<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Apache CouchDB 1.6 Documentation</title>
    
    <link rel="stylesheet" href="_static/rtd.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/badge_only.css" type="text/css" />
    <link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.6.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/underscore.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/doctools.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-doc-embed.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="contents.html#document-about" />
    <link rel="top" title="None" href="index.html" />
 
<!-- RTD Extra Head -->



  
  <!-- 
  Always link to the latest version, as canonical.
  http://docs.readthedocs.org/en/latest/canonical.html
  -->
  <link rel="canonical" href="http://docs.couchdb.org/en/latest/contents.html" />
  

<script type="text/javascript">
  // This is included here because other places don't have access to the pagename variable.
  var READTHEDOCS_DATA = {
    project: "couchdb",
    version: "1.6.1",
    language: "en",
    page: "contents",
    builder: "sphinx",
    theme: "couchdb",
    docroot: "/share/doc/src/",
    source_suffix: ".rst",
    api_host: "https://readthedocs.org",
    commit: "31dc5960d418e17eb454563330338abfd5fbbc23"
  }
  // Old variables
  var doc_version = "1.6.1";
  var doc_slug = "couchdb";
  var page_name = "contents";
  var html_theme = "couchdb";
</script>
<!-- RTD Analytics Code -->
<!-- Included in the header because you don't have a footer block. -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17997319-1']);
  _gaq.push(['_trackPageview']);

  // User Analytics Code
  _gaq.push(['user._setAccount', 'UA-658988-6']);
  _gaq.push(['user._trackPageview']);
  // End User Analytics Code


  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<!-- end RTD Analytics Code -->
<!-- end RTD <extrahead> -->

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="contents.html#document-contents">Apache CouchDB 1.6 Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="apache-couchdb-tm-release-documentation">
<h1><a class="reference external" href="http://couchdb.apache.org/">Apache CouchDB™</a> 1.6.1 Documentation<a class="headerlink" href="#apache-couchdb-tm-release-documentation" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<span id="document-intro/index"></span><div class="section" id="introduction">
<span id="intro"></span><h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>CouchDB is a database that completely embraces the web. Store your data with
JSON documents. Access your documents with your web browser, <a class="reference internal" href="contents.html#api-basics"><em>via HTTP</em></a>. <a class="reference internal" href="contents.html#api-doc"><em>Query</em></a>, <a class="reference internal" href="contents.html#views"><em>combine</em></a>,
and <a class="reference internal" href="contents.html#listfun"><em>transform</em></a> your documents with <a class="reference internal" href="contents.html#query-server-js"><em>JavaScript</em></a>. CouchDB works well with modern web and mobile apps. You can
even serve web apps directly out of CouchDB. And you can distribute your data,
or your apps, efficiently using CouchDB’s <a class="reference internal" href="contents.html#replication-intro"><em>incremental replication</em></a>. CouchDB supports master-master setups with
<a class="reference internal" href="contents.html#replication-conflicts"><em>automatic conflict</em></a> detection.</p>
<p>CouchDB comes with a suite of features, such as on-the-fly document
transformation and real-time <a class="reference internal" href="contents.html#changes"><em>change notifications</em></a>, that makes
<a class="reference internal" href="contents.html#couchapp"><em>web app</em></a> development a breeze. It even comes with an easy
to use <a class="reference internal" href="contents.html#intro-futon"><em>web administration console</em></a>. You guessed it,
served up directly out of CouchDB! We care a lot about <a class="reference external" href="http://en.wikipedia.org/wiki/CAP_theorem">distributed scaling</a>.
CouchDB is highly available and partition tolerant, but is also <a class="reference internal" href="contents.html#intro-consistency"><em>eventually
consistent</em></a>. And we care <em>a lot</em> about your data.
CouchDB has a fault-tolerant storage engine that puts the safety of your data
first.</p>
<p>In this section you&#8217;ll learn about every basic bit of CouchDB, see upon what
conceptions and technologies it built and walk through short tutorial that
teach how to use CouchDB.</p>
<div class="toctree-wrapper compound">
<span id="document-intro/overview"></span><div class="section" id="technical-overview">
<span id="intro-overview"></span><h3>Technical Overview<a class="headerlink" href="#technical-overview" title="Permalink to this headline">¶</a></h3>
<div class="section" id="document-storage">
<h4>Document Storage<a class="headerlink" href="#document-storage" title="Permalink to this headline">¶</a></h4>
<p>A CouchDB server hosts named databases, which store <strong>documents</strong>.
Each document is uniquely named in the database, and CouchDB provides
a <a class="reference external" href="http://en.wikipedia.org/wiki/REST">RESTful</a> <a class="reference internal" href="contents.html#api-basics"><em>HTTP API</em></a> for reading and updating (add, edit,
delete)  database documents.</p>
<p>Documents are the primary unit of data in CouchDB and consist of any number
of fields and attachments. Documents also include metadata that’s maintained
by the database system. Document fields are uniquely named and contain values
of <a class="reference internal" href="contents.html#json"><em>varying types</em></a> (text, number, boolean, lists, etc),
and there is no set limit to text size or element count.</p>
<p>The CouchDB document update model is lockless and optimistic.
Document edits are made by client applications loading documents,
applying changes, and saving them back to the database. If another client
editing the same document saves their changes first, the client gets an edit
conflict error on save. To resolve the update conflict, the latest document
version can be opened, the edits reapplied and the update tried again.</p>
<p>Document updates (add, edit, delete) are all or nothing, either succeeding
entirely or failing completely. The database never contains partially saved
or edited documents.</p>
</div>
<div class="section" id="acid-properties">
<h4>ACID Properties<a class="headerlink" href="#acid-properties" title="Permalink to this headline">¶</a></h4>
<p>The CouchDB file layout and commitment system features all <cite>Atomic Consistent
Isolated Durable</cite> (<a class="reference external" href="http://en.wikipedia.org/wiki/ACID">ACID</a>) properties. On-disk, CouchDB never overwrites
committed data or associated structures, ensuring the database file is always
in a consistent state. This is a &#8220;crash-only&#8221; design where the CouchDB
server does not go through a shut down process, it&#8217;s simply terminated.</p>
<p>Document updates (add, edit, delete) are serialized, except for binary blobs
which are written concurrently. Database readers are never locked out and
never have to wait on writers or other readers. Any number of clients can be
reading documents without being locked out or interrupted by concurrent
updates, even on the same document. CouchDB read operations use a
<cite>Multi-Version Concurrency Control</cite> (<a class="reference external" href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a>) model where each client sees a
consistent snapshot of the database from the beginning to the end of the read
operation.</p>
<p>Documents are indexed in <a class="reference external" href="http://en.wikipedia.org/wiki/B-tree">B-trees</a> by their name (DocID) and a Sequence ID.
Each update to a database instance generates a new sequential number.
Sequence IDs are used later for incrementally finding changes in a database.
These B-tree indexes are updated simultaneously when documents are saved or
deleted. The index updates always occur at the end of the file (append-only
updates).</p>
<p>Documents have the advantage of data being already conveniently packaged for
storage rather than split out across numerous tables and rows in most
database systems. When documents are committed to disk, the document fields
and metadata are packed into buffers, sequentially one document after another
(helpful later for efficient building of views).</p>
<p>When CouchDB documents are updated, all data and associated indexes are
flushed to disk and the transactional commit always leaves the database
in a completely consistent state. Commits occur in two steps:</p>
<ol class="arabic simple">
<li>All document data and associated index updates are synchronously flushed
to disk.</li>
<li>The updated database header is written in two consecutive, identical chunks
to make up the first 4k of the file, and then synchronously flushed to disk.</li>
</ol>
<p>In the event of an OS crash or power failure during step 1,
the partially flushed updates are simply forgotten on restart. If such a
crash happens during step 2 (committing the header), a surviving copy of the
previous identical headers will remain, ensuring coherency of all previously
committed data. Excepting the header area, consistency checks or fix-ups
after a crash or a power failure are never necessary.</p>
</div>
<div class="section" id="compaction">
<h4>Compaction<a class="headerlink" href="#compaction" title="Permalink to this headline">¶</a></h4>
<p>Wasted space is recovered by occasional compaction. On schedule, or when the
database file exceeds a certain amount of wasted space, the compaction process
clones all the active data to a new file and then discards the old file.
The database remains completely online the entire time and all updates and
reads are allowed to complete successfully. The old database file is deleted only when
all the data has been copied and all users transitioned to the new file.</p>
</div>
<div class="section" id="views">
<h4>Views<a class="headerlink" href="#views" title="Permalink to this headline">¶</a></h4>
<p>ACID properties only deal with storage and updates, but we also need the ability
to show our data in interesting and useful ways. Unlike SQL databases where
data must be carefully decomposed into tables, data in CouchDB is stored in
semi-structured documents. CouchDB documents are flexible and each has its
own implicit structure, which alleviates the most difficult problems and
pitfalls of bi-directionally replicating table schemas and their contained data.</p>
<p>But beyond acting as a fancy file server, a simple document model for data
storage and sharing is too simple to build real applications on &#8211; it simply
doesn&#8217;t do enough of the things we want and expect. We want to slice and dice
and see our data in many different ways. What is needed is a way to filter,
organize and report on data that hasn&#8217;t been decomposed into tables.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#views"><em>Guide to Views</em></a></p>
</div>
<div class="section" id="view-model">
<h5>View Model<a class="headerlink" href="#view-model" title="Permalink to this headline">¶</a></h5>
<p>To address this problem of adding structure back to unstructured and
semi-structured data, CouchDB integrates a view model. Views are the method
of aggregating and reporting on the documents in a database, and are built
on-demand to aggregate, join and report on database documents. Because views are built
dynamically and don’t affect the underlying document, you can have as many
different view representations of the same data as you like.</p>
<p>View definitions are strictly virtual and only display the documents from the
current database instance, making them separate from the data they display
and compatible with replication. CouchDB views are defined inside special
<strong>design documents</strong> and can replicate across database instances like
regular documents, so that not only data replicates in CouchDB,
but entire application designs replicate too.</p>
</div>
<div class="section" id="javascript-view-functions">
<h5>Javascript View Functions<a class="headerlink" href="#javascript-view-functions" title="Permalink to this headline">¶</a></h5>
<p>Views are defined using Javascript functions acting as the map part in a
<a class="reference external" href="http://en.wikipedia.org/wiki/MapReduce">map-reduce system</a>. A <a class="reference internal" href="contents.html#viewfun"><em>view function</em></a> takes a CouchDB document
as an argument and then does whatever computation it needs to do to determine
the data that is to be made available through the view, if any.
It can add multiple rows to the view based on a single document,
or it can add no rows at all.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#viewfun"><em>View functions</em></a></p>
</div>
</div>
<div class="section" id="view-indexes">
<h5>View Indexes<a class="headerlink" href="#view-indexes" title="Permalink to this headline">¶</a></h5>
<p>Views are a dynamic representation of the actual document contents of a
database, and CouchDB makes it easy to create useful views of data.
But generating a view of a database with hundreds of thousands or millions of
documents is time and resource consuming, it&#8217;s not something the system
should do from scratch each time.</p>
<p>To keep view querying fast, the view engine maintains indexes of its views,
and incrementally updates them to reflect changes in the database.
CouchDB’s core design is largely optimized around the need for efficient,
incremental creation of views and their indexes.</p>
<p>Views and their functions are defined inside special &#8220;design&#8221; documents,
and a design document may contain any number of uniquely named view functions.
When a user opens a view and its index is automatically updated, all the views
in the same design document are indexed as a single group.</p>
<p>The view builder uses the database sequence ID to determine if the view group
is fully up-to-date with the database. If not, the view engine examines the
all database documents (in packed sequential order) changed since the last
refresh. Documents are read in the order they occur in the disk file,
reducing the frequency and cost of disk head seeks.</p>
<p>The views can be read and queried simultaneously while also being refreshed.
If a client is slowly streaming out the contents of a large view,
the same view can be concurrently opened and refreshed for another client
without blocking the first client. This is true for any number of
simultaneous client readers, who can read and query the view while the index
is concurrently being refreshed for other clients without causing problems
for the readers.</p>
<p>As documents are processed by the view engine through your &#8216;map&#8217; and &#8216;reduce&#8217;
functions, their previous row values are removed from the view indexes, if
they exist. If the document is selected by a view function, the function results
are inserted into the view as a new row.</p>
<p>When view index changes are written to disk, the updates are always appended
at the end of the file, serving to both reduce disk head seek times during
disk commits and to ensure crashes and power failures can not cause
corruption of indexes. If a crash occurs while updating a view index,
the incomplete index updates are simply lost and rebuilt incrementally from
its previously committed state.</p>
</div>
</div>
<div class="section" id="security-and-validation">
<h4>Security and Validation<a class="headerlink" href="#security-and-validation" title="Permalink to this headline">¶</a></h4>
<p>To protect who can read and update documents, CouchDB has a simple reader
access and update validation model that can be extended to implement custom
security models.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#api-db-security"><em>/db/_security</em></a></p>
</div>
<div class="section" id="administrator-access">
<h5>Administrator Access<a class="headerlink" href="#administrator-access" title="Permalink to this headline">¶</a></h5>
<p>CouchDB database instances have administrator accounts. Administrator
accounts can create other administrator accounts and update design documents.
Design documents are special documents containing view definitions and other
special formulas, as well as regular fields and blobs.</p>
</div>
<div class="section" id="update-validation">
<h5>Update Validation<a class="headerlink" href="#update-validation" title="Permalink to this headline">¶</a></h5>
<p>As documents written to disk, they can be validated dynamically by javascript
functions for both security and data validation. When the document passes
all the formula validation criteria, the update is allowed to continue.
If the validation fails, the update is aborted and the user client gets an
error response.</p>
<p>Both the user&#8217;s credentials and the updated document are given as inputs to
the validation formula, and can be used to implement custom security models
by validating a user&#8217;s permissions to update a document.</p>
<p>A basic &#8220;author only&#8221; update document model is trivial to implement,
where document updates are validated to check if the user is listed in an
&#8220;author&#8221; field in the existing document. More dynamic models are also possible,
like checking a separate user account profile for permission settings.</p>
<p>The update validations are enforced for both live usage and replicated
updates, ensuring security and data validation in a shared, distributed system.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#vdufun"><em>Validate document update functions</em></a></p>
</div>
</div>
</div>
<div class="section" id="distributed-updates-and-replication">
<h4>Distributed Updates and Replication<a class="headerlink" href="#distributed-updates-and-replication" title="Permalink to this headline">¶</a></h4>
<p>CouchDB is a peer-based distributed database system. It allows users and servers
to access and update the same shared data while disconnected. Those changes can
then be replicated bi-directionally later.</p>
<p>The CouchDB document storage, view and security models are designed to work
together to make true bi-directional replication efficient and reliable.
Both documents and designs can replicate, allowing full database applications
(including application design, logic and data) to be replicated to laptops
for offline use, or replicated to servers in remote offices where slow or
unreliable connections make sharing data difficult.</p>
<p>The replication process is incremental. At the database level,
replication only examines documents updated since the last replication.
Then for each updated document, only fields and blobs that have changed are
replicated across the network. If replication fails at any step, due to network
problems or crash for example, the next replication restarts at the same
document where it left off.</p>
<p>Partial replicas can be created and maintained. Replication can be filtered
by a javascript function, so that only particular documents or those meeting
specific criteria are replicated. This can allow users to take subsets of a
large shared database application offline for their own use, while maintaining
normal interaction with the application and that subset of data.</p>
<div class="section" id="conflicts">
<h5>Conflicts<a class="headerlink" href="#conflicts" title="Permalink to this headline">¶</a></h5>
<p>Conflict detection and management are key issues for any distributed edit
system. The CouchDB storage system treats edit conflicts as a common state,
not an exceptional one. The conflict handling model is simple and
&#8220;non-destructive&#8221; while preserving single document semantics and allowing for
decentralized conflict resolution.</p>
<p>CouchDB allows for any number of conflicting documents to exist
simultaneously in the database, with each database instance deterministically
deciding which document is the &#8220;winner&#8221; and which are conflicts. Only the
winning document can appear in views, while &#8220;losing&#8221; conflicts are still
accessible and remain in the database until deleted or purged during
database compaction. Because conflict documents are still regular documents,
they replicate just like regular documents and are subject to the same
security and validation rules.</p>
<p>When distributed edit conflicts occur, every database replica sees the same
winning revision and each has the opportunity to resolve the conflict.
Resolving conflicts can be done manually or, depending on the nature of the
data and the conflict, by automated agents. The system makes decentralized
conflict resolution possible while maintaining single document database
semantics.</p>
<p>Conflict management continues to work even if multiple disconnected users or
agents attempt to resolve the same conflicts. If resolved conflicts result in
more conflicts, the system accommodates them in the same manner, determining
the same winner on each machine and maintaining single document semantics.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#replication-conflicts"><em>Replication and conflict model</em></a></p>
</div>
</div>
<div class="section" id="applications">
<h5>Applications<a class="headerlink" href="#applications" title="Permalink to this headline">¶</a></h5>
<p>Using just the basic replication model, many traditionally single server
database applications can be made distributed with almost no extra work.
CouchDB replication is designed to be immediately useful for basic database
applications, while also being extendable for more elaborate and full-featured
uses.</p>
<p>With very little database work, it is possible to build a distributed
document management application with granular security and full revision
histories. Updates to documents can be implemented to exploit incremental
field and blob replication, where replicated updates are nearly as efficient
and incremental as the actual edit differences (&#8220;diffs&#8221;).</p>
<p>The CouchDB replication model can be modified for other distributed update
models. If the storage engine is enhanced to allow multi-document update
transactions, it is possible to perform Subversion-like &#8220;all or nothing&#8221;
atomic commits when replicating with an upstream server, such that any single
document conflict or validation failure will cause the entire update to fail.
Like Subversion, conflicts would be resolved by doing a &#8220;pull&#8221; replication to
force the conflicts locally, then merging and  re-replicating to the upstream
server.</p>
</div>
</div>
<div class="section" id="implementation">
<h4>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h4>
<p>CouchDB is built on the <a class="reference external" href="http://www.erlang.org/">Erlang OTP platform</a>, a functional,
concurrent programming language and development platform. Erlang was
developed for real-time telecom applications with an extreme emphasis on
reliability and availability.</p>
<p>Both in syntax and semantics, Erlang is very different from conventional
programming languages like C or Java. Erlang uses lightweight &#8220;processes&#8221; and
message passing for concurrency, it has no shared state threading and all
data is immutable. The robust, concurrent nature of Erlang is ideal for a
database server.</p>
<p>CouchDB is designed for lock-free concurrency, in the conceptual model and
the actual Erlang implementation. Reducing bottlenecks and avoiding locks
keeps the entire system working predictably under heavy loads. CouchDB can
accommodate many clients replicating changes, opening and updating documents,
and querying views whose indexes are simultaneously being refreshed for
other clients, without needing locks.</p>
<p>For higher availability and more concurrent users, CouchDB is designed for
&#8220;shared nothing&#8221; clustering. In a &#8220;shared nothing&#8221; cluster, each machine
is independent and replicates data with its cluster mates, allowing individual
server failures with zero downtime. And because consistency scans
and fix-ups aren’t needed on restart,
if the entire cluster fails &#8211; due to a power outage in a datacenter,
for example &#8211; the entire CouchDB distributed system becomes immediately
available after a restart.</p>
<p>CouchDB is built from the start with a consistent vision of a distributed
document database system. Unlike cumbersome attempts to bolt distributed
features on top of the same legacy models and databases,
it is the result of careful ground-up design, engineering and integration.
The document, view, security and replication models, the special purpose query
language, the efficient and robust disk layout and the concurrent and reliable
nature of the Erlang platform are all carefully integrated for a reliable
and efficient system.</p>
</div>
</div>
<span id="document-intro/why"></span><div class="section" id="why-couchdb">
<span id="intro-why"></span><h3>Why CouchDB?<a class="headerlink" href="#why-couchdb" title="Permalink to this headline">¶</a></h3>
<p>Apache CouchDB is one of a new breed of database management systems.
This topic explains why there&#8217;s a need for new systems as well as the
motivations behind building CouchDB.</p>
<p>As CouchDB developers, we&#8217;re naturally very excited to be using CouchDB.
In this topic we&#8217;ll share with you the reasons for our enthusiasm.
We&#8217;ll show you how CouchDB&#8217;s schema-free document model is a better fit
for common applications, how the built-in query engine is a powerful way
to use and process your data, and how CouchDB&#8217;s design lends itself
to modularization and scalability.</p>
<div class="section" id="relax">
<h4>Relax<a class="headerlink" href="#relax" title="Permalink to this headline">¶</a></h4>
<p>If there&#8217;s one word to describe CouchDB, it is <em>relax</em>. It is the byline
to CouchDB&#8217;s official logo and when you start CouchDB, you see:</p>
<div class="highlight-json"><div class="highlight"><pre>Apache CouchDB has started. Time to relax.
</pre></div>
</div>
<p>Why is relaxation important? Developer productivity roughly doubled in the
last five years. The chief reason for the boost is more powerful tools that
are easier to use. Take Ruby on Rails as an example. It is an infinitely
complex framework, but it&#8217;s easy to get started with. Rails is a success
story because of the core design focus on ease of use. This is one reason why
CouchDB is relaxing: learning CouchDB and understanding its core concepts
should feel natural to most everybody who has been doing any work on the Web.
And it is still pretty easy to explain to non-technical people.</p>
<p>Getting out of the way when creative people try to build specialized
solutions is in itself a core feature and one thing that CouchDB aims to get
right. We found existing tools too cumbersome to work with during development
or in production, and decided to focus on making CouchDB easy, even a pleasure,
to use.</p>
<p>Another area of relaxation for CouchDB users is the production setting.
If you have a live running application, CouchDB again goes out of its way
to avoid troubling you. Its internal architecture is fault-tolerant,
and failures occur in a controlled environment and are dealt with gracefully.
Single problems do not cascade through an entire server system but stay
isolated in single requests.</p>
<p>CouchDB&#8217;s core concepts are simple (yet powerful) and well understood.
Operations teams (if you have a team; otherwise, that&#8217;s you) do not have to
fear random behavior and untraceable errors. If anything should go wrong,
you can easily find out what the problem is, but these situations are rare.</p>
<p>CouchDB is also designed to handle varying traffic gracefully. For instance,
if a website is experiencing a sudden spike in traffic, CouchDB will generally
absorb a lot of concurrent requests without falling over. It may take a little
more time for each request, but they all get answered. When the spike is over,
CouchDB will work with regular speed again.</p>
<p>The third area of relaxation is growing and shrinking the underlying hardware
of your application. This is commonly referred to as scaling. CouchDB enforces
a set of limits on the programmer. On first look, CouchDB might seem
inflexible, but some features are left out by design for the simple reason
that if CouchDB supported them, it would allow a programmer to create
applications that couldn&#8217;t deal with scaling up or down.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CouchDB doesn&#8217;t let you do things that would get you in trouble later on.
This sometimes means you&#8217;ll have to unlearn best practices you might have
picked up in your current or past work.</p>
</div>
</div>
<div class="section" id="a-different-way-to-model-your-data">
<h4>A Different Way to Model Your Data<a class="headerlink" href="#a-different-way-to-model-your-data" title="Permalink to this headline">¶</a></h4>
<p>We believe that CouchDB will drastically change the way you build
document-based applications. CouchDB combines an intuitive document storage
model with a powerful query engine in a way that&#8217;s so simple you&#8217;ll probably
be tempted to ask, “Why has no one built something like this before?”</p>
<blockquote>
<div><p>Django may be built for the Web, but CouchDB is built of the Web. I&#8217;ve
never seen software that so completely embraces the philosophies behind
HTTP. CouchDB makes Django look old-school in the same way that Django
makes ASP look outdated.</p>
<p class="attribution">&mdash;Jacob Kaplan-Moss, Django developer</p>
</div></blockquote>
<p>CouchDB&#8217;s design borrows heavily from web architecture and the concepts of
resources, methods, and representations. It augments this with powerful ways
to query, map, combine, and filter your data. Add fault tolerance, extreme
scalability, and incremental replication, and CouchDB defines a sweet spot
for document databases.</p>
</div>
<div class="section" id="a-better-fit-for-common-applications">
<h4>A Better Fit for Common Applications<a class="headerlink" href="#a-better-fit-for-common-applications" title="Permalink to this headline">¶</a></h4>
<p>We write software to improve our lives and the lives of others. Usually this
involves taking some mundane information such as contacts, invoices,
or receipts and manipulating it using a computer application. CouchDB is a
great fit for common applications like this because it embraces the natural
idea of evolving, self-contained documents as the very core of its data model.</p>
<div class="section" id="self-contained-data">
<h5>Self-Contained Data<a class="headerlink" href="#self-contained-data" title="Permalink to this headline">¶</a></h5>
<p>An invoice contains all the pertinent information about a single transaction
the seller, the buyer, the date, and a list of the items or services sold.
As shown in <a class="reference internal" href="contents.html#intro-why-01"><em>Figure 1. Self-contained documents</em></a>, there&#8217;s no abstract reference on this
piece of paper that points to some other piece of paper with the seller&#8217;s
name and address. Accountants appreciate the simplicity of having everything
in one place. And given the choice, programmers appreciate that, too.</p>
<div class="figure align-center" id="intro-why-01">
<img alt="Self-contained documents" src="_images/intro-why-01.png" />
<p class="caption">Figure 1. Self-contained documents</p>
</div>
<p>Yet using references is exactly how we model our data in a relational
database! Each invoice is stored in a table as a row that refers to other
rows in other tables one row for seller information, one for the buyer,
one row for each item billed, and more rows still to describe the item
details, manufacturer details, and so on and so forth.</p>
<p>This isn&#8217;t meant as a detraction of the relational model, which is widely
applicable and extremely useful for a number of reasons. Hopefully, though, it
illustrates the point that sometimes your model may not “fit” your data
in the way it occurs in the real world.</p>
<p>Let&#8217;s take a look at the humble contact database to illustrate a different
way of modeling data, one that more closely “fits” its real-world counterpart
&#8211; a pile of business cards. Much like our invoice example, a business card
contains all the important information, right there on the cardstock.
We call this “self-contained” data, and it&#8217;s an important concept
in understanding document databases like CouchDB.</p>
</div>
<div class="section" id="syntax-and-semantics">
<h5>Syntax and Semantics<a class="headerlink" href="#syntax-and-semantics" title="Permalink to this headline">¶</a></h5>
<p>Most business cards contain roughly the same information &#8211; someone&#8217;s identity,
an affiliation, and some contact information. While the exact form of this
information can vary between business cards, the general information being
conveyed remains the same, and we&#8217;re easily able to recognize it as a
business card. In this sense, we can describe a business card as a <em>real-world
document</em>.</p>
<p>Jan&#8217;s business card might contain a phone number but no fax number,
whereas J. Chris&#8217;s business card contains both a phone and a fax number. Jan
does not have to make his lack of a fax machine explicit by writing something
as ridiculous as “Fax: None” on the business card. Instead, simply omitting
a fax number implies that he doesn&#8217;t have one.</p>
<p>We can see that real-world documents of the same type, such as business cards,
tend to be very similar in <em>semantics</em> &#8211; the sort of information they carry,
but can vary hugely in <em>syntax</em>, or how that information is structured. As human
beings, we&#8217;re naturally comfortable dealing with this kind of variation.</p>
<p>While a traditional relational database requires you to model your data
<em>up front</em>, CouchDB&#8217;s schema-free design unburdens you with a powerful way to
aggregate your data <em>after the fact</em>, just like we do with real-world
documents. We&#8217;ll look in depth at how to design applications with this
underlying storage paradigm.</p>
</div>
</div>
<div class="section" id="building-blocks-for-larger-systems">
<h4>Building Blocks for Larger Systems<a class="headerlink" href="#building-blocks-for-larger-systems" title="Permalink to this headline">¶</a></h4>
<p>CouchDB is a storage system useful on its own. You can build many applications
with the tools CouchDB gives you. But CouchDB is designed with a bigger picture
in mind. Its components can be used as building blocks that solve storage
problems in slightly different ways for larger and more complex systems.</p>
<p>Whether you need a system that&#8217;s crazy fast but isn&#8217;t too concerned with
reliability (think logging), or one that guarantees storage in two or more
physically separated locations for reliability, but you&#8217;re willing to take a
performance hit, CouchDB lets you build these systems.</p>
<p>There are a multitude of knobs you could turn to make a system work better in
one area, but you&#8217;ll affect another area when doing so. One example would be
the CAP theorem discussed in <a class="reference internal" href="contents.html#intro-consistency"><em>Eventual Consistency</em></a>. To give you an idea of other
things that affect storage systems, see <a class="reference internal" href="contents.html#intro-why-figure-02"><em>Figure 2</em></a>
and <a class="reference internal" href="contents.html#intro-why-figure-03"><em>Figure 3</em></a>.</p>
<p>By reducing latency for a given system (and that is true not only for storage
systems), you affect concurrency and throughput capabilities.</p>
<div class="figure align-center" id="intro-why-figure-02">
<img alt="Throughput, latency, or concurrency" src="_images/intro-why-02.png" />
<p class="caption">Figure 2. Throughput, latency, or concurrency</p>
</div>
<div class="figure align-center" id="intro-why-figure-03">
<img alt="Scaling: read requests, write requests, or data" src="_images/intro-why-03.png" />
<p class="caption">Figure 3. Scaling: read requests, write requests, or data</p>
</div>
<p>When you want to scale out, there are three distinct issues to deal with:
scaling read requests, write requests, and data. Orthogonal to all three and
to the items shown in <a class="reference internal" href="contents.html#intro-why-figure-02"><em>Figure 2</em></a> and <a class="reference internal" href="contents.html#intro-why-figure-03"><em>Figure 3</em></a> are many more attributes like reliability or simplicity.
You can draw many of these graphs that show how different features or attributes
pull into different directions and thus shape the system they describe.</p>
<p>CouchDB is very flexible and gives you enough building blocks to create a
system shaped to suit your exact problem. That&#8217;s not saying that CouchDB can
be bent to solve any problem &#8211; CouchDB is no silver bullet &#8211; but in the
area of data storage, it can get you a long way.</p>
</div>
<div class="section" id="couchdb-replication">
<h4>CouchDB Replication<a class="headerlink" href="#couchdb-replication" title="Permalink to this headline">¶</a></h4>
<p>CouchDB replication is one of these building blocks. Its fundamental function
is to synchronize two or more CouchDB databases. This may sound simple,
but the simplicity is key to allowing replication to solve a number of
problems: reliably synchronize databases between multiple machines for
redundant data storage; distribute data to a cluster of CouchDB instances
that share a subset of the total number of requests that hit the cluster
(load balancing); and distribute data between physically distant locations,
such as one office in New York and another in Tokyo.</p>
<p>CouchDB replication uses the same REST API all clients use. HTTP is
ubiquitous and well understood. Replication works incrementally; that is,
if during replication anything goes wrong, like dropping your network
connection, it will pick up where it left off the next time it runs. It also
only transfers data that is needed to synchronize databases.</p>
<p>A core assumption CouchDB makes is that things can go wrong,
like network connection troubles, and it is designed for graceful error
recovery instead of assuming all will be well. The replication system&#8217;s
incremental design shows that best. The ideas behind “things that can go
wrong” are embodied in the <a class="reference external" href="http://en.wikipedia.org/wiki/Fallacies_of_Distributed_Computing">Fallacies of Distributed Computing</a>:</p>
<ul class="simple">
<li>The network is reliable.</li>
<li>Latency is zero.</li>
<li>Bandwidth is infinite.</li>
<li>The network is secure.</li>
<li>Topology doesn&#8217;t change.</li>
<li>There is one administrator.</li>
<li>Transport cost is zero.</li>
<li>The network is homogeneous.</li>
</ul>
<p>Existing tools often try to hide the fact that there is a network and that
any or all of the previous conditions don&#8217;t exist for a particular system.
This usually results in fatal error scenarios when something finally goes
wrong. In contrast, CouchDB doesn&#8217;t try to hide the network; it just handles
errors gracefully and lets you know when actions on your end are required.</p>
</div>
<div class="section" id="local-data-is-king">
<h4>Local Data Is King<a class="headerlink" href="#local-data-is-king" title="Permalink to this headline">¶</a></h4>
<p>CouchDB takes quite a few lessons learned from the Web,
but there is one thing that could be improved about the Web: latency.
Whenever you have to wait for an application to respond or a website to
render, you almost always wait for a network connection that isn&#8217;t as fast as
you want it at that point. Waiting a few seconds instead of milliseconds
greatly affects user experience and thus user satisfaction.</p>
<p>What do you do when you are offline? This happens all the time &#8211; your DSL or
cable provider has issues, or your iPhone, G1, or Blackberry has no bars,
and no connectivity means no way to get to your data.</p>
<p>CouchDB can solve this scenario as well, and this is where scaling is
important again. This time it is scaling down. Imagine CouchDB installed on
phones and other mobile devices that can synchronize data with centrally
hosted CouchDBs when they are on a network. The synchronization is not bound
by user interface constraints like subsecond response times. It is easier to
tune for high bandwidth and higher latency than for low bandwidth and very
low latency. Mobile applications can then use the local CouchDB to fetch
data, and since no remote networking is required for that,
latency is low by default.</p>
<p>Can you really use CouchDB on a phone? Erlang, CouchDB&#8217;s implementation
language has been designed to run on embedded devices magnitudes smaller and
less powerful than today&#8217;s phones.</p>
</div>
<div class="section" id="wrapping-up">
<h4>Wrapping Up<a class="headerlink" href="#wrapping-up" title="Permalink to this headline">¶</a></h4>
<p>The next document <a class="reference internal" href="contents.html#intro-consistency"><em>Eventual Consistency</em></a> further explores the distributed nature
of CouchDB. We should have given you enough bites to whet your interest.
Let&#8217;s go!</p>
</div>
</div>
<span id="document-intro/consistency"></span><div class="section" id="eventual-consistency">
<span id="intro-consistency"></span><h3>Eventual Consistency<a class="headerlink" href="#eventual-consistency" title="Permalink to this headline">¶</a></h3>
<p>In the previous document <a class="reference internal" href="contents.html#intro-why"><em>Why CouchDB?</em></a>, we saw that CouchDB&#8217;s flexibility allows us to
evolve our data as our applications grow and change. In this topic,
we&#8217;ll explore how working &#8220;with the grain&#8221; of CouchDB promotes simplicity in
our applications and helps us naturally build scalable, distributed systems.</p>
<div class="section" id="working-with-the-grain">
<h4>Working with the Grain<a class="headerlink" href="#working-with-the-grain" title="Permalink to this headline">¶</a></h4>
<p>A <em>distributed system</em> is a system that operates robustly over a wide network.
A particular feature of network computing is that network links can
potentially disappear, and there are plenty of strategies for managing this
type of network segmentation. CouchDB differs from others by accepting
eventual consistency, as opposed to putting absolute consistency ahead of raw
availability, like <a class="reference external" href="http://en.wikipedia.org/wiki/Relational_database_management_system">RDBMS</a> or <a class="reference external" href="http://en.wikipedia.org/wiki/Paxos_%28computer_science%29">Paxos</a>. What these systems have in common is
an awareness that data acts differently when many people are accessing it
simultaneously. Their approaches differ when it comes to which aspects of
<em>consistency</em>, <em>availability</em>, or <em>partition</em> tolerance they prioritize.</p>
<p>Engineering distributed systems is tricky. Many of the caveats and &#8220;gotchas&#8221;
you will face over time aren&#8217;t immediately obvious. We don&#8217;t have all the
solutions, and CouchDB isn&#8217;t a panacea, but when you work with CouchDB&#8217;s
grain rather than against it, the path of least resistance leads you to
naturally scalable applications.</p>
<p>Of course, building a distributed system is only the beginning. A website
with a database that is available only half the time is next to worthless.
Unfortunately, the traditional relational database approach to consistency
makes it very easy for application programmers to rely on global state,
global clocks, and other high availability no-nos, without even realizing
that they&#8217;re doing so. Before examining how CouchDB promotes scalability,
we&#8217;ll look at the constraints faced by a distributed system. After we&#8217;ve seen
the problems that arise when parts of your application can&#8217;t rely on being
in constant contact with each other, we&#8217;ll see that CouchDB provides an
intuitive and useful way for modeling applications around high availability.</p>
</div>
<div class="section" id="the-cap-theorem">
<span id="cap"></span><h4>The CAP Theorem<a class="headerlink" href="#the-cap-theorem" title="Permalink to this headline">¶</a></h4>
<p>The CAP theorem describes a few different strategies for distributing
application logic across networks. CouchDB&#8217;s solution uses replication to
propagate application changes across participating nodes. This is a
fundamentally different approach from consensus algorithms and relational
databases, which operate at different intersections of consistency,
availability, and partition tolerance.</p>
<p>The CAP theorem, shown in <a class="reference internal" href="contents.html#intro-consistency-01"><em>Figure 1. The CAP theorem</em></a>,
identifies three distinct concerns:</p>
<ul class="simple">
<li><strong>Consistency</strong>:
All database clients see the same data, even with concurrent updates.</li>
<li><strong>Availability</strong>:
All database clients are able to access some version of the data.</li>
<li><strong>Partition tolerance</strong>:
The database can be split over multiple servers.</li>
</ul>
<p>Pick two.</p>
<div class="figure align-center" id="intro-consistency-01">
<img alt="The CAP theorem" src="_images/intro-consistency-01.png" />
<p class="caption">Figure 1. The CAP theorem</p>
</div>
<p>When a system grows large enough that a single database node is unable to
handle the load placed on it, a sensible solution is to add more servers.
When we add nodes, we have to start thinking about how to partition data
between them. Do we have a few databases that share exactly the same data?
Do we put different sets of data on different database servers?
Do we let only certain database servers write data and let others handle
the reads?</p>
<p>Regardless of which approach we take, the one problem we&#8217;ll keep bumping into
is that of keeping all these database servers in sync. If you write some
information to one node, how are you going to make sure that a read request
to another database server reflects this newest information? These events
might be milliseconds apart. Even with a modest collection of database
servers, this problem can become extremely complex.</p>
<p>When it&#8217;s absolutely critical that all clients see a consistent view of the
database, the users of one node will have to wait for any other nodes to come
into agreement before being able to read or write to the database.
In this instance, we see that availability takes a backseat to consistency.
However, there are situations where availability trumps consistency:</p>
<blockquote>
<div><p>Each node in a system should be able to make decisions purely based on
local state. If you need to do something under high load with failures
occurring and you need to reach agreement, you&#8217;re lost. If you&#8217;re
concerned about scalability, any algorithm that forces you to run
agreement will eventually become your bottleneck. Take that as a given.</p>
<blockquote>
<div>&#8211; Werner Vogels, Amazon CTO and Vice President</div></blockquote>
</div></blockquote>
<p>If availability is a priority, we can let clients write data to one node of
the database without waiting for other nodes to come into agreement.
If the database knows how to take care of reconciling these operations between
nodes, we achieve a sort of &#8220;eventual consistency&#8221; in exchange for high
availability. This is a surprisingly applicable trade-off for many applications.</p>
<p>Unlike traditional relational databases, where each action performed is
necessarily subject to database-wide consistency checks,
CouchDB makes it really simple to build applications that sacrifice immediate
consistency for the huge performance improvements that come with simple
distribution.</p>
</div>
<div class="section" id="local-consistency">
<h4>Local Consistency<a class="headerlink" href="#local-consistency" title="Permalink to this headline">¶</a></h4>
<p>Before we attempt to understand how CouchDB operates in a cluster,
it&#8217;s important that we understand the inner workings of a single CouchDB node.
The CouchDB API is designed to provide a convenient but thin wrapper around
the database core. By taking a closer look at the structure of the database
core, we&#8217;ll have a better understanding of the API that surrounds it.</p>
<div class="section" id="the-key-to-your-data">
<h5>The Key to Your Data<a class="headerlink" href="#the-key-to-your-data" title="Permalink to this headline">¶</a></h5>
<p>At the heart of CouchDB is a powerful <em>B-tree</em> storage engine.
A B-tree is a sorted data structure that allows for searches, insertions,
and deletions in logarithmic time. As <a class="reference internal" href="contents.html#intro-consistency-02"><em>Figure 2. Anatomy of a view request</em></a>
illustrates, CouchDB uses this B-tree storage engine for all internal data,
documents, and views. If we understand one, we will understand them all.</p>
<div class="figure align-center" id="intro-consistency-02">
<img alt="Anatomy of a view request" src="_images/intro-consistency-02.png" />
<p class="caption">Figure 2. Anatomy of a view request</p>
</div>
<p>CouchDB uses MapReduce to compute the results of a view. MapReduce makes use
of two functions, &#8220;map&#8221; and &#8220;reduce&#8221;, which are applied to each document in
isolation. Being able to isolate these operations means that view computation
lends itself to parallel and incremental computation. More important,
because these functions produce key/value pairs, CouchDB is able to insert
them into the B-tree storage engine, sorted by key. Lookups by key,
or key range, are extremely efficient operations with a B-tree,
described in <cite>big O</cite> notation as <tt class="docutils literal"><span class="pre">O(log</span> <span class="pre">N)</span></tt> and <tt class="docutils literal"><span class="pre">O(log</span> <span class="pre">N</span> <span class="pre">+</span> <span class="pre">K)</span></tt>,
respectively.</p>
<p>In CouchDB, we access documents and view results by key or key range.
This is a direct mapping to the underlying operations performed on CouchDB&#8217;s
B-tree storage engine. Along with document inserts and updates,
this direct mapping is the reason we describe CouchDB&#8217;s API as being a thin
wrapper around the database core.</p>
<p>Being able to access results by key alone is a very important restriction
because it allows us to make huge performance gains. As well as the massive
speed improvements, we can partition our data over multiple nodes,
without affecting our ability to query each node in isolation.
<a class="reference external" href="http://en.wikipedia.org/wiki/BigTable">BigTable</a>, <a class="reference external" href="http://hadoop.apache.org">Hadoop</a>, <a class="reference external" href="http://aws.amazon.com/simpledb/">SimpleDB</a>, and <a class="reference external" href="http://memcached.org">memcached</a> restrict object lookups
by key for  exactly these reasons.</p>
</div>
<div class="section" id="no-locking">
<h5>No Locking<a class="headerlink" href="#no-locking" title="Permalink to this headline">¶</a></h5>
<p>A table in a relational database is a single data structure. If you want to
modify a table &#8211; say, update a row &#8211; the database system must ensure
that nobody else is trying to update that row and that nobody can read from
that row while it is being updated. The common way to handle this uses what&#8217;s
known as a lock. If multiple clients want to access a table, the first client
gets the lock, making everybody else wait. When the first client&#8217;s request is
processed, the next client is given access while everybody else waits,
and so on. This serial execution of requests, even when they arrived in
parallel, wastes a significant amount of your server&#8217;s processing power.
Under high load, a relational database can spend more time figuring out who
is allowed to do what, and in which order, than it does doing any actual work.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Modern relational databases avoid locks by implementing MVCC under
the hood, but hide it from the end user, requiring them to coordinate
concurrent changes of single rows or fields.</p>
</div>
<p>Instead of locks, CouchDB uses <cite>Multi-Version Concurrency Control</cite> (MVCC) to
manage concurrent access to the database. <a class="reference internal" href="contents.html#intro-consistency-03"><em>Figure 3. MVCC means no locking</em></a>
illustrates the differences between MVCC and traditional locking mechanisms.
MVCC means that CouchDB can run at full speed, all the time,
even under high load. Requests are run in parallel, making excellent use of
every last drop of processing power your server has to offer.</p>
<div class="figure align-center" id="intro-consistency-03">
<img alt="MVCC means no locking" src="_images/intro-consistency-03.png" />
<p class="caption">Figure 3. MVCC means no locking</p>
</div>
<p>Documents in CouchDB are versioned, much like they would be in a regular
version control system such as <a class="reference external" href="http://subversion.apache.org/">Subversion</a>. If you want to change
a value in a document, you create an entire new version of that document
and save it over the old one. After doing this, you end up with two versions
of the same document, one old and one new.</p>
<p>How does this offer an improvement over locks? Consider a set of requests
wanting to access a document. The first request reads the document.
While this is being processed, a second request changes the document.
Since the second request includes a completely new version of the document,
CouchDB can simply append it to the database without having to wait for the
read request to finish.</p>
<p>When a third request wants to read the same document, CouchDB will point it
to the new version that has just been written. During this whole process,
the first request could still be reading the original version.</p>
<p>A read request will always see the most recent snapshot of your database at
the time of the beginning of the request.</p>
</div>
</div>
<div class="section" id="validation">
<h4>Validation<a class="headerlink" href="#validation" title="Permalink to this headline">¶</a></h4>
<p>As application developers, we have to think about what sort of input we
should accept and what we should reject. The expressive power to do this type
of validation over complex data within a traditional relational database
leaves a lot to be desired. Fortunately, CouchDB provides a powerful way to
perform per-document validation from within the database.</p>
<p>CouchDB can validate documents using JavaScript functions similar to those
used for MapReduce. Each time you try to modify a document,
CouchDB will pass the validation function a copy of the existing document,
a copy of the new document, and a collection of additional information,
such as user authentication details. The validation function now has the
opportunity to approve or deny the update.</p>
<p>By working with the grain and letting CouchDB do this for us,
we save ourselves a tremendous amount of CPU cycles that would otherwise have
been spent serializing object graphs from SQL, converting them into domain
objects, and using those objects to do application-level validation.</p>
</div>
<div class="section" id="distributed-consistency">
<h4>Distributed Consistency<a class="headerlink" href="#distributed-consistency" title="Permalink to this headline">¶</a></h4>
<p>Maintaining consistency within a single database node is relatively easy for
most databases. The real problems start to surface when you try to maintain
consistency between multiple database servers. If a client makes a write
operation on server <cite>A</cite>, how do we make sure that this is consistent with
server <cite>B</cite>, or <cite>C</cite>, or <cite>D</cite>? For relational databases, this is a very complex
problem with entire books devoted to its solution. You could use
multi-master, master/slave, partitioning, sharding, write-through caches,
and all sorts of other complex techniques.</p>
</div>
<div class="section" id="incremental-replication">
<h4>Incremental Replication<a class="headerlink" href="#incremental-replication" title="Permalink to this headline">¶</a></h4>
<p>CouchDB&#8217;s operations take place within the context of a single document.
As CouchDB achieves eventual consistency between multiple databases by using
incremental replication you no longer have to worry about your database
servers being able to stay in constant communication. Incremental replication
is a process where document changes are periodically copied between servers.
We are able to build what&#8217;s known as a <em>shared nothing</em> cluster of databases
where each node is independent and self-sufficient, leaving no single point
of contention across the system.</p>
<p>Need to scale out your CouchDB database cluster? Just throw in another server.</p>
<p>As illustrated in <a class="reference internal" href="contents.html#intro-consistency-04"><em>Figure 4. Incremental replication between CouchDB nodes</em></a>, with CouchDB&#8217;s incremental
replication, you can synchronize your data between any two databases however
you like and whenever you like. After replication, each database is able
to work independently.</p>
<p>You could use this feature to synchronize database servers within a cluster
or between data centers using a job scheduler such as cron,
or you could use it to synchronize data with your laptop for offline work as
you travel. Each database can be used in the usual fashion,
and changes between databases can be synchronized later in both directions.</p>
<div class="figure align-center" id="intro-consistency-04">
<img alt="Incremental replication between CouchDB nodes" src="_images/intro-consistency-04.png" />
<p class="caption">Figure 4. Incremental replication between CouchDB nodes</p>
</div>
<p>What happens when you change the same document in two different databases and
want to synchronize these with each other? CouchDB&#8217;s replication system
comes with automatic conflict detection and resolution. When CouchDB detects
that a document has been changed in both databases, it flags this document
as being in conflict, much like they would be in a regular version control
system.</p>
<p>This isn&#8217;t as troublesome as it might first sound. When two versions of a
document conflict during replication, the winning version is saved as the
most recent version in the document&#8217;s history. Instead of throwing the losing
version away, as you might expect, CouchDB saves this as a previous version
in the document&#8217;s history, so that you can access it if you need to. This
happens automatically and consistently, so both databases will make exactly
the same choice.</p>
<p>It is up to you to handle conflicts in a way that makes sense for your
application. You can leave the chosen document versions in place,
revert to the older version, or try to merge the two versions and save the
result.</p>
</div>
<div class="section" id="case-study">
<h4>Case Study<a class="headerlink" href="#case-study" title="Permalink to this headline">¶</a></h4>
<p>Greg Borenstein, a friend and coworker, built a small library for converting
Songbird playlists to JSON objects and decided to store these in CouchDB as
part of a backup application. The completed software uses CouchDB&#8217;s MVCC and
document revisions to ensure that Songbird playlists are backed up robustly
between nodes.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="http://en.wikipedia.org/wiki/Songbird_%28software%29">Songbird</a> is a free software media player with an integrated web browser,
based on the Mozilla XULRunner platform. Songbird is available for Microsoft
Windows, Apple Mac OS X, Solaris, and Linux.</p>
</div>
<p>Let&#8217;s examine the workflow of the Songbird backup application,
first as a user backing up from a single computer, and then using Songbird to
synchronize playlists between multiple computers. We&#8217;ll see how document
revisions turn what could have been a hairy problem into something that <em>just
works</em>.</p>
<p>The first time we use this backup application, we feed our playlists to the
application and initiate a backup. Each playlist is converted to a JSON
object and handed to a CouchDB database. As illustrated in
<a class="reference internal" href="contents.html#intro-consistency-05"><em>Figure 5. Backing up to a single database</em></a>, CouchDB hands back the document ID and
revision of each playlist as it&#8217;s saved to the database.</p>
<div class="figure align-center" id="intro-consistency-05">
<img alt="Backing up to a single database" src="_images/intro-consistency-05.png" />
<p class="caption">Figure 5. Backing up to a single database</p>
</div>
<p>After a few days, we find that our playlists have been updated and we want to
back up our changes. After we have fed our playlists to the backup
application, it fetches the latest versions from CouchDB,
along with the corresponding document revisions. When the application hands
back the new playlist document, CouchDB requires that the document revision
is included in the request.</p>
<p>CouchDB then makes sure that the document revision handed to it in the
request matches the current revision held in the database. Because CouchDB
updates the revision with every modification, if these two are out of sync it
suggests that someone else has made changes to the document between the time
we requested it from the database and the time we sent our updates. Making
changes to a document after someone else has modified it without first
inspecting those changes is usually a bad idea.</p>
<p>Forcing clients to hand back the correct document revision is the heart of
CouchDB&#8217;s optimistic concurrency.</p>
<p>We have a laptop we want to keep synchronized with our desktop computer.
With all our playlists on our desktop, the first step is to
&#8220;restore from backup&#8221; onto our laptop. This is the first time we&#8217;ve done this,
so afterward our laptop  should hold an exact replica of our desktop playlist
collection.</p>
<p>After editing our Argentine Tango playlist on our laptop to add a few new
songs we&#8217;ve purchased, we want to save our changes. The backup application
replaces the playlist document in our laptop CouchDB database and a new
document revision is generated. A few days later, we remember our new songs
and want to copy the playlist across to our desktop computer. As illustrated
in <a class="reference internal" href="contents.html#intro-consistency-06"><em>Figure 6. Synchronizing between two databases</em></a>, the backup application copies the new document
and the new revision to the desktop CouchDB database. Both CouchDB databases
now have the same document revision.</p>
<div class="figure align-center" id="intro-consistency-06">
<img alt="Synchronizing between two databases" src="_images/intro-consistency-06.png" />
<p class="caption">Figure 6. Synchronizing between two databases</p>
</div>
<p>Because CouchDB tracks document revisions, it ensures that updates like these
will work only if they are based on current information. If we had made
modifications to the playlist backups between synchronization,
things wouldn&#8217;t go as smoothly.</p>
<p>We back up some changes on our laptop and forget to synchronize. A few days
later, we&#8217;re editing playlists on our desktop computer, make a backup,
and want to synchronize this to our laptop. As illustrated in
<a class="reference internal" href="contents.html#intro-consistency-07"><em>Figure 7. Synchronization conflicts between two databases</em></a>, when our backup application tries to replicate
between the two databases, CouchDB sees that the changes being sent from our
desktop computer are modifications of out-of-date documents and helpfully
informs us that there has been a conflict.</p>
<p>Recovering from this error is easy to accomplish from an application
perspective. Just download CouchDB&#8217;s version of the playlist and provide an
opportunity to merge the changes or save local modifications into a new
playlist.</p>
<div class="figure align-center" id="intro-consistency-07">
<img alt="Synchronization conflicts between two databases" src="_images/intro-consistency-07.png" />
<p class="caption">Figure 7. Synchronization conflicts between two databases</p>
</div>
</div>
<div class="section" id="wrapping-up">
<h4>Wrapping Up<a class="headerlink" href="#wrapping-up" title="Permalink to this headline">¶</a></h4>
<p>CouchDB&#8217;s design borrows heavily from web architecture and the lessons
learned deploying massively distributed systems on that architecture.
By understanding why this architecture works the way it does,
and by learning to spot which parts of your application can be easily
distributed and which parts cannot, you&#8217;ll enhance your ability to design
distributed and scalable applications, with CouchDB or without it.</p>
<p>We&#8217;ve covered the main issues surrounding CouchDB&#8217;s consistency model and
hinted at some of the benefits to be had when you work <em>with</em> CouchDB and not
against it. But enough theory &#8211; let&#8217;s get up and running and see what all the
fuss is about!</p>
</div>
</div>
<span id="document-intro/tour"></span><div class="section" id="getting-started">
<span id="intro-tour"></span><h3>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h3>
<p>In this document, we&#8217;ll take a quick tour of CouchDB&#8217;s features,
familiarizing ourselves with Futon, the built-in administration interface.
We&#8217;ll create our first document and experiment with CouchDB views.</p>
<div class="section" id="all-systems-are-go">
<h4>All Systems Are Go!<a class="headerlink" href="#all-systems-are-go" title="Permalink to this headline">¶</a></h4>
<p>We&#8217;ll have a very quick look at CouchDB&#8217;s bare-bones Application Programming
Interface (API) by using the command-line utility curl. Please note that this
is not the only way of talking to CouchDB. We will show you plenty more
throughout the rest of the documents. What&#8217;s interesting about curl is that it
gives you control over raw HTTP requests, and you can see exactly what is
going on &#8220;underneath the hood&#8221; of your database.</p>
<p>Make sure CouchDB is still running, and then do:</p>
<div class="highlight-json"><div class="highlight"><pre>curl http://127.0.0.1:5984/
</pre></div>
</div>
<p>This issues a GET request to your newly installed CouchDB instance.</p>
<p>The reply should look something like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;couchdb&quot;</span><span class="o">:</span> <span class="s2">&quot;Welcome&quot;</span><span class="p">,</span>
  <span class="s2">&quot;uuid&quot;</span><span class="o">:</span> <span class="s2">&quot;85fb71bf700c17267fef77535820e371&quot;</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;1.4.0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;vendor&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;1.4.0&quot;</span><span class="p">,</span>
      <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;The Apache Software Foundation&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Not all that spectacular. CouchDB is saying &#8220;hello&#8221; with the running version
number.</p>
<p>Next, we can get a list of databases:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X GET http://127.0.0.1:5984/_all_dbs
</pre></div>
</div>
<p>All we added to the previous request is the _all_dbs string.</p>
<p>The response should look like:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">[</span><span class="s2">&quot;_replicator&quot;</span><span class="p">,</span><span class="s2">&quot;_users&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Oh, that&#8217;s right, we didn&#8217;t create any databases yet! All we see is an empty
list.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The curl command issues GET requests by default. You can issue POST requests
using <tt class="docutils literal"><span class="pre">curl</span> <span class="pre">-X</span> <span class="pre">POST</span></tt>. To make it easy to work with our terminal history,
we usually use the <tt class="docutils literal"><span class="pre">-X</span></tt> option even when issuing GET requests.
If we want to send a POST next time, all we have to change is the method.</p>
<p class="last">HTTP does a bit more under the hood than you can see in the examples here.
If you&#8217;re interested in every last detail that goes over the wire,
pass in the <tt class="docutils literal"><span class="pre">-v</span></tt> option (e.g., <tt class="docutils literal"><span class="pre">curl</span> <span class="pre">-vX</span> <span class="pre">GET</span></tt>), which will show you
the server curl tries to connect to, the request headers it sends,
and response headers it receives back. Great for debugging!</p>
</div>
<p>Let&#8217;s create a database:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://127.0.0.1:5984/baseball
</pre></div>
</div>
<p>CouchDB will reply with:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
<p>Retrieving the list of databases again shows some useful results this time:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X GET http://127.0.0.1:5984/_all_dbs
</pre></div>
</div>
<div class="highlight-json"><div class="highlight"><pre><span class="p">[</span><span class="s2">&quot;baseball&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>We should mention JavaScript Object Notation (JSON) here,
the data format CouchDB speaks. JSON is a lightweight data interchange format
based on JavaScript syntax. Because JSON is natively compatible with
JavaScript, your web browser is an ideal client for CouchDB.</p>
<p class="last">Brackets (<tt class="docutils literal"><span class="pre">[]</span></tt>) represent ordered lists, and curly braces (<tt class="docutils literal"><span class="pre">{}</span></tt>) represent
key/value dictionaries. Keys must be strings, delimited by quotes (<tt class="docutils literal"><span class="pre">&quot;</span></tt>),
and values can be strings, numbers, booleans, lists,
or key/value dictionaries. For a more detailed description of JSON,
see Appendix E, JSON Primer.</p>
</div>
<p>Let&#8217;s create another database:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://127.0.0.1:5984/baseball
</pre></div>
</div>
<p>CouchDB will reply with:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="s2">&quot;file_exists&quot;</span><span class="p">,</span><span class="nt">&quot;reason&quot;</span><span class="p">:</span><span class="s2">&quot;The database could not be created,</span>
<span class="s2">the file already exists.&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>We already have a database with that name, so CouchDB will respond with an
error. Let&#8217;s try again with a different database name:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://127.0.0.1:5984/plankton
</pre></div>
</div>
<p>CouchDB will reply with:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
<p>Retrieving the list of databases yet again shows some useful results:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X GET http://127.0.0.1:5984/_all_dbs
</pre></div>
</div>
<p>CouchDB will respond with:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">[</span><span class="s2">&quot;baseball&quot;</span><span class="p">,</span> <span class="s2">&quot;plankton&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>To round things off, let&#8217;s delete the second database:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X DELETE http://127.0.0.1:5984/plankton
</pre></div>
</div>
<p>CouchDB will reply with:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
<p>The list of databases is now the same as it was before:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X GET http://127.0.0.1:5984/_all_dbs
</pre></div>
</div>
<p>CouchDB will respond with:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">[</span><span class="s2">&quot;baseball&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>For brevity, we&#8217;ll skip working with documents, as the next section covers a
different and potentially easier way of working with CouchDB that should
provide experience with this. As we work through the example,
keep in mind that &#8220;under the hood&#8221; everything is being done by the
application exactly as you have been doing here manually.
Everything is done using GET, PUT, POST, and DELETE with a URI.</p>
</div>
<div class="section" id="welcome-to-futon">
<h4>Welcome to Futon<a class="headerlink" href="#welcome-to-futon" title="Permalink to this headline">¶</a></h4>
<p>After having seen CouchDB&#8217;s raw API, let&#8217;s get our feet wet by playing with
Futon, the built-in administration interface. Futon provides full access to
all of CouchDB&#8217;s features and makes it easy to work with some of the more
complex ideas involved. With Futon we can create and destroy databases; view
and edit documents; compose and run MapReduce views; and trigger replication
between databases.</p>
<p>To load Futon in your browser, visit:</p>
<div class="highlight-json"><div class="highlight"><pre>http://127.0.0.1:5984/_utils/
</pre></div>
</div>
<p>If you&#8217;re running version 0.9 or later, you should see something similar to
<a class="reference internal" href="contents.html#intro-tour-01"><em>Figure 1. The Futon welcome screen</em></a>. In later documents, we&#8217;ll focus on using CouchDB from
server-side languages such as Ruby and Python. As such, this document is a great
opportunity to showcase an example of natively serving up a dynamic web
application using nothing more than CouchDB&#8217;s integrated web server, something
you may wish to do with your own applications.</p>
<p>The first thing we should do with a fresh installation of CouchDB is run the
test suite to verify that everything is working properly. This assures us
that any problems we may run into aren&#8217;t due to bothersome issues with our
setup. By the same token, failures in the Futon test suite are a red flag,
telling us to double-check our installation before attempting to use a
potentially broken database server, saving us the confusion when nothing
seems to be working quite like we expect!</p>
<div class="figure align-center" id="intro-tour-01">
<img alt="The Futon welcome screen" src="_images/intro-tour-01.png" />
<p class="caption">Figure 1. The Futon welcome screen</p>
</div>
<p>Some common network configurations cause the replication test to fail when
accessed via the localhost address. You can fix this by accessing CouchDB via
127.0.0.1, e.g. <a class="reference external" href="http://127.0.0.1:5984/_utils/">http://127.0.0.1:5984/_utils/</a>.</p>
<p>Navigate to the test suite by clicking &#8220;Test Suite&#8221; on the Futon sidebar,
then click &#8220;run all&#8221; at the top to kick things off. <a class="reference internal" href="contents.html#intro-tour-02"><em>Figure 2. The Futon test suite running some tests</em></a>
shows the Futon test suite running some tests.</p>
<div class="figure align-center" id="intro-tour-02">
<img alt="The Futon test suite running some tests" src="_images/intro-tour-02.png" />
<p class="caption">Figure 2. The Futon test suite running some tests</p>
</div>
<p>Because the test suite is run from the browser, not only does it test that
CouchDB is functioning properly, it also verifies that your browser&#8217;s
connection to the database is properly configured, which can be very handy
for diagnosing misbehaving proxies or other HTTP middleware.</p>
<p>If the test suite has an inordinate number of failures,
you&#8217;ll need to see the troubleshooting section in Appendix D,
Installing from Source for the next steps to fix your installation.</p>
<p>Now that the test suite is finished, you&#8217;ve verified that your CouchDB
installation is successful and you&#8217;re ready to see what else Futon has to offer.</p>
</div>
<div class="section" id="your-first-database-and-document">
<h4>Your First Database and Document<a class="headerlink" href="#your-first-database-and-document" title="Permalink to this headline">¶</a></h4>
<p>Creating a database in Futon is simple. From the overview page,
click &#8220;Create Database.&#8221; When asked for a name, enter hello-world and click
the Create button.</p>
<p>After your database has been created, Futon will display a list of all its
documents. This list will start out empty (<a class="reference internal" href="contents.html#intro-tour-03"><em>Figure 3. An empty database in Futon</em></a>), so let&#8217;s
create our first document. Click the &#8220;New Document&#8221; link and then the Create
button in the pop up. Make sure to leave the document ID blank,
and CouchDB will generate a UUID for you.</p>
<p>For demoing purposes, having CouchDB assign a UUID is fine. When you write
your first programs, we recommend assigning your own UUIDs. If your rely on
the server to generate the UUID and you end up making two POST requests
because the first POST request bombed out, you might generate two docs and
never find out about the first one because only the second one will be
reported back. Generating your own UUIDs makes sure that you&#8217;ll never end up
with duplicate documents.</p>
<p>Futon will display the newly created document, with its _id and _rev as the
only fields. To create a new field, click the &#8220;Add Field&#8221; button. We&#8217;ll call
the new field hello. Click the green check icon (or hit the Enter key) to
finalize creating the hello field. Double-click the hello field&#8217;s value
(default null) to edit it.</p>
<p>You can experiment with other JSON values; e.g., <tt class="docutils literal"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">&quot;c&quot;]</span></tt> or
<tt class="docutils literal"><span class="pre">{&quot;foo&quot;:</span> <span class="pre">&quot;bar&quot;}</span></tt>. Once you&#8217;ve entered your values into the document,
make a note of its <tt class="docutils literal"><span class="pre">_rev</span></tt> attribute and click &#8220;Save Document.&#8221; The result
should look like <a class="reference internal" href="contents.html#intro-tour-04"><em>Figure 4. A &#8220;hello world&#8221; document in Futon</em></a>.</p>
<div class="figure align-center" id="intro-tour-03">
<img alt="An empty database in Futon" src="_images/intro-tour-03.png" />
<p class="caption">Figure 3. An empty database in Futon</p>
</div>
<div class="figure align-center" id="intro-tour-04">
<img alt="A &quot;hello world&quot; document in Futon" src="_images/intro-tour-04.png" />
<p class="caption">Figure 4. A &#8220;hello world&#8221; document in Futon</p>
</div>
<p>You&#8217;ll notice that the document&#8217;s _rev has changed. We&#8217;ll go into more detail
about this in later documents, but for now, the important thing to note is
that _rev acts like a safety feature when saving a document. As long as you
and CouchDB agree on the most recent _rev of a document, you can successfully
save your changes.</p>
<p>Futon also provides a way to display the underlying JSON data,
which can be more compact and easier to read, depending on what sort of data
you are dealing with. To see the JSON version of our &#8220;hello world&#8221; document,
click the Source tab. The result should look like <a class="reference internal" href="contents.html#intro-tour-05"><em>Figure 5. The JSON source of a &#8220;hello world&#8221; document in Futon</em></a>.</p>
<div class="figure align-center" id="intro-tour-05">
<img alt="The JSON source of a &quot;hello world&quot; document in Futon" src="_images/intro-tour-05.png" />
<p class="caption">Figure 5. The JSON source of a &#8220;hello world&#8221; document in Futon</p>
</div>
</div>
<div class="section" id="running-a-query-using-mapreduce">
<h4>Running a Query Using MapReduce<a class="headerlink" href="#running-a-query-using-mapreduce" title="Permalink to this headline">¶</a></h4>
<p>Traditional relational databases allow you to run any queries you like as
long as your data is structured correctly. In contrast,
CouchDB uses predefined map and reduce functions in a style known as
MapReduce. These functions provide great flexibility because they can adapt
to variations in document structure, and indexes for each document can be
computed independently and in parallel. The combination of a map and a reduce
function is called a view in CouchDB terminology.</p>
<p>For experienced relational database programmers, MapReduce can take some
getting used to. Rather than declaring which rows from which tables to
include in a result set and depending on the database to determine the most
efficient way to run the query, reduce queries are based on simple range
requests against the indexes generated by your map functions.</p>
<p>Map functions are called once with each document as the argument.
The function can choose to skip the document altogether or emit one or more
view rows as key/value pairs. Map functions may not depend on any information
outside of the document. This independence is what allows CouchDB views to be
generated incrementally and in parallel.</p>
<p>CouchDB views are stored as rows that are kept sorted by key. This makes
retrieving data from a range of keys efficient even when there are thousands
or millions of rows. When writing CouchDB map functions,
your primary goal is to build an index that stores related data under nearby
keys.</p>
<p>Before we can run an example MapReduce view, we&#8217;ll need some data to run it
on. We&#8217;ll create documents carrying the price of various supermarket items as
found at different shops. Let&#8217;s create documents for apples, oranges,
and bananas. (Allow CouchDB to generate the _id and _rev fields.) Use Futon
to create documents that have a final JSON structure that looks like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
 <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;00a271787f89c0ef2e10e88a0c0001f4&quot;</span><span class="p">,</span>
 <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-2628a75ac8c3abfffc8f6e30c9949fd6&quot;</span><span class="p">,</span>
 <span class="s2">&quot;item&quot;</span><span class="o">:</span> <span class="s2">&quot;apple&quot;</span><span class="p">,</span>
 <span class="s2">&quot;prices&quot;</span><span class="o">:</span> <span class="p">{</span>
     <span class="s2">&quot;Fresh Mart&quot;</span><span class="o">:</span> <span class="mf">1.59</span><span class="p">,</span>
     <span class="s2">&quot;Price Max&quot;</span><span class="o">:</span> <span class="mf">5.99</span><span class="p">,</span>
     <span class="s2">&quot;Apples Express&quot;</span><span class="o">:</span> <span class="mf">0.79</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This document should look like <a class="reference internal" href="contents.html#intro-tour-06"><em>Figure 6. An example document with apple prices in Futon</em></a> when entered into Futon.</p>
<div class="figure align-center" id="intro-tour-06">
<img alt="An example document with apple prices in Futon" src="_images/intro-tour-06.png" />
<p class="caption">Figure 6. An example document with apple prices in Futon</p>
</div>
<p>OK, now that that&#8217;s done, let&#8217;s create the document for oranges:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
 <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;00a271787f89c0ef2e10e88a0c0003f0&quot;</span><span class="p">,</span>
 <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-e9680c5d9a688b4ff8dd68549e8e072c&quot;</span><span class="p">,</span>
 <span class="s2">&quot;item&quot;</span><span class="o">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
 <span class="s2">&quot;prices&quot;</span><span class="o">:</span> <span class="p">{</span>
     <span class="s2">&quot;Fresh Mart&quot;</span><span class="o">:</span> <span class="mf">1.99</span><span class="p">,</span>
     <span class="s2">&quot;Price Max&quot;</span><span class="o">:</span> <span class="mf">3.19</span><span class="p">,</span>
     <span class="s2">&quot;Citrus Circus&quot;</span><span class="o">:</span> <span class="mf">1.09</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And finally, the document for bananas:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
 <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;00a271787f89c0ef2e10e88a0c00048b&quot;</span><span class="p">,</span>
 <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-60e25d93dc12884676d037400a6fa189&quot;</span><span class="p">,</span>
 <span class="s2">&quot;item&quot;</span><span class="o">:</span> <span class="s2">&quot;banana&quot;</span><span class="p">,</span>
 <span class="s2">&quot;prices&quot;</span><span class="o">:</span> <span class="p">{</span>
     <span class="s2">&quot;Fresh Mart&quot;</span><span class="o">:</span> <span class="mf">1.99</span><span class="p">,</span>
     <span class="s2">&quot;Price Max&quot;</span><span class="o">:</span> <span class="mf">0.79</span><span class="p">,</span>
     <span class="s2">&quot;Banana Montana&quot;</span><span class="o">:</span> <span class="mf">4.22</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Imagine we&#8217;re catering a big luncheon, but the client is very price-sensitive.
To find the lowest prices, we&#8217;re going to create our first view,
which shows each fruit sorted by price. Click &#8220;hello-world&#8221; to return to the
hello-world overview, and then from the &#8220;select view&#8221; menu choose &#8220;Temporary
view…&#8221; to create a new view.</p>
<div class="figure align-center">
<img alt="A temporary view in Futon" src="_images/intro-tour-07.png" />
<p class="caption">Figure 7. A temporary view in Futon</p>
</div>
<p>Edit the map function, on the left, so that it looks like the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">shop</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">value</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">item</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">prices</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">shop</span> <span class="k">in</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">prices</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">price</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">prices</span><span class="p">[</span><span class="nx">shop</span><span class="p">];</span>
          <span class="nx">value</span> <span class="o">=</span> <span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span> <span class="nx">shop</span><span class="p">];</span>
          <span class="nx">emit</span><span class="p">(</span><span class="nx">price</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is a JavaScript function that CouchDB runs for each of our documents as
it computes the view. We&#8217;ll leave the reduce function blank for the time being.</p>
<p>Click &#8220;Run&#8221; and you should see result rows like in <a class="reference internal" href="contents.html#intro-tour-08"><em>Figure 8. The results of running a view in Futon</em></a>,
with the various items sorted by price. This map function could be even more
useful if it grouped the items by type so that all the prices for bananas were
next to each other in the result set. CouchDB&#8217;s key sorting system allows any
valid JSON object as a key. In this case, we&#8217;ll emit an array of [item, price]
so that CouchDB groups by item type and price.</p>
<div class="figure align-center" id="intro-tour-08">
<img alt="The results of running a view in Futon" src="_images/intro-tour-08.png" />
<p class="caption">Figure 8. The results of running a view in Futon</p>
</div>
<p>Let&#8217;s modify the view function so that it looks like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">shop</span><span class="p">,</span> <span class="nx">price</span><span class="p">,</span> <span class="nx">key</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">item</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">prices</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">shop</span> <span class="k">in</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">prices</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">price</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">prices</span><span class="p">[</span><span class="nx">shop</span><span class="p">];</span>
          <span class="nx">key</span> <span class="o">=</span> <span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">item</span><span class="p">,</span> <span class="nx">price</span><span class="p">];</span>
          <span class="nx">emit</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">shop</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, we first check that the document has the fields we want to use. CouchDB
recovers gracefully from a few isolated map function failures,
but when a map function fails regularly (due to a missing required field or
other JavaScript exception), CouchDB shuts off its indexing to prevent any
further resource usage. For this reason, it&#8217;s important to check for the
existence of any fields before you use them. In this case,
our map function will skip the first &#8220;hello world&#8221; document we created
without emitting any rows or encountering any errors. The result of this
query should look like <a class="reference internal" href="contents.html#intro-tour-09"><em>Figure 9. The results of running a view after grouping by item type and price</em></a>.</p>
<div class="figure align-center" id="intro-tour-09">
<img alt="The results of running a view after grouping by item type and price" src="_images/intro-tour-09.png" />
<p class="caption">Figure 9. The results of running a view after grouping by item type and price</p>
</div>
<p>Once we know we&#8217;ve got a document with an item type and some prices,
we iterate over the item&#8217;s prices and emit key/values pairs. The key is an
array of the item and the price, and forms the basis for CouchDB&#8217;s sorted
index. In this case, the value is the name of the shop where the item can be
found for the listed price.</p>
<p>View rows are sorted by their keys &#8211; in this example, first by item,
then by price. This method of complex sorting is at the heart of creating
useful indexes with CouchDB.</p>
<p>MapReduce can be challenging, especially if you&#8217;ve spent years working with
relational databases. The important things to keep in mind are that map
functions give you an opportunity to sort your data using any key you choose,
and that CouchDB&#8217;s design is focused on providing fast,
efficient access to data within a range of keys.</p>
</div>
<div class="section" id="triggering-replication">
<h4>Triggering Replication<a class="headerlink" href="#triggering-replication" title="Permalink to this headline">¶</a></h4>
<p>Futon can trigger replication between two local databases,
between a local and remote database, or even between two remote databases.
We&#8217;ll show you how to replicate data from one local database to another,
which is a simple way of making backups of your databases as we&#8217;re working
through the examples.</p>
<p>First we&#8217;ll need to create an empty database to be the target of replication.
Return to the overview and create a database called hello-replication.
Now click &#8220;Replicator&#8221; in the sidebar and choose hello-world as the source
and hello-replication as the target. Click &#8220;Replicate&#8221; to replicate your
database. The result should look something like <a class="reference internal" href="contents.html#intro-tour-10"><em>Figure 10. Running database replication in Futon</em></a>.</p>
<div class="figure align-center" id="intro-tour-10">
<img alt="Running database replication in Futon" src="_images/intro-tour-10.png" />
<p class="caption">Figure 10. Running database replication in Futon</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For larger databases, replication can take much longer. It is important to
leave the browser window open while replication is taking place.
As an alternative, you can trigger replication via curl or some other HTTP
client that can handle long-running connections. If your client closes the
connection before replication finishes, you&#8217;ll have to retrigger it.
Luckily, CouchDB&#8217;s replication can take over from where it left off
instead of starting from scratch.</p>
</div>
</div>
<div class="section" id="wrapping-up">
<h4>Wrapping Up<a class="headerlink" href="#wrapping-up" title="Permalink to this headline">¶</a></h4>
<p>Now that you&#8217;ve seen most of Futon&#8217;s features, you&#8217;ll be prepared to dive in
and inspect your data as we build our example application in the next few
documents. Futon&#8217;s pure JavaScript approach to managing CouchDB shows how it&#8217;s
possible to build a fully featured web application using only CouchDB&#8217;s HTTP
API and integrated web server.</p>
<p>But before we get there, we&#8217;ll have another look at CouchDB&#8217;s HTTP API &#8211; now
with a magnifying glass. Let&#8217;s curl up on the couch and relax.</p>
</div>
</div>
<span id="document-intro/api"></span><div class="section" id="the-core-api">
<span id="intro-api"></span><h3>The Core API<a class="headerlink" href="#the-core-api" title="Permalink to this headline">¶</a></h3>
<p>This document explores the CouchDB in minute detail. It shows all the
nitty-gritty and clever bits. We show you best practices and guide you around
common pitfalls.</p>
<p>We start out by revisiting the basic operations we ran in the previous document
<a class="reference internal" href="contents.html#intro-tour"><em>Getting Started</em></a>, looking behind the scenes. We also show what Futon needs to
do behind its user interface to give us the nice features we saw earlier.</p>
<p>This document is both an introduction to the core CouchDB API as well as a
reference. If you can&#8217;t remember how to run a particular request or why some
parameters are needed, you can always come back here and look things up (we
are probably the heaviest users of this document).</p>
<p>While explaining the API bits and pieces, we sometimes need to take a larger
detour to explain the reasoning for a particular request. This is a good
opportunity for us to tell you why CouchDB works the way it does.</p>
<p>The API can be subdivided into the following sections. We&#8217;ll explore them
individually:</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#server" id="id1">Server</a></li>
<li><a class="reference internal" href="#databases" id="id2">Databases</a></li>
<li><a class="reference internal" href="#documents" id="id3">Documents</a></li>
<li><a class="reference internal" href="#replication" id="id4">Replication</a></li>
<li><a class="reference internal" href="#wrapping-up" id="id5">Wrapping Up</a></li>
</ul>
</div>
<div class="section" id="server">
<h4><a class="toc-backref" href="#id1">Server</a><a class="headerlink" href="#server" title="Permalink to this headline">¶</a></h4>
<p>This one is basic and simple. It can serve as a sanity check to see if
CouchDB is running at all. It can also act as a safety guard for libraries
that require a certain version of CouchDB. We&#8217;re using the <a class="reference external" href="http://curl.haxx.se/">curl</a> utility
again:</p>
<div class="highlight-json"><div class="highlight"><pre>curl http://127.0.0.1:5984/
</pre></div>
</div>
<p>CouchDB replies, all excited to get going:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;couchdb&quot;</span><span class="o">:</span> <span class="s2">&quot;Welcome&quot;</span><span class="p">,</span>
  <span class="s2">&quot;uuid&quot;</span><span class="o">:</span> <span class="s2">&quot;85fb71bf700c17267fef77535820e371&quot;</span><span class="p">,</span>
  <span class="s2">&quot;vendor&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;The Apache Software Foundation&quot;</span><span class="p">,</span>
      <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;1.5.0&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;1.5.0&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You get back a JSON string, that, if parsed into a native object or data
structure of your programming language, gives you access to the welcome
string and version information.</p>
<p>This is not terribly useful, but it illustrates nicely the way CouchDB
behaves. You send an HTTP request and you receive a JSON string in the HTTP
response as a result.</p>
</div>
<div class="section" id="databases">
<h4><a class="toc-backref" href="#id2">Databases</a><a class="headerlink" href="#databases" title="Permalink to this headline">¶</a></h4>
<p>Now let&#8217;s do something a little more useful: <em>create databases</em>.
For the strict, CouchDB is a <em>database management system</em> (DMS). That means it
can hold multiple databases. A database is a bucket that holds &#8220;related data&#8221;.
We&#8217;ll explore later what that means exactly. In practice, the terminology is
overlapping &#8211; often people refer to a DMS as &#8220;a database&#8221; and also a database
within the DMS as &#8220;a database.&#8221; We might follow that slight oddity, so don&#8217;t
get confused by it. In general, it should be clear from the context if we are
talking about the whole of CouchDB or a single database within CouchDB.</p>
<p>Now let&#8217;s make one! We want to store our favorite music albums,
and we creatively give our database the name albums. Note that we&#8217;re now
using the <tt class="docutils literal"><span class="pre">-X</span></tt> option again to tell curl to send a <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">PUT</a> request
instead of the default <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.3">GET</a> request:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://127.0.0.1:5984/albums
</pre></div>
</div>
<p>CouchDB replies:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
<p>That&#8217;s it. You created a database and CouchDB told you that all went well.
What happens if you try to create a database that already exists? Let&#8217;s try
to create that database again:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://127.0.0.1:5984/albums
</pre></div>
</div>
<p>CouchDB replies:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="o">:</span><span class="s2">&quot;file_exists&quot;</span><span class="p">,</span><span class="s2">&quot;reason&quot;</span><span class="o">:</span><span class="s2">&quot;The database could not be created, the file already exists.&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>We get back an error. This is pretty convenient. We also learn a little bit
about how CouchDB works. CouchDB stores each database in a single file.
Very simple.</p>
<p>Let&#8217;s create another database, this time with curl&#8217;s <tt class="docutils literal"><span class="pre">-v</span></tt> (for &#8220;verbose&#8221;)
option. The verbose option tells curl to show us not only the essentials &#8211;
the HTTP response body &#8211; but all the underlying request and response details:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -vX PUT http://127.0.0.1:5984/albums-backup
</pre></div>
</div>
<p>curl elaborates:</p>
<div class="highlight-json"><div class="highlight"><pre>* About to connect() to 127.0.0.1 port 5984 (#0)
*   Trying 127.0.0.1... connected
* Connected to 127.0.0.1 (127.0.0.1) port 5984 (#0)
&gt; PUT /albums-backup HTTP/1.1
&gt; User-Agent: curl/7.16.3 (powerpc-apple-darwin9.0) libcurl/7.16.3 OpenSSL/0.9.7l zlib/1.2.3
&gt; Host: 127.0.0.1:5984
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 201 Created
&lt; Server: CouchDB (Erlang/OTP)
&lt; Date: Sun, 05 Jul 2009 22:48:28 GMT
&lt; Content-Type: text/plain;charset=utf-8
&lt; Content-Length: 12
&lt; Cache-Control: must-revalidate
&lt;
{&quot;ok&quot;:true}
* Connection #0 to host 127.0.0.1 left intact
* Closing connection #0
</pre></div>
</div>
<p>What a mouthful. Let&#8217;s step through this line by line to understand what&#8217;s
going on and find out what&#8217;s important. Once you&#8217;ve seen this output a few
times, you&#8217;ll be able to spot the important bits more easily.</p>
<div class="highlight-json"><div class="highlight"><pre>* About to connect() to 127.0.0.1 port 5984 (#0)
</pre></div>
</div>
<p>This is curl telling us that it is going to establish a TCP connection to the
CouchDB server we specified in our request URI. Not at all important,
except when debugging networking issues.</p>
<div class="highlight-json"><div class="highlight"><pre>*   Trying 127.0.0.1... connected
* Connected to 127.0.0.1 (127.0.0.1) port 5984 (#0)
</pre></div>
</div>
<p>curl tells us it successfully connected to CouchDB. Again,
not important if you aren&#8217;t trying to find problems with your network.</p>
<p>The following lines are prefixed with <tt class="docutils literal"><span class="pre">&gt;</span></tt> and <tt class="docutils literal"><span class="pre">&lt;</span></tt> characters.
The <tt class="docutils literal"><span class="pre">&gt;</span></tt> means the line was sent to CouchDB verbatim (without the actual
<tt class="docutils literal"><span class="pre">&gt;</span></tt>). The <tt class="docutils literal"><span class="pre">&lt;</span></tt> means the line was sent back to curl by CouchDB.</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; PUT /albums-backup HTTP/1.1
</pre></div>
</div>
<p>This initiates an HTTP request. Its <em>method</em> is <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">PUT</a>, the <em>URI</em> is
<tt class="docutils literal"><span class="pre">/albums-backup</span></tt>, and the HTTP version is <tt class="docutils literal"><span class="pre">HTTP/1.1</span></tt>. There is also
<tt class="docutils literal"><span class="pre">HTTP/1.0</span></tt>, which is simpler in some cases, but for all practical reasons
you should be using <tt class="docutils literal"><span class="pre">HTTP/1.1</span></tt>.</p>
<p>Next, we see a number of <em>request headers</em>. These are used to provide
additional details about the request to CouchDB.</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; User-Agent: curl/7.16.3 (powerpc-apple-darwin9.0) libcurl/7.16.3 OpenSSL/0.9.7l zlib/1.2.3
</pre></div>
</div>
<p>The User-Agent header tells CouchDB which piece of client software is doing
the HTTP request. We don&#8217;t learn anything new: it&#8217;s curl. This header is
often useful in web development when there are known errors in client
implementations that a server might want to prepare the response for.
It also helps to determine which platform a user is on. This information
can be used for technical and statistical reasons. For CouchDB, the
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.43">User-Agent</a> header is irrelevant.</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; Host: 127.0.0.1:5984
</pre></div>
</div>
<p>The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.23">Host</a> header is required by <tt class="docutils literal"><span class="pre">HTTP</span> <span class="pre">1.1</span></tt>. It tells the server
the hostname that came with the request.</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; Accept: */*
</pre></div>
</div>
<p>The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> header tells CouchDB that curl accepts any media type.
We&#8217;ll look into why this is useful a little later.</p>
<div class="highlight-json"><div class="highlight"><pre>&gt;
</pre></div>
</div>
<p>An empty line denotes that the request headers are now finished and the rest
of the request contains data we&#8217;re sending to the server. In this case,
we&#8217;re not sending any data, so the rest of the curl output is dedicated to
the HTTP response.</p>
<div class="highlight-json"><div class="highlight"><pre>&lt; HTTP/1.1 201 Created
</pre></div>
</div>
<p>The first line of CouchDB&#8217;s HTTP response includes the HTTP version
information (again, to acknowledge that the requested version could be
processed), an HTTP <em>status code</em>, and a <em>status code message</em>.
Different requests trigger different response codes. There&#8217;s a whole range of
them telling the client (curl in our case) what effect the request had on the
server. Or, if an error occurred, what kind of error. <span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2616.html"><strong>RFC 2616</strong></a> (the HTTP 1.1
specification) defines clear behavior for response codes. CouchDB fully
follows the RFC.</p>
<p>The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> status code tells the client that the resource
the request was made against was successfully created. No surprise here,
but if you remember that we got an error message when we tried to create this
database twice, you now know that this response could include a different
response code. Acting upon responses based on response codes is a common
practice. For example, all response codes of <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> or larger
tell you that some error occurred. If you want to shortcut your logic and
immediately deal with the error, you could just check a &gt;= <tt class="docutils literal"><span class="pre">400</span></tt> response
code.</p>
<div class="highlight-json"><div class="highlight"><pre>&lt; Server: CouchDB (Erlang/OTP)
</pre></div>
</div>
<p>The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.38">Server</a> header is good for diagnostics. It tells us which
CouchDB version and which underlying Erlang version we are talking to.
In general, you can ignore this header, but it is good to know it&#8217;s there if
you need it.</p>
<div class="highlight-json"><div class="highlight"><pre>&lt; Date: Sun, 05 Jul 2009 22:48:28 GMT
</pre></div>
</div>
<p>The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.18">Date</a> header tells you the time of the server. Since client
and server time are not necessarily synchronized, this header is purely
informational. You shouldn&#8217;t build any critical application logic on top
of this!</p>
<div class="highlight-json"><div class="highlight"><pre>&lt; Content-Type: text/plain;charset=utf-8
</pre></div>
</div>
<p>The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> header tells you which MIME type
the HTTP response body is and its encoding. We already know CouchDB returns
JSON strings. The appropriate <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> header is
<em class="mimetype">application/json</em>. Why do we see <em class="mimetype">text/plain</em>?
This is where pragmatism wins over purity. Sending an
<em class="mimetype">application/json</em> <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> header will make
a browser offer you the returned JSON for download instead of
just displaying it. Since it is extremely useful to be able to test CouchDB
from a browser, CouchDB sends a <em class="mimetype">text/plain</em> content type, so all
browsers will display the JSON as text.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are some extensions that make your browser JSON-aware,
but they are not installed by default. For more information, look at
the popular <a class="reference external" href="http://jsonview.com/">JSONView</a> extension, available for both Firefox and Chrome.</p>
</div>
<p>Do you remember the <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> request header and how it is set to
<tt class="docutils literal"><span class="pre">\*/\*</span> <span class="pre">-&gt;</span> <span class="pre">*/*</span></tt> to express interest in any MIME type? If you send <tt class="docutils literal"><span class="pre">Accept:</span>
<span class="pre">application/json</span></tt> in your request, CouchDB knows that you can deal with a pure
JSON response with the proper <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> header and will
use it instead of <em class="mimetype">text/plain</em>.</p>
<div class="highlight-json"><div class="highlight"><pre>&lt; Content-Length: 12
</pre></div>
</div>
<p>The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.13">Content-Length</a> header simply tells us how many bytes
the response body has.</p>
<div class="highlight-json"><div class="highlight"><pre>&lt; Cache-Control: must-revalidate
</pre></div>
</div>
<p>This <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9">Cache-Control</a> header tells you, or any proxy server between
CouchDB and you, not to cache this response.</p>
<div class="highlight-json"><div class="highlight"><pre>&lt;
</pre></div>
</div>
<p>This empty line tells us we&#8217;re done with the response headers and what
follows now is the response body.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
<p>We&#8217;ve seen this before.</p>
<div class="highlight-json"><div class="highlight"><pre>* Connection #0 to host 127.0.0.1 left intact
* Closing connection #0
</pre></div>
</div>
<p>The last two lines are curl telling us that it kept the TCP connection it
opened in the beginning open for a moment, but then closed it after it
received the entire response.</p>
<p>Throughout the documents, we&#8217;ll show more requests with the <tt class="docutils literal"><span class="pre">-v</span></tt> option,
but we&#8217;ll omit some of the headers we&#8217;ve seen here and include only those
that are important for the particular request.</p>
<p>Creating databases is all fine, but how do we get rid of one? Easy &#8211; just
change the HTTP method:</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; curl -vX DELETE http://127.0.0.1:5984/albums-backup
</pre></div>
</div>
<p>This deletes a CouchDB database. The request will remove the file that the
database contents are stored in. There is no <em>&#8220;Are you sure?&#8221;</em> safety net or
any <em>&#8220;Empty the trash&#8221;</em> magic you&#8217;ve got to do to delete a database. Use this
command with care. Your data will be deleted without a chance to bring it
back easily if you don&#8217;t have a backup copy.</p>
<p>This section went knee-deep into HTTP and set the stage for discussing the
rest of the core CouchDB API. Next stop: documents.</p>
</div>
<div class="section" id="documents">
<h4><a class="toc-backref" href="#id3">Documents</a><a class="headerlink" href="#documents" title="Permalink to this headline">¶</a></h4>
<p>Documents are CouchDB&#8217;s central data structure. The idea behind a document
is, unsurprisingly, that of a real-world document &#8211; a sheet of paper such as
an invoice, a recipe, or a business card. We already learned that CouchDB uses
the JSON format to store documents. Let&#8217;s see how this storing works at the
lowest level.</p>
<p>Each document in CouchDB has an <em>ID</em>. This ID is unique per database. You are
free to choose any string to be the ID, but for best results we recommend a
<a class="reference external" href="http://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a> (or <a class="reference external" href="http://en.wikipedia.org/wiki/Globally_unique_identifier">GUID</a>), i.e., a Universally (or Globally) Unique IDentifier.
UUIDs are random numbers that have such a low collision probability that
everybody can make thousands of UUIDs a minute for millions of years without
ever creating a duplicate. This is a great way to ensure two independent people
cannot create two different documents with the same ID. Why should you care
what somebody else is doing? For one, that somebody else could be you at a
later time or on a different computer; secondly, CouchDB replication lets you
share documents with others and using UUIDs ensures that it all works.
But more on that later; let&#8217;s make some documents:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af -d &#39;{&quot;title&quot;:&quot;There is Nothing Left to Lose&quot;,&quot;artist&quot;:&quot;Foo Fighters&quot;}&#39;
</pre></div>
</div>
<p>CouchDB replies:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6e1295ed6c29495e54cc05947f18c8af&quot;</span><span class="p">,</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-2902191555&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>The curl command appears complex, but let&#8217;s break it down.
First, <tt class="docutils literal"><span class="pre">-X</span> <span class="pre">PUT</span></tt> tells curl to make a <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">PUT</a> request.
It is followed by the URL that specifies your CouchDB IP address and port.
The resource part of the URL <tt class="docutils literal"><span class="pre">/albums/6e1295ed6c29495e54cc05947f18c8af</span></tt>
specifies the location of a document inside our albums database.
The wild collection of numbers and characters is a UUID. This UUID is your
document&#8217;s ID. Finally, the <tt class="docutils literal"><span class="pre">-d</span></tt> flag tells curl to use the following
string as the body for the <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">PUT</a> request. The string is a simple JSON
structure including <tt class="docutils literal"><span class="pre">title</span></tt> and <tt class="docutils literal"><span class="pre">artist</span></tt> attributes with their respective
values.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you don&#8217;t have a UUID handy, you can ask CouchDB to give you one (in fact,
that is what we did just now without showing you). Simply send a
<a class="reference internal" href="contents.html#get--_uuids" title="GET /_uuids"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/_uuids</span></tt></a> request:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X GET http://127.0.0.1:5984/_uuids
</pre></div>
</div>
<p>CouchDB replies:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;uuids&quot;</span><span class="o">:</span><span class="p">[</span><span class="s2">&quot;6e1295ed6c29495e54cc05947f18c8af&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<p class="last">Voilà, a UUID. If you need more than one, you can pass in the <tt class="docutils literal"><span class="pre">?count=10</span></tt> HTTP
parameter to request 10 UUIDs, or really, any number you need.</p>
</div>
<p>To double-check that CouchDB isn&#8217;t lying about having saved your document (it
usually doesn&#8217;t), try to retrieve it by sending a GET request:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X GET http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af
</pre></div>
</div>
<p>We hope you see a pattern here. Everything in CouchDB has an address, a URI,
and you use the different HTTP methods to operate on these URIs.</p>
<p>CouchDB replies:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;6e1295ed6c29495e54cc05947f18c8af&quot;</span><span class="p">,</span><span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-2902191555&quot;</span><span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="s2">&quot;There is Nothing Left to Lose&quot;</span><span class="p">,</span><span class="s2">&quot;artist&quot;</span><span class="o">:</span><span class="s2">&quot;Foo Fighters&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>This looks a lot like the document you asked CouchDB to save, which is good.
But you should notice that CouchDB added two fields to your JSON structure.
The first is <tt class="docutils literal"><span class="pre">_id</span></tt>, which holds the UUID we asked CouchDB to save our document
under. We always know the ID of a document if it is included, which is very
convenient.</p>
<p>The second field is <tt class="docutils literal"><span class="pre">_rev</span></tt>. It stands for <em>revision</em>.</p>
<div class="section" id="revisions">
<h5>Revisions<a class="headerlink" href="#revisions" title="Permalink to this headline">¶</a></h5>
<p>If you want to change a document in CouchDB, you don&#8217;t tell it to go and find
a field in a specific document and insert a new value. Instead, you load
the full document out of CouchDB, make your changes in the JSON structure
(or object, when you are doing actual programming), and save the entire new
revision (or version) of that document back into CouchDB. Each revision is
identified by a new <tt class="docutils literal"><span class="pre">_rev</span></tt> value.</p>
<p>If you want to update or delete a document, CouchDB expects you to include
the <tt class="docutils literal"><span class="pre">_rev</span></tt> field of the revision you wish to change. When CouchDB accepts
the change, it will generate a new revision number. This mechanism ensures that,
in case somebody else made a change without you knowing before you got to
request the document update, CouchDB will not accept your update because you
are likely to overwrite data you didn&#8217;t know existed. Or simplified: whoever
saves a change to a document first, wins. Let&#8217;s see what happens if we don&#8217;t
provide a <tt class="docutils literal"><span class="pre">_rev</span></tt> field (which is equivalent to providing a outdated value):</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af \
     -d &#39;{&quot;title&quot;:&quot;There is Nothing Left to Lose&quot;,&quot;artist&quot;:&quot;Foo Fighters&quot;,&quot;year&quot;:&quot;1997&quot;}&#39;
</pre></div>
</div>
<p>CouchDB replies:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="o">:</span><span class="s2">&quot;conflict&quot;</span><span class="p">,</span><span class="s2">&quot;reason&quot;</span><span class="o">:</span><span class="s2">&quot;Document update conflict.&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>If you see this, add the latest revision number of your document to the JSON
structure:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af \
     -d &#39;{&quot;_rev&quot;:&quot;1-2902191555&quot;,&quot;title&quot;:&quot;There is Nothing Left to Lose&quot;,&quot;artist&quot;:&quot;Foo Fighters&quot;,&quot;year&quot;:&quot;1997&quot;}&#39;
</pre></div>
</div>
<p>Now you see why it was handy that CouchDB returned that <tt class="docutils literal"><span class="pre">_rev</span></tt> when we made
the initial request. CouchDB replies:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6e1295ed6c29495e54cc05947f18c8af&quot;</span><span class="p">,</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-8aff9ee9d06671fa89c99d20a4b3ae&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>CouchDB accepted your write and also generated a new revision number.
The revision number is the <em>MD5 hash</em> of the transport representation of a
document with an <tt class="docutils literal"><span class="pre">N-</span></tt> prefix denoting the number of times a document got
updated. This is useful for replication. See <a class="reference internal" href="contents.html#replication-conflicts"><em>Replication and conflict model</em></a> for
more information.</p>
<p>There are multiple reasons why CouchDB uses this revision system,
which is also called Multi-Version Concurrency Control (<a class="reference external" href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a>). They all work
hand-in-hand, and this is a good opportunity to explain some of them.</p>
<p>One of the aspects of the HTTP protocol that CouchDB uses is that it is
stateless. What does that mean? When talking to CouchDB you need to make
requests. Making a request includes opening a network connection to CouchDB,
exchanging bytes, and closing the connection. This is done every time you
make a request. Other protocols allow you to open a connection, exchange bytes,
keep the connection open, exchange more bytes later &#8211; maybe depending on the
bytes you exchanged at the beginning &#8211; and eventually close the connection.
Holding a connection open for later use requires the server to do extra work.
One common pattern is that for the lifetime of a connection, the client has
a consistent and static view of the data on the server. Managing huge amounts
of parallel connections is a significant amount of work. HTTP connections are
usually short-lived, and making the same guarantees is a lot easier.
As a result, CouchDB can handle many more concurrent connections.</p>
<p>Another reason CouchDB uses MVCC is that this model is simpler conceptually
and, as a consequence, easier to program. CouchDB uses less code to make this
work, and less code is always good because the ratio of defects per lines of
code is static.</p>
<p>The revision system also has positive effects on replication and storage
mechanisms, but we&#8217;ll explore these later in the documents.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The terms <em>version</em> and <em>revision</em> might sound familiar (if you are
programming without version control, stop reading this guide right now and start
learning one of the popular systems). Using new versions for document changes
works a lot like version control, but there&#8217;s an important difference:
<strong>CouchDB does not guarantee that older versions are kept around</strong>.</p>
</div>
</div>
<div class="section" id="documents-in-detail">
<h5>Documents in Detail<a class="headerlink" href="#documents-in-detail" title="Permalink to this headline">¶</a></h5>
<p>Now let&#8217;s have a closer look at our document creation requests with the curl
<tt class="docutils literal"><span class="pre">-v</span></tt> flag that was helpful when we explored the database API earlier.
This is also a good opportunity to create more documents that we can use in
later examples.</p>
<p>We&#8217;ll add some more of our favorite music albums. Get a fresh UUID from the
<tt class="docutils literal"><span class="pre">/_uuids</span></tt> resource. If you don&#8217;t remember how that works, you can look it up
a few pages back.</p>
<div class="highlight-json"><div class="highlight"><pre>curl -vX PUT http://127.0.0.1:5984/albums/70b50bfa0a4b3aed1f8aff9e92dc16a0 \
     -d &#39;{&quot;title&quot;:&quot;Blackened Sky&quot;,&quot;artist&quot;:&quot;Biffy Clyro&quot;,&quot;year&quot;:2002}&#39;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">By the way, if you happen to know more information about your favorite
albums, don&#8217;t hesitate to add more properties. And don&#8217;t worry about not
knowing all the information for all the albums. CouchDB&#8217;s schema-less
documents can contain whatever you know. After all, you should relax and not
worry about data.</p>
</div>
<p>Now with the <tt class="docutils literal"><span class="pre">-v</span></tt> option, CouchDB&#8217;s reply (with only the important bits shown)
looks like this:</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; PUT /albums/70b50bfa0a4b3aed1f8aff9e92dc16a0 HTTP/1.1
&gt;
&lt; HTTP/1.1 201 Created
&lt; Location: http://127.0.0.1:5984/albums/70b50bfa0a4b3aed1f8aff9e92dc16a0
&lt; ETag: &quot;1-e89c99d29d06671fa0a4b3ae8aff9e&quot;
&lt;
{&quot;ok&quot;:true,&quot;id&quot;:&quot;70b50bfa0a4b3aed1f8aff9e92dc16a0&quot;,&quot;rev&quot;:&quot;1-e89c99d29d06671fa0a4b3ae8aff9e&quot;}
</pre></div>
</div>
<p>We&#8217;re getting back the <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> HTTP status code in the response
headers, as we saw earlier when we created a database. The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.3">Location</a>
header gives us a full URL to our newly created document. And there&#8217;s a new
header. An <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> in HTTP-speak identifies a specific version of a
resource. In this case, it identifies a specific version (the first one) of our
new document. Sound familiar? Yes, conceptually, an <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> is the same
as a CouchDB document revision number, and it shouldn&#8217;t come as a surprise that
CouchDB uses revision numbers for ETags. ETags are useful for caching
infrastructures.</p>
</div>
<div class="section" id="attachments">
<h5>Attachments<a class="headerlink" href="#attachments" title="Permalink to this headline">¶</a></h5>
<p>CouchDB documents can have attachments just like an email message can have
attachments. An attachment is identified by a name and includes its MIME type
(or <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a>) and the number of bytes the attachment
contains. Attachments can be any data. It is easiest to think about attachments
as files attached to a document. These files can be text, images, Word
documents, music, or movie files. Let&#8217;s make one.</p>
<p>Attachments get their own URL where you can upload data. Say we want to add
the album artwork to the <tt class="docutils literal"><span class="pre">6e1295ed6c29495e54cc05947f18c8af</span></tt> document
(<em>&#8220;There is Nothing Left to Lose&#8221;</em>), and let&#8217;s also say the artwork is in a file
<cite>artwork.jpg</cite> in the current directory:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -vX PUT http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af/artwork.jpg?rev=2-2739352689 \
     --data-binary @artwork.jpg -H &quot;Content-Type:image/jpg&quot;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal"><span class="pre">--data-binary</span></tt> <tt class="docutils literal"><span class="pre">&#64;</span></tt> option tells curl to read a file&#8217;s contents into
the HTTP request body. We&#8217;re using the <tt class="docutils literal"><span class="pre">-H</span></tt> option to tell CouchDB that
we&#8217;re uploading a JPEG file. CouchDB will keep this information around and
will send the appropriate header when requesting this attachment; in case of
an image like this, a browser will render the image instead of offering you
the data for download. This will come in handy later. Note that you need
to provide the current revision number of the document you&#8217;re attaching
the artwork to, just as if you would update the document. Because, after all,
attaching some data is changing the document.</p>
</div>
<p>You should now see your artwork image if you point your browser to
<a class="reference external" href="http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af/artwork.jpg">http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af/artwork.jpg</a></p>
<p>If you request the document again, you&#8217;ll see a new member:</p>
<div class="highlight-json"><div class="highlight"><pre>curl http://127.0.0.1:5984/albums/6e1295ed6c29495e54cc05947f18c8af
</pre></div>
</div>
<p>CouchDB replies:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;6e1295ed6c29495e54cc05947f18c8af&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;3-131533518&quot;</span><span class="p">,</span>
  <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;There is Nothing Left to Lose&quot;</span><span class="p">,</span>
  <span class="s2">&quot;artist&quot;</span><span class="o">:</span> <span class="s2">&quot;Foo Fighters&quot;</span><span class="p">,</span>
  <span class="s2">&quot;year&quot;</span><span class="o">:</span> <span class="s2">&quot;1997&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_attachments&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;artwork.jpg&quot;</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">&quot;stub&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="s2">&quot;content_type&quot;</span><span class="o">:</span> <span class="s2">&quot;image/jpg&quot;</span><span class="p">,</span>
          <span class="s2">&quot;length&quot;</span><span class="o">:</span> <span class="mi">52450</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">_attachments</span></tt> is a list of keys and values where the values are JSON objects
containing the attachment metadata. <tt class="docutils literal"><span class="pre">stub=true</span></tt> tells us that this entry is
just the metadata. If we use the <tt class="docutils literal"><span class="pre">?attachments=true</span></tt> HTTP option when
requesting this document, we&#8217;d get a <a class="reference external" href="http://en.wikipedia.org/wiki/Base64">Base64</a> encoded string containing the
attachment data.</p>
<p>We&#8217;ll have a look at more document request options later as we explore more
features of CouchDB, such as replication, which is the next topic.</p>
</div>
</div>
<div class="section" id="replication">
<h4><a class="toc-backref" href="#id4">Replication</a><a class="headerlink" href="#replication" title="Permalink to this headline">¶</a></h4>
<p>CouchDB replication is a mechanism to synchronize databases. Much like <a class="reference external" href="http://en.wikipedia.org/wiki/Rsync">rsync</a>
synchronizes two directories locally or over a network, replication synchronizes
two databases locally or remotely.</p>
<p>In a simple <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.5">POST</a> request, you tell CouchDB the <em>source</em> and the
<em>target</em> of a replication and CouchDB will figure out which documents and new
document revisions are on <em>source</em> that are not yet on <em>target</em>, and will
proceed  to move the missing documents and revisions over.</p>
<p>We&#8217;ll take an in-depth look at replication in the document <a class="reference internal" href="contents.html#replication-intro"><em>Introduction Into Replications</em></a>;
in this document, we&#8217;ll just show you how to use it.</p>
<p>First, we&#8217;ll create a target database. Note that CouchDB won&#8217;t automatically
create a target database for you, and will return a replication failure if
the target doesn&#8217;t exist (likewise for the source, but that mistake isn&#8217;t as
easy to make):</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://127.0.0.1:5984/albums-replica
</pre></div>
</div>
<p>Now we can use the database <cite>albums-replica</cite> as a replication target:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -vX POST http://127.0.0.1:5984/_replicate \
     -d &#39;{&quot;source&quot;:&quot;albums&quot;,&quot;target&quot;:&quot;albums-replica&quot;}&#39; \
     -H &quot;Content-Type: application/json&quot;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CouchDB supports the option <tt class="docutils literal"><span class="pre">&quot;create_target&quot;:true</span></tt> placed in the JSON POSTed
to the <a class="reference internal" href="contents.html#api-server-replicate"><em>_replicate</em></a> URL. It implicitly creates
the target database if it doesn&#8217;t exist.</p>
</div>
<p>CouchDB replies (this time we formatted the output so you can read it more
easily):</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;history&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;start_last_seq&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;missing_found&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;docs_read&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;end_last_seq&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="s2">&quot;missing_checked&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;docs_written&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="s2">&quot;doc_write_failures&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;end_time&quot;</span><span class="o">:</span> <span class="s2">&quot;Sat, 11 Jul 2009 17:36:21 GMT&quot;</span><span class="p">,</span>
      <span class="s2">&quot;start_time&quot;</span><span class="o">:</span> <span class="s2">&quot;Sat, 11 Jul 2009 17:36:20 GMT&quot;</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="s2">&quot;source_last_seq&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="s2">&quot;session_id&quot;</span><span class="o">:</span> <span class="s2">&quot;924e75e914392343de89c99d29d06671&quot;</span><span class="p">,</span>
  <span class="s2">&quot;ok&quot;</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
<p>CouchDB maintains a <em>session history</em> of replications. The response for a
replication request contains the history entry for this <em>replication session</em>.
It is also worth noting that the request for replication will stay open until
replication closes. If you have a lot of documents, it&#8217;ll take a while until
they are all replicated and you won&#8217;t get back the replication response
until all documents are replicated. It is important to note that
replication replicates the database only as it was at the point in time
when replication was started. So, any additions, modifications,
or deletions subsequent to the start of replication will not be replicated.</p>
<p>We&#8217;ll punt on the details again &#8211; the <tt class="docutils literal"><span class="pre">&quot;ok&quot;:</span> <span class="pre">true</span></tt> at the end tells us all
went well. If you now have a look at the albums-replica database,
you should see all the documents that you created in the albums database.
Neat, eh?</p>
<p>What you just did is called local replication in CouchDB terms. You created a
local copy of a database. This is useful for backups or to keep snapshots of
a specific state of your data around for later. You might want to do this
if you are developing your applications but want to be able to roll back to
a stable version of your code and data.</p>
<p>There are more types of replication useful in other situations. The source
and target members of our replication request are actually links (like in
HTML) and so far we&#8217;ve seen links relative to the server we&#8217;re working on
(hence local). You can also specify a remote database as the target:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -vX POST http://127.0.0.1:5984/_replicate \
     -d &#39;{&quot;source&quot;:&quot;albums&quot;,&quot;target&quot;:&quot;http://example.org:5984/albums-replica&quot;}&#39; \
     -H &quot;Content-Type:application/json&quot;
</pre></div>
</div>
<p>Using a <em>local source</em> and a <em>remote target</em> database is called <em>push
replication</em>. We&#8217;re pushing changes to a remote server.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since we don&#8217;t have a second CouchDB server around just yet, we&#8217;ll just use
the absolute address of our single server, but you should be able to infer
from this that you can put any remote server in there.</p>
</div>
<p>This is great for sharing local changes with remote servers or buddies next
door.</p>
<p>You can also use a <em>remote source</em> and a <em>local target</em> to do a <em>pull
replication</em>. This is great for getting the latest changes from a server that
is used by others:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -vX POST http://127.0.0.1:5984/_replicate \
     -d &#39;{&quot;source&quot;:&quot;http://example.org:5984/albums-replica&quot;,&quot;target&quot;:&quot;albums&quot;}&#39; \
     -H &quot;Content-Type:application/json&quot;
</pre></div>
</div>
<p>Finally, you can run remote replication, which is mostly useful for management
operations:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -vX POST http://127.0.0.1:5984/_replicate \
     -d &#39;{&quot;source&quot;:&quot;http://example.org:5984/albums&quot;,&quot;target&quot;:&quot;http://example.org:5984/albums-replica&quot;}&#39; \
     -H&quot;Content-Type: application/json&quot;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>CouchDB and REST</strong></p>
<p>CouchDB prides itself on having a <a class="reference external" href="http://en.wikipedia.org/wiki/Representational_state_transfer">RESTful</a> API, but these replication
requests don&#8217;t look very RESTy to the trained eye. What&#8217;s up with that?
While CouchDB&#8217;s core database, document, and attachment API are RESTful,
not all of CouchDB&#8217;s API is. The replication API is one example. There are
more, as we&#8217;ll see later in the documents.</p>
<p>Why are there RESTful and non-RESTful APIs mixed up here? Have the developers
been too lazy to go REST all the way? Remember, REST is an architectural
style that lends itself to certain architectures (such as the CouchDB
document API). But it is not a one-size-fits-all. Triggering an event like
replication does not make a whole lot of sense in the REST world. It is more
like a traditional remote procedure call. And there is nothing wrong with
this.</p>
<p class="last">We very much believe in the &#8220;use the right tool for the job&#8221; philosophy,
and REST does not fit every job. For support, we refer to Leonard Richardson
and Sam Ruby who wrote <a class="reference external" href="http://oreilly.com/catalog/9780596529260">RESTful Web Services</a> (O&#8217;Reilly), as they share our
view.</p>
</div>
</div>
<div class="section" id="wrapping-up">
<h4><a class="toc-backref" href="#id5">Wrapping Up</a><a class="headerlink" href="#wrapping-up" title="Permalink to this headline">¶</a></h4>
<p>This is still not the full CouchDB API, but we discussed the essentials in
great detail. We&#8217;re going to fill in the blanks as we go. For now, we believe
you&#8217;re ready to start building CouchDB applications.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p><a class="reference internal" href="contents.html#api"><em>Complete HTTP API Reference</em></a>:</p>
<ul class="last simple">
<li><a class="reference internal" href="contents.html#api-server"><em>Server API Reference</em></a></li>
<li><a class="reference internal" href="contents.html#api-database"><em>Database API Reference</em></a></li>
<li><a class="reference internal" href="contents.html#api-document"><em>Document API Reference</em></a></li>
<li><a class="reference internal" href="contents.html#api-server-replicate"><em>Replication API</em></a></li>
</ul>
</div>
</div>
</div>
<span id="document-intro/security"></span><div class="section" id="security">
<span id="intro-security"></span><h3>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h3>
<p>In this document, we&#8217;ll look at the basic security mechanisms in CouchDB: the
<cite>Admin Party</cite>, <cite>Basic Authentication</cite>, <cite>Cookie Authentication</cite>; how CouchDB
handles users and protects their credentials.</p>
<div class="section" id="authentication">
<h4>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h4>
<div class="section" id="the-admin-party">
<span id="intro-security-admin-party"></span><h5>The Admin Party<a class="headerlink" href="#the-admin-party" title="Permalink to this headline">¶</a></h5>
<p>When you start out fresh, CouchDB allows any request to be made by anyone.
Create a database? No problem, here you go. Delete some documents? Same deal.
CouchDB calls this the <cite>Admin Party</cite>. Everybody has privileges to do anything.
Neat.</p>
<p>While it is incredibly easy to get started with CouchDB that way,
it should be obvious that putting a default installation into the wild is
adventurous. Any rogue client could come along and delete a database.</p>
<p>A note of relief: by default, CouchDB will listen only on your loopback
network interface (<tt class="docutils literal"><span class="pre">127.0.0.1</span></tt> or <tt class="docutils literal"><span class="pre">localhost</span></tt>) and thus only you will be
able to make requests to CouchDB, nobody else. But when you start to open up
your CouchDB to the public (that is, by telling it to bind to your machine&#8217;s
public IP address), you will want to think about restricting access so that
the next bad guy doesn&#8217;t ruin your admin party.</p>
<p>In our previous discussions, we dropped some keywords about how things
without the <cite>Admin Party</cite> work. First, there&#8217;s <em>admin</em> itself, which implies
some sort of super user. Then there are <em>privileges</em>. Let&#8217;s explore these terms
a little more.</p>
<p>CouchDB has the idea of an <em>admin user</em> (e.g. an administrator, a super user,
or root) that is allowed to do anything to a CouchDB installation. By default,
everybody is an admin. If you don&#8217;t like that, you can create specific admin
users with a username and password as their credentials.</p>
<p>CouchDB also defines a set of requests that only admin users are allowed to
do. If you have defined one or more specific admin users, CouchDB will ask for
identification for certain requests:</p>
<ul class="simple">
<li>Creating a database (<a class="reference internal" href="contents.html#put--db" title="PUT /{db}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/database</span></tt></a>)</li>
<li>Deleting a database (<a class="reference internal" href="contents.html#put--db" title="PUT /{db}"><tt class="xref http http-put docutils literal"><span class="pre">DELETE</span> <span class="pre">/database</span></tt></a>)</li>
<li>Setup a database security (<a class="reference internal" href="contents.html#put--db-_security" title="PUT /{db}/_security"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/database/_security</span></tt></a>)</li>
<li>Creating a design document (<a class="reference internal" href="contents.html#put--db-_design-ddoc" title="PUT /{db}/_design/{ddoc}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/database/_design/app</span></tt></a>)</li>
<li>Updating a design document (<a class="reference internal" href="contents.html#put--db-_design-ddoc" title="PUT /{db}/_design/{ddoc}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/database/_design/app?rev=1-4E2</span></tt></a>)</li>
<li>Deleting a design document (<a class="reference internal" href="contents.html#delete--db-_design-ddoc" title="DELETE /{db}/_design/{ddoc}"><tt class="xref http http-delete docutils literal"><span class="pre">DELETE</span> <span class="pre">/database/_design/app?rev=2-6A7</span></tt></a>)</li>
<li>Execute a temporary view (<a class="reference internal" href="contents.html#post--db-_temp_view" title="POST /{db}/_temp_view"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/database/_temp_view</span></tt></a>)</li>
<li>Triggering compaction (<a class="reference internal" href="contents.html#post--db-_compact" title="POST /{db}/_compact"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/database/_compact</span></tt></a>)</li>
<li>Reading the task status list (<a class="reference internal" href="contents.html#get--_active_tasks" title="GET /_active_tasks"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/_active_tasks</span></tt></a>)</li>
<li>Restarting the server (<a class="reference internal" href="contents.html#post--_restart" title="POST /_restart"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/_restart</span></tt></a>)</li>
<li>Reading the active configuration (<a class="reference internal" href="contents.html#get--_config" title="GET /_config"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/_config</span></tt></a>)</li>
<li>Updating the active configuration (<a class="reference internal" href="contents.html#put--_config-section-key" title="PUT /_config/{section}/{key}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/_config/section/key</span></tt></a>)</li>
</ul>
<div class="section" id="creating-new-admin-user">
<h6>Creating New Admin User<a class="headerlink" href="#creating-new-admin-user" title="Permalink to this headline">¶</a></h6>
<p>Let&#8217;s do another walk through the API using <cite>curl</cite> to see how CouchDB behaves
when you add admin users.</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; HOST=&quot;http://127.0.0.1:5984&quot;
&gt; curl -X PUT $HOST/database
{&quot;ok&quot;:true}
</pre></div>
</div>
<p>When starting out fresh, we can add a database. Nothing unexpected. Now let&#8217;s
create an admin user. We&#8217;ll call her <tt class="docutils literal"><span class="pre">anna</span></tt>, and her password is <tt class="docutils literal"><span class="pre">secret</span></tt>.
Note the double quotes in the following code; they are needed to denote a string
value for the <a class="reference internal" href="contents.html#api-config"><em>configuration API</em></a>:</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; curl -X PUT $HOST/_config/admins/anna -d &#39;&quot;secret&quot;&#39;
&quot;&quot;
</pre></div>
</div>
<p>As per the <a class="reference internal" href="contents.html#api-config"><em>_config</em></a> API&#8217;s behavior, we&#8217;re getting
the previous value for the config item we just wrote. Since our admin user
didn&#8217;t exist, we get an empty string.</p>
</div>
<div class="section" id="hashing-passwords">
<h6>Hashing Passwords<a class="headerlink" href="#hashing-passwords" title="Permalink to this headline">¶</a></h6>
<p>Seeing the plain-text password is scary, isn&#8217;t it? No worries, CouchDB doesn&#8217;t
show up the plain-text password anywhere. It gets hashed right away. The hash
is that big, ugly, long string that starts out with <tt class="docutils literal"><span class="pre">-hashed-</span></tt>.
How does that work?</p>
<ol class="arabic simple">
<li>Creates a new 128-bit UUID. This is our <em>salt</em>.</li>
<li>Creates a sha1 hash of the concatenation of the bytes of the plain-text
password and the salt <tt class="docutils literal"><span class="pre">(sha1(password</span> <span class="pre">+</span> <span class="pre">salt))</span></tt>.</li>
<li>Prefixes the result with <tt class="docutils literal"><span class="pre">-hashed-</span></tt> and appends <tt class="docutils literal"><span class="pre">,salt</span></tt>.</li>
</ol>
<p>To compare a plain-text password during authentication with the stored hash,
the same procedure is run and the resulting hash is compared to the stored
hash. The probability of two identical hashes for different passwords is too
insignificant to mention (c.f. <a class="reference external" href="http://en.wikipedia.org/wiki/Bruce_Schneier">Bruce Schneier</a>). Should the stored hash fall
into the hands of an attacker, it is, by current standards, way too inconvenient
(i.e., it&#8217;d take a lot of money and time) to find the plain-text password from
the hash.</p>
<p>But what&#8217;s with the <tt class="docutils literal"><span class="pre">-hashed-</span></tt> prefix? When CouchDB starts up, it reads a set
of <cite>.ini</cite> files with config settings. It loads these settings into an internal
data store (not a database). The config API lets you read the current
configuration as well as change it and create new entries. CouchDB is writing
any changes back to the <cite>.ini</cite> files.</p>
<p>The <cite>.ini</cite> files can also be edited by hand when CouchDB is not running.
Instead of creating the admin user as we showed previously, you could have
stopped CouchDB, opened your <cite>local.ini</cite>, added <tt class="docutils literal"><span class="pre">anna</span> <span class="pre">=</span> <span class="pre">secret</span></tt> to the
<a class="reference internal" href="contents.html#admins" title="[admins]"><tt class="xref config config-section docutils literal"><span class="pre">admins</span></tt></a>, and restarted CouchDB. Upon reading the new line from
<cite>local.ini</cite>, CouchDB would run the hashing algorithm and write back the hash to
<cite>local.ini</cite>, replacing the plain-text password. To make sure CouchDB only hashes
plain-text passwords and not an existing hash a second time, it prefixes
the hash with <tt class="docutils literal"><span class="pre">-hashed-</span></tt>, to distinguish between plain-text passwords and
hashed passwords. This means your plain-text password can&#8217;t start with the
characters <tt class="docutils literal"><span class="pre">-hashed-</span></tt>, but that&#8217;s pretty unlikely to begin with.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since <a class="reference internal" href="contents.html#release-1-3-0"><em>1.3.0 release</em></a> CouchDB uses <tt class="docutils literal"><span class="pre">-pbkdf2-</span></tt> prefix
by default to sign about using <a class="reference external" href="http://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a> hashing algorithm instead of <cite>SHA1</cite>.</p>
</div>
</div>
</div>
<div class="section" id="basic-authentication">
<span id="intro-security-basicauth"></span><h5>Basic Authentication<a class="headerlink" href="#basic-authentication" title="Permalink to this headline">¶</a></h5>
<p>Now that we have defined an admin, CouchDB will not allow us to create new
databases unless we give the correct admin user credentials. Let&#8217;s verify:</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; curl -X PUT $HOST/somedatabase
{&quot;error&quot;:&quot;unauthorized&quot;,&quot;reason&quot;:&quot;You are not a server admin.&quot;}
</pre></div>
</div>
<p>That looks about right. Now we try again with the correct credentials:</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; HOST=&quot;http://anna:secret@127.0.0.1:5984&quot;
&gt; curl -X PUT $HOST/somedatabase
{&quot;ok&quot;:true}
</pre></div>
</div>
<p>If you have ever accessed a website or FTP server that was password-protected,
the <tt class="docutils literal"><span class="pre">username:password&#64;</span></tt> URL variant should look familiar.</p>
<p>If you are security conscious, the missing <tt class="docutils literal"><span class="pre">s</span></tt> in <tt class="docutils literal"><span class="pre">http://</span></tt> will make you
nervous. We&#8217;re sending our password to CouchDB in plain text. This is a bad
thing, right? Yes, but consider our scenario: CouchDB listens on <tt class="docutils literal"><span class="pre">127.0.0.1</span></tt>
on a development box that we&#8217;re the sole user of. Who could possibly sniff our
password?</p>
<p>If you are in a production environment, however, you need to reconsider. Will
your CouchDB instance communicate over a public network? Even a LAN shared
with other collocation customers is public. There are multiple ways to secure
communication between you or your application and CouchDB that exceed the
scope of this documentation. CouchDB as of version <a class="reference internal" href="contents.html#release-1-1-0"><em>1.1.0</em></a>
comes with <a class="reference internal" href="contents.html#config-ssl"><em>SSL built in</em></a>.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#api-auth-basic"><em>Basic Authentication API Reference</em></a></p>
</div>
</div>
<div class="section" id="cookie-authentication">
<span id="intro-security-cookie"></span><h5>Cookie Authentication<a class="headerlink" href="#cookie-authentication" title="Permalink to this headline">¶</a></h5>
<p>Basic authentication that uses plain-text passwords is nice and convenient,
but not very secure if no extra measures are taken. It is also a very poor
user experience. If you use basic authentication to identify admins,
your application&#8217;s users need to deal with an ugly, unstylable browser modal
dialog that says non-professional at work more than anything else.</p>
<p>To remedy some of these concerns, CouchDB supports cookie authentication.
With cookie authentication your application doesn&#8217;t have to include the ugly
login dialog that the users&#8217; browsers come with. You can use a regular HTML
form to submit logins to CouchDB. Upon receipt, CouchDB will generate a
one-time token that the client can use in its next request to CouchDB. When
CouchDB sees the token in a subsequent request, it will authenticate the user
based on the token without the need to see the password again. By default,
a token is valid for 10 minutes.</p>
<p>To obtain the first token and thus authenticate a user for the first time,
the username and password must be sent to the <a class="reference internal" href="contents.html#api-auth-session"><em>_session</em></a>
API. The API is smart enough to decode HTML form submissions, so you don&#8217;t have
to resort to any smarts in your application.</p>
<p>If you are not using HTML forms to log in, you need to send an HTTP request
that looks as if an HTML form generated it. Luckily, this is super simple:</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; HOST=&quot;http://127.0.0.1:5984&quot;
&gt; curl -vX POST $HOST/_session \
       -H &#39;Content-Type:application/x-www-form-urlencoded&#39; \
       -d &#39;name=anna&amp;password=secret&#39;
</pre></div>
</div>
<p>CouchDB replies, and we&#8217;ll give you some more detail:</p>
<div class="highlight-json"><div class="highlight"><pre>&lt; HTTP/1.1 200 OK
&lt; Set-Cookie: AuthSession=YW5uYTo0QUIzOTdFQjrC4ipN-D-53hw1sJepVzcVxnriEw;
&lt; Version=1; Path=/; HttpOnly
&gt; ...
&lt;
{&quot;ok&quot;:true}
</pre></div>
</div>
<p>A <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> response code tells us all is well, a <a class="reference external" href="http://tools.ietf.org/html/rfc2109#section-4.2.2">Set-Cookie</a>
header includes the token we can use for the next request, and the standard JSON
response tells us again that the request was successful.</p>
<p>Now we can use this token to make another request as the same user without
sending the username and password again:</p>
<div class="highlight-json"><div class="highlight"><pre>&gt; curl -vX PUT $HOST/mydatabase \
       --cookie AuthSession=YW5uYTo0QUIzOTdFQjrC4ipN-D-53hw1sJepVzcVxnriEw \
       -H &quot;X-CouchDB-WWW-Authenticate: Cookie&quot; \
       -H &quot;Content-Type:application/x-www-form-urlencoded&quot;
{&quot;ok&quot;:true}
</pre></div>
</div>
<p>You can keep using this token for 10 minutes by default. After 10 minutes you
need to authenticate your user again. The token lifetime can be configured
with the timeout (in seconds) setting in the <a class="reference internal" href="contents.html#config-couch-httpd-auth"><em>couch_httpd_auth</em></a> configuration section.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#api-auth-cookie"><em>Cookie Authentication API Reference</em></a></p>
</div>
</div>
</div>
<div class="section" id="authentication-database">
<h4>Authentication Database<a class="headerlink" href="#authentication-database" title="Permalink to this headline">¶</a></h4>
<p>You may already note, that CouchDB administrators are defined within config file
and you now wondering does regular users are also stored there. No, they don&#8217;t.
CouchDB has special <cite>authentication database</cite> &#8211; <tt class="docutils literal"><span class="pre">_users</span></tt> by default &#8211; that
stores all registered users as JSON documents.</p>
<p>CouchDB uses special database (called <tt class="docutils literal"><span class="pre">_users</span></tt> by default) to store
information about registered users. This is a <cite>system database</cite> &#8211; this means
that while it shares common <a class="reference internal" href="contents.html#api-database"><em>database API</em></a>, there are some
special security-related constraints applied and used agreements on documents
structure. So how <cite>authentication database</cite> is different from others?</p>
<ul class="simple">
<li>Only administrators may browse list of all documents
(<a class="reference internal" href="contents.html#get--db-_all_docs" title="GET /{db}/_all_docs"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/_users/_all_docs</span></tt></a>)</li>
<li>Only administrators may listen <a class="reference internal" href="contents.html#changes"><em>changes feed</em></a> (<a class="reference internal" href="contents.html#get--db-_changes" title="GET /{db}/_changes"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/_users/_changes</span></tt></a>)</li>
<li>Only administrators may execute design functions like <a class="reference internal" href="contents.html#viewfun"><em>views</em></a>,
<a class="reference internal" href="contents.html#showfun"><em>shows</em></a> and <a class="reference internal" href="contents.html#ddocs"><em>others</em></a></li>
<li>Only administrators may <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.3">GET</a>, <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">PUT</a> or <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.7">DELETE</a>
any document (to be honest, that they always can do)</li>
<li>There is special design document <tt class="docutils literal"><span class="pre">_auth</span></tt> that cannot be modified</li>
<li>Every document (of course, except <cite>design documents</cite>) represents registered
CouchDB users and belong to them</li>
<li>Users may only access (<a class="reference internal" href="contents.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/_users/org.couchdb.user:Jan</span></tt></a>) or modify (<a class="reference internal" href="contents.html#put--db-docid" title="PUT /{db}/{docid}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/_users/org.couchdb.user:Jan</span></tt></a>) documents that they owns</li>
</ul>
<p>These draconian rules are reasonable: CouchDB cares about user&#8217;s personal
information and doesn&#8217;t discloses it for everyone. Often, users documents are
contains not only system information like <cite>login</cite>, <cite>password hash</cite> and <cite>roles</cite>,
but also sensitive personal information like: real name, email, phone, special
internal identifications and more - this is not right information that you
want to share with the World.</p>
<div class="section" id="users-documents">
<h5>Users Documents<a class="headerlink" href="#users-documents" title="Permalink to this headline">¶</a></h5>
<p>Each CouchDB user is stored in document format. These documents are contains
several <em>mandatory</em> fields, that CouchDB handles for correct authentication
process:</p>
<ul class="simple">
<li><strong>_id</strong> (<em>string</em>): Document ID. Contains user&#8217;s login with special prefix
<a class="reference internal" href="contents.html#org-couchdb-user"><em>Why org.couchdb.user: prefix?</em></a></li>
<li><strong>derived_key</strong> (<em>string</em>): <a class="reference external" href="http://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a> key</li>
<li><strong>name</strong> (<em>string</em>): User&#8217;s name aka login. <strong>Immutable</strong> e.g. you cannot
rename existed user - you have to create new one</li>
<li><strong>roles</strong> (<em>array</em> of <em>string</em>): List of user roles. CouchDB doesn&#8217;t provides
any builtin roles, so you&#8217;re free to define your own depending on your needs.
However, you cannot set system roles like <tt class="docutils literal"><span class="pre">_admin</span></tt> there. Also, only
administrators may assign roles to users - by default all users have no roles</li>
<li><strong>password_sha</strong> (<em>string</em>): Hashed password with salt. Used for <tt class="docutils literal"><span class="pre">simple</span></tt>
<cite>password_scheme</cite></li>
<li><strong>password_scheme</strong> (<em>string</em>): Password hashing scheme. May be <tt class="docutils literal"><span class="pre">simple</span></tt> or
<tt class="docutils literal"><span class="pre">pbkdf2</span></tt></li>
<li><strong>salt</strong> (<em>string</em>): Hash salt. Used for <tt class="docutils literal"><span class="pre">simple</span></tt> <cite>password_scheme</cite></li>
<li><strong>type</strong> (<em>string</em>): Document type. Constantly have value <tt class="docutils literal"><span class="pre">user</span></tt></li>
</ul>
<p>Additionally, you may specify any custom fields that are relates to the target
user. This is good place to store user&#8217;s private information because only the
target user and CouchDB administrators may browse it.</p>
<div class="section" id="why-org-couchdb-user-prefix">
<span id="org-couchdb-user"></span><h6>Why <tt class="docutils literal"><span class="pre">org.couchdb.user:</span></tt> prefix?<a class="headerlink" href="#why-org-couchdb-user-prefix" title="Permalink to this headline">¶</a></h6>
<p>The reason to have special prefix before user&#8217;s login name is to have
namespaces which users are belongs to. This prefix is designed to prevent
replication conflicts when you&#8217;ll try to merge two <cite>_user</cite> databases or more.</p>
<p>For current CouchDB releases, all users are belongs to the same
<tt class="docutils literal"><span class="pre">org.couchdb.user</span></tt> namespace and this cannot be changed, but we&#8217;d made
such design decision for future releases.</p>
</div>
</div>
<div class="section" id="creating-new-user">
<h5>Creating New User<a class="headerlink" href="#creating-new-user" title="Permalink to this headline">¶</a></h5>
<p>Creating new user is a very trivial operation. You need just to send single
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">PUT</a> request with user&#8217;s data to CouchDB. Let&#8217;s create user with login
<cite>jan</cite> and password <cite>apple</cite>:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://localhost:5984/_users/org.couchdb.user:jan \
     -H &quot;Accept: application/json&quot; \
     -H &quot;Content-Type: application/json&quot; \
     -d &#39;{&quot;name&quot;: &quot;jan&quot;, &quot;password&quot;: &quot;apple&quot;, &quot;roles&quot;: [], &quot;type&quot;: &quot;user&quot;}&#39;
</pre></div>
</div>
<p>This <cite>curl</cite> command will produce next HTTP request:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/_users/org.couchdb.user:jan</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">62</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">curl/7.31.0</span>
</pre></div>
</div>
<p>And CouchDB responds with:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">83</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 27 Sep 2013 07:33:28 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;1-e0ebfb84005b920488fc7a8cc5470cc0&quot;</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/_users/org.couchdb.user:jan</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;org.couchdb.user:jan&quot;</span><span class="p">,</span><span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot;1-e0ebfb84005b920488fc7a8cc5470cc0&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Document successfully created what also means that user <cite>jan</cite> have created too!
Let&#8217;s check is this true:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X POST http://localhost:5984/_session -d &#39;name=jan&amp;password=apple&#39;
</pre></div>
</div>
<p>CouchDB should respond with:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;jan&quot;</span><span class="p">,</span><span class="s2">&quot;roles&quot;</span><span class="o">:</span><span class="p">[]}</span>
</pre></div>
</div>
<p>Which means that username was recognized and password&#8217;s hash matches with stored
one. If we specify wrong login and/or password, CouchDB will notify us with
the next error message:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="o">:</span><span class="s2">&quot;unauthorized&quot;</span><span class="p">,</span><span class="s2">&quot;reason&quot;</span><span class="o">:</span><span class="s2">&quot;Name or password is incorrect.&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="password-changing">
<h5>Password Changing<a class="headerlink" href="#password-changing" title="Permalink to this headline">¶</a></h5>
<p>This is quite common situation: user had forgot their password, it was leaked
somehow (via copy-paste, screenshot, or by typing in wrong chat window) or
something else. Let&#8217;s change password for our user <cite>jan</cite>.</p>
<p>First of all, let&#8217;s define what is the password changing from the point of
CouchDB and the authentication database. Since &#8220;users&#8221; are &#8220;documents&#8221;, this
operation is nothing, but updating the document with special field <tt class="docutils literal"><span class="pre">password</span></tt>
which contains the <em>plain text password</em>. Scared? No need to: the authentication
database has special internal hook on  document update which looks for this
field and replaces it with the <em>secured hash</em>, depending on chosen
<tt class="docutils literal"><span class="pre">password_scheme</span></tt>.</p>
<p>Summarizing above, we need to get document content, add <tt class="docutils literal"><span class="pre">password</span></tt> field
with new plain text password value and store JSON result to the authentication
database.</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X GET http://localhost:5984/_users/org.couchdb.user:jan
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;org.couchdb.user:jan&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-e0ebfb84005b920488fc7a8cc5470cc0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;derived_key&quot;</span><span class="o">:</span> <span class="s2">&quot;e579375db0e0c6a6fc79cd9e36a36859f71575c3&quot;</span><span class="p">,</span>
  <span class="s2">&quot;iterations&quot;</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;jan&quot;</span><span class="p">,</span>
  <span class="s2">&quot;password_scheme&quot;</span><span class="o">:</span> <span class="s2">&quot;pbkdf2&quot;</span><span class="p">,</span>
  <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[],</span>
  <span class="s2">&quot;salt&quot;</span><span class="o">:</span> <span class="s2">&quot;1112283cf988a34f124200a050d308a1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;user&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here is our user&#8217;s document. We may strip hashes from stored document to reduce
amount of posted data:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://localhost:5984/_users/org.couchdb.user:jan \
     -H &quot;Accept: application/json&quot; \
     -H &quot;Content-Type: application/json&quot; \
     -H &quot;If-Match: 1-e0ebfb84005b920488fc7a8cc5470cc0&quot; \
     -d &#39;{&quot;name&quot;:&quot;jan&quot;, &quot;roles&quot;:[], &quot;type&quot;:&quot;user&quot;, &quot;password&quot;:&quot;orange&quot;}&#39;
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;org.couchdb.user:jan&quot;</span><span class="p">,</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-ed293d3a0ae09f0c624f10538ef33c6f&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Updated! Now let&#8217;s check that password was really changed:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X POST http://localhost:5984/_session -d &#39;name=jan&amp;password=apple&#39;
</pre></div>
</div>
<p>CouchDB should respond with:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="o">:</span><span class="s2">&quot;unauthorized&quot;</span><span class="p">,</span><span class="s2">&quot;reason&quot;</span><span class="o">:</span><span class="s2">&quot;Name or password is incorrect.&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Looks like the password <tt class="docutils literal"><span class="pre">apple</span></tt> is wrong, what about <tt class="docutils literal"><span class="pre">orange</span></tt>?</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X POST http://localhost:5984/_session -d &#39;name=jan&amp;password=orange&#39;
</pre></div>
</div>
<p>CouchDB should respond with:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;jan&quot;</span><span class="p">,</span><span class="s2">&quot;roles&quot;</span><span class="o">:</span><span class="p">[]}</span>
</pre></div>
</div>
<p>Hooray! You may wonder why so complex: need to retrieve user&#8217;s document, add
special field to it, post it back - where is one big button that changes the
password without worry about document&#8217;s content? Actually, <a class="reference internal" href="contents.html#intro-futon"><em>Futon</em></a> has such at the right bottom corner if you have logged in -
all implementation details are hidden from your sight.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is no password confirmation for API request: you should implement it
on your application layer like Futon does.</p>
</div>
</div>
<div class="section" id="users-public-information">
<h5>Users Public Information<a class="headerlink" href="#users-public-information" title="Permalink to this headline">¶</a></h5>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>Sometimes users <em>wants</em> to share some information with the World. For instance,
their contact email to let other users get in touch with them. To solve this
problem, but still keep sensitive and private information secured there is
special <a class="reference internal" href="contents.html#config"><em>configuration</em></a> option <a class="reference internal" href="contents.html#couch_httpd_auth/public_fields" title="public_fields"><tt class="xref config config-option docutils literal"><span class="pre">public_fields</span></tt></a>. In this options you may define comma
separated list of users document fields that will be publicity available.</p>
<p>Normally, if you request any user&#8217;s document and you&#8217;re not administrator or
this document owner, CouchDB will respond with <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a>:</p>
<div class="highlight-json"><div class="highlight"><pre>curl http://localhost:5984/_users/org.couchdb.user:robert
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="o">:</span><span class="s2">&quot;not_found&quot;</span><span class="p">,</span><span class="s2">&quot;reason&quot;</span><span class="o">:</span><span class="s2">&quot;missing&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>This response is constant for both cases when user exists or not exists - by
security reasons.</p>
<p>Now let&#8217;s share field <tt class="docutils literal"><span class="pre">name</span></tt>. First, setup the <tt class="docutils literal"><span class="pre">public_fields</span></tt> configuration
option. Remember, that this action requires administrator&#8217;s privileges and
the next command will ask for password for user <cite>admin</cite>, assuming that they are
the server administrator:</p>
<div class="highlight-json"><div class="highlight"><pre>curl -X PUT http://localhost:5984/_config/couch_http_auth/public_fields \
     -H &quot;Content-Type: application/json&quot; \
     -d &#39;&quot;name&quot;&#39; \
     -u admin
</pre></div>
</div>
<p>What have changed? Let&#8217;s check Robert&#8217;s document once again:</p>
<div class="highlight-json"><div class="highlight"><pre>curl http://localhost:5984/_users/org.couchdb.user:robert
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;org.couchdb.user:robert&quot;</span><span class="p">,</span><span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;6-869e2d3cbd8b081f9419f190438ecbe7&quot;</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;robert&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Good news! Now we may read field <tt class="docutils literal"><span class="pre">name</span></tt> from <em>every user&#8217;s document without
need to be an administrator</em>. That&#8217;s important note: don&#8217;t publish sensitive
information, especially without user&#8217;s acknowledge - they may not like such
actions from your side.</p>
</div>
</div>
</div>
<span id="document-intro/futon"></span><div class="section" id="futon-web-gui-administration-panel">
<span id="intro-futon"></span><h3>Futon: Web GUI Administration Panel<a class="headerlink" href="#futon-web-gui-administration-panel" title="Permalink to this headline">¶</a></h3>
<p>Futon is a native web-based interface built into CouchDB. It provides a
basic interface to the majority of the functionality, including the
ability to create, update, delete and view documents and views, provides
access to the configuration parameters, and an interface for initiating
replication.</p>
<p>The default view is the Overview page which provides you with a list of
the databases. The basic structure of the page is consistent regardless
of the section you are in. The main panel on the left provides the main
interface to the databases, configuration or replication systems. The
side panel on the right provides navigation to the main areas of Futon
interface:</p>
<div class="figure align-center">
<img alt="Futon Overview" src="_images/futon-overview.png" />
<p class="caption">Futon Overview</p>
</div>
<p>The main sections are:</p>
<ul>
<li><p class="first">Overview</p>
<p>The main overview page, which provides a list of the databases and
provides the interface for querying the database and creating and
updating documents. See <a class="reference internal" href="contents.html#futon-management"><em>Managing Databases and Documents</em></a>.</p>
</li>
<li><p class="first">Configuration</p>
<p>An interface into the configuration of your CouchDB installation. The
interface allows you to edit the different configurable parameters.
For more details on configuration, see <a class="reference internal" href="contents.html#config"><em>Configuring CouchDB</em></a> section.</p>
</li>
<li><p class="first">Replicator</p>
<p>An interface to the replication system, enabling you to initiate
replication between local and remote databases. See
<a class="reference internal" href="contents.html#futon-replication"><em>Configuring Replication</em></a>.</p>
</li>
<li><p class="first">Status</p>
<p>Displays a list of the running background tasks on the server.
Background tasks include view index building, compaction and
replication. The Status page is an interface to the
<a class="reference internal" href="contents.html#api-server-active-tasks"><em>Active Tasks</em></a> API call.</p>
</li>
<li><p class="first">Verify Installation</p>
<p>The Verify Installation allows you to check whether all of the
components of your CouchDB installation are correctly installed.</p>
</li>
<li><p class="first">Test Suite</p>
<p>The Test Suite section allows you to run the built-in test suite.
This executes a number of test routines entirely within your browser
to test the API and functionality of your CouchDB installation. If
you select this page, you can run the tests by using the Run All
button. This will execute all the tests, which may take some time.</p>
</li>
</ul>
<div class="section" id="managing-databases-and-documents">
<span id="futon-management"></span><h4>Managing Databases and Documents<a class="headerlink" href="#managing-databases-and-documents" title="Permalink to this headline">¶</a></h4>
<p>You can manage databases and documents within Futon using the main
Overview section of the Futon interface.</p>
<p>To create a new database, click the Create Database ELLIPSIS button. You
will be prompted for the database name, as shown in the figure below.</p>
<div class="figure align-center">
<img alt="Creating a Database" src="_images/futon-createdb.png" />
<p class="caption">Creating a Database</p>
</div>
<p>Once you have created the database (or selected an existing one), you
will be shown a list of the current documents. If you create a new
document, or select an existing document, you will be presented with the
edit document display.</p>
<p>Editing documents within Futon requires selecting the document and then
editing (and setting) the fields for the document individually before
saving the document back into the database.</p>
<p>For example, the figure below shows the editor for a single document, a
newly created document with a single ID, the document <tt class="docutils literal"><span class="pre">_id</span></tt> field.</p>
<div class="figure align-center">
<img alt="Editing a Document" src="_images/futon-editdoc.png" />
<p class="caption">Editing a Document</p>
</div>
<p>To add a field to the document:</p>
<ol class="arabic">
<li><p class="first">Click Add Field.</p>
</li>
<li><p class="first">In the fieldname box, enter the name of the field you want to create.
For example, “company”.</p>
</li>
<li><p class="first">Click the green tick next to the field name to confirm the field name
change.</p>
</li>
<li><p class="first">Double-click the corresponding Value cell.</p>
</li>
<li><p class="first">Enter a company name, for example “Example”.</p>
</li>
<li><p class="first">Click the green tick next to the field value to confirm the field
value.</p>
</li>
<li><p class="first">The document is still not saved as this point. You must explicitly
save the document by clicking the Save Document button at the top of
the page. This will save the document, and then display the new
document with the saved revision information (the <tt class="docutils literal"><span class="pre">_rev</span></tt> field).</p>
<div class="figure align-center">
<img alt="Edited Document" src="_images/futon-editeddoc.png" />
<p class="caption">Edited Document</p>
</div>
</li>
</ol>
<p>The same basic interface is used for all editing operations within Futon.
You <em>must</em> remember to save the individual element (fieldname, value)
using the green tick button, before then saving the document.</p>
</div>
<div class="section" id="configuring-replication">
<span id="futon-replication"></span><h4>Configuring Replication<a class="headerlink" href="#configuring-replication" title="Permalink to this headline">¶</a></h4>
<p>When you click the Replicator option within the Tools menu you are
presented with the Replicator screen. This allows you to start
replication between two databases by filling in or select the
appropriate options within the form provided.</p>
<div class="figure align-center">
<img alt="Replication Form" src="_images/futon-replform.png" />
<p class="caption">Replication Form</p>
</div>
<p>To start a replication process, either the select the local database or
enter a remote database name into the corresponding areas of the form.
Replication occurs from the database on the left to the database on the
right.</p>
<p>If you are specifying a remote database name, you must specify the full
URL of the remote database (including the host, port number and database
name). If the remote instance requires authentication, you can specify
the username and password as part of the URL, for example
<tt class="docutils literal"><span class="pre">http://username:pass&#64;remotehost:5984/demo</span></tt>.</p>
<p>To enable continuous replication, click the Continuous checkbox.</p>
<p>To start the replication process, click the Replicate button. The
replication process should start and will continue in the background. If
the replication process will take a long time, you can monitor the
status of the replication using the Status option under the Tools menu.</p>
<p>Once replication has been completed, the page will show the information
returned when the replication process completes by the API.</p>
<p>The Replicator tool is an interface to the underlying replication API.
For more information, see <a class="reference internal" href="contents.html#api-server-replicate"><em>/_replicate</em></a>. For more information on
replication, see <a class="reference internal" href="contents.html#replication"><em>Replication</em></a>.</p>
</div>
</div>
<span id="document-intro/curl"></span><div class="section" id="curl-your-command-line-friend">
<span id="intro-curl"></span><h3>cURL: Your Command Line Friend<a class="headerlink" href="#curl-your-command-line-friend" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">curl</span></tt> utility is a command line tool available on Unix, Linux,
Mac OS X and Windows and many other platforms. <tt class="docutils literal"><span class="pre">curl</span></tt> provides easy
access to the HTTP protocol (among others) directly from the
command-line and is therefore an ideal way of interacting with CouchDB
over the HTTP REST API.</p>
<p>For simple <tt class="docutils literal"><span class="pre">GET</span></tt> requests you can supply the URL of the request. For
example, to get the database information:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl http://127.0.0.1:5984
</pre></div>
</div>
<p>This returns the database information (formatted in the output below for
clarity):</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;couchdb&quot;</span><span class="p">:</span> <span class="s2">&quot;Welcome&quot;</span><span class="p">,</span>
    <span class="nt">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;85fb71bf700c17267fef77535820e371&quot;</span><span class="p">,</span>
    <span class="nt">&quot;vendor&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;The Apache Software Foundation&quot;</span><span class="p">,</span>
        <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.4.0&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.4.0&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>For some URLs, especially those that include special characters such
as ampersand, exclamation mark, or question mark, you should quote
the URL you are specifying on the command line. For example:</p>
<div class="last highlight-bash"><div class="highlight"><pre>shell&gt; curl <span class="s1">&#39;http://couchdb:5984/_uuids?count=5&#39;</span>
</pre></div>
</div>
</div>
<p>You can explicitly set the HTTP command using the <tt class="docutils literal"><span class="pre">-X</span></tt> command line
option. For example, when creating a database, you set the name of the
database in the URL you send using a PUT request:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl -X PUT http://127.0.0.1:5984/demo
<span class="o">{</span><span class="s2">&quot;ok&quot;</span>:true<span class="o">}</span>
</pre></div>
</div>
<p>But to obtain the database information you use a <tt class="docutils literal"><span class="pre">GET</span></tt> request (with
the return information formatted for clarity):</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl -X GET http://127.0.0.1:5984/demo
<span class="o">{</span>
   <span class="s2">&quot;compact_running&quot;</span> : <span class="nb">false</span>,
   <span class="s2">&quot;doc_count&quot;</span> : 0,
   <span class="s2">&quot;db_name&quot;</span> : <span class="s2">&quot;demo&quot;</span>,
   <span class="s2">&quot;purge_seq&quot;</span> : 0,
   <span class="s2">&quot;committed_update_seq&quot;</span> : 0,
   <span class="s2">&quot;doc_del_count&quot;</span> : 0,
   <span class="s2">&quot;disk_format_version&quot;</span> : 5,
   <span class="s2">&quot;update_seq&quot;</span> : 0,
   <span class="s2">&quot;instance_start_time&quot;</span> : <span class="s2">&quot;1306421773496000&quot;</span>,
   <span class="s2">&quot;disk_size&quot;</span> : 79
<span class="o">}</span>
</pre></div>
</div>
<p>For certain operations, you must specify the content type of request,
which you do by specifying the <tt class="docutils literal"><span class="pre">Content-Type</span></tt> header using the <tt class="docutils literal"><span class="pre">-H</span></tt>
command-line option:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> http://127.0.0.1:5984/_uuids
</pre></div>
</div>
<p>You can also submit &#8216;payload&#8217; data, that is, data in the body of the
HTTP request using the <tt class="docutils literal"><span class="pre">-d</span></tt> option. This is useful if you need to
submit JSON structures, for example document data, as part of the
request. For example, to submit a simple document to the <tt class="docutils literal"><span class="pre">demo</span></tt>
database:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl -H <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\</span>
            -X POST http://127.0.0.1:5984/demo <span class="se">\</span>
            -d <span class="s1">&#39;{&quot;company&quot;: &quot;Example, Inc.&quot;}&#39;</span>
<span class="o">{</span><span class="s2">&quot;ok&quot;</span>:true,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;8843faaf0b831d364278331bc3001bd8&quot;</span>,
 <span class="s2">&quot;rev&quot;</span>:<span class="s2">&quot;1-33b9fbce46930280dab37d672bbc8bb9&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>In the above example, the argument after the <tt class="docutils literal"><span class="pre">-d</span></tt> option is the JSON
of the document we want to submit.</p>
<p>The document can be accessed by using the automatically generated
document ID that was returned:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl -X GET http://127.0.0.1:5984/demo/8843faaf0b831d364278331bc3001bd8
<span class="o">{</span><span class="s2">&quot;_id&quot;</span>:<span class="s2">&quot;8843faaf0b831d364278331bc3001bd8&quot;</span>,
 <span class="s2">&quot;_rev&quot;</span>:<span class="s2">&quot;1-33b9fbce46930280dab37d672bbc8bb9&quot;</span>,
 <span class="s2">&quot;company&quot;</span>:<span class="s2">&quot;Example, Inc.&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>The API samples in the <a class="reference internal" href="contents.html#api-basics"><em>API Basics</em></a> show the HTTP command, URL and any
payload information that needs to be submitted (and the expected return
value). All of these examples can be reproduced using <tt class="docutils literal"><span class="pre">curl</span></tt> with the
command-line examples shown above.</p>
</div>
</div>
</div>
<span id="document-install/index"></span><div class="section" id="installation">
<span id="install"></span><h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-install/unix"></span><div class="section" id="installation-on-unix-like-systems">
<span id="install-unix"></span><h3>Installation on Unix-like systems<a class="headerlink" href="#installation-on-unix-like-systems" title="Permalink to this headline">¶</a></h3>
<p>A high-level guide to Unix-like systems, inc. Mac OS X and Ubuntu.</p>
<p>This document is the canonical source of installation information. However, many
systems have gotchas that you need to be aware of. In addition, dependencies
frequently change as distributions update their archives. If you&#8217;re running into
trouble, be sure to check out the wiki. If you have any tips to share, please
also update the wiki so that others can benefit from your experience.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="http://wiki.apache.org/couchdb/Installation">Community installation guides</a></p>
</div>
<div class="section" id="troubleshooting">
<h4>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>There is a <a class="reference external" href="http://wiki.apache.org/couchdb/Troubleshooting">troubleshooting guide</a>.</li>
<li>There is a <a class="reference external" href="http://wiki.apache.org/couchdb">wiki</a> for general documentation.</li>
<li>There are collection of <a class="reference external" href="http://couchdb.apache.org/community/lists.html">friendly mailing lists</a>.</li>
</ul>
<p>Please work through these in order if you experience any problems.</p>
</div>
<div class="section" id="dependencies">
<span id="install-unix-dependencies"></span><h4>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h4>
<p>You should have the following installed:</p>
<ul class="simple">
<li><a class="reference external" href="http://erlang.org/">Erlang OTP (&gt;=R14B01, =&lt;R17)</a></li>
<li><a class="reference external" href="http://icu-project.org/">ICU</a></li>
<li><a class="reference external" href="http://www.openssl.org/">OpenSSL</a></li>
<li><a class="reference external" href="http://www.mozilla.org/js/spidermonkey/">Mozilla SpiderMonkey (1.8.5)</a></li>
<li><a class="reference external" href="http://www.gnu.org/software/make/">GNU Make</a></li>
<li><a class="reference external" href="http://gcc.gnu.org/">GNU Compiler Collection</a></li>
<li><a class="reference external" href="http://curl.haxx.se/libcurl/">libcurl</a></li>
<li><a class="reference external" href="http://www.gnu.org/s/help2man/">help2man</a></li>
<li><a class="reference external" href="http://python.org/">Python (&gt;=2.7) for docs</a></li>
<li><a class="reference external" href="http://pypi.python.org/pypi/Sphinx">Python Sphinx (&gt;=1.1.3)</a></li>
</ul>
<p>It is recommended that you install Erlang OTP R13B-4 or above where possible.
You will only need libcurl if you plan to run the JavaScript test suite. And
help2man is only need if you plan on installing the CouchDB man pages.
Python and Sphinx are only required for building the online documentation.</p>
<div class="section" id="debian-based-systems">
<h5>Debian-based Systems<a class="headerlink" href="#debian-based-systems" title="Permalink to this headline">¶</a></h5>
<p>You can install the dependencies by running:</p>
<div class="highlight-json"><div class="highlight"><pre>sudo apt-get install build-essential
sudo apt-get install erlang-base-hipe
sudo apt-get install erlang-dev
sudo apt-get install erlang-manpages
sudo apt-get install erlang-eunit
sudo apt-get install erlang-nox
sudo apt-get install libicu-dev
sudo apt-get install libmozjs-dev
sudo apt-get install libcurl4-openssl-dev
</pre></div>
</div>
<p>There are lots of Erlang packages. If there is a problem with your install, try
a different mix. There is more information on the wiki. Additionally, you might
want to install some of the optional Erlang tools which may also be useful.</p>
<p>Be sure to update the version numbers to match your system&#8217;s available packages.</p>
<p>Unfortunately, it seems that installing dependencies on Ubuntu is troublesome.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li><a class="reference external" href="http://wiki.apache.org/couchdb/Installing_on_Debian">Installing on Debian</a></li>
<li><a class="reference external" href="http://wiki.apache.org/couchdb/Installing_on_Ubuntu">Installing on Ubuntu</a></li>
</ul>
</div>
</div>
<div class="section" id="redhat-based-fedora-centos-rhel-systems">
<h5>RedHat-based (Fedora, Centos, RHEL) Systems<a class="headerlink" href="#redhat-based-fedora-centos-rhel-systems" title="Permalink to this headline">¶</a></h5>
<p>You can install the dependencies by running:</p>
<div class="highlight-json"><div class="highlight"><pre>sudo yum install autoconf
sudo yum install autoconf-archive
sudo yum install automake
sudo yum install curl-devel
sudo yum install erlang-asn1
sudo yum install erlang-erts
sudo yum install erlang-eunit
sudo yum install erlang-os_mon
sudo yum install erlang-xmerl
sudo yum install help2man
sudo yum install js-devel
sudo yum install libicu-devel
sudo yum install libtool
sudo yum install perl-Test-Harness
</pre></div>
</div>
<p>While CouchDB builds against the default js-devel-1.7.0 included in some
distributions, it&#8217;s recommended to use a more recent js-devel-1.8.5.</p>
</div>
<div class="section" id="mac-os-x">
<h5>Mac OS X<a class="headerlink" href="#mac-os-x" title="Permalink to this headline">¶</a></h5>
<p>Follow <a class="reference internal" href="contents.html#install-mac-homebrew"><em>Installation with HomeBrew</em></a> reference till <cite>brew install couchdb</cite> step.</p>
</div>
</div>
<div class="section" id="installing">
<h4>Installing<a class="headerlink" href="#installing" title="Permalink to this headline">¶</a></h4>
<p>Once you have satisfied the dependencies you should run:</p>
<div class="highlight-json"><div class="highlight"><pre>./configure
</pre></div>
</div>
<p>This script will configure CouchDB to be installed into <cite>/usr/local</cite> by default.</p>
<p>If you wish to customise the installation, pass <cite>&#8211;help</cite> to this script.</p>
<p>If everything was successful you should see the following message:</p>
<div class="highlight-json"><div class="highlight"><pre>You have configured Apache CouchDB, time to relax.
</pre></div>
</div>
<p>Relax.</p>
<p>To install CouchDB you should run:</p>
<div class="highlight-json"><div class="highlight"><pre>make &amp;&amp; sudo make install
</pre></div>
</div>
<p>You only need to use <cite>sudo</cite> if you&#8217;re installing into a system directory.</p>
<p>Try <cite>gmake</cite> if <cite>make</cite> is giving you any problems.</p>
<p>If everything was successful you should see the following message:</p>
<div class="highlight-json"><div class="highlight"><pre>You have installed Apache CouchDB, time to relax.
</pre></div>
</div>
<p>Relax.</p>
</div>
<div class="section" id="first-run">
<h4>First Run<a class="headerlink" href="#first-run" title="Permalink to this headline">¶</a></h4>
<p>You can start the CouchDB server by running:</p>
<div class="highlight-json"><div class="highlight"><pre>sudo -i -u couchdb couchdb
</pre></div>
</div>
<p>This uses the <cite>sudo</cite> command to run the <cite>couchdb</cite> command as the <cite>couchdb</cite> user.</p>
<p>When CouchDB starts it should eventually display the following message:</p>
<div class="highlight-json"><div class="highlight"><pre>Apache CouchDB has started, time to relax.
</pre></div>
</div>
<p>Relax.</p>
<p>To check that everything has worked, point your web browser to:</p>
<div class="highlight-json"><div class="highlight"><pre>http://127.0.0.1:5984/_utils/index.html
</pre></div>
</div>
<p>From here you should verify your installation by pointing your web browser to:</p>
<div class="highlight-json"><div class="highlight"><pre>http://localhost:5984/_utils/verify_install.html
</pre></div>
</div>
</div>
<div class="section" id="security-considerations">
<h4>Security Considerations<a class="headerlink" href="#security-considerations" title="Permalink to this headline">¶</a></h4>
<p>You should create a special <cite>couchdb</cite> user for CouchDB.</p>
<p>On many Unix-like systems you can run:</p>
<div class="highlight-json"><div class="highlight"><pre>adduser --system \
        --home /usr/local/var/lib/couchdb \
        --no-create-home \
        --shell /bin/bash \
        --group --gecos \
        &quot;CouchDB Administrator&quot; couchdb
</pre></div>
</div>
<p>On Mac OS X you can use the <a class="reference external" href="http://www.apple.com/support/downloads/serveradmintools1047.html">Workgroup Manager</a> to create users.</p>
<p>You must make sure that:</p>
<ul class="simple">
<li>The user has a working POSIX shell</li>
<li>The user&#8217;s home directory is <cite>/usr/local/var/lib/couchdb</cite></li>
</ul>
<p>You can test this by:</p>
<ul class="simple">
<li>Trying to log in as the <cite>couchdb</cite> user</li>
<li>Running <cite>pwd</cite> and checking the present working directory</li>
</ul>
<p>Change the ownership of the CouchDB directories by running:</p>
<div class="highlight-json"><div class="highlight"><pre>chown -R couchdb:couchdb /usr/local/etc/couchdb
chown -R couchdb:couchdb /usr/local/var/lib/couchdb
chown -R couchdb:couchdb /usr/local/var/log/couchdb
chown -R couchdb:couchdb /usr/local/var/run/couchdb
</pre></div>
</div>
<p>Change the permission of the CouchDB directories by running:</p>
<div class="highlight-json"><div class="highlight"><pre>chmod 0770 /usr/local/etc/couchdb
chmod 0770 /usr/local/var/lib/couchdb
chmod 0770 /usr/local/var/log/couchdb
chmod 0770 /usr/local/var/run/couchdb
</pre></div>
</div>
</div>
<div class="section" id="running-as-a-daemon">
<h4>Running as a Daemon<a class="headerlink" href="#running-as-a-daemon" title="Permalink to this headline">¶</a></h4>
<div class="section" id="sysv-bsd-style-systems">
<h5>SysV/BSD-style Systems<a class="headerlink" href="#sysv-bsd-style-systems" title="Permalink to this headline">¶</a></h5>
<p>You can use the <cite>couchdb</cite> init script to control the CouchDB daemon.</p>
<p>On SysV-style systems, the init script will be installed into:</p>
<div class="highlight-json"><div class="highlight"><pre>/usr/local/etc/init.d
</pre></div>
</div>
<p>On BSD-style systems, the init script will be installed into:</p>
<div class="highlight-json"><div class="highlight"><pre>/usr/local/etc/rc.d
</pre></div>
</div>
<p>We use the <cite>[init.d|rc.d]</cite> notation to refer to both of these directories.</p>
<p>You can control the CouchDB daemon by running:</p>
<div class="highlight-json"><div class="highlight"><pre>/usr/local/etc/[init.d|rc.d]/couchdb [start|stop|restart|status]
</pre></div>
</div>
<p>If you wish to configure how the init script works, you can edit:</p>
<div class="highlight-json"><div class="highlight"><pre>/usr/local/etc/default/couchdb
</pre></div>
</div>
<p>Comment out the <cite>COUCHDB_USER</cite> setting if you&#8217;re running as a non-superuser.</p>
<p>To start the daemon on boot, copy the init script to:</p>
<div class="highlight-json"><div class="highlight"><pre>/etc/[init.d|rc.d]
</pre></div>
</div>
<p>You should then configure your system to run the init script automatically.</p>
<p>You may be able to run:</p>
<div class="highlight-json"><div class="highlight"><pre>sudo update-rc.d couchdb defaults
</pre></div>
</div>
<p>If this fails, consult your system documentation for more information.</p>
<p>A <cite>logrotate</cite> configuration is installed into:</p>
<div class="highlight-json"><div class="highlight"><pre>/usr/local/etc/logrotate.d/couchdb
</pre></div>
</div>
<p>Consult your <cite>logrotate</cite> documentation for more information.</p>
<p>It is critical that the CouchDB logs are rotated so as not to fill your disk.</p>
</div>
</div>
</div>
<span id="document-install/windows"></span><div class="section" id="installation-on-windows">
<span id="install-windows"></span><h3>Installation on Windows<a class="headerlink" href="#installation-on-windows" title="Permalink to this headline">¶</a></h3>
<p>There are two ways to install CouchDB on Windows.</p>
<div class="section" id="installation-from-binaries">
<h4>Installation from binaries<a class="headerlink" href="#installation-from-binaries" title="Permalink to this headline">¶</a></h4>
<p>This is the simplest way to go.</p>
<ol class="arabic simple">
<li>Get <a class="reference external" href="http://couchdb.org/#download">the latest Windows binaries</a> from <a class="reference external" href="http://couchdb.org/">CouchDB web site</a>.
Old releases are available at <a class="reference external" href="http://archive.apache.org/dist/couchdb/binary/win/">archive</a>.</li>
<li>Follow the installation wizard steps:<ul>
<li>Next on &#8220;Welcome&#8221; screen</li>
<li>Accept the License agreement</li>
<li>Select the installation directory</li>
<li>Specify &#8220;Start Menu&#8221; group name</li>
<li>Approve that you&#8217;d like to install CouchDB as service and let it be
started automatically after installation (probably, you&#8217;d like so)</li>
<li>Verify installation settings</li>
<li>Install CouchDB</li>
</ul>
</li>
<li><a class="reference external" href="http://localhost:5984/_utils">Open up Futon</a> (if you hadn&#8217;t selected autostart CouchDB after
installation, you have to start it first manually)</li>
<li>It&#8217;s time to Relax!</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In some cases you might been asked to reboot Windows to complete
installation process, because of using on different Microsoft Visual C++
runtimes by CouchDB.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Upgrading note</strong></p>
<p>It&#8217;s recommended to uninstall previous CouchDB version before upgrading,
especially if the new one is built against different Erlang release.
The reason is simple: there may be leftover libraries with alternative or
incompatible versions from old Erlang release that may create conflicts,
errors and weird crashes.</p>
<p class="last">In this case, make sure you backup of your <cite>local.ini</cite> config and CouchDB
database/index files.</p>
</div>
</div>
<div class="section" id="installation-from-sources">
<h4>Installation from sources<a class="headerlink" href="#installation-from-sources" title="Permalink to this headline">¶</a></h4>
<p>If you&#8217;re Windows geek, this section is for you!</p>
<div class="section" id="troubleshooting">
<h5>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>There is a <a class="reference external" href="http://wiki.apache.org/couchdb/Troubleshooting">troubleshooting guide</a>.</li>
<li>There is a <a class="reference external" href="http://wiki.apache.org/couchdb">wiki</a> for general documentation.</li>
<li>And some <a class="reference external" href="http://wiki.apache.org/couchdb/Quirks_on_Windows">Windows-specific tips</a>.</li>
<li>There are collection of <a class="reference external" href="http://couchdb.apache.org/community/lists.html">friendly mailing lists</a>.</li>
</ul>
<p>Please work through these in order if you experience any problems.</p>
</div>
<div class="section" id="dependencies">
<h5>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h5>
<p>You should have the following installed:</p>
<ul class="simple">
<li><a class="reference external" href="http://erlang.org/">Erlang OTP (&gt;=14B01, &lt;R17)</a></li>
<li><a class="reference external" href="http://icu-project.org/">ICU        (&gt;=4.*)</a></li>
<li><a class="reference external" href="http://www.openssl.org/">OpenSSL    (&gt;0.9.8r)</a></li>
<li><a class="reference external" href="http://www.mozilla.org/js/spidermonkey/">Mozilla SpiderMonkey (=1.8.5)</a></li>
<li><a class="reference external" href="http://www.cygwin.com/">Cygwin</a></li>
<li><a class="reference external" href="http://www.microsoft.com/en-us/download/details.aspx?id=8279">Microsoft SDK 7.0 or 7.1</a></li>
<li><a class="reference external" href="http://curl.haxx.se/libcurl/">libcurl    (&gt;=7.20)</a></li>
<li><a class="reference external" href="http://www.gnu.org/s/help2man/">help2man</a></li>
<li><a class="reference external" href="http://python.org/">Python (&gt;=2.7) for docs</a></li>
<li><a class="reference external" href="http://pypi.python.org/pypi/Sphinx">Python Sphinx (&gt;=1.1.3)</a></li>
</ul>
<p>You will only need libcurl if you plan to run the JavaScript test suite. And
help2man is only need if you plan on installing the CouchDB man pages.
Python and Sphinx are only required for building the online documentation.</p>
</div>
<div class="section" id="general-notes">
<h5>General Notes<a class="headerlink" href="#general-notes" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>When installing Cygwin, be sure to select all the <cite>development</cite> tools.</li>
<li>When installing Erlang, you must build it from source.</li>
<li>The CouchDB build requires a number of the Erlang build scripts.</li>
<li>All dependent libraries should be built with the same version of
Microsoft SDK.</li>
<li>Do not try to link against libraries built with, or included in,
Cygwin or MingW. They are not compatible with the Erlang/OTP or CouchDB
build scripts.</li>
<li>ICU version 4.6 and later will build cleanly using MSBuild.</li>
<li>Python and Sphinx are optional for building the online documentation.
Use cygwin-provided Python and install Sphinx via easy_install or pip.
Further information is here <a class="reference external" href="http://pypi.python.org/pypi/setuptools#id4">http://pypi.python.org/pypi/setuptools#id4</a></li>
</ul>
</div>
<div class="section" id="setting-up-cygwin">
<h5>Setting Up Cygwin<a class="headerlink" href="#setting-up-cygwin" title="Permalink to this headline">¶</a></h5>
<p>Before starting any Cygwin terminals, run:</p>
<div class="highlight-json"><div class="highlight"><pre>set CYGWIN=nontsec
</pre></div>
</div>
<p>To set up your environment, run:</p>
<div class="highlight-json"><div class="highlight"><pre>[VS_BIN]/vcvars32.bat
</pre></div>
</div>
<p>Replace <tt class="docutils literal"><span class="pre">[VS_BIN]</span></tt> with the path to your Visual Studio <cite>bin</cite> directory.</p>
<p>You must check that:</p>
<ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">which</span> <span class="pre">link</span></tt> command points to the Microsoft linker.</li>
<li>The <tt class="docutils literal"><span class="pre">which</span> <span class="pre">cl</span></tt> command points to the Microsoft compiler.</li>
<li>The <tt class="docutils literal"><span class="pre">which</span> <span class="pre">mc</span></tt> command points to the Microsoft message compiler.</li>
<li>The <tt class="docutils literal"><span class="pre">which</span> <span class="pre">mt</span></tt> command points to the Microsoft manifest tool.</li>
<li>The <tt class="docutils literal"><span class="pre">which</span> <span class="pre">nmake</span></tt> command points to the Microsoft make tool.</li>
</ul>
<p>If you do not do this, the build may fail due to Cygwin ones found in <cite>/usr/bin</cite>
being used instead.</p>
</div>
<div class="section" id="building-erlang">
<h5>Building Erlang<a class="headerlink" href="#building-erlang" title="Permalink to this headline">¶</a></h5>
<p>You must include Win32 OpenSSL, built statically from source. Use
exactly the same version as required by the Erlang/OTP build process.</p>
<p>However, you can skip the GUI tools by running:</p>
<div class="highlight-json"><div class="highlight"><pre>echo &quot;skipping gs&quot; &gt; lib/gs/SKIP

echo &quot;skipping ic&quot; &gt; lib/ic/SKIP

echo &quot;skipping jinterface&quot; &gt; lib/jinterface/SKIP
</pre></div>
</div>
<p>Follow the rest of the Erlang instructions as described.</p>
<p>After running:</p>
<div class="highlight-json"><div class="highlight"><pre>./otp_build release -a
</pre></div>
</div>
<p>You should run:</p>
<div class="highlight-json"><div class="highlight"><pre>./release/win32/Install.exe -s
</pre></div>
</div>
<p>This will set up the release/win32/bin directory correctly. The CouchDB
installation scripts currently write their data directly into this
location.</p>
<p>To set up your environment for building CouchDB, run:</p>
<div class="highlight-json"><div class="highlight"><pre>eval `./otp_build env_win32`
</pre></div>
</div>
<p>To set up the <cite>ERL_TOP</cite> environment variable, run:</p>
<div class="highlight-json"><div class="highlight"><pre>export ERL_TOP=[ERL_TOP]
</pre></div>
</div>
<p>Replace <tt class="docutils literal"><span class="pre">[ERL_TOP]</span></tt> with the Erlang source directory name.</p>
<p>Remember to use <cite>/cygdrive/c/</cite> instead of <cite>c:/</cite> as the directory prefix.</p>
<p>To set up your path, run:</p>
<div class="highlight-json"><div class="highlight"><pre>export PATH=$ERL_TOP/release/win32/erts-5.8.5/bin:$PATH
</pre></div>
</div>
<p>If everything was successful, you should be ready to build CouchDB.</p>
<p>Relax.</p>
</div>
<div class="section" id="building-couchdb">
<h5>Building CouchDB<a class="headerlink" href="#building-couchdb" title="Permalink to this headline">¶</a></h5>
<p>Note that <cite>win32-curl</cite> is only required if you wish to run the developer
tests.</p>
<p>The documentation step may be skipped using <tt class="docutils literal"><span class="pre">--disable-docs</span></tt> if you wish.</p>
<p>Once you have satisfied the dependencies you should run:</p>
<div class="highlight-json"><div class="highlight"><pre>./configure \
    --with-js-include=/cygdrive/c/path_to_spidermonkey_include \
    --with-js-lib=/cygdrive/c/path_to_spidermonkey_lib \
    --with-win32-icu-binaries=/cygdrive/c/path_to_icu_binaries_root \
    --with-erlang=$ERL_TOP/release/win32/usr/include \
    --with-win32-curl=/cygdrive/c/path/to/curl/root/directory \
    --with-openssl-bin-dir=/cygdrive/c/openssl/bin \
    --with-msvc-redist-dir=/cygdrive/c/dir/with/vcredist_platform_executable \
    --disable-init \
    --disable-launchd \
    --prefix=$ERL_TOP/release/win32
</pre></div>
</div>
<p>This command could take a while to complete.</p>
<p>If everything was successful you should see the following message:</p>
<div class="highlight-json"><div class="highlight"><pre>You have configured Apache CouchDB, time to relax.
</pre></div>
</div>
<p>Relax.</p>
<p>To install CouchDB you should run:</p>
<div class="highlight-json"><div class="highlight"><pre>make install
</pre></div>
</div>
<p>If everything was successful you should see the following message:</p>
<div class="highlight-json"><div class="highlight"><pre>You have installed Apache CouchDB, time to relax.
</pre></div>
</div>
<p>Relax.</p>
<p>To build the .exe installer package, you should run:</p>
<div class="highlight-json"><div class="highlight"><pre>make dist
</pre></div>
</div>
<p>Alternatively, you may run CouchDB directly from the build tree, but
to avoid any contamination do not run <cite>make dist</cite> after this.</p>
</div>
<div class="section" id="first-run">
<h5>First Run<a class="headerlink" href="#first-run" title="Permalink to this headline">¶</a></h5>
<p>You can start the CouchDB server by running:</p>
<div class="highlight-json"><div class="highlight"><pre>$ERL_TOP/release/win32/bin/couchdb.bat
</pre></div>
</div>
<p>When CouchDB starts it should eventually display the following message:</p>
<div class="highlight-json"><div class="highlight"><pre>Apache CouchDB has started, time to relax.
</pre></div>
</div>
<p>Relax.</p>
<p>To check that everything has worked, point your web browser to:</p>
<div class="highlight-json"><div class="highlight"><pre>http://127.0.0.1:5984/_utils/index.html
</pre></div>
</div>
<p>From here you should run the verification tests in Firefox.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="https://github.com/dch/glazier">Glazier: Automate building of CouchDB from source on Windows</a></p>
</div>
</div>
</div>
</div>
<span id="document-install/mac"></span><div class="section" id="installation-on-mac-os-x">
<span id="install-mac"></span><h3>Installation on Mac OS X<a class="headerlink" href="#installation-on-mac-os-x" title="Permalink to this headline">¶</a></h3>
<div class="section" id="installation-using-the-apache-couchdb-native-application">
<span id="install-mac-binary"></span><h4>Installation using the Apache CouchDB native application<a class="headerlink" href="#installation-using-the-apache-couchdb-native-application" title="Permalink to this headline">¶</a></h4>
<p>The easiest way to run CouchDB on Mac OS X is through the native Mac OS X
application. Just follow the below instructions:</p>
<ol class="arabic simple">
<li><a class="reference external" href="http://couchdb.org/#download">Download Apache CouchDB for Mac OS X</a>.
Old releases are available at <a class="reference external" href="http://archive.apache.org/dist/couchdb/binary/mac/">archive</a>.</li>
<li>Double click on the Zip file</li>
<li>Drag and drop the Apache CouchDB.app into Applications folder</li>
</ol>
<p>That&#8217;s all, now CouchDB is installed on your Mac:</p>
<ol class="arabic simple">
<li>Run Apache CouchDB application</li>
<li><a class="reference external" href="http://localhost:5984/_utils">Open up Futon</a>, the CouchDB admin interface</li>
<li>Time to Relax!</li>
</ol>
</div>
<div class="section" id="installation-with-homebrew">
<span id="install-mac-homebrew"></span><h4>Installation with HomeBrew<a class="headerlink" href="#installation-with-homebrew" title="Permalink to this headline">¶</a></h4>
<p>You can install the build tools by running:</p>
<div class="highlight-json"><div class="highlight"><pre>open /Applications/Installers/Xcode\ Tools/XcodeTools.mpkg
</pre></div>
</div>
<p>You will need <a class="reference external" href="http://mxcl.github.com/homebrew/">Homebrew</a> installed to use the <cite>brew</cite> command. To install the
other <a class="reference internal" href="contents.html#install-unix-dependencies"><em>dependencies</em></a> run next commands:</p>
<div class="highlight-json"><div class="highlight"><pre>brew install autoconf
brew install autoconf-archive
brew install automake
brew install libtool
brew install erlang
brew install icu4c
brew install spidermonkey
brew install curl
</pre></div>
</div>
<p>You may want to link ICU so that CouchDB can find the header files
automatically:</p>
<div class="highlight-json"><div class="highlight"><pre>brew link icu4c
</pre></div>
</div>
<p>The same is true for recent versions of Erlang:</p>
<div class="highlight-json"><div class="highlight"><pre>brew link erlang
</pre></div>
</div>
<p>Now it&#8217;s time to brew CouchDB:</p>
<div class="highlight-json"><div class="highlight"><pre>brew install couchdb
</pre></div>
</div>
<p>The above Erlang install will use the bottled (pre-compiled) version if you are:
using <cite>/usr/local</cite> for <cite>homebrew</cite>, and on 10.6 or 10.7. If you&#8217;re not on one of
these, <cite>homebrew</cite> will build from source, so consider doing:</p>
<div class="highlight-json"><div class="highlight"><pre>brew install erlang --no-docs
</pre></div>
</div>
<p>to trim down compilation time.</p>
<p>If you&#8217;re hacking on CouchDB, and we hope you will, you may try the current
git-based master (head) branch, or the next development release using this
<tt class="docutils literal"><span class="pre">couchdb</span></tt> recipe, using either <tt class="docutils literal"><span class="pre">--head</span></tt> or <tt class="docutils literal"><span class="pre">--devel</span></tt> options respectively.
This will allow quick installation of the future release branch when it becomes
active. If you&#8217;re not sure if you need this, then you probably don&#8217;t.
In both cases we assume you are comfortable identifying bugs, and handling any
potential upgrades between commits to the codebase.</p>
<div class="highlight-json"><div class="highlight"><pre>brew install [--devel|--head] couchdb
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">OS X Lion might hang on the final brew.
See the thread at <a class="reference external" href="https://github.com/mxcl/homebrew/issues/7024">https://github.com/mxcl/homebrew/issues/7024</a> it seems in
most cases to be resolved by breaking out with <tt class="docutils literal"><span class="pre">CTRL-C</span></tt> and then repeating
with <tt class="docutils literal"><span class="pre">brew</span> <span class="pre">install</span> <span class="pre">-v</span> <span class="pre">couchdb</span></tt>.</p>
</div>
<p>If you wish to have CouchDB run as a daemon then, set up the account,
using the &#8220;User &amp; Groups&#8221; preference pane:</p>
<ul class="simple">
<li>Create a standard user <cite>couchdb</cite> with home directory as
<cite>/usr/local/var/lib/couchdb</cite></li>
<li>Create a group called <cite>couchdb</cite> and add yourself, the <cite>couchdb</cite> user, and any
others you want to be able to edit config or db files directly to it.
Use the <cite>advanced</cite> group options to ensure the internal name is also correctly
called <cite>couchdb</cite>.</li>
</ul>
<p>Some versions of Mac OS X ship a problematic OpenSSL library. If you&#8217;re
experiencing troubles with CouchDB crashing intermittently with a segmentation
fault or a bus error, you will need to install your own version of OpenSSL.</p>
<div class="section" id="running-as-a-daemon">
<h5>Running as a Daemon<a class="headerlink" href="#running-as-a-daemon" title="Permalink to this headline">¶</a></h5>
<p>You can use the <cite>launchctl</cite> command to control the CouchDB daemon.</p>
<p>You can load the configuration by running:</p>
<div class="highlight-json"><div class="highlight"><pre>sudo launchctl load \
     /usr/local/Library/LaunchDaemons/org.apache.couchdb.plist
</pre></div>
</div>
<p>You can stop the CouchDB daemon by running:</p>
<div class="highlight-json"><div class="highlight"><pre>sudo launchctl unload \
     /usr/local/Library/LaunchDaemons/org.apache.couchdb.plist
</pre></div>
</div>
<p>You can start CouchDB by running:</p>
<div class="highlight-json"><div class="highlight"><pre>sudo launchctl start org.apache.couchdb
</pre></div>
</div>
<p>You can restart CouchDB by running:</p>
<div class="highlight-json"><div class="highlight"><pre>sudo launchctl stop org.apache.couchdb
</pre></div>
</div>
<p>You can edit the launchd configuration by running:</p>
<div class="highlight-json"><div class="highlight"><pre>open /usr/local/Library/LaunchDaemons/org.apache.couchdb.plist
</pre></div>
</div>
<p>To start the daemon on boot, copy the configuration file to:</p>
<div class="highlight-json"><div class="highlight"><pre>/Library/LaunchDaemons
</pre></div>
</div>
<p>Consult your system documentation for more information.</p>
</div>
</div>
<div class="section" id="installation-from-macports">
<span id="install-mac-macports"></span><h4>Installation from MacPorts<a class="headerlink" href="#installation-from-macports" title="Permalink to this headline">¶</a></h4>
<p>To install CouchDB using MacPorts you have 2 package choices:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">couchdb</span></tt> - the latest release version</li>
<li><tt class="docutils literal"><span class="pre">couchdb-devel</span></tt> - updated every few weeks with the latest from the master
branch</li>
</ul>
<div class="highlight-json"><div class="highlight"><pre>$ sudo port install couchdb
</pre></div>
</div>
<p>should be enough. MacPorts takes care of installing all necessary dependencies.
If you have already installed some of the CouchDB dependencies via MacPorts,
run this command to check and upgrade any outdated ones, after installing
CouchDB:</p>
<div class="highlight-json"><div class="highlight"><pre>$ sudo port upgrade couchdb
</pre></div>
</div>
<p>This will upgrade dependencies recursively, if there are more recent versions
available. If you want to run CouchDB as a service controlled by the OS, load
the launchd configuration which comes with the project, with this command:</p>
<div class="highlight-json"><div class="highlight"><pre>$ sudo port load couchdb
</pre></div>
</div>
<p>and it should be up and accessible via Futon at <a class="reference external" href="http://127.0.0.1:5984/_utils">http://127.0.0.1:5984/_utils</a>.
It should also be restarted automatically after reboot.</p>
<p>Updating the ports collection. The collection of port files has to be updated
to reflect the latest versions of available packages. In order to do that run:</p>
<div class="highlight-json"><div class="highlight"><pre>$ sudo port selfupdate
</pre></div>
</div>
<p>to update the port tree, and then install just as explained.</p>
</div>
</div>
<span id="document-install/freebsd"></span><div class="section" id="installation-on-freebsd">
<span id="install-freebsd"></span><h3>Installation on FreeBSD<a class="headerlink" href="#installation-on-freebsd" title="Permalink to this headline">¶</a></h3>
<div class="section" id="installation-from-ports">
<h4>Installation from ports<a class="headerlink" href="#installation-from-ports" title="Permalink to this headline">¶</a></h4>
<div class="highlight-text"><div class="highlight"><pre>cd /usr/ports/databases/couchdb
make install clean
</pre></div>
</div>
<p>This will install CouchDB from the ports collection.</p>
<div class="section" id="start-script">
<h5>Start script<a class="headerlink" href="#start-script" title="Permalink to this headline">¶</a></h5>
<p>The following options for <tt class="docutils literal"><span class="pre">/etc/rc.conf</span></tt> or <tt class="docutils literal"><span class="pre">/etc/rc.conf.local</span></tt> are
supported by the start script (defaults shown):</p>
<div class="highlight-json"><div class="highlight"><pre>couchdb_enable=&quot;NO&quot;
couchdb_enablelogs=&quot;YES&quot;
couchdb_user=&quot;couchdb&quot;
</pre></div>
</div>
<p>After enabling the couchdb rc service use the following command to start CouchDB:</p>
<div class="highlight-json"><div class="highlight"><pre>/usr/local/etc/rc.d/couchdb start
</pre></div>
</div>
<p>This script responds to the arguments <cite>start</cite>, <cite>stop</cite>, <cite>status</cite>, <cite>rcvar</cite> etc..</p>
<p>The start script will also use settings from the following config files:</p>
<ul class="simple">
<li>/usr/local/etc/couchdb/default.ini</li>
<li>/usr/local/etc/couchdb/local.ini</li>
</ul>
<p>Administrators should use <tt class="docutils literal"><span class="pre">default.ini</span></tt> as reference and only modify the
<tt class="docutils literal"><span class="pre">local.ini</span></tt> file.</p>
</div>
<div class="section" id="post-install">
<h5>Post install<a class="headerlink" href="#post-install" title="Permalink to this headline">¶</a></h5>
<p>In case the install script fails to install a noninteractive user &#8220;couchdb&#8221; to
be used for the database, the user needs to be created manually:</p>
<p>I used the <tt class="docutils literal"><span class="pre">pw</span></tt> command to add a user &#8220;couchdb&#8221; in group &#8220;couchdb&#8221;:</p>
<div class="highlight-text"><div class="highlight"><pre>pw user add couchdb
pw user mod couchdb -c &#39;CouchDB, time to relax&#39; -s /usr/sbin/nologin -d /var/lib/couchdb
pw group add couchdb
</pre></div>
</div>
<p>The user is added to <tt class="docutils literal"><span class="pre">/etc/passwd</span></tt> and should look similar to the following:</p>
<div class="highlight-text"><div class="highlight"><pre>shell#  grep couchdb /etc/passwd
couchdb:*:1013:1013:Couchdb, time to relax:/var/lib/couchdb/:/usr/sbin/nologin
</pre></div>
</div>
<p>To change any of these settings, please refrain from editing <cite>/etc/passwd</cite> and
instead use <tt class="docutils literal"><span class="pre">pw</span> <span class="pre">user</span> <span class="pre">mod</span> <span class="pre">...</span></tt> or <tt class="docutils literal"><span class="pre">vipw</span></tt>. Make sure that the user has no
shell, but instead uses <tt class="docutils literal"><span class="pre">/usr/sbin/nologin</span></tt>. The &#8216;*&#8217; in the second field means
that this user can not login via password authorization. For details use
<a class="reference external" href="http://linux.die.net/man/5/passwd">man 5 passwd</a>.</p>
</div>
</div>
</div>
</div>
</div>
<span id="document-config/index"></span><div class="section" id="configuring-couchdb">
<span id="config"></span><h2>Configuring CouchDB<a class="headerlink" href="#configuring-couchdb" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-config/intro"></span><div class="section" id="introduction-into-configuring">
<span id="config-intro"></span><h3>Introduction Into Configuring<a class="headerlink" href="#introduction-into-configuring" title="Permalink to this headline">¶</a></h3>
<div class="section" id="configuration-files">
<h4>Configuration files<a class="headerlink" href="#configuration-files" title="Permalink to this headline">¶</a></h4>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The following section covering load order of config files
applies only to UNIX-ish systems.
For Windows, only the provided <tt class="docutils literal"><span class="pre">default.ini</span></tt> and <tt class="docutils literal"><span class="pre">local.ini</span></tt>
files are relevant. These can of course have content
appended, which achieves the same type of functionality
as outlined for UNIX-ish systems below.</p>
</div>
<p>By default, CouchDB reads configuration files from the following locations,
in the following order:</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">LOCALCONFDIR/default.ini</span></tt></li>
<li><tt class="docutils literal"><span class="pre">LOCALCONFDIR/default.d/*.ini</span></tt></li>
<li><tt class="docutils literal"><span class="pre">PLUGINS_DIR/*/priv/default.d/*.ini</span></tt></li>
<li><tt class="docutils literal"><span class="pre">LOCALCONFDIR/local.ini</span></tt></li>
<li><tt class="docutils literal"><span class="pre">LOCALCONFDIR/local.d/*.ini</span></tt></li>
</ol>
<p>The <tt class="docutils literal"><span class="pre">LOCALCONFDIR</span></tt> points to the directory that contains configuration files
(<tt class="docutils literal"><span class="pre">/usr/local/etc/couchdb</span></tt> by default). This variable may vary from the
target operation system and may be changed during building from the source code.
For binary distributions, it mostly points to the installation path
(e.g. <tt class="docutils literal"><span class="pre">C:\Program</span> <span class="pre">Files\CouchDB\etc\couchdb</span></tt> for Windows).</p>
<p>To see the actual configuration files chain run in shell:</p>
<div class="highlight-ini"><div class="highlight"><pre>couchdb -c
</pre></div>
</div>
<p>This will print out all <em>actual</em> configuration files that will form the result
CouchDB configuration:</p>
<div class="highlight-ini"><div class="highlight"><pre>/etc/couchdb/default.ini
/etc/couchdb/default.d/geocouch.ini
/etc/couchdb/local.ini
/etc/couchdb/local.d/geocouch.ini
/etc/couchdb/local.d/vendor.ini
</pre></div>
</div>
<p>Settings in successive documents override the settings in earlier entries.
For example, setting the <a class="reference internal" href="contents.html#httpd/bind_address" title="bind_address"><tt class="xref config config-option docutils literal"><span class="pre">httpd/bind_address</span></tt></a> parameter in <tt class="docutils literal"><span class="pre">local.ini</span></tt>
would override any setting in <tt class="docutils literal"><span class="pre">default.ini</span></tt>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The <tt class="docutils literal"><span class="pre">default.ini</span></tt> file may be overwritten during an upgrade or
re-installation, so localised changes should be made to the
<tt class="docutils literal"><span class="pre">local.ini</span></tt> file or files within the <tt class="docutils literal"><span class="pre">local.d</span></tt> directory.</p>
</div>
<p>The configuration files chain may be changed by specifying additional sources
by using next command line options:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">-a</span></tt>: adds configuration file to the chain</li>
<li><tt class="docutils literal"><span class="pre">-A</span></tt>: adds configuration directory to the chain</li>
</ul>
<p>Let&#8217;s add these options and see how the configuration chain changes:</p>
<div class="highlight-ini"><div class="highlight"><pre>shell&gt; couchdb -c -a /home/couchdb/custom.ini
/etc/couchdb/default.ini
/etc/couchdb/default.d/geocouch.ini
/etc/couchdb/local.ini
/etc/couchdb/local.d/geocouch.ini
/etc/couchdb/local.d/vendor.ini
/home/couchdb/custom.ini
</pre></div>
</div>
<p>In case when <cite>/home/couchdb/custom.ini</cite> exists it will be added to
the configuration chain.</p>
</div>
<div class="section" id="parameter-names-and-values">
<h4>Parameter names and values<a class="headerlink" href="#parameter-names-and-values" title="Permalink to this headline">¶</a></h4>
<p>All parameter names are <em>case-sensitive</em>. Every parameter takes a value of one
of five types: <cite>boolean</cite>, <cite>integer</cite>, <cite>string</cite>, <a class="reference external" href="http://www.erlang.org/doc/reference_manual/data_types.html#id66049">tuple</a> and <a class="reference external" href="http://www.erlang.org/doc/man/proplists.html">proplist</a>. Boolean
values can be written as <tt class="docutils literal"><span class="pre">true</span></tt> or <tt class="docutils literal"><span class="pre">false</span></tt>.</p>
<p>Parameters with value type of <cite>tuple</cite> or <cite>proplist</cite> are following the Erlang
requirement for style and naming.</p>
</div>
<div class="section" id="setting-parameters-via-the-configuration-file">
<h4>Setting parameters via the configuration file<a class="headerlink" href="#setting-parameters-via-the-configuration-file" title="Permalink to this headline">¶</a></h4>
<p>The common way to set some parameters is to edit the <cite>local.ini</cite> file which is
mostly located in the <cite>etc/couchdb</cite> directory relative your installation path
root.</p>
<p>For example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="c1">; This is a comment</span>
<span class="k">[section]</span>
<span class="na">param</span> <span class="o">=</span> <span class="s">value ; inline comments are allowed</span>
</pre></div>
</div>
<p>Each configuration file line may contains <cite>section</cite> definition, <cite>parameter</cite>
specification, empty (space and newline characters only) or <cite>commented</cite> line.
You can setup <cite>inline</cite> commentaries for <cite>sections</cite> or <cite>parameters</cite>.</p>
<p>The <cite>section</cite> defines group of parameters that are belongs to some specific
CouchDB subsystem. For instance, <a class="reference internal" href="contents.html#httpd" title="[httpd]"><tt class="xref config config-section docutils literal"><span class="pre">httpd</span></tt></a> section holds not only HTTP
server parameters, but also others that directly interacts with it.</p>
<p>The <cite>parameter</cite> specification contains two parts divided by the <cite>equal</cite> sign
(<tt class="docutils literal"><span class="pre">=</span></tt>): the parameter name on the left side and the parameter value on the
right one. The leading and following whitespace for <tt class="docutils literal"><span class="pre">=</span></tt> is an optional to
improve configuration readability.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>In case when you&#8217;d like to remove some parameter from the <cite>default.ini</cite>
without modifying that file, you may override in <cite>local.ini</cite>, but
without any value:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_all_dbs</span> <span class="o">=</span>
</pre></div>
</div>
<p class="last">This could be read as: &#8220;remove the <cite>_all_dbs</cite> parameter from
the <cite>httpd_global_handlers</cite> section if it was ever set before&#8221;.</p>
</div>
<p>The semicolon (<tt class="docutils literal"><span class="pre">;</span></tt>) signs about <cite>commentary</cite> start: everything after this
character is counted as commentary and doesn&#8217;t process by CouchDB.</p>
<p>After editing of configuration file CouchDB server instance should be restarted
to apply these changes.</p>
</div>
<div class="section" id="setting-parameters-via-the-http-api">
<h4>Setting parameters via the HTTP API<a class="headerlink" href="#setting-parameters-via-the-http-api" title="Permalink to this headline">¶</a></h4>
<p>Alternatively, configuration parameters could be set via the
<a class="reference internal" href="contents.html#api-config"><em>HTTP API</em></a>. This API allows to change CouchDB configuration
on-the-fly without requiring a server restart:</p>
<div class="highlight-ini"><div class="highlight"><pre>curl -X PUT http://localhost:5984/_config/uuids/algorithm -d &#39;&quot;random&quot;&#39;
</pre></div>
</div>
<p>In the response the old parameter&#8217;s value returns:</p>
<div class="highlight-ini"><div class="highlight"><pre>&quot;sequential&quot;
</pre></div>
</div>
<p>You should be careful with changing configuration via the HTTP API since it&#8217;s
easy to make CouchDB unavailable. For instance, if you&#8217;d like to change the
<a class="reference internal" href="contents.html#httpd/bind_address" title="bind_address"><tt class="xref config config-option docutils literal"><span class="pre">httpd/bind_address</span></tt></a> for a new one:</p>
<div class="highlight-ini"><div class="highlight"><pre>curl -X PUT http://localhost:5984/_config/httpd/bind_address -d &#39;&quot;10.10.0.128&quot;&#39;
</pre></div>
</div>
<p>However, if you make a typo, or the specified IP address is not available
from your network, CouchDB will be unavailable for you in both cases and
the only way to resolve this will be by remoting into the server, correcting
the errant file, and restarting CouchDB. To protect yourself against such
accidents you may set the <a class="reference internal" href="contents.html#httpd/config_whitelist" title="config_whitelist"><tt class="xref config config-option docutils literal"><span class="pre">httpd/config_whitelist</span></tt></a> of permitted
configuration parameters for updates via the HTTP API. Once this option is set,
further changes to non-whitelisted parameters must take place via the
configuration file, and in most cases, also requires a server restart before
hand-edited options take effect.</p>
</div>
</div>
<span id="document-config/couchdb"></span><div class="section" id="base-configuration">
<h3>Base Configuration<a class="headerlink" href="#base-configuration" title="Permalink to this headline">¶</a></h3>
<div class="section" id="base-couchdb-options">
<span id="config-couchdb"></span><h4>Base CouchDB Options<a class="headerlink" href="#base-couchdb-options" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="couchdb">
<tt class="descname">[couchdb]</tt><a class="headerlink" href="#couchdb" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="couchdb/attachment_stream_buffer_size">
<tt class="descname">attachment_stream_buffer_size</tt><a class="headerlink" href="#couchdb/attachment_stream_buffer_size" title="Permalink to this definition">¶</a></dt>
<dd><p>Higher values may result in better read performance due to fewer read
operations and/or more OS page cache hits. However, they can also increase
overall response time for writes when there are many attachment write
requests in parallel.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">attachment_stream_buffer_size</span> <span class="o">=</span> <span class="s">4096</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/database_dir">
<tt class="descname">database_dir</tt><a class="headerlink" href="#couchdb/database_dir" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies location of CouchDB database files (<tt class="docutils literal"><span class="pre">*.couch</span></tt> named).
This location should be writable and readable for the user the CouchDB
service runs as (<tt class="docutils literal"><span class="pre">couchdb</span></tt> by default).</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">database_dir</span> <span class="o">=</span> <span class="s">/var/lib/couchdb</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/delayed_commits">
<tt class="descname">delayed_commits</tt><a class="headerlink" href="#couchdb/delayed_commits" title="Permalink to this definition">¶</a></dt>
<dd><p>When this config value as <tt class="docutils literal"><span class="pre">false</span></tt> the CouchDB provides guaranty of <cite>fsync</cite>
call before return <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> response on each document saving.
Setting this config value as <tt class="docutils literal"><span class="pre">true</span></tt> may raise some overall performance
with cost of losing durability - it&#8217;s strongly not recommended to do such
in production:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">delayed_commits</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Delayed commits are a feature of CouchDB that allows it to achieve better
write performance for some workloads while sacrificing a small amount of
durability. The setting causes CouchDB to wait up to a full second before
committing new data after an update. If the server crashes before
the header is written then any writes since the last commit are lost.</p>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/file_compression">
<tt class="descname">file_compression</tt><a class="headerlink" href="#couchdb/file_compression" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.2: </span>Added <a class="reference external" href="http://code.google.com/p/snappy/">Google Snappy</a> compression algorithm.</p>
</div>
<p>Method used to compress everything that is appended to database and
view index files, except for attachments (see the <a class="reference internal" href="contents.html#attachments" title="[attachments]"><tt class="xref config config-section docutils literal"><span class="pre">attachments</span></tt></a>
section). Available methods are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">none</span></tt>: no compression</li>
<li><tt class="docutils literal"><span class="pre">snappy</span></tt>: use Google Snappy, a very fast compressor/decompressor</li>
<li><tt class="docutils literal"><span class="pre">deflate_N</span></tt>: use zlib&#8217;s deflate; <tt class="docutils literal"><span class="pre">N</span></tt> is the compression level which
ranges from <tt class="docutils literal"><span class="pre">1</span></tt> (fastest, lowest compression ratio) to <tt class="docutils literal"><span class="pre">9</span></tt> (slowest,
highest compression ratio)</li>
</ul>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">file_compression</span> <span class="o">=</span> <span class="s">snappy</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/fsync_options">
<tt class="descname">fsync_options</tt><a class="headerlink" href="#couchdb/fsync_options" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies when to make <cite>fsync</cite> calls. <cite>fsync</cite> makes sure that
the contents of any file system buffers kept by the operating system are
flushed to disk. There is generally no need to modify this parameter.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">fsync_options</span> <span class="o">=</span> <span class="s">[before_header, after_header, on_file_open]</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/max_dbs_open">
<tt class="descname">max_dbs_open</tt><a class="headerlink" href="#couchdb/max_dbs_open" title="Permalink to this definition">¶</a></dt>
<dd><p>This option places an upper bound on the number of databases that can be
open at once. CouchDB reference counts database accesses internally and will
close idle databases as needed. Sometimes it is necessary to keep more than
the default open at once, such as in deployments where many databases will
be replicating continuously.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">max_dbs_open</span> <span class="o">=</span> <span class="s">100</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/max_document_size">
<tt class="descname">max_document_size</tt><a class="headerlink" href="#couchdb/max_document_size" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.3: </span>This option now actually works.</p>
</div>
<p>Defines a maximum size for JSON documents, in bytes. This limit does not
apply to attachments, since they are transferred as a stream of chunks.
If you set this to a small value, you might be unable to modify
configuration options, database security and other larger documents until
a larger value is restored by editing the configuration file.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">max_document_size</span> <span class="o">=</span> <span class="s">4294967296 ; 4 GB</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/os_process_timeout">
<tt class="descname">os_process_timeout</tt><a class="headerlink" href="#couchdb/os_process_timeout" title="Permalink to this definition">¶</a></dt>
<dd><p>If an external process, such as a query server or external process, runs for
this amount of microseconds without returning any results, it will be
terminated. Keeping this value smaller ensures you get expedient errors, but
you may want to tweak it for your specific needs.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">os_process_timeout</span> <span class="o">=</span> <span class="s">5000 ; 5 sec</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/uri_file">
<tt class="descname">uri_file</tt><a class="headerlink" href="#couchdb/uri_file" title="Permalink to this definition">¶</a></dt>
<dd><p>This file contains the full <a class="reference external" href="http://en.wikipedia.org/wiki/URI">URI</a> that can be used to access this
instance of CouchDB. It is used to help discover the port CouchDB is running
on (if it was set to <tt class="docutils literal"><span class="pre">0</span></tt> (e.g. automatically assigned any free one).
This file should be writable and readable for the user that runs the CouchDB
service (<tt class="docutils literal"><span class="pre">couchdb</span></tt> by default).</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">uri_file</span> <span class="o">=</span> <span class="s">/var/run/couchdb/couchdb.uri</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/util_driver_dir">
<tt class="descname">util_driver_dir</tt><a class="headerlink" href="#couchdb/util_driver_dir" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies location of binary drivers (<cite>icu</cite>, <cite>ejson</cite>, etc.). This location
and its contents should be readable for the user that runs the CouchDB
service.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">util_driver_dir</span> <span class="o">=</span> <span class="s">/usr/lib/couchdb/erlang/lib/couch-1.5.0/priv/lib</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/uuid">
<tt class="descname">uuid</tt><a class="headerlink" href="#couchdb/uuid" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>Unique identifier for this CouchDB server instance.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">uuid</span> <span class="o">=</span> <span class="s">0a959b9b8227188afc2ac26ccdf345a6</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couchdb/view_index_dir">
<tt class="descname">view_index_dir</tt><a class="headerlink" href="#couchdb/view_index_dir" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies location of CouchDB view index files. This location should be
writable and readable for the user that runs the CouchDB service
(<tt class="docutils literal"><span class="pre">couchdb</span></tt> by default).</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">view_index_dir</span> <span class="o">=</span> <span class="s">/var/lib/couchdb</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
</div>
<span id="document-config/http"></span><div class="section" id="couchdb-http-server">
<h3>CouchDB HTTP Server<a class="headerlink" href="#couchdb-http-server" title="Permalink to this headline">¶</a></h3>
<div class="section" id="http-server-options">
<span id="config-httpd"></span><h4>HTTP Server Options<a class="headerlink" href="#http-server-options" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="httpd">
<tt class="descname">[httpd]</tt><a class="headerlink" href="#httpd" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="httpd/allow_jsonp">
<tt class="descname">allow_jsonp</tt><a class="headerlink" href="#httpd/allow_jsonp" title="Permalink to this definition">¶</a></dt>
<dd><p>The <tt class="docutils literal"><span class="pre">true</span></tt> value of this option enables <a class="reference external" href="http://www.json-p.org/">JSONP</a> support (it&#8217;s <tt class="docutils literal"><span class="pre">false</span></tt> by
default):</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">allow_jsonp</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/authentication_handlers">
<tt class="descname">authentication_handlers</tt><a class="headerlink" href="#httpd/authentication_handlers" title="Permalink to this definition">¶</a></dt>
<dd><p>List of used authentication handlers that used by CouchDB. You may extend
them via third-party plugins or remove some of them if you won&#8217;t let users
to use one of provided methods:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">authentication_handlers</span> <span class="o">=</span> <span class="s">{couch_httpd_oauth, oauth_authentication_handler}, {couch_httpd_auth, cookie_authentication_handler}, {couch_httpd_auth, default_authentication_handler}</span>
</pre></div>
</div>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">{couch_httpd_oauth,</span> <span class="pre">oauth_authentication_handler}</span></tt>: handles OAuth;</li>
<li><tt class="docutils literal"><span class="pre">{couch_httpd_auth,</span> <span class="pre">cookie_authentication_handler}</span></tt>: used for Cookie auth;</li>
<li><tt class="docutils literal"><span class="pre">{couch_httpd_auth,</span> <span class="pre">proxy_authentication_handler}</span></tt>: used for Proxy auth;</li>
<li><tt class="docutils literal"><span class="pre">{couch_httpd_auth,</span> <span class="pre">default_authentication_handler}</span></tt>: used for Basic auth;</li>
<li><tt class="docutils literal"><span class="pre">{couch_httpd_auth,</span> <span class="pre">null_authentication_handler}</span></tt>: disables auth.
Everlasting <cite>Admin Party</cite>!</li>
</ul>
</dd></dl>

<dl class="option">
<dt id="httpd/bind_address">
<tt class="descname">bind_address</tt><a class="headerlink" href="#httpd/bind_address" title="Permalink to this definition">¶</a></dt>
<dd><p>Defines the IP address by which CouchDB will be accessible:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">bind_address</span> <span class="o">=</span> <span class="s">127.0.0.1</span>
</pre></div>
</div>
<p>To let CouchDB listen any available IP address, just setup <tt class="docutils literal"><span class="pre">0.0.0.0</span></tt>
value:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">bind_address</span> <span class="o">=</span> <span class="s">0.0.0.0</span>
</pre></div>
</div>
<p>For IPv6 support you need to set <tt class="docutils literal"><span class="pre">::1</span></tt> if you want to let CouchDB listen
local address:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">bind_address</span> <span class="o">=</span> <span class="s">::1</span>
</pre></div>
</div>
<p>or <tt class="docutils literal"><span class="pre">::</span></tt> for any available:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">bind_address</span> <span class="o">=</span> <span class="s">::</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/changes_timeout">
<tt class="descname">changes_timeout</tt><a class="headerlink" href="#httpd/changes_timeout" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies default <cite>timeout</cite> value for <a class="reference internal" href="contents.html#changes"><em>Changes Feed</em></a> in
milliseconds (60000 by default):</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">changes_feed</span> <span class="o">=</span> <span class="s">60000 ; 60 seconds</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/config_whitelist">
<tt class="descname">config_whitelist</tt><a class="headerlink" href="#httpd/config_whitelist" title="Permalink to this definition">¶</a></dt>
<dd><p>Sets the configuration modification whitelist. Only whitelisted values
may be changed via the <a class="reference internal" href="contents.html#api-config"><em>config API</em></a>. To allow the admin
to change this value over HTTP, remember to include
<tt class="docutils literal"><span class="pre">{httpd,config_whitelist}</span></tt> itself. Excluding it from the list would
require editing this file to update the whitelist:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">config_whitelist</span> <span class="o">=</span> <span class="s">[{httpd,config_whitelist}, {log,level}, {etc,etc}]</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/default_handler">
<tt class="descname">default_handler</tt><a class="headerlink" href="#httpd/default_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies default HTTP requests handler:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">default_handler</span> <span class="o">=</span> <span class="s">{couch_httpd_db, handle_request}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/enable_cors">
<tt class="descname">enable_cors</tt><a class="headerlink" href="#httpd/enable_cors" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>Controls <a class="reference internal" href="contents.html#config-cors"><em>CORS</em></a> feature:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">enable_cors</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/log_max_chunk_size">
<tt class="descname">log_max_chunk_size</tt><a class="headerlink" href="#httpd/log_max_chunk_size" title="Permalink to this definition">¶</a></dt>
<dd><p>Defines maximum chunk size in bytes for <a class="reference internal" href="contents.html#api-server-log"><em>_log</em></a>
resource:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">log_max_chunk_size</span> <span class="o">=</span> <span class="s">1000000</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/port">
<tt class="descname">port</tt><a class="headerlink" href="#httpd/port" title="Permalink to this definition">¶</a></dt>
<dd><p>Defined the port number to listen:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">5984</span>
</pre></div>
</div>
<p>To let CouchDB handle any free port, set this option to <tt class="docutils literal"><span class="pre">0</span></tt>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">0</span>
</pre></div>
</div>
<p>After that, CouchDB URI could be located within the URI file.</p>
</dd></dl>

<dl class="option">
<dt id="httpd/redirect_vhost_handler">
<tt class="descname">redirect_vhost_handler</tt><a class="headerlink" href="#httpd/redirect_vhost_handler" title="Permalink to this definition">¶</a></dt>
<dd><p>This option customizes the default function that handles requests to
<a class="reference internal" href="contents.html#vhosts" title="[vhosts]"><tt class="xref config config-section docutils literal"><span class="pre">virtual</span> <span class="pre">hosts</span></tt></a>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">redirect_vhost_handler</span> <span class="o">=</span> <span class="s">{Module, Fun}</span>
</pre></div>
</div>
<p>The specified function take 2 arguments: the Mochiweb request object and the
target path.</p>
</dd></dl>

<dl class="option">
<dt id="httpd/server_options">
<tt class="descname">server_options</tt><a class="headerlink" href="#httpd/server_options" title="Permalink to this definition">¶</a></dt>
<dd><p>Server options for the <a class="reference external" href="https://github.com/mochi/mochiweb">MochiWeb</a> component of CouchDB can be added to the
configuration files:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">server_options</span> <span class="o">=</span> <span class="s">[{backlog, 128}, {acceptor_pool_size, 16}]</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/secure_rewrites">
<tt class="descname">secure_rewrites</tt><a class="headerlink" href="#httpd/secure_rewrites" title="Permalink to this definition">¶</a></dt>
<dd><p>This option allow to isolate databases via subdomains:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">secure_rewrites</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/socket_options">
<tt class="descname">socket_options</tt><a class="headerlink" href="#httpd/socket_options" title="Permalink to this definition">¶</a></dt>
<dd><p>The socket options for the listening socket in CouchDB can be specified as
a list of tuples. For example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">socket_options</span> <span class="o">=</span> <span class="s">[{recbuf, 262144}, {sndbuf, 262144}, {nodelay, true}]</span>
</pre></div>
</div>
<p>The options supported are a subset of full options supported by the
TCP/IP stack. A list of the supported options are provided in the
<a class="reference external" href="http://www.erlang.org/doc/man/inet.html#setopts-2">Erlang inet</a> documentation.</p>
</dd></dl>

<dl class="option">
<dt id="httpd/vhost_global_handlers">
<tt class="descname">vhost_global_handlers</tt><a class="headerlink" href="#httpd/vhost_global_handlers" title="Permalink to this definition">¶</a></dt>
<dd><p>List of global handlers that are available for <a class="reference internal" href="contents.html#vhosts" title="[vhosts]"><tt class="xref config config-section docutils literal"><span class="pre">virtual</span> <span class="pre">hosts</span></tt></a>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">vhost_global_handlers</span> <span class="o">=</span> <span class="s">_utils, _uuids, _session, _oauth, _users</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/x_forwarded_host">
<tt class="descname">x_forwarded_host</tt><a class="headerlink" href="#httpd/x_forwarded_host" title="Permalink to this definition">¶</a></dt>
<dd><p>The <cite>x_forwarded_host</cite> header (<tt class="docutils literal"><span class="pre">X-Forwarded-Host</span></tt> by default) is used to
forward the original value of the <tt class="docutils literal"><span class="pre">Host</span></tt> header field in case, for
example, if a reverse proxy is rewriting the &#8220;Host&#8221; header field to some
internal host name before forward the request to CouchDB:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">x_forwarded_host</span> <span class="o">=</span> <span class="s">X-Forwarded-Host</span>
</pre></div>
</div>
<p>This header has higher priority above <tt class="docutils literal"><span class="pre">Host</span></tt> one, if only it exists in
the request.</p>
</dd></dl>

<dl class="option">
<dt id="httpd/x_forwarded_proto">
<tt class="descname">x_forwarded_proto</tt><a class="headerlink" href="#httpd/x_forwarded_proto" title="Permalink to this definition">¶</a></dt>
<dd><p><cite>x_forwarded_proto</cite> header (<tt class="docutils literal"><span class="pre">X-Forwarder-Proto</span></tt> by default) is used for
identifying the originating protocol of an HTTP request, since a reverse
proxy may communicate with CouchDB instance using HTTP even if the request
to the reverse proxy is HTTPS:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">x_forwarded_proto</span> <span class="o">=</span> <span class="s">X-Forwarded-Proto</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/x_forwarded_ssl">
<tt class="descname">x_forwarded_ssl</tt><a class="headerlink" href="#httpd/x_forwarded_ssl" title="Permalink to this definition">¶</a></dt>
<dd><p>The <cite>x_forwarded_ssl</cite> header (<tt class="docutils literal"><span class="pre">X-Forwarded-Ssl</span></tt> by default) tells CouchDB
that it should use the <cite>https</cite> scheme instead of the <cite>http</cite>. Actually, it&#8217;s
a synonym for <tt class="docutils literal"><span class="pre">X-Forwarded-Proto:</span> <span class="pre">https</span></tt> header, but used by some reverse
proxies:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">x_forwarded_ssl</span> <span class="o">=</span> <span class="s">X-Forwarded-Ssl</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd/WWW-Authenticate">
<tt class="descname">WWW-Authenticate</tt><a class="headerlink" href="#httpd/WWW-Authenticate" title="Permalink to this definition">¶</a></dt>
<dd><p>Set this option to trigger basic-auth popup on unauthorized requests:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">WWW-Authenticate</span> <span class="o">=</span> <span class="s">Basic realm=&quot;Welcome to the Couch!&quot;</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="secure-socket-level-options">
<span id="config-ssl"></span><h4>Secure Socket Level Options<a class="headerlink" href="#secure-socket-level-options" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="ssl">
<tt class="descname">[ssl]</tt><a class="headerlink" href="#ssl" title="Permalink to this definition">¶</a></dt>
<dd><p>CouchDB supports SSL natively. All your secure connection needs can
now be served without needing to setup and maintain a separate proxy server
that handles SSL.</p>
<p>SSL setup can be tricky, but the configuration in CouchDB was designed
to be as easy as possible. All you need is two files; a certificate and
a private key. If you bought an official SSL certificate from a
certificate authority, both should be in your possession already.</p>
<p>If you just want to try this out and don&#8217;t want to pay anything upfront,
you can create a self-signed certificate. Everything will work the same,
but clients will get a warning about an insecure certificate.</p>
<p>You will need the <a class="reference external" href="http://www.openssl.org/">OpenSSL</a> command line tool installed. It probably
already is.</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; mkdir /etc/couchdb/cert
shell&gt; <span class="nb">cd</span> /etc/couchdb/cert
shell&gt; openssl genrsa &gt; privkey.pem
shell&gt; openssl req -new -x509 -key privkey.pem -out couchdb.pem -days 1095
shell&gt; chmod <span class="m">600</span> privkey.pem couchdb.pem
shell&gt; chown couchdb privkey.pem couchdb.pem
</pre></div>
</div>
<p>Now, you need to edit CouchDB&#8217;s configuration, either by editing your
<tt class="docutils literal"><span class="pre">local.ini</span></tt> file or using the <tt class="docutils literal"><span class="pre">/_config</span></tt> API calls or the
configuration screen in Futon. Here is what you need to do in
<tt class="docutils literal"><span class="pre">local.ini</span></tt>, you can infer what needs doing in the other places.</p>
<p>At first, <a class="reference internal" href="contents.html#daemons/httpsd" title="httpsd"><tt class="xref config config-option docutils literal"><span class="pre">enable</span> <span class="pre">the</span> <span class="pre">HTTPS</span> <span class="pre">daemon</span></tt></a>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">httpsd</span> <span class="o">=</span> <span class="s">{couch_httpd, start_link, [https]}</span>
</pre></div>
</div>
<p>Next, under <tt class="docutils literal"><span class="pre">[ssl]</span></tt> section setup newly generated certificates:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[ssl]</span>
<span class="na">cert_file</span> <span class="o">=</span> <span class="s">/etc/couchdb/cert/couchdb.pem</span>
<span class="na">key_file</span> <span class="o">=</span> <span class="s">/etc/couchdb/cert/privkey.pem</span>
</pre></div>
</div>
<p>For more information please read <a class="reference external" href="http://www.openssl.org/docs/HOWTO/certificates.txt">certificates HOWTO</a>.</p>
<p>Now start (or restart) CouchDB. You should be able to connect to it
using HTTPS on port 6984:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl https://127.0.0.1:6984/
curl: (60) SSL certificate problem, verify that the CA cert is OK. Details:
error:14090086:SSL routines:SSL3_GET_SERVER_CERTIFICATE:certificate verify failed
More details here: http://curl.haxx.se/docs/sslcerts.html

curl performs SSL certificate verification by default, using a &quot;bundle&quot;
of Certificate Authority (CA) public keys (CA certs). If the default
bundle file isn&#39;t adequate, you can specify an alternate file
using the --cacert option.
If this HTTPS server uses a certificate signed by a CA represented in
the bundle, the certificate verification probably failed due to a
problem with the certificate (it might be expired, or the name might
not match the domain name in the URL).
If you&#39;d like to turn off curl&#39;s verification of the certificate, use
the -k (or --insecure) option.
</pre></div>
</div>
<p>Oh no! What happened?! Remember, clients will notify their users that
your certificate is self signed. <tt class="docutils literal"><span class="pre">curl</span></tt> is the client in this case and
it notifies you. Luckily you trust yourself (don&#8217;t you?) and you can
specify the <tt class="docutils literal"><span class="pre">-k</span></tt> option as the message reads:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl -k https://127.0.0.1:6984/
<span class="o">{</span><span class="s2">&quot;couchdb&quot;</span>:<span class="s2">&quot;Welcome&quot;</span>,<span class="s2">&quot;version&quot;</span>:<span class="s2">&quot;1.5.0&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>All done.</p>
<dl class="option">
<dt id="ssl/cacert_file">
<tt class="descname">cacert_file</tt><a class="headerlink" href="#ssl/cacert_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Path to file containing PEM encoded CA certificates (trusted certificates
used for verifying a peer certificate). May be omitted if you do not want
to verify the peer:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[ssl]</span>
<span class="na">cacert_file</span> <span class="o">=</span> <span class="s">/etc/ssl/certs/ca-certificates.crt</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="ssl/cert_file">
<tt class="descname">cert_file</tt><a class="headerlink" href="#ssl/cert_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Path to a file containing the user&#8217;s certificate:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[ssl]</span>
<span class="na">cert_file</span> <span class="o">=</span> <span class="s">/etc/couchdb/cert/couchdb.pem</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="ssl/key_file">
<tt class="descname">key_file</tt><a class="headerlink" href="#ssl/key_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Path to file containing user&#8217;s private PEM encoded key:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[ssl]</span>
<span class="na">key_file</span> <span class="o">=</span> <span class="s">/etc/couchdb/cert/privkey.pem</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="ssl/password">
<tt class="descname">password</tt><a class="headerlink" href="#ssl/password" title="Permalink to this definition">¶</a></dt>
<dd><p>String containing the user&#8217;s password. Only used if the private keyfile is
password protected:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[ssl]</span>
<span class="na">password</span> <span class="o">=</span> <span class="s">somepassword</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="ssl/ssl_certificate_max_depth">
<tt class="descname">ssl_certificate_max_depth</tt><a class="headerlink" href="#ssl/ssl_certificate_max_depth" title="Permalink to this definition">¶</a></dt>
<dd><p>Maximum peer certificate depth (must be set even if certificate validation
is off):</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[ssl]</span>
<span class="na">ssl_certificate_max_depth</span> <span class="o">=</span> <span class="s">1</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="ssl/verify_fun">
<tt class="descname">verify_fun</tt><a class="headerlink" href="#ssl/verify_fun" title="Permalink to this definition">¶</a></dt>
<dd><p>The verification fun (optional) if not specified, the default
verification fun will be used:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[ssl]</span>
<span class="na">verify_fun</span> <span class="o">=</span> <span class="s">{Module, VerifyFun}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="ssl/verify_ssl_certificates">
<tt class="descname">verify_ssl_certificates</tt><a class="headerlink" href="#ssl/verify_ssl_certificates" title="Permalink to this definition">¶</a></dt>
<dd><p>Set to <cite>true</cite> to validate peer certificates:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[ssl]</span>
<span class="na">verify_ssl_certificates</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="cross-origin-resource-sharing">
<span id="config-cors"></span><span id="cors"></span><h4>Cross-Origin Resource Sharing<a class="headerlink" href="#cross-origin-resource-sharing" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="cors">
<tt class="descname">[cors]</tt><a class="headerlink" href="#cors" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.3: </span>added CORS support, see JIRA <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-431">COUCHDB-431</a></p>
</div>
<p><cite>CORS</cite>, or &#8220;Cross-Origin Resource Sharing&#8221;, allows a resource such as a web
page running JavaScript inside a browser, to make AJAX requests
(XMLHttpRequests) to a different domain, without compromising the security
of either party.</p>
<p>A typical use case is to have a static website hosted on a CDN make
requests to another resource, such as a hosted CouchDB instance. This
avoids needing an intermediary proxy, using <cite>JSONP</cite> or similar workarounds
to retrieve and host content.</p>
<p>While CouchDB&#8217;s integrated HTTP server has support for document attachments
makes this less of a constraint for pure CouchDB projects, there are many
cases where separating the static content from the database access is
desirable, and CORS makes this very straightforward.</p>
<p>By supporting CORS functionality, a CouchDB instance can accept direct
connections to protected databases and instances, without the browser
functionality being blocked due to same-origin constraints. CORS is
supported today on over 90% of recent browsers.</p>
<p>CORS support is provided as experimental functionality in 1.3, and as such
will need to be enabled specifically in CouchDB&#8217;s configuration. While all
origins are forbidden from making requests by default, support is available
for simple requests, preflight requests and per-vhost configuration.</p>
<p>This section requires <a class="reference internal" href="contents.html#httpd/enable_cors" title="enable_cors"><tt class="xref config config-option docutils literal"><span class="pre">httpd/enable_cors</span></tt></a> option have
<tt class="docutils literal"><span class="pre">true</span></tt> value:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">enable_cors</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
<dl class="option">
<dt id="cors/credentials">
<tt class="descname">credentials</tt><a class="headerlink" href="#cors/credentials" title="Permalink to this definition">¶</a></dt>
<dd><p>By default, neither authentication headers nor cookies are included in
requests and responses. To do so requires both setting
<tt class="docutils literal"><span class="pre">XmlHttpRequest.withCredentials</span> <span class="pre">=</span> <span class="pre">true</span></tt> on the request object in the
browser and enabling credentials support in CouchDB.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[cors]</span>
<span class="na">credentials</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
<p>CouchDB will respond to a credentials-enabled CORS request with an
additional header, <tt class="docutils literal"><span class="pre">Access-Control-Allow-Credentials=true</span></tt>.</p>
</dd></dl>

<dl class="option">
<dt id="cors/origins">
<tt class="descname">origins</tt><a class="headerlink" href="#cors/origins" title="Permalink to this definition">¶</a></dt>
<dd><p>List of origins separated by a comma, <tt class="docutils literal"><span class="pre">*</span></tt> means accept all.
You can’t set <tt class="docutils literal"><span class="pre">origins</span> <span class="pre">=</span> <span class="pre">*</span></tt> and <tt class="docutils literal"><span class="pre">credentials</span> <span class="pre">=</span> <span class="pre">true</span></tt> option at the same
time:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[cors]</span>
<span class="na">origins</span> <span class="o">=</span> <span class="s">*</span>
</pre></div>
</div>
<p>Access can be restricted by protocol, host and optionally by port. Origins
must follow the scheme: <a class="reference external" href="http://example.com:80">http://example.com:80</a>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[cors]</span>
<span class="na">origins</span> <span class="o">=</span> <span class="s">http://localhost, https://localhost, http://couch.mydev.name:8080</span>
</pre></div>
</div>
<p>Note that by default, no origins are accepted. You must define them
explicitly.</p>
</dd></dl>

<dl class="option">
<dt id="cors/headers">
<tt class="descname">headers</tt><a class="headerlink" href="#cors/headers" title="Permalink to this definition">¶</a></dt>
<dd><p>List of accepted headers separated by a comma:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[cors]</span>
<span class="na">headers</span> <span class="o">=</span> <span class="s">X-Couch-Id, X-Couch-Rev</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="cors/methods">
<tt class="descname">methods</tt><a class="headerlink" href="#cors/methods" title="Permalink to this definition">¶</a></dt>
<dd><p>List of accepted methods:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[cors]</span>
<span class="na">methods</span> <span class="o">=</span> <span class="s">GET,POST</span>
</pre></div>
</div>
</dd></dl>

<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p>Original JIRA <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-431">implementation ticket</a></p>
<p>Standards and References:</p>
<ul class="simple">
<li>IETF RFCs relating to methods: <span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2618.html"><strong>RFC 2618</strong></a>, <span class="target" id="index-1"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2817.html"><strong>RFC 2817</strong></a>, <span class="target" id="index-2"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc5789.html"><strong>RFC 5789</strong></a></li>
<li>IETF RFC for Web Origins: <span class="target" id="index-3"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc6454.html"><strong>RFC 6454</strong></a></li>
<li>W3C <a class="reference external" href="http://www.w3.org/TR/cors">CORS standard</a></li>
</ul>
<p>Mozilla Developer Network Resources:</p>
<ul class="simple">
<li><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Same-origin_policy_for_file:_URIs">Same origin policy for URIs</a></li>
<li><a class="reference external" href="https://developer.mozilla.org/En/HTTP_access_control">HTTP Access Control</a></li>
<li><a class="reference external" href="https://developer.mozilla.org/En/Server-Side_Access_Control">Server-side Access Control</a></li>
<li><a class="reference external" href="https://developer.mozilla.org/en-US/docs/Same_origin_policy_for_JavaScript">Javascript same origin policy</a></li>
</ul>
<p>Client-side CORS support and usage:</p>
<ul class="last simple">
<li><a class="reference external" href="http://caniuse.com/cors">CORS browser support matrix</a></li>
<li><a class="reference external" href="http://www.html5rocks.com/en/tutorials/cors/">COS tutorial</a></li>
<li><a class="reference external" href="http://hacks.mozilla.org/2009/07/cross-site-xmlhttprequest-with-cors/">XHR with CORS</a></li>
</ul>
</div>
</dd></dl>

<div class="section" id="per-virtual-host-configuration">
<h5>Per Virtual Host Configuration<a class="headerlink" href="#per-virtual-host-configuration" title="Permalink to this headline">¶</a></h5>
<p>To set the options for a <a class="reference internal" href="contents.html#vhosts" title="[vhosts]"><tt class="xref config config-section docutils literal"><span class="pre">vhosts</span></tt></a>, you will need to create a section
with the vhost name prefixed by <tt class="docutils literal"><span class="pre">cors:</span></tt>. Example case for the vhost
<cite>example.com</cite>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[cors:example.com]</span>
<span class="na">credentials</span> <span class="o">=</span> <span class="s">false</span>
<span class="c1">; List of origins separated by a comma</span>
<span class="na">origins</span> <span class="o">=</span> <span class="s">*</span>
<span class="c1">; List of accepted headers separated by a comma</span>
<span class="na">headers</span> <span class="o">=</span> <span class="s">X-CouchDB-Header</span>
<span class="c1">; List of accepted methods</span>
<span class="na">methods</span> <span class="o">=</span> <span class="s">HEAD, GET</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="virtual-hosts">
<span id="config-vhosts"></span><h4>Virtual Hosts<a class="headerlink" href="#virtual-hosts" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="vhosts">
<tt class="descname">[vhosts]</tt><a class="headerlink" href="#vhosts" title="Permalink to this definition">¶</a></dt>
<dd><p>CouchDB can map requests to different locations based on the <tt class="docutils literal"><span class="pre">Host</span></tt> header,
even if they arrive on the same inbound IP address.</p>
<p>This allows different virtual hosts on the same machine to map to different
databases or design documents, etc. The most common use case is to map a
virtual host to a <a class="reference internal" href="contents.html#api-ddoc-rewrite"><em>Rewrite Handler</em></a>, to provide full
control over the application&#8217;s URIs.</p>
<p>To add a virtual host, add a <cite>CNAME</cite> pointer to the DNS for your domain
name. For development and testing, it is sufficient to add an entry in
the hosts file, typically <cite>/etc/hosts`</cite> on Unix-like operating systems:</p>
<div class="highlight-text"><div class="highlight"><pre># CouchDB vhost definitions, refer to local.ini for further details
127.0.0.1       couchdb.local
</pre></div>
</div>
<p>Test that this is working:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ping -n <span class="m">2</span> couchdb.local
PING couchdb.local <span class="o">(</span>127.0.0.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from localhost <span class="o">(</span>127.0.0.1<span class="o">)</span>: <span class="nv">icmp_req</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nb">time</span><span class="o">=</span>0.025 ms
<span class="m">64</span> bytes from localhost <span class="o">(</span>127.0.0.1<span class="o">)</span>: <span class="nv">icmp_req</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nb">time</span><span class="o">=</span>0.051 ms
</pre></div>
</div>
<p>Finally, add an entry to your <a class="reference internal" href="contents.html#config"><em>configuration file</em></a> in the
<tt class="docutils literal"><span class="pre">[vhosts]</span></tt> section:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[vhosts]</span>
<span class="na">couchdb.local:5984</span> <span class="o">=</span> <span class="s">/example</span>
<span class="na">*.couchdb.local:5984</span> <span class="o">=</span> <span class="s">/example</span>
</pre></div>
</div>
<p>If your CouchDB is listening on the the default HTTP port (80), or is sitting
behind a proxy, then you don&#8217;t need to specify a port number in the <cite>vhost</cite>
key.</p>
<p>The first line will rewrite the request to display the content of the
<cite>example</cite> database. This rule works only if the <tt class="docutils literal"><span class="pre">Host</span></tt> header is
<tt class="docutils literal"><span class="pre">couchdb.local</span></tt> and won&#8217;t work for <cite>CNAMEs</cite>. The second rule, on the other
hand, matches all <cite>CNAMEs</cite> to <cite>example</cite> db, so that both <cite>www.couchdb.local</cite>
and <cite>db.couchdb.local</cite> will work.</p>
</dd></dl>

<div class="section" id="rewriting-hosts-to-a-path">
<h5>Rewriting Hosts to a Path<a class="headerlink" href="#rewriting-hosts-to-a-path" title="Permalink to this headline">¶</a></h5>
<p>Like in the <a class="reference internal" href="contents.html#api-ddoc-rewrite"><em>_rewrite</em></a> handler you can match some
variable and use them to create the target path. Some examples:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[vhosts]</span>
<span class="na">*.couchdb.local</span> <span class="o">=</span> <span class="s">/*</span>
<span class="na">:dbname.</span> <span class="o">=</span> <span class="s">/:dbname</span>
<span class="na">:ddocname.:dbname.example.com</span> <span class="o">=</span> <span class="s">/:dbname/_design/:ddocname/_rewrite</span>
</pre></div>
</div>
<p>The first rule passes the wildcard as <cite>dbname</cite>. The second one does the same,
but uses a variable name. And the third one allows you to use any URL with
<cite>ddocname</cite> in any database with <cite>dbname</cite>.</p>
<p>You could also change the default function to handle request by changing
the setting <a class="reference internal" href="contents.html#httpd/redirect_vhost_handler" title="redirect_vhost_handler"><tt class="xref config config-option docutils literal"><span class="pre">httpd/redirect_vhost_handler</span></tt></a>.</p>
</div>
</div>
</div>
<span id="document-config/auth"></span><div class="section" id="authentication-and-authorization">
<h3>Authentication and Authorization<a class="headerlink" href="#authentication-and-authorization" title="Permalink to this headline">¶</a></h3>
<div class="section" id="server-administrators">
<span id="config-admins"></span><h4>Server Administrators<a class="headerlink" href="#server-administrators" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="admins">
<tt class="descname">[admins]</tt><a class="headerlink" href="#admins" title="Permalink to this definition">¶</a></dt>
<dd><p>A default CouchDB install provides admin-level access to all connecting users.
This configuration is known as <cite>Admin Party</cite>, and is not recommended for
in-production usage. You can crash the party simply by creating the first
admin account. CouchDB server administrators and passwords are not stored
in the <tt class="docutils literal"><span class="pre">_users</span></tt> database, but in the <tt class="docutils literal"><span class="pre">local.ini</span></tt> file, which should be
appropriately secured and readable only by system administrators:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[admins]</span>
<span class="c1">;admin = mysecretpassword</span>
<span class="na">admin</span> <span class="o">=</span> <span class="s">-hashed-6d3c30241ba0aaa4e16c6ea99224f915687ed8cd,7f4a3e05e0cbc6f48a0035e3508eef90</span>
<span class="na">architect</span> <span class="o">=</span> <span class="s">-pbkdf2-43ecbd256a70a3a2f7de40d2374b6c3002918834,921a12f74df0c1052b3e562a23cd227f,10000</span>
</pre></div>
</div>
<p>Administrators can be added directly to the <tt class="docutils literal"><span class="pre">[admins]</span></tt> section, and when
CouchDB is restarted, the passwords will be salted and encrypted. You may
also use the HTTP interface to create administrator accounts; this way,
you don&#8217;t need to restart CouchDB, and there&#8217;s no need to temporarily store
or transmit passwords in plaintext. The HTTP <tt class="docutils literal"><span class="pre">_config/admins</span></tt> endpoint
supports querying, deleting or creating new admin accounts:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_config/admins</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">196</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 30 Nov 2012 11:37:18 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
</pre></div>
</div>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;admin&quot;</span><span class="p">:</span> <span class="s2">&quot;-hashed-6d3c30241ba0aaa4e16c6ea99224f915687ed8cd,7f4a3e05e0cbc6f48a0035e3508eef90&quot;</span><span class="p">,</span>
  <span class="nt">&quot;architect&quot;</span><span class="p">:</span> <span class="s2">&quot;-pbkdf2-43ecbd256a70a3a2f7de40d2374b6c3002918834,921a12f74df0c1052b3e562a23cd227f,10000&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you already have a salted, encrypted password string (for example,
from an old <tt class="docutils literal"><span class="pre">local.ini</span></tt> file, or from a different CouchDB server), then
you can store the &#8220;raw&#8221; encrypted string, without having CouchDB doubly
encrypt it.</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/_config/admins/architect?raw=true</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">89</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="s2">&quot;-pbkdf2-43ecbd256a70a3a2f7de40d2374b6c3002918834,921a12f74df0c1052b3e562a23cd227f,10000&quot;</span>
</pre></div>
</div>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">89</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 30 Nov 2012 11:39:18 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="s2">&quot;-pbkdf2-43ecbd256a70a3a2f7de40d2374b6c3002918834,921a12f74df0c1052b3e562a23cd227f,10000&quot;</span>
</pre></div>
</div>
<p>Further details are available in <cite>security</cite>, including configuring the
work factor for <tt class="docutils literal"><span class="pre">PBKDF2</span></tt>, and the algorithm itself at
<a class="reference external" href="http://tools.ietf.org/html/rfc2898">PBKDF2 (RFC-2898)</a>.</p>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.4: </span><cite>PBKDF2</cite> server-side hashed salted password support
added, now as a synchronous call for the <tt class="docutils literal"><span class="pre">_config/admins</span></tt> API.</p>
</div>
</dd></dl>

</div>
<div class="section" id="authentication-configuration">
<span id="config-couch-httpd-auth"></span><h4>Authentication Configuration<a class="headerlink" href="#authentication-configuration" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="couch_httpd_auth">
<tt class="descname">[couch_httpd_auth]</tt><a class="headerlink" href="#couch_httpd_auth" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="couch_httpd_auth/allow_persistent_cookies">
<tt class="descname">allow_persistent_cookies</tt><a class="headerlink" href="#couch_httpd_auth/allow_persistent_cookies" title="Permalink to this definition">¶</a></dt>
<dd><p>Makes cookies persistent if <tt class="docutils literal"><span class="pre">true</span></tt>.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">allow_persistent_cookies</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/auth_cache_size">
<tt class="descname">auth_cache_size</tt><a class="headerlink" href="#couch_httpd_auth/auth_cache_size" title="Permalink to this definition">¶</a></dt>
<dd><p>Number of <a class="reference internal" href="contents.html#userctx-object"><em>User Context Object</em></a> to cache in memory, to reduce disk lookups.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">auth_cache_size</span> <span class="o">=</span> <span class="s">50</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/authentication_db">
<tt class="descname">authentication_db</tt><a class="headerlink" href="#couch_httpd_auth/authentication_db" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies the name of the system database for storing CouchDB users.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">authentication_db</span> <span class="o">=</span> <span class="s">_users</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you change the database name, do not forget to remove or clean
up the old database, since it will no longer be protected by CouchDB.</p>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/authentication_redirect">
<tt class="descname">authentication_redirect</tt><a class="headerlink" href="#couch_httpd_auth/authentication_redirect" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies the location for redirection on successful authentication if a
<tt class="docutils literal"><span class="pre">text/html</span></tt> response is accepted by the client (via an <tt class="docutils literal"><span class="pre">Accept</span></tt> header).</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">authentication_redirect</span> <span class="o">=</span> <span class="s">/_utils/session.html</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/iterations">
<tt class="descname">iterations</tt><a class="headerlink" href="#couch_httpd_auth/iterations" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>The number of iterations for password hashing by the PBKDF2 algorithm.
A higher  number provides better hash durability, but comes at a cost in
performance for each request that requires authentication.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">iterations</span> <span class="o">=</span> <span class="s">10000</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/min_iterations">
<tt class="descname">min_iterations</tt><a class="headerlink" href="#couch_httpd_auth/min_iterations" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>The minimum number of iterations allowed for passwords hashed by
the PBKDF2 algorithm. Any user with fewer iterations is forbidden.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">min_iterations</span> <span class="o">=</span> <span class="s">100</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/max_iterations">
<tt class="descname">max_iterations</tt><a class="headerlink" href="#couch_httpd_auth/max_iterations" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>The maximum number of iterations allowed for passwords hashed by
the PBKDF2 algorithm. Any user with greater iterations is forbidden.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">max_iterations</span> <span class="o">=</span> <span class="s">100000</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/proxy_use_secret">
<tt class="descname">proxy_use_secret</tt><a class="headerlink" href="#couch_httpd_auth/proxy_use_secret" title="Permalink to this definition">¶</a></dt>
<dd><p>When this option is set to <tt class="docutils literal"><span class="pre">true</span></tt>,  the <a class="reference internal" href="contents.html#couch_httpd_auth/secret" title="secret"><tt class="xref config config-option docutils literal"><span class="pre">couch_httpd_auth/secret</span></tt></a>
option is required for <a class="reference internal" href="contents.html#api-auth-proxy"><em>Proxy Authentication</em></a>.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">proxy_use_secret</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/public_fields">
<tt class="descname">public_fields</tt><a class="headerlink" href="#couch_httpd_auth/public_fields" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>A comma-separated list of field names in user documents (in
<a class="reference internal" href="contents.html#couch_httpd_auth/authentication_db" title="authentication_db"><tt class="xref config config-option docutils literal"><span class="pre">couch_httpd_auth/authentication_db</span></tt></a>) that can
be read by any user. If unset or not specified, authenticated users can only
retrieve their own document.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">public_fields</span> <span class="o">=</span> <span class="s">first_name, last_name, contacts, url</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Using the <tt class="docutils literal"><span class="pre">public_fields</span></tt> whitelist for user document properties
requires setting the <a class="reference internal" href="contents.html#couch_httpd_auth/users_db_public" title="users_db_public"><tt class="xref config config-option docutils literal"><span class="pre">couch_httpd_auth/users_db_public</span></tt></a>
option to <tt class="docutils literal"><span class="pre">true</span></tt> (the latter option has no other purpose):</p>
<div class="last highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">users_db_public</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/require_valid_user">
<tt class="descname">require_valid_user</tt><a class="headerlink" href="#couch_httpd_auth/require_valid_user" title="Permalink to this definition">¶</a></dt>
<dd><p>When this option is set to <tt class="docutils literal"><span class="pre">true</span></tt>, no requests are allowed from anonymous
users. Everyone must be authenticated.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">require_valid_user</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/secret">
<tt class="descname">secret</tt><a class="headerlink" href="#couch_httpd_auth/secret" title="Permalink to this definition">¶</a></dt>
<dd><p>The secret token used for <a class="reference internal" href="contents.html#api-auth-proxy"><em>Proxy Authentication</em></a> method.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">secret</span> <span class="o">=</span> <span class="s">92de07df7e7a3fe14808cef90a7cc0d91</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/timeout">
<tt class="descname">timeout</tt><a class="headerlink" href="#couch_httpd_auth/timeout" title="Permalink to this definition">¶</a></dt>
<dd><p>Number of seconds since the last request before sessions will be expired.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">timeout</span> <span class="o">=</span> <span class="s">600</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/users_db_public">
<tt class="descname">users_db_public</tt><a class="headerlink" href="#couch_httpd_auth/users_db_public" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>Allow all users to view user documents. By default, only admins may browse
all users documents, while users may browse only their own document.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">users_db_public</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/x_auth_roles">
<tt class="descname">x_auth_roles</tt><a class="headerlink" href="#couch_httpd_auth/x_auth_roles" title="Permalink to this definition">¶</a></dt>
<dd><p>The HTTP header name (<tt class="docutils literal"><span class="pre">X-Auth-CouchDB-Roles</span></tt> by default) that contains the
list of a user&#8217;s roles, separated by a comma. Used for
<a class="reference internal" href="contents.html#api-auth-proxy"><em>Proxy Authentication</em></a>.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">x_auth_roles</span> <span class="o">=</span> <span class="s">X-Auth-CouchDB-Roles</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/x_auth_token">
<tt class="descname">x_auth_token</tt><a class="headerlink" href="#couch_httpd_auth/x_auth_token" title="Permalink to this definition">¶</a></dt>
<dd><p>The HTTP header name (<tt class="docutils literal"><span class="pre">X-Auth-CouchDB-Token</span></tt> by default) containing the
token used to authenticate the authorization. This token is an <cite>HMAC-SHA1</cite>
created from the <a class="reference internal" href="contents.html#couch_httpd_auth/secret" title="secret"><tt class="xref config config-option docutils literal"><span class="pre">couch_httpd_auth/secret</span></tt></a> and
<a class="reference internal" href="contents.html#couch_httpd_auth/x_auth_username" title="x_auth_username"><tt class="xref config config-option docutils literal"><span class="pre">couch_httpd_auth/x_auth_username</span></tt></a>. The secret key should be
the same on the client and the CouchDB node. This token is optional if
the value of the <a class="reference internal" href="contents.html#couch_httpd_auth/proxy_use_secret" title="proxy_use_secret"><tt class="xref config config-option docutils literal"><span class="pre">couch_httpd_auth/proxy_use_secret</span></tt></a> option is not
<tt class="docutils literal"><span class="pre">true</span></tt>. Used for <a class="reference internal" href="contents.html#api-auth-proxy"><em>Proxy Authentication</em></a>.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">x_auth_roles</span> <span class="o">=</span> <span class="s">X-Auth-CouchDB-Token</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="couch_httpd_auth/x_auth_username">
<tt class="descname">x_auth_username</tt><a class="headerlink" href="#couch_httpd_auth/x_auth_username" title="Permalink to this definition">¶</a></dt>
<dd><p>The HTTP header name (<tt class="docutils literal"><span class="pre">X-Auth-CouchDB-UserName</span></tt> by default) containing the
username. Used for <a class="reference internal" href="contents.html#api-auth-proxy"><em>Proxy Authentication</em></a>.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_auth]</span>
<span class="na">x_auth_username</span> <span class="o">=</span> <span class="s">X-Auth-CouchDB-UserName</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="http-oauth-configuration">
<span id="config-couch-httpd-oauth"></span><h4>HTTP OAuth Configuration<a class="headerlink" href="#http-oauth-configuration" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="couch_httpd_oauth">
<tt class="descname">[couch_httpd_oauth]</tt><a class="headerlink" href="#couch_httpd_oauth" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.2.</span></p>
</div>
<dl class="option">
<dt id="couch_httpd_oauth/use_users_db">
<tt class="descname">use_users_db</tt><a class="headerlink" href="#couch_httpd_oauth/use_users_db" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>CouchDB is able to store OAuth credentials within user documents instead of
config file by using this option:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couch_httpd_oauth]</span>
<span class="na">use_users_db</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
<p>If set to <tt class="docutils literal"><span class="pre">true</span></tt>, OAuth token and consumer secrets will be looked up in the
<a class="reference internal" href="contents.html#couch_httpd_auth/authentication_db" title="authentication_db"><tt class="xref config config-option docutils literal"><span class="pre">authentication</span> <span class="pre">database</span></tt></a>.
These secrets are stored in a top level field named <tt class="docutils literal"><span class="pre">&quot;oauth&quot;</span></tt> in user
documents, as below.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;org.couchdb.user:joe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;joe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;password_sha&quot;</span><span class="o">:</span> <span class="s2">&quot;fe95df1ca59a9b567bdca5cbaf8412abd6e06121&quot;</span><span class="p">,</span>
    <span class="s2">&quot;salt&quot;</span><span class="o">:</span> <span class="s2">&quot;4e170ffeb6f34daecfd814dfb4001a73&quot;</span>
    <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">],</span>
    <span class="s2">&quot;oauth&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;consumer_keys&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;consumerKey1&quot;</span><span class="o">:</span> <span class="s2">&quot;key1Secret&quot;</span><span class="p">,</span>
            <span class="s2">&quot;consumerKey2&quot;</span><span class="o">:</span> <span class="s2">&quot;key2Secret&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;tokens&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;token1&quot;</span><span class="o">:</span> <span class="s2">&quot;token1Secret&quot;</span><span class="p">,</span>
            <span class="s2">&quot;token2&quot;</span><span class="o">:</span> <span class="s2">&quot;token2Secret&quot;</span>
       <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="oauth-configuration">
<span id="config-oauth"></span><h4>OAuth Configuration<a class="headerlink" href="#oauth-configuration" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="oauth_*">
<tt class="descname">[oauth_*]</tt><a class="headerlink" href="#oauth_*" title="Permalink to this definition">¶</a></dt>
<dd><p>To let users be authenticated by <a class="reference internal" href="contents.html#api-auth-oauth"><em>OAuth Authentication</em></a> (<span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc5849.html"><strong>RFC 5849</strong></a>), three
special sections must be set up in the <a class="reference internal" href="contents.html#config"><em>configuration</em></a> file:</p>
<ol class="arabic simple">
<li>The Consumer secret:</li>
</ol>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[oauth_consumer_secrets]</span>
<span class="na">consumer1</span> <span class="o">=</span> <span class="s">sekr1t</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Token secrets:</li>
</ol>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[oauth_token_secrets]</span>
<span class="na">token1</span> <span class="o">=</span> <span class="s">tokensekr1t</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>A mapping from tokens to users:</li>
</ol>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[oauth_token_users]</span>
<span class="na">token1</span> <span class="o">=</span> <span class="s">couchdb_username</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
<span id="document-config/compaction"></span><div class="section" id="compaction-configuration">
<h3>Compaction Configuration<a class="headerlink" href="#compaction-configuration" title="Permalink to this headline">¶</a></h3>
<div class="section" id="database-compaction-options">
<span id="conifg-database-compaction"></span><h4>Database Compaction Options<a class="headerlink" href="#database-compaction-options" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="database_compaction">
<tt class="descname">[database_compaction]</tt><a class="headerlink" href="#database_compaction" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="database_compaction/doc_buffer_size">
<tt class="descname">doc_buffer_size</tt><a class="headerlink" href="#database_compaction/doc_buffer_size" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies the copy buffer&#8217;s maximum size in bytes:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[database_compaction]</span>
<span class="na">doc_buffer_size</span> <span class="o">=</span> <span class="s">524288</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="database_compaction/checkpoint_after">
<tt class="descname">checkpoint_after</tt><a class="headerlink" href="#database_compaction/checkpoint_after" title="Permalink to this definition">¶</a></dt>
<dd><p>Triggers a checkpoint after the specified amount of bytes were successfully
copied to the compacted database:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[database_compaction]</span>
<span class="na">checkpoint_after</span> <span class="o">=</span> <span class="s">5242880</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="compaction-daemon-rules">
<span id="config-compactions"></span><h4>Compaction Daemon Rules<a class="headerlink" href="#compaction-daemon-rules" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="compactions">
<tt class="descname">[compactions]</tt><a class="headerlink" href="#compactions" title="Permalink to this definition">¶</a></dt>
<dd><p>A list of rules to determine when to run automatic compaction. The
<a class="reference internal" href="contents.html#daemons/compaction_daemon" title="compaction_daemon"><tt class="xref config config-option docutils literal"><span class="pre">daemons/compaction_daemon</span></tt></a> compacts databases and their respective
view groups when all the condition parameters are satisfied. Configuration
can be per-database or global, and it has the following format:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[compactions]</span>
<span class="na">database_name</span> <span class="o">=</span> <span class="s">[ {ParamName, ParamValue}, {ParamName, ParamValue}, ... ]</span>
<span class="na">_default</span> <span class="o">=</span> <span class="s">[ {ParamName, ParamValue}, {ParamName, ParamValue}, ... ]</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[compactions]</span>
<span class="na">_default</span> <span class="o">=</span> <span class="s">[{db_fragmentation, &quot;70%&quot;}, {view_fragmentation, &quot;60%&quot;}, {from, &quot;23:00&quot;}, {to, &quot;04:00&quot;}]</span>
</pre></div>
</div>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">db_fragmentation</span></tt>: If the ratio of legacy data, including metadata, to
current data in the database file size is equal to or greater than this
value, this condition is satisfied. The percentage is expressed as an
integer percentage. This value is computed as:</p>
<div class="highlight-ini"><div class="highlight"><pre>(file_size - data_size) / file_size * 100
</pre></div>
</div>
<p>The data_size and file_size values can be obtained when
querying <a class="reference internal" href="contents.html#get--db" title="GET /{db}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}</span></tt></a>.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">view_fragmentation</span></tt>: If the ratio of legacy data, including metadata, to
current data in a view index file size is equal to or greater then this
value, this database compaction condition is satisfied. The percentage is
expressed as an integer percentage. This value is computed as:</p>
<div class="highlight-ini"><div class="highlight"><pre>(file_size - data_size) / file_size * 100
</pre></div>
</div>
<p>The data_size and file_size values can be obtained when querying a
<a class="reference internal" href="contents.html#api-ddoc-info"><em>view group&#8217;s information URI</em></a>.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">from</span></tt> and <tt class="docutils literal"><span class="pre">to</span></tt>: The period for which a database (and its view group)
compaction is allowed. The value for these parameters must obey the format:</p>
<div class="highlight-ini"><div class="highlight"><pre>HH:MM - HH:MM  (HH in [0..23], MM in [0..59])
</pre></div>
</div>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">strict_window</span></tt>: If a compaction is still running after the end of the
allowed period, it will be canceled if this parameter is set to <cite>true</cite>.
It defaults to <cite>false</cite> and is meaningful only if the <em>period</em> parameter is
also specified.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">parallel_view_compaction</span></tt>: If set to <cite>true</cite>, the database and its views
are compacted in parallel. This is only useful on certain setups, like
for example when the database and view index directories point to different
disks. It defaults to <cite>false</cite>.</p>
</li>
</ul>
<p>Before a compaction is triggered, an estimation of how much free disk space is
needed is computed. This estimation corresponds to two times the data size of
the database or view index. When there&#8217;s not enough free disk space to compact
a particular database or view index, a warning message is logged.</p>
<p>Examples:</p>
<ol class="arabic">
<li><p class="first"><tt class="docutils literal"><span class="pre">[{db_fragmentation,</span> <span class="pre">&quot;70%&quot;},</span> <span class="pre">{view_fragmentation,</span> <span class="pre">&quot;60%&quot;}]</span></tt></p>
<p>The <cite>foo</cite> database is compacted if its fragmentation is 70% or more.
Any view index of this database is compacted only if its fragmentation
is 60% or more.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">[{db_fragmentation,</span> <span class="pre">&quot;70%&quot;},</span> <span class="pre">{view_fragmentation,</span> <span class="pre">&quot;60%&quot;},</span> <span class="pre">{from,</span> <span class="pre">&quot;00:00&quot;},</span> <span class="pre">{to,</span> <span class="pre">&quot;04:00&quot;}]</span></tt></p>
<p>Similar to the preceding example but a compaction (database or view index)
is only triggered if the current time is between midnight and 4 AM.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">[{db_fragmentation,</span> <span class="pre">&quot;70%&quot;},</span> <span class="pre">{view_fragmentation,</span> <span class="pre">&quot;60%&quot;},</span> <span class="pre">{from,</span> <span class="pre">&quot;00:00&quot;},</span> <span class="pre">{to,</span> <span class="pre">&quot;04:00&quot;},</span> <span class="pre">{strict_window,</span> <span class="pre">true}]</span></tt></p>
<p>Similar to the preceding example - a compaction (database or view index)
is only triggered if the current time is between midnight and 4 AM. If at
4 AM the database or one of its views is still compacting, the compaction
process will be canceled.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">[{db_fragmentation,</span> <span class="pre">&quot;70%&quot;},</span> <span class="pre">{view_fragmentation,</span> <span class="pre">&quot;60%&quot;},</span> <span class="pre">{from,</span> <span class="pre">&quot;00:00&quot;},</span> <span class="pre">{to,</span> <span class="pre">&quot;04:00&quot;},</span> <span class="pre">{strict_window,</span> <span class="pre">true},</span> <span class="pre">{parallel_view_compaction,</span> <span class="pre">true}]</span></tt></p>
<p>Similar to the preceding example, but a database and its views can be
compacted in parallel.</p>
</li>
</ol>
</dd></dl>

</div>
<div class="section" id="configuration-of-compaction-daemon">
<span id="config-compaction-daemon"></span><h4>Configuration of Compaction Daemon<a class="headerlink" href="#configuration-of-compaction-daemon" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="compaction_daemon">
<tt class="descname">[compaction_daemon]</tt><a class="headerlink" href="#compaction_daemon" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="compaction_daemon/check_interval">
<tt class="descname">check_interval</tt><a class="headerlink" href="#compaction_daemon/check_interval" title="Permalink to this definition">¶</a></dt>
<dd><p>The delay, in seconds, between each check for which database and view
indexes need to be compacted:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[compaction_daemon]</span>
<span class="na">check_interval</span> <span class="o">=</span> <span class="s">300</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="compaction_daemon/min_file_size">
<tt class="descname">min_file_size</tt><a class="headerlink" href="#compaction_daemon/min_file_size" title="Permalink to this definition">¶</a></dt>
<dd><p>If a database or view index file is smaller than this value (in bytes),
compaction will not happen. Very small files always have high fragmentation,
so compacting them is inefficient.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[compaction_daemon]</span>
<span class="na">min_file_size</span> <span class="o">=</span> <span class="s">131072</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="views-compaction-options">
<span id="config-view-compaction"></span><h4>Views Compaction Options<a class="headerlink" href="#views-compaction-options" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="view_compaction">
<tt class="descname">[view_compaction]</tt><a class="headerlink" href="#view_compaction" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="view_compaction/keyvalue_buffer_size">
<tt class="descname">keyvalue_buffer_size</tt><a class="headerlink" href="#view_compaction/keyvalue_buffer_size" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies maximum copy buffer size in bytes used during compaction:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[view_compaction]</span>
<span class="na">keyvalue_buffer_size</span> <span class="o">=</span> <span class="s">2097152</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
</div>
<span id="document-config/logging"></span><div class="section" id="logging">
<h3>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h3>
<div class="section" id="logging-options">
<span id="config-log"></span><h4>Logging options<a class="headerlink" href="#logging-options" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="log">
<tt class="descname">[log]</tt><a class="headerlink" href="#log" title="Permalink to this definition">¶</a></dt>
<dd><p>CouchDB logging configuration.</p>
<dl class="option">
<dt id="log/file">
<tt class="descname">file</tt><a class="headerlink" href="#log/file" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies the location of file for logging output:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[log]</span>
<span class="na">file</span> <span class="o">=</span> <span class="s">/var/log/couchdb/couch.log</span>
</pre></div>
</div>
<p>This path should be readable and writable for user that runs CouchDB service
(<cite>couchdb</cite> by default).</p>
</dd></dl>

<dl class="option">
<dt id="log/level">
<tt class="descname">level</tt><a class="headerlink" href="#log/level" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.3:: </span>Added <tt class="docutils literal"><span class="pre">warning</span></tt> level.</p>
</div>
<p>Logging level defines how verbose and detailed logging will be:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[log]</span>
<span class="na">level</span> <span class="o">=</span> <span class="s">info</span>
</pre></div>
</div>
<p>Available levels:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">debug</span></tt>: Very informative and detailed debug logging. Includes HTTP
headers, external processes communications, authorization information and
more;</li>
<li><tt class="docutils literal"><span class="pre">info</span></tt>: Informative logging. Includes HTTP requests headlines, startup
of an external processes etc.</li>
<li><tt class="docutils literal"><span class="pre">warning</span></tt>: Warning messages are alerts about edge situations that may
lead to errors. For instance, compaction daemon alerts about low or
insufficient disk space at this level.</li>
<li><tt class="docutils literal"><span class="pre">error</span></tt>: Error level includes only things that going wrong, crush
reports and HTTP error responses (5xx codes).</li>
<li><tt class="docutils literal"><span class="pre">none</span></tt>: Disables logging any messages.</li>
</ul>
</dd></dl>

<dl class="option">
<dt id="log/include_sasl">
<tt class="descname">include_sasl</tt><a class="headerlink" href="#log/include_sasl" title="Permalink to this definition">¶</a></dt>
<dd><p>Includes <a class="reference external" href="http://www.erlang.org/doc/apps/sasl/">SASL</a> information in logs:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[log]</span>
<span class="na">include_sasl</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="per-module-logging">
<span id="config-log-level-by-module"></span><h4>Per module logging<a class="headerlink" href="#per-module-logging" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="log_level_by_module">
<tt class="descname">[log_level_by_module]</tt><a class="headerlink" href="#log_level_by_module" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>In this section you can specify <a class="reference internal" href="contents.html#log/level" title="level"><tt class="xref config config-option docutils literal"><span class="pre">log</span> <span class="pre">level</span></tt></a> on a
per-module basis:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[log_level_by_module]</span>
<span class="na">couch_httpd</span> <span class="o">=</span> <span class="s">debug</span>
<span class="na">couch_replicator</span> <span class="o">=</span> <span class="s">info</span>
<span class="na">couch_query_servers</span> <span class="o">=</span> <span class="s">error</span>
</pre></div>
</div>
<p>See <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=tree;f=src;hb=HEAD">src/*/*.erl</a> for available modules.</p>
</dd></dl>

</div>
</div>
<span id="document-config/replicator"></span><div class="section" id="replicator">
<h3>Replicator<a class="headerlink" href="#replicator" title="Permalink to this headline">¶</a></h3>
<div class="section" id="replicator-database-configuration">
<span id="config-replicator"></span><h4>Replicator Database Configuration<a class="headerlink" href="#replicator-database-configuration" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="replicator">
<tt class="descname">[replicator]</tt><a class="headerlink" href="#replicator" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.2.</span></p>
</div>
<dl class="option">
<dt id="replicator/db">
<tt class="descname">db</tt><a class="headerlink" href="#replicator/db" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies replicator database name:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">db</span> <span class="o">=</span> <span class="s">_replicator</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/max_replication_retry_count">
<tt class="descname">max_replication_retry_count</tt><a class="headerlink" href="#replicator/max_replication_retry_count" title="Permalink to this definition">¶</a></dt>
<dd><p>Maximum replication retry count can be a non-negative integer or &#8220;infinity&#8221;</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">max_replication_retry_count</span> <span class="o">=</span> <span class="s">10</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/worker_batch_size">
<tt class="descname">worker_batch_size</tt><a class="headerlink" href="#replicator/worker_batch_size" title="Permalink to this definition">¶</a></dt>
<dd><p>With lower batch sizes checkpoints are done more frequently. Lower batch
sizes also reduce the total amount of used RAM memory:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">worker_batch_size</span> <span class="o">=</span> <span class="s">500</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/worker_processes">
<tt class="descname">worker_processes</tt><a class="headerlink" href="#replicator/worker_processes" title="Permalink to this definition">¶</a></dt>
<dd><p>More worker processes can give higher network throughput but can also imply
more disk and network IO:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">worker_processes</span> <span class="o">=</span> <span class="s">4</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/http_connections">
<tt class="descname">http_connections</tt><a class="headerlink" href="#replicator/http_connections" title="Permalink to this definition">¶</a></dt>
<dd><p>Maximum number of HTTP connections per replication:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">http_connections</span> <span class="o">=</span> <span class="s">20</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/connection_timeout">
<tt class="descname">connection_timeout</tt><a class="headerlink" href="#replicator/connection_timeout" title="Permalink to this definition">¶</a></dt>
<dd><p>HTTP connection timeout per replication.
Even for very fast/reliable networks it might need to be increased if
a remote database is too busy:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">connection_timeout</span> <span class="o">=</span> <span class="s">30000</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/retries_per_request">
<tt class="descname">retries_per_request</tt><a class="headerlink" href="#replicator/retries_per_request" title="Permalink to this definition">¶</a></dt>
<dd><p>If a request fails, the replicator will retry it up to N times:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">retries_per_request</span> <span class="o">=</span> <span class="s">10</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/socket_options">
<tt class="descname">socket_options</tt><a class="headerlink" href="#replicator/socket_options" title="Permalink to this definition">¶</a></dt>
<dd><p>Some socket options that might boost performance in some scenarios:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">{nodelay,</span> <span class="pre">boolean()}</span></tt></li>
<li><tt class="docutils literal"><span class="pre">{sndbuf,</span> <span class="pre">integer()}</span></tt></li>
<li><tt class="docutils literal"><span class="pre">{recbuf,</span> <span class="pre">integer()}</span></tt></li>
<li><tt class="docutils literal"><span class="pre">{priority,</span> <span class="pre">integer()}</span></tt></li>
</ul>
<p>See the <a class="reference external" href="http://www.erlang.org/doc/man/inet.html#setopts-2">inet</a> Erlang module&#8217;s man page for the full list of options:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">socket_options</span> <span class="o">=</span> <span class="s">[{keepalive, true}, {nodelay, false}]</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/checkpoint_interval">
<tt class="descname">checkpoint_interval</tt><a class="headerlink" href="#replicator/checkpoint_interval" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>Defines replication checkpoint interval in milliseconds. <a class="reference internal" href="contents.html#replicator"><em>Replicator</em></a> will <a class="reference internal" href="contents.html#get--db" title="GET /{db}"><tt class="xref http http-get docutils literal"><span class="pre">requests</span></tt></a> from the Source database at
the specified interval:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">checkpoint_interval</span> <span class="o">=</span> <span class="s">5000</span>
</pre></div>
</div>
<p>Lower intervals may be useful for frequently changing data, while higher
values will lower bandwidth and make fewer requests for infrequently
updated databases.</p>
</dd></dl>

<dl class="option">
<dt id="replicator/use_checkpoints">
<tt class="descname">use_checkpoints</tt><a class="headerlink" href="#replicator/use_checkpoints" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>If <tt class="docutils literal"><span class="pre">use_checkpoints</span></tt> is set to <tt class="docutils literal"><span class="pre">true</span></tt>, CouchDB will make checkpoints
during replication and at the completion of replication. CouchDB can
efficiently resume replication from any of these checkpoints:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">use_checkpoints</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Checkpoints are stored in <a class="reference internal" href="contents.html#api-local"><em>local documents</em></a>
on both the source and target databases (which requires write access).</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Disabling checkpoints is <strong>not recommended</strong> as CouchDB
will scan the Source database&#8217;s changes feed from the beginning.</p>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/cert_file">
<tt class="descname">cert_file</tt><a class="headerlink" href="#replicator/cert_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Path to a file containing the user&#8217;s certificate:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">cert_file</span> <span class="o">=</span> <span class="s">/full/path/to/server_cert.pem</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/key_file">
<tt class="descname">key_file</tt><a class="headerlink" href="#replicator/key_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Path to file containing user&#8217;s private PEM encoded key:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">key_file</span> <span class="o">=</span> <span class="s">/full/path/to/server_key.pem</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/password">
<tt class="descname">password</tt><a class="headerlink" href="#replicator/password" title="Permalink to this definition">¶</a></dt>
<dd><p>String containing the user&#8217;s password. Only used if the private keyfile is
password protected:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">password</span> <span class="o">=</span> <span class="s">somepassword</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/verify_ssl_certificates">
<tt class="descname">verify_ssl_certificates</tt><a class="headerlink" href="#replicator/verify_ssl_certificates" title="Permalink to this definition">¶</a></dt>
<dd><p>Set to true to validate peer certificates:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">verify_ssl_certificates</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/ssl_trusted_certificates_file">
<tt class="descname">ssl_trusted_certificates_file</tt><a class="headerlink" href="#replicator/ssl_trusted_certificates_file" title="Permalink to this definition">¶</a></dt>
<dd><p>File containing a list of peer trusted certificates (in the PEM format):</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">ssl_trusted_certificates_file</span> <span class="o">=</span> <span class="s">/etc/ssl/certs/ca-certificates.crt</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="replicator/ssl_certificate_max_depth">
<tt class="descname">ssl_certificate_max_depth</tt><a class="headerlink" href="#replicator/ssl_certificate_max_depth" title="Permalink to this definition">¶</a></dt>
<dd><p>Maximum peer certificate depth (must be set even if certificate validation
is off):</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[replicator]</span>
<span class="na">ssl_certificate_max_depth</span> <span class="o">=</span> <span class="s">3</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
</div>
<span id="document-config/query-servers"></span><div class="section" id="query-servers">
<h3>Query Servers<a class="headerlink" href="#query-servers" title="Permalink to this headline">¶</a></h3>
<div class="section" id="query-servers-definition">
<span id="config-query-servers"></span><h4>Query Servers Definition<a class="headerlink" href="#query-servers-definition" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="query_servers">
<tt class="descname">[query_servers]</tt><a class="headerlink" href="#query_servers" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.2:: </span>Added CoffeeScript query server</p>
</div>
<p>CouchDB delegates computation of <a class="reference internal" href="contents.html#ddocs"><em>design documents</em></a> functions to
external query servers. The external query server is a special OS process which
communicates with CouchDB over standard input/output using a very simple
line-based protocol with JSON messages.</p>
<p>The external query server may be defined in configuration file following next
pattern:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[query_servers]</span>
<span class="na">LANGUAGE</span> <span class="o">=</span> <span class="s">PATH ARGS</span>
</pre></div>
</div>
<p>Where:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">LANGUAGE</span></tt>: is a programming language which code this query server may
execute. For instance, there are <cite>python</cite>, <cite>ruby</cite>, <cite>clojure</cite> and other query
servers in wild. This value is also used for <cite>ddoc</cite> field <tt class="docutils literal"><span class="pre">language</span></tt>
to determine which query server processes the functions.</p>
<p>Note, that you may setup multiple query servers for the same programming
language, but you have to name them different (like <cite>python-dev</cite> etc.).</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">PATH</span></tt>: is a system path to the executable binary program that runs the
query server.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">ARGS</span></tt>: optionally, you may specify additional command line arguments for
the executable <tt class="docutils literal"><span class="pre">PATH</span></tt>.</p>
</li>
</ul>
<p>The default query server is written in <a class="reference internal" href="contents.html#query-server-js"><em>JavaScript</em></a>,
running via <a class="reference external" href="https://developer.mozilla.org/en/docs/SpiderMonkey">Mozilla SpiderMonkey</a>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[query_servers]</span>
<span class="na">javascript</span> <span class="o">=</span> <span class="s">/usr/bin/couchjs /usr/share/couchdb/server/main.js</span>
<span class="na">coffeescript</span> <span class="o">=</span> <span class="s">/usr/bin/couchjs /usr/share/couchdb/server/main-coffee.js</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#config-native-query-servers"><em>Native Erlang Query Server</em></a> that allows
to process Erlang <cite>ddocs</cite> and runs within CouchDB bypassing stdio
communication and JSON serialization/deserialization round trip overhead.</p>
</div>
</dd></dl>

</div>
<div class="section" id="query-servers-configuration">
<span id="config-query-server-config"></span><h4>Query Servers Configuration<a class="headerlink" href="#query-servers-configuration" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="query_server_config">
<tt class="descname">[query_server_config]</tt><a class="headerlink" href="#query_server_config" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="query_server_config/commit_freq">
<tt class="descname">commit_freq</tt><a class="headerlink" href="#query_server_config/commit_freq" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies the delay in seconds before view index changes are committed to disk.
The default value is <tt class="docutils literal"><span class="pre">5</span></tt>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[query_server_config]</span>
<span class="na">commit_freq</span> <span class="o">=</span> <span class="s">5</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="query_server_config/os_process_limit">
<tt class="descname">os_process_limit</tt><a class="headerlink" href="#query_server_config/os_process_limit" title="Permalink to this definition">¶</a></dt>
<dd><p>Amount of time in seconds that the Query Server may process CouchDB command:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[query_server_config]</span>
<span class="na">os_process_limit</span> <span class="o">=</span> <span class="s">10</span>
</pre></div>
</div>
<p>CouchDB will raise <cite>os_process_timeout</cite> error and kill the process in case the
Query Server doesn&#8217;t return any result within this limit.</p>
</dd></dl>

<dl class="option">
<dt id="query_server_config/reduce_limit">
<tt class="descname">reduce_limit</tt><a class="headerlink" href="#query_server_config/reduce_limit" title="Permalink to this definition">¶</a></dt>
<dd><p>Controls <cite>Reduce overflow</cite> error that raises when output of
<a class="reference internal" href="contents.html#reducefun"><em>reduce functions</em></a> is too big:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[query_server_config]</span>
<span class="na">reduce_limit</span> <span class="o">=</span> <span class="s">true</span>
</pre></div>
</div>
<p>Normally, you don&#8217;t have to disable (by setting <tt class="docutils literal"><span class="pre">false</span></tt> value) this option
since main propose of <cite>reduce</cite> functions is to <em>reduce</em> the input.</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="native-erlang-query-server">
<span id="config-native-query-servers"></span><h4>Native Erlang Query Server<a class="headerlink" href="#native-erlang-query-server" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="native_query_servers">
<tt class="descname">[native_query_servers]</tt><a class="headerlink" href="#native_query_servers" title="Permalink to this definition">¶</a></dt>
<dd><div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Due to security restrictions, the Erlang query server is disabled by
default.</p>
<p class="last">Unlike the JavaScript query server, the Erlang one does not runs in a sandbox
mode. This means that Erlang code has full access to your OS,
filesystem and network, which may lead to security issues. While Erlang
functions are faster than JavaScript ones, you need to be careful
about running them, especially if they were written by someone else.</p>
</div>
<p>CouchDB has a native Erlang query server, allowing you to write your map/reduce
functions in Erlang.</p>
<p>First, you&#8217;ll need to edit your <cite>local.ini</cite> to include a
<tt class="docutils literal"><span class="pre">[native_query_servers]</span></tt> section:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[native_query_servers]</span>
<span class="na">erlang</span> <span class="o">=</span> <span class="s">{couch_native_process, start_link, []}</span>
</pre></div>
</div>
<p>To see these changes you will also need to restart the server.
To test out using <a class="reference internal" href="contents.html#query-server-erlang"><em>Erlang views</em></a>, visit the
<cite>Futon</cite> admin interface, create a new database and open a temporary view.
You should now be able to select <tt class="docutils literal"><span class="pre">erlang</span></tt> from the language drop-down.</p>
<p>Let&#8217;s try an example of map/reduce functions which count the total documents at
each number of revisions (there are x many documents at version &#8220;1&#8221;, and y
documents at &#8220;2&#8221;... etc). Add a few documents to the database, then enter the
following functions as a temporary view:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="c">%% Map Function</span>
<span class="k">fun</span><span class="p">({</span><span class="nv">Doc</span><span class="p">})</span> <span class="o">-&gt;</span>
  <span class="o">&lt;&lt;</span><span class="nv">K</span><span class="p">,_</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nn">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;_rev&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Doc</span><span class="p">,</span> <span class="n">null</span><span class="p">),</span>
  <span class="nv">V</span> <span class="o">=</span> <span class="nn">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;_id&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Doc</span><span class="p">,</span> <span class="n">null</span><span class="p">),</span>
  <span class="nv">Emit</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">K</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">V</span><span class="p">)</span>
<span class="k">end</span><span class="p">.</span>

<span class="c">%% Reduce Function</span>
<span class="k">fun</span><span class="p">(</span><span class="nv">Keys</span><span class="p">,</span> <span class="nv">Values</span><span class="p">,</span> <span class="nv">ReReduce</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">length</span><span class="p">(</span><span class="nv">Values</span><span class="p">)</span> <span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>If all has gone well, after running the view you should see a list of the total
number of documents at each revision number.</p>
</dd></dl>

</div>
</div>
<span id="document-config/externals"></span><div class="section" id="external-processes">
<h3>External Processes<a class="headerlink" href="#external-processes" title="Permalink to this headline">¶</a></h3>
<div class="section" id="os-daemons">
<span id="config-os-daemons"></span><h4>OS Daemons<a class="headerlink" href="#os-daemons" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="os_daemons">
<tt class="descname">[os_daemons]</tt><a class="headerlink" href="#os_daemons" title="Permalink to this definition">¶</a></dt>
<dd><p>This is a simple feature that allows users to configure CouchDB so that it
maintains a given OS level process alive. If the process dies for any reason,
CouchDB will restart it. If the process restarts too often, then CouchDB will
mark it has halted and not attempt to restart it. The default max restart rate
is <tt class="docutils literal"><span class="pre">3</span></tt> times in the last <tt class="docutils literal"><span class="pre">5</span></tt> seconds. These parameters are
<a class="reference internal" href="contents.html#os_daemon_settings" title="[os_daemon_settings]"><tt class="xref config config-section docutils literal"><span class="pre">adjustable</span></tt></a>.</p>
<p>Commands that are started in this manner will have access to a simple
API over stdio to request configuration parameters or to add log
statements to CouchDB&#8217;s logs.</p>
<p>To configure an OS process as a CouchDB os_daemon, create a section
in your <cite>local.ini</cite> like such:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[os_daemons]</span>
<span class="na">daemon_name</span> <span class="o">=</span> <span class="s">/path/to/command -with args</span>
</pre></div>
</div>
<p>This will make CouchDB bring up the command and attempt to keep it
alive. To request a configuration parameter, an <cite>os_daemon</cite> can write
a simple JSON message to stdout like such:</p>
<div class="highlight-ini"><div class="highlight"><pre>[&quot;get&quot;, &quot;os_daemons&quot;]\n
</pre></div>
</div>
<p>which would return:</p>
<div class="highlight-ini"><div class="highlight"><pre>{&quot;daemon_name&quot;: &quot;/path/to/command -with args&quot;}\n
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-ini"><div class="highlight"><pre>[&quot;get&quot;, &quot;os_daemons&quot;, &quot;daemon_name&quot;]\n
</pre></div>
</div>
<p>which would return:</p>
<div class="highlight-ini"><div class="highlight"><pre>&quot;/path/to/command -with args&quot;\n
</pre></div>
</div>
<p>There&#8217;s no restriction on what configuration variables are visible.
There&#8217;s also no method for altering the configuration.</p>
<p>If you would like your OS daemon to be restarted in the event that
the configuration changes, you can send the following messages:</p>
<div class="highlight-ini"><div class="highlight"><pre>[&quot;register&quot;, $(SECTION)]\n
</pre></div>
</div>
<p>When anything in that section changes, your OS process will be
rebooted so it can pick up the new configuration settings. If you
want to listen for changes on a specific key, you can send something
like:</p>
<div class="highlight-ini"><div class="highlight"><pre>[&quot;register&quot;, $(SECTION), $(KEY)]\n
</pre></div>
</div>
<p>In this case, CouchDB will only restart your daemon if that exact
section/key pair changes, instead of anything in that entire section.</p>
<p>Logging commands look like:</p>
<div class="highlight-ini"><div class="highlight"><pre>[&quot;log&quot;, $(JSON_MESSAGE)]\n
</pre></div>
</div>
<p>Where <tt class="docutils literal"><span class="pre">$(JSON_MESSAGE)</span></tt> is arbitrary JSON data. These messages are
logged at the &#8216;info&#8217; level. If you want to log at a different level
you can pass messages like such:</p>
<div class="highlight-ini"><div class="highlight"><pre>[&quot;log&quot;, $(JSON_MESSAGE), {&quot;level&quot;: $(LEVEL)}]\n
</pre></div>
</div>
<p>Where <tt class="docutils literal"><span class="pre">$(LEVEL)</span></tt> is one of &#8220;debug&#8221;, &#8220;info&#8221;, or &#8220;error&#8221;.</p>
<p>When implementing a daemon process to be managed by CouchDB you
should remember to use a method like checking the parent process
id or if stdin has been closed. These flags can tell you if
your daemon process has been orphaned so you can exit cleanly.</p>
<p>There is no interactivity between CouchDB and the running process, but
you can use the OS Daemons service to create new HTTP servers and
responders and then use the new proxy service to redirect requests and
output to the CouchDB managed service. For more information on proxying,
see <a class="reference internal" href="contents.html#http-proxying"><em>CouchDB As Proxy</em></a>. For further background on the OS Daemon service,
see <a class="reference internal" href="contents.html#externals"><em>CouchDB Externals API</em></a>.</p>
</dd></dl>

</div>
<div class="section" id="os-daemons-settings">
<span id="config-os-daemon-settings"></span><h4>OS Daemons settings<a class="headerlink" href="#os-daemons-settings" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="os_daemon_settings">
<tt class="descname">[os_daemon_settings]</tt><a class="headerlink" href="#os_daemon_settings" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="os_daemon_settings/max_retries">
<tt class="descname">max_retries</tt><a class="headerlink" href="#os_daemon_settings/max_retries" title="Permalink to this definition">¶</a></dt>
<dd><p>Specifies maximum attempts to run <a class="reference internal" href="contents.html#os_daemons" title="[os_daemons]"><tt class="xref config config-section docutils literal"><span class="pre">os_daemons</span></tt></a> before
mark them halted:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[os_daemon_settings]</span>
<span class="na">max_retries</span> <span class="o">=</span> <span class="s">3</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="os_daemon_settings/retry_time">
<tt class="descname">retry_time</tt><a class="headerlink" href="#os_daemon_settings/retry_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Delay in seconds between <a class="reference internal" href="contents.html#os_daemons" title="[os_daemons]"><tt class="xref config config-section docutils literal"><span class="pre">os_daemons</span></tt></a> restarts:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[os_daemon_settings]</span>
<span class="na">retry_time</span> <span class="o">=</span> <span class="s">5</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="config-update-notification">
<span id="update-notifications"></span><span id="id1"></span><h4>Update notifications<a class="headerlink" href="#config-update-notification" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="update_notification">
<tt class="descname">[update_notification]</tt><a class="headerlink" href="#update_notification" title="Permalink to this definition">¶</a></dt>
<dd><p>CouchDB is able to spawn OS processes to notify them about recent databases
updates. The notifications are in form of JSON messages sent as a line of
text, terminated by <tt class="docutils literal"><span class="pre">CR</span></tt> (<tt class="docutils literal"><span class="pre">\n</span></tt>) character, to the OS processes through
<cite>stdout</cite>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[update_notification]</span>
<span class="c1">;unique notifier name=/full/path/to/exe -with &quot;cmd line arg&quot;</span>
<span class="na">index_updater</span> <span class="o">=</span> <span class="s">ruby /usr/local/bin/index_updater.rb</span>
</pre></div>
</div>
<p>The update notification messages are depend upon of event type:</p>
<ul>
<li><p class="first"><strong>Database created</strong>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;created&quot;</span><span class="p">,</span><span class="s2">&quot;db&quot;</span><span class="o">:</span><span class="s2">&quot;dbname&quot;</span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>Database updated</strong>:  this event raises when any document gets updated for
specified database:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span><span class="s2">&quot;db&quot;</span><span class="o">:</span><span class="s2">&quot;dbname&quot;</span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>Design document updated</strong>: for design document updates there is special
event raised in additional to regular db update one:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;ddoc_updated&quot;</span><span class="p">,</span><span class="s2">&quot;db&quot;</span><span class="o">:</span><span class="s2">&quot;dbname&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;_design/ddoc_name&quot;</span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>Database deleted</strong>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="s2">&quot;deleted&quot;</span><span class="p">,</span><span class="s2">&quot;db&quot;</span><span class="o">:</span><span class="s2">&quot;dbname&quot;</span><span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">New line (<tt class="docutils literal"><span class="pre">\n</span></tt>) trailing character was removed from examples.</p>
</div>
</dd></dl>

</div>
</div>
<span id="document-config/http-handlers"></span><div class="section" id="http-resource-handlers">
<h3>HTTP Resource Handlers<a class="headerlink" href="#http-resource-handlers" title="Permalink to this headline">¶</a></h3>
<div class="section" id="global-http-handlers">
<span id="config-httpd-global-handlers"></span><h4>Global HTTP Handlers<a class="headerlink" href="#global-http-handlers" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="httpd_global_handlers">
<tt class="descname">[httpd_global_handlers]</tt><a class="headerlink" href="#httpd_global_handlers" title="Permalink to this definition">¶</a></dt>
<dd><p>These HTTP resources are provided for CouchDB server root level.</p>
<dl class="option">
<dt id="httpd_global_handlers//">
<tt class="descname">/</tt><a class="headerlink" href="#httpd_global_handlers//" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">/</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_welcome_req, &lt;&lt;&quot;Welcome&quot;&gt;&gt;}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/favicon.ico">
<tt class="descname">favicon.ico</tt><a class="headerlink" href="#httpd_global_handlers/favicon.ico" title="Permalink to this definition">¶</a></dt>
<dd><p>The favicon handler looks for <cite>favicon.ico</cite> file within specified directory:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">favicon.ico</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_favicon_req, &quot;/usr/share/couchdb/www&quot;}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/_active_tasks">
<tt class="descname">_active_tasks</tt><a class="headerlink" href="#httpd_global_handlers/_active_tasks" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_active_tasks</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_task_status_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/_all_dbs">
<tt class="descname">_all_dbs</tt><a class="headerlink" href="#httpd_global_handlers/_all_dbs" title="Permalink to this definition">¶</a></dt>
<dd><p>Provides a list of all server&#8217;s databases:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_all_dbs</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_all_dbs_req}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Sometimes you don&#8217;t want to disclose database names for everyone, but
you also don&#8217;t like/want/able to setup any proxies in front of CouchDB.
Removing this handler disables <tt class="docutils literal"><span class="pre">_all_dbs</span></tt> resource and there will be
no way to get list of available databases.</p>
<p class="last">The same also is true for other resource handlers.</p>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/_config">
<tt class="descname">_config</tt><a class="headerlink" href="#httpd_global_handlers/_config" title="Permalink to this definition">¶</a></dt>
<dd><p>Provides resource to work with CouchDB config <a class="reference internal" href="contents.html#api-config"><em>remotely</em></a>.
Any config changes that was made via HTTP API are applied automatically on
fly and doesn&#8217;t requires server instance to be restarted:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_config</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_config_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/_log">
<tt class="descname">_log</tt><a class="headerlink" href="#httpd_global_handlers/_log" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_log</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_log_req}</span>
</pre></div>
</div>
<dl class="option">
<dt id="httpd_global_handlers/_oauth">
<tt class="descname">_oauth</tt><a class="headerlink" href="#httpd_global_handlers/_oauth" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_oauth</span> <span class="o">=</span> <span class="s">{couch_httpd_oauth, handle_oauth_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/_replicate">
<tt class="descname">_replicate</tt><a class="headerlink" href="#httpd_global_handlers/_replicate" title="Permalink to this definition">¶</a></dt>
<dd><p>Provides an API to run <a class="reference internal" href="contents.html#api-server-replicate"><em>temporary replications</em></a>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_replicate</span> <span class="o">=</span> <span class="s">{couch_replicator_httpd, handle_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/_restart">
<tt class="descname">_restart</tt><a class="headerlink" href="#httpd_global_handlers/_restart" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_restart</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_restart_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/_session">
<tt class="descname">_session</tt><a class="headerlink" href="#httpd_global_handlers/_session" title="Permalink to this definition">¶</a></dt>
<dd><p>Provides a resource with information about the current user&#8217;s session:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_session</span> <span class="o">=</span> <span class="s">{couch_httpd_auth, handle_session_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/_stats">
<tt class="descname">_stats</tt><a class="headerlink" href="#httpd_global_handlers/_stats" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_stats</span> <span class="o">=</span> <span class="s">{couch_httpd_stats_handlers, handle_stats_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/_utils">
<tt class="descname">_utils</tt><a class="headerlink" href="#httpd_global_handlers/_utils" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference internal" href="contents.html#api-server-utils"><em>_utils</em></a> handler serves <cite>Futon</cite>&#8216;s web administration
page:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_utils</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_utils_dir_req, &quot;/usr/share/couchdb/www&quot;}</span>
</pre></div>
</div>
<p>In similar way, you may setup custom handler to let CouchDB serve any static
files.</p>
</dd></dl>

<dl class="option">
<dt id="httpd_global_handlers/_uuids">
<tt class="descname">_uuids</tt><a class="headerlink" href="#httpd_global_handlers/_uuids" title="Permalink to this definition">¶</a></dt>
<dd><p>Provides a resource to get UUIDs generated by CouchDB:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_uuids</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_uuids_req}</span>
</pre></div>
</div>
<p>This is useful when your client environment isn&#8217;t capable of providing truly
random IDs (web browsers e.g.).</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="database-http-handlers">
<span id="config-httpd-db-handlers"></span><h4>Database HTTP Handlers<a class="headerlink" href="#database-http-handlers" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="httpd_db_handlers">
<tt class="descname">[httpd_db_handlers]</tt><a class="headerlink" href="#httpd_db_handlers" title="Permalink to this definition">¶</a></dt>
<dd><p>These HTTP resources are available on every CouchDB database.</p>
<dl class="option">
<dt id="httpd_db_handlers/_all_docs">
<tt class="descname">_all_docs</tt><a class="headerlink" href="#httpd_db_handlers/_all_docs" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_db_handlers]</span>
<span class="na">_all_docs</span> <span class="o">=</span> <span class="s">{couch_mrview_http, handle_all_docs_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_db_handlers/_changes">
<tt class="descname">_changes</tt><a class="headerlink" href="#httpd_db_handlers/_changes" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_db_handlers]</span>
<span class="na">_changes</span> <span class="o">=</span> <span class="s">{couch_httpd_db, handle_changes_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_db_handlers/_compact">
<tt class="descname">_compact</tt><a class="headerlink" href="#httpd_db_handlers/_compact" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_db_handlers]</span>
<span class="na">_compact</span> <span class="o">=</span> <span class="s">{couch_httpd_db, handle_compact_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_db_handlers/_design">
<tt class="descname">_design</tt><a class="headerlink" href="#httpd_db_handlers/_design" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_db_handlers]</span>
<span class="na">_design</span> <span class="o">=</span> <span class="s">{couch_httpd_db, handle_design_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_db_handlers/_temp_view">
<tt class="descname">_temp_view</tt><a class="headerlink" href="#httpd_db_handlers/_temp_view" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_db_handlers]</span>
<span class="na">_temp_view</span> <span class="o">=</span> <span class="s">{couch_mrview_http, handle_temp_view_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_db_handlers/_view_cleanup">
<tt class="descname">_view_cleanup</tt><a class="headerlink" href="#httpd_db_handlers/_view_cleanup" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_db_handlers]</span>
<span class="na">_view_cleanup</span> <span class="o">=</span> <span class="s">{couch_mrview_http, handle_cleanup_req}</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="design-documents-http-handlers">
<span id="config-httpd-design-handlers"></span><h4>Design Documents HTTP Handlers<a class="headerlink" href="#design-documents-http-handlers" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="httpd_design_handlers">
<tt class="descname">[httpd_design_handlers]</tt><a class="headerlink" href="#httpd_design_handlers" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>These HTTP resources are provided for design documents.</p>
<blockquote>
<div><dl class="option">
<dt id="httpd_design_handlers/_compact">
<tt class="descname">_compact</tt><a class="headerlink" href="#httpd_design_handlers/_compact" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_design_handlers]</span>
<span class="na">_compact</span> <span class="o">=</span> <span class="s">{couch_mrview_http, handle_compact_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_design_handlers/_info">
<tt class="descname">_info</tt><a class="headerlink" href="#httpd_design_handlers/_info" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_design_handlers]</span>
<span class="na">_info</span> <span class="o">=</span> <span class="s">{couch_mrview_http, handle_info_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_design_handlers/_list">
<tt class="descname">_list</tt><a class="headerlink" href="#httpd_design_handlers/_list" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_design_handlers]</span>
<span class="na">_list</span> <span class="o">=</span> <span class="s">{couch_mrview_show, handle_view_list_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_design_handlers/_rewrite">
<tt class="descname">_rewrite</tt><a class="headerlink" href="#httpd_design_handlers/_rewrite" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_design_handlers]</span>
<span class="na">_rewrite</span> <span class="o">=</span> <span class="s">{couch_httpd_rewrite, handle_rewrite_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_design_handlers/_show">
<tt class="descname">_show</tt><a class="headerlink" href="#httpd_design_handlers/_show" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_design_handlers]</span>
<span class="na">_show</span> <span class="o">=</span> <span class="s">{couch_mrview_show, handle_doc_show_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_design_handlers/_update">
<tt class="descname">_update</tt><a class="headerlink" href="#httpd_design_handlers/_update" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_design_handlers]</span>
<span class="na">_update</span> <span class="o">=</span> <span class="s">{couch_mrview_show, handle_doc_update_req}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="httpd_design_handlers/_view">
<tt class="descname">_view</tt><a class="headerlink" href="#httpd_design_handlers/_view" title="Permalink to this definition">¶</a></dt>
<dd><div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_design_handlers]</span>
<span class="na">_view</span> <span class="o">=</span> <span class="s">{couch_mrview_http, handle_view_req}</span>
</pre></div>
</div>
</dd></dl>

</div></blockquote>
</div>
</div>
<span id="document-config/services"></span><div class="section" id="couchdb-internal-services">
<h3>CouchDB Internal Services<a class="headerlink" href="#couchdb-internal-services" title="Permalink to this headline">¶</a></h3>
<div class="section" id="couchdb-daemonized-mini-apps">
<span id="config-daemons"></span><h4>CouchDB Daemonized Mini Apps<a class="headerlink" href="#couchdb-daemonized-mini-apps" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="daemons">
<tt class="descname">[daemons]</tt><a class="headerlink" href="#daemons" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="daemons/auth_cache">
<tt class="descname">auth_cache</tt><a class="headerlink" href="#daemons/auth_cache" title="Permalink to this definition">¶</a></dt>
<dd><p>This daemon provides authentication caching to avoid repeated opening and
closing of the <cite>_users</cite> database for each request requiring authentication:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">auth_cache</span><span class="o">=</span><span class="s">{couch_auth_cache, start_link, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/compaction_daemon">
<tt class="descname">compaction_daemon</tt><a class="headerlink" href="#daemons/compaction_daemon" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="contents.html#config-compactions"><em>Automatic compaction</em></a> daemon:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">compaction_daemon</span><span class="o">=</span><span class="s">{couch_compaction_daemon, start_link, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/external_manager">
<tt class="descname">external_manager</tt><a class="headerlink" href="#daemons/external_manager" title="Permalink to this definition">¶</a></dt>
<dd><p><cite>External</cite> processes manager:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">external_manager</span><span class="o">=</span><span class="s">{couch_external_manager, start_link, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/httpd">
<tt class="descname">httpd</tt><a class="headerlink" href="#daemons/httpd" title="Permalink to this definition">¶</a></dt>
<dd><p>HTTP server daemon:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">httpd</span><span class="o">=</span><span class="s">{couch_httpd, start_link, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/httpsd">
<tt class="descname">httpsd</tt><a class="headerlink" href="#daemons/httpsd" title="Permalink to this definition">¶</a></dt>
<dd><p>Provides <a class="reference internal" href="contents.html#config-ssl"><em>SSL support</em></a>. The default ssl port CouchDB
listens on is <cite>6984</cite>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">httpsd</span> <span class="o">=</span> <span class="s">{couch_httpd, start_link, [https]}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/index_server">
<tt class="descname">index_server</tt><a class="headerlink" href="#daemons/index_server" title="Permalink to this definition">¶</a></dt>
<dd><p>The <cite>couch_index</cite> application is responsible for managing all of the
different types of indexers. This manages the process handling for
keeping track of the index state as well as managing the updater and
compactor handling:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">index_server</span><span class="o">=</span><span class="s">{couch_index_server, start_link, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/os_daemons">
<tt class="descname">os_daemons</tt><a class="headerlink" href="#daemons/os_daemons" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="contents.html#config-os-daemons"><em>OS Daemons</em></a> manager:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">os_daemons</span><span class="o">=</span><span class="s">{couch_os_daemons, start_link, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/query_servers">
<tt class="descname">query_servers</tt><a class="headerlink" href="#daemons/query_servers" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="contents.html#config-query-servers"><em>Query servers</em></a> manager:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">query_servers</span><span class="o">=</span><span class="s">{couch_query_servers, start_link, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/replicator_manager">
<tt class="descname">replicator_manager</tt><a class="headerlink" href="#daemons/replicator_manager" title="Permalink to this definition">¶</a></dt>
<dd><p>Replications manager:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">replicator_manager</span><span class="o">=</span><span class="s">{couch_replicator_manager, start_link, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/stats_aggregator">
<tt class="descname">stats_aggregator</tt><a class="headerlink" href="#daemons/stats_aggregator" title="Permalink to this definition">¶</a></dt>
<dd><p>Runtime statistics aggregator:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">stats_aggregator</span><span class="o">=</span><span class="s">{couch_stats_aggregator, start, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/stats_collector">
<tt class="descname">stats_collector</tt><a class="headerlink" href="#daemons/stats_collector" title="Permalink to this definition">¶</a></dt>
<dd><p>Runtime statistics collector:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">stats_collector</span><span class="o">=</span><span class="s">{couch_stats_collector, start, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/uuids">
<tt class="descname">uuids</tt><a class="headerlink" href="#daemons/uuids" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="contents.html#config-uuids"><em>UUIDs</em></a> generator daemon:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">uuids</span><span class="o">=</span><span class="s">{couch_uuids, start, []}</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="daemons/vhosts">
<tt class="descname">vhosts</tt><a class="headerlink" href="#daemons/vhosts" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="contents.html#config-vhosts"><em>Virtual hosts</em></a> manager. Provides dynamic add of vhosts
without restart, wildcards support and dynamic routing via pattern matching</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[daemons]</span>
<span class="na">vhosts</span><span class="o">=</span><span class="s">{couch_httpd_vhost, start_link, []}</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
</div>
<span id="document-config/misc"></span><div class="section" id="miscellaneous-parameters">
<h3>Miscellaneous Parameters<a class="headerlink" href="#miscellaneous-parameters" title="Permalink to this headline">¶</a></h3>
<div class="section" id="configuration-of-attachment-storage">
<span id="config-attachments"></span><h4>Configuration of Attachment Storage<a class="headerlink" href="#configuration-of-attachment-storage" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="attachments">
<tt class="descname">[attachments]</tt><a class="headerlink" href="#attachments" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="attachments/compression_level">
<tt class="descname">compression_level</tt><a class="headerlink" href="#attachments/compression_level" title="Permalink to this definition">¶</a></dt>
<dd><p>Defines zlib compression level for the attachments from <tt class="docutils literal"><span class="pre">1</span></tt> (lowest,
fastest) to <tt class="docutils literal"><span class="pre">9</span></tt> (highest, slowest). A value of <tt class="docutils literal"><span class="pre">0</span></tt> disables compression</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[attachments]</span>
<span class="na">compression_level</span> <span class="o">=</span> <span class="s">8</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="attachments/compressible_types">
<tt class="descname">compressible_types</tt><a class="headerlink" href="#attachments/compressible_types" title="Permalink to this definition">¶</a></dt>
<dd><p>Since compression is ineffective for some types of files, it is possible
to let CouchDB compress only some types of attachments, specified by their
MIME type:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[attachments]</span>
<span class="na">compressible_types</span> <span class="o">=</span> <span class="s">text/*, application/javascript, application/json, application/xml</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="statistic-calculation">
<span id="config-stats"></span><h4>Statistic Calculation<a class="headerlink" href="#statistic-calculation" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="stats">
<tt class="descname">[stats]</tt><a class="headerlink" href="#stats" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="stats/rate">
<tt class="descname">rate</tt><a class="headerlink" href="#stats/rate" title="Permalink to this definition">¶</a></dt>
<dd><p>Rate of statistics gathering in milliseconds:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[stats]</span>
<span class="na">rate</span> <span class="o">=</span> <span class="s">1000</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="stats/samples">
<tt class="descname">samples</tt><a class="headerlink" href="#stats/samples" title="Permalink to this definition">¶</a></dt>
<dd><p>Samples are used to track the mean and standard value deviation within
specified intervals (in seconds):</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[stats]</span>
<span class="na">samples</span> <span class="o">=</span> <span class="s">[0, 60, 300, 900]</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="uuids-configuration">
<span id="config-uuids"></span><h4>UUIDs Configuration<a class="headerlink" href="#uuids-configuration" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="uuids">
<tt class="descname">[uuids]</tt><a class="headerlink" href="#uuids" title="Permalink to this definition">¶</a></dt>
<dd><dl class="option">
<dt id="uuids/algorithm">
<tt class="descname">algorithm</tt><a class="headerlink" href="#uuids/algorithm" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.3: </span>Added <tt class="docutils literal"><span class="pre">utc_id</span></tt> algorithm.</p>
</div>
<p>CouchDB provides various algorithms to generate the UUID values that are
used for document <cite>_id</cite>&#8216;s by default:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[uuids]</span>
<span class="na">algorithm</span> <span class="o">=</span> <span class="s">sequential</span>
</pre></div>
</div>
<p>Available algorithms:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">random</span></tt>: 128 bits of random awesome. All awesome, all the time:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;uuids&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;5fcbbf2cb171b1d5c3bc6df3d4affb32&quot;</span><span class="p">,</span>
    <span class="s2">&quot;9115e0942372a87a977f1caf30b2ac29&quot;</span><span class="p">,</span>
    <span class="s2">&quot;3840b51b0b81b46cab99384d5cd106e3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b848dbdeb422164babf2705ac18173e1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;b7a8566af7e0fc02404bb676b47c3bf7&quot;</span><span class="p">,</span>
    <span class="s2">&quot;a006879afdcae324d70e925c420c860d&quot;</span><span class="p">,</span>
    <span class="s2">&quot;5f7716ee487cc4083545d4ca02cd45d4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;35fdd1c8346c22ccc43cc45cd632e6d6&quot;</span><span class="p">,</span>
    <span class="s2">&quot;97bbdb4a1c7166682dc026e1ac97a64c&quot;</span><span class="p">,</span>
    <span class="s2">&quot;eb242b506a6ae330bda6969bb2677079&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">sequential</span></tt>: Monotonically increasing ids with random increments.
The first 26 hex characters are random, the last 6 increment in random
amounts until an overflow occurs. On overflow, the random prefix is
regenerated and the process starts over.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;uuids&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;4e17c12963f4bee0e6ec90da54804894&quot;</span><span class="p">,</span>
    <span class="s2">&quot;4e17c12963f4bee0e6ec90da5480512f&quot;</span><span class="p">,</span>
    <span class="s2">&quot;4e17c12963f4bee0e6ec90da54805c25&quot;</span><span class="p">,</span>
    <span class="s2">&quot;4e17c12963f4bee0e6ec90da54806ba1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;4e17c12963f4bee0e6ec90da548072b3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;4e17c12963f4bee0e6ec90da54807609&quot;</span><span class="p">,</span>
    <span class="s2">&quot;4e17c12963f4bee0e6ec90da54807718&quot;</span><span class="p">,</span>
    <span class="s2">&quot;4e17c12963f4bee0e6ec90da54807754&quot;</span><span class="p">,</span>
    <span class="s2">&quot;4e17c12963f4bee0e6ec90da54807e5d&quot;</span><span class="p">,</span>
    <span class="s2">&quot;4e17c12963f4bee0e6ec90da54808d28&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">utc_random</span></tt>: The time since Jan 1, 1970 UTC, in microseconds. The first
14 characters are the time in hex. The last 18 are random.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;uuids&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;04dd32b3af699659b6db9486a9c58c62&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32b3af69bb1c2ac7ebfee0a50d88&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32b3af69d8591b99a8e86a76e0fb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32b3af69f4a18a76efd89867f4f4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32b3af6a1f7925001274bbfde952&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32b3af6a3fe8ea9b120ed906a57f&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32b3af6a5b5c518809d3d4b76654&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32b3af6a78f6ab32f1e928593c73&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32b3af6a99916c665d6bbf857475&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32b3af6ab558dd3f2c0afacb7d66&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">utc_id</span></tt>: The time since Jan 1, 1970 UTC, in microseconds, plus
the <tt class="docutils literal"><span class="pre">utc_id_suffix</span></tt> string. The first 14 characters are the time in hex.
The <a class="reference internal" href="contents.html#uuids/utc_id_suffix" title="utc_id_suffix"><tt class="xref config config-option docutils literal"><span class="pre">uuids/utc_id_suffix</span></tt></a> string value is appended to these.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;uuids&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="s2">&quot;04dd32bd5eabcc@mycouch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32bd5eabee@mycouch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32bd5eac05@mycouch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32bd5eac28@mycouch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32bd5eac43@mycouch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32bd5eac58@mycouch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32bd5eac6e@mycouch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32bd5eac84@mycouch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32bd5eac98@mycouch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;04dd32bd5eacad@mycouch&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Impact of UUID choices:</strong> the choice of UUID has a significant impact
on the layout of the B-tree, prior to compaction.</p>
<p>For example, using a sequential UUID algorithm while uploading a large
batch of documents will avoid the need to rewrite many intermediate
B-tree nodes. A random UUID algorithm may require rewriting intermediate
nodes on a regular basis, resulting in significantly decreased throughput
and wasted disk space space due to the append-only B-tree design.</p>
<p class="last">It is generally recommended to set your own UUIDs, or use the sequential
algorithm unless you have a specific need and take into account
the likely need for compaction to re-balance the B-tree and reclaim
wasted space.</p>
</div>
</dd></dl>

<dl class="option">
<dt id="uuids/utc_id_suffix">
<tt class="descname">utc_id_suffix</tt><a class="headerlink" href="#uuids/utc_id_suffix" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>The <tt class="docutils literal"><span class="pre">utc_id_suffix</span></tt> value will be appended to UUIDs generated by the
<tt class="docutils literal"><span class="pre">utc_id</span></tt> algorithm. Replicating instances should have unique
<tt class="docutils literal"><span class="pre">utc_id_suffix</span></tt> values to ensure uniqueness of <tt class="docutils literal"><span class="pre">utc_id</span></tt> ids.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[uuid]</span>
<span class="na">utc_id_suffix</span> <span class="o">=</span> <span class="s">my-awesome-suffix</span>
</pre></div>
</div>
</dd></dl>

<dl class="option">
<dt id="uuids/max_count">
<tt class="descname">max_count</tt><a class="headerlink" href="#uuids/max_count" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.5.1.</span></p>
</div>
<p>No more than this number of UUIDs will be sent in a single request. If
more UUIDs are requested, an HTTP error response will be thrown.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[uuid]</span>
<span class="na">max_count</span> <span class="o">=</span> <span class="s">1000</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="vendor-information">
<span id="config-vendor"></span><h4>Vendor information<a class="headerlink" href="#vendor-information" title="Permalink to this headline">¶</a></h4>
<dl class="section">
<dt id="vendor">
<tt class="descname">[vendor]</tt><a class="headerlink" href="#vendor" title="Permalink to this definition">¶</a></dt>
<dd><div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>CouchDB distributors have the option of customizing CouchDB&#8217;s welcome
message. This is returned when requesting <tt class="docutils literal"><span class="pre">GET</span> <span class="pre">/</span></tt>.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[vendor]</span>
<span class="na">name</span> <span class="o">=</span> <span class="s">The Apache Software Foundation</span>
<span class="na">version</span> <span class="o">=</span> <span class="s">1.5.0</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
<span id="document-config/proxying"></span><div class="section" id="proxying-configuration">
<span id="config-proxy"></span><h3>Proxying Configuration<a class="headerlink" href="#proxying-configuration" title="Permalink to this headline">¶</a></h3>
<div class="section" id="couchdb-as-proxy">
<span id="config-proxy-couchdb"></span><span id="http-proxying"></span><h4>CouchDB As Proxy<a class="headerlink" href="#couchdb-as-proxy" title="Permalink to this headline">¶</a></h4>
<p>The HTTP proxy feature makes it easy to map and redirect different
content through your CouchDB URL. The proxy works by mapping a pathname
and passing all content after that prefix through to the configured
proxy address.</p>
<p>Configuration of the proxy redirect is handled through the
<tt class="docutils literal"><span class="pre">[httpd_global_handlers]</span></tt> section of the CouchDB configuration file
(typically <tt class="docutils literal"><span class="pre">local.ini</span></tt>). The format is:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">PREFIX</span> <span class="o">=</span> <span class="s">{couch_httpd_proxy, handle_proxy_req, &lt;&lt;&quot;DESTINATION&quot;&gt;&gt;}</span>
</pre></div>
</div>
<p>Where:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">PREFIX</span></tt></p>
<p>Is the string that will be matched. The string can be any valid
qualifier, although to ensure that existing database names are not
overridden by a proxy configuration, you can use an underscore
prefix.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">DESTINATION</span></tt></p>
<p>The fully-qualified URL to which the request should be sent. The
destination must include the <tt class="docutils literal"><span class="pre">http</span></tt> prefix. The content is used
verbatim in the original request, so you can also forward to servers
on different ports and to specific paths on the target host.</p>
</li>
</ul>
<p>The proxy process then translates requests of the form:</p>
<div class="highlight-text"><div class="highlight"><pre>http://couchdb:5984/PREFIX/path
</pre></div>
</div>
<p>To:</p>
<div class="highlight-text"><div class="highlight"><pre>DESTINATION/path
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Everything after <tt class="docutils literal"><span class="pre">PREFIX</span></tt> including the required forward slash
will be appended to the <tt class="docutils literal"><span class="pre">DESTINATION</span></tt>.</p>
</div>
<p>The response is then communicated back to the original client.</p>
<p>For example, the following configuration:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_google</span> <span class="o">=</span> <span class="s">{couch_httpd_proxy, handle_proxy_req, &lt;&lt;&quot;http://www.google.com&quot;&gt;&gt;}</span>
</pre></div>
</div>
<p>Would forward all requests for <tt class="docutils literal"><span class="pre">http://couchdb:5984/_google</span></tt> to the
Google website.</p>
<p>The service can also be used to forward to related CouchDB services,
such as <cite>Lucene</cite>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_fti</span> <span class="o">=</span> <span class="s">{couch_httpd_proxy, handle_proxy_req, &lt;&lt;&quot;http://127.0.0.1:5985&quot;&gt;&gt;}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The proxy service is basic. If the request is not identified by the
<tt class="docutils literal"><span class="pre">DESTINATION</span></tt>, or the remainder of the <tt class="docutils literal"><span class="pre">PATH</span></tt> specification is
incomplete, the original request URL is interpreted as if the
<tt class="docutils literal"><span class="pre">PREFIX</span></tt> component of that URL does not exist.</p>
<p class="last">For example, requesting <tt class="docutils literal"><span class="pre">http://couchdb:5984/_intranet/media</span></tt> when
<tt class="docutils literal"><span class="pre">/media</span></tt> on the proxy destination does not exist, will cause the
request URL to be interpreted as <tt class="docutils literal"><span class="pre">http://couchdb:5984/media</span></tt>. Care
should be taken to ensure that both requested URLs and destination
URLs are able to cope.</p>
</div>
</div>
</div>
</div>
</div>
<span id="document-replication/index"></span><div class="section" id="replication">
<span id="id1"></span><h2>Replication<a class="headerlink" href="#replication" title="Permalink to this headline">¶</a></h2>
<p>The replication is an incremental one way process involving two databases
(a source and a destination).</p>
<p>The aim of the replication is that at the end of the process, all active
documents on the source database are also in the destination database and all
documents that were deleted in the source databases are also deleted (if exists)
on the destination database.</p>
<p>The replication process only copies the last revision of a document, so all
previous revisions that were only on the source database are not copied to the
destination database.</p>
<div class="toctree-wrapper compound">
<span id="document-replication/intro"></span><div class="section" id="introduction-into-replications">
<span id="replication-intro"></span><h3>Introduction Into Replications<a class="headerlink" href="#introduction-into-replications" title="Permalink to this headline">¶</a></h3>
<p>One of CouchDB&#8217;s strengths is the ability to synchronize two copies of the same
database. This enables users to distribute data across several nodes or
datacenters, but also to move data more closely to clients.</p>
<p>Replication involves a source and a destination database, which can be one the
same or on different CouchDB instances. The aim of the replication is that at
the end of the process, all active documents on the source database are also in
the destination database and all documents that were deleted in the source
databases are also deleted on the destination database (if they even existed).</p>
<div class="section" id="triggering-replication">
<h4>Triggering Replication<a class="headerlink" href="#triggering-replication" title="Permalink to this headline">¶</a></h4>
<p>Replication is controlled through documents in the <a class="reference internal" href="contents.html#replicator"><em>Replicator Database</em></a>, where
each document describes one replication process (see
<a class="reference internal" href="contents.html#replication-settings"><em>Replication Settings</em></a>).</p>
<p>A replication is triggered by storing a replication document in the replicator
database. Its status can be inspected through the active tasks API (see
<a class="reference internal" href="contents.html#api-server-active-tasks"><em>/_active_tasks</em></a> and <a class="reference internal" href="contents.html#replication-status"><em>Replication Status</em></a>). A replication can be
stopped by deleting the document, or by updating it with its <cite>cancel</cite> property
set to <cite>true</cite>.</p>
</div>
<div class="section" id="replication-procedure">
<h4>Replication Procedure<a class="headerlink" href="#replication-procedure" title="Permalink to this headline">¶</a></h4>
<p>During replication, CouchDB will compare the source and the destination
database to determine which documents differ between the source and the
destination database. It does so by following the <a class="reference internal" href="contents.html#changes"><em>Changes Feeds</em></a> on the source
and comparing the documents to the destination. Changes are submitted to the
destination in batches where they can introduce conflicts. Documents that
already exist on the destination in the same revision are not transferred. As
the deletion of documents is represented by a new revision, a document deleted
on the source will also be deleted on the target.</p>
<p>A replication task will finish once it reaches the end of the changes feed. If
its <cite>continuous</cite> property is set to true, it will wait for new changes to
appear until the task is cancelled. Replication tasks also create checkpoint
documents on the destination to ensure that a restarted task can continue from
where it stopped, for example after it has crashed.</p>
<p>When a replication task is initiated on the sending node, it is called <em>push</em>
replication, if it is initiated by the receiving node, it is called <em>pull</em>
replication.</p>
</div>
<div class="section" id="master-master-replication">
<h4>Master - Master replication<a class="headerlink" href="#master-master-replication" title="Permalink to this headline">¶</a></h4>
<p>One replication task will only transfer changes in one direction. To achieve
master-master replication it is possible to set up two replication tasks in
different directions. When a change is replication from database A to B by the
first task, the second will discover that the new change on B already exists in
A and will wait for further changes.</p>
</div>
<div class="section" id="controlling-which-documents-to-replicate">
<h4>Controlling which Documents to Replicate<a class="headerlink" href="#controlling-which-documents-to-replicate" title="Permalink to this headline">¶</a></h4>
<p>There are two ways for controlling which documents are replicated, and which
are skipped. <em>Local</em> documents are never replicated (see <a class="reference internal" href="contents.html#api-local"><em>Local (non-replicating) Documents</em></a>).</p>
<p>Additionally, <a class="reference internal" href="contents.html#filterfun"><em>Filter functions</em></a> can be used in a replication documents (see
<a class="reference internal" href="contents.html#replication-settings"><em>Replication Settings</em></a>). The replication task will then evaluate
the filter function for each document in the changes feed. The document will
only be replicated if the filter returns <cite>true</cite>.</p>
</div>
<div class="section" id="migrating-data-to-clients">
<h4>Migrating Data to Clients<a class="headerlink" href="#migrating-data-to-clients" title="Permalink to this headline">¶</a></h4>
<p>Replication can be especially useful for bringing data closer to clients.
<a class="reference external" href="http://pouchdb.com/">PouchDB</a> implements the replication algorithm of CouchDB
in JavaScript, making it possible to make data from a CouchDB database
available in an offline browser application, and synchronize changes back to
CouchDB.</p>
</div>
</div>
<span id="document-replication/protocol"></span><div class="section" id="couchdb-replication-protocol">
<span id="replication-protocol"></span><h3>CouchDB Replication Protocol<a class="headerlink" href="#couchdb-replication-protocol" title="Permalink to this headline">¶</a></h3>
<p>The <strong>CouchDB Replication protocol</strong> is a protocol for synchronizing
documents between 2 peers over HTTP/1.1.</p>
<div class="section" id="language">
<h4>Language<a class="headerlink" href="#language" title="Permalink to this headline">¶</a></h4>
<p>The key words &#8220;MUST&#8221;, &#8220;MUST NOT&#8221;, &#8220;REQUIRED&#8221;, &#8220;SHALL&#8221;, &#8220;SHALL NOT&#8221;,
&#8220;SHOULD&#8221;, &#8220;SHOULD NOT&#8221;, &#8220;RECOMMENDED&#8221;, &#8220;MAY&#8221;, and &#8220;OPTIONAL&#8221; in this
document are to be interpreted as described in <span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2119.html"><strong>RFC 2119</strong></a>.</p>
</div>
<div class="section" id="goals">
<h4>Goals<a class="headerlink" href="#goals" title="Permalink to this headline">¶</a></h4>
<p>The CouchDB Replication protocol is a synchronization protocol for
synchronizing documents between 2 peers over HTTP/1.1.</p>
<p>In theory the CouchDB protocol can be used between products that
implement it. However the reference implementation, written in <a class="reference external" href="http://erlang.org">Erlang</a>, is
provided by the <a class="reference external" href="https://github.com/apache/couchdb/tree/master/src/couch_replicator">couch_replicator</a> module available in Apache CouchDB.</p>
<p>The <a class="reference external" href="http://couchdb.apache.org">CouchDB</a> replication protocol is using the <a class="reference external" href="http://wiki.apache.org/couchdb/Reference">CouchDB REST API</a> and so is based on HTTP and
the Apache CouchDB MVCC Data model. The primary goal of this
specification is to describe the CouchDB replication algorithm.</p>
</div>
<div class="section" id="definitions">
<h4>Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt>ID:</dt>
<dd>An identifier (could be an UUID) as described in <span class="target" id="index-1"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc4122.html"><strong>RFC 4122</strong></a></dd>
<dt>Sequence:</dt>
<dd>An ID provided by the changes feed. It can be numeric but not
necessarily.</dd>
<dt>Revision:</dt>
<dd>(to define)</dd>
<dt>Document</dt>
<dd>A document is JSON entity with a unique ID and revision.</dd>
<dt>Database</dt>
<dd>A collection of documents with a unique URI</dd>
<dt>URI</dt>
<dd>An uri is defined by the <span class="target" id="index-2"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2396.html"><strong>RFC 2396</strong></a> . It can be an URL as defined
in <span class="target" id="index-3"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc1738.html"><strong>RFC 1738</strong></a>.</dd>
<dt>Source</dt>
<dd>Database from where the Documents are replicated</dd>
<dt>Target</dt>
<dd>Database where the Document are replicated</dd>
<dt>Checkpoint</dt>
<dd>Last source sequence ID</dd>
</dl>
</div>
<div class="section" id="algorithm">
<h4>Algorithm<a class="headerlink" href="#algorithm" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Get unique identifiers for the Source and Target based on their URI if
replication task ID is not available.</li>
<li>Save this identifier in a special Document named <cite>_local/&lt;uniqueid&gt;</cite>
on the Target database. This document isn&#8217;t replicated. It will
collect the last Source sequence ID, the Checkpoint, from the
previous replication process.</li>
<li>Get the Source changes feed by passing it the Checkpoint using the
<cite>since</cite> parameter by calling the <cite>/&lt;source&gt;/_changes</cite> URL. The
changes feed only return a list of current revisions.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This step can be done continuously using the <cite>feed=longpoll</cite> or
<cite>feed=continuous</cite> parameters. Then the feed will continuously get
the changes.</p>
</div>
<ol class="arabic simple" start="4">
<li>Collect a group of Document/Revisions ID pairs from the <strong>changes
feed</strong> and send them to the target databases on the
<cite>/&lt;target&gt;/_revs_diffs</cite> URL. The result will contain the list of
revisions <strong>NOT</strong> in the Target.</li>
<li>GET each revisions from the source Database by calling the URL
<cite>/&lt;source&gt;/&lt;docid&gt;?revs=true&amp;open_revs`=&lt;revision&gt;</cite> . This
will get the document with its parent revisions. Also don&#8217;t forget to
get attachments that aren&#8217;t already stored at the target. As an
optimisation you can use the HTTP multipart api to get all.</li>
<li>Collect a group of revisions fetched at previous step and store them
on the target database using the <a class="reference external" href="http://wiki.apache.org/couchdb/HTTP_Document_API#Bulk_Docs">Bulk Docs</a> API
with the <cite>new_edit: false</cite> JSON property to preserve their revisions
ID.</li>
<li>After the group of revision is stored on the Target, save
the new Checkpoint on the Source.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>Even if some revisions have been ignored the sequence should be
take in consideration for the Checkpoint.</li>
<li>To compare non numeric sequence ordering, you will have to keep an
ordered list of the sequences IDS as they appear in the _changes
feed and compare their indices.</li>
</ul>
</div>
</div>
<div class="section" id="filter-replication">
<h4>Filter replication<a class="headerlink" href="#filter-replication" title="Permalink to this headline">¶</a></h4>
<p>The replication can be filtered by passing the <cite>filter</cite> parameter to the
changes feeds with a function name. This will call a function on each
changes. If this function return True, the document will be added to the
feed.</p>
</div>
<div class="section" id="optimisations">
<h4>Optimisations<a class="headerlink" href="#optimisations" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The system should run each steps in parallel to reduce the latency.</li>
<li>The number of revisions passed to the step 3 and 6 should be large
enough to reduce the bandwidth and make sure to reduce the latency.</li>
</ul>
</div>
<div class="section" id="api-reference">
<h4>API Reference<a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference internal" href="contents.html#head--db" title="HEAD /{db}"><tt class="xref http http-head docutils literal"><span class="pre">HEAD</span> <span class="pre">/{db}</span></tt></a> &#8211; Check Database existence</li>
<li><a class="reference internal" href="contents.html#post--db-_ensure_full_commit" title="POST /{db}/_ensure_full_commit"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_ensure_full_commit</span></tt></a> &#8211; Ensure that all changes are stored
on disk</li>
<li><em>:get:`/{db}/_local/{id}`</em> &#8211; Read the last Checkpoint</li>
<li><em>:put:`/{db}/_local/{id}`</em> &#8211; Save a new Checkpoint</li>
</ul>
<div class="section" id="push-only">
<h5>Push Only<a class="headerlink" href="#push-only" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference internal" href="contents.html#put--db" title="PUT /{db}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/{db}</span></tt></a> &#8211; Create Target if it not exists and option was provided</li>
<li><a class="reference internal" href="contents.html#post--db-_revs_diff" title="POST /{db}/_revs_diff"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_revs_diff</span></tt></a> &#8211; Locate Revisions that are not known to the
Target</li>
<li><a class="reference internal" href="contents.html#post--db-_bulk_docs" title="POST /{db}/_bulk_docs"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_bulk_docs</span></tt></a> &#8211; Upload Revisions to the Target</li>
<li><a class="reference internal" href="contents.html#put--db-docid" title="PUT /{db}/{docid}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/{db}/{docid}</span></tt></a>?new_edits=false &#8211; Upload a single Document with
attachments to the Target</li>
</ul>
</div>
<div class="section" id="pull-only">
<h5>Pull Only<a class="headerlink" href="#pull-only" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference internal" href="contents.html#get--db-_changes" title="GET /{db}/_changes"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/_changes</span></tt></a> &#8211; Locate changes since on Source the last pull.
The request uses next query parameters:<ul>
<li><tt class="docutils literal"><span class="pre">style=all_docs</span></tt></li>
<li><tt class="docutils literal"><span class="pre">feed=feed</span></tt> , where feed is <a class="reference internal" href="contents.html#changes-normal"><em>normal</em></a> or
<a class="reference internal" href="contents.html#changes-longpoll"><em>longpoll</em></a></li>
<li><tt class="docutils literal"><span class="pre">limit=limit</span></tt></li>
<li><tt class="docutils literal"><span class="pre">heartbeat=heartbeat</span></tt></li>
</ul>
</li>
<li><a class="reference internal" href="contents.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}</span></tt></a> &#8211; Retrieve a single Document from Source with attachments.
The request uses next query parameters:<ul>
<li><tt class="docutils literal"><span class="pre">open_revs=revid</span></tt> - where <tt class="docutils literal"><span class="pre">revid</span></tt> is the actual Document Revision at the
moment of the pull request</li>
<li><tt class="docutils literal"><span class="pre">revs=true</span></tt></li>
<li><tt class="docutils literal"><span class="pre">atts_since=lastrev</span></tt></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="reference">
<h4>Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://github.com/couchbaselabs/TouchDB-iOS/wiki/Replication-Algorithm">TouchDB iOS wiki</a></li>
<li><a class="reference external" href="http://wiki.apache.org/couchdb/Replication">CouchDB documentation</a></li>
<li>CouchDB <a class="reference external" href="http://guide.couchdb.org/draft/notifications.html">change notifications</a></li>
</ul>
</div>
</div>
<span id="document-replication/replicator"></span><div class="section" id="replicator-database">
<span id="replicator"></span><h3>Replicator Database<a class="headerlink" href="#replicator-database" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">_replicator</span></tt> database works like any other in CouchDB, but documents
added to it will trigger replications. Creating (<tt class="docutils literal"><span class="pre">PUT</span></tt> or <tt class="docutils literal"><span class="pre">POST</span></tt>) a
document to start a replication. <tt class="docutils literal"><span class="pre">DELETE</span></tt> a replicaiton document to
cancel an ongoing replication.</p>
<p>These documents have exactly the same content as the JSON objects we use to
<tt class="docutils literal"><span class="pre">POST</span></tt> to <tt class="docutils literal"><span class="pre">_replicate</span></tt> (fields <tt class="docutils literal"><span class="pre">source</span></tt>, <tt class="docutils literal"><span class="pre">target</span></tt>, <tt class="docutils literal"><span class="pre">create_target</span></tt>,
<tt class="docutils literal"><span class="pre">continuous</span></tt>, <tt class="docutils literal"><span class="pre">doc_ids</span></tt>, <tt class="docutils literal"><span class="pre">filter</span></tt>, <tt class="docutils literal"><span class="pre">query_params</span></tt>, <tt class="docutils literal"><span class="pre">use_checkpoints</span></tt>,
<tt class="docutils literal"><span class="pre">checkpoint_interval</span></tt>).</p>
<p>Replication documents can have a user defined <tt class="docutils literal"><span class="pre">_id</span></tt> (handy for finding a
specific replication request later). Design Documents
(and <tt class="docutils literal"><span class="pre">_local</span></tt> documents) added to the replicator database are ignored.</p>
<p>The default name of this database is <tt class="docutils literal"><span class="pre">_replicator</span></tt>. The name can be
changed in the <tt class="docutils literal"><span class="pre">local.ini</span></tt> configuration, section <tt class="docutils literal"><span class="pre">[replicator]</span></tt>,
parameter <tt class="docutils literal"><span class="pre">db</span></tt>.</p>
<div class="section" id="basics">
<h4>Basics<a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h4>
<p>Let&#8217;s say you POST the following document into <tt class="docutils literal"><span class="pre">_replicator</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;my_rep&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://myserver.com:5984/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;create_target&quot;</span><span class="o">:</span>  <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the couch log you&#8217;ll see 2 entries like these:</p>
<div class="highlight-text"><div class="highlight"><pre>[Thu, 17 Feb 2011 19:43:59 GMT] [info] [&lt;0.291.0&gt;] Document `my_rep` triggered replication `c0ebe9256695ff083347cbf95f93e280+create_target`
[Thu, 17 Feb 2011 19:44:37 GMT] [info] [&lt;0.124.0&gt;] Replication `c0ebe9256695ff083347cbf95f93e280+create_target` finished (triggered by document `my_rep`)
</pre></div>
</div>
<p>As soon as the replication is triggered, the document will be updated by
CouchDB with 3 new fields:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;my_rep&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://myserver.com:5984/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;create_target&quot;</span><span class="o">:</span>  <span class="kc">true</span><span class="p">,</span>
    <span class="s2">&quot;_replication_id&quot;</span><span class="o">:</span>  <span class="s2">&quot;c0ebe9256695ff083347cbf95f93e280&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_state&quot;</span><span class="o">:</span>  <span class="s2">&quot;triggered&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_state_time&quot;</span><span class="o">:</span>  <span class="mi">1297974122</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Special fields set by the replicator start with the prefix
<tt class="docutils literal"><span class="pre">_replication_</span></tt>.</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">_replication_id</span></tt></p>
<p>The ID internally assigned to the replication. This is also the ID
exposed by <tt class="docutils literal"><span class="pre">/_active_tasks</span></tt>.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">_replication_state</span></tt></p>
<p>The current state of the replication.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">_replication_state_time</span></tt></p>
<p>A Unix timestamp (number of seconds since 1 Jan 1970) that tells us
when the current replication state (marked in <tt class="docutils literal"><span class="pre">_replication_state</span></tt>)
was set.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">_replication_state_reason</span></tt></p>
<p>If <tt class="docutils literal"><span class="pre">replication_state</span></tt> is <tt class="docutils literal"><span class="pre">error</span></tt>, this field contains the reason.</p>
</li>
</ul>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
<span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;my_rep&quot;</span><span class="p">,</span>
<span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;2-9f2c0d9372f4ee4dc75652ab8f8e7c70&quot;</span><span class="p">,</span>
<span class="s2">&quot;source&quot;</span><span class="o">:</span> <span class="s2">&quot;foodb&quot;</span><span class="p">,</span>
<span class="s2">&quot;target&quot;</span><span class="o">:</span> <span class="s2">&quot;bardb&quot;</span><span class="p">,</span>
<span class="s2">&quot;_replication_state&quot;</span><span class="o">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
<span class="s2">&quot;_replication_state_time&quot;</span><span class="o">:</span> <span class="s2">&quot;2013-12-13T18:48:00+01:00&quot;</span><span class="p">,</span>
<span class="s2">&quot;_replication_state_reason&quot;</span><span class="o">:</span> <span class="s2">&quot;db_not_found: could not open foodb&quot;</span><span class="p">,</span>
<span class="s2">&quot;_replication_id&quot;</span><span class="o">:</span> <span class="s2">&quot;fe965cdc47b4d5f6c02811d9d351ac3d&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When the replication finishes, it will update the <tt class="docutils literal"><span class="pre">_replication_state</span></tt>
field (and <tt class="docutils literal"><span class="pre">_replication_state_time</span></tt>) with the value <tt class="docutils literal"><span class="pre">completed</span></tt>, so
the document will look like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;my_rep&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://myserver.com:5984/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;create_target&quot;</span><span class="o">:</span>  <span class="kc">true</span><span class="p">,</span>
    <span class="s2">&quot;_replication_id&quot;</span><span class="o">:</span>  <span class="s2">&quot;c0ebe9256695ff083347cbf95f93e280&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_state&quot;</span><span class="o">:</span>  <span class="s2">&quot;completed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_state_time&quot;</span><span class="o">:</span>  <span class="mi">1297974122</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When an error happens during replication, the <tt class="docutils literal"><span class="pre">_replication_state</span></tt>
field is set to <tt class="docutils literal"><span class="pre">error</span></tt> (and <tt class="docutils literal"><span class="pre">_replication_state_reason</span></tt> and
<tt class="docutils literal"><span class="pre">_replication_state_time</span></tt> are updated).</p>
<p>When you PUT/POST a document to the <tt class="docutils literal"><span class="pre">_replicator</span></tt> database, CouchDB
will attempt to start the replication up to 10 times (configurable under
<tt class="docutils literal"><span class="pre">[replicator]</span></tt>, parameter <tt class="docutils literal"><span class="pre">max_replication_retry_count</span></tt>). If it
fails on the first attempt, it waits 5 seconds before doing a second
attempt. If the second attempt fails, it waits 10 seconds before doing a
third attempt. If the third attempt fails, it waits 20 seconds before
doing a fourth attempt (each attempt doubles the previous wait period).
When an attempt fails, the Couch log will show you something like:</p>
<div class="highlight-text"><div class="highlight"><pre>[error] [&lt;0.149.0&gt;] Error starting replication `67c1bb92010e7abe35d7d629635f18b6+create_target` (document `my_rep_2`): {db_not_found,&lt;&lt;&quot;could not open http://myserver:5986/foo/&quot;&gt;&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal"><span class="pre">_replication_state</span></tt> field is only set to <tt class="docutils literal"><span class="pre">error</span></tt> when all
the attempts were unsuccessful.</p>
</div>
<p>There are only 3 possible values for the <tt class="docutils literal"><span class="pre">_replication_state</span></tt> field:
<tt class="docutils literal"><span class="pre">triggered</span></tt>, <tt class="docutils literal"><span class="pre">completed</span></tt> and <tt class="docutils literal"><span class="pre">error</span></tt>. Continuous replications
never get their state set to <tt class="docutils literal"><span class="pre">completed</span></tt>.</p>
</div>
<div class="section" id="documents-describing-the-same-replication">
<h4>Documents describing the same replication<a class="headerlink" href="#documents-describing-the-same-replication" title="Permalink to this headline">¶</a></h4>
<p>Lets suppose 2 documents are added to the <tt class="docutils literal"><span class="pre">_replicator</span></tt> database in
the following order:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;doc_A&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://myserver.com:5984/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;bar&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;doc_B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://myserver.com:5984/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;bar&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Both describe exactly the same replication (only their <tt class="docutils literal"><span class="pre">_ids</span></tt> differ).
In this case document <tt class="docutils literal"><span class="pre">doc_A</span></tt> triggers the replication, getting
updated by CouchDB with the fields <tt class="docutils literal"><span class="pre">_replication_state</span></tt>,
<tt class="docutils literal"><span class="pre">_replication_state_time</span></tt> and <tt class="docutils literal"><span class="pre">_replication_id</span></tt>, just like it was
described before. Document <tt class="docutils literal"><span class="pre">doc_B</span></tt> however, is only updated with one
field, the <tt class="docutils literal"><span class="pre">_replication_id</span></tt> so it will look like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;doc_B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://myserver.com:5984/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_id&quot;</span><span class="o">:</span>  <span class="s2">&quot;c0ebe9256695ff083347cbf95f93e280&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>While document <tt class="docutils literal"><span class="pre">doc_A</span></tt> will look like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;doc_A&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://myserver.com:5984/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_id&quot;</span><span class="o">:</span>  <span class="s2">&quot;c0ebe9256695ff083347cbf95f93e280&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_state&quot;</span><span class="o">:</span>  <span class="s2">&quot;triggered&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_state_time&quot;</span><span class="o">:</span>  <span class="mi">1297974122</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that both document get exactly the same value for the
<tt class="docutils literal"><span class="pre">_replication_id</span></tt> field. This way you can identify which documents
refer to the same replication - you can for example define a view which
maps replication IDs to document IDs.</p>
</div>
<div class="section" id="canceling-replications">
<h4>Canceling replications<a class="headerlink" href="#canceling-replications" title="Permalink to this headline">¶</a></h4>
<p>To cancel a replication simply <tt class="docutils literal"><span class="pre">DELETE</span></tt> the document which triggered
the replication. The Couch log will show you an entry like the
following:</p>
<div class="highlight-text"><div class="highlight"><pre>[Thu, 17 Feb 2011 20:16:29 GMT] [info] [&lt;0.125.0&gt;] Stopped replication `c0ebe9256695ff083347cbf95f93e280+continuous+create_target` because replication document `doc_A` was deleted
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You need to <tt class="docutils literal"><span class="pre">DELETE</span></tt> the document that triggered the replication.
<tt class="docutils literal"><span class="pre">DELETE</span></tt>-ing another document that describes the same replication
but did not trigger it, will not cancel the replication.</p>
</div>
</div>
<div class="section" id="server-restart">
<h4>Server restart<a class="headerlink" href="#server-restart" title="Permalink to this headline">¶</a></h4>
<p>When CouchDB is restarted, it checks its <tt class="docutils literal"><span class="pre">_replicator</span></tt> database and
restarts any replication that is described by a document that either has
its <tt class="docutils literal"><span class="pre">_replication_state</span></tt> field set to <tt class="docutils literal"><span class="pre">triggered</span></tt> or it doesn&#8217;t have
yet the <tt class="docutils literal"><span class="pre">_replication_state</span></tt> field set.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Continuous replications always have a <tt class="docutils literal"><span class="pre">_replication_state</span></tt> field
with the value <tt class="docutils literal"><span class="pre">triggered</span></tt>, therefore they&#8217;re always restarted
when CouchDB is restarted.</p>
</div>
</div>
<div class="section" id="changing-the-replicator-database">
<h4>Changing the Replicator Database<a class="headerlink" href="#changing-the-replicator-database" title="Permalink to this headline">¶</a></h4>
<p>Imagine your replicator database (default name is <tt class="docutils literal"><span class="pre">_replicator</span></tt>) has the
two following documents that represent pull replications from servers A
and B:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;rep_from_A&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://aserver.com:5984/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;foo_a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;continuous&quot;</span><span class="o">:</span>  <span class="kc">true</span><span class="p">,</span>
    <span class="s2">&quot;_replication_id&quot;</span><span class="o">:</span>  <span class="s2">&quot;c0ebe9256695ff083347cbf95f93e280&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_state&quot;</span><span class="o">:</span>  <span class="s2">&quot;triggered&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_state_time&quot;</span><span class="o">:</span>  <span class="mi">1297971311</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;rep_from_B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://bserver.com:5984/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;foo_b&quot;</span><span class="p">,</span>
    <span class="s2">&quot;continuous&quot;</span><span class="o">:</span>  <span class="kc">true</span><span class="p">,</span>
    <span class="s2">&quot;_replication_id&quot;</span><span class="o">:</span>  <span class="s2">&quot;231bb3cf9d48314eaa8d48a9170570d1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_state&quot;</span><span class="o">:</span>  <span class="s2">&quot;triggered&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_replication_state_time&quot;</span><span class="o">:</span>  <span class="mi">1297974122</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now without stopping and restarting CouchDB, you change the name of the
replicator database to <tt class="docutils literal"><span class="pre">another_replicator_db</span></tt>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>curl -X PUT http://localhost:5984/_config/replicator/db -d <span class="s1">&#39;&quot;another_replicator_db&quot;&#39;</span>
<span class="s2">&quot;_replicator&quot;</span>
</pre></div>
</div>
<p>As soon as this is done, both pull replications defined before, are
stopped. This is explicitly mentioned in CouchDB&#8217;s log:</p>
<div class="highlight-text"><div class="highlight"><pre>[Fri, 11 Mar 2011 07:44:20 GMT] [info] [&lt;0.104.0&gt;] Stopping all ongoing replications because the replicator database was deleted or changed
[Fri, 11 Mar 2011 07:44:20 GMT] [info] [&lt;0.127.0&gt;] 127.0.0.1 - - PUT /_config/replicator/db 200
</pre></div>
</div>
<p>Imagine now you add a replication document to the new replicator
database named <tt class="docutils literal"><span class="pre">another_replicator_db</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;rep_from_X&quot;</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://xserver.com:5984/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;foo_x&quot;</span><span class="p">,</span>
    <span class="s2">&quot;continuous&quot;</span><span class="o">:</span>  <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From now own you have a single replication going on in your system: a
pull replication pulling from server X. Now you change back the
replicator database to the original one <tt class="docutils literal"><span class="pre">_replicator</span></tt>:</p>
<div class="highlight-ini"><div class="highlight"><pre>$ curl -X PUT http://localhost:5984/_config/replicator/db -d &#39;&quot;_replicator&quot;&#39;
&quot;another_replicator_db&quot;
</pre></div>
</div>
<p>Immediately after this operation, the replication pulling from server X
will be stopped and the replications defined in the <tt class="docutils literal"><span class="pre">_replicator</span></tt>
database (pulling from servers A and B) will be resumed.</p>
<p>Changing again the replicator database to <tt class="docutils literal"><span class="pre">another_replicator_db</span></tt> will
stop the pull replications pulling from servers A and B, and resume the
pull replication pulling from server X.</p>
</div>
<div class="section" id="replicating-the-replicator-database">
<h4>Replicating the replicator database<a class="headerlink" href="#replicating-the-replicator-database" title="Permalink to this headline">¶</a></h4>
<p>Imagine you have in server C a replicator database with the two
following pull replication documents in it:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
     <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;rep_from_A&quot;</span><span class="p">,</span>
     <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://aserver.com:5984/foo&quot;</span><span class="p">,</span>
     <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;foo_a&quot;</span><span class="p">,</span>
     <span class="s2">&quot;continuous&quot;</span><span class="o">:</span>  <span class="kc">true</span><span class="p">,</span>
     <span class="s2">&quot;_replication_id&quot;</span><span class="o">:</span>  <span class="s2">&quot;c0ebe9256695ff083347cbf95f93e280&quot;</span><span class="p">,</span>
     <span class="s2">&quot;_replication_state&quot;</span><span class="o">:</span>  <span class="s2">&quot;triggered&quot;</span><span class="p">,</span>
     <span class="s2">&quot;_replication_state_time&quot;</span><span class="o">:</span>  <span class="mi">1297971311</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
     <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;rep_from_B&quot;</span><span class="p">,</span>
     <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://bserver.com:5984/foo&quot;</span><span class="p">,</span>
     <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;foo_b&quot;</span><span class="p">,</span>
     <span class="s2">&quot;continuous&quot;</span><span class="o">:</span>  <span class="kc">true</span><span class="p">,</span>
     <span class="s2">&quot;_replication_id&quot;</span><span class="o">:</span>  <span class="s2">&quot;231bb3cf9d48314eaa8d48a9170570d1&quot;</span><span class="p">,</span>
     <span class="s2">&quot;_replication_state&quot;</span><span class="o">:</span>  <span class="s2">&quot;triggered&quot;</span><span class="p">,</span>
     <span class="s2">&quot;_replication_state_time&quot;</span><span class="o">:</span>  <span class="mi">1297974122</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now you would like to have the same pull replications going on in server
D, that is, you would like to have server D pull replicating from
servers A and B. You have two options:</p>
<ul class="simple">
<li>Explicitly add two documents to server&#8217;s D replicator database</li>
<li>Replicate server&#8217;s C replicator database into server&#8217;s D replicator
database</li>
</ul>
<p>Both alternatives accomplish exactly the same goal.</p>
</div>
<div class="section" id="delegations">
<h4>Delegations<a class="headerlink" href="#delegations" title="Permalink to this headline">¶</a></h4>
<p>Replication documents can have a custom <tt class="docutils literal"><span class="pre">user_ctx</span></tt> property. This
property defines the user context under which a replication runs. For
the old way of triggering replications (POSTing to <tt class="docutils literal"><span class="pre">/_replicate/</span></tt>),
this property was not needed (it didn&#8217;t exist in fact) - this is because
at the moment of triggering the replication it has information about the
authenticated user. With the replicator database, since it&#8217;s a regular
database, the information about the authenticated user is only present
at the moment the replication document is written to the database - the
replicator database implementation is like a <tt class="docutils literal"><span class="pre">_changes</span></tt> feed consumer
(with <tt class="docutils literal"><span class="pre">?include_docs=true</span></tt>) that reacts to what was written to the
replicator database - in fact this feature could be implemented with an
external script/program. This implementation detail implies that for non
admin users, a <tt class="docutils literal"><span class="pre">user_ctx</span></tt> property, containing the user&#8217;s name and a
subset of their roles, must be defined in the replication document.
This is ensured by the document update validation function present in
the default design document of the replicator database. This validation
function also ensure that a non admin user can set a user name property
in the <tt class="docutils literal"><span class="pre">user_ctx</span></tt> property that doesn&#8217;t match their own name (same
principle applies for the roles).</p>
<p>For admins, the <tt class="docutils literal"><span class="pre">user_ctx</span></tt> property is optional, and if it&#8217;s missing
it defaults to a user context with name null and an empty list of roles
- this mean design documents will not be written to local targets. If
writing design documents to local targets is desired, the a user context
with the roles <tt class="docutils literal"><span class="pre">_admin</span></tt> must be set explicitly.</p>
<p>Also, for admins the <tt class="docutils literal"><span class="pre">user_ctx</span></tt> property can be used to trigger a
replication on behalf of another user. This is the user context that
will be passed to local target database document validation functions.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal"><span class="pre">user_ctx</span></tt> property only has effect for local endpoints.</p>
</div>
<p>Example delegated replication document:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
     <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;my_rep&quot;</span><span class="p">,</span>
     <span class="s2">&quot;source&quot;</span><span class="o">:</span>  <span class="s2">&quot;http://bserver.com:5984/foo&quot;</span><span class="p">,</span>
     <span class="s2">&quot;target&quot;</span><span class="o">:</span>  <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
     <span class="s2">&quot;continuous&quot;</span><span class="o">:</span>  <span class="kc">true</span><span class="p">,</span>
     <span class="s2">&quot;user_ctx&quot;</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;joe&quot;</span><span class="p">,</span>
          <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;erlanger&quot;</span><span class="p">,</span> <span class="s2">&quot;researcher&quot;</span><span class="p">]</span>
     <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As stated before, for admins the <tt class="docutils literal"><span class="pre">user_ctx</span></tt> property is optional, while
for regular (non admin) users it&#8217;s mandatory. When the roles property of
<tt class="docutils literal"><span class="pre">user_ctx</span></tt> is missing, it defaults to the empty list <tt class="docutils literal"><span class="pre">[</span> <span class="pre">]</span></tt>.</p>
</div>
</div>
<span id="document-replication/conflicts"></span><div class="section" id="replication-and-conflict-model">
<span id="replication-conflicts"></span><h3>Replication and conflict model<a class="headerlink" href="#replication-and-conflict-model" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s take the following example to illustrate replication and conflict handling.</p>
<ul class="simple">
<li>Alice has a document containing Bob&#8217;s business card;</li>
<li>She synchronizes it between her desktop PC and her laptop;</li>
<li>On the desktop PC, she updates Bob&#8217;s E-mail address;
Without syncing again, she updates Bob&#8217;s mobile number on the laptop;</li>
<li>Then she replicates the two to each other again.</li>
</ul>
<p>So on the desktop the document has Bob&#8217;s new E-mail address and his old mobile
number, and on the laptop it has his old E-mail address and his new mobile
number.</p>
<p>The question is, what happens to these conflicting updated documents?</p>
<div class="section" id="couchdb-replication">
<h4>CouchDB replication<a class="headerlink" href="#couchdb-replication" title="Permalink to this headline">¶</a></h4>
<p>CouchDB works with JSON documents inside databases. Replication of databases
takes place over HTTP, and can be either a &#8220;pull&#8221; or a &#8220;push&#8221;, but is
unidirectional. So the easiest way to perform a full sync is to do a &#8220;push&#8221;
followed by a &#8220;pull&#8221; (or vice versa).</p>
<p>So, Alice creates v1 and sync it. She updates to v2a on one side and v2b on the
other, and then replicates. What happens?</p>
<p>The answer is simple: both versions exist on both sides!</p>
<div class="highlight-text"><div class="highlight"><pre>  DESKTOP                          LAPTOP
+---------+
| /db/bob |                                     INITIAL
|   v1    |                                     CREATION
+---------+

+---------+                      +---------+
| /db/bob |  -----------------&gt;  | /db/bob |     PUSH
|   v1    |                      |   v1    |
+---------+                      +---------+

+---------+                      +---------+  INDEPENDENT
| /db/bob |                      | /db/bob |     LOCAL
|   v2a   |                      |   v2b   |     EDITS
+---------+                      +---------+

+---------+                      +---------+
| /db/bob |  -----------------&gt;  | /db/bob |     PUSH
|   v2a   |                      |   v2a   |
+---------+                      |   v2b   |
                                 +---------+

+---------+                      +---------+
| /db/bob |  &lt;-----------------  | /db/bob |     PULL
|   v2a   |                      |   v2a   |
|   v2b   |                      |   v2b   |
+---------+                      +---------+
</pre></div>
</div>
<p>After all, this is not a filesystem, so there&#8217;s no restriction that only one
document can exist with the name /db/bob. These are just &#8220;conflicting&#8221; revisions
under the same name.</p>
<p>Because the changes are always replicated, the data is safe. Both machines have
identical copies of both documents, so failure of a hard drive on either side
won&#8217;t lose any of the changes.</p>
<p>Another thing to notice is that peers do not have to be configured or tracked.
You can do regular replications to peers, or you can do one-off, ad-hoc pushes
or pulls. After the replication has taken place, there is no record kept of
which peer any particular document or revision came from.</p>
<p>So the question now is: what happens when you try to read /db/bob? By default,
CouchDB picks one arbitrary revision as the &#8220;winner&#8221;, using a deterministic
algorithm so that the same choice will be made on all peers. The same happens
with views: the deterministically-chosen winner is the only revision fed into
your map function.</p>
<p>Let&#8217;s say that the winner is v2a. On the desktop, if Alice reads the document
she&#8217;ll see v2a, which is what she saved there. But on the laptop, after
replication, she&#8217;ll also see only v2a. It could look as if the changes she made
there have been lost - but of course they have not, they have just been hidden
away as a conflicting revision. But eventually she&#8217;ll need these changes merged
into Bob&#8217;s business card, otherwise they will effectively have been lost.</p>
<p>Any sensible business-card application will, at minimum, have to present the
conflicting versions to Alice and allow her to create a new version
incorporating information from them all. Ideally it would merge the updates
itself.</p>
</div>
<div class="section" id="conflict-avoidance">
<h4>Conflict avoidance<a class="headerlink" href="#conflict-avoidance" title="Permalink to this headline">¶</a></h4>
<p>When working on a single node, CouchDB will avoid creating conflicting revisions
by returning a <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.10">409 Conflict</a> error. This is because, when you
PUT a new version of a document, you must give the <tt class="docutils literal"><span class="pre">_rev</span></tt> of the previous
version. If that <tt class="docutils literal"><span class="pre">_rev</span></tt> has already been superseded, the update is rejected
with a  <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.10">409 Conflict</a> response.</p>
<p>So imagine two users on the same node are fetching Bob&#8217;s business card, updating
it concurrently, and writing it back:</p>
<div class="highlight-text"><div class="highlight"><pre>USER1    -----------&gt;  GET /db/bob
         &lt;-----------  {&quot;_rev&quot;:&quot;1-aaa&quot;, ...}

USER2    -----------&gt;  GET /db/bob
         &lt;-----------  {&quot;_rev&quot;:&quot;1-aaa&quot;, ...}

USER1    -----------&gt;  PUT /db/bob?rev=1-aaa
         &lt;-----------  {&quot;_rev&quot;:&quot;2-bbb&quot;, ...}

USER2    -----------&gt;  PUT /db/bob?rev=1-aaa
         &lt;-----------  409 Conflict  (not saved)
</pre></div>
</div>
<p>User2&#8217;s changes are rejected, so it&#8217;s up to the app to fetch /db/bob again,
and either:</p>
<ol class="arabic simple">
<li>apply the same changes as were applied to the earlier revision, and submit
a new PUT</li>
<li>redisplay the document so the user has to edit it again</li>
<li>just overwrite it with the document being saved before (which is not
advisable, as user1&#8217;s changes will be silently lost)</li>
</ol>
<p>So when working in this mode, your application still has to be able to handle
these conflicts and have a suitable retry strategy, but these conflicts never
end up inside the database itself.</p>
</div>
<div class="section" id="conflicts-in-batches">
<h4>Conflicts in batches<a class="headerlink" href="#conflicts-in-batches" title="Permalink to this headline">¶</a></h4>
<p>There are two different ways that conflicts can end up in the database:</p>
<ul class="simple">
<li>Conflicting changes made on different databases, which are replicated to each
other, as shown earlier.</li>
<li>Changes are written to the database using <tt class="docutils literal"><span class="pre">_bulk_docs</span></tt> and all_or_nothing,
which bypasses the 409 mechanism.</li>
</ul>
<p>The <a class="reference internal" href="contents.html#api-db-bulk-docs"><em>_bulk_docs API</em></a> lets you submit multiple updates
(and/or deletes) in a single HTTP POST. Normally, these are treated as
independent updates; some in the batch may fail because the <cite>_rev</cite> is stale
(just like a 409 from a PUT) whilst others are written successfully.
The response from <tt class="docutils literal"><span class="pre">_bulk_docs</span></tt> lists the success/fail separately for each
document in the batch.</p>
<p>However there is another mode of working, whereby you specify
<tt class="docutils literal"><span class="pre">{&quot;all_or_nothing&quot;:true}</span></tt> as part of the request. This is CouchDB&#8217;s nearest
equivalent of a &#8220;transaction&#8221;, but it&#8217;s not the same as a database transaction
which can fail and roll back. Rather, it means that all of the changes in the
request will be forcibly applied to the database, even if that introduces
conflicts. The only guarantee you are given is that they will either all be
applied to the database, or none of them (e.g. if the power is pulled out before
the update is finished writing to disk).</p>
<p>So this gives you a way to introduce conflicts within a single database
instance. If you choose to do this instead of PUT, it means you don&#8217;t have to
write any code for the possibility of getting a 409 response, because you will
never get one. Rather, you have to deal with conflicts appearing later in the
database, which is what you&#8217;d have to do in a multi-master application anyway.</p>
<div class="highlight-http"><div class="highlight"><pre>POST /db/_bulk_docs
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;all_or_nothing&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="s2">&quot;docs&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-xxx&quot;</span><span class="p">,</span> <span class="p">...},</span>
    <span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-yyy&quot;</span><span class="p">,</span> <span class="p">...},</span>
    <span class="p">...</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="revision-tree">
<h4>Revision tree<a class="headerlink" href="#revision-tree" title="Permalink to this headline">¶</a></h4>
<p>When you update a document in CouchDB, it keeps a list of the previous
revisions. In the case where conflicting updates are introduced, this history
branches into a tree, where the current conflicting revisions for this document
form the tips (leaf nodes) of this tree:</p>
<div class="highlight-text"><div class="highlight"><pre>  ,--&gt; r2a
r1 --&gt; r2b
  `--&gt; r2c
</pre></div>
</div>
<p>Each branch can then extend its history - for example if you read revision r2b
and then PUT with ?rev=r2b then you will make a new revision along that
particular branch.</p>
<div class="highlight-text"><div class="highlight"><pre>  ,--&gt; r2a -&gt; r3a -&gt; r4a
r1 --&gt; r2b -&gt; r3b
  `--&gt; r2c -&gt; r3c
</pre></div>
</div>
<p>Here, (r4a, r3b, r3c) are the set of conflicting revisions. The way you resolve
a conflict is to delete the leaf nodes along the other branches. So when you
combine (r4a+r3b+r3c) into a single merged document, you would replace r4a and
delete r3b and r3c.</p>
<div class="highlight-text"><div class="highlight"><pre>  ,--&gt; r2a -&gt; r3a -&gt; r4a -&gt; r5a
r1 --&gt; r2b -&gt; r3b -&gt; (r4b deleted)
  `--&gt; r2c -&gt; r3c -&gt; (r4c deleted)
</pre></div>
</div>
<p>Note that r4b and r4c still exist as leaf nodes in the history tree, but as
deleted docs. You can retrieve them but they will be marked <tt class="docutils literal"><span class="pre">&quot;_deleted&quot;:true</span></tt>.</p>
<p>When you compact a database, the bodies of all the non-leaf documents are
discarded. However, the list of historical _revs is retained, for the benefit of
later conflict resolution in case you meet any old replicas of the database at
some time in future. There is &#8220;revision pruning&#8221; to stop this getting
arbitrarily large.</p>
</div>
<div class="section" id="working-with-conflicting-documents">
<h4>Working with conflicting documents<a class="headerlink" href="#working-with-conflicting-documents" title="Permalink to this headline">¶</a></h4>
<p>The basic <em>:get:`/{doc}/{docid}`</em> operation will not show you any
information about conflicts. You see only the deterministically-chosen winner,
and get no indication as to whether other conflicting revisions exist or not:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-b91bb807b4685080c6a651115ff558f5&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hello&quot;</span><span class="o">:</span><span class="s2">&quot;bar&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you do <tt class="docutils literal"><span class="pre">GET</span> <span class="pre">/db/bob?conflicts=true</span></tt>, and the document is in a conflict
state, then you will get the winner plus a _conflicts member containing an array
of the revs of the other, conflicting revision(s). You can then fetch them
individually using subsequent <tt class="docutils literal"><span class="pre">GET</span> <span class="pre">/db/bob?rev=xxxx</span></tt> operations:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-b91bb807b4685080c6a651115ff558f5&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hello&quot;</span><span class="o">:</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_conflicts&quot;</span><span class="o">:</span><span class="p">[</span>
    <span class="s2">&quot;2-65db2a11b5172bf928e3bcf59f728970&quot;</span><span class="p">,</span>
    <span class="s2">&quot;2-5bc3c6319edf62d4c624277fdd0ae191&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you do <tt class="docutils literal"><span class="pre">GET</span> <span class="pre">/db/bob?open_revs=all</span></tt> then you will get all the leaf nodes of
the revision tree. This will give you all the current conflicts, but will also
give you leaf nodes which have been deleted (i.e. parts of the conflict history
which have since been resolved). You can remove these by filtering out documents
with <tt class="docutils literal"><span class="pre">&quot;_deleted&quot;:true</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span>
  <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-5bc3c6319edf62d4c624277fdd0ae191&quot;</span><span class="p">,</span><span class="s2">&quot;hello&quot;</span><span class="o">:</span><span class="s2">&quot;foo&quot;</span><span class="p">}},</span>
  <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-65db2a11b5172bf928e3bcf59f728970&quot;</span><span class="p">,</span><span class="s2">&quot;hello&quot;</span><span class="o">:</span><span class="s2">&quot;baz&quot;</span><span class="p">}},</span>
  <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-b91bb807b4685080c6a651115ff558f5&quot;</span><span class="p">,</span><span class="s2">&quot;hello&quot;</span><span class="o">:</span><span class="s2">&quot;bar&quot;</span><span class="p">}}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">&quot;ok&quot;</span></tt> tag is an artifact of <tt class="docutils literal"><span class="pre">open_revs</span></tt>, which also lets you list
explicit revisions as a JSON array, e.g. <tt class="docutils literal"><span class="pre">open_revs=[rev1,rev2,rev3]</span></tt>. In this
form, it would be possible to request a revision which is now missing, because
the database has been compacted.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The order of revisions returned by <tt class="docutils literal"><span class="pre">open_revs=all</span></tt> is <strong>NOT</strong> related to
the deterministic &#8220;winning&#8221; algorithm. In the above example, the winning
revision is 2-b91b... and happens to be returned last, but in other cases it
can be returned in a different position.</p>
</div>
<p>Once you have retrieved all the conflicting revisions, your application can then
choose to display them all to the user. Or it could attempt to merge them, write
back the merged version, and delete the conflicting versions - that is, to
resolve the conflict permanently.</p>
<p>As described above, you need to update one revision and delete all the
conflicting revisions explicitly. This can be done using a single <cite>POST</cite> to
<tt class="docutils literal"><span class="pre">_bulk_docs</span></tt>, setting <tt class="docutils literal"><span class="pre">&quot;_deleted&quot;:true</span></tt> on those revisions you wish to
delete.</p>
</div>
<div class="section" id="multiple-document-api">
<h4>Multiple document API<a class="headerlink" href="#multiple-document-api" title="Permalink to this headline">¶</a></h4>
<p>You can fetch multiple documents at once using <tt class="docutils literal"><span class="pre">include_docs=true</span></tt> on a view.
However, a <tt class="docutils literal"><span class="pre">conflicts=true</span></tt> request is ignored; the &#8220;doc&#8221; part of the value
never includes a <tt class="docutils literal"><span class="pre">_conflicts</span></tt> member. Hence you would need to do another query
to determine for each document whether it is in a conflicting state:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>curl <span class="s1">&#39;http://127.0.0.1:5984/conflict_test/_all_docs?include_docs=true&amp;conflicts=true&#39;</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;total_rows&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;offset&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
      <span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
      <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-b91bb807b4685080c6a651115ff558f5&quot;</span><span class="p">},</span>
      <span class="s2">&quot;doc&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-b91bb807b4685080c6a651115ff558f5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hello&quot;</span><span class="o">:</span><span class="s2">&quot;bar&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>curl <span class="s1">&#39;http://127.0.0.1:5984/conflict_test/test?conflicts=true&#39;</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-b91bb807b4685080c6a651115ff558f5&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hello&quot;</span><span class="o">:</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_conflicts&quot;</span><span class="o">:</span><span class="p">[</span>
    <span class="s2">&quot;2-65db2a11b5172bf928e3bcf59f728970&quot;</span><span class="p">,</span>
    <span class="s2">&quot;2-5bc3c6319edf62d4c624277fdd0ae191&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="view-map-functions">
<h4>View map functions<a class="headerlink" href="#view-map-functions" title="Permalink to this headline">¶</a></h4>
<p>Views only get the winning revision of a document. However they do also get a
<tt class="docutils literal"><span class="pre">_conflicts</span></tt> member if there are any conflicting revisions. This means you can
write a view whose job is specifically to locate documents with conflicts.
Here is a simple map function which achieves this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_conflicts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_conflicts</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which gives the following output:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;total_rows&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;offset&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
      <span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span>
      <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="p">[</span>
        <span class="s2">&quot;2-b91bb807b4685080c6a651115ff558f5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2-65db2a11b5172bf928e3bcf59f728970&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2-5bc3c6319edf62d4c624277fdd0ae191&quot;</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you do this, you can have a separate &#8220;sweep&#8221; process which periodically scans
your database, looks for documents which have conflicts, fetches the conflicting
revisions, and resolves them.</p>
<p>Whilst this keeps the main application simple, the problem with this approach is
that there will be a window between a conflict being introduced and it being
resolved. From a user&#8217;s viewpoint, this may appear that the document they just
saved successfully may suddenly lose their changes, only to be resurrected some
time later. This may or may not be acceptable.</p>
<p>Also, it&#8217;s easy to forget to start the sweeper, or not to implement it properly,
and this will introduce odd behaviour which will be hard to track down.</p>
<p>CouchDB&#8217;s &#8220;winning&#8221; revision algorithm may mean that information drops out of a
view until a conflict has been resolved. Consider Bob&#8217;s business card again;
suppose Alice has a view which emits mobile numbers, so that her telephony
application can display the caller&#8217;s name based on caller ID. If there are
conflicting documents with Bob&#8217;s old and new mobile numbers, and they happen to
be resolved in favour of Bob&#8217;s old number, then the view won&#8217;t be able to
recognise his new one. In this particular case, the application might have
preferred to put information from both the conflicting documents into the view,
but this currently isn&#8217;t possible.</p>
<p>Suggested algorithm to fetch a document with conflict resolution:</p>
<ol class="arabic simple">
<li>Get document via <tt class="docutils literal"><span class="pre">GET</span> <span class="pre">docid?conflicts=true</span></tt> request;</li>
<li>For each member in the <tt class="docutils literal"><span class="pre">_conflicts</span></tt> array call <tt class="docutils literal"><span class="pre">GET</span> <span class="pre">docid?rev=xxx</span></tt>.
If any errors occur at this stage, restart from step 1.
(There could be a race where someone else has already resolved this conflict
and deleted that rev)</li>
<li>Perform application-specific merging</li>
<li>Write <tt class="docutils literal"><span class="pre">_bulk_docs</span></tt> with an update to the first rev and deletes of the other
revs.</li>
</ol>
<p>This could either be done on every read (in which case you could replace all
calls to GET in your application with calls to a library which does the above),
or as part of your sweeper code.</p>
<p>And here is an example of this in Ruby using the low-level <a class="reference external" href="https://rubygems.org/gems/rest-client">RestClient</a>:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;rest_client&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
<span class="no">DB</span><span class="o">=</span><span class="s2">&quot;http://127.0.0.1:5984/conflict_test&quot;</span>

<span class="c1"># Write multiple documents as all_or_nothing, can introduce conflicts</span>
<span class="k">def</span> <span class="nf">writem</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
  <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">RestClient</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">DB</span><span class="si">}</span><span class="s2">/_bulk_docs&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s2">&quot;all_or_nothing&quot;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
    <span class="s2">&quot;docs&quot;</span> <span class="o">=&gt;</span> <span class="n">docs</span><span class="p">,</span>
  <span class="p">}</span><span class="o">.</span><span class="n">to_json</span><span class="p">))</span>
<span class="k">end</span>

<span class="c1"># Write one document, return the rev</span>
<span class="k">def</span> <span class="nf">write1</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">rev</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
  <span class="n">doc</span><span class="o">[</span><span class="s1">&#39;_id&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="nb">id</span> <span class="k">if</span> <span class="nb">id</span>
  <span class="n">doc</span><span class="o">[</span><span class="s1">&#39;_rev&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="n">rev</span> <span class="k">if</span> <span class="n">rev</span>
  <span class="n">writem</span><span class="p">(</span><span class="o">[</span><span class="n">doc</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="s1">&#39;rev&#39;</span><span class="o">]</span>
<span class="k">end</span>

<span class="c1"># Read a document, return *all* revs</span>
<span class="k">def</span> <span class="nf">read1</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kp">loop</span> <span class="k">do</span>
    <span class="c1"># FIXME: escape id</span>
    <span class="n">res</span> <span class="o">=</span> <span class="o">[</span><span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">DB</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">?conflicts=true&quot;</span><span class="p">))</span><span class="o">]</span>
    <span class="k">if</span> <span class="n">revs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s1">&#39;_conflicts&#39;</span><span class="p">)</span>
      <span class="k">begin</span>
        <span class="n">revs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">rev</span><span class="o">|</span>
          <span class="n">res</span> <span class="o">&lt;&lt;</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">DB</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="nb">id</span><span class="si">}</span><span class="s2">?rev=</span><span class="si">#{</span><span class="n">rev</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">end</span>
      <span class="k">rescue</span>
        <span class="n">retries</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">raise</span> <span class="k">if</span> <span class="n">retries</span> <span class="o">&gt;=</span> <span class="mi">5</span>
        <span class="k">next</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">res</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># Create DB</span>
<span class="no">RestClient</span><span class="o">.</span><span class="n">delete</span> <span class="no">DB</span> <span class="k">rescue</span> <span class="kp">nil</span>
<span class="no">RestClient</span><span class="o">.</span><span class="n">put</span> <span class="no">DB</span><span class="p">,</span> <span class="p">{}</span><span class="o">.</span><span class="n">to_json</span>

<span class="c1"># Write a document</span>
<span class="n">rev1</span> <span class="o">=</span> <span class="n">write1</span><span class="p">({</span><span class="s2">&quot;hello&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;xxx&quot;</span><span class="p">},</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="nb">p</span> <span class="n">read1</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>

<span class="c1"># Make three conflicting versions</span>
<span class="n">write1</span><span class="p">({</span><span class="s2">&quot;hello&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;foo&quot;</span><span class="p">},</span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="n">rev1</span><span class="p">)</span>
<span class="n">write1</span><span class="p">({</span><span class="s2">&quot;hello&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;bar&quot;</span><span class="p">},</span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="n">rev1</span><span class="p">)</span>
<span class="n">write1</span><span class="p">({</span><span class="s2">&quot;hello&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;baz&quot;</span><span class="p">},</span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="n">rev1</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">read1</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
<span class="nb">p</span> <span class="n">res</span>

<span class="c1"># Now let&#39;s replace these three with one</span>
<span class="n">res</span><span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="s1">&#39;hello&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;foo+bar+baz&quot;</span>
<span class="n">res</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="p">,</span><span class="n">i</span><span class="o">|</span>
  <span class="k">unless</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">r</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;_id&#39;</span><span class="o">=&gt;</span><span class="n">r</span><span class="o">[</span><span class="s1">&#39;_id&#39;</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;_rev&#39;</span><span class="o">=&gt;</span><span class="n">r</span><span class="o">[</span><span class="s1">&#39;_rev&#39;</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;_deleted&#39;</span><span class="o">=&gt;</span><span class="kp">true</span><span class="p">})</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">writem</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="nb">p</span> <span class="n">read1</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>An application written this way never has to deal with a <tt class="docutils literal"><span class="pre">PUT</span> <span class="pre">409</span></tt>, and is
automatically multi-master capable.</p>
<p>You can see that it&#8217;s straightforward enough when you know what you&#8217;re doing.
It&#8217;s just that CouchDB doesn&#8217;t currently provide a convenient HTTP API for
&#8220;fetch all conflicting revisions&#8221;, nor &#8220;PUT to supersede these N revisions&#8221;, so
you need to wrap these yourself. I also don&#8217;t know of any client-side libraries
which provide support for this.</p>
</div>
<div class="section" id="merging-and-revision-history">
<h4>Merging and revision history<a class="headerlink" href="#merging-and-revision-history" title="Permalink to this headline">¶</a></h4>
<p>Actually performing the merge is an application-specific function. It depends
on the structure of your data. Sometimes it will be easy: e.g. if a document
contains a list which is only ever appended to, then you can perform a union of
the two list versions.</p>
<p>Some merge strategies look at the changes made to an object, compared to its
previous version. This is how git&#8217;s merge function works.</p>
<p>For example, to merge Bob&#8217;s business card versions v2a and v2b, you could look
at the differences between v1 and v2b, and then apply these changes to v2a as
well.</p>
<p>With CouchDB, you can sometimes get hold of old revisions of a document.
For example, if you fetch <tt class="docutils literal"><span class="pre">/db/bob?rev=v2b&amp;revs_info=true</span></tt> you&#8217;ll get a list
of the previous revision ids which ended up with revision v2b. Doing the same
for v2a you can find their common ancestor revision. However if the database
has been compacted, the content of that document revision will have been lost.
<tt class="docutils literal"><span class="pre">revs_info</span></tt> will still show that v1 was an ancestor, but report it as
&#8220;missing&#8221;:</p>
<div class="highlight-ini"><div class="highlight"><pre>BEFORE COMPACTION           AFTER COMPACTION

     ,-&gt; v2a                     v2a
   v1
     `-&gt; v2b                     v2b
</pre></div>
</div>
<p>So if you want to work with diffs, the recommended way is to store those diffs
within the new revision itself. That is: when you replace v1 with v2a, include
an extra field or attachment in v2a which says which fields were changed from
v1 to v2a. This unfortunately does mean additional book-keeping for your
application.</p>
</div>
<div class="section" id="comparison-with-other-replicating-data-stores">
<h4>Comparison with other replicating data stores<a class="headerlink" href="#comparison-with-other-replicating-data-stores" title="Permalink to this headline">¶</a></h4>
<p>The same issues arise with other replicating systems, so it can be instructive
to look at these and see how they compare with CouchDB. Please feel free to add
other examples.</p>
<div class="section" id="unison">
<h5>Unison<a class="headerlink" href="#unison" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="http://www.cis.upenn.edu/~bcpierce/unison/">Unison</a> is a bi-directional file synchronisation tool. In this case, the
business card would be a file, say <cite>bob.vcf</cite>.</p>
<p>When you run unison, changes propagate both ways. If a file has changed on one
side but not the other, the new replaces the old. Unison maintains a local state
file so that it knows whether a file has changed since the last successful
replication.</p>
<p>In our example it has changed on both sides. Only one file called <cite>bob.vcf</cite>
can exist within the filesystem. Unison solves the problem by simply ducking
out: the user can choose to replace the remote version with the local version,
or vice versa (both of which would lose data), but the default action is to
leave both sides unchanged.</p>
<p>From Alice&#8217;s point of view, at least this is a simple solution. Whenever she&#8217;s
on the desktop she&#8217;ll see the version she last edited on the desktop, and
whenever she&#8217;s on the laptop she&#8217;ll see the version she last edited there.</p>
<p>But because no replication has actually taken place, the data is not protected.
If her laptop hard drive dies, she&#8217;ll lose all her changes made on the laptop;
ditto if her desktop hard drive dies.</p>
<p>It&#8217;s up to her to copy across one of the versions manually (under a different
filename), merge the two, and then finally push the merged version to the other
side.</p>
<p>Note also that the original file (version v1) has been lost by this point.
So it&#8217;s not going to be known from inspection alone which of v2a and v2b has the
most up-to-date E-mail address for Bob, and which has the most up-to-date mobile
number. Alice has to remember which she entered last.</p>
</div>
<div class="section" id="git">
<h5>Git<a class="headerlink" href="#git" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="http://git-scm.com/">Git</a> is a well-known distributed source control system. Like Unison, git deals
with files. However, git considers the state of a whole set of files as a single
object, the &#8220;tree&#8221;. Whenever you save an update, you create a &#8220;commit&#8221; which
points to both the updated tree and the previous commit(s), which in turn point
to the previous tree(s). You therefore have a full history of all the states of
the files. This forms a branch, and a pointer is kept to the tip of the branch,
from which you can work backwards to any previous state. The &#8220;pointer&#8221; is
actually an SHA1 hash of the tip commit.</p>
<p>If you are replicating with one or more peers, a separate branch is made for
each of the peers. For example, you might have:</p>
<div class="highlight-ini"><div class="highlight"><pre>master               -- my local branch
remotes/foo/master   -- branch on peer &#39;foo&#39;
remotes/bar/master   -- branch on peer &#39;bar&#39;
</pre></div>
</div>
<p>In the normal way of working, replication is a &#8220;pull&#8221;, importing changes from
a remote peer into the local repository. A &#8220;pull&#8221; does two things: first &#8220;fetch&#8221;
the state of the peer into the remote tracking branch for that peer; and then
attempt to &#8220;merge&#8221; those changes into the local branch.</p>
<p>Now let&#8217;s consider the business card. Alice has created a git repo containing
<tt class="docutils literal"><span class="pre">bob.vcf</span></tt>, and cloned it across to the other machine. The branches look like
this, where <tt class="docutils literal"><span class="pre">AAAAAAAA</span></tt> is the SHA1 of the commit:</p>
<div class="highlight-ini"><div class="highlight"><pre>---------- desktop ----------           ---------- laptop ----------
master: AAAAAAAA                        master: AAAAAAAA
remotes/laptop/master: AAAAAAAA         remotes/desktop/master: AAAAAAAA
</pre></div>
</div>
<p>Now she makes a change on the desktop, and commits it into the desktop repo;
then she makes a different change on the laptop, and commits it into the laptop
repo:</p>
<div class="highlight-ini"><div class="highlight"><pre>---------- desktop ----------           ---------- laptop ----------
master: BBBBBBBB                        master: CCCCCCCC
remotes/laptop/master: AAAAAAAA         remotes/desktop/master: AAAAAAAA
</pre></div>
</div>
<p>Now on the desktop she does <tt class="docutils literal"><span class="pre">git</span> <span class="pre">pull</span> <span class="pre">laptop</span></tt>. Firstly, the remote objects
are copied across into the local repo and the remote tracking branch is
updated:</p>
<div class="highlight-ini"><div class="highlight"><pre>---------- desktop ----------           ---------- laptop ----------
master: BBBBBBBB                        master: CCCCCCCC
remotes/laptop/master: CCCCCCCC         remotes/desktop/master: AAAAAAAA
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">repo still contains AAAAAAAA because commits BBBBBBBB and CCCCCCCC point to it</p>
</div>
<p>Then git will attempt to merge the changes in. It can do this because it knows
the parent commit to <tt class="docutils literal"><span class="pre">CCCCCCCC</span></tt> is <tt class="docutils literal"><span class="pre">AAAAAAAA</span></tt>, so it takes a diff between
<tt class="docutils literal"><span class="pre">AAAAAAAA</span></tt> and <tt class="docutils literal"><span class="pre">CCCCCCCC</span></tt> and tries to apply it to <tt class="docutils literal"><span class="pre">BBBBBBBB</span></tt>.</p>
<p>If this is successful, then you&#8217;ll get a new version with a merge commit:</p>
<div class="highlight-ini"><div class="highlight"><pre>---------- desktop ----------           ---------- laptop ----------
master: DDDDDDDD                        master: CCCCCCCC
remotes/laptop/master: CCCCCCCC         remotes/desktop/master: AAAAAAAA
</pre></div>
</div>
<p>Then Alice has to logon to the laptop and run <tt class="docutils literal"><span class="pre">git</span> <span class="pre">pull</span> <span class="pre">desktop</span></tt>. A similar
process occurs. The remote tracking branch is updated:</p>
<div class="highlight-ini"><div class="highlight"><pre>---------- desktop ----------           ---------- laptop ----------
master: DDDDDDDD                        master: CCCCCCCC
remotes/laptop/master: CCCCCCCC         remotes/desktop/master: DDDDDDDD
</pre></div>
</div>
<p>Then a merge takes place. This is a special-case: <tt class="docutils literal"><span class="pre">CCCCCCCC</span></tt> one of the parent
commits of <tt class="docutils literal"><span class="pre">DDDDDDDD</span></tt>, so the laptop can <cite>fast forward</cite> update from
<tt class="docutils literal"><span class="pre">CCCCCCCC</span></tt> to <tt class="docutils literal"><span class="pre">DDDDDDDD</span></tt> directly without having to do any complex merging.
This leaves the final state as:</p>
<div class="highlight-ini"><div class="highlight"><pre>---------- desktop ----------           ---------- laptop ----------
master: DDDDDDDD                        master: DDDDDDDD
remotes/laptop/master: CCCCCCCC         remotes/desktop/master: DDDDDDDD
</pre></div>
</div>
<p>Now this is all and good, but you may wonder how this is relevant when thinking
about CouchDB.</p>
<p>Firstly, note what happens in the case when the merge algorithm fails.
The changes are still propagated from the remote repo into the local one, and
are available in the remote tracking branch; so unlike Unison, you know the data
is protected. It&#8217;s just that the local working copy may fail to update, or may
diverge from the remote version. It&#8217;s up to you to create and commit the
combined version yourself, but you are guaranteed to have all the history you
might need to do this.</p>
<p>Note that whilst it&#8217;s possible to build new merge algorithms into Git,
the standard ones are focused on line-based changes to source code. They don&#8217;t
work well for XML or JSON if it&#8217;s presented without any line breaks.</p>
<p>The other interesting consideration is multiple peers. In this case you have
multiple remote tracking branches, some of which may match your local branch,
some of which may be behind you, and some of which may be ahead of you
(i.e. contain changes that you haven&#8217;t yet merged):</p>
<div class="highlight-ini"><div class="highlight"><pre>master: AAAAAAAA
remotes/foo/master: BBBBBBBB
remotes/bar/master: CCCCCCCC
remotes/baz/master: AAAAAAAA
</pre></div>
</div>
<p>Note that each peer is explicitly tracked, and therefore has to be explicitly
created. If a peer becomes stale or is no longer needed, it&#8217;s up to you to
remove it from your configuration and delete the remote tracking branch.
This is different to CouchDB, which doesn&#8217;t keep any peer state in the database.</p>
<p>Another difference with git is that it maintains all history back to time
zero - git compaction keeps diffs between all those versions in order to reduce
size, but CouchDB discards them. If you are constantly updating a document,
the size of a git repo would grow forever. It is possible (with some effort)
to use &#8220;history rewriting&#8221; to make git forget commits earlier than a particular
one.</p>
<div class="section" id="what-is-the-couchdb-replication-protocol-is-it-like-git">
<span id="replication-conflicts-git"></span><h6>What is the CouchDB replication protocol? Is it like Git?<a class="headerlink" href="#what-is-the-couchdb-replication-protocol-is-it-like-git" title="Permalink to this headline">¶</a></h6>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Jason Smith</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">2011-01-29</td>
</tr>
<tr class="field-odd field"><th class="field-name">Source:</th><td class="field-body"><a class="reference external" href="http://stackoverflow.com/questions/4766391/what-is-the-couchdb-replication-protocol-is-it-like-git">http://stackoverflow.com/questions/4766391/what-is-the-couchdb-replication-protocol-is-it-like-git</a></td>
</tr>
</tbody>
</table>
<p><strong>Key points</strong></p>
<p><strong>If you know Git, then you know how Couch replication works.</strong> Replicating is
<em>very</em> similar to pushing or pulling with distributed source managers like Git.</p>
<p><strong>CouchDB replication does not have its own protocol.</strong> A replicator simply
connects to two DBs as a client, then reads from one and writes to the other.
Push replication is reading the local data and updating the remote DB;
pull replication is vice versa.</p>
<ul class="simple">
<li><strong>Fun fact 1</strong>: The replicator is actually an independent Erlang application,
in its own process. It connects to both couches, then reads records from one
and writes them to the other.</li>
<li><strong>Fun fact 2</strong>: CouchDB has no way of knowing who is a normal client and who
is a replicator (let alone whether the replication is push or pull).
It all looks like client connections. Some of them read records. Some of them
write records.</li>
</ul>
<p><strong>Everything flows from the data model</strong></p>
<p>The replication algorithm is trivial, uninteresting. A trained monkey could
design it. It&#8217;s simple because the cleverness is the data model, which has these
useful characteristics:</p>
<ol class="arabic simple">
<li>Every record in CouchDB is completely independent of all others. That sucks
if you want to do a JOIN or a transaction, but it&#8217;s awesome if you want to
write a replicator. Just figure out how to replicate one record, and then
repeat that for each record.</li>
<li>Like Git, records have a linked-list revision history. A record&#8217;s revision ID
is the checksum of its own data. Subsequent revision IDs are checksums of:
the new data, plus the revision ID of the previous.</li>
<li>In addition to application data (<tt class="docutils literal"><span class="pre">{&quot;name&quot;:</span> <span class="pre">&quot;Jason&quot;,</span> <span class="pre">&quot;awesome&quot;:</span> <span class="pre">true}</span></tt>),
every record stores the evolutionary timeline of all previous revision IDs
leading up to itself.<ul>
<li>Exercise: Take a moment of quiet reflection. Consider any two different
records, A and B. If A&#8217;s revision ID appears in B&#8217;s timeline, then B
definitely evolved from A. Now consider Git&#8217;s fast-forward merges.
Do you hear that? That is the sound of your mind being blown.</li>
</ul>
</li>
<li>Git isn&#8217;t really a linear list. It has forks, when one parent has multiple
children. CouchDB has that too.<ul>
<li>Exercise: Compare two different records, A and B. A&#8217;s revision ID does not
appear in B&#8217;s timeline; however, one revision ID, C, is in both A&#8217;s and B&#8217;s
timeline. Thus A didn&#8217;t evolve from B. B didn&#8217;t evolve from A. But rather,
A and B have a common ancestor C. In Git, that is a &#8220;fork.&#8221; In CouchDB,
it&#8217;s a &#8220;conflict.&#8221;</li>
<li>In Git, if both children go on to develop their timelines independently,
that&#8217;s cool. Forks totally support that.</li>
<li>In CouchDB, if both children go on to develop their timelines
independently, that cool too. Conflicts totally support that.</li>
<li><strong>Fun fact 3</strong>: CouchDB &#8220;conflicts&#8221; do not correspond to Git &#8220;conflicts.&#8221;
A Couch conflict is a divergent revision history, what Git calls a &#8220;fork.&#8221;
For this reason the CouchDB community pronounces &#8220;conflict&#8221; with a silent
<cite>n</cite>: &#8220;co-flicked.&#8221;</li>
</ul>
</li>
<li>Git also has merges, when one child has multiple parents. CouchDB <em>sort</em> of
has that too.<ul>
<li><strong>In the data model, there is no merge.</strong> The client simply marks one
timeline as deleted and continues to work with the only extant timeline.</li>
<li><strong>In the application, it feels like a merge.</strong> Typically, the client merges
the <em>data</em> from each timeline in an application-specific way.
Then it writes the new data to the timeline. In Git, this is like copying
and pasting the changes from branch A into branch B, then commiting to
branch B and deleting branch A. The data was merged, but there was no
<cite>git merge</cite>.</li>
<li>These behaviors are different because, in Git, the timeline itself is
important; but in CouchDB, the data is important and the timeline is
incidental—it&#8217;s just there to support replication. That is one reason why
CouchDB&#8217;s built-in revisioning is inappropriate for storing revision data
like a wiki page.</li>
</ul>
</li>
</ol>
<p><strong>Final notes</strong></p>
<p>At least one sentence in this writeup (possibly this one) is complete BS.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<span id="document-maintenance/index"></span><div class="section" id="couchdb-maintenance">
<h2>CouchDB Maintenance<a class="headerlink" href="#couchdb-maintenance" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-maintenance/compaction"></span><div class="section" id="compaction">
<span id="compact"></span><h3>Compaction<a class="headerlink" href="#compaction" title="Permalink to this headline">¶</a></h3>
<p>The <cite>compaction</cite> operation is the way to reduce disk space usage by removing
unused and old data from database or view index files. This operation is a very
similar to the <cite>vacuum</cite> (<a class="reference external" href="http://www.sqlite.org/lang_vacuum.html">SQLite</a> ex.) available for other database management
systems.</p>
<p>During compaction of the <cite>target</cite> CouchDB creates new file with the <tt class="docutils literal"><span class="pre">.compact</span></tt>
extension and transfers only actual data into. Because of this, CouchDB checks
first for the available disk space - it should be <em>twice greater</em> than the
compacted file&#8217;s data.</p>
<p>When all actual data is successfully transferred to the <cite>compacted</cite> file CouchDB
replaces the <cite>target</cite> with the <cite>compacted</cite> file.</p>
<div class="section" id="database-compaction">
<span id="compact-db"></span><h4>Database Compaction<a class="headerlink" href="#database-compaction" title="Permalink to this headline">¶</a></h4>
<p>Database compaction compresses the database file by removing unused file
sections created during updates. Old documents revisions are replaced with
small amount of metadata called <cite>tombstone</cite> which are used for conflicts
resolution during replication. The number of stored revisions
(and their <cite>tombstones</cite>) can be configured by using the <a class="reference internal" href="contents.html#get--db-_revs_limit" title="GET /{db}/_revs_limit"><tt class="xref http http-get docutils literal"><span class="pre">_revs_limit</span></tt></a> URL endpoint.</p>
<p>Compaction is manually triggered operation per database and runs as a background
task. To start it for specific database there is need to send HTTP
<a class="reference internal" href="contents.html#post--db-_compact" title="POST /{db}/_compact"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_compact</span></tt></a> sub-resource of the target database:</p>
<div class="highlight-ini"><div class="highlight"><pre>curl -H &quot;Content-Type: application/json&quot; -X POST http://localhost:5984/my_db/_compact
</pre></div>
</div>
<p>On success, HTTP status <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> is returned immediately:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">202</span> <span class="ne">Accepted</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">12</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/plain; charset=utf-8</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 19 Jun 2013 09:43:52 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
<p>Although the request body is not used you must still specify
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> header with <em class="mimetype">application/json</em> value
for the request. If you don&#8217;t, you will be aware about with HTTP status
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.16">415 Unsupported Media Type</a> response:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">415</span> <span class="ne">Unsupported Media Type</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">78</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 19 Jun 2013 09:43:44 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="s2">&quot;bad_content_type&quot;</span><span class="p">,</span><span class="nt">&quot;reason&quot;</span><span class="p">:</span><span class="s2">&quot;Content-Type must be application/json&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>When the compaction is successful started and running it is possible to get
information about it via <a class="reference internal" href="contents.html#api-db"><em>database information resource</em></a>:</p>
<div class="highlight-ini"><div class="highlight"><pre>curl http://localhost:5984/my_db
</pre></div>
</div>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">246</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 19 Jun 2013 16:51:20 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;committed_update_seq&quot;</span><span class="p">:</span> <span class="mi">76215</span><span class="p">,</span>
    <span class="nt">&quot;compact_running&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;data_size&quot;</span><span class="p">:</span> <span class="mi">3787996</span><span class="p">,</span>
    <span class="nt">&quot;db_name&quot;</span><span class="p">:</span> <span class="s2">&quot;my_db&quot;</span><span class="p">,</span>
    <span class="nt">&quot;disk_format_version&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="nt">&quot;disk_size&quot;</span><span class="p">:</span> <span class="mi">17703025</span><span class="p">,</span>
    <span class="nt">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">5091</span><span class="p">,</span>
    <span class="nt">&quot;doc_del_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;instance_start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;1371660751878859&quot;</span><span class="p">,</span>
    <span class="nt">&quot;purge_seq&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;update_seq&quot;</span><span class="p">:</span> <span class="mi">76215</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that <tt class="docutils literal"><span class="pre">compaction_running</span></tt> field is <tt class="docutils literal"><span class="pre">true</span></tt> indicating that compaction
is actually running. To track the compaction progress you may query the
<a class="reference internal" href="contents.html#get--_active_tasks" title="GET /_active_tasks"><tt class="xref http http-get docutils literal"><span class="pre">_active_tasks</span></tt></a> resource:</p>
<div class="highlight-ini"><div class="highlight"><pre>curl http://localhost:5984/my_db
</pre></div>
</div>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">175</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 19 Jun 2013 16:27:23 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;changes_done&quot;</span><span class="p">:</span> <span class="mi">44461</span><span class="p">,</span>
        <span class="nt">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;my_db&quot;</span><span class="p">,</span>
        <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;0.218.0&gt;&quot;</span><span class="p">,</span>
        <span class="nt">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">58</span><span class="p">,</span>
        <span class="nt">&quot;started_on&quot;</span><span class="p">:</span> <span class="mi">1371659228</span><span class="p">,</span>
        <span class="nt">&quot;total_changes&quot;</span><span class="p">:</span> <span class="mi">76215</span><span class="p">,</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;database_compaction&quot;</span><span class="p">,</span>
        <span class="nt">&quot;updated_on&quot;</span><span class="p">:</span> <span class="mi">1371659241</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="views-compaction">
<span id="compact-views"></span><h4>Views Compaction<a class="headerlink" href="#views-compaction" title="Permalink to this headline">¶</a></h4>
<p><cite>Views</cite> are also need compaction like databases, unlike databases views
are compacted by groups per <cite>design document</cite>. To start their compaction there
is need to send HTTP <a class="reference internal" href="contents.html#post--db-_compact-ddoc" title="POST /{db}/_compact/{ddoc}"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_compact/{ddoc}</span></tt></a> request:</p>
<div class="highlight-ini"><div class="highlight"><pre>curl -H &quot;Content-Type: application/json&quot; -X POST http://localhost:5984/dbname/_compact/designname
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
<p>This compacts the view index from the current version of the specified design
document. The HTTP response code is <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a>
(like <a class="reference internal" href="contents.html#compact-db"><em>compaction for databases</em></a>) and a compaction background
task will be created.</p>
<div class="section" id="views-cleanup">
<span id="compact-views-cleanup"></span><h5>Views cleanup<a class="headerlink" href="#views-cleanup" title="Permalink to this headline">¶</a></h5>
<p>View indexes on disk are named after their <cite>MD5</cite> hash of the view definition.
When you change a view, old indexes remain on disk. To clean up all outdated
view indexes (files named after the MD5 representation of views, that does not
exist anymore) you can trigger a <a class="reference internal" href="contents.html#api-db-view-cleanup"><em>view cleanup</em></a>:</p>
<div class="highlight-ini"><div class="highlight"><pre>curl -H &quot;Content-Type: application/json&quot; -X POST http://localhost:5984/dbname/_view_cleanup
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="automatic-compaction">
<span id="compact-auto"></span><h4>Automatic Compaction<a class="headerlink" href="#automatic-compaction" title="Permalink to this headline">¶</a></h4>
<p>While both <a class="reference internal" href="contents.html#compact-db"><em>database</em></a> and <a class="reference internal" href="contents.html#compact-views"><em>views</em></a>
compactions are required be manually triggered, it is also possible to configure
automatic compaction, so that compaction of databases and views is automatically
triggered based on various criteria. Automatic compaction is configured in
CouchDB&#8217;s <a class="reference internal" href="contents.html#config-intro"><em>configuration files</em></a>.</p>
<p>The <a class="reference internal" href="contents.html#daemons/compaction_daemon" title="compaction_daemon"><tt class="xref config config-option docutils literal"><span class="pre">daemons/compaction_daemon</span></tt></a> is responsible for triggering
the compaction. It is automatically started, but disabled by default.
The criteria for triggering the compactions is configured in the
<a class="reference internal" href="contents.html#compactions" title="[compactions]"><tt class="xref config config-section docutils literal"><span class="pre">compactions</span></tt></a> section.</p>
</div>
</div>
<span id="document-maintenance/performance"></span><div class="section" id="performance">
<span id="id1"></span><h3>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h3>
<p>With up to tens of thousands of documents you will generally find CouchDB to
perform well no matter how you write your code. Once you start getting into
the millions of documents you need to be a lot more careful.</p>
<div class="section" id="disk-i-o">
<h4>Disk I/O<a class="headerlink" href="#disk-i-o" title="Permalink to this headline">¶</a></h4>
<div class="section" id="file-size">
<h5>File Size<a class="headerlink" href="#file-size" title="Permalink to this headline">¶</a></h5>
<p>The smaller your file size, the less <cite>I/O</cite> operations there will be,
the more of the file can be cached by CouchDB and the operating system,
the quicker it is to replicate, backup etc. Consequently you should carefully
examine the data you are storing. For example it would be silly to use keys
that are hundreds of characters long, but your program would be hard to
maintain if you only used single character keys. Carefully consider data
that is duplicated by putting it in views.</p>
</div>
<div class="section" id="disk-and-file-system-performance">
<h5>Disk and File System Performance<a class="headerlink" href="#disk-and-file-system-performance" title="Permalink to this headline">¶</a></h5>
<p>Using faster disks, striped RAID arrays and modern file systems can all speed
up your CouchDB deployment. However, there is one option that can increase
the responsiveness of your CouchDB server when disk performance is a
bottleneck. From the Erlang documentation for the file module:</p>
<blockquote>
<div>On operating systems with thread support, it is possible to let file
operations be performed in threads of their own, allowing other Erlang
processes to continue executing in parallel with the file operations.
See the <a class="reference external" href="http://erlang.org/doc/man/erl.html">command line flag +A in erl(1)</a>.</div></blockquote>
<p>Setting this argument to a number greater than zero can keep your CouchDB
installation responsive even during periods of heavy disk utilization. The
easiest way to set this option is through the <tt class="docutils literal"><span class="pre">ERL_FLAGS</span></tt> environment
variable. For example, to give Erlang four threads with which to perform I/O
operations add the following to <tt class="docutils literal"><span class="pre">(prefix)/etc/defaults/couchdb</span></tt>
(or equivalent):</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">export ERL_FLAGS</span><span class="o">=</span><span class="s">&quot;+A 4&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="system-resource-limits">
<h4>System Resource Limits<a class="headerlink" href="#system-resource-limits" title="Permalink to this headline">¶</a></h4>
<p>One of the problems that administrators run into as their deployments become
large are resource limits imposed by the system and by the application
configuration. Raising these limits can allow your deployment to grow beyond
what the default configuration will support.</p>
<div class="section" id="couchdb-configuration-options">
<h5>CouchDB Configuration Options<a class="headerlink" href="#couchdb-configuration-options" title="Permalink to this headline">¶</a></h5>
<div class="section" id="delayed-commits">
<h6>delayed_commits<a class="headerlink" href="#delayed-commits" title="Permalink to this headline">¶</a></h6>
<p>The <a class="reference internal" href="contents.html#couchdb/delayed_commits" title="delayed_commits"><tt class="xref config config-option docutils literal"><span class="pre">delayed</span> <span class="pre">commits</span></tt></a> allows to
achieve better write performance for some workloads while sacrificing a small
amount of durability. The setting causes CouchDB to wait up to a full second
before committing new data after an update. If the server crashes before
the header is written then any writes since the last commit are lost. Keep this
option enabled on your own risk.</p>
</div>
<div class="section" id="max-dbs-open">
<h6>max_dbs_open<a class="headerlink" href="#max-dbs-open" title="Permalink to this headline">¶</a></h6>
<p>In your <a class="reference internal" href="contents.html#config"><em>configuration</em></a> (local.ini or similar) familiarize
yourself with the <a class="reference internal" href="contents.html#couchdb/max_dbs_open" title="max_dbs_open"><tt class="xref config config-option docutils literal"><span class="pre">couchdb/max_dbs_open</span></tt></a>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[couchdb]</span>
<span class="na">max_dbs_open</span> <span class="o">=</span> <span class="s">100</span>
</pre></div>
</div>
<p>This option places an upper bound on the number of databases that can be
open at one time. CouchDB reference counts database accesses internally and
will close idle databases when it must. Sometimes it is necessary to keep
more than the default open at once, such as in deployments where many databases
will be continuously replicating.</p>
</div>
</div>
<div class="section" id="erlang">
<h5>Erlang<a class="headerlink" href="#erlang" title="Permalink to this headline">¶</a></h5>
<p>Even if you&#8217;ve increased the maximum connections CouchDB will allow,
the Erlang runtime system will not allow more than 1024 connections by
default. Adding the following directive to <tt class="docutils literal"><span class="pre">(prefix)/etc/default/couchdb</span></tt> (or
equivalent) will increase this limit (in this case to 4096):</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">export ERL_MAX_PORTS</span><span class="o">=</span><span class="s">4096</span>
</pre></div>
</div>
<p>CouchDB versions up to 1.1.x also create Erlang Term Storage (<a class="reference external" href="http://www.erlang.org/doc/man/ets.html">ETS</a>) tables for
each replication. If you are using a version of CouchDB older than 1.2 and
must support many replications, also set the <tt class="docutils literal"><span class="pre">ERL_MAX_ETS_TABLES</span></tt> variable.
The default is approximately 1400 tables.</p>
<p>Note that on Mac OS X, Erlang will not actually increase the file descriptor
limit past 1024 (i.e. the system header–defined value of <tt class="docutils literal"><span class="pre">FD_SETSIZE</span></tt>). See
<a class="reference external" href="http://erlang.org/pipermail/erlang-questions/2011-December/063119.html">this tip for a possible workaround</a> and <a class="reference external" href="http://erlang.org/pipermail/erlang-questions/2011-October/061971.html">this thread for a deeper
explanation</a>.</p>
</div>
<div class="section" id="pam-and-ulimit">
<h5>PAM and ulimit<a class="headerlink" href="#pam-and-ulimit" title="Permalink to this headline">¶</a></h5>
<p>Finally, most *nix operating systems impose various resource limits on every
process. If your system is set up to use the Pluggable Authentication Modules
(<a class="reference external" href="http://www.linux-pam.org/">PAM</a>) system, increasing this limit is straightforward. For example,
creating a file named <tt class="docutils literal"><span class="pre">/etc/security/limits.d/100-couchdb.conf</span></tt> with the
following contents will ensure that CouchDB can open enough file descriptors
to service your increased maximum open databases and Erlang ports:</p>
<div class="highlight-ini"><div class="highlight"><pre>#&lt;domain&gt;    &lt;type&gt;    &lt;item&gt;    &lt;value&gt;
couchdb      hard      nofile    4096
couchdb      soft      nofile    4096
</pre></div>
</div>
<p>If your system does not use PAM, a <cite>ulimit</cite> command is usually available for
use in a custom script to launch CouchDB with increased resource limits.
If necessary, feel free to increase this limits as long as your hardware can
handle the load.</p>
</div>
</div>
<div class="section" id="network">
<h4>Network<a class="headerlink" href="#network" title="Permalink to this headline">¶</a></h4>
<p>There is latency overhead making and receiving each request/response.
In general you should do your requests in batches. Most APIs have some
mechanism to do batches, usually by supplying lists of documents or keys in
the request body. Be careful what size you pick for the batches. The larger
batch requires more time your client has to spend encoding the items into JSON
and more time is spent decoding that number of responses. Do some benchmarking
with your own configuration and typical data to find the sweet spot.
It is likely to be between one and ten thousand documents.</p>
<p>If you have a fast I/O system then you can also use concurrency - have
multiple requests/responses at the same time. This mitigates the latency
involved in assembling JSON, doing the networking and decoding JSON.</p>
<p>As of CouchDB 1.1.0, users often report lower write performance of documents
compared to older releases. The main reason is that this release ships with
the more recent version of the HTTP server library Mochiweb, which by default
sets the TCP socket option <a class="reference external" href="http://en.wikipedia.org/wiki/Nagle%27s_algorithm">SO_NODELAY</a> to false. This means that small data
sent to the TCP socket, like the reply to a document write request (or reading
a very small document), will not be sent immediately to the network - TCP will
buffer it for a while hoping that it will be asked to send more data through
the same socket and then send all the data at once for increased performance.
This TCP buffering behaviour can be disabled via
<a class="reference internal" href="contents.html#httpd/socket_options" title="socket_options"><tt class="xref config config-option docutils literal"><span class="pre">httpd/socket_options</span></tt></a>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">socket_options</span> <span class="o">=</span> <span class="s">[{nodelay, true}]</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last">Bulk <a class="reference internal" href="contents.html#api-db-all-docs"><em>load</em></a> and <a class="reference internal" href="contents.html#api-db-bulk-docs"><em>store</em></a> API.</p>
</div>
</div>
<div class="section" id="couchdb">
<h4>CouchDB<a class="headerlink" href="#couchdb" title="Permalink to this headline">¶</a></h4>
<div class="section" id="delete-operation">
<h5>DELETE operation<a class="headerlink" href="#delete-operation" title="Permalink to this headline">¶</a></h5>
<p>When you <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.7">DELETE</a> a document the database will create a new
revision which contains the <tt class="docutils literal"><span class="pre">_id</span></tt> and <tt class="docutils literal"><span class="pre">_rev</span></tt> fields as well as
the <cite>_deleted</cite> flag. This revision will remain even after a <cite>database
compaction</cite> so that the deletion can be replicated. Deleted documents, like
non-deleted documents, can affect view build times, <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">PUT</a> and
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.7">DELETE</a> requests time and size of database on disk, since they
increase the size of the B+Tree&#8217;s. You can see the number of deleted documents
in <a class="reference internal" href="contents.html#get--db" title="GET /{db}"><tt class="xref http http-get docutils literal"><span class="pre">database</span> <span class="pre">information</span></tt></a>. If your use case creates lots of
deleted documents (for example, if you are storing short-term data like logfile
entries, message queues, etc), you might want to periodically switch to a new
database and delete the old one (once the entries in it have all expired).</p>
</div>
<div class="section" id="document-s-id">
<h5>Document&#8217;s ID<a class="headerlink" href="#document-s-id" title="Permalink to this headline">¶</a></h5>
<p>The db file size is derived from your document and view sizes but also on a
multiple of your <tt class="docutils literal"><span class="pre">_id</span></tt> sizes. Not only is the <tt class="docutils literal"><span class="pre">_id</span></tt> present in the document,
but it and parts of it are duplicated in the binary tree structure CouchDB uses
to navigate the file to find the document in the first place. As a real world
example for one user switching from 16 byte ids to 4 byte ids made a database
go from 21GB to 4GB with 10 million documents (the raw JSON text when from
2.5GB to 2GB).</p>
<p>Inserting with sequential (and at least sorted) ids is faster than random ids.
Consequently you should consider generating ids yourself, allocating them
sequentially and using an encoding scheme that consumes fewer bytes.
For example, something that takes 16 hex digits to represent can be done in
4 base 62 digits (10 numerals, 26 lower case, 26 upper case).</p>
</div>
</div>
<div class="section" id="views">
<h4>Views<a class="headerlink" href="#views" title="Permalink to this headline">¶</a></h4>
<div class="section" id="views-generation">
<h5>Views Generation<a class="headerlink" href="#views-generation" title="Permalink to this headline">¶</a></h5>
<p>Views with the Javascript query server are extremely slow to generate when
there are a non-trivial number of documents to process. The generation process
won&#8217;t even saturate a single CPU let alone your I/O. The cause is the latency
involved in the CouchDB server and separate <cite>couchjs</cite> query server, dramatically
indicating how important it is to take latency out of your implementation.</p>
<p>You can let view access be &#8220;stale&#8221; but it isn&#8217;t practical to determine when
that will occur giving you a quick response and when views will be updated
which will take a long time. (A 10 million document database took about 10
minutes to load into CouchDB but about 4 hours to do view generation).</p>
<p>View information isn&#8217;t replicated - it is rebuilt on each database so you
can&#8217;t do the view generation on a separate sever.</p>
</div>
<div class="section" id="builtin-reduce-functions">
<h5>Builtin Reduce Functions<a class="headerlink" href="#builtin-reduce-functions" title="Permalink to this headline">¶</a></h5>
<p>If you’re using a very simple view function that only performs a sum or count
reduction, you can call native Erlang implementations of them by simply
writing <tt class="docutils literal"><span class="pre">_sum</span></tt> or <tt class="docutils literal"><span class="pre">_count</span></tt> in place of your function declaration.
This will speed up things dramatically, as it cuts down on IO between CouchDB
and the <a class="reference internal" href="contents.html#query-server-js"><em>JavaScript query server</em></a>. For example, as
<a class="reference external" href="http://mail-archives.apache.org/mod_mbox/couchdb-user/201003.mbox/%3c5E07E00E-3D69-4A8C-ADA3-1B20CF0BA4C8&#64;julianstahnke.com%3e">mentioned on the mailing list</a>, the time for outputting an (already indexed
and cached) view with about 78,000 items went down from 60 seconds to 4 seconds.</p>
<p>Before:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;_design/foo&quot;</span><span class="p">,</span>
  <span class="s2">&quot;views&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;bar&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;map&quot;</span><span class="o">:</span> <span class="s2">&quot;function (doc) { emit(doc.author, 1); }&quot;</span><span class="p">,</span>
      <span class="s2">&quot;reduce&quot;</span><span class="o">:</span> <span class="s2">&quot;function (keys, values, rereduce) { return sum(values); }&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;_design/foo&quot;</span><span class="p">,</span>
  <span class="s2">&quot;views&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;bar&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;map&quot;</span><span class="o">:</span> <span class="s2">&quot;function (doc) { emit(doc.author, 1); }&quot;</span><span class="p">,</span>
      <span class="s2">&quot;reduce&quot;</span><span class="o">:</span> <span class="s2">&quot;_sum&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#reducefun-builtin"><em>Builtin reduce functions</em></a></p>
</div>
</div>
</div>
</div>
</div>
</div>
<span id="document-couchapp/index"></span><div class="section" id="couchapp">
<span id="id1"></span><h2>CouchApp<a class="headerlink" href="#couchapp" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://couchapp.org/">CouchApps</a> are web applications served directly from CouchDB, mostly driven by
JavaScript and HTML5. If you can fit your application into those constraints,
then you get CouchDB&#8217;s scalability and flexibility &#8220;for free&#8221; (and deploying
your app is as simple as replicating it to the production server).</p>
<div class="toctree-wrapper compound">
<span id="document-couchapp/ddocs"></span><div class="section" id="design-functions">
<span id="ddocs"></span><h3>Design Functions<a class="headerlink" href="#design-functions" title="Permalink to this headline">¶</a></h3>
<p>In this section we&#8217;ll show how to write design documents, using the built-in
<a class="reference internal" href="contents.html#query-server-js"><em>JavaScript Query Server</em></a>.</p>
<p>But before we start to write our first function, let&#8217;s take a look at the list
of common objects that will be used during our code journey - we&#8217;ll be using
them extensively within each function:</p>
<ul class="simple">
<li><a class="reference internal" href="contents.html#dbinfo-object"><em>Database information object</em></a></li>
<li><a class="reference internal" href="contents.html#request-object"><em>Request object</em></a></li>
<li><a class="reference internal" href="contents.html#response-object"><em>Response object</em></a></li>
<li><a class="reference internal" href="contents.html#userctx-object"><em>UserCtx object</em></a></li>
<li><a class="reference internal" href="contents.html#security-object"><em>Database Security object</em></a></li>
<li><a class="reference internal" href="contents.html#query-server-js"><em>Guide to JavaScript Query Server</em></a></li>
</ul>
<div class="section" id="view-functions">
<span id="viewfun"></span><h4>View functions<a class="headerlink" href="#view-functions" title="Permalink to this headline">¶</a></h4>
<p>Views are the primary tool used for querying and reporting on CouchDB databases.</p>
<div class="section" id="map-functions">
<span id="mapfun"></span><h5>Map functions<a class="headerlink" href="#map-functions" title="Permalink to this headline">¶</a></h5>
<dl class="function">
<dt>
<tt class="descname">mapfun</tt><big>(</big><em>doc</em><big>)</big></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first last simple">
<li><strong>doc</strong> &#8211; Processed document object.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Map functions accept a single document as the argument and (optionally) <a class="reference internal" href="contents.html#emit" title="emit"><tt class="xref js js-func docutils literal"><span class="pre">emit()</span></tt></a>
key/value pairs that are stored in a view.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;post&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emit</span><span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this example a key/value pair is emitted for each value in the <cite>tags</cite> array
of a document with a <cite>type</cite> of &#8220;post&#8221;. Note that <a class="reference internal" href="contents.html#emit" title="emit"><tt class="xref js js-func docutils literal"><span class="pre">emit()</span></tt></a> may be called many
times for a single document, so the same document may be available by several
different keys.</p>
<p>Also keep in mind that each document is <em>sealed</em> to prevent situation when one
map function changes document state and the other one received a modified
version.</p>
<p>For efficiency reasons, documents are passed to a group of map functions -
each document is processed by group of map functions from all views of
related design document. This means that if you trigger index update for one
view in ddoc, all others will get updated too.</p>
<p>Since <cite>1.1.0</cite> release <cite>map</cite> function supports
<a class="reference internal" href="contents.html#commonjs"><em>CommonJS</em></a> modules and access to <a class="reference internal" href="contents.html#require" title="require"><tt class="xref js js-func docutils literal"><span class="pre">require()</span></tt></a> function.</p>
</div>
<div class="section" id="reduce-and-rereduce-functions">
<span id="reducefun"></span><h5>Reduce and rereduce functions<a class="headerlink" href="#reduce-and-rereduce-functions" title="Permalink to this headline">¶</a></h5>
<dl class="function">
<dt id="redfun">
<tt class="descname">redfun</tt><big>(</big><em>keys</em>, <em>values</em><span class="optional">[</span>, <em>rereduce</em><span class="optional">]</span><big>)</big><a class="headerlink" href="#redfun" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>keys</strong> &#8211; Array of pairs docid-key for related map function result.
Always <tt class="docutils literal"><span class="pre">null</span></tt> if rereduce is running (has <tt class="docutils literal"><span class="pre">true</span></tt> value).</li>
<li><strong>values</strong> &#8211; Array of map function result values.</li>
<li><strong>rereduce</strong> &#8211; Boolean sign of rereduce run.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Reduces <cite>values</cite></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Reduce functions takes two required arguments of keys and values lists - the
result of the related map function - and optional third one which indicates if
<cite>rereduce</cite> mode is active or not. <cite>Rereduce</cite> is using for additional reduce
values list, so when it is <tt class="docutils literal"><span class="pre">true</span></tt> there is no information about related <cite>keys</cite>
(first argument is <tt class="docutils literal"><span class="pre">null</span></tt>).</p>
<p>Note, that if produced result by <cite>reduce</cite> function is longer than initial
values list then a Query Server error will be raised. However, this behavior
could be disabled by setting <tt class="docutils literal"><span class="pre">reduce_limit</span></tt> config option to <tt class="docutils literal"><span class="pre">false</span></tt>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[query_server_config]</span>
<span class="na">reduce_limit</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
<p>While disabling <tt class="docutils literal"><span class="pre">reduce_limit</span></tt> might be useful for debug proposes, remember,
that main task of reduce functions is to <em>reduce</em> mapped result, not to make it
even bigger. Generally, your reduce function should converge rapidly to a single
value - which could be an array or similar object.</p>
<div class="section" id="builtin-reduce-functions">
<span id="reducefun-builtin"></span><h6>Builtin reduce functions<a class="headerlink" href="#builtin-reduce-functions" title="Permalink to this headline">¶</a></h6>
<p>Additionally, CouchDB has three built-in reduce functions. These are implemented
in Erlang and runs inside CouchDB, so they are much faster than the equivalent
JavaScript functions: <tt class="docutils literal"><span class="pre">_sum</span></tt>, <tt class="docutils literal"><span class="pre">_count</span></tt> and <tt class="docutils literal"><span class="pre">_stats</span></tt>. Their equivalents in
JavaScript below:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// could be replaced by _sum</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// could be replaced by _count</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// could be replaced by _stats</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="s1">&#39;sum&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">sum</span> <span class="p">},</span> <span class="mi">0</span><span class="p">),</span>
      <span class="s1">&#39;min&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">min</span><span class="p">)</span> <span class="p">},</span> <span class="kc">Infinity</span><span class="p">),</span>
      <span class="s1">&#39;max&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span> <span class="p">},</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">),</span>
      <span class="s1">&#39;count&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">count</span> <span class="p">},</span> <span class="mi">0</span><span class="p">),</span>
      <span class="s1">&#39;sumsqr&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">sumsqr</span> <span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="s1">&#39;sum&#39;</span><span class="o">:</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">),</span>
      <span class="s1">&#39;min&#39;</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">values</span><span class="p">),</span>
      <span class="s1">&#39;max&#39;</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">values</span><span class="p">),</span>
      <span class="s1">&#39;count&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="s1">&#39;sumsqr&#39;</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">sumsqr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">sumsqr</span> <span class="o">+=</span> <span class="nx">value</span> <span class="o">*</span> <span class="nx">value</span><span class="p">;</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="nx">sumsqr</span><span class="p">;</span>
      <span class="p">})(),</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Why don&#8217;t reduce functions support CommonJS modules?</strong></p>
<p>While <cite>map</cite> functions have limited access to stored modules through
<a class="reference internal" href="contents.html#require" title="require"><tt class="xref js js-func docutils literal"><span class="pre">require()</span></tt></a> function there is no such feature for <cite>reduce</cite> functions.
The reason lies deep inside in mechanism how <cite>map</cite> and <cite>reduce</cite> functions
are processed by Query Server. Let&#8217;s take a look on <cite>map</cite> functions first:</p>
<ol class="arabic simple">
<li>CouchDB sends all <cite>map</cite> functions for processed design document to
Query Server.</li>
<li>Query Server handles them one by one, compiles and puts them onto an
internal stack.</li>
<li>After all <cite>map</cite> functions had been processed, CouchDB will send the
remaining documents to index one by one.</li>
<li>The Query Server receives the document object and applies it to every function
from the stack. The emitted results are then joined into a single array and sent
back to CouchDB.</li>
</ol>
<p>Now let&#8217;s see how <cite>reduce</cite> functions are handled:</p>
<ol class="arabic simple">
<li>CouchDB sends <em>as single command</em> list of available <cite>reduce</cite> functions
with result list of key-value pairs that was previously received as
result of <cite>map</cite> functions work.</li>
<li>Query Server compiles reduce functions and applies them to key-value
lists. Reduced result sends back to CouchDB.</li>
</ol>
<p class="last">As you may note, <cite>reduce</cite> functions been applied in single shot while
<cite>map</cite> ones are applied in an iterative way per each document. This means that
it&#8217;s possible for <cite>map</cite> functions to precompile CommonJS libraries and use them
during the entire view processing, but for <cite>reduce</cite> functions it will be
compiled again and again for each view result reduction, which will lead to
performance degradation (<cite>reduce</cite> function are already does hard work to make
large result smaller).</p>
</div>
</div>
</div>
</div>
<div class="section" id="show-functions">
<span id="showfun"></span><h4>Show functions<a class="headerlink" href="#show-functions" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<tt class="descname">showfun</tt><big>(</big><em>doc</em>, <em>req</em><big>)</big></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>doc</strong> &#8211; Processed document, may be omitted.</li>
<li><strong>req</strong> &#8211; <a class="reference internal" href="contents.html#request-object"><em>Request object</em></a>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><a class="reference internal" href="contents.html#response-object"><em>Response object</em></a></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">object or string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Show functions are used to represent documents in various formats, commonly as
HTML page with nicer formatting. They can also be used to run server-side functions
without requiring a pre-existing document.</p>
<p>Basic example of show function could be:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Hello from &quot;</span> <span class="o">+</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span> <span class="o">+</span> <span class="s2">&quot;!&quot;</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Hello, world!&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Also, there is more simple way to return json encoded data:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="s1">&#39;json&#39;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span>
      <span class="s1">&#39;rev&#39;</span><span class="o">:</span> <span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;_rev&#39;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and even files (this one is CouchDB logo):</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s1">&#39;Content-Type&#39;</span> <span class="o">:</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;base64&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span>
      <span class="s1">&#39;iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAsV&#39;</span><span class="p">,</span>
      <span class="s1">&#39;BMVEUAAAD////////////////////////5ur3rEBn////////////////wDBL/&#39;</span><span class="p">,</span>
      <span class="s1">&#39;AADuBAe9EB3IEBz/7+//X1/qBQn2AgP/f3/ilpzsDxfpChDtDhXeCA76AQH/v7&#39;</span><span class="p">,</span>
      <span class="s1">&#39;/84eLyWV/uc3bJPEf/Dw/uw8bRWmP1h4zxSlD6YGHuQ0f6g4XyQkXvCA36MDH6&#39;</span><span class="p">,</span>
      <span class="s1">&#39;wMH/z8/yAwX64ODeh47BHiv/Ly/20dLQLTj98PDXWmP/Pz//39/wGyJ7Iy9JAA&#39;</span><span class="p">,</span>
      <span class="s1">&#39;AADHRSTlMAbw8vf08/bz+Pv19jK/W3AAAAg0lEQVR4Xp3LRQ4DQRBD0QqTm4Y5&#39;</span><span class="p">,</span>
      <span class="s1">&#39;zMxw/4OleiJlHeUtv2X6RbNO1Uqj9g0RMCuQO0vBIg4vMFeOpCWIWmDOw82fZx&#39;</span><span class="p">,</span>
      <span class="s1">&#39;vaND1c8OG4vrdOqD8YwgpDYDxRgkSm5rwu0nQVBJuMg++pLXZyr5jnc1BaH4GT&#39;</span><span class="p">,</span>
      <span class="s1">&#39;LvEliY253nA3pVhQqdPt0f/erJkMGMB8xucAAAAASUVORK5CYII=&#39;</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>But what if you need to represent data in different formats via a single function?
Functions <a class="reference internal" href="contents.html#registerType" title="registerType"><tt class="xref js js-func docutils literal"><span class="pre">registerType()</span></tt></a> and <a class="reference internal" href="contents.html#provides" title="provides"><tt class="xref js js-func docutils literal"><span class="pre">provides()</span></tt></a> are your the best friends in
that question:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
  <span class="nx">provides</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;json&#39;</span><span class="o">:</span> <span class="nx">doc</span><span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">provides</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;pre&gt;&#39;</span> <span class="o">+</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/pre&gt;&#39;</span>
  <span class="p">})</span>
  <span class="nx">provides</span><span class="p">(</span><span class="s1">&#39;xml&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/xml&#39;</span><span class="p">},</span>
      <span class="s1">&#39;body&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span>
        <span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&#39;</span><span class="p">,</span>
        <span class="s1">&#39;&lt;doc&gt;&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
          <span class="nx">escape</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span>
            <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;quot;/g</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;gt;/g</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;lt;/g</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;amp;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">);</span>
          <span class="p">};</span>
          <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
          <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">doc</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="nx">key</span><span class="p">]));</span>
            <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
            <span class="nx">content</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span>
              <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
              <span class="nx">value</span>
              <span class="s1">&#39;&lt;/&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>
            <span class="p">)</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="nx">content</span><span class="p">;</span>
        <span class="p">})(),</span>
        <span class="s1">&#39;&lt;/doc&gt;&#39;</span>
      <span class="p">)</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="nx">registerType</span><span class="p">(</span><span class="s1">&#39;text-json&#39;</span><span class="p">,</span> <span class="s1">&#39;text/json&#39;</span><span class="p">)</span>
  <span class="nx">provides</span><span class="p">(</span><span class="s1">&#39;text-json&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
  <span class="p">})</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function may return <cite>html</cite>, <cite>json</cite> , <cite>xml</cite> or our custom <cite>text json</cite> format
representation of same document object with same processing rules. Probably,
the <cite>xml</cite> provider in our function needs more care to handle nested objects
correctly, and keys with invalid characters, but you&#8217;ve got the idea!</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt>CouchDB Wiki:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://wiki.apache.org/couchdb/Formatting_with_Show_and_List#Showing_Documents">Showing Documents</a></li>
</ul>
</dd>
<dt>CouchDB Guide:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://guide.couchdb.org/editions/1/en/show.html">Show Functions</a></li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="list-functions">
<span id="listfun"></span><h4>List functions<a class="headerlink" href="#list-functions" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<tt class="descname">listfun</tt><big>(</big><em>head</em>, <em>req</em><big>)</big></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>head</strong> &#8211; <a class="reference internal" href="contents.html#view-head-info-object"><em>View Head Information</em></a></li>
<li><strong>req</strong> &#8211; <a class="reference internal" href="contents.html#request-object"><em>Request object</em></a>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">Last chunk.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>While <a class="reference internal" href="contents.html#showfun"><em>Show functions</em></a> are used to customize document presentation, <a class="reference internal" href="contents.html#listfun"><em>List functions</em></a>
are used for same purpose, but against <a class="reference internal" href="contents.html#viewfun"><em>View functions</em></a> results.</p>
<p>The next list function formats view and represents it as a very simple HTML page:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
  <span class="nx">start</span><span class="p">({</span>
    <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/html&#39;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;&lt;html&gt;&lt;body&gt;&lt;table&gt;&#39;</span><span class="p">);</span>
  <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Key&lt;/th&gt;&lt;th&gt;Value&lt;/th&gt;&lt;/tr&gt;&#39;</span><span class="p">)</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">row</span> <span class="o">=</span> <span class="nx">getRow</span><span class="p">()){</span>
    <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span>
      <span class="s1">&#39;&lt;tr&gt;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span>
      <span class="s1">&#39;&lt;/tr&gt;&#39;</span>
    <span class="p">));</span>
  <span class="p">}</span>
  <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Templates and styles could obviously be used to present data in a nicer
fashion, but this is an excellent starting point. Note that you may also
use <a class="reference internal" href="contents.html#registerType" title="registerType"><tt class="xref js js-func docutils literal"><span class="pre">registerType()</span></tt></a> and <a class="reference internal" href="contents.html#provides" title="provides"><tt class="xref js js-func docutils literal"><span class="pre">provides()</span></tt></a> functions in the same
way as for <a class="reference internal" href="contents.html#showfun"><em>Show functions</em></a>!</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt>CouchDB Wiki:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://wiki.apache.org/couchdb/Formatting_with_Show_and_List#Listing_Views_with_CouchDB_0.10_and_later">Listing Views with CouchDB 0.10 and later</a></li>
</ul>
</dd>
<dt>CouchDB Guide:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://guide.couchdb.org/draft/transforming.html">Transforming Views with List Functions</a></li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="update-functions">
<span id="updatefun"></span><h4>Update functions<a class="headerlink" href="#update-functions" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<tt class="descname">updatefun</tt><big>(</big><em>doc</em>, <em>req</em><big>)</big></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>doc</strong> &#8211; Update function target document.</li>
<li><strong>req</strong> &#8211; <a class="reference internal" href="contents.html#request-object"><em>Request object</em></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Two-element array: the first element is the (updated or new)
document, which is committed to the database. If the first element
is <tt class="docutils literal"><span class="pre">null</span></tt> no document will be committed to the database.
If you are updating an existing, it should already have an <tt class="docutils literal"><span class="pre">_id</span></tt>
set, and if you are creating a new document, make sure to set its
<tt class="docutils literal"><span class="pre">_id</span></tt> to something, either generated based on the input or the
<tt class="docutils literal"><span class="pre">req.uuid</span></tt> provided. The second element is the response that will
be sent back to the caller.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Update handlers are functions that clients can request to invoke server-side
logic that will create or update a document. This feature allows a range of use
cases such as providing a server-side last modified timestamp, updating
individual fields in a document without first getting the latest revision, etc.</p>
<p>When the request to an update handler includes a document ID in the URL, the
server will provide the function with the most recent version of that document.
You can provide any other values needed by the update handler function via the
<tt class="docutils literal"><span class="pre">POST</span></tt>/<tt class="docutils literal"><span class="pre">PUT</span></tt> entity body or query string parameters of the request.</p>
<p>The basic example that demonstrates all use-cases of update handlers below:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="k">in</span> <span class="nx">req</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]){</span>
            <span class="c1">// create new document</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="nx">req</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]},</span> <span class="s1">&#39;New World&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="c1">// change nothing in database</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;Empty World&#39;</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;world&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hello&#39;</span><span class="p">;</span>
    <span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;edited_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">req</span><span class="p">[</span><span class="s1">&#39;userCtx&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">doc</span><span class="p">,</span> <span class="s1">&#39;Edited World!&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt>CouchDB Wiki:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://wiki.apache.org/couchdb/Document_Update_Handlers">Document Update Handlers</a></li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="filter-functions">
<span id="filterfun"></span><h4>Filter functions<a class="headerlink" href="#filter-functions" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt>
<tt class="descname">filterfun</tt><big>(</big><em>doc</em>, <em>req</em><big>)</big></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>doc</strong> &#8211; Processed document object.</li>
<li><strong>req</strong> &#8211; <a class="reference internal" href="contents.html#request-object"><em>Request object</em></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Boolean value: <tt class="docutils literal"><span class="pre">true</span></tt> means that <cite>doc</cite> passes the filter rules,
<tt class="docutils literal"><span class="pre">false</span></tt> means that it does not.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Filter functions mostly act like <a class="reference internal" href="contents.html#showfun"><em>Show functions</em></a> and <a class="reference internal" href="contents.html#listfun"><em>List functions</em></a>: they
format, or <em>filter</em> the <a class="reference internal" href="contents.html#changes"><em>changes feed</em></a>.</p>
<div class="section" id="classic-filters">
<h5>Classic filters<a class="headerlink" href="#classic-filters" title="Permalink to this headline">¶</a></h5>
<p>By default the changes feed emits all database documents changes. But if you&#8217;re
waiting for some special changes, processing all documents is inefficient.</p>
<p>Filters are special design document functions that allow the changes feed to emit
only specific documents that pass filter rules.</p>
<p>Let&#8217;s assume that our database is a mailbox and we need to handle only new mail
events (documents with status <cite>new</cite>). Our filter function will look like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
  <span class="c1">// we need only `mail` documents</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="s1">&#39;mail&#39;</span><span class="p">){</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// we&#39;re interested only in `new` ones</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="s1">&#39;new&#39;</span><span class="p">){</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// passed!</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Filter functions must return <tt class="docutils literal"><span class="pre">true</span></tt> if a document passed all defined
rules. Now, if you apply this function to the changes feed it will emit only changes
about &#8220;new mails&#8221;:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">GET /somedatabase/_changes?filter</span><span class="o">=</span><span class="s">mailbox/new_mail HTTP/1.1</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;df8eca9da37dade42ee4d7aa3401f1dd&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-c2e0085a21d34fa1cecb6dc26a4ae657&quot;</span><span class="p">}]},</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">7</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;df8eca9da37dade42ee4d7aa34024714&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-29d748a6e87b43db967fe338bcb08d74&quot;</span><span class="p">}]},</span>
<span class="p">],</span>
<span class="s2">&quot;last_seq&quot;</span><span class="o">:</span><span class="mi">27</span><span class="p">}</span>
</pre></div>
</div>
<p>Note that the value of <tt class="docutils literal"><span class="pre">last_seq</span></tt> is 27, but we&#8217;d received only two records.
Seems like any other changes were for documents that haven&#8217;t passed our filter.</p>
<p>We probably need to filter the changes feed of our mailbox by more than a single
status value. We&#8217;re also interested in statuses like &#8220;spam&#8221; to update
spam-filter heuristic rules, &#8220;outgoing&#8221; to let a mail daemon actually send mails,
and so on. Creating a lot of similar functions that actually do similar work
isn&#8217;t good idea - so we need a dynamic filter.</p>
<p>You may have noticed that filter functions take a second argument named
<a class="reference internal" href="contents.html#request-object"><em>request</em></a> - it allows creating dynamic filters
based on query parameters, <a class="reference internal" href="contents.html#userctx-object"><em>user context</em></a> and more.</p>
<p>The dynamic version of our filter looks like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
  <span class="c1">// we need only `mail` documents</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="s1">&#39;mail&#39;</span><span class="p">){</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// we&#39;re interested only in requested status</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">status</span><span class="p">){</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// passed!</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and now we have passed the <cite>status</cite> query parameter in request to let our filter match
only required documents:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">GET /somedatabase/_changes?filter</span><span class="o">=</span><span class="s">mailbox/by_status&amp;status=new HTTP/1.1</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;df8eca9da37dade42ee4d7aa3401f1dd&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-c2e0085a21d34fa1cecb6dc26a4ae657&quot;</span><span class="p">}]},</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">7</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;df8eca9da37dade42ee4d7aa34024714&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-29d748a6e87b43db967fe338bcb08d74&quot;</span><span class="p">}]},</span>
<span class="p">],</span>
<span class="s2">&quot;last_seq&quot;</span><span class="o">:</span><span class="mi">27</span><span class="p">}</span>
</pre></div>
</div>
<p>and we can easily change filter behavior with:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">GET /somedatabase/_changes?filter</span><span class="o">=</span><span class="s">mailbox/by_status&amp;status=spam HTTP/1.1</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;8960e91220798fc9f9d29d24ed612e0d&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;3-cc6ff71af716ddc2ba114967025c0ee0&quot;</span><span class="p">}]},</span>
<span class="p">],</span>
<span class="s2">&quot;last_seq&quot;</span><span class="o">:</span><span class="mi">27</span><span class="p">}</span>
</pre></div>
</div>
<p>Combining filters with a <cite>continuous</cite> feed allows creating powerful event-driven
systems.</p>
</div>
<div class="section" id="view-filters">
<span id="viewfilter"></span><h5>View filters<a class="headerlink" href="#view-filters" title="Permalink to this headline">¶</a></h5>
<p>View filters are the same as above, with one small difference: they use
views <cite>map</cite> function instead to <cite>filter</cite> one to process the changes feed. Each
time when a key-value pair could be emitted, a change is returned. This allows
to avoid creating filter functions that are mostly does same works as views.</p>
<p>To use them just specify <cite>_view</cite> value for <tt class="docutils literal"><span class="pre">filter</span></tt> parameter and
<cite>designdoc/viewname</cite> for <tt class="docutils literal"><span class="pre">view</span></tt> one:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">GET /somedatabase/_changes?filter</span><span class="o">=</span><span class="s">_view&amp;view=dname/viewname  HTTP/1.1</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since view filters uses <cite>map</cite> functions as filters, they can&#8217;t show any
dynamic behavior since <a class="reference internal" href="contents.html#request-object"><em>request object</em></a> is not
available.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt>CouchDB Guide:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://guide.couchdb.org/draft/notifications.html#filters">Guide to filter change notification</a></li>
</ul>
</dd>
<dt>CouchDB Wiki:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://wiki.apache.org/couchdb/Replication#Filtered_Replication">Filtered replication</a></li>
</ul>
</dd>
</dl>
</div>
</div>
</div>
<div class="section" id="validate-document-update-functions">
<span id="vdufun"></span><h4>Validate document update functions<a class="headerlink" href="#validate-document-update-functions" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="validatefun">
<tt class="descname">validatefun</tt><big>(</big><em>newDoc</em>, <em>oldDoc</em>, <em>userCtx</em>, <em>secObj</em><big>)</big><a class="headerlink" href="#validatefun" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>newDoc</strong> &#8211; New version of document that will be stored.</li>
<li><strong>oldDoc</strong> &#8211; Previous version of document that is already stored.</li>
<li><strong>userCtx</strong> &#8211; <a class="reference internal" href="contents.html#userctx-object"><em>User Context Object</em></a></li>
<li><strong>secObj</strong> &#8211; <a class="reference internal" href="contents.html#security-object"><em>Security Object</em></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Throws:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">forbidden</span></tt> error to gracefully prevent document storing.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Throws:</th><td class="field-body"><p class="first last"><tt class="docutils literal"><span class="pre">unauthorized</span></tt> error to prevent storage and allow the user to
re-auth.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>A design document may contain a function named <cite>validate_doc_update</cite>
which can be used to prevent invalid or unauthorized document update requests
from being stored.  The function is passed the new document from the update
request, the current document stored in the database, a <a class="reference internal" href="contents.html#userctx-object"><em>User Context Object</em></a>
containing information about the user writing the document (if present), and
a <a class="reference internal" href="contents.html#security-object"><em>Security Object</em></a> with lists of database security roles.</p>
<p>Validation functions typically examine the structure of the new document to
ensure that required fields are present and to verify that the requesting user
should be allowed to make changes to the document properties.  For example,
an application may require that a user must be authenticated in order to create
a new document or that specific document fields be present when a document
is updated. The validation function can abort the pending document write
by throwing one of two error objects:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// user is not authorized to make the change but may re-authenticate</span>
<span class="k">throw</span><span class="p">({</span> <span class="nx">unauthorized</span><span class="o">:</span> <span class="s1">&#39;Error message here.&#39;</span> <span class="p">});</span>

<span class="c1">// change is not allowed</span>
<span class="k">throw</span><span class="p">({</span> <span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Error message here.&#39;</span> <span class="p">});</span>
</pre></div>
</div>
<p>Document validation is optional, and each design document in the database may
have at most one validation function.  When a write request is received for
a given database, the validation function in each design document in that
database is called in an unspecified order.  If any of the validation functions
throw an error, the write will not succeed.</p>
<p><strong>Example</strong>: The <tt class="docutils literal"><span class="pre">_design/_auth</span></tt> ddoc from <cite>_users</cite> database uses a validation
function to ensure that documents contain some required fields and are only
modified by a user with the <tt class="docutils literal"><span class="pre">_admin</span></tt> role:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">newDoc</span><span class="p">,</span> <span class="nx">oldDoc</span><span class="p">,</span> <span class="nx">userCtx</span><span class="p">,</span> <span class="nx">secObj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">_deleted</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// allow deletes by admins and matching users</span>
        <span class="c1">// without checking the other fields</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_admin&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">oldDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Only admins may delete other user docs.&#39;</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="nx">oldDoc</span> <span class="o">&amp;&amp;</span> <span class="nx">oldDoc</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span> <span class="o">:</span> <span class="s1">&#39;doc.type must be user&#39;</span><span class="p">});</span>
    <span class="p">}</span> <span class="c1">// we only allow user docs for now</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;doc.name is required&#39;</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;doc.roles must exist&#39;</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;doc.roles must be an array&#39;</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">_id</span> <span class="o">!==</span> <span class="p">(</span><span class="s1">&#39;org.couchdb.user:&#39;</span> <span class="o">+</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span>
            <span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Doc ID must be of the form org.couchdb.user:name&#39;</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">oldDoc</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// validate all updates</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">oldDoc</span><span class="p">.</span><span class="nx">name</span> <span class="o">!==</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Usernames can not be changed.&#39;</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">password_sha</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">salt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span>
            <span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Users with password_sha must have a salt.&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;See /_utils/script/couch.js for example code.&#39;</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">is_server_or_database_admin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userCtx</span><span class="p">,</span> <span class="nx">secObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// see if the user is a server admin</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_admin&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// a server admin</span>
        <span class="p">}</span>

        <span class="c1">// see if the user a database admin specified by name</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">secObj</span> <span class="o">&amp;&amp;</span> <span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span> <span class="o">&amp;&amp;</span> <span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span><span class="p">.</span><span class="nx">names</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// database admin</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// see if the user a database admin specified by role</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">secObj</span> <span class="o">&amp;&amp;</span> <span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span> <span class="o">&amp;&amp;</span> <span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span><span class="p">.</span><span class="nx">roles</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">db_roles</span> <span class="o">=</span> <span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span><span class="p">.</span><span class="nx">roles</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">idx</span> <span class="o">&lt;</span> <span class="nx">userCtx</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">user_role</span> <span class="o">=</span> <span class="nx">userCtx</span><span class="p">.</span><span class="nx">roles</span><span class="p">[</span><span class="nx">idx</span><span class="p">];</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">db_roles</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">user_role</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// role matches!</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// default to no admin</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_server_or_database_admin</span><span class="p">(</span><span class="nx">userCtx</span><span class="p">,</span> <span class="nx">secObj</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">oldDoc</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// validate non-admin updates</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">name</span> <span class="o">!==</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span><span class="p">({</span>
                    <span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;You may only update your own user document.&#39;</span>
                <span class="p">});</span>
            <span class="p">}</span>
            <span class="c1">// validate role updates</span>
            <span class="kd">var</span> <span class="nx">oldRoles</span> <span class="o">=</span> <span class="nx">oldDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">newRoles</span> <span class="o">=</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">oldRoles</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="nx">newRoles</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Only _admin may edit roles&#39;</span><span class="p">});</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">oldRoles</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">oldRoles</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">newRoles</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Only _admin may edit roles&#39;</span><span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Only _admin may set roles&#39;</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// no system roles in users db</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">({</span>
                <span class="nx">forbidden</span><span class="o">:</span>
                <span class="s1">&#39;No system roles (starting with underscore) in users db.&#39;</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// no system names as names</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Username may not start with underscore.&#39;</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">badUserNameChars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">badUserNameChars</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">badUserNameChars</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Character `&#39;</span> <span class="o">+</span> <span class="nx">badUserNameChars</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span>
                    <span class="s1">&#39;` is not allowed in usernames.&#39;</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal"><span class="pre">return</span></tt> statement used only for function, it has no impact on
the validation process.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt>CouchDB Guide:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://guide.couchdb.org/editions/1/en/validation.html">Validation Functions</a></li>
</ul>
</dd>
<dt>CouchDB Wiki:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://wiki.apache.org/couchdb/Document_Update_Validation">Document Update Validation</a></li>
</ul>
</dd>
</dl>
</div>
</div>
</div>
<span id="document-couchapp/views/index"></span><div class="section" id="guide-to-views">
<span id="views"></span><h3>Guide to Views<a class="headerlink" href="#guide-to-views" title="Permalink to this headline">¶</a></h3>
<p>Views are the primary tool used for querying and reporting on CouchDB documents.
There you&#8217;ll learn how they works and how to use them to build effective
applications with CouchDB</p>
<div class="toctree-wrapper compound">
<span id="document-couchapp/views/intro"></span><div class="section" id="introduction-into-the-views">
<span id="views-intro"></span><h4>Introduction Into The Views<a class="headerlink" href="#introduction-into-the-views" title="Permalink to this headline">¶</a></h4>
<p>Views are useful for many purposes:</p>
<ul class="simple">
<li>Filtering the documents in your database to find those relevant to a
particular process.</li>
<li>Extracting data from your documents and presenting it in a specific order.</li>
<li>Building efficient indexes to find documents by any value or structure that
resides in them.</li>
<li>Use these indexes to represent relationships among documents.</li>
<li>Finally, with views you can make all sorts of calculations on the data in your
documents. For example, if documents represent your company’s financial
transactions, a view can answer the question of what the spending was in the
last week, month, or year.</li>
</ul>
<div class="section" id="what-is-a-view">
<h5>What Is a View?<a class="headerlink" href="#what-is-a-view" title="Permalink to this headline">¶</a></h5>
<p>Let’s go through the different use cases. First is extracting data that you
might need for a special purpose in a specific order. For a front page, we want
a list of blog post titles sorted by date. We’ll work with a set of example
documents as we walk through how views work:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;biking&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;AE19EBC7654&quot;</span><span class="p">,</span>

  <span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="s2">&quot;Biking&quot;</span><span class="p">,</span>
  <span class="s2">&quot;body&quot;</span><span class="o">:</span><span class="s2">&quot;My biggest hobby is mountainbiking. The other day...&quot;</span><span class="p">,</span>
  <span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="s2">&quot;2009/01/30 18:04:11&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;bought-a-cat&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;4A3BBEE711&quot;</span><span class="p">,</span>

  <span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="s2">&quot;Bought a Cat&quot;</span><span class="p">,</span>
  <span class="s2">&quot;body&quot;</span><span class="o">:</span><span class="s2">&quot;I went to the the pet store earlier and brought home a little kitty...&quot;</span><span class="p">,</span>
  <span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="s2">&quot;2009/02/17 21:13:39&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;hello-world&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;43FBA4E7AB&quot;</span><span class="p">,</span>

  <span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="s2">&quot;Hello World&quot;</span><span class="p">,</span>
  <span class="s2">&quot;body&quot;</span><span class="o">:</span><span class="s2">&quot;Well hello and welcome to my new blog...&quot;</span><span class="p">,</span>
  <span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="s2">&quot;2009/01/15 15:52:20&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Three will do for the example. Note that the documents are sorted by &#8220;_id&#8221;,
which is how they are stored in the database. Now we define a view.
Bear with us without an explanation while we show you some code:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">date</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is a <cite>map function</cite>, and it is written in JavaScript. If you are not
familiar with JavaScript but have used C or any other C-like language such as
Java, PHP, or C#, this should look familiar. It is a simple function definition.</p>
<p>You provide CouchDB with view functions as strings stored inside the <tt class="docutils literal"><span class="pre">views</span></tt>
field of a design document. You don’t run it yourself. Instead, when you
<cite>query your view</cite>, CouchDB takes the source code and runs it for you on every
document in the database your view was defined in. You <cite>query your view</cite> to
retrieve the <cite>view result</cite>.</p>
<p>All map functions have a single parameter doc. This is a single document in
the database. Our map function checks whether our document has a <tt class="docutils literal"><span class="pre">date</span></tt> and
a <tt class="docutils literal"><span class="pre">title</span></tt> attribute — luckily, all of our documents have them — and then calls
the built-in <a class="reference internal" href="contents.html#emit" title="emit"><tt class="xref js js-func docutils literal"><span class="pre">emit()</span></tt></a> function with these two attributes as arguments.</p>
<p>The <a class="reference internal" href="contents.html#emit" title="emit"><tt class="xref js js-func docutils literal"><span class="pre">emit()</span></tt></a> function always takes two arguments: the first is <tt class="docutils literal"><span class="pre">key</span></tt>,
and the second is <tt class="docutils literal"><span class="pre">value</span></tt>. The <tt class="docutils literal"><span class="pre">emit(key,</span> <span class="pre">value)</span></tt> function creates an entry
in our <cite>view result</cite>. One more thing: the <tt class="docutils literal"><span class="pre">emit()</span></tt> function can be called
multiple times in the map function to create multiple entries in the view
results from a single document, but we are not doing that yet.</p>
<p>CouchDB takes whatever you pass into the emit() function and puts it into a list
(see Table 1, “View results” below). Each row in that list includes the <cite>key</cite>
and <cite>value</cite>. More importantly, the list is sorted by key (by <tt class="docutils literal"><span class="pre">doc.date</span></tt>
in our case).  The most important feature of a view result is that it is sorted
by <cite>key</cite>. We will come back to that over and over again to do neat things. Stay
tuned.</p>
<p>Table 1. View results:</p>
<table border="1" class="docutils">
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Key</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>&#8220;2009/01/15 15:52:20&#8221;</td>
<td>&#8220;Hello World&#8221;</td>
</tr>
<tr class="row-odd"><td>&#8220;2009/01/30 18:04:11&#8221;</td>
<td>&#8220;Biking&#8221;</td>
</tr>
<tr class="row-even"><td>&#8220;2009/02/17 21:13:39&#8221;</td>
<td>&#8220;Bought a Cat&#8221;</td>
</tr>
</tbody>
</table>
<p>When you query your view, CouchDB takes the source code and runs it for you on
every document in the database. If you have a lot of documents, that takes
quite a bit of time and you might wonder if it is not horribly inefficient
to do this. Yes, it would be, but CouchDB is designed to avoid any extra costs:
it only runs through all documents once, when you first query your view.
If a document is changed, the map function is only run once, to recompute
the keys and values for that single document.</p>
<p>The view result is stored in a B-tree, just like the structure that is
responsible for holding your documents. View B-trees are stored in their
own file, so that for high-performance CouchDB usage, you can keep views on
their own disk. The B-tree provides very fast lookups of rows by key, as well
as efficient streaming of rows in a key range. In our example, a single view
can answer all questions that involve time: “Give me all the blog posts from
last week” or “last month” or “this year.” Pretty neat.</p>
<p>When we query our view, we get back a list of all documents sorted by date.
Each row also includes the post title so we can construct links to posts.
Table 1 is just a graphical representation of the view result.
The actual result is JSON-encoded and contains a little more metadata:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;total_rows&quot;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;offset&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s2">&quot;rows&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;2009/01/15 15:52:20&quot;</span><span class="p">,</span>
      <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;hello-world&quot;</span><span class="p">,</span>
      <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;Hello World&quot;</span>
    <span class="p">},</span>

    <span class="p">{</span>
      <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;2009/01/30 18:04:11&quot;</span><span class="p">,</span>
      <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;biking&quot;</span><span class="p">,</span>
      <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;Biking&quot;</span>
    <span class="p">},</span>

    <span class="p">{</span>
      <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;2009/02/17 21:13:39&quot;</span><span class="p">,</span>
      <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;bought-a-cat&quot;</span><span class="p">,</span>
      <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;Bought a Cat&quot;</span>
    <span class="p">}</span>

  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, the actual result is not as nicely formatted and doesn’t include any
superfluous whitespace or newlines, but this is better for you (and us!)
to read and understand. Where does that &#8220;id&#8221; member in the result rows come
from? That wasn’t there before. That’s because we omitted it earlier to avoid
confusion. CouchDB automatically includes the document ID of the document that
created the entry in the view result. We’ll use this as well when constructing
links to the blog post pages.</p>
</div>
<div class="section" id="efficient-lookups">
<h5>Efficient Lookups<a class="headerlink" href="#efficient-lookups" title="Permalink to this headline">¶</a></h5>
<p>Let’s move on to the second use case for views: “building efficient indexes to
find documents by any value or structure that resides in them.” We already
explained the efficient indexing, but we skipped a few details. This is a good
time to finish this discussion as we are looking at map functions that are a
little more complex.</p>
<p>First, back to the B-trees! We explained that the B-tree that backs the
key-sorted view result is built only once, when you first query a view,
and all subsequent queries will just read the B-tree instead of executing
the map function for all documents again. What happens, though, when you change
a document, add a new one, or delete one? Easy: CouchDB is smart enough
to find the rows in the view result that were created by a specific document.
It marks them invalid so that they no longer show up in view results.
If the document was deleted, we’re good — the resulting B-tree reflects the
state of the database. If a document got updated, the new document is run
through the map function and the resulting new lines are inserted into
the B-tree at the correct spots. New documents are handled in the same way.
The B-tree is a very efficient data structure for our needs, and the crash-only
design of CouchDB databases is carried over to the view indexes as well.</p>
<p>To add one more point to the efficiency discussion: usually multiple documents
are updated between view queries. The mechanism explained in the previous
paragraph gets applied to all changes in the database since the last time
the view was queried in a batch operation, which makes things even faster and
is generally a better use of your resources.</p>
<div class="section" id="find-one">
<h6>Find One<a class="headerlink" href="#find-one" title="Permalink to this headline">¶</a></h6>
<p>On to more complex map functions. We said “find documents by any value or
structure that resides in them.” We already explained how to extract a value
by which to sort a list of views (our date field). The same mechanism is used
for fast lookups. The URI to query to get a view’s result is
<tt class="docutils literal"><span class="pre">/database/_design/designdocname/_view/viewname</span></tt>. This gives you a list of all
rows in the view. We have only three documents, so things are small, but with
thousands of documents, this can get long. You can add view parameters to the
URI to constrain the result set. Say we know the date of a blog post.
To find a single document, we would use
<tt class="docutils literal"><span class="pre">/blog/_design/docs/_view/by_date?key=&quot;2009/01/30</span> <span class="pre">18:04:11&quot;</span></tt>
to get the “Biking” blog post. Remember that you can place whatever you like
in the key parameter to the emit() function. Whatever you put in there, we can
now use to look up exactly — and fast.</p>
<p>Note that in the case where multiple rows have the same key (perhaps we design
a view where the key is the name of the post’s author), key queries can return
more than one row.</p>
</div>
<div class="section" id="find-many">
<h6>Find Many<a class="headerlink" href="#find-many" title="Permalink to this headline">¶</a></h6>
<p>We talked about “getting all posts for last month.” If it’s February now,
this is as easy as <tt class="docutils literal"><span class="pre">/blog/_design/docs/_view/by_date?startkey=&quot;2010/01/01</span> <span class="pre">00:00:00&quot;&amp;endkey=&quot;2010/02/00</span> <span class="pre">00:00:00&quot;</span></tt>.
The <tt class="docutils literal"><span class="pre">startkey</span></tt> and <tt class="docutils literal"><span class="pre">endkey</span></tt> parameters specify an inclusive range on which
we can search.</p>
<p>To make things a little nicer and to prepare for a future example, we are going
to change the format of our date field. Instead of a string, we are going to use
an array, where individual members are part of a timestamp in decreasing
significance. This sounds fancy, but it is rather easy. Instead of:</p>
<div class="highlight-ini"><div class="highlight"><pre>{
  &quot;date&quot;: &quot;2009/01/31 00:00:00&quot;
}
</pre></div>
</div>
<p>we use:</p>
<div class="highlight-ini"><div class="highlight"><pre>{
  &quot;date&quot;: [2009, 1, 31, 0, 0, 0]
}
</pre></div>
</div>
<p>Our map function does not have to change for this, but our view result looks
a little different:</p>
<p>Table 2. New view results:</p>
<table border="1" class="docutils">
<colgroup>
<col width="60%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Key</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>[2009, 1, 15, 15, 52, 20]</td>
<td>&#8220;Hello World&#8221;</td>
</tr>
<tr class="row-odd"><td>[2009, 2, 17, 21, 13, 39]</td>
<td>&#8220;Biking&#8221;</td>
</tr>
<tr class="row-even"><td>[2009, 1, 30, 18, 4, 11]</td>
<td>&#8220;Bought a Cat&#8221;</td>
</tr>
</tbody>
</table>
<p>And our queries change to <tt class="docutils literal"><span class="pre">/blog/_design/docs/_view/by_date?startkey=[2010,</span> <span class="pre">1,</span> <span class="pre">1,</span> <span class="pre">0,</span> <span class="pre">0,</span> <span class="pre">0]&amp;endkey=[2010,</span> <span class="pre">2,</span> <span class="pre">1,</span> <span class="pre">0,</span> <span class="pre">0,</span> <span class="pre">0]</span></tt>.
For all you care, this is just a change in syntax, not meaning. But it shows
you the power of views. Not only can you construct an index with scalar values
like strings and integers, you can also use JSON structures as keys for your
views. Say we tag our documents with a list of tags and want to see all tags,
but we don’t care for documents that have not been tagged.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="p">...</span>
  <span class="nx">tags</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;cool&quot;</span><span class="p">,</span> <span class="s2">&quot;freak&quot;</span><span class="p">,</span> <span class="s2">&quot;plankton&quot;</span><span class="p">],</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="p">...</span>
  <span class="nx">tags</span><span class="o">:</span> <span class="p">[],</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">[</span><span class="nx">idx</span><span class="p">],</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This shows a few new things. You can have conditions on structure
(<tt class="docutils literal"><span class="pre">if(doc.tags.length</span> <span class="pre">&gt;</span> <span class="pre">0)</span></tt>) instead of just values. This is also an example of
how a map function calls <a class="reference internal" href="contents.html#emit" title="emit"><tt class="xref js js-func docutils literal"><span class="pre">emit()</span></tt></a> multiple times per document.
And finally, you can pass null instead of a value to the value parameter.
The same is true for the key parameter. We’ll see in a bit how that is useful.</p>
</div>
<div class="section" id="reversed-results">
<h6>Reversed Results<a class="headerlink" href="#reversed-results" title="Permalink to this headline">¶</a></h6>
<p>To retrieve view results in reverse order, use the <tt class="docutils literal"><span class="pre">descending=true</span></tt> query
parameter. If you are using a <tt class="docutils literal"><span class="pre">startkey</span></tt> parameter, you will find that CouchDB
returns different rows or no rows at all. What’s up with that?</p>
<p>It’s pretty easy to understand when you see how view query options work under
the hood. A view is stored in a tree structure for fast lookups. Whenever you
query a view, this is how CouchDB operates:</p>
<ol class="arabic simple">
<li>Starts reading at the top, or at the position that <tt class="docutils literal"><span class="pre">startkey</span></tt> specifies,
if present.</li>
<li>Returns one row at a time until the end or until it hits <tt class="docutils literal"><span class="pre">endkey</span></tt>,
if present.</li>
</ol>
<p>If you specify <tt class="docutils literal"><span class="pre">descending=true</span></tt>, the reading direction is reversed,
not the sort  order of the rows in the view. In addition, the same two-step
procedure is followed.</p>
<p>Say you have a view result that looks like this:</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Key</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>&#8220;foo&#8221;</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>&#8220;bar&#8221;</td>
</tr>
<tr class="row-even"><td>2</td>
<td>&#8220;baz&#8221;</td>
</tr>
</tbody>
</table>
<p>Here are potential query options: <tt class="docutils literal"><span class="pre">?startkey=1&amp;descending=true</span></tt>. What will
CouchDB do? See #1 above: it jumps to <tt class="docutils literal"><span class="pre">startkey</span></tt>, which is the row with the
key <tt class="docutils literal"><span class="pre">1</span></tt>, and starts reading backward until it hits the end of the view.
So the particular result would be:</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Key</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>&#8220;bar&#8221;</td>
</tr>
<tr class="row-odd"><td>0</td>
<td>&#8220;foo&#8221;</td>
</tr>
</tbody>
</table>
<p>This is very likely not what you want. To get the rows with the indexes <tt class="docutils literal"><span class="pre">1</span></tt>
and <tt class="docutils literal"><span class="pre">2</span></tt> in reverse order, you need to switch the <tt class="docutils literal"><span class="pre">startkey</span></tt> to <tt class="docutils literal"><span class="pre">endkey</span></tt>:
<tt class="docutils literal"><span class="pre">endkey=1&amp;descending=true</span></tt>:</p>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Key</th>
<th class="head">Value</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2</td>
<td>&#8220;baz&#8221;</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>&#8220;bar&#8221;</td>
</tr>
</tbody>
</table>
<p>Now that looks a lot better. CouchDB started reading at the bottom of the view
and went backward until it hit <tt class="docutils literal"><span class="pre">endkey</span></tt>.</p>
</div>
</div>
<div class="section" id="the-view-to-get-comments-for-posts">
<h5>The View to Get Comments for Posts<a class="headerlink" href="#the-view-to-get-comments-for-posts" title="Permalink to this headline">¶</a></h5>
<p>We use an array key here to support the <tt class="docutils literal"><span class="pre">group_level</span></tt> reduce query parameter.
CouchDB’s views are stored in the B-tree file structure. Because of the way
B-trees are structured, we can cache the intermediate reduce results in the
non-leaf nodes of the tree, so reduce queries can be computed along arbitrary
key ranges in logarithmic time. See Figure 1, “Comments map function”.</p>
<p>In the blog app, we use <tt class="docutils literal"><span class="pre">group_leve``l</span> <span class="pre">reduce</span> <span class="pre">queries</span> <span class="pre">to</span> <span class="pre">compute</span> <span class="pre">the</span> <span class="pre">count</span> <span class="pre">of</span>
<span class="pre">comments</span> <span class="pre">both</span> <span class="pre">on</span> <span class="pre">a</span> <span class="pre">per-post</span> <span class="pre">and</span> <span class="pre">total</span> <span class="pre">basis,</span> <span class="pre">achieved</span> <span class="pre">by</span> <span class="pre">querying</span> <span class="pre">the</span> <span class="pre">same</span> <span class="pre">view</span>
<span class="pre">index</span> <span class="pre">with</span> <span class="pre">different</span> <span class="pre">methods.</span> <span class="pre">With</span> <span class="pre">some</span> <span class="pre">array</span> <span class="pre">keys,</span> <span class="pre">and</span> <span class="pre">assuming</span> <span class="pre">each</span> <span class="pre">key</span> <span class="pre">has</span>
<span class="pre">the</span> <span class="pre">value</span> <span class="pre">``1</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
<span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;e&quot;</span><span class="p">]</span>
<span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">,</span><span class="s2">&quot;m&quot;</span><span class="p">]</span>
<span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
<span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;g&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>the reduce view:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>returns the total number of rows between the start and end key.
So with <tt class="docutils literal"><span class="pre">startkey=[&quot;a&quot;,&quot;b&quot;]&amp;endkey=[&quot;b&quot;]</span></tt> (which includes the first three of
the above keys) the result would equal <tt class="docutils literal"><span class="pre">3</span></tt>. The effect is to count rows.
If you’d like to count rows without depending on the row value, you can switch
on the <tt class="docutils literal"><span class="pre">rereduce</span></tt> parameter:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">JavaScript function about could be effectively replaced by builtin <tt class="docutils literal"><span class="pre">_count</span></tt>
one.</p>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/views-intro-01.png"><img alt="Comments map function" src="_images/views-intro-01.png" style="width: 643.0px; height: 532.5px;" /></a>
<p class="caption">Figure 1. Comments map function</p>
</div>
<p>This is the reduce view used by the example app to count comments, while
utilizing the map to output the comments, which are more useful than just
<tt class="docutils literal"><span class="pre">1</span></tt> over and over. It pays to spend some time playing around with map and
reduce functions. Futon is OK for this, but it doesn’t give full access to all
the query parameters. Writing your own test code for views in your language
of choice is a great way to explore the nuances and capabilities of CouchDB’s
incremental MapReduce system.</p>
<p>Anyway, with a <tt class="docutils literal"><span class="pre">group_level</span></tt> query, you’re basically running a series of
reduce range queries: one for each group that shows up at the level you query.
Let’s reprint the key list from earlier, grouped at level <tt class="docutils literal"><span class="pre">1</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>   <span class="mi">3</span>
<span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>   <span class="mi">2</span>
</pre></div>
</div>
<p>And at <tt class="docutils literal"><span class="pre">group_level=2</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>   <span class="mi">2</span>
<span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>   <span class="mi">1</span>
<span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>   <span class="mi">2</span>
</pre></div>
</div>
<p>Using the parameter <tt class="docutils literal"><span class="pre">group=true</span></tt> makes it behave as though it were
<tt class="docutils literal"><span class="pre">group_level=exact</span></tt>, so in the case of our current example, it would give the
number <tt class="docutils literal"><span class="pre">1</span></tt> for each key, as there are no exactly duplicated keys.</p>
</div>
<div class="section" id="reduce-rereduce">
<h5>Reduce/Rereduce<a class="headerlink" href="#reduce-rereduce" title="Permalink to this headline">¶</a></h5>
<p>We briefly talked about the <tt class="docutils literal"><span class="pre">rereduce</span></tt> parameter to your reduce function.
We’ll explain what’s up with it in this section. By now, you should have learned
that your view result is stored in B-tree index structure for efficiency.
The existence and use of the <tt class="docutils literal"><span class="pre">rereduce</span></tt> parameter is tightly coupled to how
the B-tree index works.</p>
<p>Consider the map result are:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="s2">&quot;afrikan&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;afrikan&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;chinese&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;chinese&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;chinese&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;chinese&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;french&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;italian&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;italian&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;spanish&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;vietnamese&quot;</span><span class="p">,</span> <span class="mi">1</span>
<span class="s2">&quot;vietnamese&quot;</span><span class="p">,</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Example 1. Example view result (mmm, food)</p>
<p>When we want to find out how many dishes there are per origin, we can reuse
the simple reduce function shown earlier:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Figure 2, “The B-tree index” shows a simplified version of what the B-tree index
looks like. We abbreviated the key strings.</p>
<div class="figure align-center">
<img alt="The B-tree index" src="_images/views-intro-02.png" />
<p class="caption">Figure 2. The B-tree index</p>
</div>
<p>The view result is what computer science grads call a “pre-order” walk through
the tree. We look at each element in each node starting from the left. Whenever
we see that there is a subnode to descend into, we descend and start reading
the elements in that subnode. When we have walked through the entire tree,
we’re done.</p>
<p>You can see that CouchDB stores both keys and values inside each leaf node.
In our case, it is simply always <tt class="docutils literal"><span class="pre">1</span></tt>, but you might have a value where you
count other results and then all rows have a different value. What’s important
is that CouchDB runs all elements that are within a node into the reduce
function (setting the <tt class="docutils literal"><span class="pre">rereduce</span></tt> parameter to false) and stores the result
inside the parent node along with the edge to the subnode. In our case, each
edge has a 3 representing the reduce value for the node it points to.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In reality, nodes have more than 1,600 elements in them. CouchDB computes
the result for all the elements in multiple iterations over the elements in
a single node, not all at once (which would be disastrous for memory
consumption).</p>
</div>
<p>Now let’s see what happens when we run a query. We want to know how many
&#8220;chinese&#8221; entries we have. The query option is simple: <tt class="docutils literal"><span class="pre">?key=&quot;chinese&quot;</span></tt>.
See Figure 3, “The B-tree index reduce result”.</p>
<div class="figure align-center">
<img alt="The B-tree index reduce result" src="_images/views-intro-03.png" />
<p class="caption">Figure 3. The B-tree index reduce result</p>
</div>
<p>CouchDB detects that all values in the subnode include the &#8220;chinese&#8221; key.
It concludes that it can take just the 3 values associated with that node to
compute the final result. It then finds the node left to it and sees that it’s
a node with keys outside the requested range (<tt class="docutils literal"><span class="pre">key=</span></tt> requests a range where
the beginning and the end are the same value). It concludes that it has to use
the &#8220;chinese&#8221; element’s value and the other node’s value and run them through
the reduce function with the <tt class="docutils literal"><span class="pre">rereduce</span></tt> parameter set to true.</p>
<p>The reduce function effectively calculates 3 + 1 on query time and returns the
desired result. The next example shows some pseudocode that shows the last
invocation of the reduce function with actual values:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">sum</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, we said your reduce function must actually reduce your values. If you see
the B-tree, it should become obvious what happens when you don’t reduce your
values. Consider the following map result and reduce function. This time we
want to get a list of all the unique labels in our view:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="s2">&quot;afrikan&quot;</span>
<span class="s2">&quot;cef&quot;</span><span class="p">,</span> <span class="s2">&quot;afrikan&quot;</span>
<span class="s2">&quot;fhi&quot;</span><span class="p">,</span> <span class="s2">&quot;chinese&quot;</span>
<span class="s2">&quot;hkl&quot;</span><span class="p">,</span> <span class="s2">&quot;chinese&quot;</span>
<span class="s2">&quot;ino&quot;</span><span class="p">,</span> <span class="s2">&quot;chinese&quot;</span>
<span class="s2">&quot;lqr&quot;</span><span class="p">,</span> <span class="s2">&quot;chinese&quot;</span>
<span class="s2">&quot;mtu&quot;</span><span class="p">,</span> <span class="s2">&quot;french&quot;</span>
<span class="s2">&quot;owx&quot;</span><span class="p">,</span> <span class="s2">&quot;italian&quot;</span>
<span class="s2">&quot;qza&quot;</span><span class="p">,</span> <span class="s2">&quot;italian&quot;</span>
<span class="s2">&quot;tdx&quot;</span><span class="p">,</span> <span class="s2">&quot;spanish&quot;</span>
<span class="s2">&quot;xfg&quot;</span><span class="p">,</span> <span class="s2">&quot;vietnamese&quot;</span>
<span class="s2">&quot;zul&quot;</span><span class="p">,</span> <span class="s2">&quot;vietnamese&quot;</span>
</pre></div>
</div>
<p>We don’t care for the key here and only list all the labels we have. Our reduce
function removes duplicates:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">unique_labels</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">unique_labels</span><span class="p">[</span><span class="nx">label</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">unique_labels</span><span class="p">[</span><span class="nx">label</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">unique_labels</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This translates to Figure 4, “An overflowing reduce index”.</p>
<p>We hope you get the picture. The way the B-tree storage works means that if you
don’t actually reduce your data in the reduce function, you end up having
CouchDB copy huge amounts of data around that grow linearly, if not faster
with the number of rows in your view.</p>
<p>CouchDB will be able to compute the final result, but only for views with a few
rows. Anything larger will experience a ridiculously slow view build time.
To help with that, CouchDB since version 0.10.0 will throw an error if your
reduce function does not reduce its input values.</p>
<div class="figure align-center">
<img alt="An overflowing reduce index" src="_images/views-intro-04.png" />
<p class="caption">Figure 4. An overflowing reduce index</p>
</div>
</div>
<div class="section" id="lessons-learned">
<h5>Lessons Learned<a class="headerlink" href="#lessons-learned" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>If you don’t use the key field in the map function, you are probably doing it
wrong.</li>
<li>If you are trying to make a list of values unique in the reduce functions,
you are probably doing it wrong.</li>
<li>If you don’t reduce your values to a single scalar value or a small
fixed-sized object or array with a fixed number of scalar values of small
sizes, you are probably doing it wrong.</li>
</ul>
</div>
<div class="section" id="wrapping-up">
<h5>Wrapping Up<a class="headerlink" href="#wrapping-up" title="Permalink to this headline">¶</a></h5>
<p>Map functions are side effect–free functions that take a document as argument
and <cite>emit</cite> key/value pairs. CouchDB stores the emitted rows by constructing a
sorted B-tree index, so row lookups by key, as well as streaming operations
across a range of rows, can be accomplished in a small memory and processing
footprint, while writes avoid seeks. Generating a view takes <tt class="docutils literal"><span class="pre">O(N)</span></tt>, where
<tt class="docutils literal"><span class="pre">N</span></tt> is the total number of rows in the view. However, querying a view is very
quick, as the B-tree remains shallow even when it contains many, many keys.</p>
<p>Reduce functions operate on the sorted rows emitted by map view functions.
CouchDB’s reduce functionality takes advantage of one of the fundamental
properties of B-tree indexes: for every leaf node (a sorted row), there is a
chain of internal nodes reaching back to the root. Each leaf node in the B-tree
carries a few rows (on the order of tens, depending on row size), and each
internal node may link to a few leaf nodes or other internal nodes.</p>
<p>The reduce function is run on every node in the tree in order to calculate
the final reduce value. The end result is a reduce function that can be
incrementally updated upon changes to the map function, while recalculating
the reduction values for a minimum number of nodes. The initial reduction is
calculated once per each node (inner and leaf) in the tree.</p>
<p>When run on leaf nodes (which contain actual map rows), the reduce function’s
third parameter, <tt class="docutils literal"><span class="pre">rereduce</span></tt>, is false. The arguments in this case are the keys
and values as output by the map function. The function has a single returned
reduction value, which is stored on the inner node that a working set of leaf
nodes have in common, and is used as a cache in future reduce calculations.</p>
<p>When the reduce function is run on inner nodes, the <tt class="docutils literal"><span class="pre">rereduce</span></tt> flag is
<tt class="docutils literal"><span class="pre">true</span></tt>. This allows the function to account for the fact that it will be
receiving its own prior output. When <tt class="docutils literal"><span class="pre">rereduce</span></tt> is true, the values passed to
the function are intermediate reduction values as cached from previous
calculations. When the tree is more than two levels deep, the <cite>rereduce</cite> phase
is repeated, consuming chunks of the previous level’s output until the final
reduce value is calculated at the root node.</p>
<p>A common mistake new CouchDB users make is attempting to construct complex
aggregate values with a reduce function. Full reductions should result in a
scalar value, like 5, and not, for instance, a JSON hash with a set of unique
keys and the count of each. The problem with this approach is that you’ll end
up with a very large final value. The number of unique keys can be nearly as
large as the number of total keys, even for a large set. It is fine to combine
a few scalar calculations into one reduce function; for instance, to find the
total, average, and standard deviation of a set of numbers in a single function.</p>
<p>If you’re interested in pushing the edge of CouchDB’s incremental reduce
functionality, have a look at <a class="reference external" href="http://research.google.com/archive/sawzall.html">Google’s paper on Sawzall</a>, which gives examples
of some of the more exotic reductions that can be accomplished in a system with
similar constraints.</p>
</div>
</div>
<span id="document-couchapp/views/collation"></span><div class="section" id="views-collation">
<span id="id1"></span><h4>Views Collation<a class="headerlink" href="#views-collation" title="Permalink to this headline">¶</a></h4>
<div class="section" id="basics">
<h5>Basics<a class="headerlink" href="#basics" title="Permalink to this headline">¶</a></h5>
<p>View functions specify a key and a value to be returned for each row. CouchDB
collates the view rows by this key. In the following example, the <tt class="docutils literal"><span class="pre">LastName</span></tt>
property serves as the key, thus the result will be sorted by <tt class="docutils literal"><span class="pre">LastName</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="s2">&quot;customer&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">LastName</span><span class="p">,</span> <span class="p">{</span><span class="nx">FirstName</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">FirstName</span><span class="p">,</span> <span class="nx">Address</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">Address</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>CouchDB allows arbitrary JSON structures to be used as keys. You can use JSON
arrays as keys for fine-grained control over sorting and grouping.</p>
</div>
<div class="section" id="examples">
<h5>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h5>
<p>The following clever trick would return both customer and order documents.
The key is composed of a customer <tt class="docutils literal"><span class="pre">_id</span></tt> and a sorting token. Because the key
for order documents begins with the <tt class="docutils literal"><span class="pre">_id</span></tt> of a customer document, all the
orders will be sorted by customer. Because the sorting token for customers is
lower than the token for orders, the customer document will come before the
associated orders. The values 0 and 1 for the sorting token are arbitrary.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="s2">&quot;customer&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">([</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="s2">&quot;order&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">([</span><span class="nx">doc</span><span class="p">.</span><span class="nx">customer_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To list a specific customer with <tt class="docutils literal"><span class="pre">_id</span></tt> XYZ, and all of that customer&#8217;s orders, limit the startkey and endkey ranges to cover only documents for that customer&#8217;s <tt class="docutils literal"><span class="pre">_id</span></tt>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">startkey</span><span class="o">=</span><span class="s">[&quot;XYZ&quot;]&amp;endkey=[&quot;XYZ&quot;, {}]</span>
</pre></div>
</div>
<p>It is not recommended to emit the document itself in the view. Instead, to include the bodies of the documents when requesting the view, request the view with <tt class="docutils literal"><span class="pre">?include_docs=true</span></tt>.</p>
</div>
<div class="section" id="sorting-by-dates">
<h5>Sorting by Dates<a class="headerlink" href="#sorting-by-dates" title="Permalink to this headline">¶</a></h5>
<p>It maybe be convenient to store date attributes in a human readable format
(i.e. as a <cite>string</cite>), but still sort by date. This can be done by converting
the date to a <cite>number</cite> in the <a class="reference internal" href="contents.html#emit" title="emit"><tt class="xref js js-func docutils literal"><span class="pre">emit()</span></tt></a> function. For example, given
a document with a created_at attribute of <tt class="docutils literal"><span class="pre">'Wed</span> <span class="pre">Jul</span> <span class="pre">23</span> <span class="pre">16:29:21</span> <span class="pre">+0100</span> <span class="pre">2013'</span></tt>,
the following emit function would sort by date:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">emit</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">created_at</span><span class="p">).</span><span class="nx">getTime</span><span class="p">(),</span> <span class="kc">null</span><span class="p">);</span>
</pre></div>
</div>
<p>Alternatively, if you use a date format which sorts lexicographically,
such as <tt class="docutils literal"><span class="pre">&quot;2013/06/09</span> <span class="pre">13:52:11</span> <span class="pre">+0000&quot;</span></tt> you can just</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">created_at</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</pre></div>
</div>
<p>and avoid the conversion. As a bonus, this date format is compatible with the
JavaScript date parser, so you can use <tt class="docutils literal"><span class="pre">new</span> <span class="pre">Date(doc.created_at)</span></tt> in your
client side JavaScript to make date sorting easy in the browser.</p>
</div>
<div class="section" id="string-ranges">
<h5>String Ranges<a class="headerlink" href="#string-ranges" title="Permalink to this headline">¶</a></h5>
<p>If you need start and end keys that encompass every string with a given prefix,
it is better to use a high value unicode character, than to use a <tt class="docutils literal"><span class="pre">'ZZZZ'</span></tt>
suffix.</p>
<p>That is, rather than:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">startkey</span><span class="o">=</span><span class="s">&quot;abc&quot;&amp;endkey=&quot;abcZZZZZZZZZ&quot;</span>
</pre></div>
</div>
<p>You should use:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">startkey</span><span class="o">=</span><span class="s">&quot;abc&quot;&amp;endkey=&quot;abc\ufff0&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="collation-specification">
<h5>Collation Specification<a class="headerlink" href="#collation-specification" title="Permalink to this headline">¶</a></h5>
<p>This section is based on the view_collation function in <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=blob;f=share/www/script/test/view_collation.js;hb=HEAD">view_collation.js</a>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// special values sort before all other types</span>
<span class="kc">null</span>
<span class="kc">false</span>
<span class="kc">true</span>

<span class="c1">// then numbers</span>
<span class="mi">1</span>
<span class="mi">2</span>
<span class="mf">3.0</span>
<span class="mi">4</span>

<span class="c1">// then text, case sensitive</span>
<span class="s2">&quot;a&quot;</span>
<span class="s2">&quot;A&quot;</span>
<span class="s2">&quot;aa&quot;</span>
<span class="s2">&quot;b&quot;</span>
<span class="s2">&quot;B&quot;</span>
<span class="s2">&quot;ba&quot;</span>
<span class="s2">&quot;bb&quot;</span>

<span class="c1">// then arrays. compared element by element until different.</span>
<span class="c1">// Longer arrays sort after their prefixes</span>
<span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
<span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span>
<span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">]</span>
<span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]</span>
<span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;d&quot;</span><span class="p">]</span>
<span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">]</span>

<span class="c1">// then object, compares each key value in the list until different.</span>
<span class="c1">// larger objects sort after their subset objects.</span>
<span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">}</span>
<span class="p">{</span><span class="nx">a</span><span class="o">:</span><span class="mi">2</span><span class="p">}</span>
<span class="p">{</span><span class="nx">b</span><span class="o">:</span><span class="mi">1</span><span class="p">}</span>
<span class="p">{</span><span class="nx">b</span><span class="o">:</span><span class="mi">2</span><span class="p">}</span>
<span class="p">{</span><span class="nx">b</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">a</span><span class="o">:</span><span class="mi">1</span><span class="p">}</span> <span class="c1">// Member order does matter for collation.</span>
           <span class="c1">// CouchDB preserves member order</span>
           <span class="c1">// but doesn&#39;t require that clients will.</span>
           <span class="c1">// this test might fail if used with a js engine</span>
           <span class="c1">// that doesn&#39;t preserve order</span>
<span class="p">{</span><span class="nx">b</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="nx">c</span><span class="o">:</span><span class="mi">2</span><span class="p">}</span>
</pre></div>
</div>
<p>Comparison of strings is done using <a class="reference external" href="http://site.icu-project.org/">ICU</a> which implements the
<a class="reference external" href="http://www.unicode.org/unicode/reports/tr10/">Unicode Collation Algorithm</a>, giving a dictionary sorting of keys.
This can give surprising results if you were expecting ASCII ordering.
Note that:</p>
<ul class="simple">
<li>All symbols sort before numbers and letters (even the &#8220;high&#8221; symbols like
tilde, <tt class="docutils literal"><span class="pre">0x7e</span></tt>)</li>
<li>Differing sequences of letters are compared without regard to case, so
<tt class="docutils literal"><span class="pre">a</span> <span class="pre">&lt;</span> <span class="pre">aa</span></tt> but also <tt class="docutils literal"><span class="pre">A</span> <span class="pre">&lt;</span> <span class="pre">aa</span></tt> and <tt class="docutils literal"><span class="pre">a</span> <span class="pre">&lt;</span> <span class="pre">AA</span></tt></li>
<li>Identical sequences of letters are compared with regard to case, with
lowercase before uppercase, so <tt class="docutils literal"><span class="pre">a</span> <span class="pre">&lt;</span> <span class="pre">A</span></tt></li>
</ul>
<p>You can demonstrate the collation sequence for 7-bit ASCII characters like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;restclient&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;json&#39;</span>

<span class="no">DB</span><span class="o">=</span><span class="s2">&quot;http://127.0.0.1:5984/collator&quot;</span>

<span class="no">RestClient</span><span class="o">.</span><span class="n">delete</span> <span class="no">DB</span> <span class="k">rescue</span> <span class="kp">nil</span>
<span class="no">RestClient</span><span class="o">.</span><span class="n">put</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">DB</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span>

<span class="p">(</span><span class="mi">32</span><span class="o">..</span><span class="mi">126</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="no">RestClient</span><span class="o">.</span><span class="n">put</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">DB</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">c</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="o">=&gt;</span><span class="n">c</span><span class="o">.</span><span class="n">chr</span><span class="p">}</span><span class="o">.</span><span class="n">to_json</span>
<span class="k">end</span>

<span class="no">RestClient</span><span class="o">.</span><span class="n">put</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">DB</span><span class="si">}</span><span class="s2">/_design/test&quot;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="no">EOS</span>
<span class="sh">{</span>
<span class="sh">  &quot;views&quot;:{</span>
<span class="sh">    &quot;one&quot;:{</span>
<span class="sh">      &quot;map&quot;:&quot;function (doc) { emit(doc.x,null); }&quot;</span>
<span class="sh">    }</span>
<span class="sh">  }</span>
<span class="sh">}</span>
<span class="no">EOS</span>

<span class="nb">puts</span> <span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">DB</span><span class="si">}</span><span class="s2">/_design/test/_view/one&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This shows the collation sequence to be:</p>
<div class="highlight-ini"><div class="highlight"><pre>` ^ _ - , ; : ! ? . &#39; &quot; ( ) [ ] { } @ * / \ &amp; # % + &lt; = &gt; | ~ $ 0 1 2 3 4 5 6 7 8 9
a A b B c C d D e E f F g G h H i I j J k K l L m M n N o O p P q Q r R s S t T u U v V w W x X y Y z Z
</pre></div>
</div>
<div class="section" id="key-ranges">
<h6>Key ranges<a class="headerlink" href="#key-ranges" title="Permalink to this headline">¶</a></h6>
<p>Take special care when querying key ranges. For example: the query:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">startkey</span><span class="o">=</span><span class="s">&quot;Abc&quot;&amp;endkey=&quot;AbcZZZZ&quot;</span>
</pre></div>
</div>
<p>will match &#8220;ABC&#8221; and &#8220;abc1&#8221;, but not &#8220;abc&#8221;. This is because UCA sorts as:</p>
<div class="highlight-ini"><div class="highlight"><pre>abc &lt; Abc &lt; ABC &lt; abc1 &lt; AbcZZZZZ
</pre></div>
</div>
<p>For most applications, to avoid problems you should lowercase the <cite>startkey</cite>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">startkey</span><span class="o">=</span><span class="s">&quot;abc&quot;&amp;endkey=&quot;abcZZZZZZZZ&quot;</span>
</pre></div>
</div>
<p>will match all keys starting with <tt class="docutils literal"><span class="pre">[aA][bB][cC]</span></tt></p>
</div>
<div class="section" id="complex-keys">
<h6>Complex keys<a class="headerlink" href="#complex-keys" title="Permalink to this headline">¶</a></h6>
<p>The query <tt class="docutils literal"><span class="pre">startkey=[&quot;foo&quot;]&amp;endkey=[&quot;foo&quot;,{}]</span></tt> will match most array keys
with &#8220;foo&#8221; in the first element, such as <tt class="docutils literal"><span class="pre">[&quot;foo&quot;,&quot;bar&quot;]</span></tt> and
<tt class="docutils literal"><span class="pre">[&quot;foo&quot;,[&quot;bar&quot;,&quot;baz&quot;]]</span></tt>. However it will not match <tt class="docutils literal"><span class="pre">[&quot;foo&quot;,{&quot;an&quot;:&quot;object&quot;}]</span></tt></p>
</div>
</div>
<div class="section" id="all-docs">
<h5>_all_docs<a class="headerlink" href="#all-docs" title="Permalink to this headline">¶</a></h5>
<p>The <a class="reference internal" href="contents.html#api-db-all-docs"><em>_all_docs</em></a>  view is a special case because it uses
ASCII collation for doc ids, not UCA:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">startkey</span><span class="o">=</span><span class="s">&quot;_design/&quot;&amp;endkey=&quot;_design/ZZZZZZZZ&quot;</span>
</pre></div>
</div>
<p>will not find <tt class="docutils literal"><span class="pre">_design/abc</span></tt> because <cite>&#8216;Z&#8217;</cite> comes before <cite>&#8216;a&#8217;</cite> in the ASCII
sequence. A better solution is:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">startkey</span><span class="o">=</span><span class="s">&quot;_design/&quot;&amp;endkey=&quot;_design0&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="raw-collation">
<h5>Raw collation<a class="headerlink" href="#raw-collation" title="Permalink to this headline">¶</a></h5>
<p>To squeeze a little more performance out of views, you can specify
<tt class="docutils literal"><span class="pre">&quot;options&quot;:{&quot;collation&quot;:&quot;raw&quot;}</span></tt>  within the view definition for native Erlang
collation, especially if you don&#8217;t require UCA. This gives a different collation
sequence:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="mi">1</span>
<span class="kc">false</span>
<span class="kc">null</span>
<span class="kc">true</span>
<span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="o">:</span><span class="s2">&quot;a&quot;</span><span class="p">},</span>
<span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span>
<span class="s2">&quot;a&quot;</span>
</pre></div>
</div>
<p>Beware that <tt class="docutils literal"><span class="pre">{}</span></tt> is no longer a suitable &#8220;high&#8221; key sentinel value. Use a
string like <tt class="docutils literal"><span class="pre">&quot;\ufff0&quot;</span></tt> instead.</p>
</div>
</div>
<span id="document-couchapp/views/joins"></span><div class="section" id="joins-with-views">
<span id="views-json"></span><h4>Joins With Views<a class="headerlink" href="#joins-with-views" title="Permalink to this headline">¶</a></h4>
<div class="section" id="linked-documents">
<h5>Linked Documents<a class="headerlink" href="#linked-documents" title="Permalink to this headline">¶</a></h5>
<p>If your <a class="reference internal" href="contents.html#mapfun"><em>map function</em></a> emits an object value which has
<tt class="docutils literal"><span class="pre">{'_id':</span> <span class="pre">XXX}</span></tt> and you <a class="reference internal" href="contents.html#api-ddoc-view"><em>query view</em></a> with
<tt class="docutils literal"><span class="pre">include_docs=true</span></tt> parameter, then CouchDB will fetch the document with id
<tt class="docutils literal"><span class="pre">XXX</span></tt> rather than the document which was processed to emit the key/value pair.</p>
<p>This means that if one document contains the ids of other documents, it can
cause those documents to be fetched in the view too, adjacent to the same key
if required.</p>
<p>For example, if you have the following hierarchically-linked documents:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span>
  <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;11111&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;22222&quot;</span><span class="p">,</span> <span class="s2">&quot;ancestors&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;11111&quot;</span><span class="p">],</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;hello&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;33333&quot;</span><span class="p">,</span> <span class="s2">&quot;ancestors&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;22222&quot;</span><span class="p">,</span><span class="s2">&quot;11111&quot;</span><span class="p">],</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;world&quot;</span> <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>You can emit the values with the ancestor documents adjacent to them in the view
like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">([</span><span class="nx">doc</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="kc">null</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">ancestors</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">ancestors</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emit</span><span class="p">([</span><span class="nx">doc</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">ancestors</span><span class="p">[</span><span class="nx">i</span><span class="p">]});</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The result you get is:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;total_rows&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">&quot;offset&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;rows&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;22222&quot;</span><span class="p">,</span>
            <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;hello&quot;</span><span class="p">,</span>
                <span class="mi">0</span>
            <span class="p">],</span>
            <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="s2">&quot;doc&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;22222&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-0eee81fecb5aa4f51e285c621271ff02&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ancestors&quot;</span><span class="o">:</span> <span class="p">[</span>
                    <span class="s2">&quot;11111&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;hello&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;22222&quot;</span><span class="p">,</span>
            <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;hello&quot;</span><span class="p">,</span>
                <span class="mi">1</span>
            <span class="p">],</span>
            <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;11111&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;doc&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;11111&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-967a00dff5e02add41819138abb3284d&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;33333&quot;</span><span class="p">,</span>
            <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;world&quot;</span><span class="p">,</span>
                <span class="mi">0</span>
            <span class="p">],</span>
            <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="s2">&quot;doc&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;33333&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-11e42b44fdb3d3784602eca7c0332a43&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ancestors&quot;</span><span class="o">:</span> <span class="p">[</span>
                    <span class="s2">&quot;22222&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;11111&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;world&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;33333&quot;</span><span class="p">,</span>
            <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;world&quot;</span><span class="p">,</span>
                <span class="mi">1</span>
            <span class="p">],</span>
            <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;22222&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;doc&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;22222&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-0eee81fecb5aa4f51e285c621271ff02&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ancestors&quot;</span><span class="o">:</span> <span class="p">[</span>
                    <span class="s2">&quot;11111&quot;</span>
                <span class="p">],</span>
                <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;hello&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;33333&quot;</span><span class="p">,</span>
            <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;world&quot;</span><span class="p">,</span>
                <span class="mi">2</span>
            <span class="p">],</span>
            <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;11111&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;doc&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;11111&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-967a00dff5e02add41819138abb3284d&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>which makes it very cheap to fetch a document plus all its ancestors in one
query.</p>
<p>Note that the <tt class="docutils literal"><span class="pre">&quot;id&quot;</span></tt> in the row is still that of the originating document.
The only difference is that <tt class="docutils literal"><span class="pre">include_docs</span></tt> fetches a different doc.</p>
<p>The current revision of the document is resolved at query time, not at the time
the view is generated. This means that if a new revision of the linked document
is added later, it will appear in view queries even though the view itself
hasn&#8217;t changed. To force a specific revision of a linked document to be used,
emit a <tt class="docutils literal"><span class="pre">&quot;_rev&quot;</span></tt> property as well as <tt class="docutils literal"><span class="pre">&quot;_id&quot;</span></tt>.</p>
</div>
<div class="section" id="using-view-collation">
<h5>Using View Collation<a class="headerlink" href="#using-view-collation" title="Permalink to this headline">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Christopher Lenz</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">2007-10-05</td>
</tr>
<tr class="field-odd field"><th class="field-name">Source:</th><td class="field-body"><a class="reference external" href="http://www.cmlenz.net/archives/2007/10/couchdb-joins">http://www.cmlenz.net/archives/2007/10/couchdb-joins</a></td>
</tr>
</tbody>
</table>
<p>Just today, there was a discussion on IRC how you&#8217;d go about modeling a simple
blogging system with “post” and “comment” entities, where any blog post might
have N comments. If you&#8217;d be using an SQL database, you&#8217;d obviously have two
tables with foreign keys and you&#8217;d be using joins. (At least until you needed
to add some <a class="reference external" href="http://en.wikipedia.org/wiki/Denormalization">denormalization</a>).</p>
<p>But what would the “obvious” approach in CouchDB look like?</p>
<div class="section" id="approach-1-comments-inlined">
<h6>Approach #1: Comments Inlined<a class="headerlink" href="#approach-1-comments-inlined" title="Permalink to this headline">¶</a></h6>
<p>A simple approach would be to have one document per blog post, and store the
comments inside that document:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;myslug&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;123456&quot;</span><span class="p">,</span>
  <span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="s2">&quot;john&quot;</span><span class="p">,</span>
  <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;My blog post&quot;</span><span class="p">,</span>
  <span class="s2">&quot;content&quot;</span><span class="o">:</span> <span class="s2">&quot;Bla bla bla …&quot;</span><span class="p">,</span>
  <span class="s2">&quot;comments&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="s2">&quot;jack&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="o">:</span> <span class="s2">&quot;…&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="s2">&quot;jane&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="o">:</span> <span class="s2">&quot;…&quot;</span><span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Of course the model of an actual blogging system would be more extensive,
you&#8217;d have tags, timestamps, etc etc. This is just to demonstrate the basics.</p>
</div>
<p>The obvious advantage of this approach is that the data that belongs together
is stored in one place. Delete the post, and you automatically delete the
corresponding comments, and so on.</p>
<p>You may be thinking that putting the comments inside the blog post document
would not allow us to query for the comments themselves, but you&#8217;d be wrong.
You could trivially write a CouchDB view that would return all comments across
all blog posts, keyed by author:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">comments</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">comments</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">author</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">comments</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">content</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now you could list all comments by a particular user by invoking the view and
passing it a <tt class="docutils literal"><span class="pre">?key=&quot;username&quot;</span></tt> query string parameter.</p>
<p>However, this approach has a drawback that can be quite significant for many
applications: To add a comment to a post, you need to:</p>
<ul class="simple">
<li>Fetch the blog post document</li>
<li>Add the new comment to the JSON structure</li>
<li>Send the updated document to the server</li>
</ul>
<p>Now if you have multiple client processes adding comments at roughly the same
time, some of them will get a <cite>HTTP 409 Conflict</cite> error on step 3 (that&#8217;s
optimistic concurrency in action). For some applications this makes sense, but
in many other apps, you&#8217;d want to append new related data regardless of whether
other data has been added in the meantime.</p>
<p>The only way to allow non-conflicting addition of related data is by putting
that related data into separate documents.</p>
</div>
<div class="section" id="approach-2-comments-separate">
<h6>Approach #2: Comments Separate<a class="headerlink" href="#approach-2-comments-separate" title="Permalink to this headline">¶</a></h6>
<p>Using this approach you&#8217;d have one document per blog post, and one document per
comment. The comment documents would have a “backlink” to the post they belong
to.</p>
<p>The blog post document would look similar to the above, minus the comments
property. Also, we&#8217;d now have a type property on all our documents so that we
can tell the difference between posts and comments:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;myslug&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;123456&quot;</span><span class="p">,</span>
  <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span>
  <span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="s2">&quot;john&quot;</span><span class="p">,</span>
  <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;My blog post&quot;</span><span class="p">,</span>
  <span class="s2">&quot;content&quot;</span><span class="o">:</span> <span class="s2">&quot;Bla bla bla …&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The comments themselves are stored in separate documents, which also have a type
property (this time with the value “comment”), and in addition feature a post
property containing the ID of the post document they belong to:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;ABCDEF&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;123456&quot;</span><span class="p">,</span>
  <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;comment&quot;</span><span class="p">,</span>
  <span class="s2">&quot;post&quot;</span><span class="o">:</span> <span class="s2">&quot;myslug&quot;</span><span class="p">,</span>
  <span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="s2">&quot;jack&quot;</span><span class="p">,</span>
  <span class="s2">&quot;content&quot;</span><span class="o">:</span> <span class="s2">&quot;…&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;DEFABC&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;123456&quot;</span><span class="p">,</span>
  <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;comment&quot;</span><span class="p">,</span>
  <span class="s2">&quot;post&quot;</span><span class="o">:</span> <span class="s2">&quot;myslug&quot;</span><span class="p">,</span>
  <span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="s2">&quot;jane&quot;</span><span class="p">,</span>
  <span class="s2">&quot;content&quot;</span><span class="o">:</span> <span class="s2">&quot;…&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To list all comments per blog post, you&#8217;d add a simple view, keyed by blog post
ID:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;comment&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">post</span><span class="p">,</span> <span class="p">{</span><span class="nx">author</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">author</span><span class="p">,</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">content</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And you&#8217;d invoke that view passing it a <tt class="docutils literal"><span class="pre">?key=&quot;post_id&quot;</span></tt> query string
parameter.</p>
<p>Viewing all comments by author is just as easy as before:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;comment&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">author</span><span class="p">,</span> <span class="p">{</span><span class="nx">post</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">post</span><span class="p">,</span> <span class="nx">content</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">content</span><span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>So this is better in some ways, but it also has a disadvantage.
Imagine you want to display a blog post with all the associated comments on the
same web page. With our first approach, we needed just a single request to the
CouchDB server, namely a <tt class="docutils literal"><span class="pre">GET</span></tt> request to the document. With this second
approach, we need two requests: a <tt class="docutils literal"><span class="pre">GET</span></tt> request to the post document, and a
<tt class="docutils literal"><span class="pre">GET</span></tt> request to the view that returns all comments for the post.</p>
<p>That is okay, but not quite satisfactory. Just imagine you wanted to added
threaded comments: you&#8217;d now need an additional fetch per comment. What we&#8217;d
probably want then would be a way to join the blog post and the various comments
together to be able to retrieve them with a single HTTP request.</p>
<p>This was when Damien Katz, the author of CouchDB, chimed in to the discussion
on IRC to show us the way.</p>
</div>
<div class="section" id="optimization-using-the-power-of-view-collation">
<h6>Optimization: Using the Power of View Collation<a class="headerlink" href="#optimization-using-the-power-of-view-collation" title="Permalink to this headline">¶</a></h6>
<p>Obvious to Damien, but not at all obvious to the rest of us: it&#8217;s fairly simple
to make a view that includes both the content of the blog post document, and
the content of all the comments associated with that post. The way you do that
is by using <cite>complex keys</cite>. Until now we&#8217;ve been using simple string values for
the view keys, but in fact they can be arbitrary JSON values, so let&#8217;s make
some use of that:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;post&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">([</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="nx">doc</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;comment&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">([</span><span class="nx">doc</span><span class="p">.</span><span class="nx">post</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">doc</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Okay, this may be confusing at first. Let&#8217;s take a step back and look at what
views in CouchDB are really about.</p>
<p>CouchDB views are basically highly efficient on-disk dictionaries that map keys
to values, where the key is automatically indexed and can be used to filter
and/or sort the results you get back from your views. When you “invoke” a view,
you can say that you&#8217;re only interested in a subset of the view rows by
specifying a <tt class="docutils literal"><span class="pre">?key=foo</span></tt> query string parameter. Or you can specify
<tt class="docutils literal"><span class="pre">?startkey=foo</span></tt> and/or <tt class="docutils literal"><span class="pre">?endkey=bar</span></tt> query string parameters to fetch rows
over a range of keys.</p>
<p>It&#8217;s also important to note that keys are always used for collating (i.e.
sorting) the rows. CouchDB has well defined (but as of yet undocumented) rules
for comparing arbitrary JSON objects for collation. For example, the JSON value
<tt class="docutils literal"><span class="pre">[&quot;foo&quot;,</span> <span class="pre">2]</span></tt> is sorted after (considered “greater than”) the values
<tt class="docutils literal"><span class="pre">[&quot;foo&quot;]</span></tt> or <tt class="docutils literal"><span class="pre">[&quot;foo&quot;,</span> <span class="pre">1,</span> <span class="pre">&quot;bar&quot;]</span></tt>, but before e.g. <tt class="docutils literal"><span class="pre">[&quot;foo&quot;,</span> <span class="pre">2,</span> <span class="pre">&quot;bar&quot;]</span></tt>.
This feature enables a whole class of tricks that are rather non-obvious...</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#views-collation"><em>Views Collation</em></a></p>
</div>
<p>With that in mind, let&#8217;s return to the view function above. First note that,
unlike the previous view functions we&#8217;ve used here, this view handles both
&#8220;post&#8221; and &#8220;comment&#8221; documents, and both of them end up as rows in the same
view. Also, the key in this view is not just a simple string, but an array.
The first element in that array is always the ID of the post, regardless of
whether we&#8217;re processing an actual post document, or a comment associated with
a post. The second element is 0 for post documents, and 1 for comment documents.</p>
<p>Let&#8217;s assume we have two blog posts in our database. Without limiting the view
results via <tt class="docutils literal"><span class="pre">key</span></tt>, <tt class="docutils literal"><span class="pre">startkey</span></tt>, or <tt class="docutils literal"><span class="pre">endkey</span></tt>, we&#8217;d get back something like
the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;total_rows&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;rows&quot;</span><span class="o">:</span> <span class="p">[{</span>
      <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;myslug&quot;</span><span class="p">,</span>
      <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;myslug&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
      <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">{...}</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;ABCDEF&quot;</span><span class="p">,</span>
      <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;myslug&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
      <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">{...}</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;DEFABC&quot;</span><span class="p">,</span>
      <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;myslug&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
      <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">{...}</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;other_slug&quot;</span><span class="p">,</span>
      <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;other_slug&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
      <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">{...}</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;CDEFAB&quot;</span><span class="p">,</span>
      <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;other_slug&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
      <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">{...}</span>
    <span class="p">},</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal"><span class="pre">...</span></tt> placeholder here would contain the complete JSON encoding of the
corresponding document</p>
</div>
<p>Now, to get a specific blog post and all associated comments, we&#8217;d invoke that
view with the query string:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">?startkey</span><span class="o">=</span><span class="s">[&quot;myslug&quot;]&amp;endkey;=[&quot;myslug&quot;, 2]</span>
</pre></div>
</div>
<p>We&#8217;d get back the first three rows, those that belong to the <tt class="docutils literal"><span class="pre">myslug</span></tt> post,
but not the others. Et voila, we now have the data we need to display a post
with all associated comments, retrieved via a single <tt class="docutils literal"><span class="pre">GET</span></tt> request.</p>
<p>You may be asking what the 0 and 1 parts of the keys are for. They&#8217;re simply
to ensure that the post document is always sorted before the the associated
comment documents. So when you get back the results from this view for a
specific post, you&#8217;ll know that the first row contains the data for the blog
post itself, and the remaining rows contain the comment data.</p>
<p>One remaining problem with this model is that comments are not ordered, but
that&#8217;s simply because we don&#8217;t have date/time information associated with them.
If we had, we&#8217;d add the timestamp as third element of the key array, probably
as ISO date/time strings. Now we would continue using the query string
<tt class="docutils literal"><span class="pre">?startkey=[&quot;myslug&quot;]&amp;endkey=[&quot;myslug&quot;,</span> <span class="pre">2]</span></tt> to fetch the blog post and all
associated comments, only now they&#8217;d be in chronological order.</p>
</div>
</div>
</div>
<span id="document-couchapp/views/nosql"></span><div class="section" id="view-cookbook-for-sql-jockeys">
<span id="views-nosql"></span><h4>View Cookbook for SQL Jockeys<a class="headerlink" href="#view-cookbook-for-sql-jockeys" title="Permalink to this headline">¶</a></h4>
<p>This is a collection of some common SQL queries and how to get the same result
in CouchDB. The key to remember here is that CouchDB does not work like an SQL
database at all and that best practices from the SQL world do not translate well
or at all to CouchDB. This documents’s “cookbook” assumes that you are familiar
with the CouchDB basics such as creating and updating databases and documents.</p>
<div class="section" id="using-views">
<h5>Using Views<a class="headerlink" href="#using-views" title="Permalink to this headline">¶</a></h5>
<p>How you would do this in SQL:</p>
<div class="highlight-ini"><div class="highlight"><pre>CREATE TABLE
</pre></div>
</div>
<p>or:</p>
<div class="highlight-ini"><div class="highlight"><pre>ALTER TABLE
</pre></div>
</div>
<p>How you can do this in CouchDB?</p>
<p>Using views is a two-step process. First you define a view; then you query it.
This is analogous to defining a table structure (with indexes) using
<tt class="docutils literal"><span class="pre">CREATE</span> <span class="pre">TABLE</span></tt> or <tt class="docutils literal"><span class="pre">ALTER</span> <span class="pre">TABLE</span></tt> and querying it using an SQL query.</p>
<div class="section" id="defining-a-view">
<h6>Defining a View<a class="headerlink" href="#defining-a-view" title="Permalink to this headline">¶</a></h6>
<p>Defining a view is done by creating a special document in a CouchDB database.
The only real specialness is the <tt class="docutils literal"><span class="pre">_id</span></tt> of the document, which starts with
<tt class="docutils literal"><span class="pre">_design/</span></tt> — for example, _design/application. Other than that, it is just a
regular CouchDB document. To make sure CouchDB understands that you are defining
a view, you need to prepare the contents of that design document in a special
format. Here is an example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;_design/application&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-C1687D17&quot;</span><span class="p">,</span>
  <span class="s2">&quot;views&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;viewname&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;map&quot;</span><span class="o">:</span> <span class="s2">&quot;function(doc) { ... }&quot;</span><span class="p">,</span>
      <span class="s2">&quot;reduce&quot;</span><span class="o">:</span> <span class="s2">&quot;function(keys, values) { ... }&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We are defining a view <cite>viewname</cite>. The definition of the view consists of two
functions: the map function and the reduce function. Specifying a reduce
function is optional. We’ll look at the nature of the functions later. Note that
<cite>viewname</cite> can be whatever you like: <tt class="docutils literal"><span class="pre">users</span></tt>, <tt class="docutils literal"><span class="pre">by-name</span></tt>, or <tt class="docutils literal"><span class="pre">by-date</span></tt> are
just some examples.</p>
<p>A single design document can also include multiple view definitions, each
identified by a unique name:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;_design/application&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-C1687D17&quot;</span><span class="p">,</span>
  <span class="s2">&quot;views&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;viewname&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;map&quot;</span><span class="o">:</span> <span class="s2">&quot;function(doc) { ... }&quot;</span><span class="p">,</span>
      <span class="s2">&quot;reduce&quot;</span><span class="o">:</span> <span class="s2">&quot;function(keys, values) { ... }&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;anotherview&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;map&quot;</span><span class="o">:</span> <span class="s2">&quot;function(doc) { ... }&quot;</span><span class="p">,</span>
      <span class="s2">&quot;reduce&quot;</span><span class="o">:</span> <span class="s2">&quot;function(keys, values) { ... }&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="querying-a-view">
<h6>Querying a View<a class="headerlink" href="#querying-a-view" title="Permalink to this headline">¶</a></h6>
<p>The name of the design document and the name of the view are significant for
querying the view. To query the view <cite>viewname</cite>, you perform an HTTP <tt class="docutils literal"><span class="pre">GET</span></tt>
request to the following URI:</p>
<div class="highlight-ini"><div class="highlight"><pre>/database/_design/application/_view/viewname
</pre></div>
</div>
<p>database is the name of the database you created your design document in. Next
up is the design document name, and then the view name prefixed with <tt class="docutils literal"><span class="pre">_view/</span></tt>.
To query <cite>anotherview</cite>, replace <cite>viewname</cite> in that URI with <cite>anotherview</cite>.
If you want to query a view in a different design document, adjust the design
document name.</p>
</div>
<div class="section" id="mapreduce-functions">
<h6>MapReduce Functions<a class="headerlink" href="#mapreduce-functions" title="Permalink to this headline">¶</a></h6>
<p>MapReduce is a concept that solves problems by applying a two-step process,
aptly named the map phase and the reduce phase. The map phase looks at all
documents in CouchDB separately one after the other and creates a <cite>map result</cite>.
The map result is an ordered list of key/value pairs. Both key and value can
be specified by the user writing the map function. A map function may call the
built-in <tt class="docutils literal"><span class="pre">emit(key,</span> <span class="pre">value)</span></tt> function 0 to N times per document, creating a row
in the map result per invocation.</p>
<p>CouchDB is smart enough to run a map function only once for every document, even
on subsequent queries on a view. Only changes to documents or new documents need
to be processed anew.</p>
</div>
<div class="section" id="map-functions">
<h6>Map functions<a class="headerlink" href="#map-functions" title="Permalink to this headline">¶</a></h6>
<p>Map functions run in isolation for every document. They can’t modify the
document, and they can’t talk to the outside world—they can’t have side effects.
This is required so that CouchDB can guarantee correct results without having
to recalculate a complete result when only one document gets changed.</p>
<p>The map result looks like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;total_rows&quot;</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;offset&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;fc2636bf50556346f1ce46b4bc01fe30&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Lena&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;1fb2449f9b9d4e466dbfa47ebe675063&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Lisa&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">4</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;8ede09f6f6aeb35d948485624b28f149&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Sarah&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">6</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>It is a list of rows sorted by the value of key. The id is added automatically
and refers back to the document that created this row. The value is the data
you’re looking for. For example purposes, it’s the girl’s age.</p>
<p>The map function that produces this result is:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">age</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">age</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It includes the if statement as a sanity check to ensure that we’re operating
on the right fields and calls the emit function with the name and age as the key
and value.</p>
</div>
</div>
<div class="section" id="look-up-by-key">
<h5>Look Up by Key<a class="headerlink" href="#look-up-by-key" title="Permalink to this headline">¶</a></h5>
<p>How you would do this in SQL:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">SELECT field FROM table WHERE value</span><span class="o">=</span><span class="s">&quot;searchterm&quot;</span>
</pre></div>
</div>
<p>How you can do this in CouchDB?</p>
<p>Use case: get a result (which can be a record or set of records) associated
with a key (&#8220;searchterm&#8221;).</p>
<p>To look something up quickly, regardless of the storage mechanism, an index is
needed. An index is a data structure optimized for quick search and retrieval.
CouchDB’s map result is stored in such an index, which happens to be a B+ tree.</p>
<p>To look up a value by &#8220;searchterm&#8221;, we need to put all values into the key of a
view. All we need is a simple map function:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This creates a list of documents that have a value field sorted by the data in
the value field. To find all the records that match &#8220;searchterm&#8221;, we query the
view and specify the search term as a query parameter:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">/database/_design/application/_view/viewname?key</span><span class="o">=</span><span class="s">&quot;searchterm&quot;</span>
</pre></div>
</div>
<p>Consider the documents from the previous section, and say we’re indexing on the
age field of the documents to find all the five-year-olds:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">age</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">age</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Query:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">/ladies/_design/ladies/_view/age?key</span><span class="o">=</span><span class="s">5</span>
</pre></div>
</div>
<p>Result:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;total_rows&quot;</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;offset&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;fc2636bf50556346f1ce46b4bc01fe30&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;Lena&quot;</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>Easy.</p>
<p>Note that you have to emit a value. The view result includes the associated
document ID in every row. We can use it to look up more data from the document
itself. We can also use the <tt class="docutils literal"><span class="pre">?include_docs=true</span></tt> parameter to have CouchDB
fetch the documents individually for us.</p>
</div>
<div class="section" id="look-up-by-prefix">
<h5>Look Up by Prefix<a class="headerlink" href="#look-up-by-prefix" title="Permalink to this headline">¶</a></h5>
<p>How you would do this in SQL:</p>
<div class="highlight-ini"><div class="highlight"><pre>SELECT field FROM table WHERE value LIKE &quot;searchterm%&quot;
</pre></div>
</div>
<p>How you can do this in CouchDB?</p>
<p>Use case: find all documents that have a field value that starts with
<cite>searchterm</cite>. For example, say you stored a MIME type (like <cite>text/html</cite> or
<cite>image/jpg</cite>) for each document and now you want to find all documents that are
images according to the MIME type.</p>
<p>The solution is very similar to the previous example: all we need is a map
function that is a little more clever than the first one. But first, an example
document:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;Hugh Laurie&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;1-9fded7deef52ac373119d05435581edf&quot;</span><span class="p">,</span>
  <span class="s2">&quot;mime-type&quot;</span><span class="o">:</span> <span class="s2">&quot;image/jpg&quot;</span><span class="p">,</span>
  <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;some dude&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The clue lies in extracting the prefix that we want to search for from our
document and putting it into our view index. We use a regular expression to
match our prefix:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="s2">&quot;mime-type&quot;</span><span class="p">])</span> <span class="p">{</span>
    <span class="c1">// from the start (^) match everything that is not a slash ([^\/]+) until</span>
    <span class="c1">// we find a slash (\/). Slashes needs to be escaped with a backslash (\/)</span>
    <span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">[</span><span class="s2">&quot;mime-type&quot;</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[^\/]+\//</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emit</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We can now query this view with our desired MIME type prefix and not only find
all images, but also text, video, and all other formats:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">/files/_design/finder/_view/by-mime-type?key</span><span class="o">=</span><span class="s">&quot;image/&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="aggregate-functions">
<h5>Aggregate Functions<a class="headerlink" href="#aggregate-functions" title="Permalink to this headline">¶</a></h5>
<p>How you would do this in SQL:</p>
<div class="highlight-ini"><div class="highlight"><pre>SELECT COUNT(field) FROM table
</pre></div>
</div>
<p>How you can do this in CouchDB?</p>
<p>Use case: calculate a derived value from your data.</p>
<p>We haven’t explained reduce functions yet. Reduce functions are similar to
aggregate functions in SQL. They compute a value over multiple documents.</p>
<p>To explain the mechanics of reduce functions, we’ll create one that doesn’t make
a whole lot of sense. But this example is easy to understand. We’ll explore more
useful reductions later.</p>
<p>Reduce functions operate on the output of the map function (also called the map
result or intermediate result). The reduce function’s job, unsurprisingly, is to
reduce the list that the map function produces.</p>
<p>Here’s what our summing reduce function looks like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sum</span> <span class="o">=</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">values</span><span class="p">[</span><span class="nx">idx</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">sum</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here’s an alternate, more idiomatic JavaScript version:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sum</span> <span class="o">=</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">element</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">sum</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Don&#8217;t miss effective builtin <a class="reference internal" href="contents.html#reducefun"><em>reduce functions</em></a> like <tt class="docutils literal"><span class="pre">_sum</span></tt>
and <tt class="docutils literal"><span class="pre">_count</span></tt></p>
</div>
<p>This reduce function takes two arguments: a list of keys and a list of values.
For our summing purposes we can ignore the keys-list and consider only the value
list. We’re looping over the list and add each item to a running total that
we’re returning at the end of the function.</p>
<p>You’ll see one difference between the map and the reduce function. The map
function uses <tt class="docutils literal"><span class="pre">emit()</span></tt> to create its result, whereas the reduce function
returns a value.</p>
<p>For example, from a list of integer values that specify the age, calculate the
sum of all years of life for the news headline,
<cite>“786 life years present at event.”</cite> A little contrived, but very simple and
thus good for demonstration purposes. Consider the documents and the map view we
used earlier in this document.</p>
<p>The reduce function to calculate the total age of all girls is:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that, instead of the two earlier versions, we use CouchDB’s predefined
<a class="reference internal" href="contents.html#sum" title="sum"><tt class="xref js js-func docutils literal"><span class="pre">sum()</span></tt></a> function. It does the same thing as the other two, but it is such
a common piece of code that CouchDB has it included.</p>
<p>The result for our reduce view now looks like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
  <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">15</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>The total sum of all age fields in all our documents is 15. Just what we wanted.
The key member of the result object is null, as we can’t know anymore which
documents took part in the creation of the reduced result. We’ll cover more
advanced reduce cases later on.</p>
<p>As a rule of thumb, the reduce function should reduce to a single scalar value.
That is, an integer; a string; or a small, fixed-size list or object that
includes an aggregated value (or values) from the values argument.
It should never just return values or similar. CouchDB will give you a warning
if you try to use reduce “the wrong way”:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;error&quot;</span><span class="o">:</span><span class="s2">&quot;reduce_overflow_error&quot;</span><span class="p">,</span>
  <span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;Reduce output must shrink more rapidly: Current output: ...&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="get-unique-values">
<h5>Get Unique Values<a class="headerlink" href="#get-unique-values" title="Permalink to this headline">¶</a></h5>
<p>How you would do this in SQL:</p>
<div class="highlight-ini"><div class="highlight"><pre>SELECT DISTINCT field FROM table
</pre></div>
</div>
<p>How you can do this in CouchDB?</p>
<p>Getting unique values is not as easy as adding a keyword. But a reduce view and
a special query parameter give us the same result. Let’s say you want a list of
tags that your users have tagged themselves with and no duplicates.</p>
<p>First, let’s look at the source documents. We punt on <tt class="docutils literal"><span class="pre">_id</span></tt> and <tt class="docutils literal"><span class="pre">_rev</span></tt>
attributes here:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Chris&quot;</span><span class="p">,</span>
  <span class="s2">&quot;tags&quot;</span><span class="o">:</span><span class="p">[</span><span class="s2">&quot;mustache&quot;</span><span class="p">,</span> <span class="s2">&quot;music&quot;</span><span class="p">,</span> <span class="s2">&quot;couchdb&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Noah&quot;</span><span class="p">,</span>
  <span class="s2">&quot;tags&quot;</span><span class="o">:</span><span class="p">[</span><span class="s2">&quot;hypertext&quot;</span><span class="p">,</span> <span class="s2">&quot;philosophy&quot;</span><span class="p">,</span> <span class="s2">&quot;couchdb&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
  <span class="s2">&quot;tags&quot;</span><span class="o">:</span><span class="p">[</span><span class="s2">&quot;drums&quot;</span><span class="p">,</span> <span class="s2">&quot;bike&quot;</span><span class="p">,</span> <span class="s2">&quot;couchdb&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next, we need a list of all tags. A map function will do the trick:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emit</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The result will look like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;total_rows&quot;</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;offset&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;3525ab874bc4965fa3cda7c549e92d30&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;bike&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;3525ab874bc4965fa3cda7c549e92d30&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;couchdb&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;53f82b1f0ff49a08ac79a9dff41d7860&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;couchdb&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;da5ea89448a4506925823f4d985aabbd&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;couchdb&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;3525ab874bc4965fa3cda7c549e92d30&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;drums&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;53f82b1f0ff49a08ac79a9dff41d7860&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;hypertext&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;da5ea89448a4506925823f4d985aabbd&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;music&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;da5ea89448a4506925823f4d985aabbd&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;mustache&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;53f82b1f0ff49a08ac79a9dff41d7860&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;philosophy&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>As promised, these are all the tags, including duplicates. Since each document
gets run through the map function in isolation, it cannot know if the same key
has been emitted already. At this stage, we need to live with that. To achieve
uniqueness, we need a reduce:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This reduce doesn’t do anything, but it allows us to specify a special query
parameter when querying the view:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">/dudes/_design/dude-data/_view/tags?group</span><span class="o">=</span><span class="s">true</span>
</pre></div>
</div>
<p>CouchDB replies:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;bike&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;couchdb&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;drums&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;hypertext&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;music&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;mustache&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;philosophy&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>In this case, we can ignore the value part because it is always true, but the
result includes a list of all our tags and no duplicates!</p>
<p>With a small change we can put the reduce to good use, too. Let’s see how many
of the non-unique tags are there for each tag. To calculate the tag frequency,
we just use the summing up we already learned about. In the map function,
we emit a 1 instead of null:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emit</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the reduce function, we return the sum of all values:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, if we query the view with the <tt class="docutils literal"><span class="pre">?group=true</span></tt> parameter, we get back the
count for each tag:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;bike&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;couchdb&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">3</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;drums&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;hypertext&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;music&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;mustache&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span>
<span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;philosophy&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
</div>
<div class="section" id="enforcing-uniqueness">
<h5>Enforcing Uniqueness<a class="headerlink" href="#enforcing-uniqueness" title="Permalink to this headline">¶</a></h5>
<p>How you would do this in SQL:</p>
<div class="highlight-ini"><div class="highlight"><pre>UNIQUE KEY(column)
</pre></div>
</div>
<p>How you can do this in CouchDB?</p>
<p>Use case: your applications require that a certain value exists only once in a
database.</p>
<p>This is an easy one: within a CouchDB database, each document must have a
unique <tt class="docutils literal"><span class="pre">_id</span></tt> field. If you require unique values in a database, just assign
them to a document’s <tt class="docutils literal"><span class="pre">_id</span></tt> field and CouchDB will enforce uniqueness for you.</p>
<p>There’s one caveat, though: in the distributed case, when you are running more
than one CouchDB node that accepts write requests, uniqueness can be guaranteed
only per node or outside of CouchDB. CouchDB will allow two identical IDs to be
written to two different nodes. On replication, CouchDB will detect a conflict
and flag the document accordingly.</p>
</div>
</div>
<span id="document-couchapp/views/pagination"></span><div class="section" id="pagination-recipe">
<span id="views-pagination"></span><h4>Pagination Recipe<a class="headerlink" href="#pagination-recipe" title="Permalink to this headline">¶</a></h4>
<p>This recipe explains how to paginate over view results.
Pagination is a user interface (UI) pattern that allows the display of a
large number of rows (<cite>the result set</cite>) without loading all the rows into the
UI at once. A fixed-size subset, the <cite>page</cite>, is displayed along with next and
previous links or buttons that can move the <cite>viewport</cite> over the result set to
an adjacent page.</p>
<p>We assume you’re familiar with creating and querying documents and views as
well as the multiple view query options.</p>
<div class="section" id="example-data">
<h5>Example Data<a class="headerlink" href="#example-data" title="Permalink to this headline">¶</a></h5>
<p>To have some data to work with, we’ll create a list of bands,
one document per band:</p>
<div class="highlight-ini"><div class="highlight"><pre>{ &quot;name&quot;:&quot;Biffy Clyro&quot; }

{ &quot;name&quot;:&quot;Foo Fighters&quot; }

{ &quot;name&quot;:&quot;Tool&quot; }

{ &quot;name&quot;:&quot;Nirvana&quot; }

{ &quot;name&quot;:&quot;Helmet&quot; }

{ &quot;name&quot;:&quot;Tenacious D&quot; }

{ &quot;name&quot;:&quot;Future of the Left&quot; }

{ &quot;name&quot;:&quot;A Perfect Circle&quot; }

{ &quot;name&quot;:&quot;Silverchair&quot; }

{ &quot;name&quot;:&quot;Queens of the Stone Age&quot; }

{ &quot;name&quot;:&quot;Kerub&quot; }
</pre></div>
</div>
</div>
<div class="section" id="a-view">
<h5>A View<a class="headerlink" href="#a-view" title="Permalink to this headline">¶</a></h5>
<p>We need a simple map function that gives us an alphabetical list of band
names. This should be easy, but we’re adding extra smarts to filter out “The”
and “A” in front of band names to put them into the right position:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(A|The) /</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The views result is an alphabetical list of band names. Now say we want to
display band names five at a time and have a link pointing to the next five
names that make up one page, and a link for the previous five,
if we’re not on the first page.</p>
<p>We learned how to use the <tt class="docutils literal"><span class="pre">startkey</span></tt>, <tt class="docutils literal"><span class="pre">limit</span></tt>, and <tt class="docutils literal"><span class="pre">skip</span></tt> parameters in
earlier documents. We’ll use these again here. First, let’s have a look at
the full result set:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;total_rows&quot;</span><span class="o">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">&quot;offset&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;a0746072bba60a62b01209f467ca4fe2&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Biffy Clyro&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;b47d82284969f10cd1b6ea460ad62d00&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Foo Fighters&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;45ccde324611f86ad4932555dea7fce0&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Tenacious D&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;d7ab24bb3489a9010c7d1a2087a4a9e4&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Future of the Left&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;ad2f85ef87f5a9a65db5b3a75a03cd82&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Helmet&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;a2f31cfa68118a6ae9d35444fcb1a3cf&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Nirvana&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;67373171d0f626b811bdc34e92e77901&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Kerub&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;3e1b84630c384f6aef1a5c50a81e4a34&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Perfect Circle&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;84a371a7b8414237fad1b6aaf68cd16a&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Queens of the Stone Age&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;dcdaf08242a4be7da1a36e25f4f0b022&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Silverchair&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;fd590d4ad53771db47b0406054f02243&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Tool&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
</div>
<div class="section" id="setup">
<h5>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h5>
<p>The mechanics of paging are very simple:</p>
<ul class="simple">
<li>Display first page</li>
<li>If there are more rows to show, show next link</li>
<li>Draw subsequent page</li>
<li>If this is not the first page, show a previous link</li>
<li>If there are more rows to show, show next link</li>
</ul>
<p>Or in a pseudo-JavaScript snippet:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Result</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">getPage</span><span class="p">();</span>

<span class="nx">page</span><span class="p">.</span><span class="nx">display</span><span class="p">();</span>

<span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">hasPrev</span><span class="p">())</span> <span class="p">{</span>
  <span class="nx">page</span><span class="p">.</span><span class="nx">display_link</span><span class="p">(</span><span class="s1">&#39;prev&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">hasNext</span><span class="p">())</span> <span class="p">{</span>
  <span class="nx">page</span><span class="p">.</span><span class="nx">display_link</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="paging">
<h5>Paging<a class="headerlink" href="#paging" title="Permalink to this headline">¶</a></h5>
<p>To get the first five rows from the view result, you use the <tt class="docutils literal"><span class="pre">?limit=5</span></tt>
query parameter:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">curl -X GET http://127.0.0.1:5984/artists/_design/artists/_view/by-name?limit</span><span class="o">=</span><span class="s">5</span>
</pre></div>
</div>
<p>The result:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;total_rows&quot;</span><span class="o">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">&quot;offset&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;a0746072bba60a62b01209f467ca4fe2&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Biffy Clyro&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;b47d82284969f10cd1b6ea460ad62d00&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Foo Fighters&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;45ccde324611f86ad4932555dea7fce0&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Tenacious D&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;d7ab24bb3489a9010c7d1a2087a4a9e4&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Future of the Left&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;ad2f85ef87f5a9a65db5b3a75a03cd82&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Helmet&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>By comparing the <tt class="docutils literal"><span class="pre">total_rows</span></tt> value to our <tt class="docutils literal"><span class="pre">limit</span></tt> value,
we can determine if there are more pages to display. We also know by the
<cite>offset</cite> member that we are on the first page. We can calculate the value for
<tt class="docutils literal"><span class="pre">skip=</span></tt> to get the results for the next page:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">rows_per_page</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">page</span> <span class="o">=</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">/</span> <span class="nx">rows_per_page</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// == 1</span>
<span class="kd">var</span> <span class="nx">skip</span> <span class="o">=</span> <span class="nx">page</span> <span class="o">*</span> <span class="nx">rows_per_page</span><span class="p">;</span> <span class="c1">// == 5 for the first page, 10 for the second ...</span>
</pre></div>
</div>
<p>So we query CouchDB with:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">curl -X GET &#39;http://127.0.0.1:5984/artists/_design/artists/_view/by-name?limit</span><span class="o">=</span><span class="s">5&amp;skip=5&#39;</span>
</pre></div>
</div>
<p>Note we have to use <tt class="docutils literal"><span class="pre">'</span></tt> (single quotes) to escape the <tt class="docutils literal"><span class="pre">&amp;</span></tt> character that is
special to the shell we execute curl in.</p>
<p>The result:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;total_rows&quot;</span><span class="o">:</span><span class="mi">11</span><span class="p">,</span><span class="s2">&quot;offset&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;a2f31cfa68118a6ae9d35444fcb1a3cf&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Nirvana&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;67373171d0f626b811bdc34e92e77901&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Kerub&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;3e1b84630c384f6aef1a5c50a81e4a34&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Perfect Circle&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;84a371a7b8414237fad1b6aaf68cd16a&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Queens of the Stone Age&quot;</span><span class="p">,</span>
  <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;dcdaf08242a4be7da1a36e25f4f0b022&quot;</span><span class="p">,</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;Silverchair&quot;</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>Implementing the <tt class="docutils literal"><span class="pre">hasPrev()</span></tt> and <tt class="docutils literal"><span class="pre">hasNext()</span></tt> method is pretty
straightforward:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">hasPrev</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="nx">page</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">hasNext</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kd">var</span> <span class="nx">last_page</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">total_rows</span> <span class="o">/</span> <span class="nx">rows_per_page</span><span class="p">)</span> <span class="o">+</span>
    <span class="p">(</span><span class="nx">total_rows</span> <span class="o">%</span> <span class="nx">rows_per_page</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">page</span> <span class="o">!=</span> <span class="nx">last_page</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="paging-alternate-method">
<h5>Paging (Alternate Method)<a class="headerlink" href="#paging-alternate-method" title="Permalink to this headline">¶</a></h5>
<p>The method described above performed poorly with large skip values until
CouchDB 1.2. Additionally, some use cases may call for the following
alternate method even with newer versions of CouchDB. One such case is when
duplicate results should be prevented. Using skip alone it is possible for
new documents to be inserted during pagination which could change the offset
of the start of the subsequent page.</p>
<p>A correct solution is not much harder. Instead of slicing the result set
into equally sized pages, we look at 10 rows at a time and use <tt class="docutils literal"><span class="pre">startkey</span></tt> to
jump to the next 10 rows. We even use skip, but only with the value 1.</p>
<p>Here is how it works:</p>
<ul class="simple">
<li>Request <cite>rows_per_page + 1</cite> rows from the view</li>
<li>Display <cite>rows_per_page</cite> rows, <cite>store + 1</cite> row as <cite>next_startkey</cite> and
<cite>next_startkey_docid</cite></li>
<li>As page information, keep <tt class="docutils literal"><span class="pre">startkey</span></tt> and <cite>next_startkey</cite></li>
<li>Use the <cite>next_*</cite> values to create the next link, and use the others to
create the previous link</li>
</ul>
<p>The trick to finding the next page is pretty simple. Instead of requesting 10
rows for a page, you request 11 rows, but display only 10 and use the values
in the 11th row as the <tt class="docutils literal"><span class="pre">startkey</span></tt> for the next page. Populating the link to
the previous page is as simple as carrying the current <tt class="docutils literal"><span class="pre">startkey</span></tt> over to the
next page. If there’s no previous <tt class="docutils literal"><span class="pre">startkey</span></tt>, we are on the first page. We
stop displaying the link to the next page if we get <cite>rows_per_page</cite> or less
rows back. This is called linked list pagination, as we go from page to
page, or list item to list item, instead of jumping directly to a
pre-computed page. There is one caveat, though. Can you spot it?</p>
<p>CouchDB view keys do not have to be unique; you can have multiple index
entries read. What if you have more index entries for a key than rows that
should be on a page? <tt class="docutils literal"><span class="pre">startkey</span></tt> jumps to the first row, and you’d be screwed
if CouchDB didn’t have an additional parameter for you to use. All view keys
with the same value are internally sorted by <cite>docid</cite>, that is, the ID of
the document that created that view row. You can use the <tt class="docutils literal"><span class="pre">startkey_docid</span></tt>
and <tt class="docutils literal"><span class="pre">endkey_docid</span></tt> parameters to get subsets of these rows. For
pagination, we still don’t need <tt class="docutils literal"><span class="pre">endkey_docid</span></tt>, but <tt class="docutils literal"><span class="pre">startkey_docid</span></tt> is very
handy. In addition to <tt class="docutils literal"><span class="pre">startkey</span></tt> and <tt class="docutils literal"><span class="pre">limit</span></tt>, you also use
<tt class="docutils literal"><span class="pre">startkey_docid</span></tt> for pagination if, and only if, the extra row you fetch to
find the next page has the same key as the current <tt class="docutils literal"><span class="pre">startkey</span></tt>.</p>
<p>It is important to note that the <cite>*_docid</cite> parameters only work in addition to
the <cite>*key</cite> parameters and are only useful to further narrow down the result set
of a view for a single key. They do not work on their own (the one exception
being the built-in <a class="reference internal" href="contents.html#api-db-all-docs"><em>_all_docs view</em></a>  that already sorts
by document ID).</p>
<p>The advantage of this approach is that all the key operations can be
performed on the super-fast B-tree index behind the view. Looking up a page
doesn’t include scanning through hundreds and thousands of rows unnecessarily.</p>
</div>
<div class="section" id="jump-to-page">
<h5>Jump to Page<a class="headerlink" href="#jump-to-page" title="Permalink to this headline">¶</a></h5>
<p>One drawback of the linked list style pagination is that you can’t
pre-compute the rows for a particular page from the page number and the rows
per page. Jumping to a specific page doesn’t really work. Our gut reaction,
if that concern is raised, is, “Not even Google is doing that!” and we tend
to get away with it. Google always pretends on the first page to find 10 more
pages of results. Only if you click on the second page (something very few
people actually do) might Google display a reduced set of pages. If you page
through the results, you get links for the previous and next 10 pages,
but no more. Pre-computing the necessary <tt class="docutils literal"><span class="pre">startkey</span></tt> and <tt class="docutils literal"><span class="pre">startkey_docid</span></tt>
for 20 pages is a feasible operation and a pragmatic optimization to know the
rows for every page in a result set that is potentially tens of thousands
of rows long, or more.</p>
<p>If you really do need to jump to a page over the full range of documents (we
have seen applications that require that), you can still maintain an integer
value index as the view index and take a hybrid approach at solving pagination.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<span id="document-externals"></span><div class="section" id="couchdb-externals-api">
<span id="externals"></span><h2>CouchDB Externals API<a class="headerlink" href="#couchdb-externals-api" title="Permalink to this headline">¶</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Paul Joseph Davis</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">2010-09-26</td>
</tr>
<tr class="field-odd field"><th class="field-name">Source:</th><td class="field-body"><a class="reference external" href="http://davispj.com/2010/09/26/new-couchdb-externals-api.html">http://davispj.com/2010/09/26/new-couchdb-externals-api.html</a></td>
</tr>
</tbody>
</table>
<p>For a bit of background, CouchDB has had an API for managing <a class="reference external" href="http://wiki.apache.org/couchdb/ExternalProcesses">external OS
processes</a> that are capable of handling HTTP requests for a given
URL prefix. These OS processes communicate with CouchDB using JSON over
stdio. They&#8217;re dead simple to write and provide CouchDB users an easy way to
extend CouchDB functionality.</p>
<p>Even though they&#8217;re dead simple to write, there are a few issues. The
implementation in CouchDB does not provide fancy pooling semantics. The
current API is explicitly synchronous which prevents people from writing
event driven code in an external handler. In the end, they may be simple,
but their simplicity is also quite limiting.</p>
<p>During CouchCamp a few weeks ago I had multiple discussions with various people
that wanted to see the _externals API modified in slight ways that weren&#8217;t
mutually compatible. After having multiple discussions with multiple people
we formed a general consensus on what a new API could look like.</p>
<div class="section" id="the-new-hotness">
<h3>The New Hotness<a class="headerlink" href="#the-new-hotness" title="Permalink to this headline">¶</a></h3>
<p>So the first idea for improving the _external API was to make CouchDB act as
a reverse proxy. This would allow people to write an HTTP server that was as
simple or as complicated as they wanted. It will allow people to change their
networking configuration more easily and also allow for external processes to
be hosted on nodes other than the one running CouchDB. Bottom line, it not
only allows us to have similar semantics as _externals, it provides a lot more
fringe benefits as well. I&#8217;m always a fan of extra awesomeness.</p>
<p>After hitting on the idea of adding a reverse proxy, people quickly pointed
out that it would require users to start manually managing their external
processes using something like <a class="reference external" href="http://smarden.org/runit/">Runit</a> or <a class="reference external" href="http://supervisord.org/">Supervisord</a>. After some
more discussions I ran into people that wanted something like _externals that
didn&#8217;t handle HTTP requests. After that it was easy to see that adding a second
feature that managed OS processes was the way to go.</p>
<p>I spent this weekend implementing both of these features. Both are at the stage
of working but requiring more testing. In the case of the HTTP proxy I have no
tests because I can&#8217;t decide how to test the thing. If you have ideas, I&#8217;d
sure like to hear them.</p>
<p><strong>[Update]</strong>: I woke up the other morning realizing that I was being an idiot
and that Erlang is awesome. There&#8217;s no reason that I can&#8217;t have an HTTP client,
proxy, and server all hosted in the same process. So that&#8217;s what I did. It
turns out to be a fairly nice way of configuring matching assertions between
the client and the server to test the proxy transmissions.</p>
</div>
<div class="section" id="how-does-it-work-http-proxying">
<h3>How does it work? - HTTP Proxying<a class="headerlink" href="#how-does-it-work-http-proxying" title="Permalink to this headline">¶</a></h3>
<p>To configure a <a class="reference internal" href="contents.html#config-proxy"><em>proxy handler</em></a>, edit your <cite>local.ini</cite> and
add a section like such:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_fti</span> <span class="o">=</span> <span class="s">{couch_httpd_proxy, handle_proxy_req, &lt;&lt;&quot;http://127.0.0.1:5985&quot;&gt;&gt;}</span>
</pre></div>
</div>
<p>This would be approximately what you&#8217;d need to do to get <a class="reference external" href="https://github.com/rnewson/couchdb-lucene">CouchDB-Lucene</a>
handled through this interface. The URL you use to access a query would be:</p>
<blockquote>
<div><a class="reference external" href="http://127.0.0.1:5984/_fti/db_name/_design/foo/by_content?q=hello">http://127.0.0.1:5984/_fti/db_name/_design/foo/by_content?q=hello</a></div></blockquote>
<p>A couple things to note here. Anything in the path after the configured proxy
name (&#8220;_fti&#8221; in this case) will be appended to the configured destination URL
(&#8220;<a class="reference external" href="http://127.0.0.1:5985">http://127.0.0.1:5985</a>&#8221; in this case). The query string and any associated
body will also be proxied transparently.</p>
<p>Also, of note is that there&#8217;s nothing that limits on what resources can be
proxied. You&#8217;re free to choose any destination that the CouchDB node is capable
of communicating with.</p>
</div>
<div class="section" id="how-does-it-work-os-daemons">
<h3>How does it work? - OS Daemons<a class="headerlink" href="#how-does-it-work-os-daemons" title="Permalink to this headline">¶</a></h3>
<p>The second part of the new API gives CouchDB simple OS process management. When
CouchDB boots it will start each configured OS daemon. If one of these daemons
fails at some point, it will be restarted. If one of these daemons fails too
often, CouchDB will stop attempting to start it.</p>
<p>OS daemons are one-to-one. For each daemon, CouchDB will make sure that exactly
one instance of it is alive. If you have something where you want multiple
processes, you need to either tell CouchDB about each one, or have a main
process that forks off the required sub-processes.</p>
<p>To configure an <a class="reference internal" href="contents.html#os_daemons" title="[os_daemons]"><tt class="xref config config-section docutils literal"><span class="pre">OS</span> <span class="pre">daemon</span></tt></a>, add this to your
<cite>local.ini</cite>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[os_daemons]</span>
<span class="na">my_daemon</span> <span class="o">=</span> <span class="s">/path/to/command -with args</span>
</pre></div>
</div>
<div class="section" id="configuration-api">
<h4>Configuration API<a class="headerlink" href="#configuration-api" title="Permalink to this headline">¶</a></h4>
<p>As an added benefit, because stdio is now free, I implemented a simple API
that OS daemons can use to read the configuration of their CouchDB host. This
way you can have them store their configuration inside CouchDB&#8217;s config system
if you desire. Or they can peek at things like the
<a class="reference internal" href="contents.html#httpd/bind_address" title="bind_address"><tt class="xref config config-option docutils literal"><span class="pre">httpd/bind_address</span></tt></a> and <a class="reference internal" href="contents.html#httpd/port" title="port"><tt class="xref config config-option docutils literal"><span class="pre">httpd/port</span></tt></a> that CouchDB
is using.</p>
<p>A request for a config section looks like this:</p>
<div class="highlight-ini"><div class="highlight"><pre>[&quot;get&quot;, &quot;os_daemons&quot;]\n
</pre></div>
</div>
<p>And the response:</p>
<div class="highlight-ini"><div class="highlight"><pre>{&quot;my_daemon&quot;: &quot;/path/to/command -with args&quot;}\n
</pre></div>
</div>
<p>Or to get a specific key:</p>
<div class="highlight-ini"><div class="highlight"><pre>[&quot;get&quot;, &quot;os_daemons&quot;, &quot;my_daemon&quot;]\n
</pre></div>
</div>
<p>And the response:</p>
<div class="highlight-ini"><div class="highlight"><pre>&quot;/path/to/command -with args&quot;\n
</pre></div>
</div>
<p>All requests and responses are terminated with a newline (indicated by <tt class="docutils literal"><span class="pre">\n</span></tt>).</p>
</div>
<div class="section" id="logging-api">
<h4>Logging API<a class="headerlink" href="#logging-api" title="Permalink to this headline">¶</a></h4>
<p>There&#8217;s also an API for adding messages to CouchDB&#8217;s logs. Its simply:</p>
<div class="highlight-ini"><div class="highlight"><pre>[&quot;log&quot;, $MESG]\n
</pre></div>
</div>
<p>Where <tt class="docutils literal"><span class="pre">$MESG</span></tt> is any arbitrary JSON. There is no response from this command. As
with the config API, the trailing <tt class="docutils literal"><span class="pre">\n</span></tt> represents a newline byte.</p>
</div>
<div class="section" id="dynamic-daemons">
<h4>Dynamic Daemons<a class="headerlink" href="#dynamic-daemons" title="Permalink to this headline">¶</a></h4>
<p>The OS daemons react in real time to changes to the configuration system. If
you set or delete keys in the <a class="reference internal" href="contents.html#os_daemons" title="[os_daemons]"><tt class="xref config config-section docutils literal"><span class="pre">os_daemons</span></tt></a> section,
the corresponding daemons will be started or killed as appropriate.</p>
</div>
</div>
<div class="section" id="neat-but-so-what">
<h3>Neat. But So What?<a class="headerlink" href="#neat-but-so-what" title="Permalink to this headline">¶</a></h3>
<p>It was suggested that a good first demo would be a <a class="reference external" href="http://nodejs.org/">Node.js</a> handler. So, I
present to you a &#8220;Hello, World&#8221; Node.js handler. Also, remember that this
currently relies on code in my fork on <a class="reference external" href="http://github.com/davisp/couchdb/tree/new_externals">GitHub</a>.</p>
<p>File <cite>node-hello-world.js</cite>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">);</span>

<span class="c1">// Send a log message to be included in CouchDB&#39;s</span>
<span class="c1">// log files.</span>

<span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mesg</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">([</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="nx">mesg</span><span class="p">]));</span>
<span class="p">}</span>

<span class="c1">// The Node.js example HTTP server</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">resp</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">});</span>
  <span class="nx">resp</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;Hello World\n&#39;</span><span class="p">);</span>
  <span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
<span class="p">})</span>

<span class="c1">// We use stdin in a couple ways. First, we</span>
<span class="c1">// listen for data that will be the requested</span>
<span class="c1">// port information. We also listen for it</span>
<span class="c1">// to close which indicates that CouchDB has</span>
<span class="c1">// exited and that means its time for us to</span>
<span class="c1">// exit as well.</span>

<span class="kd">var</span> <span class="nx">stdin</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">openStdin</span><span class="p">();</span>

<span class="nx">stdin</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">d</span><span class="p">)));</span>
<span class="p">});</span>

<span class="nx">stdin</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Send the request for the port to listen on.</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">([</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;node_hello&quot;</span><span class="p">,</span> <span class="s2">&quot;port&quot;</span><span class="p">]));</span>
</pre></div>
</div>
<p>File <cite>local.ini</cite> (Just add these to what you have):</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[log]</span>
<span class="na">level</span> <span class="o">=</span> <span class="s">info</span>

<span class="k">[os_daemons]</span>
<span class="na">node_hello</span> <span class="o">=</span> <span class="s">/path/to/node-hello-world.js</span>

<span class="k">[node_hello]</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">8000</span>

<span class="k">[httpd_global_handlers]</span>
<span class="na">_hello</span> <span class="o">=</span> <span class="s">{couch_httpd_proxy, handle_proxy_req, &lt;&lt;&quot;http://127.0.0.1:8000&quot;&gt;&gt;}</span>
</pre></div>
</div>
<p>And then start CouchDB and try:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>curl -v http://127.0.0.1:5984/_hello
* About to connect<span class="o">()</span> to 127.0.0.1 port <span class="m">5984</span> <span class="o">(</span><span class="c">#0)</span>
*   Trying 127.0.0.1... connected
* Connected to 127.0.0.1 <span class="o">(</span>127.0.0.1<span class="o">)</span> port <span class="m">5984</span> <span class="o">(</span><span class="c">#0)</span>
&gt; GET /_hello HTTP/1.1
&gt; User-Agent: curl/7.19.7 <span class="o">(</span>universal-apple-darwin10.0<span class="o">)</span> libcurl/7.19.7 OpenSSL/0.9.8l zlib/1.2.3
&gt; Host: 127.0.0.1:5984
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200
&lt; Transfer-Encoding: chunked
&lt; Server: CouchDB <span class="o">(</span>Erlang/OTP<span class="o">)</span>
&lt; Date: Mon, <span class="m">27</span> Sep <span class="m">2010</span> 01:13:37 GMT
&lt; Content-Type: text/plain
&lt; Connection: keep-alive
&lt;
Hello World
* Connection <span class="c">#0 to host 127.0.0.1 left intact</span>
* Closing connection <span class="c">#0</span>
</pre></div>
</div>
<p>The corresponding CouchDB logs look like:</p>
<div class="highlight-ini"><div class="highlight"><pre>Apache CouchDB 1.5.0 (LogLevel=info) is starting.
Apache CouchDB has started. Time to relax.
[info] [&lt;0.31.0&gt;] Apache CouchDB has started on http://127.0.0.1:5984/
[info] [&lt;0.105.0&gt;] 127.0.0.1 - - &#39;GET&#39; /_hello 200
[info] [&lt;0.95.0&gt;] Daemon &quot;node-hello&quot; :: GET /
</pre></div>
</div>
</div>
</div>
<span id="document-query-server/index"></span><div class="section" id="query-server">
<span id="id1"></span><h2>Query Server<a class="headerlink" href="#query-server" title="Permalink to this headline">¶</a></h2>
<p>The <cite>Query server</cite> is an external process that communicates with CouchDB by JSON
protocol through stdio interface and processed all
<a class="reference internal" href="contents.html#ddocs"><em>design functions</em></a> calls:
<a class="reference internal" href="contents.html#viewfun"><em>views</em></a>, <a class="reference internal" href="contents.html#showfun"><em>shows</em></a>, <a class="reference internal" href="contents.html#listfun"><em>lists</em></a> and more.</p>
<p>The default query server is written in
<a class="reference internal" href="contents.html#query-server-js"><em>JavaScript</em></a>, running via <a class="reference external" href="https://developer.mozilla.org/en/docs/SpiderMonkey">Mozilla SpiderMonkey</a>.
You can use other languages by setting a Query server key in the <tt class="docutils literal"><span class="pre">language</span></tt>
property of a design document or the <cite>Content-Type</cite> header of a
<cite>temporary view</cite>. Design documents that do not specify a <tt class="docutils literal"><span class="pre">language</span></tt> property
are assumed to be of type <cite>javascript</cite>, as are ad hoc queries that are POSTed to
<a class="reference internal" href="contents.html#api-db-temp-view"><em>_temp_view</em></a> without a <cite>Content-Type</cite> header.</p>
<div class="toctree-wrapper compound">
<span id="document-query-server/protocol"></span><div class="section" id="query-server-protocol">
<span id="id1"></span><h3>Query Server Protocol<a class="headerlink" href="#query-server-protocol" title="Permalink to this headline">¶</a></h3>
<p>The <cite>Query Server</cite> is an external process that communicates with CouchDB via a
JSON protocol over stdio  and processes all design functions calls:
<cite>views</cite>, <cite>shows</cite>, <cite>lists</cite>, <cite>filters</cite>, <cite>updates</cite> and <cite>validate_doc_update</cite>.</p>
<p>CouchDB communicates with the Query Server process though stdio interface by
JSON messages that terminated by newline character. Messages that are sent to
the Query Server are always <cite>array</cite>-typed that could be matched by the pattern
<tt class="docutils literal"><span class="pre">[&lt;command&gt;,</span> <span class="pre">&lt;*arguments&gt;]\n</span></tt>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To simplify examples reading we omitted trailing <tt class="docutils literal"><span class="pre">\n</span></tt> character to let
Sphinx highlight them well. Also, all examples contain formatted JSON values
while real data transfers in compact mode without formatting spaces.</p>
</div>
<div class="section" id="reset">
<span id="qs-reset"></span><h4><tt class="docutils literal"><span class="pre">reset</span></tt><a class="headerlink" href="#reset" title="Permalink to this headline">¶</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><tt class="docutils literal"><span class="pre">reset</span></tt></td>
</tr>
<tr class="field-even field"><th class="field-name">Arguments:</th><td class="field-body"><a class="reference internal" href="contents.html#config-query-server-config"><em>Query server state</em></a> (optional)</td>
</tr>
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body"><tt class="docutils literal"><span class="pre">true</span></tt></td>
</tr>
</tbody>
</table>
<p>This resets the state of the Query Server and makes it forget all previous
input. If applicable, this is the point to run garbage collection.</p>
<p>CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[&quot;reset&quot;]</span>
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>true
</pre></div>
</div>
<p>To set up new Query Server state the second argument is used with object data.
This argument is used</p>
<p>CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[&quot;reset&quot;, {&quot;reduce_limit&quot;: true, &quot;timeout&quot;: 5000}]</span>
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>true
</pre></div>
</div>
</div>
<div class="section" id="add-lib">
<span id="qs-add-lib"></span><h4><tt class="docutils literal"><span class="pre">add_lib</span></tt><a class="headerlink" href="#add-lib" title="Permalink to this headline">¶</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><tt class="docutils literal"><span class="pre">add_lib</span></tt></td>
</tr>
<tr class="field-even field"><th class="field-name">Arguments:</th><td class="field-body">CommonJS library object by <tt class="docutils literal"><span class="pre">views/lib</span></tt> path</td>
</tr>
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body"><tt class="docutils literal"><span class="pre">true</span></tt></td>
</tr>
</tbody>
</table>
<p>Adds <a class="reference internal" href="contents.html#commonjs"><em>CommonJS</em></a> library to Query Server state for further usage
in <cite>map</cite> functions.</p>
<p>CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;add_lib&quot;,
  {
    &quot;utils&quot;: &quot;exports.MAGIC = 42;&quot;
  }
]
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>true
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This library shouldn&#8217;t have any side effects nor track its own state
or you&#8217;ll have a lot of happy debugging time if something went wrong.
Remember that a complete index rebuild is a heavy operation and this is
the only way to fix your mistakes with shared state.</p>
</div>
<div class="section" id="add-fun">
<span id="qs-add-fun"></span><h5><tt class="docutils literal"><span class="pre">add_fun</span></tt><a class="headerlink" href="#add-fun" title="Permalink to this headline">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><tt class="docutils literal"><span class="pre">add_fun</span></tt></td>
</tr>
<tr class="field-even field"><th class="field-name">Arguments:</th><td class="field-body">Map function source code.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body"><tt class="docutils literal"><span class="pre">true</span></tt></td>
</tr>
</tbody>
</table>
<p>When creating or updating a view the Query Server gets sent the view function
for evaluation. The Query Server should parse, compile and evaluate the
function it receives to make it callable later. If this fails, the Query Server
returns an error. CouchDB might store several functions before sending in any
actual documents.</p>
<p>CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;add_fun&quot;,
  &quot;function(doc) { if(doc.score &gt; 50) emit(null, {&#39;player_name&#39;: doc.name}); }&quot;
]
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>true
</pre></div>
</div>
</div>
</div>
<div class="section" id="map-doc">
<span id="qs-map-doc"></span><h4><tt class="docutils literal"><span class="pre">map_doc</span></tt><a class="headerlink" href="#map-doc" title="Permalink to this headline">¶</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><tt class="docutils literal"><span class="pre">map_doc</span></tt></td>
</tr>
<tr class="field-even field"><th class="field-name">Arguments:</th><td class="field-body">Document object</td>
</tr>
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">Array of key-value pairs per applied <a class="reference internal" href="contents.html#qs-add-fun"><em>function</em></a></td>
</tr>
</tbody>
</table>
<p>When the view function is stored in the Query Server, CouchDB starts sending in
all the documents in the database, one at a time. The Query Server calls the
previously stored functions one after another with a document and stores its
result. When all functions have been called, the result is returned as a JSON
string.</p>
<p>CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;map_doc&quot;,
  {
    &quot;_id&quot;: &quot;8877AFF9789988EE&quot;,
    &quot;_rev&quot;: &quot;3-235256484&quot;,
    &quot;name&quot;: &quot;John Smith&quot;,
    &quot;score&quot;: 60
  }
]
</pre></div>
</div>
<p>If the function above is the only function stored, the Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  [
    [null, {&quot;player_name&quot;: &quot;John Smith&quot;}]
  ]
]
</pre></div>
</div>
<p>That is, an array with the result for every function for the given document.</p>
<p>If a document is to be excluded from the view, the array should be empty.</p>
<p>CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;map_doc&quot;,
  {
    &quot;_id&quot;: &quot;9590AEB4585637FE&quot;,
    &quot;_rev&quot;: &quot;1-674684684&quot;,
    &quot;name&quot;: &quot;Jane Parker&quot;,
    &quot;score&quot;: 43
  }
]
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[[]]</span>
</pre></div>
</div>
</div>
<div class="section" id="reduce">
<span id="qs-reduce"></span><h4><tt class="docutils literal"><span class="pre">reduce</span></tt><a class="headerlink" href="#reduce" title="Permalink to this headline">¶</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">reduce</span></tt></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li>Reduce function source</li>
<li>Array of <a class="reference internal" href="contents.html#mapfun"><em>map function</em></a> results where each item represented
in format <tt class="docutils literal"><span class="pre">[[key,</span> <span class="pre">id-of-doc],</span> <span class="pre">value]</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Array with pair values: <tt class="docutils literal"><span class="pre">true</span></tt> and another array with reduced result</p>
</td>
</tr>
</tbody>
</table>
<p>If the view has a reduce function defined, CouchDB will enter into the reduce
phase. The view server will receive a list of reduce functions and some map
results on which it can apply them.</p>
<p>CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;reduce&quot;,
  [
    &quot;function(k, v) { return sum(v); }&quot;
  ],
  [
    [[1, &quot;699b524273605d5d3e9d4fd0ff2cb272&quot;], 10],
    [[2, &quot;c081d0f69c13d2ce2050d684c7ba2843&quot;], 20],
    [[null, &quot;foobar&quot;], 3]
  ]
]
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  true,
  [33]
]
</pre></div>
</div>
<p>Note that even though the view server receives the map results in the form
<tt class="docutils literal"><span class="pre">[[key,</span> <span class="pre">id-of-doc],</span> <span class="pre">value]</span></tt>, the function may receive them in a different
form. For example, the JavaScript Query Server applies functions on the list of
keys and the list of values.</p>
</div>
<div class="section" id="rereduce">
<span id="qs-rereduce"></span><h4><tt class="docutils literal"><span class="pre">rereduce</span></tt><a class="headerlink" href="#rereduce" title="Permalink to this headline">¶</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><tt class="docutils literal"><span class="pre">rereduce</span></tt></td>
</tr>
<tr class="field-even field"><th class="field-name">Arguments:</th><td class="field-body">List of values.</td>
</tr>
</tbody>
</table>
<p>When building a view, CouchDB will apply the reduce step directly to the output
of the map step and the rereduce step to the output of a previous reduce step.</p>
<p>CouchDB will send a list of values, with no keys or document ids, to the
rereduce step.</p>
<p>CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;rereduce&quot;,
  [
    &quot;function(k, v, r) { return sum(v); }&quot;
  ],
  [
    33,
    55,
    66
  ]
]
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  true,
  [154]
]
</pre></div>
</div>
</div>
<div class="section" id="ddoc">
<span id="qs-ddoc"></span><h4><tt class="docutils literal"><span class="pre">ddoc</span></tt><a class="headerlink" href="#ddoc" title="Permalink to this headline">¶</a></h4>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">ddoc</span></tt></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Arguments:</th><td class="field-body"><p class="first">Array of objects.</p>
<ul class="simple">
<li>First phase (ddoc initialization):<ul>
<li><tt class="docutils literal"><span class="pre">&quot;new&quot;</span></tt></li>
<li>Design document <tt class="docutils literal"><span class="pre">_id</span></tt></li>
<li>Design document object</li>
</ul>
</li>
<li>Second phase (design function execution):<ul>
<li>Design document <tt class="docutils literal"><span class="pre">_id</span></tt></li>
<li>Function path as an array of object keys</li>
<li>Array of function arguments</li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body"><ul class="first last simple">
<li>First phase (ddoc initialization): <tt class="docutils literal"><span class="pre">true</span></tt></li>
<li>Second phase (design function execution): custom object depending on
executed function</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>This command acts in two phases: <cite>ddoc</cite> registration and <cite>design function</cite>
execution.</p>
<p>In the first phase CouchDB sends a full design document content to the Query
Server to let it cache it by <tt class="docutils literal"><span class="pre">_id</span></tt> value for further function execution.</p>
<p>To do this, CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;ddoc&quot;,
  &quot;new&quot;,
  &quot;_design/temp&quot;,
  {
    &quot;_id&quot;: &quot;_design/temp&quot;,
    &quot;_rev&quot;: &quot;8-d7379de23a751dc2a19e5638a7bbc5cc&quot;,
    &quot;language&quot;: &quot;javascript&quot;,
    &quot;shows&quot;: {
      &quot;request&quot;: &quot;function(doc,req){ return {json: req}; }&quot;,
      &quot;hello&quot;: &quot;function(doc,req){ return {body: &#39;Hello, &#39; + (doc || {})._id + &#39;!&#39;}; }&quot;
    }
  }
]
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>true
</pre></div>
</div>
<p>After than this design document is ready to serve next subcommands - that&#8217;s the
second phase.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Each <tt class="docutils literal"><span class="pre">ddoc</span></tt> subcommand is the root design document key, so they are not
actually subcommands, but first elements of the JSON path that may be handled
and processed.</p>
<p>The pattern for subcommand execution is common:</p>
<p class="last"><tt class="docutils literal"><span class="pre">[&quot;ddoc&quot;,</span> <span class="pre">&lt;design_doc_id&gt;,</span> <span class="pre">[&lt;subcommand&gt;,</span> <span class="pre">&lt;funcname&gt;],</span> <span class="pre">[&lt;argument1&gt;,</span> <span class="pre">&lt;argument2&gt;,</span> <span class="pre">...]]</span></tt></p>
</div>
<div class="section" id="shows">
<span id="qs-ddoc-shows"></span><h5><tt class="docutils literal"><span class="pre">shows</span></tt><a class="headerlink" href="#shows" title="Permalink to this headline">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">ddoc</span></tt></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">SubCommand:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">shows</span></tt></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li>Document object or <tt class="docutils literal"><span class="pre">null</span></tt> if document <cite>id</cite> wasn&#8217;t specified in request</li>
<li><a class="reference internal" href="contents.html#request-object"><em>Request object</em></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">Array with two elements:</p>
<ul class="last simple">
<li><tt class="docutils literal"><span class="pre">&quot;resp&quot;</span></tt></li>
<li><a class="reference internal" href="contents.html#response-object"><em>Response object</em></a></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Executes <a class="reference internal" href="contents.html#showfun"><em>show function</em></a>.</p>
<p>Couchdb sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;ddoc&quot;,
  &quot;_design/temp&quot;,
  [
      &quot;shows&quot;,
      &quot;doc&quot;
  ],
  [
    null,
    {
      &quot;info&quot;: {
        &quot;db_name&quot;: &quot;test&quot;,
        &quot;doc_count&quot;: 8,
        &quot;doc_del_count&quot;: 0,
        &quot;update_seq&quot;: 105,
        &quot;purge_seq&quot;: 0,
        &quot;compact_running&quot;: false,
        &quot;disk_size&quot;: 15818856,
        &quot;data_size&quot;: 1535048,
        &quot;instance_start_time&quot;: &quot;1359952188595857&quot;,
        &quot;disk_format_version&quot;: 6,
        &quot;committed_update_seq&quot;: 105
      },
      &quot;id&quot;: null,
      &quot;uuid&quot;: &quot;169cb4cc82427cc7322cb4463d0021bb&quot;,
      &quot;method&quot;: &quot;GET&quot;,
      &quot;requested_path&quot;: [
        &quot;api&quot;,
        &quot;_design&quot;,
        &quot;temp&quot;,
        &quot;_show&quot;,
        &quot;request&quot;
      ],
      &quot;path&quot;: [
        &quot;api&quot;,
        &quot;_design&quot;,
        &quot;temp&quot;,
        &quot;_show&quot;,
        &quot;request&quot;
      ],
      &quot;raw_path&quot;: &quot;/api/_design/temp/_show/request&quot;,
      &quot;query&quot;: {},
      &quot;headers&quot;: {
        &quot;Accept&quot;: &quot;*/*&quot;,
        &quot;Host&quot;: &quot;localhost:5984&quot;,
        &quot;User-Agent&quot;: &quot;curl/7.26.0&quot;
      },
      &quot;body&quot;: &quot;undefined&quot;,
      &quot;peer&quot;: &quot;127.0.0.1&quot;,
      &quot;form&quot;: {},
      &quot;cookie&quot;: {},
      &quot;userCtx&quot;: {
        &quot;db&quot;: &quot;api&quot;,
        &quot;name&quot;: null,
        &quot;roles&quot;: [
          &quot;_admin&quot;
        ]
      },
      &quot;secObj&quot;: {}
    }
  ]
]
</pre></div>
</div>
<p>The Query Server sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;resp&quot;,
  {
    &quot;body&quot;: &quot;Hello, undefined!&quot;
  }
]
</pre></div>
</div>
</div>
<div class="section" id="lists">
<span id="qs-ddoc-lists"></span><h5><tt class="docutils literal"><span class="pre">lists</span></tt><a class="headerlink" href="#lists" title="Permalink to this headline">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">ddoc</span></tt></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">SubCommand:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">lists</span></tt></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><a class="reference internal" href="contents.html#view-head-info-object"><em>View Head Information</em></a>:</li>
<li><a class="reference internal" href="contents.html#request-object"><em>Request object</em></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Array. See below for details.</p>
</td>
</tr>
</tbody>
</table>
<p>Executes <a class="reference internal" href="contents.html#listfun"><em>list function</em></a>.</p>
<p>The communication protocol for <cite>list</cite> functions is a bit complex so let&#8217;s use
an example for illustration.</p>
<p>Let&#8217;s assume that we have view a function that emits <cite>id-rev</cite> pairs:</p>
<div class="highlight-ini"><div class="highlight"><pre>function(doc) {
  emit(doc._id, doc._rev);
}
</pre></div>
</div>
<p>And we&#8217;d like to emulate <tt class="docutils literal"><span class="pre">_all_docs</span></tt> JSON response with list function. Our
<em>first</em> version of the list functions looks like this:</p>
<div class="highlight-ini"><div class="highlight"><pre>function(head, req){
  start({&#39;headers&#39;: {&#39;Content-Type&#39;: &#39;application/json&#39;}});
  var resp = head;
  var rows = [];
  while(row=getRow()){
    rows.push(row);
  }
  resp.rows = rows;
  return toJSON(resp);
}
</pre></div>
</div>
<p>The whole communication session during list function execution could be divided
on three parts:</p>
<ol class="arabic">
<li><p class="first">Initialization</p>
<p>The first returned object from list function is an array of next structure:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[&quot;start&quot;, &lt;chunks&gt;, &lt;headers&gt;]</span>
</pre></div>
</div>
<p>Where <tt class="docutils literal"><span class="pre">&lt;chunks&gt;</span></tt> is an array of text chunks that will be sent to client
and <tt class="docutils literal"><span class="pre">&lt;headers&gt;</span></tt> is an object with response HTTP headers.</p>
<p>This message is sent from the Query Server to CouchDB on the
<a class="reference internal" href="contents.html#start" title="start"><tt class="xref js js-func docutils literal"><span class="pre">start()</span></tt></a> call which initialize HTTP response to the client:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;start&quot;,
  [],
  {
    &quot;headers&quot;: {
      &quot;Content-Type&quot;: &quot;application/json&quot;
    }
  }
]
</pre></div>
</div>
<p>After this, the list function may start to process view rows.</p>
</li>
<li><p class="first">View Processing</p>
<p>Since view results can be extremely large, it is not wise to pass all its
rows in a single command. Instead, CouchDB can send view rows one by one
to the Query Server allowing processing view and output generation in a
streaming way.</p>
<p>CouchDB sends a special array that carries view row data:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;list_row&quot;,
  {
    &quot;id&quot;: &quot;0cb42c267fe32d4b56b3500bc503e030&quot;,
    &quot;key&quot;: &quot;0cb42c267fe32d4b56b3500bc503e030&quot;,
    &quot;value&quot;: &quot;1-967a00dff5e02add41819138abb3284d&quot;
  }
]
</pre></div>
</div>
<p>If Query Server has something to return on this, it returns an array with a
<tt class="docutils literal"><span class="pre">&quot;chunks&quot;</span></tt> item in the head and an array of data in the tail. Now, for our
case it has nothing to return, so the response will be:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;chunks&quot;,
  []
]
</pre></div>
</div>
<p>When there is no more view rows to process, CouchDB sends special message,
that signs about that there is no more data to send from its side:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[&quot;list_end&quot;]</span>
</pre></div>
</div>
</li>
<li><p class="first">Finalization</p>
<p>The last stage of the communication process is the returning <em>list tail</em>:
the last data chunk. After this, processing list function will be completed
and client will receive complete response.</p>
<p>For our example the last message will be the next:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;end&quot;,
  [
    &quot;{\&quot;total_rows\&quot;:2,\&quot;offset\&quot;:0,\&quot;rows\&quot;:[{\&quot;id\&quot;:\&quot;0cb42c267fe32d4b56b3500bc503e030\&quot;,\&quot;key\&quot;:\&quot;0cb42c267fe32d4b56b3500bc503e030\&quot;,\&quot;value\&quot;:\&quot;1-967a00dff5e02add41819138abb3284d\&quot;},{\&quot;id\&quot;:\&quot;431926a69504bde41851eb3c18a27b1f\&quot;,\&quot;key\&quot;:\&quot;431926a69504bde41851eb3c18a27b1f\&quot;,\&quot;value\&quot;:\&quot;1-967a00dff5e02add41819138abb3284d\&quot;}]}&quot;
  ]
]
</pre></div>
</div>
</li>
</ol>
<p>There, we had made a big mistake: we had returned out result in a single
message from the Query Server. That&#8217;s ok when there are only a few rows in the
view result, but it&#8217;s not acceptable for millions documents and millions view
rows</p>
<p>Let&#8217;s fix our list function and see the changes in communication:</p>
<div class="highlight-ini"><div class="highlight"><pre>function(head, req){
  start({&#39;headers&#39;: {&#39;Content-Type&#39;: &#39;application/json&#39;}});
  send(&#39;{&#39;);
  send(&#39;&quot;total_rows&quot;:&#39; + toJSON(head.total_rows) + &#39;,&#39;);
  send(&#39;&quot;offset&quot;:&#39; + toJSON(head.offset) + &#39;,&#39;);
  send(&#39;&quot;rows&quot;:[&#39;);
  if (row=getRow()){
    send(toJSON(row));
  }
  while(row=getRow()){
    send(&#39;,&#39; + toJSON(row));
  }
  send(&#39;]&#39;);
  return &#39;}&#39;;
}
</pre></div>
</div>
<p>&#8220;Wait, what?&#8221; - you&#8217;d like to ask. Yes, we&#8217;d build JSON response manually by
string chunks, but let&#8217;s take a look on logs:</p>
<div class="highlight-ini"><div class="highlight"><pre>[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [&lt;0.19191.1&gt;] OS Process #Port&lt;0.4444&gt; Output :: [&quot;start&quot;,[&quot;{&quot;,&quot;\&quot;total_rows\&quot;:2,&quot;,&quot;\&quot;offset\&quot;:0,&quot;,&quot;\&quot;rows\&quot;:[&quot;],{&quot;headers&quot;:{&quot;Content-Type&quot;:&quot;application/json&quot;}}]
[Wed, 24 Jul 2013 05:45:30 GMT] [info] [&lt;0.18963.1&gt;] 127.0.0.1 - - GET /blog/_design/post/_list/index/all_docs 200
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [&lt;0.19191.1&gt;] OS Process #Port&lt;0.4444&gt; Input  :: [&quot;list_row&quot;,{&quot;id&quot;:&quot;0cb42c267fe32d4b56b3500bc503e030&quot;,&quot;key&quot;:&quot;0cb42c267fe32d4b56b3500bc503e030&quot;,&quot;value&quot;:&quot;1-967a00dff5e02add41819138abb3284d&quot;}]
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [&lt;0.19191.1&gt;] OS Process #Port&lt;0.4444&gt; Output :: [&quot;chunks&quot;,[&quot;{\&quot;id\&quot;:\&quot;0cb42c267fe32d4b56b3500bc503e030\&quot;,\&quot;key\&quot;:\&quot;0cb42c267fe32d4b56b3500bc503e030\&quot;,\&quot;value\&quot;:\&quot;1-967a00dff5e02add41819138abb3284d\&quot;}&quot;]]
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [&lt;0.19191.1&gt;] OS Process #Port&lt;0.4444&gt; Input  :: [&quot;list_row&quot;,{&quot;id&quot;:&quot;431926a69504bde41851eb3c18a27b1f&quot;,&quot;key&quot;:&quot;431926a69504bde41851eb3c18a27b1f&quot;,&quot;value&quot;:&quot;1-967a00dff5e02add41819138abb3284d&quot;}]
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [&lt;0.19191.1&gt;] OS Process #Port&lt;0.4444&gt; Output :: [&quot;chunks&quot;,[&quot;,{\&quot;id\&quot;:\&quot;431926a69504bde41851eb3c18a27b1f\&quot;,\&quot;key\&quot;:\&quot;431926a69504bde41851eb3c18a27b1f\&quot;,\&quot;value\&quot;:\&quot;1-967a00dff5e02add41819138abb3284d\&quot;}&quot;]]
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [&lt;0.19191.1&gt;] OS Process #Port&lt;0.4444&gt; Input  :: [&quot;list_end&quot;]
[Wed, 24 Jul 2013 05:45:30 GMT] [debug] [&lt;0.19191.1&gt;] OS Process #Port&lt;0.4444&gt; Output :: [&quot;end&quot;,[&quot;]&quot;,&quot;}&quot;]]
</pre></div>
</div>
<p>Note, that now the Query Server sends response by lightweight chunks and if
our communication process was extremely slow, the client will see how response
data appears on their screen. Chunk by chunk, without waiting for the complete
result, like they have for our previous list function.</p>
</div>
<div class="section" id="updates">
<span id="qs-ddoc-updates"></span><h5><tt class="docutils literal"><span class="pre">updates</span></tt><a class="headerlink" href="#updates" title="Permalink to this headline">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">ddoc</span></tt></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">SubCommand:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">updates</span></tt></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li>Document object or <tt class="docutils literal"><span class="pre">null</span></tt> if document <cite>id</cite> wasn&#8217;t specified in request</li>
<li><a class="reference internal" href="contents.html#request-object"><em>Request object</em></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">Array with there elements:</p>
<ul class="last simple">
<li><tt class="docutils literal"><span class="pre">&quot;up&quot;</span></tt></li>
<li>Document object or <tt class="docutils literal"><span class="pre">null</span></tt> if nothing should be stored</li>
<li><a class="reference internal" href="contents.html#response-object"><em>Response object</em></a></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Executes <a class="reference internal" href="contents.html#updatefun"><em>update function</em></a>.</p>
<p>CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
    &quot;ddoc&quot;,
    &quot;_design/id&quot;,
    [
        &quot;updates&quot;,
        &quot;nothing&quot;
    ],
    [
        null,
        {
            &quot;info&quot;: {
                &quot;db_name&quot;: &quot;test&quot;,
                &quot;doc_count&quot;: 5,
                &quot;doc_del_count&quot;: 0,
                &quot;update_seq&quot;: 16,
                &quot;purge_seq&quot;: 0,
                &quot;compact_running&quot;: false,
                &quot;disk_size&quot;: 8044648,
                &quot;data_size&quot;: 7979601,
                &quot;instance_start_time&quot;: &quot;1374612186131612&quot;,
                &quot;disk_format_version&quot;: 6,
                &quot;committed_update_seq&quot;: 16
            },
            &quot;id&quot;: null,
            &quot;uuid&quot;: &quot;7b695cb34a03df0316c15ab529002e69&quot;,
            &quot;method&quot;: &quot;POST&quot;,
            &quot;requested_path&quot;: [
                &quot;test&quot;,
                &quot;_design&quot;,
                &quot;1139&quot;,
                &quot;_update&quot;,
                &quot;nothing&quot;
            ],
            &quot;path&quot;: [
                &quot;test&quot;,
                &quot;_design&quot;,
                &quot;1139&quot;,
                &quot;_update&quot;,
                &quot;nothing&quot;
            ],
            &quot;raw_path&quot;: &quot;/test/_design/1139/_update/nothing&quot;,
            &quot;query&quot;: {},
            &quot;headers&quot;: {
                &quot;Accept&quot;: &quot;*/*&quot;,
                &quot;Accept-Encoding&quot;: &quot;identity, gzip, deflate, compress&quot;,
                &quot;Content-Length&quot;: &quot;0&quot;,
                &quot;Host&quot;: &quot;localhost:5984&quot;
            },
            &quot;body&quot;: &quot;&quot;,
            &quot;peer&quot;: &quot;127.0.0.1&quot;,
            &quot;form&quot;: {},
            &quot;cookie&quot;: {},
            &quot;userCtx&quot;: {
                &quot;db&quot;: &quot;test&quot;,
                &quot;name&quot;: null,
                &quot;roles&quot;: [
                    &quot;_admin&quot;
                ]
            },
            &quot;secObj&quot;: {}
        }
    ]
]
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;up&quot;,
  null,
  {&quot;body&quot;: &quot;document id wasn&#39;t provided&quot;}
]
</pre></div>
</div>
<p>or in case of successful update:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;up&quot;,
  {
    &quot;_id&quot;: &quot;7b695cb34a03df0316c15ab529002e69&quot;,
    &quot;hello&quot;: &quot;world!&quot;
  },
  {&quot;body&quot;: &quot;document was updated&quot;}
]
</pre></div>
</div>
</div>
<div class="section" id="filters">
<span id="qs-ddoc-filters"></span><h5><tt class="docutils literal"><span class="pre">filters</span></tt><a class="headerlink" href="#filters" title="Permalink to this headline">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">ddoc</span></tt></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">SubCommand:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">filters</span></tt></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li>Array of document objects</li>
<li><a class="reference internal" href="contents.html#request-object"><em>Request object</em></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">Array of two elements:</p>
<ul class="last simple">
<li><tt class="docutils literal"><span class="pre">true</span></tt></li>
<li>Array of booleans in the same order of input documents.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Executes <a class="reference internal" href="contents.html#filterfun"><em>filter function</em></a>.</p>
<p>CouchDB sends:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
    &quot;ddoc&quot;,
    &quot;_design/test&quot;,
    [
        &quot;filters&quot;,
        &quot;random&quot;
    ],
    [
        [
            {
                &quot;_id&quot;: &quot;431926a69504bde41851eb3c18a27b1f&quot;,
                &quot;_rev&quot;: &quot;1-967a00dff5e02add41819138abb3284d&quot;,
                &quot;_revisions&quot;: {
                    &quot;start&quot;: 1,
                    &quot;ids&quot;: [
                        &quot;967a00dff5e02add41819138abb3284d&quot;
                    ]
                }
            },
            {
                &quot;_id&quot;: &quot;0cb42c267fe32d4b56b3500bc503e030&quot;,
                &quot;_rev&quot;: &quot;1-967a00dff5e02add41819138abb3284d&quot;,
                &quot;_revisions&quot;: {
                    &quot;start&quot;: 1,
                    &quot;ids&quot;: [
                        &quot;967a00dff5e02add41819138abb3284d&quot;
                    ]
                }
            }
        ],
        {
            &quot;info&quot;: {
                &quot;db_name&quot;: &quot;test&quot;,
                &quot;doc_count&quot;: 5,
                &quot;doc_del_count&quot;: 0,
                &quot;update_seq&quot;: 19,
                &quot;purge_seq&quot;: 0,
                &quot;compact_running&quot;: false,
                &quot;disk_size&quot;: 8056936,
                &quot;data_size&quot;: 7979745,
                &quot;instance_start_time&quot;: &quot;1374612186131612&quot;,
                &quot;disk_format_version&quot;: 6,
                &quot;committed_update_seq&quot;: 19
            },
            &quot;id&quot;: null,
            &quot;uuid&quot;: &quot;7b695cb34a03df0316c15ab529023a81&quot;,
            &quot;method&quot;: &quot;GET&quot;,
            &quot;requested_path&quot;: [
                &quot;test&quot;,
                &quot;_changes?filter=test&quot;,
                &quot;random&quot;
            ],
            &quot;path&quot;: [
                &quot;test&quot;,
                &quot;_changes&quot;
            ],
            &quot;raw_path&quot;: &quot;/test/_changes?filter=test/random&quot;,
            &quot;query&quot;: {
                &quot;filter&quot;: &quot;test/random&quot;
            },
            &quot;headers&quot;: {
                &quot;Accept&quot;: &quot;application/json&quot;,
                &quot;Accept-Encoding&quot;: &quot;identity, gzip, deflate, compress&quot;,
                &quot;Content-Length&quot;: &quot;0&quot;,
                &quot;Content-Type&quot;: &quot;application/json; charset=utf-8&quot;,
                &quot;Host&quot;: &quot;localhost:5984&quot;
            },
            &quot;body&quot;: &quot;&quot;,
            &quot;peer&quot;: &quot;127.0.0.1&quot;,
            &quot;form&quot;: {},
            &quot;cookie&quot;: {},
            &quot;userCtx&quot;: {
                &quot;db&quot;: &quot;test&quot;,
                &quot;name&quot;: null,
                &quot;roles&quot;: [
                    &quot;_admin&quot;
                ]
            },
            &quot;secObj&quot;: {}
        }
    ]
]
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  true,
  [
    true,
    false
  ]
]
</pre></div>
</div>
</div>
<div class="section" id="views">
<span id="qs-ddoc-views"></span><h5><tt class="docutils literal"><span class="pre">views</span></tt><a class="headerlink" href="#views" title="Permalink to this headline">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">ddoc</span></tt></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">SubCommand:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">views</span></tt></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><p class="first">Array of document objects</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">Array of two elements:</p>
<ul class="last simple">
<li><tt class="docutils literal"><span class="pre">true</span></tt></li>
<li>Array of booleans in the same order of input documents.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.2.</span></p>
</div>
<p>Executes <a class="reference internal" href="contents.html#viewfilter"><em>view function</em></a> in place of the filter.</p>
<p>Acts in the same way as <a class="reference internal" href="contents.html#qs-ddoc-filters"><em>filters</em></a> command.</p>
</div>
<div class="section" id="validate-doc-update">
<span id="qs-ddoc-validate-doc-update"></span><h5><tt class="docutils literal"><span class="pre">validate_doc_update</span></tt><a class="headerlink" href="#validate-doc-update" title="Permalink to this headline">¶</a></h5>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Command:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">ddoc</span></tt></p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">SubCommand:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">validate_doc_update</span></tt></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li>Document object that will be stored</li>
<li>Document object that will be replaced</li>
<li><a class="reference internal" href="contents.html#userctx-object"><em>User Context Object</em></a></li>
<li><a class="reference internal" href="contents.html#security-object"><em>Security Object</em></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last"><tt class="docutils literal"><span class="pre">1</span></tt></p>
</td>
</tr>
</tbody>
</table>
<p>Executes <a class="reference internal" href="contents.html#vdufun"><em>validation function</em></a>.</p>
<p>CouchDB send:</p>
<div class="highlight-ini"><div class="highlight"><pre>[
  &quot;ddoc&quot;,
  &quot;_design/id&quot;,
  [&quot;validate_doc_update&quot;],
  [
    {
      &quot;_id&quot;: &quot;docid&quot;,
      &quot;_rev&quot;: &quot;2-e0165f450f6c89dc6b071c075dde3c4d&quot;,
      &quot;score&quot;: 10
    },
    {
      &quot;_id&quot;: &quot;docid&quot;,
      &quot;_rev&quot;: &quot;1-9f798c6ad72a406afdbf470b9eea8375&quot;,
      &quot;score&quot;: 4
    },
    {
      &quot;name&quot;: &quot;Mike&quot;,
      &quot;roles&quot;: [&quot;player&quot;]
    },
    {
      &quot;admins&quot;: {},
      &quot;members&quot;: []
    }
  ]
]
</pre></div>
</div>
<p>The Query Server answers:</p>
<div class="highlight-ini"><div class="highlight"><pre>1
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While the only valid response for this command is <tt class="docutils literal"><span class="pre">true</span></tt> to prevent
document save the Query Server need to raise an error: <tt class="docutils literal"><span class="pre">forbidden</span></tt> or
<tt class="docutils literal"><span class="pre">unauthorized</span></tt> - these errors will be turned into correct <tt class="docutils literal"><span class="pre">HTTP</span> <span class="pre">403</span></tt> and
<tt class="docutils literal"><span class="pre">HTTP</span> <span class="pre">401</span></tt> responses respectively.</p>
</div>
</div>
</div>
<div class="section" id="raising-errors">
<span id="qs-errors"></span><h4>Raising errors<a class="headerlink" href="#raising-errors" title="Permalink to this headline">¶</a></h4>
<p>When something went wrong the Query Server is able to inform CouchDB about
such a situation by sending special message in response of received command.</p>
<p>Error messages prevent further command execution and return an error description
to CouchDB. All errors are logically divided into two groups:</p>
<ul class="simple">
<li><cite>Common errors</cite>. These errors only break the current Query Server command and
return the error info to the CouchDB instance <em>without</em> terminating the Query
Server  process.</li>
<li><cite>Fatal errors</cite>. The fatal errors signal about something really bad that hurts
the overall Query Server process stability and productivity. For instance, if
you&#8217;re using Python Query Server and some design function is unable to import
some third party module, it&#8217;s better to count such error as fatal and
terminate whole process or you still have to do the same after import fixing,
but manually.</li>
</ul>
<div class="section" id="error">
<span id="qs-error"></span><h5><tt class="docutils literal"><span class="pre">error</span></tt><a class="headerlink" href="#error" title="Permalink to this headline">¶</a></h5>
<p>To raise an error, the Query Server have to answer:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[&quot;error&quot;, &quot;error_name&quot;, &quot;reason why&quot;]</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">&quot;error_name&quot;</span></tt> helps to classify problems by their type e.g. if it&#8217;s
<tt class="docutils literal"><span class="pre">&quot;value_error&quot;</span></tt> so probably user have entered wrong data, <tt class="docutils literal"><span class="pre">&quot;not_found&quot;</span></tt>
notifies about missed resource and <tt class="docutils literal"><span class="pre">&quot;type_error&quot;</span></tt> definitely says about
invalid and non expected input from user.</p>
<p>The <tt class="docutils literal"><span class="pre">&quot;reason</span> <span class="pre">why&quot;</span></tt> is the error message that explains why it raised and, if
possible, what is needed to do to fix it.</p>
<p>For example, calling <a class="reference internal" href="contents.html#updatefun"><em>Update functions</em></a> against non existent document could produce
next error message:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[&quot;error&quot;, &quot;not_found&quot;, &quot;Update function requires existent document&quot;]</span>
</pre></div>
</div>
</div>
<div class="section" id="forbidden">
<span id="qs-error-forbidden"></span><h5><tt class="docutils literal"><span class="pre">forbidden</span></tt><a class="headerlink" href="#forbidden" title="Permalink to this headline">¶</a></h5>
<p>The <cite>forbidden</cite> error is widely used by <a class="reference internal" href="contents.html#vdufun"><em>Validate document update functions</em></a> to stop further function
processing and prevent on disk store of the new document version. Since this
error actually is not an error, but an assertion against user actions, CouchDB
doesn&#8217;t log it at <cite>&#8220;error&#8221;</cite> level, but returns <cite>HTTP 403 Forbidden</cite> response
with error information object.</p>
<p>To raise this error, the Query Server have to answer:</p>
<div class="highlight-ini"><div class="highlight"><pre>{&quot;forbidden&quot;: &quot;reason why&quot;}
</pre></div>
</div>
</div>
<div class="section" id="unauthorized">
<span id="qs-error-unauthorized"></span><h5><tt class="docutils literal"><span class="pre">unauthorized</span></tt><a class="headerlink" href="#unauthorized" title="Permalink to this headline">¶</a></h5>
<p>The <cite>unauthorized</cite> error mostly acts like <cite>forbidden</cite> one, but with
the meaning of <em>please authorize first</em>. This small difference helps end users
to understand what they can do to solve the problem. CouchDB doesn&#8217;t log it at
<cite>&#8220;error&#8221;</cite> level, but returns <cite>HTTP 401 Unauthorized</cite> response with error
information object.</p>
<p>To raise this error, the Query Server have to answer:</p>
<div class="highlight-ini"><div class="highlight"><pre>{&quot;unauthorized&quot;: &quot;reason why&quot;}
</pre></div>
</div>
</div>
</div>
<div class="section" id="logging">
<span id="qs-log"></span><h4>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h4>
<p>At any time, the Query Server may send some information that will be saved in
CouchDB&#8217;s log file. This is done by sending a special object with just one
field, log, on a separate line:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[&quot;log&quot;, &quot;some message&quot;]</span>
</pre></div>
</div>
<p>CouchDB responds nothing, but writes received message into log file:</p>
<div class="highlight-ini"><div class="highlight"><pre>[Sun, 13 Feb 2009 23:31:30 GMT] [info] [&lt;0.72.0&gt;] Query Server Log Message: some message
</pre></div>
</div>
<p>These messages are only logged at <a class="reference internal" href="contents.html#log/level" title="level"><tt class="xref config config-option docutils literal"><span class="pre">info</span> <span class="pre">level</span></tt></a>.</p>
</div>
</div>
<span id="document-query-server/javascript"></span><div class="section" id="javascript">
<span id="query-server-js"></span><h3>JavaScript<a class="headerlink" href="#javascript" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While every design function has access to all JavaScript objects,
the table below describes appropriate usage cases. For example,
you may use <a class="reference internal" href="contents.html#emit" title="emit"><tt class="xref js js-func docutils literal"><span class="pre">emit()</span></tt></a> in <a class="reference internal" href="contents.html#listfun"><em>List functions</em></a>, but <a class="reference internal" href="contents.html#getRow" title="getRow"><tt class="xref js js-func docutils literal"><span class="pre">getRow()</span></tt></a> is not permitted during <a class="reference internal" href="contents.html#mapfun"><em>Map functions</em></a>.</p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">JS Function</th>
<th class="head">Reasonable to use in design doc functions</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference internal" href="contents.html#emit" title="emit"><tt class="xref js js-func docutils literal"><span class="pre">emit()</span></tt></a></td>
<td><a class="reference internal" href="contents.html#mapfun"><em>Map functions</em></a></td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="contents.html#getRow" title="getRow"><tt class="xref js js-func docutils literal"><span class="pre">getRow()</span></tt></a></td>
<td><a class="reference internal" href="contents.html#listfun"><em>List functions</em></a></td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="contents.html#JSON" title="JSON"><tt class="xref js js-data docutils literal"><span class="pre">JSON</span></tt></a></td>
<td>any</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="contents.html#isArray" title="isArray"><tt class="xref js js-func docutils literal"><span class="pre">isArray()</span></tt></a></td>
<td>any</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="contents.html#log" title="log"><tt class="xref js js-func docutils literal"><span class="pre">log()</span></tt></a></td>
<td>any</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="contents.html#provides" title="provides"><tt class="xref js js-func docutils literal"><span class="pre">provides()</span></tt></a></td>
<td><a class="reference internal" href="contents.html#showfun"><em>Show functions</em></a>, <a class="reference internal" href="contents.html#listfun"><em>List functions</em></a></td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="contents.html#registerType" title="registerType"><tt class="xref js js-func docutils literal"><span class="pre">registerType()</span></tt></a></td>
<td><a class="reference internal" href="contents.html#showfun"><em>Show functions</em></a>, <a class="reference internal" href="contents.html#listfun"><em>List functions</em></a></td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="contents.html#require" title="require"><tt class="xref js js-func docutils literal"><span class="pre">require()</span></tt></a></td>
<td>any, except <a class="reference internal" href="contents.html#reducefun"><em>Reduce and rereduce functions</em></a></td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="contents.html#send" title="send"><tt class="xref js js-func docutils literal"><span class="pre">send()</span></tt></a></td>
<td><a class="reference internal" href="contents.html#listfun"><em>List functions</em></a></td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="contents.html#start" title="start"><tt class="xref js js-func docutils literal"><span class="pre">start()</span></tt></a></td>
<td><a class="reference internal" href="contents.html#listfun"><em>List functions</em></a></td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="contents.html#sum" title="sum"><tt class="xref js js-func docutils literal"><span class="pre">sum()</span></tt></a></td>
<td>any</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="contents.html#toJSON" title="toJSON"><tt class="xref js js-func docutils literal"><span class="pre">toJSON()</span></tt></a></td>
<td>any</td>
</tr>
</tbody>
</table>
<div class="section" id="design-functions-context">
<h4>Design functions context<a class="headerlink" href="#design-functions-context" title="Permalink to this headline">¶</a></h4>
<p>Each design function executes in a special context of predefined objects,
modules and functions:</p>
<dl class="function">
<dt id="emit">
<tt class="descname">emit</tt><big>(</big><em>key</em>, <em>value</em><big>)</big><a class="headerlink" href="#emit" title="Permalink to this definition">¶</a></dt>
<dd><p>Emits a <cite>key</cite>-<cite>value</cite> pair for further processing by CouchDB after the map
function is done.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first last simple">
<li><strong>key</strong> &#8211; The view key</li>
<li><strong>value</strong> &#8211; The <cite>key</cite>&#8216;s associated value</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">){</span>
  <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="getRow">
<tt class="descname">getRow</tt><big>(</big><big>)</big><a class="headerlink" href="#getRow" title="Permalink to this definition">¶</a></dt>
<dd><p>Extracts the next row from a related view result.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">View result row</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">object</td>
</tr>
</tbody>
</table>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
  <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">);</span>
  <span class="nx">row</span> <span class="o">=</span> <span class="nx">getRow</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">row</span><span class="p">){</span>
    <span class="nx">send</span><span class="p">(</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">row</span><span class="p">));</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">row</span> <span class="o">=</span> <span class="nx">getRow</span><span class="p">()){</span>
      <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
      <span class="nx">send</span><span class="p">(</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">row</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="data">
<dt id="JSON">
<tt class="descname">JSON</tt><a class="headerlink" href="#JSON" title="Permalink to this definition">¶</a></dt>
<dd><p><a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=blob;f=share/server/json2.js">JSON2</a>
object.</p>
</dd></dl>

<dl class="function">
<dt id="isArray">
<tt class="descname">isArray</tt><big>(</big><em>obj</em><big>)</big><a class="headerlink" href="#isArray" title="Permalink to this definition">¶</a></dt>
<dd><p>A helper function to check if the provided value is an <cite>Array</cite>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>obj</strong> &#8211; Any Javascript value</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><tt class="docutils literal"><span class="pre">true</span></tt> if <cite>obj</cite> is <cite>Array</cite>-typed, <tt class="docutils literal"><span class="pre">false</span></tt> otherwise</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">boolean</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="log">
<tt class="descname">log</tt><big>(</big><em>message</em><big>)</big><a class="headerlink" href="#log" title="Permalink to this definition">¶</a></dt>
<dd><p>Log a message to the CouchDB log (at the <cite>INFO</cite> level).</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first last simple">
<li><strong>message</strong> &#8211; Message to be logged</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">){</span>
  <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Procesing doc &#39;</span> <span class="o">+</span> <span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]);</span>
  <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After the map function has run, the following line can be found in CouchDB
logs (e.g. at <cite>/var/log/couchdb/couch.log</cite>):</p>
<div class="highlight-text"><div class="highlight"><pre>[Sat, 03 Nov 2012 17:38:02 GMT] [info] [&lt;0.7543.0&gt;] OS Process #Port&lt;0.3289&gt; Log :: Processing doc 8d300b86622d67953d102165dbe99467
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="provides">
<tt class="descname">provides</tt><big>(</big><em>key</em>, <em>func</em><big>)</big><a class="headerlink" href="#provides" title="Permalink to this definition">¶</a></dt>
<dd><p>Registers callable handler for specified MIME key.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first last simple">
<li><strong>key</strong> &#8211; MIME key previously defined by <a class="reference internal" href="contents.html#registerType" title="registerType"><tt class="xref js js-func docutils literal"><span class="pre">registerType()</span></tt></a></li>
<li><strong>func</strong> &#8211; MIME type handler</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="registerType">
<tt class="descname">registerType</tt><big>(</big><em>key</em>, <em>*mimes</em><big>)</big><a class="headerlink" href="#registerType" title="Permalink to this definition">¶</a></dt>
<dd><p>Registers list of MIME types by associated <cite>key</cite>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first last simple">
<li><strong>key</strong> &#8211; MIME types</li>
<li><strong>mimes</strong> &#8211; MIME types enumeration</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Predefined mappings (<cite>key</cite>-<cite>array</cite>):</p>
<ul class="simple">
<li><strong>all</strong>: <tt class="docutils literal"><span class="pre">*/*</span></tt></li>
<li><strong>text</strong>: <tt class="docutils literal"><span class="pre">text/plain;</span> <span class="pre">charset=utf-8</span></tt>, <tt class="docutils literal"><span class="pre">txt</span></tt></li>
<li><strong>html</strong>: <tt class="docutils literal"><span class="pre">text/html;</span> <span class="pre">charset=utf-8</span></tt></li>
<li><strong>xhtml</strong>: <tt class="docutils literal"><span class="pre">application/xhtml+xml</span></tt>, <tt class="docutils literal"><span class="pre">xhtml</span></tt></li>
<li><strong>xml</strong>: <tt class="docutils literal"><span class="pre">application/xml</span></tt>, <tt class="docutils literal"><span class="pre">text/xml</span></tt>, <tt class="docutils literal"><span class="pre">application/x-xml</span></tt></li>
<li><strong>js</strong>: <tt class="docutils literal"><span class="pre">text/javascript</span></tt>, <tt class="docutils literal"><span class="pre">application/javascript</span></tt>,
<tt class="docutils literal"><span class="pre">application/x-javascript</span></tt></li>
<li><strong>css</strong>: <tt class="docutils literal"><span class="pre">text/css</span></tt></li>
<li><strong>ics</strong>: <tt class="docutils literal"><span class="pre">text/calendar</span></tt></li>
<li><strong>csv</strong>: <tt class="docutils literal"><span class="pre">text/csv</span></tt></li>
<li><strong>rss</strong>: <tt class="docutils literal"><span class="pre">application/rss+xml</span></tt></li>
<li><strong>atom</strong>: <tt class="docutils literal"><span class="pre">application/atom+xml</span></tt></li>
<li><strong>yaml</strong>: <tt class="docutils literal"><span class="pre">application/x-yaml</span></tt>, <tt class="docutils literal"><span class="pre">text/yaml</span></tt></li>
<li><strong>multipart_form</strong>: <tt class="docutils literal"><span class="pre">multipart/form-data</span></tt></li>
<li><strong>url_encoded_form</strong>: <tt class="docutils literal"><span class="pre">application/x-www-form-urlencoded</span></tt></li>
<li><strong>json</strong>: <tt class="docutils literal"><span class="pre">application/json</span></tt>, <tt class="docutils literal"><span class="pre">text/x-json</span></tt></li>
</ul>
</dd></dl>

<dl class="function">
<dt id="require">
<tt class="descname">require</tt><big>(</big><em>path</em><big>)</big><a class="headerlink" href="#require" title="Permalink to this definition">¶</a></dt>
<dd><p>Loads CommonJS module by a specified <cite>path</cite>. The path should not start with
a slash.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>path</strong> &#8211; A CommonJS module path started from design document root</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Exported statements</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="send">
<tt class="descname">send</tt><big>(</big><em>chunk</em><big>)</big><a class="headerlink" href="#send" title="Permalink to this definition">¶</a></dt>
<dd><p>Sends a single string <cite>chunk</cite> in response.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first last simple">
<li><strong>chunk</strong> &#8211; Text chunk</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
  <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Hello,&#39;</span><span class="p">);</span>
  <span class="nx">send</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
  <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Couch&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">!</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="start">
<tt class="descname">start</tt><big>(</big><em>init_resp</em><big>)</big><a class="headerlink" href="#start" title="Permalink to this definition">¶</a></dt>
<dd><p>Initiates chunked response. As an option, a custom
<a class="reference internal" href="contents.html#response-object"><em>response</em></a> object may be sent at this point.
For <cite>list</cite>-functions only!</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">list functions may set the <cite>HTTP response code</cite> and <cite>headers</cite> by calling
this function. This function must be called before <a class="reference internal" href="contents.html#send" title="send"><tt class="xref js js-func docutils literal"><span class="pre">send()</span></tt></a>,
<a class="reference internal" href="contents.html#getRow" title="getRow"><tt class="xref js js-func docutils literal"><span class="pre">getRow()</span></tt></a> or a <cite>return</cite> statement; otherwise, the query server will
implicitly call this function with the empty object (<tt class="docutils literal"><span class="pre">{}</span></tt>).</p>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
  <span class="nx">start</span><span class="p">({</span>
    <span class="s2">&quot;code&quot;</span><span class="o">:</span> <span class="mi">302</span><span class="p">,</span>
    <span class="s2">&quot;headers&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;Location&quot;</span><span class="o">:</span> <span class="s2">&quot;http://couchdb.apache.org&quot;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="s2">&quot;Relax!&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="sum">
<tt class="descname">sum</tt><big>(</big><em>arr</em><big>)</big><a class="headerlink" href="#sum" title="Permalink to this definition">¶</a></dt>
<dd><p>Sum <cite>arr</cite>&#8216;s items.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>arr</strong> &#8211; Array of numbers</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">number</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="toJSON">
<tt class="descname">toJSON</tt><big>(</big><em>obj</em><big>)</big><a class="headerlink" href="#toJSON" title="Permalink to this definition">¶</a></dt>
<dd><p>Encodes <cite>obj</cite> to JSON string. This is an alias for the <tt class="docutils literal"><span class="pre">JSON.stringify</span></tt>
method.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>obj</strong> &#8211; JSON encodable object</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">JSON string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="commonjs-modules">
<span id="commonjs"></span><h4>CommonJS Modules<a class="headerlink" href="#commonjs-modules" title="Permalink to this headline">¶</a></h4>
<p>Support for <a class="reference external" href="http://wiki.commonjs.org/wiki/Modules/1.1.1">CommonJS Modules</a>
(introduced in CouchDB 0.11.0) allows you to create modular design functions
without the need for duplication of functionality.</p>
<p>Here&#8217;s a CommonJS module that checks user permissions:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">user_context</span><span class="p">(</span><span class="nx">userctx</span><span class="p">,</span> <span class="nx">secobj</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">is_admin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">userctx</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_admin&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;is_admin&#39;</span><span class="o">:</span> <span class="nx">is_admin</span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">user_context</span>
</pre></div>
</div>
<p>Each module has access to additional global variables:</p>
<ul class="simple">
<li><strong>module</strong> (<cite>object</cite>): Contains information about the stored module<ul>
<li><strong>id</strong> (<cite>string</cite>): The module id; a JSON path in ddoc context</li>
<li><strong>current</strong> (<cite>code</cite>): Compiled module code object</li>
<li><strong>parent</strong> (<cite>object</cite>): Parent frame</li>
<li><strong>exports</strong> (<cite>object</cite>): Export statements</li>
</ul>
</li>
<li><strong>exports</strong> (<cite>object</cite>): Shortcut to the <tt class="docutils literal"><span class="pre">module.exports</span></tt> object</li>
</ul>
<p>The CommonJS module can be added to a design document, like so:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
   <span class="s2">&quot;views&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;lib&quot;</span><span class="o">:</span> <span class="p">{</span>
         <span class="s2">&quot;security&quot;</span><span class="o">:</span> <span class="s2">&quot;function user_context(userctx, secobj) { ... }&quot;</span>
      <span class="p">}</span>
   <span class="p">},</span>
   <span class="s2">&quot;validate_doc_update&quot;</span><span class="o">:</span> <span class="s2">&quot;function(newdoc, olddoc, userctx, secobj) {</span>
<span class="s2">      user = require(&#39;lib/security&#39;).user(userctx, secobj);</span>
<span class="s2">      return user.is_admin();</span>
<span class="s2">   }&quot;</span>
   <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;_design/test&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Modules paths are relative to the design document&#8217;s <tt class="docutils literal"><span class="pre">views</span></tt> object, but
modules can only be loaded from the object referenced via <tt class="docutils literal"><span class="pre">lib</span></tt>. The
<tt class="docutils literal"><span class="pre">lib</span></tt> structure can still be used for view functions as well, by simply
storing view functions at e.g. <tt class="docutils literal"><span class="pre">views.lib.map</span></tt>, <tt class="docutils literal"><span class="pre">views.lib.reduce</span></tt>, etc.</p>
</div>
</div>
<span id="document-query-server/erlang"></span><div class="section" id="erlang">
<span id="query-server-erlang"></span><h3>Erlang<a class="headerlink" href="#erlang" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The Erlang query server is disabled by default.
Read <a class="reference internal" href="contents.html#config-native-query-servers"><em>configuration guide</em></a> about
reasons why and how to enable it.</p>
</div>
<dl class="function">
<dt id="Emit">
<tt class="descname">Emit</tt><big>(</big><em>Id</em>, <em>Value</em><big>)</big><a class="headerlink" href="#Emit" title="Permalink to this definition">¶</a></dt>
<dd><p>Emits <cite>key</cite>-<cite>value</cite> pairs to view indexer process.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="k">fun</span><span class="p">({</span><span class="nv">Doc</span><span class="p">})</span> <span class="o">-&gt;</span>
  <span class="o">&lt;&lt;</span><span class="nv">K</span><span class="p">,_</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nn">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;_rev&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Doc</span><span class="p">,</span> <span class="n">null</span><span class="p">),</span>
  <span class="nv">V</span> <span class="o">=</span> <span class="nn">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;_id&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Doc</span><span class="p">,</span> <span class="n">null</span><span class="p">),</span>
  <span class="nv">Emit</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">K</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">V</span><span class="p">)</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="FoldRows">
<tt class="descname">FoldRows</tt><big>(</big><em>Fun</em>, <em>Acc</em><big>)</big><a class="headerlink" href="#FoldRows" title="Permalink to this definition">¶</a></dt>
<dd><p>Helper to iterate over all rows in a list function.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first last simple">
<li><strong>Fun</strong> &#8211; Function object.</li>
<li><strong>Acc</strong> &#8211; The value previously returned by <cite>Fun</cite>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-erlang"><div class="highlight"><pre><span class="k">fun</span><span class="p">(</span><span class="nv">Head</span><span class="p">,</span> <span class="p">{</span><span class="nv">Req</span><span class="p">})</span> <span class="o">-&gt;</span>
  <span class="nv">Fun</span> <span class="o">=</span> <span class="k">fun</span><span class="p">({</span><span class="nv">Row</span><span class="p">},</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Id</span> <span class="o">=</span> <span class="nn">couch_util</span><span class="p">:</span><span class="nf">get_value</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;id&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Row</span><span class="p">),</span>
    <span class="nv">Send</span><span class="p">(</span><span class="nb">list_to_binary</span><span class="p">(</span><span class="nn">io_lib</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Previous doc id: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Acc</span><span class="p">]))),</span>
    <span class="nv">Send</span><span class="p">(</span><span class="nb">list_to_binary</span><span class="p">(</span><span class="nn">io_lib</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Current  doc id: </span><span class="si">~p~n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Id</span><span class="p">]))),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Id</span><span class="p">}</span>
  <span class="k">end</span><span class="p">,</span>
  <span class="nv">FoldRows</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="n">nil</span><span class="p">),</span>
  <span class="s">&quot;&quot;</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="GetRow">
<tt class="descname">GetRow</tt><big>(</big><big>)</big><a class="headerlink" href="#GetRow" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieves the next row from a related view result.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="c">%% FoldRows background implementation.</span>
<span class="c">%% https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=blob;f=src/couchdb/couch_native_process.erl;hb=HEAD#l368</span>
<span class="c">%%</span>
<span class="nf">foldrows</span><span class="p">(</span><span class="nv">GetRow</span><span class="p">,</span> <span class="nv">ProcRow</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">case</span> <span class="nv">GetRow</span><span class="p">()</span> <span class="k">of</span>
    <span class="n">nil</span> <span class="o">-&gt;</span>
      <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">};</span>
    <span class="nv">Row</span> <span class="o">-&gt;</span>
      <span class="k">case</span> <span class="p">(</span><span class="k">catch</span> <span class="nv">ProcRow</span><span class="p">(</span><span class="nv">Row</span><span class="p">,</span> <span class="nv">Acc</span><span class="p">))</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Acc2</span><span class="p">}</span> <span class="o">-&gt;</span>
          <span class="n">foldrows</span><span class="p">(</span><span class="nv">GetRow</span><span class="p">,</span> <span class="nv">ProcRow</span><span class="p">,</span> <span class="nv">Acc2</span><span class="p">);</span>
        <span class="p">{</span><span class="n">stop</span><span class="p">,</span> <span class="nv">Acc2</span><span class="p">}</span> <span class="o">-&gt;</span>
          <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Acc2</span><span class="p">}</span>
      <span class="k">end</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="Log">
<tt class="descname">Log</tt><big>(</big><em>Msg</em><big>)</big><a class="headerlink" href="#Log" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first last simple">
<li><strong>Msg</strong> &#8211; Log a message at the <cite>INFO</cite> level.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<div class="highlight-erlang"><div class="highlight"><pre><span class="k">fun</span><span class="p">({</span><span class="nv">Doc</span><span class="p">})</span> <span class="o">-&gt;</span>
  <span class="o">&lt;&lt;</span><span class="nv">K</span><span class="p">,_</span><span class="o">/</span><span class="n">binary</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nn">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;_rev&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Doc</span><span class="p">,</span> <span class="n">null</span><span class="p">),</span>
  <span class="nv">V</span> <span class="o">=</span> <span class="nn">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;_id&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">Doc</span><span class="p">,</span> <span class="n">null</span><span class="p">),</span>
  <span class="nv">Log</span><span class="p">(</span><span class="nn">lists</span><span class="p">:</span><span class="nf">flatten</span><span class="p">(</span><span class="nn">io_lib</span><span class="p">:</span><span class="nf">format</span><span class="p">(</span><span class="s">&quot;Hello from </span><span class="si">~s</span><span class="s"> doc!&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">V</span><span class="p">]))),</span>
  <span class="nv">Emit</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="nv">K</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="nv">V</span><span class="p">)</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>After the map function has run, the following line can be found in
CouchDB logs (e.g. at <cite>/var/log/couchdb/couch.log</cite>):</p>
<div class="highlight-text"><div class="highlight"><pre>[Sun, 04 Nov 2012 11:33:58 GMT] [info] [&lt;0.9144.2&gt;] Hello from 8d300b86622d67953d102165dbe99467 doc!
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="Send">
<tt class="descname">Send</tt><big>(</big><em>Chunk</em><big>)</big><a class="headerlink" href="#Send" title="Permalink to this definition">¶</a></dt>
<dd><p>Sends a single string <cite>Chunk</cite> in response.</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="k">fun</span><span class="p">(</span><span class="nv">Head</span><span class="p">,</span> <span class="p">{</span><span class="nv">Req</span><span class="p">})</span> <span class="o">-&gt;</span>
  <span class="nv">Send</span><span class="p">(</span><span class="s">&quot;Hello,&quot;</span><span class="p">),</span>
  <span class="nv">Send</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">),</span>
  <span class="nv">Send</span><span class="p">(</span><span class="s">&quot;Couch&quot;</span><span class="p">),</span>
  <span class="s">&quot;!&quot;</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
<p>The function above produces the following response:</p>
<div class="highlight-text"><div class="highlight"><pre>Hello, Couch!
</pre></div>
</div>
</dd></dl>

<dl class="function">
<dt id="Start">
<tt class="descname">Start</tt><big>(</big><em>Headers</em><big>)</big><a class="headerlink" href="#Start" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first last simple">
<li><strong>Headers</strong> &#8211; Proplist of <a class="reference internal" href="contents.html#response-object"><em>response object</em></a>.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Initialize <a class="reference internal" href="contents.html#listfun"><em>List functions</em></a> response. At this point, response code and headers
may be defined. For example, this function redirects to the CouchDB web site:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="k">fun</span><span class="p">(</span><span class="nv">Head</span><span class="p">,</span> <span class="p">{</span><span class="nv">Req</span><span class="p">})</span> <span class="o">-&gt;</span>
  <span class="nv">Start</span><span class="p">({[{</span><span class="o">&lt;&lt;</span><span class="s">&quot;code&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="mi">302</span><span class="p">},</span>
          <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;headers&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="p">{[</span>
            <span class="p">{</span><span class="o">&lt;&lt;</span><span class="s">&quot;Location&quot;</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;&lt;</span><span class="s">&quot;http://couchdb.apache.org&quot;</span><span class="o">&gt;&gt;</span><span class="p">}]</span>
          <span class="p">}}</span>
        <span class="p">]}),</span>
  <span class="s">&quot;Relax!&quot;</span>
<span class="k">end</span><span class="p">.</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
</div>
<span id="document-fauxton/index"></span><div class="section" id="fauxton">
<span id="id1"></span><h2>Fauxton<a class="headerlink" href="#fauxton" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-fauxton/install"></span><div class="section" id="installation">
<span id="fauxton-install"></span><h3>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<p>A recent of <a class="reference external" href="http://nodejs.org/">node.js</a> and <a class="reference external" href="https://npmjs.org/doc/README.html">npm</a> is required.</p>
<div class="section" id="get-the-source">
<h4>Get the source<a class="headerlink" href="#get-the-source" title="Permalink to this headline">¶</a></h4>
<p>Clone the CouchDB repo:</p>
<div class="highlight-ini"><div class="highlight"><pre>$ git clone http://git-wip-us.apache.org/repos/asf/couchdb.git
$ cd couchdb
</pre></div>
</div>
</div>
<div class="section" id="fauxton-setup">
<h4>Fauxton Setup<a class="headerlink" href="#fauxton-setup" title="Permalink to this headline">¶</a></h4>
<p>Install all dependencies:</p>
<div class="highlight-ini"><div class="highlight"><pre>couchdb/ $ cd src/fauxton
couchdb/src/fauxton/ $ npm install
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>To avoid a npm global install add <tt class="docutils literal"><span class="pre">node_modules/.bin</span></tt> to your path:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">export PATH</span><span class="o">=</span><span class="s">./node_modules/.bin:$PATH</span>
</pre></div>
</div>
<p>Or just use the wrappers in <tt class="docutils literal"><span class="pre">./bin/</span></tt>.</p>
<p>Development mode, non minified files:</p>
<div class="highlight-ini"><div class="highlight"><pre>./bin/grunt couchdebug
</pre></div>
</div>
<p>Or fully compiled install:</p>
<div class="last highlight-ini"><div class="highlight"><pre>./bin/grunt couchdb
</pre></div>
</div>
</div>
</div>
<div class="section" id="dev-server">
<h4>Dev Server<a class="headerlink" href="#dev-server" title="Permalink to this headline">¶</a></h4>
<p>Using the dev server is the easiest way to use Fauxton, specially when
developing for it:</p>
<div class="highlight-ini"><div class="highlight"><pre>grunt dev
</pre></div>
</div>
</div>
<div class="section" id="deploy-fauxton">
<h4>Deploy Fauxton<a class="headerlink" href="#deploy-fauxton" title="Permalink to this headline">¶</a></h4>
<p>Deploy Fauxton to your local CouchDB instance:</p>
<blockquote>
<div>./bin/grunt couchapp_deploy</div></blockquote>
<p>The Fauxton be available by <a class="reference external" href="http://localhost:5984/fauxton/_design/fauxton/index.html">http://localhost:5984/fauxton/_design/fauxton/index.html</a></p>
<div class="section" id="understang-fauxton-code-layout">
<h5>Understang Fauxton Code layout<a class="headerlink" href="#understang-fauxton-code-layout" title="Permalink to this headline">¶</a></h5>
<p>Each bit of functionality is its own separate module or addon.</p>
<p>All core modules are stored under <cite>app/module</cite> and any addons that are optional
are under <cite>app/addons</cite>.</p>
<p>We use <a class="reference external" href="http://backbonejs.org/">backbone.js</a> and <a class="reference external" href="https://github.com/tbranyen/backbone.layoutmanager">Backbone.layoutmanager</a> quite heavily, so best to
get an idea how they work. Its best at this point to read through a couple of
the modules and addons to get an idea of how they work.</p>
<p>Two good starting points are <cite>app/addon/config</cite> and <cite>app/modules/databases</cite>.</p>
<p>Each module must have a <cite>base.js</cite> file, this is read and compile when Fauxton is
deployed.</p>
<p>The <cite>resource.js</cite> file is usually for your <tt class="docutils literal"><span class="pre">Backbone.Models</span></tt> and
<tt class="docutils literal"><span class="pre">Backbone.Collections</span></tt>, <cite>view.js</cite> for your <tt class="docutils literal"><span class="pre">Backbone.Views</span></tt>.</p>
<p>The <cite>routes.js</cite> is used to register a url path for your view along with what
layout, data, breadcrumbs and api point is required for the view.</p>
</div>
<div class="section" id="todo-items">
<h5>ToDo items<a class="headerlink" href="#todo-items" title="Permalink to this headline">¶</a></h5>
<p>Checkout <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB/component/12320406">JIRA</a>  for a list of items to do.</p>
</div>
</div>
</div>
<span id="document-fauxton/addons"></span><div class="section" id="writting-addons">
<span id="fauxton-addons"></span><h3>Writting Addons<a class="headerlink" href="#writting-addons" title="Permalink to this headline">¶</a></h3>
<p>Addons allow you to extend Fauxton for a specific use case. Usually, they
have the following structure:</p>
<div class="highlight-ini"><div class="highlight"><pre>+ my_addon/
| ---+ assets [optional]
|    \ ---+ less
|         \ ---- my_addon.less
| ---+ templates/
|    \ ---- my_addon.html - underscore template fragments
| ---- resources.js - models and collections of the addon
| ---- routes.js - URL routing for the addon
| ---- views.js - views that the model provides
</pre></div>
</div>
<div class="section" id="generating-an-addon">
<h4>Generating an Addon<a class="headerlink" href="#generating-an-addon" title="Permalink to this headline">¶</a></h4>
<p>We have a <cite>grunt-init</cite> template that lets you create a skeleton addon,
including all the boiler plate code. Run <tt class="docutils literal"><span class="pre">grunt-init</span> <span class="pre">tasks/addon</span></tt> and answer
the questions it asks to create an addon:</p>
<div class="highlight-ini"><div class="highlight"><pre>± grunt-init tasks/addon
path.existsSync is now called `fs.existsSync`.
Running &quot;addon&quot; task

Please answer the following:
[?] Add on Name (WickedCool) SuperAddon
[?] Location of add ons (app/addons)
[?] Do you need an assets folder?(for .less) (y/N)
[?] Do you need to make any changes to the above before continuing? (y/N)

Created addon SuperAddon in app/addons

Done, without errors.
</pre></div>
</div>
<p>Once the addon is created add the name to the settings.json file to get it
compiled and added on the next install.</p>
</div>
<div class="section" id="routes-and-hooks">
<h4>Routes and hooks<a class="headerlink" href="#routes-and-hooks" title="Permalink to this headline">¶</a></h4>
<p>An addon can insert itself into Fauxton in two ways; via a route or via a hook.</p>
<div class="section" id="routes">
<h5>Routes<a class="headerlink" href="#routes" title="Permalink to this headline">¶</a></h5>
<p>An addon will override an existing route should one exist, but in all other
ways is just a normal backbone <cite>route/view</cite>. This is how you would add a whole
new feature.</p>
</div>
<div class="section" id="hooks">
<h5>Hooks<a class="headerlink" href="#hooks" title="Permalink to this headline">¶</a></h5>
<p>Hooks let you modify/extend an existing feature. They modify a DOM element by
selector for a named set of routes, for example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">Search</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FauxtonAPI</span><span class="p">.</span><span class="nx">addon</span><span class="p">();</span>
<span class="nx">Search</span><span class="p">.</span><span class="nx">hooks</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c1">// Render additional content into the sidebar</span>
  <span class="s2">&quot;#sidebar-content&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">routes</span><span class="o">:</span><span class="p">[</span>
      <span class="s2">&quot;database/:database/_design/:ddoc/_search/:search&quot;</span><span class="p">,</span>
      <span class="s2">&quot;database/:database/_design/:ddoc/_view/:view&quot;</span><span class="p">,</span>
      <span class="s2">&quot;database/:database/_:handler&quot;</span><span class="p">],</span>
    <span class="nx">callback</span><span class="o">:</span> <span class="nx">searchSidebar</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="k">return</span> <span class="nx">Search</span><span class="p">;</span>
</pre></div>
</div>
<p>adds the <cite>searchSidebar</cite> callback to <cite>#sidebar-content</cite> for three routes.</p>
</div>
</div>
<div class="section" id="hello-world-addon">
<h4>Hello world Addon<a class="headerlink" href="#hello-world-addon" title="Permalink to this headline">¶</a></h4>
<p>First create the addon skeleton:</p>
<div class="highlight-ini"><div class="highlight"><pre>± bbb addon
path.existsSync is now called `fs.existsSync`.
Running &quot;addon&quot; task

Please answer the following:
[?] Add on Name (WickedCool) Hello
[?] Location of add ons (app/addons)
[?] Do you need to make any changes to the above before continuing? (y/N)

Created addon Hello in app/addons

Done, without errors.
</pre></div>
</div>
<p>In <cite>app/addons/hello/templates/hello.html</cite> place:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Hello!<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div>
<p>Next, we&#8217;ll defined a simple view in <cite>resources.js</cite> (for more complex addons
you may want to have a views.js) that renders that template:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
  <span class="s2">&quot;app&quot;</span><span class="p">,</span>
  <span class="s2">&quot;api&quot;</span>
<span class="p">],</span>

<span class="kd">function</span> <span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">FauxtonAPI</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Resources</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="nx">Resources</span><span class="p">.</span><span class="nx">Hello</span> <span class="o">=</span> <span class="nx">FauxtonAPI</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">template</span><span class="o">:</span> <span class="s2">&quot;addons/hello/templates/hello&quot;</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">Resources</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Then define a route in <cite>routes.js</cite> that the addon is accessible at:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
  <span class="s2">&quot;app&quot;</span><span class="p">,</span>
  <span class="s2">&quot;api&quot;</span><span class="p">,</span>
  <span class="s2">&quot;addons/hello/resources&quot;</span>
<span class="p">],</span>

<span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">FauxtonAPI</span><span class="p">,</span> <span class="nx">Resources</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">helloRoute</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;helloRoute callback yo&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">layout</span><span class="o">:</span> <span class="s2">&quot;one_pane&quot;</span><span class="p">,</span>
      <span class="nx">crumbs</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">,</span><span class="s2">&quot;link&quot;</span><span class="o">:</span> <span class="s2">&quot;_hello&quot;</span><span class="p">}</span>
      <span class="p">],</span>
      <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;#dashboard-content&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Resources</span><span class="p">.</span><span class="nx">Hello</span><span class="p">({})</span>
      <span class="p">},</span>
      <span class="nx">apiUrl</span><span class="o">:</span> <span class="s1">&#39;hello&#39;</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="nx">Routes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;_hello&quot;</span><span class="o">:</span> <span class="nx">helloRoute</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Routes</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Then wire it all together in base.js:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">define</span><span class="p">([</span>
  <span class="s2">&quot;app&quot;</span><span class="p">,</span>
  <span class="s2">&quot;api&quot;</span><span class="p">,</span>
  <span class="s2">&quot;addons/hello/routes&quot;</span>
<span class="p">],</span>

<span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">FauxtonAPI</span><span class="p">,</span> <span class="nx">HelloRoutes</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">Hello</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FauxtonAPI</span><span class="p">.</span><span class="nx">addon</span><span class="p">();</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;hello from hello&#39;</span><span class="p">);</span>

  <span class="nx">Hello</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">FauxtonAPI</span><span class="p">.</span><span class="nx">addHeaderLink</span><span class="p">({</span><span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="nx">href</span><span class="o">:</span> <span class="s2">&quot;#_hello&quot;</span><span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">Hello</span><span class="p">.</span><span class="nx">Routes</span> <span class="o">=</span> <span class="nx">HelloRoutes</span><span class="p">;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">Hello</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">Hello</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Once the code is in place include the add on in your <cite>settings.json</cite> so that it
gets included by the <cite>require</cite> task. Your addon is included in one of three
ways; a local path, a git URL or a name. Named plugins assume the plugin is in
the Fauxton base directory, addons with a git URL will be cloned into the
application, local paths will be copied. Addons included from a local path will
be cleaned out by the clean task, others are left alone.</p>
</div>
</div>
</div>
</div>
<span id="document-api/index"></span><div class="section" id="api-reference">
<span id="api"></span><h2>API Reference<a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h2>
<p>The components of the API URL path help determine the part of the
CouchDB server that is being accessed. The result is the structure of
the URL request both identifies and effectively describes the area of
the database you are accessing.</p>
<p>As with all URLs, the individual components are separated by a forward
slash.</p>
<p>As a general rule, URL components and JSON fields starting with the
<tt class="docutils literal"><span class="pre">_</span></tt> (underscore) character represent a special component or entity
within the server or returned object. For example, the URL fragment
<tt class="docutils literal"><span class="pre">/_all_dbs</span></tt> gets a list of all of the databases in a CouchDB instance.</p>
<p>This reference is structured according to the URL structure, as below.</p>
<div class="toctree-wrapper compound">
<span id="document-api/basics"></span><div class="section" id="api-basics">
<span id="id1"></span><h3>API Basics<a class="headerlink" href="#api-basics" title="Permalink to this headline">¶</a></h3>
<p>The CouchDB API is the primary method of interfacing to a CouchDB
instance. Requests are made using HTTP and requests are used to request
information from the database, store new data, and perform views and
formatting of the information stored within the documents.</p>
<p>Requests to the API can be categorised by the different areas of the
CouchDB system that you are accessing, and the HTTP method used to send
the request. Different methods imply different operations, for example
retrieval of information from the database is typically handled by the
<tt class="docutils literal"><span class="pre">GET</span></tt> operation, while updates are handled by either a <tt class="docutils literal"><span class="pre">POST</span></tt> or
<tt class="docutils literal"><span class="pre">PUT</span></tt> request. There are some differences between the information that
must be supplied for the different methods. For a guide to the basic
HTTP methods and request structure, see <a class="reference internal" href="contents.html#api-format"><em>Request Format and Responses</em></a>.</p>
<p>For nearly all operations, the submitted data, and the returned data
structure, is defined within a JavaScript Object Notation (JSON) object.
Basic information on the content and data types for JSON are provided in
<a class="reference internal" href="contents.html#json"><em>JSON Basics</em></a>.</p>
<p>Errors when accessing the CouchDB API are reported using standard HTTP
Status Codes. A guide to the generic codes returned by CouchDB are
provided in <a class="reference internal" href="contents.html#errors"><em>HTTP Status Codes</em></a>.</p>
<p>When accessing specific areas of the CouchDB API, specific information
and examples on the HTTP methods and request, JSON structures, and error
codes are provided.</p>
<div class="section" id="request-format-and-responses">
<span id="api-format"></span><h4>Request Format and Responses<a class="headerlink" href="#request-format-and-responses" title="Permalink to this headline">¶</a></h4>
<p>CouchDB supports the following HTTP request methods:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">GET</span></tt></p>
<p>Request the specified item. As with normal HTTP requests, the format
of the URL defines what is returned. With CouchDB this can include
static items, database documents, and configuration and statistical
information. In most cases the information is returned in the form of
a JSON document.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">HEAD</span></tt></p>
<p>The <tt class="docutils literal"><span class="pre">HEAD</span></tt> method is used to get the HTTP header of a <tt class="docutils literal"><span class="pre">GET</span></tt>
request without the body of the response.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">POST</span></tt></p>
<p>Upload data. Within CouchDB <tt class="docutils literal"><span class="pre">POST</span></tt> is used to set values, including
uploading documents, setting document values, and starting certain
administration commands.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">PUT</span></tt></p>
<p>Used to put a specified resource. In CouchDB <tt class="docutils literal"><span class="pre">PUT</span></tt> is used to
create new objects, including databases, documents, views and design
documents.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">DELETE</span></tt></p>
<p>Deletes the specified resource, including documents, views, and
design documents.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">COPY</span></tt></p>
<p>A special method that can be used to copy documents and objects.</p>
</li>
</ul>
<p>If you use the an unsupported HTTP request type with a URL that does not
support the specified type, a 405 error will be returned, listing the
supported HTTP methods. For example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;error&quot;</span><span class="o">:</span><span class="s2">&quot;method_not_allowed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span><span class="s2">&quot;Only GET,HEAD allowed&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The CouchDB design document API and the functions when returning HTML
(for example as part of a show or list) enables you to include custom
HTTP headers through the <tt class="docutils literal"><span class="pre">headers</span></tt> block of the return object.</p>
</div>
<div class="section" id="http-headers">
<h4>HTTP Headers<a class="headerlink" href="#http-headers" title="Permalink to this headline">¶</a></h4>
<p>Because CouchDB uses HTTP for all communication, you need to ensure that
the correct HTTP headers are supplied (and processed on retrieval) so
that you get the right format and encoding. Different environments and
clients will be more or less strict on the effect of these HTTP headers
(especially when not present). Where possible you should be as specific
as possible.</p>
<div class="section" id="request-headers">
<h5>Request Headers<a class="headerlink" href="#request-headers" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">Content-type</span></tt></p>
<p>Specifies the content type of the information being supplied within
the request. The specification uses MIME type specifications. For the
majority of requests this will be JSON (<tt class="docutils literal"><span class="pre">application/json</span></tt>). For
some settings the MIME type will be plain text. When uploading
attachments it should be the corresponding MIME type for the
attachment or binary (<tt class="docutils literal"><span class="pre">application/octet-stream</span></tt>).</p>
<p>The use of the <tt class="docutils literal"><span class="pre">Content-type</span></tt> on a request is highly recommended.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">Accept</span></tt></p>
<p>Specifies the list of accepted data types to be returned by the
server (i.e. that are accepted/understandable by the client). The
format should be a list of one or more MIME types, separated by
colons.</p>
<p>For the majority of requests the definition should be for JSON data
(<tt class="docutils literal"><span class="pre">application/json</span></tt>). For attachments you can either specify the
MIME type explicitly, or use <tt class="docutils literal"><span class="pre">*/*</span></tt> to specify that all file types
are supported. If the <tt class="docutils literal"><span class="pre">Accept</span></tt> header is not supplied, then the
<tt class="docutils literal"><span class="pre">*/*</span></tt> MIME type is assumed (i.e. client accepts all formats).</p>
<p>The use of <tt class="docutils literal"><span class="pre">Accept</span></tt> in queries for CouchDB is not required, but is
highly recommended as it helps to ensure that the data returned can
be processed by the client.</p>
<p>If you specify a data type using the <tt class="docutils literal"><span class="pre">Accept</span></tt> header, CouchDB will
honor the specified type in the <tt class="docutils literal"><span class="pre">Content-type</span></tt> header field
returned. For example, if you explicitly request <tt class="docutils literal"><span class="pre">application/json</span></tt>
in the <tt class="docutils literal"><span class="pre">Accept</span></tt> of a request, the returned HTTP headers will use
the value in the returned <tt class="docutils literal"><span class="pre">Content-type</span></tt> field.</p>
<p>For example, when sending a request without an explicit <tt class="docutils literal"><span class="pre">Accept</span></tt>
header, or when specifying <tt class="docutils literal"><span class="pre">*/*</span></tt>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">couchdb:5984</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">*/*</span>
</pre></div>
</div>
<p>The returned headers are:</p>
<div class="highlight-http"><div class="highlight"><pre>Server: CouchDB (Erlang/OTP)
Date: Thu, 13 Jan 2011 13:39:34 GMT
Content-Type: text/plain;charset=utf-8
Content-Length: 227
Cache-Control: must-revalidate
</pre></div>
</div>
<p>Note that the returned content type is <tt class="docutils literal"><span class="pre">text/plain</span></tt> even though the
information returned by the request is in JSON format.</p>
<p>Explicitly specifying the <tt class="docutils literal"><span class="pre">Accept</span></tt> header:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">couchdb:5984</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
</pre></div>
</div>
<p>The headers returned include the <tt class="docutils literal"><span class="pre">application/json</span></tt> content type:</p>
<div class="highlight-http"><div class="highlight"><pre>Server: CouchDB (Erlang/OTP)
Date: Thu, 13 Jan 2013 13:40:11 GMT
Content-Type: application/json
Content-Length: 227
Cache-Control: must-revalidate
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="response-headers">
<h5>Response Headers<a class="headerlink" href="#response-headers" title="Permalink to this headline">¶</a></h5>
<p>Response headers are returned by the server when sending back content
and include a number of different header fields, many of which are
standard HTTP response header and have no significance to CouchDB
operation. The list of response headers important to CouchDB are listed
below.</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">Content-type</span></tt></p>
<p>Specifies the MIME type of the returned data. For most request, the
returned MIME type is <tt class="docutils literal"><span class="pre">text/plain</span></tt>. All text is encoded in Unicode
(UTF-8), and this is explicitly stated in the returned
<tt class="docutils literal"><span class="pre">Content-type</span></tt>, as <tt class="docutils literal"><span class="pre">text/plain;charset=utf-8</span></tt>.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">Cache-control</span></tt></p>
<p>The cache control HTTP response header provides a suggestion for
client caching mechanisms on how to treat the returned information.
CouchDB typically returns the <tt class="docutils literal"><span class="pre">must-revalidate</span></tt>, which indicates
that the information should be revalidated if possible. This is used
to ensure that the dynamic nature of the content is correctly
updated.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">Content-length</span></tt></p>
<p>The length (in bytes) of the returned content.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">Etag</span></tt></p>
<p>The <tt class="docutils literal"><span class="pre">Etag</span></tt> HTTP header field is used to show the revision for a
document, or a view.</p>
<p>ETags have been assigned to a map/reduce group (the collection of
views in a single design document). Any change to any of the indexes
for those views would generate a new ETag for all view URLs in a
single design doc, even if that specific view&#8217;s results had not
changed.</p>
<p>Each <tt class="docutils literal"><span class="pre">_view</span></tt> URL has its own ETag which only gets updated when
changes are made to the database that effect that index. If the
index for that specific view does not change, that view keeps the
original ETag head (therefore sending back 304 Not Modified more
often).</p>
</li>
</ul>
</div>
</div>
<div class="section" id="json-basics">
<span id="json"></span><h4>JSON Basics<a class="headerlink" href="#json-basics" title="Permalink to this headline">¶</a></h4>
<p>The majority of requests and responses to CouchDB use the JavaScript
Object Notation (JSON) for formatting the content and structure of the
data and responses.</p>
<p>JSON is used because it is the simplest and easiest to use solution for
working with data within a web browser, as JSON structures can be
evaluated and used as JavaScript objects within the web browser
environment. JSON also integrates with the server-side JavaScript used
within CouchDB.</p>
<p>JSON supports the same basic types as supported by JavaScript, these
are:</p>
<ul>
<li><p class="first">Number (either integer or floating-point).</p>
</li>
<li><p class="first">String; this should be enclosed by double-quotes and supports Unicode
characters and backslash escaping. For example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="s2">&quot;A String&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Boolean - a <tt class="docutils literal"><span class="pre">true</span></tt> or <tt class="docutils literal"><span class="pre">false</span></tt> value. You can use these strings
directly. For example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Array - a list of values enclosed in square brackets. For example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span><span class="s2">&quot;one&quot;</span><span class="p">,</span> <span class="s2">&quot;two&quot;</span><span class="p">,</span> <span class="s2">&quot;three&quot;</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">Object - a set of key/value pairs (i.e. an associative array, or
hash). The key must be a string, but the value can be any of the
supported JSON values. For example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
   <span class="s2">&quot;servings&quot;</span> <span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
   <span class="s2">&quot;subtitle&quot;</span> <span class="o">:</span> <span class="s2">&quot;Easy to make in advance, and then cook when ready&quot;</span><span class="p">,</span>
   <span class="s2">&quot;cooktime&quot;</span> <span class="o">:</span> <span class="mi">60</span><span class="p">,</span>
   <span class="s2">&quot;title&quot;</span> <span class="o">:</span> <span class="s2">&quot;Chicken Coriander&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In CouchDB, the JSON object is used to represent a variety of
structures, including the main CouchDB document.</p>
</li>
</ul>
<p>Parsing JSON into a JavaScript object is supported through the
<tt class="docutils literal"><span class="pre">JSON.parse()</span></tt> function in JavaScript, or through various libraries that
will perform the parsing of the content into a JavaScript object for
you. Libraries for parsing and generating JSON are available in many
languages, including Perl, Python, Ruby, Erlang and others.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Care should be taken to ensure that your JSON structures are
valid, invalid structures will cause CouchDB to return an HTTP status code
of 500 (server error).</p>
</div>
<div class="section" id="number-handling">
<span id="json-numbers"></span><h5>Number Handling<a class="headerlink" href="#number-handling" title="Permalink to this headline">¶</a></h5>
<p>Developers and users new to computer handling of numbers often encounter
suprises when expecting that a number stored in JSON format does not
necessarily return as the same number as compared character by character.</p>
<p>Any numbers defined in JSON that contain a decimal point or exponent
will be passed through the Erlang VM&#8217;s idea of the &#8220;double&#8221; data type.
Any numbers that are used in views will pass through the view server&#8217;s
idea of a number (the common JavaScript case means even integers pass
through a double due to JavaScript&#8217;s definition of a number).</p>
<p>Consider this document that we write to CouchDB:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;30b3b38cdbd9e3a587de9b8122000cff&quot;</span><span class="p">,</span>
  <span class="s2">&quot;number&quot;</span><span class="o">:</span> <span class="mf">1.1</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now let’s read that document back from CouchDB:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;30b3b38cdbd9e3a587de9b8122000cff&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-f065cee7c3fd93aa50f6c97acde93030&quot;</span><span class="p">,</span>
  <span class="s2">&quot;number&quot;</span><span class="o">:</span><span class="mf">1.1000000000000000888</span>
<span class="p">}</span>
</pre></div>
</div>
<p>What happens is CouchDB is changing the textual representation of the
result of decoding what it was given into some numerical format. In most
cases this is an <a class="reference external" href="https://en.wikipedia.org/wiki/IEEE_754-2008">IEEE 754</a> double precision floating point number which
is exactly what almost all other languages use as well.</p>
<p>What Erlang does a bit differently than other languages is that it
does not attempt to pretty print the resulting output to use the
shortest number of characters. For instance, this is why we have this
relationship:</p>
<div class="highlight-erlang"><div class="highlight"><pre><span class="nn">ejson</span><span class="p">:</span><span class="nf">encode</span><span class="p">(</span><span class="nn">ejson</span><span class="p">:</span><span class="nf">decode</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="s">&quot;1.1&quot;</span><span class="o">&gt;&gt;</span><span class="p">)).</span>
<span class="o">&lt;&lt;</span><span class="s">&quot;1.1000000000000000888&quot;</span><span class="o">&gt;&gt;</span>
</pre></div>
</div>
<p>What can be confusing here is that internally those two formats
decode into the same IEEE-754 representation. And more importantly, it
will decode into a fairly close representation when passed through all
major parsers that we know about.</p>
<p>While we&#8217;ve only been discussing cases where the textual
representation changes, another important case is when an input value
contains more precision than can actually represented in a double.
(You could argue that this case is actually &#8220;losing&#8221; data if you don&#8217;t
accept that numbers are stored in doubles).</p>
<p>Here&#8217;s a log for a couple of the more common JSON libraries that happen
to be on the author&#8217;s machine:</p>
<p>Spidermonkey:</p>
<div class="highlight-ini"><div class="highlight"><pre>$ js -h 2&gt;&amp;1 | head -n 1
JavaScript-C 1.8.5 2011-03-31
$ js
js&gt; JSON.stringify(JSON.parse(&quot;1.01234567890123456789012345678901234567890&quot;))
&quot;1.0123456789012346&quot;
js&gt; var f = JSON.stringify(JSON.parse(&quot;1.01234567890123456789012345678901234567890&quot;))
js&gt; JSON.stringify(JSON.parse(f))
&quot;1.0123456789012346&quot;
</pre></div>
</div>
<p>Node:</p>
<div class="highlight-ini"><div class="highlight"><pre>$ node -v
v0.6.15
$ node
JSON.stringify(JSON.parse(&quot;1.01234567890123456789012345678901234567890&quot;))
&#39;1.0123456789012346&#39;
var f = JSON.stringify(JSON.parse(&quot;1.01234567890123456789012345678901234567890&quot;))
undefined
JSON.stringify(JSON.parse(f))
&#39;1.0123456789012346&#39;
</pre></div>
</div>
<p>Python:</p>
<div class="highlight-ini"><div class="highlight"><pre>$ python
Python 2.7.2 (default, Jun 20 2012, 16:23:33)
[GCC 4.2.1 Compatible Apple Clang 4.0 (tags/Apple/clang-418.0.60)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
import json
json.dumps(json.loads(&quot;1.01234567890123456789012345678901234567890&quot;))
&#39;1.0123456789012346&#39;
f = json.dumps(json.loads(&quot;1.01234567890123456789012345678901234567890&quot;))
json.dumps(json.loads(f))
&#39;1.0123456789012346&#39;
</pre></div>
</div>
<p>Ruby:</p>
<div class="highlight-ini"><div class="highlight"><pre>$ irb --version
irb 0.9.5(05/04/13)
require &#39;JSON&#39;
=&gt; true
JSON.dump(JSON.load(&quot;[1.01234567890123456789012345678901234567890]&quot;))
=&gt; &quot;[1.01234567890123]&quot;
f = JSON.dump(JSON.load(&quot;[1.01234567890123456789012345678901234567890]&quot;))
=&gt; &quot;[1.01234567890123]&quot;
JSON.dump(JSON.load(f))
=&gt; &quot;[1.01234567890123]&quot;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A small aside on Ruby, it requires a top level object or array, so I just
wrapped the value. Should be obvious it doesn&#8217;t affect the result of
parsing the number though.</p>
</div>
<p>Ejson (CouchDB&#8217;s current parser) at CouchDB sha 168a663b:</p>
<div class="highlight-ini"><div class="highlight"><pre>$ ./utils/run -i
Erlang R14B04 (erts-5.8.5) [source] [64-bit] [smp:2:2] [rq:2]
[async-threads:4] [hipe] [kernel-poll:true]

Eshell V5.8.5  (abort with ^G)
1&gt; ejson:encode(ejson:decode(&lt;&lt;&quot;1.01234567890123456789012345678901234567890&quot;&gt;&gt;)).
&lt;&lt;&quot;1.0123456789012346135&quot;&gt;&gt;
2&gt; F = ejson:encode(ejson:decode(&lt;&lt;&quot;1.01234567890123456789012345678901234567890&quot;&gt;&gt;)).
&lt;&lt;&quot;1.0123456789012346135&quot;&gt;&gt;
3&gt; ejson:encode(ejson:decode(F)).
&lt;&lt;&quot;1.0123456789012346135&quot;&gt;&gt;
</pre></div>
</div>
<p>As you can see they all pretty much behave the same except for Ruby
actually does appear to be losing some precision over the other
libraries.</p>
<p>The astute observer will notice that ejson (the CouchDB JSON library)
reported an extra three digits. While its tempting to think that this
is due to some internal difference, its just a more specific case of
the 1.1 input as described above.</p>
<p>The important point to realize here is that a double can only hold a
finite number of values. What we&#8217;re doing here is generating a string
that when passed through the &#8220;standard&#8221; floating point parsing
algorithms (ie, <tt class="docutils literal"><span class="pre">strtod</span></tt>) will result in the same bit pattern in memory
as we started with. Or, slightly different, the bytes in a JSON
serialized number are chosen such that they refer to a single specific
value that a double can represent.</p>
<p>The important point to understand is that we&#8217;re mapping from one
infinite set onto a finite set. An easy way to see this is by
reflecting on this:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">1.0</span> <span class="o">=</span><span class="s">= 1.00 == 1.000 = 1.(infinite zeroes)</span>
</pre></div>
</div>
<p>Obviously a computer can&#8217;t hold infinite bytes so we have to
decimate our infinitely sized set to a finite set that can be
represented concisely.</p>
<p>The game that other JSON libraries are playing is merely:</p>
<p>&#8220;How few characters do I have to use to select this specific value for a double&#8221;</p>
<p>And that game has lots and lots of subtle details that are difficult
to duplicate in C without a significant amount of effort (it took
Python over a year to get it sorted with their fancy build systems
that automatically run on a number of different architectures).</p>
<p>Hopefully we&#8217;ve shown that CouchDB is not doing anything &#8220;funky&#8221; by
changing input. Its behaving the same as any other common JSON library
does, its just not pretty printing its output.</p>
<p>On the other hand, if you actually are in a position where an IEEE-754
double is not a satisfactory datatype for your numbers, then the
answer as has been stated is to not pass your numbers through this
representation. In JSON this is accomplished by encoding them as a
string or by using integer types (although integer types can still
bite you if you use a platform that has a different integer
representation than normal, ie, JavaScript).</p>
<p>Further information can be found easily, including the
<a class="reference external" href="http://floating-point-gui.de/">Floating Point Guide</a>, and  <a class="reference external" href="http://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html">David Goldberg&#8217;s Reference</a>.</p>
<p>Also, if anyone is really interested in changing this behavior, we&#8217;re
all ears for contributions to <a class="reference external" href="https://github.com/davisp/jiffy">jiffy</a> (which is theoretically going to
replace ejson when we get around to updating the build system). The
places we&#8217;ve looked for inspiration are TCL and Python. If you know a
decent implementation of this float printing algorithm give us a
holler.</p>
</div>
</div>
<div class="section" id="http-status-codes">
<span id="errors"></span><h4>HTTP Status Codes<a class="headerlink" href="#http-status-codes" title="Permalink to this headline">¶</a></h4>
<p>With the interface to CouchDB working through HTTP, error codes and
statuses are reported using a combination of the HTTP status code
number, and corresponding data in the body of the response data.</p>
<p>A list of the error codes returned by CouchDB, and generic descriptions
of the related errors are provided below. The meaning of different
status codes for specific request types are provided in the
corresponding API call reference.</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">200</span> <span class="pre">-</span> <span class="pre">OK</span></tt></p>
<p>Request completed successfully.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">201</span> <span class="pre">-</span> <span class="pre">Created</span></tt></p>
<p>Document created successfully.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">202</span> <span class="pre">-</span> <span class="pre">Accepted</span></tt></p>
<p>Request has been accepted, but the corresponding operation may not
have completed. This is used for background operations, such as
database compaction.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">304</span> <span class="pre">-</span> <span class="pre">Not</span> <span class="pre">Modified</span></tt></p>
<p>The additional content requested has not been modified. This is used
with the ETag system to identify the version of information returned.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">400</span> <span class="pre">-</span> <span class="pre">Bad</span> <span class="pre">Request</span></tt></p>
<p>Bad request structure. The error can indicate an error with the
request URL, path or headers. Differences in the supplied MD5 hash
and content also trigger this error, as this may indicate message
corruption.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">401</span> <span class="pre">-</span> <span class="pre">Unauthorized</span></tt></p>
<p>The item requested was not available using the supplied
authorization, or authorization was not supplied.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">403</span> <span class="pre">-</span> <span class="pre">Forbidden</span></tt></p>
<p>The requested item or operation is forbidden.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">404</span> <span class="pre">-</span> <span class="pre">Not</span> <span class="pre">Found</span></tt></p>
<p>The requested content could not be found. The content will include
further information, as a JSON object, if available. The structure
will contain two keys, <tt class="docutils literal"><span class="pre">error</span></tt> and <tt class="docutils literal"><span class="pre">reason</span></tt>. For example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="o">:</span><span class="s2">&quot;not_found&quot;</span><span class="p">,</span><span class="s2">&quot;reason&quot;</span><span class="o">:</span><span class="s2">&quot;no_db_file&quot;</span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">405</span> <span class="pre">-</span> <span class="pre">Resource</span> <span class="pre">Not</span> <span class="pre">Allowed</span></tt></p>
<p>A request was made using an invalid HTTP request type for the URL
requested. For example, you have requested a <tt class="docutils literal"><span class="pre">PUT</span></tt> when a <tt class="docutils literal"><span class="pre">POST</span></tt>
is required. Errors of this type can also triggered by invalid URL
strings.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">406</span> <span class="pre">-</span> <span class="pre">Not</span> <span class="pre">Acceptable</span></tt></p>
<p>The requested content type is not supported by the server.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">409</span> <span class="pre">-</span> <span class="pre">Conflict</span></tt></p>
<p>Request resulted in an update conflict.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">412</span> <span class="pre">-</span> <span class="pre">Precondition</span> <span class="pre">Failed</span></tt></p>
<p>The request headers from the client and the capabilities of the
server do not match.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">415</span> <span class="pre">-</span> <span class="pre">Bad</span> <span class="pre">Content</span> <span class="pre">Type</span></tt></p>
<p>The content types supported, and the content type of the information
being requested or submitted indicate that the content type is not
supported.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">416</span> <span class="pre">-</span> <span class="pre">Requested</span> <span class="pre">Range</span> <span class="pre">Not</span> <span class="pre">Satisfiable</span></tt></p>
<p>The range specified in the request header cannot be satisfied by the
server.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">417</span> <span class="pre">-</span> <span class="pre">Expectation</span> <span class="pre">Failed</span></tt></p>
<p>When sending documents in bulk, the bulk load operation failed.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">500</span> <span class="pre">-</span> <span class="pre">Internal</span> <span class="pre">Server</span> <span class="pre">Error</span></tt></p>
<p>The request was invalid, either because the supplied JSON was
invalid, or invalid information was supplied as part of the request.</p>
</li>
</ul>
</div>
</div>
<span id="document-api/server/index"></span><div class="section" id="server">
<span id="api-server"></span><h3>Server<a class="headerlink" href="#server" title="Permalink to this headline">¶</a></h3>
<p>The CouchDB server interface provides the basic interface to a
CouchDB server for obtaining CouchDB information and getting and setting
configuration information.</p>
<div class="toctree-wrapper compound">
<span id="document-api/server/common"></span><div class="section" id="api-server-root">
<span id="id1"></span><h4><tt class="docutils literal"><span class="pre">/</span></tt><a class="headerlink" href="#api-server-root" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--">
<tt class="descname">GET </tt><tt class="descname">/</tt><a class="headerlink" href="#get--" title="Permalink to this definition">¶</a></dt>
<dd><p>Accessing the root of a CouchDB instance returns meta information about
the instance. The response is a JSON structure containing information
about the server, including a welcome message and the version of the
server.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">179</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 06:33:33 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;couchdb&quot;</span><span class="p">:</span> <span class="s2">&quot;Welcome&quot;</span><span class="p">,</span>
    <span class="nt">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;85fb71bf700c17267fef77535820e371&quot;</span><span class="p">,</span>
    <span class="nt">&quot;vendor&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;The Apache Software Foundation&quot;</span><span class="p">,</span>
        <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.3.1&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1.3.1&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="active-tasks">
<span id="api-server-active-tasks"></span><h4><tt class="docutils literal"><span class="pre">/_active_tasks</span></tt><a class="headerlink" href="#active-tasks" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--_active_tasks">
<tt class="descname">GET </tt><tt class="descname">/_active_tasks</tt><a class="headerlink" href="#get--_active_tasks" title="Permalink to this definition">¶</a></dt>
<dd><p>List of running tasks, including the task type, name, status
and process ID. The result is a JSON array of the currently running tasks,
with each task being described with a single object. Depending on operation
type set of response object fields might be different.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>changes_done</strong> (<em>number</em>) &#8211; Processed changes</li>
<li><strong>database</strong> (<em>string</em>) &#8211; Source database</li>
<li><strong>pid</strong> (<em>string</em>) &#8211; Process ID</li>
<li><strong>progress</strong> (<em>number</em>) &#8211; Current percentage progress</li>
<li><strong>started_on</strong> (<em>number</em>) &#8211; Task start time as unix timestamp</li>
<li><strong>status</strong> (<em>string</em>) &#8211; Task status message</li>
<li><strong>task</strong> (<em>string</em>) &#8211; Task name</li>
<li><strong>total_changes</strong> (<em>number</em>) &#8211; Total changes to process</li>
<li><strong>type</strong> (<em>string</em>) &#8211; Operation Type</li>
<li><strong>updated_on</strong> (<em>number</em>) &#8211; Unix timestamp of last operation update</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_active_tasks</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">1690</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 06:37:31 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;changes_done&quot;</span><span class="p">:</span> <span class="mi">64438</span><span class="p">,</span>
        <span class="nt">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;mailbox&quot;</span><span class="p">,</span>
        <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;0.12986.1&gt;&quot;</span><span class="p">,</span>
        <span class="nt">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">84</span><span class="p">,</span>
        <span class="nt">&quot;started_on&quot;</span><span class="p">:</span> <span class="mi">1376116576</span><span class="p">,</span>
        <span class="nt">&quot;total_changes&quot;</span><span class="p">:</span> <span class="mi">76215</span><span class="p">,</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;database_compaction&quot;</span><span class="p">,</span>
        <span class="nt">&quot;updated_on&quot;</span><span class="p">:</span> <span class="mi">1376116619</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;changes_done&quot;</span><span class="p">:</span> <span class="mi">14443</span><span class="p">,</span>
        <span class="nt">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;mailbox&quot;</span><span class="p">,</span>
        <span class="nt">&quot;design_document&quot;</span><span class="p">:</span> <span class="s2">&quot;c9753817b3ba7c674d92361f24f59b9f&quot;</span><span class="p">,</span>
        <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;0.10461.3&gt;&quot;</span><span class="p">,</span>
        <span class="nt">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="nt">&quot;started_on&quot;</span><span class="p">:</span> <span class="mi">1376116621</span><span class="p">,</span>
        <span class="nt">&quot;total_changes&quot;</span><span class="p">:</span> <span class="mi">76215</span><span class="p">,</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;indexer&quot;</span><span class="p">,</span>
        <span class="nt">&quot;updated_on&quot;</span><span class="p">:</span> <span class="mi">1376116650</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;changes_done&quot;</span><span class="p">:</span> <span class="mi">5454</span><span class="p">,</span>
        <span class="nt">&quot;database&quot;</span><span class="p">:</span> <span class="s2">&quot;mailbox&quot;</span><span class="p">,</span>
        <span class="nt">&quot;design_document&quot;</span><span class="p">:</span> <span class="s2">&quot;_design/meta&quot;</span><span class="p">,</span>
        <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;0.6838.4&gt;&quot;</span><span class="p">,</span>
        <span class="nt">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
        <span class="nt">&quot;started_on&quot;</span><span class="p">:</span> <span class="mi">1376116632</span><span class="p">,</span>
        <span class="nt">&quot;total_changes&quot;</span><span class="p">:</span> <span class="mi">76215</span><span class="p">,</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;indexer&quot;</span><span class="p">,</span>
        <span class="nt">&quot;updated_on&quot;</span><span class="p">:</span> <span class="mi">1376116651</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;checkpointed_source_seq&quot;</span><span class="p">:</span> <span class="mi">68585</span><span class="p">,</span>
        <span class="nt">&quot;continuous&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;doc_id&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nt">&quot;doc_write_failures&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nt">&quot;docs_read&quot;</span><span class="p">:</span> <span class="mi">4524</span><span class="p">,</span>
        <span class="nt">&quot;docs_written&quot;</span><span class="p">:</span> <span class="mi">4524</span><span class="p">,</span>
        <span class="nt">&quot;missing_revisions_found&quot;</span><span class="p">:</span> <span class="mi">4524</span><span class="p">,</span>
        <span class="nt">&quot;pid&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt;0.1538.5&gt;&quot;</span><span class="p">,</span>
        <span class="nt">&quot;progress&quot;</span><span class="p">:</span> <span class="mi">44</span><span class="p">,</span>
        <span class="nt">&quot;replication_id&quot;</span><span class="p">:</span> <span class="s2">&quot;9bc1727d74d49d9e157e260bb8bbd1d5&quot;</span><span class="p">,</span>
        <span class="nt">&quot;revisions_checked&quot;</span><span class="p">:</span> <span class="mi">4524</span><span class="p">,</span>
        <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;mailbox&quot;</span><span class="p">,</span>
        <span class="nt">&quot;source_seq&quot;</span><span class="p">:</span> <span class="mi">154419</span><span class="p">,</span>
        <span class="nt">&quot;started_on&quot;</span><span class="p">:</span> <span class="mi">1376116644</span><span class="p">,</span>
        <span class="nt">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;http://mailsrv:5984/mailbox&quot;</span><span class="p">,</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;replication&quot;</span><span class="p">,</span>
        <span class="nt">&quot;updated_on&quot;</span><span class="p">:</span> <span class="mi">1376116651</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="all-dbs">
<span id="api-server-all-dbs"></span><h4><tt class="docutils literal"><span class="pre">/_all_dbs</span></tt><a class="headerlink" href="#all-dbs" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--_all_dbs">
<tt class="descname">GET </tt><tt class="descname">/_all_dbs</tt><a class="headerlink" href="#get--_all_dbs" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a list of all the databases in the CouchDB instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_all_dbs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">52</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 06:57:48 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">[</span>
   <span class="s2">&quot;_users&quot;</span><span class="p">,</span>
   <span class="s2">&quot;contacts&quot;</span><span class="p">,</span>
   <span class="s2">&quot;docs&quot;</span><span class="p">,</span>
   <span class="s2">&quot;invoices&quot;</span><span class="p">,</span>
   <span class="s2">&quot;locations&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-updates">
<span id="api-server-db-updates"></span><h4><tt class="docutils literal"><span class="pre">/_db_updates</span></tt><a class="headerlink" href="#db-updates" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<dl class="get">
<dt id="get--_db_updates">
<tt class="descname">GET </tt><tt class="descname">/_db_updates</tt><a class="headerlink" href="#get--_db_updates" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a list of all database events in the CouchDB instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>feed</strong> (<em>string</em>) &#8211; <ul>
<li><strong>longpoll</strong>: Closes the connection after the first event.</li>
<li><strong>continuous</strong>: Send a line of JSON per event. Keeps the socket open
until <tt class="docutils literal"><span class="pre">timeout</span></tt>.</li>
<li><strong>eventsource</strong>: Like, <tt class="docutils literal"><span class="pre">continuous</span></tt>, but sends the events in
<a class="reference external" href="http://dev.w3.org/html5/eventsource/">EventSource</a> format.</li>
</ul>
</li>
<li><strong>timeout</strong> (<em>number</em>) &#8211; Number of seconds until CouchDB closes the connection.
Default is <tt class="docutils literal"><span class="pre">60</span></tt>.</li>
<li><strong>heartbeat</strong> (<em>boolean</em>) &#8211; Whether CouchDB will send a newline character
(<tt class="docutils literal"><span class="pre">\n</span></tt>) on <tt class="docutils literal"><span class="pre">timeout</span></tt>. Default is <tt class="docutils literal"><span class="pre">true</span></tt>.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.41">Transfer-Encoding</a> &#8211; <tt class="docutils literal"><span class="pre">chunked</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>db_name</strong> (<em>string</em>) &#8211; Database name</li>
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Event operation status</li>
<li><strong>type</strong> (<em>string</em>) &#8211; A database event is one of <tt class="docutils literal"><span class="pre">created</span></tt>, <tt class="docutils literal"><span class="pre">updated</span></tt>,
<tt class="docutils literal"><span class="pre">deleted</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_db_updates</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 07:02:41 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;db_name&quot;</span><span class="p">:</span> <span class="s2">&quot;mailbox&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;created&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="log">
<span id="api-server-log"></span><h4><tt class="docutils literal"><span class="pre">/_log</span></tt><a class="headerlink" href="#log" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--_log">
<tt class="descname">GET </tt><tt class="descname">/_log</tt><a class="headerlink" href="#get--_log" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets the CouchDB log, equivalent to accessing the local log file of the
corresponding CouchDB instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>bytes</strong> (<em>number</em>) &#8211; Bytes to be returned. Default is <tt class="docutils literal"><span class="pre">1000</span></tt>.</li>
<li><strong>offset</strong> (<em>number</em>) &#8211; Offset in bytes where the log tail should be started.
Default is <tt class="docutils literal"><span class="pre">0</span></tt>.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">text/plain; charset=utf-8</em></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.41">Transfer-Encoding</a> &#8211; <tt class="docutils literal"><span class="pre">chunked</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_log</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-text"><div class="highlight"><pre>[Wed, 27 Oct 2010 10:49:42 GMT] [info] [&lt;0.23338.2&gt;] 192.168.0.2 - - &#39;PUT&#39; /authdb 401
[Wed, 27 Oct 2010 11:02:19 GMT] [info] [&lt;0.23428.2&gt;] 192.168.0.116 - - &#39;GET&#39; /recipes/FishStew 200
[Wed, 27 Oct 2010 11:02:19 GMT] [info] [&lt;0.23428.2&gt;] 192.168.0.116 - - &#39;GET&#39; /_session 200
[Wed, 27 Oct 2010 11:02:19 GMT] [info] [&lt;0.24199.2&gt;] 192.168.0.116 - - &#39;GET&#39; / 200
[Wed, 27 Oct 2010 13:03:38 GMT] [info] [&lt;0.24207.2&gt;] 192.168.0.116 - - &#39;GET&#39; /_log?offset=5 200
</pre></div>
</div>
</dd></dl>

<p>If you want to pick out specific parts of the log information you can
use the <tt class="docutils literal"><span class="pre">bytes</span></tt> argument, which specifies the number of bytes to be
returned, and <tt class="docutils literal"><span class="pre">offset</span></tt>, which specifies where the reading of the log
should start, counted back from the end. For example, if you use the
following request:</p>
<div class="highlight-http"><div class="highlight"><pre>GET /_log?bytes=500&amp;offset=2000
</pre></div>
</div>
<p>Reading of the log will start at 2000 bytes from the end of the log, and
500 bytes will be shown.</p>
<p><strong>How bytes/offset works?</strong></p>
<p>CouchDB reads specified amount of <tt class="docutils literal"><span class="pre">bytes</span></tt> from the end of log file,
jumping to <tt class="docutils literal"><span class="pre">offset</span></tt> bytes towards the beginning of the file first:</p>
<div class="highlight-text"><div class="highlight"><pre> Log File    FilePos
 ----------
|          |  10
|          |  20
|          |  30
|          |  40
|          |  50
|          |  60
|          |  70 -- Bytes = 20  --
|          |  80                 | Chunk
|          |  90 -- Offset = 10 --
|__________| 100
</pre></div>
</div>
</div>
<div class="section" id="replicate">
<span id="api-server-replicate"></span><h4><tt class="docutils literal"><span class="pre">/_replicate</span></tt><a class="headerlink" href="#replicate" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--_replicate">
<tt class="descname">POST </tt><tt class="descname">/_replicate</tt><a class="headerlink" href="#post--_replicate" title="Permalink to this definition">¶</a></dt>
<dd><p>Request, configure, or stop, a replication operation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>cancel</strong> (<em>boolean</em>) &#8211; Cancels the replication</li>
<li><strong>continuous</strong> (<em>boolean</em>) &#8211; Configure the replication to be continuous</li>
<li><strong>create_target</strong> (<em>boolean</em>) &#8211; Creates the target database.
Required administrator&#8217;s privileges on target server.</li>
<li><strong>doc_ids</strong> (<em>array</em>) &#8211; Array of document IDs to be synchronized</li>
<li><strong>proxy</strong> (<em>string</em>) &#8211; Address of a proxy server through which replication
should occur (protocol can be &#8220;http&#8221; or &#8220;socks5&#8221;)</li>
<li><strong>source</strong> (<em>string</em>) &#8211; Source database name or URL</li>
<li><strong>target</strong> (<em>string</em>) &#8211; Target database name or URL</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>history</strong> (<em>array</em>) &#8211; Replication history (see below)</li>
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Replication status</li>
<li><strong>replication_id_version</strong> (<em>number</em>) &#8211; Replication protocol version</li>
<li><strong>session_id</strong> (<em>string</em>) &#8211; Unique session ID</li>
<li><strong>source_last_seq</strong> (<em>number</em>) &#8211; Last sequence number read from source database</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Replication request successfully completed</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Continuous replication request has been accepted</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid JSON data</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Either the source or target DB is not found or attempt to
cancel unknown replication task</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> &#8211; JSON specification was invalid</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The specification of the replication request is controlled through the
JSON content of the request. The JSON should be an object with the
fields defining the source, target and other options.</p>
<p>The <cite>Replication history</cite> is an array of objects with following structure:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">JSON Object:</th><td class="field-body"><ul class="first last simple">
<li><strong>doc_write_failures</strong> (<em>number</em>) &#8211; Number of document write failures</li>
<li><strong>docs_read</strong> (<em>number</em>) &#8211; Number of documents read</li>
<li><strong>docs_written</strong> (<em>number</em>) &#8211; Number of documents written to target</li>
<li><strong>end_last_seq</strong> (<em>number</em>) &#8211; Last sequence number in changes stream</li>
<li><strong>end_time</strong> (<em>string</em>) &#8211; Date/Time replication operation completed in
<span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a> format</li>
<li><strong>missing_checked</strong> (<em>number</em>) &#8211; Number of missing documents checked</li>
<li><strong>missing_found</strong> (<em>number</em>) &#8211; Number of missing documents found</li>
<li><strong>recorded_seq</strong> (<em>number</em>) &#8211; Last recorded sequence number</li>
<li><strong>session_id</strong> (<em>string</em>) &#8211; Session ID for this replication operation</li>
<li><strong>start_last_seq</strong> (<em>number</em>) &#8211; First sequence number in changes stream</li>
<li><strong>start_time</strong> (<em>string</em>) &#8211; Date/Time replication operation started in
<span class="target" id="index-1"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2822.html"><strong>RFC 2822</strong></a> format</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong></p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/_replicate</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">36</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;db_a&quot;</span><span class="p">,</span>
    <span class="nt">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;db_b&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong></p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">692</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sun, 11 Aug 2013 20:38:50 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;history&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;doc_write_failures&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;docs_read&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nt">&quot;docs_written&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nt">&quot;end_last_seq&quot;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
            <span class="nt">&quot;end_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Sun, 11 Aug 2013 20:38:50 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;missing_checked&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nt">&quot;missing_found&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nt">&quot;recorded_seq&quot;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
            <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;142a35854a08e205c47174d91b1f9628&quot;</span><span class="p">,</span>
            <span class="nt">&quot;start_last_seq&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Sun, 11 Aug 2013 20:38:50 GMT&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;doc_write_failures&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;docs_read&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;docs_written&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;end_last_seq&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;end_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Sat, 10 Aug 2013 15:41:54 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;missing_checked&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;missing_found&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;recorded_seq&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;6314f35c51de3ac408af79d6ee0c1a09&quot;</span><span class="p">,</span>
            <span class="nt">&quot;start_last_seq&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;Sat, 10 Aug 2013 15:41:54 GMT&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;replication_id_version&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;session_id&quot;</span><span class="p">:</span> <span class="s2">&quot;142a35854a08e205c47174d91b1f9628&quot;</span><span class="p">,</span>
    <span class="nt">&quot;source_last_seq&quot;</span><span class="p">:</span> <span class="mi">28</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="replication-operation">
<h5>Replication Operation<a class="headerlink" href="#replication-operation" title="Permalink to this headline">¶</a></h5>
<p>The aim of the replication is that at the end of the process, all active
documents on the source database are also in the destination database
and all documents that were deleted in the source databases are also
deleted (if they exist) on the destination database.</p>
<p>Replication can be described as either push or pull replication:</p>
<ul>
<li><p class="first"><em>Pull replication</em> is where the <tt class="docutils literal"><span class="pre">source</span></tt> is the remote CouchDB
instance, and the <tt class="docutils literal"><span class="pre">target</span></tt> is the local database.</p>
<p>Pull replication is the most useful solution to use if your source
database has a permanent IP address, and your destination (local)
database may have a dynamically assigned IP address (for example,
through DHCP). This is particularly important if you are replicating
to a mobile or other device from a central server.</p>
</li>
<li><p class="first"><em>Push replication</em> is where the <tt class="docutils literal"><span class="pre">source</span></tt> is a local database, and
<tt class="docutils literal"><span class="pre">target</span></tt> is a remote database.</p>
</li>
</ul>
</div>
<div class="section" id="specifying-the-source-and-target-database">
<h5>Specifying the Source and Target Database<a class="headerlink" href="#specifying-the-source-and-target-database" title="Permalink to this headline">¶</a></h5>
<p>You must use the URL specification of the CouchDB database if you want
to perform replication in either of the following two situations:</p>
<ul class="simple">
<li>Replication with a remote database (i.e. another instance of CouchDB
on the same host, or a different host)</li>
<li>Replication with a database that requires authentication</li>
</ul>
<p>For example, to request replication between a database local to the
CouchDB instance to which you send the request, and a remote database
you might use the following request:</p>
<div class="highlight-http"><div class="highlight"><pre>POST http://couchdb:5984/_replicate
Content-Type: application/json
Accept: application/json

{
   &quot;source&quot; : &quot;recipes&quot;,
   &quot;target&quot; : &quot;http://coucdb-remote:5984/recipes&quot;,
}
</pre></div>
</div>
<p>In all cases, the requested databases in the <tt class="docutils literal"><span class="pre">source</span></tt> and <tt class="docutils literal"><span class="pre">target</span></tt>
specification must exist. If they do not, an error will be returned
within the JSON object:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
   <span class="s2">&quot;error&quot;</span> <span class="o">:</span> <span class="s2">&quot;db_not_found&quot;</span>
   <span class="s2">&quot;reason&quot;</span> <span class="o">:</span> <span class="s2">&quot;could not open http://couchdb-remote:5984/ol1ka/&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can create the target database (providing your user credentials
allow it) by adding the <tt class="docutils literal"><span class="pre">create_target</span></tt> field to the request object:</p>
<div class="highlight-http"><div class="highlight"><pre>POST http://couchdb:5984/_replicate
Content-Type: application/json
Accept: application/json

{
   &quot;create_target&quot; : true
   &quot;source&quot; : &quot;recipes&quot;,
   &quot;target&quot; : &quot;http://couchdb-remote:5984/recipes&quot;,
}
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">create_target</span></tt> field is not destructive. If the database already
exists, the replication proceeds as normal.</p>
</div>
<div class="section" id="single-replication">
<h5>Single Replication<a class="headerlink" href="#single-replication" title="Permalink to this headline">¶</a></h5>
<p>You can request replication of a database so that the two databases can
be synchronized. By default, the replication process occurs one time and
synchronizes the two databases together. For example, you can request a
single synchronization between two databases by supplying the <tt class="docutils literal"><span class="pre">source</span></tt>
and <tt class="docutils literal"><span class="pre">target</span></tt> fields within the request JSON content.</p>
<div class="highlight-http"><div class="highlight"><pre>POST http://couchdb:5984/_replicate
Accept: application/json
Content-Type: application/json

{
   &quot;source&quot; : &quot;recipes&quot;,
   &quot;target&quot; : &quot;recipes-snapshot&quot;,
}
</pre></div>
</div>
<p>In the above example, the databases <tt class="docutils literal"><span class="pre">recipes</span></tt> and <tt class="docutils literal"><span class="pre">recipes-snapshot</span></tt>
will be synchronized. These databases are local to the CouchDB instance
where the request was made. The response will be a JSON structure
containing the success (or failure) of the synchronization process, and
statistics about the process:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
   <span class="s2">&quot;ok&quot;</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
   <span class="s2">&quot;history&quot;</span> <span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
         <span class="s2">&quot;docs_read&quot;</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">,</span>
         <span class="s2">&quot;session_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;52c2370f5027043d286daca4de247db0&quot;</span><span class="p">,</span>
         <span class="s2">&quot;recorded_seq&quot;</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">,</span>
         <span class="s2">&quot;end_last_seq&quot;</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">,</span>
         <span class="s2">&quot;doc_write_failures&quot;</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
         <span class="s2">&quot;start_time&quot;</span> <span class="o">:</span> <span class="s2">&quot;Thu, 28 Oct 2010 10:24:13 GMT&quot;</span><span class="p">,</span>
         <span class="s2">&quot;start_last_seq&quot;</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
         <span class="s2">&quot;end_time&quot;</span> <span class="o">:</span> <span class="s2">&quot;Thu, 28 Oct 2010 10:24:14 GMT&quot;</span><span class="p">,</span>
         <span class="s2">&quot;missing_checked&quot;</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
         <span class="s2">&quot;docs_written&quot;</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">,</span>
         <span class="s2">&quot;missing_found&quot;</span> <span class="o">:</span> <span class="mi">1000</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="s2">&quot;session_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;52c2370f5027043d286daca4de247db0&quot;</span><span class="p">,</span>
   <span class="s2">&quot;source_last_seq&quot;</span> <span class="o">:</span> <span class="mi">1000</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="continuous-replication">
<h5>Continuous Replication<a class="headerlink" href="#continuous-replication" title="Permalink to this headline">¶</a></h5>
<p>Synchronization of a database with the previously noted methods happens
only once, at the time the replicate request is made. To have the target
database permanently replicated from the source, you must set the
<tt class="docutils literal"><span class="pre">continuous</span></tt> field of the JSON object within the request to true.</p>
<p>With continuous replication changes in the source database are
replicated to the target database in perpetuity until you specifically
request that replication ceases.</p>
<div class="highlight-http"><div class="highlight"><pre>POST http://couchdb:5984/_replicate
Accept: application/json
Content-Type: application/json

{
   &quot;continuous&quot; : true
   &quot;source&quot; : &quot;recipes&quot;,
   &quot;target&quot; : &quot;http://couchdb-remote:5984/recipes&quot;,
}
</pre></div>
</div>
<p>Changes will be replicated between the two databases as long as a
network connection is available between the two instances.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Two keep two databases synchronized with each other, you need to set
replication in both directions; that is, you must replicate from
<tt class="docutils literal"><span class="pre">source</span></tt> to <tt class="docutils literal"><span class="pre">target</span></tt>, and separately from <tt class="docutils literal"><span class="pre">target</span></tt> to
<tt class="docutils literal"><span class="pre">source</span></tt>.</p>
</div>
</div>
<div class="section" id="canceling-continuous-replication">
<h5>Canceling Continuous Replication<a class="headerlink" href="#canceling-continuous-replication" title="Permalink to this headline">¶</a></h5>
<p>You can cancel continuous replication by adding the <tt class="docutils literal"><span class="pre">cancel</span></tt> field to
the JSON request object and setting the value to true. Note that the
structure of the request must be identical to the original for the
cancellation request to be honoured. For example, if you requested
continuous replication, the cancellation request must also contain the
<tt class="docutils literal"><span class="pre">continuous</span></tt> field.</p>
<p>For example, the replication request:</p>
<div class="highlight-http"><div class="highlight"><pre>POST http://couchdb:5984/_replicate
Content-Type: application/json
Accept: application/json

{
   &quot;source&quot; : &quot;recipes&quot;,
   &quot;target&quot; : &quot;http://couchdb-remote:5984/recipes&quot;,
   &quot;create_target&quot; : true,
   &quot;continuous&quot; : true
}
</pre></div>
</div>
<p>Must be canceled using the request:</p>
<div class="highlight-http"><div class="highlight"><pre>POST http://couchdb:5984/_replicate
Accept: application/json
Content-Type: application/json

{
    &quot;cancel&quot; : true,
    &quot;continuous&quot; : true
    &quot;create_target&quot; : true,
    &quot;source&quot; : &quot;recipes&quot;,
    &quot;target&quot; : &quot;http://couchdb-remote:5984/recipes&quot;,
}
</pre></div>
</div>
<p>Requesting cancellation of a replication that does not exist results in
a 404 error.</p>
</div>
</div>
<div class="section" id="restart">
<span id="api-server-restart"></span><h4><tt class="docutils literal"><span class="pre">/_restart</span></tt><a class="headerlink" href="#restart" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--_restart">
<tt class="descname">POST </tt><tt class="descname">/_restart</tt><a class="headerlink" href="#post--_restart" title="Permalink to this definition">¶</a></dt>
<dd><p>Restarts the CouchDB instance. You must be authenticated as a user with
administration privileges for this to work.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Server goes to restart (there is no guarantee that it will be
alive after)</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.16">415 Unsupported Media Type</a> &#8211; Bad request`s <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a></li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/_restart</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">202</span> <span class="ne">Accepted</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">12</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 11:33:50 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="stats">
<span id="api-server-stats"></span><h4><tt class="docutils literal"><span class="pre">/_stats</span></tt><a class="headerlink" href="#stats" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--_stats">
<tt class="descname">GET </tt><tt class="descname">/_stats</tt><a class="headerlink" href="#get--_stats" title="Permalink to this definition">¶</a></dt>
<dd><p>The <tt class="docutils literal"><span class="pre">_stats</span></tt> resource returns a JSON object containing the statistics
for the running server. The object is structured with top-level sections
collating the statistics for a range of entries, with each individual
statistic being easily identified, and the content of each statistic is
self-describing</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_stats/couchdb/request_time</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">187</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 11:41:11 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;couchdb&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;request_time&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;current&quot;</span><span class="p">:</span> <span class="mf">21.0</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;length of a request inside CouchDB without MochiWeb&quot;</span><span class="p">,</span>
            <span class="nt">&quot;max&quot;</span><span class="p">:</span> <span class="mf">19.0</span><span class="p">,</span>
            <span class="nt">&quot;mean&quot;</span><span class="p">:</span> <span class="mf">7.0</span><span class="p">,</span>
            <span class="nt">&quot;min&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="nt">&quot;stddev&quot;</span><span class="p">:</span> <span class="mf">10.392</span><span class="p">,</span>
            <span class="nt">&quot;sum&quot;</span><span class="p">:</span> <span class="mf">21.0</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<p>The fields provide the current, minimum and maximum, and a collection of
statistical means and quantities. The quantity in each case is not
defined, but the descriptions below provide</p>
<p>The statistics are divided into the following top-level sections:</p>
<div class="section" id="couchdb">
<h5><tt class="docutils literal"><span class="pre">couchdb</span></tt><a class="headerlink" href="#couchdb" title="Permalink to this headline">¶</a></h5>
<p>Describes statistics specific to the internals of CouchDB</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="57%" />
<col width="17%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Statistic ID</th>
<th class="head">Description</th>
<th class="head">Unit</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">auth_cache_hits</span></tt></td>
<td>Number of authentication cache hits</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">auth_cache_misses</span></tt></td>
<td>Number of authentication cache misses</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">database_reads</span></tt></td>
<td>Number of times a document was read from a database</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">database_writes</span></tt></td>
<td>Number of times a database was changed</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">open_databases</span></tt></td>
<td>Number of open databases</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">open_os_files</span></tt></td>
<td>Number of file descriptors CouchDB has open</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">request_time</span></tt></td>
<td>Length of a request inside CouchDB without MochiWeb</td>
<td>milliseconds</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="httpd-request-methods">
<h5><tt class="docutils literal"><span class="pre">httpd_request_methods</span></tt><a class="headerlink" href="#httpd-request-methods" title="Permalink to this headline">¶</a></h5>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="57%" />
<col width="17%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Statistic ID</th>
<th class="head">Description</th>
<th class="head">Unit</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">COPY</span></tt></td>
<td>Number of HTTP COPY requests</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">DELETE</span></tt></td>
<td>Number of HTTP DELETE requests</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">GET</span></tt></td>
<td>Number of HTTP GET requests</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">HEAD</span></tt></td>
<td>Number of HTTP HEAD requests</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">POST</span></tt></td>
<td>Number of HTTP POST requests</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">PUT</span></tt></td>
<td>Number of HTTP PUT requests</td>
<td>number</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="httpd-status-codes">
<h5><tt class="docutils literal"><span class="pre">httpd_status_codes</span></tt><a class="headerlink" href="#httpd-status-codes" title="Permalink to this headline">¶</a></h5>
<table border="1" class="docutils">
<colgroup>
<col width="20%" />
<col width="68%" />
<col width="13%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Statistic ID</th>
<th class="head">Description</th>
<th class="head">Unit</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">200</span></tt></td>
<td>Number of HTTP 200 OK responses</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">201</span></tt></td>
<td>Number of HTTP 201 Created responses</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">202</span></tt></td>
<td>Number of HTTP 202 Accepted responses</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">301</span></tt></td>
<td>Number of HTTP 301 Moved Permanently responses</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">304</span></tt></td>
<td>Number of HTTP 304 Not Modified responses</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">400</span></tt></td>
<td>Number of HTTP 400 Bad Request responses</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">401</span></tt></td>
<td>Number of HTTP 401 Unauthorized responses</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">403</span></tt></td>
<td>Number of HTTP 403 Forbidden responses</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">404</span></tt></td>
<td>Number of HTTP 404 Not Found responses</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">405</span></tt></td>
<td>Number of HTTP 405 Method Not Allowed responses</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">409</span></tt></td>
<td>Number of HTTP 409 Conflict responses</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">412</span></tt></td>
<td>Number of HTTP 412 Precondition Failed responses</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">500</span></tt></td>
<td>Number of HTTP 500 Internal Server Error responses</td>
<td>number</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="httpd">
<h5><tt class="docutils literal"><span class="pre">httpd</span></tt><a class="headerlink" href="#httpd" title="Permalink to this headline">¶</a></h5>
<table border="1" class="docutils">
<colgroup>
<col width="38%" />
<col width="51%" />
<col width="11%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Statistic ID</th>
<th class="head">Description</th>
<th class="head">Unit</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">bulk_requests</span></tt></td>
<td>Number of bulk requests</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">clients_requesting_changes</span></tt></td>
<td>Number of clients for continuous _changes</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">requests</span></tt></td>
<td>Number of HTTP requests</td>
<td>number</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">temporary_view_reads</span></tt></td>
<td>Number of temporary view reads</td>
<td>number</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">view_reads</span></tt></td>
<td>Number of view reads</td>
<td>number</td>
</tr>
</tbody>
</table>
<p>You can also access individual statistics by quoting the statistics
sections and statistic ID as part of the URL path. For example, to get
the <tt class="docutils literal"><span class="pre">request_time</span></tt> statistics, you can use:</p>
<div class="highlight-http"><div class="highlight"><pre>GET /_stats/couchdb/request_time
</pre></div>
</div>
<p>This returns an entire statistics object, as with the full request, but
containing only the request individual statistic. Hence, the returned
structure is as follows:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
   <span class="s2">&quot;couchdb&quot;</span> <span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;request_time&quot;</span> <span class="o">:</span> <span class="p">{</span>
         <span class="s2">&quot;stddev&quot;</span> <span class="o">:</span> <span class="mf">7454.305</span><span class="p">,</span>
         <span class="s2">&quot;min&quot;</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="s2">&quot;max&quot;</span> <span class="o">:</span> <span class="mi">34185</span><span class="p">,</span>
         <span class="s2">&quot;current&quot;</span> <span class="o">:</span> <span class="mf">34697.803</span><span class="p">,</span>
         <span class="s2">&quot;mean&quot;</span> <span class="o">:</span> <span class="mf">1652.276</span><span class="p">,</span>
         <span class="s2">&quot;sum&quot;</span> <span class="o">:</span> <span class="mf">34697.803</span><span class="p">,</span>
         <span class="s2">&quot;description&quot;</span> <span class="o">:</span> <span class="s2">&quot;length of a request inside CouchDB without MochiWeb&quot;</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="utils">
<span id="api-server-utils"></span><h4><tt class="docutils literal"><span class="pre">/_utils</span></tt><a class="headerlink" href="#utils" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--_utils">
<tt class="descname">GET </tt><tt class="descname">/_utils</tt><a class="headerlink" href="#get--_utils" title="Permalink to this definition">¶</a></dt>
<dd><p>Accesses the built-in Futon administration interface for CouchDB.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.3">Location</a> &#8211; New URI location</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.2">301 Moved Permanently</a> &#8211; Redirects to <a class="reference internal" href="contents.html#get--_utils-" title="GET /_utils/"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/_utils/</span></tt></a></li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="get">
<dt id="get--_utils-">
<tt class="descname">GET </tt><tt class="descname">/_utils/</tt><a class="headerlink" href="#get--_utils-" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">text/html</em></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.29">Last-Modified</a> &#8211; Static files modification timestamp</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="uuids">
<span id="api-server-uuids"></span><h4><tt class="docutils literal"><span class="pre">/_uuids</span></tt><a class="headerlink" href="#uuids" title="Permalink to this headline">¶</a></h4>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.5.1.</span></p>
</div>
<dl class="get">
<dt id="get--_uuids">
<tt class="descname">GET </tt><tt class="descname">/_uuids</tt><a class="headerlink" href="#get--_uuids" title="Permalink to this definition">¶</a></dt>
<dd><p>Requests one or more Universally Unique Identifiers (UUIDs) from the
CouchDB instance. The response is a JSON object providing a list of
UUIDs.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>count</strong> (<em>number</em>) &#8211; Number of UUIDs to return. Default is <tt class="docutils literal"><span class="pre">1</span></tt>.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Response hash</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.4">403 Forbidden</a> &#8211; Requested more UUIDs than is <a class="reference internal" href="contents.html#uuids/max_count" title="max_count"><tt class="xref config config-option docutils literal"><span class="pre">allowed</span></tt></a> to retrieve</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_uuids?count=10</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">362</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 11:46:25 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;DGRWWQFLUDWN5MRKSLKQ425XV&quot;</span>
<span class="na">Expires</span><span class="o">:</span> <span class="l">Fri, 01 Jan 1990 00:00:00 GMT</span>
<span class="na">Pragma</span><span class="o">:</span> <span class="l">no-cache</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;uuids&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;75480ca477454894678e22eec6002413&quot;</span><span class="p">,</span>
        <span class="s2">&quot;75480ca477454894678e22eec600250b&quot;</span><span class="p">,</span>
        <span class="s2">&quot;75480ca477454894678e22eec6002c41&quot;</span><span class="p">,</span>
        <span class="s2">&quot;75480ca477454894678e22eec6003b90&quot;</span><span class="p">,</span>
        <span class="s2">&quot;75480ca477454894678e22eec6003fca&quot;</span><span class="p">,</span>
        <span class="s2">&quot;75480ca477454894678e22eec6004bef&quot;</span><span class="p">,</span>
        <span class="s2">&quot;75480ca477454894678e22eec600528f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;75480ca477454894678e22eec6005e0b&quot;</span><span class="p">,</span>
        <span class="s2">&quot;75480ca477454894678e22eec6006158&quot;</span><span class="p">,</span>
        <span class="s2">&quot;75480ca477454894678e22eec6006161&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<p>The UUID type is determined by the <a class="reference internal" href="contents.html#uuids/algorithm" title="algorithm"><tt class="xref config config-option docutils literal"><span class="pre">UUID</span> <span class="pre">algorithm</span></tt></a> setting in the CouchDB configuration.</p>
<p>The UUID type may be changed at any time through the
<a class="reference internal" href="contents.html#api-config-section-key"><em>Configuration API</em></a>. For example, the UUID type
could be changed to <tt class="docutils literal"><span class="pre">random</span></tt> by sending this HTTP request:</p>
<div class="highlight-http"><div class="highlight"><pre>PUT http://couchdb:5984/_config/uuids/algorithm
Content-Type: application/json
Accept: */*

&quot;random&quot;
</pre></div>
</div>
<p>You can verify the change by obtaining a list of UUIDs:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
   <span class="s2">&quot;uuids&quot;</span> <span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;031aad7b469956cf2826fcb2a9260492&quot;</span><span class="p">,</span>
      <span class="s2">&quot;6ec875e15e6b385120938df18ee8e496&quot;</span><span class="p">,</span>
      <span class="s2">&quot;cff9e881516483911aa2f0e98949092d&quot;</span><span class="p">,</span>
      <span class="s2">&quot;b89d37509d39dd712546f9510d4a9271&quot;</span><span class="p">,</span>
      <span class="s2">&quot;2e0dbf7f6c4ad716f21938a016e4e59f&quot;</span>
   <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="favicon-ico">
<span id="api-server-favicon"></span><h4><tt class="docutils literal"><span class="pre">/favicon.ico</span></tt><a class="headerlink" href="#favicon-ico" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--favicon.ico">
<tt class="descname">GET </tt><tt class="descname">/favicon.ico</tt><a class="headerlink" href="#get--favicon.ico" title="Permalink to this definition">¶</a></dt>
<dd><p>Binary content for the <cite>favicon.ico</cite> site icon.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">image/x-icon</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; The requested content could not be found</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<span id="document-api/server/authn"></span><div class="section" id="authentication">
<span id="api-auth"></span><h4>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h4>
<p>Interfaces for obtaining session and authorization data.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We&#8217;re also strongly recommend you to
<a class="reference internal" href="contents.html#config-ssl"><em>setup SSL</em></a> to improve all authentication methods security.</p>
</div>
<div class="section" id="basic-authentication">
<span id="api-auth-basic"></span><h5>Basic Authentication<a class="headerlink" href="#basic-authentication" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="http://en.wikipedia.org/wiki/Basic_access_authentication">Basic authentication</a> (<span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2617.html"><strong>RFC 2617</strong></a>) is a quick and simple way to authenticate
with CouchDB. The main drawback is the need to send user credentials with each
request which may be insecure and could hurt operation performance (since
CouchDB must compute password hash with every request):</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Basic cm9vdDpyZWxheA==</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">177</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 03 Dec 2012 00:44:47 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
  <span class="nt">&quot;couchdb&quot;</span><span class="p">:</span><span class="s2">&quot;Welcome&quot;</span><span class="p">,</span>
  <span class="nt">&quot;uuid&quot;</span><span class="p">:</span><span class="s2">&quot;0a959b9b8227188afc2ac26ccdf345a6&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="s2">&quot;1.3.0&quot;</span><span class="p">,</span>
  <span class="nt">&quot;vendor&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="s2">&quot;1.3.0&quot;</span><span class="p">,</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;The Apache Software Foundation&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="cookie-authentication">
<span id="api-auth-cookie"></span><h5>Cookie Authentication<a class="headerlink" href="#cookie-authentication" title="Permalink to this headline">¶</a></h5>
<p>For cookie authentication (<span class="target" id="index-1"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2109.html"><strong>RFC 2109</strong></a>) CouchDB generates a token that the
client can use for the next few requests to CouchDB. Tokens are valid until
a timeout. When CouchDB sees a valid token in a subsequent request, it will
authenticate user by this token without requesting the password again. By
default, cookies are valid for 10 minutes, but it&#8217;s <a class="reference internal" href="contents.html#couch_httpd_auth/timeout" title="timeout"><tt class="xref config config-option docutils literal"><span class="pre">adjustable</span></tt></a>. Also it&#8217;s possible to make cookies
<a class="reference internal" href="contents.html#couch_httpd_auth/allow_persistent_cookies" title="allow_persistent_cookies"><tt class="xref config config-option docutils literal"><span class="pre">persistent</span></tt></a></p>
<p>To obtain the first token and thus authenticate a user for the first time, the
<cite>username</cite> and <cite>password</cite> must be sent to the <a class="reference internal" href="contents.html#api-auth-session"><em>_session API</em></a>.</p>
<div class="section" id="session">
<span id="api-auth-session"></span><h6><tt class="docutils literal"><span class="pre">/_session</span></tt><a class="headerlink" href="#session" title="Permalink to this headline">¶</a></h6>
<dl class="post">
<dt id="post--_session">
<tt class="descname">POST </tt><tt class="descname">/_session</tt><a class="headerlink" href="#post--_session" title="Permalink to this definition">¶</a></dt>
<dd><p>Initiates new session for specified user credentials by providing <cite>Cookie</cite>
value.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/x-www-form-urlencoded</em></li>
<li><em class="mimetype">application/json</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>next</strong> (<em>string</em>) &#8211; Enforces redirect after successful login to the specified
location. This location is relative from server root. <em>Optional</em>.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Form Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>name</strong> &#8211; User name</li>
<li><strong>password</strong> &#8211; Password</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://tools.ietf.org/html/rfc2109#section-4.2.2">Set-Cookie</a> &#8211; Authorization token</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
<li><strong>name</strong> (<em>string</em>) &#8211; Username</li>
<li><strong>roles</strong> (<em>array</em>) &#8211; List of user roles</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Successfully authenticated</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.3">302 Found</a> &#8211; Redirect after successful authentication</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Username or password wasn&#8217;t recognized</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/_session</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">24</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

name=root&amp;password=relax
</pre></div>
</div>
<p>It&#8217;s also possible to send data as JSON:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/_session</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">37</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;relax&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">43</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 03 Dec 2012 01:23:14 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Set-Cookie</span><span class="o">:</span> <span class="l">AuthSession=cm9vdDo1MEJCRkYwMjq0LO0ylOIwShrgt8y-UkhI-c6BGw; Version=1; Path=/; HttpOnly</span>

<span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;root&quot;</span><span class="p">,</span><span class="nt">&quot;roles&quot;</span><span class="p">:[</span><span class="s2">&quot;_admin&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<p>If <tt class="docutils literal"><span class="pre">next</span></tt> query parameter was provided the response will trigger redirection
to the specified location in case of successful authentication:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/_session?next=/blog/_design/sofa/_rewrite/recent-posts</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

name=root&amp;password=relax
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">302</span> <span class="ne">Moved Temporarily</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">43</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 03 Dec 2012 01:32:46 GMT</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/blog/_design/sofa/_rewrite/recent-posts</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Set-Cookie</span><span class="o">:</span> <span class="l">AuthSession=cm9vdDo1MEJDMDEzRTp7Vu5GKCkTxTVxwXbpXsBARQWnhQ; Version=1; Path=/; HttpOnly</span>

<span class="p">{</span><span class="nt">&quot;ok&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span><span class="nt">&quot;roles&quot;</span><span class="p">:[</span><span class="s2">&quot;_admin&quot;</span><span class="p">]}</span>
</pre></div>
</div>
</dd></dl>

<dl class="get">
<dt id="get--_session">
<tt class="descname">GET </tt><tt class="descname">/_session</tt><a class="headerlink" href="#get--_session" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns complete information about authenticated user.
This information contains <a class="reference internal" href="contents.html#userctx-object"><em>User Context Object</em></a>, authentication method and
available ones and authentication database.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>basic</strong> (<em>boolean</em>) &#8211; Accept <cite>Basic Auth</cite> by requesting this resource.
<em>Optional</em>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Successfully authenticated.</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Username or password wasn&#8217;t recognized.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_session</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">AuthSession=cm9vdDo1MEJDMDQxRDpqb-Ta9QfP9hpdPjHLxNTKg_Hf9w</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">175</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 09 Aug 2013 20:27:45 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Set-Cookie</span><span class="o">:</span> <span class="l">AuthSession=cm9vdDo1MjA1NTBDMTqmX2qKt1KDR--GUC80DQ6-Ew_XIw; Version=1; Path=/; HttpOnly</span>

<span class="p">{</span>
    <span class="nt">&quot;info&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;authenticated&quot;</span><span class="p">:</span> <span class="s2">&quot;cookie&quot;</span><span class="p">,</span>
        <span class="nt">&quot;authentication_db&quot;</span><span class="p">:</span> <span class="s2">&quot;_users&quot;</span><span class="p">,</span>
        <span class="nt">&quot;authentication_handlers&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;oauth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cookie&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;userCtx&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span><span class="p">,</span>
        <span class="nt">&quot;roles&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;_admin&quot;</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="delete">
<dt id="delete--_session">
<tt class="descname">DELETE </tt><tt class="descname">/_session</tt><a class="headerlink" href="#delete--_session" title="Permalink to this definition">¶</a></dt>
<dd><p>Closes user&#8217;s session.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Successfully close session.</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; User wasn&#8217;t authenticated.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">DELETE</span> <span class="nn">/_session</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">AuthSession=cm9vdDo1MjA1NEVGMDo1QXNQkqC_0Qmgrk8Fw61_AzDeXw</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">12</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 09 Aug 2013 20:30:12 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Set-Cookie</span><span class="o">:</span> <span class="l">AuthSession=; Version=1; Path=/; HttpOnly</span>

<span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
<div class="section" id="proxy-authentication">
<span id="api-auth-proxy"></span><h5>Proxy Authentication<a class="headerlink" href="#proxy-authentication" title="Permalink to this headline">¶</a></h5>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>To use this authentication method make sure that the
<tt class="docutils literal"><span class="pre">{couch_httpd_auth,</span> <span class="pre">proxy_authentication_handler}</span></tt> value in added to
the list of the active <a class="reference internal" href="contents.html#httpd/authentication_handlers" title="authentication_handlers"><tt class="xref config config-option docutils literal"><span class="pre">httpd/authentication_handlers</span></tt></a>:</p>
<div class="last highlight-ini"><div class="highlight"><pre><span class="k">[httpd]</span>
<span class="na">authentication_handlers</span> <span class="o">=</span> <span class="s">{couch_httpd_oauth, oauth_authentication_handler}, {couch_httpd_auth, cookie_authentication_handler}, {couch_httpd_auth, proxy_authentication_handler}, {couch_httpd_auth, default_authentication_handler}</span>
</pre></div>
</div>
</div>
<p><cite>Proxy authentication</cite> is very useful in case your application already uses
some external authentication service and you don&#8217;t want to duplicate users and
their roles in CouchDB.</p>
<p>This authentication method allows creation of a <a class="reference internal" href="contents.html#userctx-object"><em>User Context Object</em></a> for
remotely authenticated user. By default, the client just need to pass specific
headers to CouchDB with related request:</p>
<ul class="simple">
<li><a class="reference internal" href="contents.html#couch_httpd_auth/x_auth_username" title="x_auth_username"><tt class="xref config config-option docutils literal"><span class="pre">X-Auth-CouchDB-UserName</span></tt></a>:
username;</li>
<li><a class="reference internal" href="contents.html#couch_httpd_auth/x_auth_roles" title="x_auth_roles"><tt class="xref config config-option docutils literal"><span class="pre">X-Auth-CouchDB-Roles</span></tt></a>:
list of user roles separated by a comma (<tt class="docutils literal"><span class="pre">,</span></tt>);</li>
<li><a class="reference internal" href="contents.html#couch_httpd_auth/x_auth_token" title="x_auth_token"><tt class="xref config config-option docutils literal"><span class="pre">X-Auth-CouchDB-Token</span></tt></a>:
authentication token. Optional, but strongly recommended to
<a class="reference internal" href="contents.html#couch_httpd_auth/proxy_use_secret" title="proxy_use_secret"><tt class="xref config config-option docutils literal"><span class="pre">force</span> <span class="pre">token</span> <span class="pre">be</span> <span class="pre">required</span></tt></a>
to prevent requests from untrusted sources.</li>
</ul>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_session</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json; charset=utf-8</span>
<span class="na">X-Auth-CouchDB-Roles</span><span class="o">:</span> <span class="l">users,blogger</span>
<span class="na">X-Auth-CouchDB-UserName</span><span class="o">:</span> <span class="l">foo</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">190</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Fri, 14 Jun 2013 10:16:03 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;info&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;authenticated&quot;</span><span class="p">:</span> <span class="s2">&quot;proxy&quot;</span><span class="p">,</span>
        <span class="nt">&quot;authentication_db&quot;</span><span class="p">:</span> <span class="s2">&quot;_users&quot;</span><span class="p">,</span>
        <span class="nt">&quot;authentication_handlers&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;oauth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cookie&quot;</span><span class="p">,</span>
            <span class="s2">&quot;proxy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;userCtx&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
        <span class="nt">&quot;roles&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;users&quot;</span><span class="p">,</span>
            <span class="s2">&quot;blogger&quot;</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that you don&#8217;t need to request <a class="reference internal" href="contents.html#api-auth-session"><em>session</em></a>
to be authenticated by this method if all required HTTP headers are provided.</p>
</div>
<div class="section" id="oauth-authentication">
<span id="api-auth-oauth"></span><h5>OAuth Authentication<a class="headerlink" href="#oauth-authentication" title="Permalink to this headline">¶</a></h5>
<p>CouchDB supports OAuth 1.0 authentication (<span class="target" id="index-2"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc5849.html"><strong>RFC 5849</strong></a>). OAuth provides a method
for clients to access server resources  without sharing real credentials
(username and password).</p>
<p>First, <a class="reference internal" href="contents.html#config-oauth"><em>configure oauth</em></a>, by setting consumer and token
with their secrets and binding token to real CouchDB username.</p>
<p>Probably, it&#8217;s not good idea to work with plain curl, let use some scripting
language like Python:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python2</span>
<span class="kn">from</span> <span class="nn">oauth</span> <span class="kn">import</span> <span class="n">oauth</span> <span class="c"># pip install oauth</span>
<span class="kn">import</span> <span class="nn">httplib</span>

<span class="n">URL</span> <span class="o">=</span> <span class="s">&#39;http://localhost:5984/_session&#39;</span>
<span class="n">CONSUMER_KEY</span> <span class="o">=</span> <span class="s">&#39;consumer1&#39;</span>
<span class="n">CONSUMER_SECRET</span> <span class="o">=</span> <span class="s">&#39;sekr1t&#39;</span>
<span class="n">TOKEN</span> <span class="o">=</span> <span class="s">&#39;token1&#39;</span>
<span class="n">SECRET</span> <span class="o">=</span> <span class="s">&#39;tokensekr1t&#39;</span>

<span class="n">consumer</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">OAuthConsumer</span><span class="p">(</span><span class="n">CONSUMER_KEY</span><span class="p">,</span> <span class="n">CONSUMER_SECRET</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">OAuthToken</span><span class="p">(</span><span class="n">TOKEN</span><span class="p">,</span> <span class="n">SECRET</span><span class="p">)</span>
<span class="n">req</span> <span class="o">=</span> <span class="n">oauth</span><span class="o">.</span><span class="n">OAuthRequest</span><span class="o">.</span><span class="n">from_consumer_and_token</span><span class="p">(</span>
    <span class="n">consumer</span><span class="p">,</span>
    <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
    <span class="n">http_method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">,</span>
    <span class="n">http_url</span><span class="o">=</span><span class="n">URL</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">{}</span>
<span class="p">)</span>
<span class="n">req</span><span class="o">.</span><span class="n">sign_request</span><span class="p">(</span><span class="n">oauth</span><span class="o">.</span><span class="n">OAuthSignatureMethod_HMAC_SHA1</span><span class="p">(),</span> <span class="n">consumer</span><span class="p">,</span><span class="n">token</span><span class="p">)</span>

<span class="n">headers</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>
<span class="n">headers</span><span class="p">[</span><span class="s">&#39;Accept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/json&#39;</span>

<span class="n">con</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">5984</span><span class="p">)</span>
<span class="n">con</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="n">URL</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
<span class="k">print</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
<p>or Ruby:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1">#!/usr/bin/env ruby</span>

<span class="nb">require</span> <span class="s1">&#39;oauth&#39;</span> <span class="c1"># gem install oauth</span>

<span class="no">URL</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:5984&#39;</span>
<span class="no">CONSUMER_KEY</span> <span class="o">=</span> <span class="s1">&#39;consumer1&#39;</span>
<span class="no">CONSUMER_SECRET</span> <span class="o">=</span> <span class="s1">&#39;sekr1t&#39;</span>
<span class="no">TOKEN</span> <span class="o">=</span> <span class="s1">&#39;token1&#39;</span>
<span class="no">SECRET</span> <span class="o">=</span> <span class="s1">&#39;tokensekr1t&#39;</span>

<span class="vi">@consumer</span> <span class="o">=</span> <span class="no">OAuth</span><span class="o">::</span><span class="no">Consumer</span><span class="o">.</span><span class="n">new</span> <span class="no">CONSUMER_KEY</span><span class="p">,</span>
                                <span class="no">CONSUMER_SECRET</span><span class="p">,</span>
                                <span class="p">{</span><span class="ss">:site</span> <span class="o">=&gt;</span> <span class="no">URL</span><span class="p">}</span>

<span class="vi">@access_token</span> <span class="o">=</span> <span class="no">OAuth</span><span class="o">::</span><span class="no">AccessToken</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@consumer</span><span class="p">,</span> <span class="no">TOKEN</span><span class="p">,</span> <span class="no">SECRET</span><span class="p">)</span>

<span class="nb">puts</span> <span class="vi">@access_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/_session&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">body</span>
</pre></div>
</div>
<p>Both snippets produces similar request and response pair:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_session</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">OAuth realm=&quot;&quot;, oauth_nonce=&quot;81430018&quot;, oauth_timestamp=&quot;1374561749&quot;, oauth_consumer_key=&quot;consumer1&quot;, oauth_signature_method=&quot;HMAC-SHA1&quot;, oauth_version=&quot;1.0&quot;, oauth_token=&quot;token1&quot;, oauth_signature=&quot;o4FqJ8%2B9IzUpXH%2Bk4rgnv7L6eTY%3D&quot;</span>
</pre></div>
</div>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span> <span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span> <span class="o">:</span> <span class="l">167</span>
<span class="na">Content-Type</span> <span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span> <span class="o">:</span> <span class="l">Tue, 23 Jul 2013 06:51:15 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>


<span class="p">{</span>
  <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&quot;info&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;authenticated&quot;</span><span class="p">:</span> <span class="s2">&quot;oauth&quot;</span><span class="p">,</span>
    <span class="nt">&quot;authentication_db&quot;</span><span class="p">:</span> <span class="s2">&quot;_users&quot;</span><span class="p">,</span>
    <span class="nt">&quot;authentication_handlers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;oauth&quot;</span><span class="p">,</span> <span class="s2">&quot;cookie&quot;</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="nt">&quot;userCtx&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;couchdb_username&quot;</span><span class="p">,</span>
    <span class="nt">&quot;roles&quot;</span><span class="p">:</span> <span class="p">[]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There we request the <a class="reference internal" href="contents.html#api-auth-session"><em>_session</em></a> resource to ensure
that authentication was successful and the target CouchDB username is correct.
Change the target URL to request required resource.</p>
</div>
</div>
<span id="document-api/server/configuration"></span><div class="section" id="configuration">
<span id="api-config"></span><h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<p>The CouchDB Server Configuration API provide an interface to query and update
the various configuration values within a running CouchDB instance.</p>
<div class="section" id="config">
<h5><tt class="docutils literal"><span class="pre">/_config</span></tt><a class="headerlink" href="#config" title="Permalink to this headline">¶</a></h5>
<dl class="get">
<dt id="get--_config">
<tt class="descname">GET </tt><tt class="descname">/_config</tt><a class="headerlink" href="#get--_config" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the entire CouchDB server configuration as a JSON structure. The
structure is organized by different configuration sections, with
individual values.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong></p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_config</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">4148</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 12:01:42 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
  <span class="nt">&quot;attachments&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;compressible_types&quot;</span><span class="p">:</span> <span class="s2">&quot;text/*, application/javascript, application/json,  application/xml&quot;</span><span class="p">,</span>
      <span class="nt">&quot;compression_level&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;couch_httpd_auth&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;auth_cache_size&quot;</span><span class="p">:</span> <span class="s2">&quot;50&quot;</span><span class="p">,</span>
      <span class="nt">&quot;authentication_db&quot;</span><span class="p">:</span> <span class="s2">&quot;_users&quot;</span><span class="p">,</span>
      <span class="nt">&quot;authentication_redirect&quot;</span><span class="p">:</span> <span class="s2">&quot;/_utils/session.html&quot;</span><span class="p">,</span>
      <span class="nt">&quot;require_valid_user&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
      <span class="nt">&quot;timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;600&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;couchdb&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;database_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/lib/couchdb&quot;</span><span class="p">,</span>
      <span class="nt">&quot;delayed_commits&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
      <span class="nt">&quot;max_attachment_chunk_size&quot;</span><span class="p">:</span> <span class="s2">&quot;4294967296&quot;</span><span class="p">,</span>
      <span class="nt">&quot;max_dbs_open&quot;</span><span class="p">:</span> <span class="s2">&quot;100&quot;</span><span class="p">,</span>
      <span class="nt">&quot;max_document_size&quot;</span><span class="p">:</span> <span class="s2">&quot;4294967296&quot;</span><span class="p">,</span>
      <span class="nt">&quot;os_process_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;5000&quot;</span><span class="p">,</span>
      <span class="nt">&quot;uri_file&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/lib/couchdb/couch.uri&quot;</span><span class="p">,</span>
      <span class="nt">&quot;util_driver_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;/usr/lib64/couchdb/erlang/lib/couch-1.5.0/priv/lib&quot;</span><span class="p">,</span>
      <span class="nt">&quot;view_index_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/lib/couchdb&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;daemons&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;auth_cache&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_auth_cache, start_link, []}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;db_update_notifier&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_db_update_notifier_sup, start_link, []}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;external_manager&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_external_manager, start_link, []}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;httpd&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd, start_link, []}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;query_servers&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_query_servers, start_link, []}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;stats_aggregator&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_stats_aggregator, start, []}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;stats_collector&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_stats_collector, start, []}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;uuids&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_uuids, start, []}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;view_manager&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_view, start_link, []}&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;httpd&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;allow_jsonp&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
      <span class="nt">&quot;authentication_handlers&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_oauth, oauth_authentication_handler}, {couch_httpd_auth, cookie_authentication_handler}, {couch_httpd_auth, default_authentication_handler}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;bind_address&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.0.2&quot;</span><span class="p">,</span>
      <span class="nt">&quot;default_handler&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_db, handle_request}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;max_connections&quot;</span><span class="p">:</span> <span class="s2">&quot;2048&quot;</span><span class="p">,</span>
      <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="s2">&quot;5984&quot;</span><span class="p">,</span>
      <span class="nt">&quot;secure_rewrites&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
      <span class="nt">&quot;vhost_global_handlers&quot;</span><span class="p">:</span> <span class="s2">&quot;_utils, _uuids, _session, _oauth, _users&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;httpd_db_handlers&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;_changes&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_db, handle_changes_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_compact&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_db, handle_compact_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_design&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_db, handle_design_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_temp_view&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_view, handle_temp_view_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_view_cleanup&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_db, handle_view_cleanup_req}&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;httpd_design_handlers&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;_info&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_db,   handle_design_info_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_list&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_show, handle_view_list_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_rewrite&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_rewrite, handle_rewrite_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_show&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_show, handle_doc_show_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_update&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_show, handle_doc_update_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_view&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_view, handle_view_req}&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;httpd_global_handlers&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;/&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_misc_handlers, handle_welcome_req, &lt;&lt;\&quot;Welcome\&quot;&gt;&gt;}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_active_tasks&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_misc_handlers, handle_task_status_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_all_dbs&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_misc_handlers, handle_all_dbs_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_config&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_misc_handlers, handle_config_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_log&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_misc_handlers, handle_log_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_oauth&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_oauth, handle_oauth_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_replicate&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_misc_handlers, handle_replicate_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_restart&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_misc_handlers, handle_restart_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_session&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_auth, handle_session_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_stats&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_stats_handlers, handle_stats_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_utils&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_misc_handlers, handle_utils_dir_req, \&quot;/usr/share/couchdb/www\&quot;}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_uuids&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_misc_handlers, handle_uuids_req}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;favicon.ico&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_misc_handlers, handle_favicon_req, \&quot;/usr/share/couchdb/www\&quot;}&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;log&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/log/couchdb/couch.log&quot;</span><span class="p">,</span>
      <span class="nt">&quot;include_sasl&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
      <span class="nt">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;query_server_config&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;reduce_limit&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;query_servers&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;javascript&quot;</span><span class="p">:</span> <span class="s2">&quot;/usr/bin/couchjs /usr/share/couchdb/server/main.js&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;replicator&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;max_http_pipeline_size&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span>
      <span class="nt">&quot;max_http_sessions&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;stats&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;1000&quot;</span><span class="p">,</span>
      <span class="nt">&quot;samples&quot;</span><span class="p">:</span> <span class="s2">&quot;[0, 60, 300, 900]&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;uuids&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;algorithm&quot;</span><span class="p">:</span> <span class="s2">&quot;utc_random&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="config-section">
<span id="api-config-section"></span><h5><tt class="docutils literal"><span class="pre">/_config/section</span></tt><a class="headerlink" href="#config-section" title="Permalink to this headline">¶</a></h5>
<dl class="get">
<dt id="get--_config-section">
<tt class="descname">GET </tt><tt class="descname">/_config/{section}</tt><a class="headerlink" href="#get--_config-section" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets the configuration structure for a single section.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>section</strong> &#8211; Configuration section name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_config/httpd</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">444</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 12:10:40 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;allow_jsonp&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
    <span class="nt">&quot;authentication_handlers&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_oauth, oauth_authentication_handler}, {couch_httpd_auth, cookie_authentication_handler}, {couch_httpd_auth, default_authentication_handler}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;bind_address&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;default_handler&quot;</span><span class="p">:</span> <span class="s2">&quot;{couch_httpd_db, handle_request}&quot;</span><span class="p">,</span>
    <span class="nt">&quot;enable_cors&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
    <span class="nt">&quot;log_max_chunk_size&quot;</span><span class="p">:</span> <span class="s2">&quot;1000000&quot;</span><span class="p">,</span>
    <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="s2">&quot;5984&quot;</span><span class="p">,</span>
    <span class="nt">&quot;secure_rewrites&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
    <span class="nt">&quot;vhost_global_handlers&quot;</span><span class="p">:</span> <span class="s2">&quot;_utils, _uuids, _session, _oauth, _users&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="config-section-key">
<span id="api-config-section-key"></span><h5><tt class="docutils literal"><span class="pre">/_config/section/key</span></tt><a class="headerlink" href="#config-section-key" title="Permalink to this headline">¶</a></h5>
<dl class="get">
<dt id="get--_config-section-key">
<tt class="descname">GET </tt><tt class="descname">/_config/{section}/{key}</tt><a class="headerlink" href="#get--_config-section-key" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets a single configuration value from within a specific configuration
section.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>section</strong> &#8211; Configuration section name</li>
<li><strong>key</strong> &#8211; Configuration option name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/_config/log/level</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">8</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 12:12:59 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="s2">&quot;debug&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The returned value will be the JSON of the value, which may be a
string or numeric value, or an array or object. Some client
environments may not parse simple strings or numeric values as valid JSON.</p>
</div>
</dd></dl>

<dl class="put">
<dt id="put--_config-section-key">
<tt class="descname">PUT </tt><tt class="descname">/_config/{section}/{key}</tt><a class="headerlink" href="#put--_config-section-key" title="Permalink to this definition">¶</a></dt>
<dd><p>Updates a configuration value. The new value should be supplied in the
request body in the corresponding JSON format. If you are setting a string
value, you must supply a valid JSON string. In response CouchDB sends old
value for target section key.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>section</strong> &#8211; Configuration section name</li>
<li><strong>key</strong> &#8211; Configuration option name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid JSON request body</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> &#8211; Error setting configuration</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/_config/log/level</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">7</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="s2">&quot;info&quot;</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">8</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 12:12:59 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="s2">&quot;debug&quot;</span>
</pre></div>
</div>
</dd></dl>

<dl class="delete">
<dt id="delete--_config-section-key">
<tt class="descname">DELETE </tt><tt class="descname">/_config/{section}/{key}</tt><a class="headerlink" href="#delete--_config-section-key" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes a configuration value. The returned JSON will be the value of
the configuration parameter before it was deleted.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>section</strong> &#8211; Configuration section name</li>
<li><strong>key</strong> &#8211; Configuration option name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Specified configuration option not found</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">DELETE</span> <span class="nn">/_config/log/level</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">7</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 12:29:03 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="s2">&quot;info&quot;</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
</div>
</div>
<span id="document-api/database/index"></span><div class="section" id="databases">
<span id="api-database"></span><h3>Databases<a class="headerlink" href="#databases" title="Permalink to this headline">¶</a></h3>
<p>The Database endpoint provides an interface to an entire database with in
CouchDB. These are database-level, rather than document-level requests.</p>
<p>For all these requests, the database name within the URL path
should be the database name that you wish to perform the operation on.
For example, to obtain the meta information for the database
<tt class="docutils literal"><span class="pre">recipes</span></tt>, you would use the HTTP request:</p>
<div class="highlight-http"><div class="highlight"><pre>GET /recipes
</pre></div>
</div>
<p>For clarity, the form below is used in the URL paths:</p>
<div class="highlight-http"><div class="highlight"><pre>GET /db
</pre></div>
</div>
<p>Where <tt class="docutils literal"><span class="pre">db</span></tt> is the name of any database.</p>
<div class="toctree-wrapper compound">
<span id="document-api/database/common"></span><div class="section" id="db">
<span id="api-db"></span><h4><tt class="docutils literal"><span class="pre">/db</span></tt><a class="headerlink" href="#db" title="Permalink to this headline">¶</a></h4>
<dl class="head">
<dt id="head--db">
<tt class="descname">HEAD </tt><tt class="descname">/{db}</tt><a class="headerlink" href="#head--db" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the HTTP Headers containing a minimal amount of information
about the specified database. Since the response body is empty, using the
HEAD method is a lightweight way to check if the database exists already or
not.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Database exists</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Requested database not found</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">HEAD</span> <span class="nn">/test</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 01:27:41 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
</pre></div>
</div>
</dd></dl>

<dl class="get">
<dt id="get--db">
<tt class="descname">GET </tt><tt class="descname">/{db}</tt><a class="headerlink" href="#get--db" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets information about the specified database.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>committed_update_seq</strong> (<em>number</em>) &#8211; The number of committed update.</li>
<li><strong>compact_running</strong> (<em>boolean</em>) &#8211; Set to <tt class="docutils literal"><span class="pre">true</span></tt> if the database compaction
routine is operating on this database.</li>
<li><strong>db_name</strong> (<em>string</em>) &#8211; The name of the database.</li>
<li><strong>disk_format_version</strong> (<em>number</em>) &#8211; The version of the physical format used
for the data when it is stored on disk.</li>
<li><strong>data_size</strong> (<em>number</em>) &#8211; Actual data size in bytes of the database data.</li>
<li><strong>disk_size</strong> (<em>number</em>) &#8211; Size in bytes of the data as stored on the disk.
Views indexes are not included in the calculation.</li>
<li><strong>doc_count</strong> (<em>number</em>) &#8211; A count of the documents in the specified database.</li>
<li><strong>doc_del_count</strong> (<em>number</em>) &#8211; Number of deleted documents</li>
<li><strong>instance_start_time</strong> (<em>string</em>) &#8211; Timestamp of when the database was opened,
expressed in microseconds since the epoch.</li>
<li><strong>purge_seq</strong> (<em>number</em>) &#8211; The number of purge operations on the database.</li>
<li><strong>update_seq</strong> (<em>number</em>) &#8211; The current number of updates to the database.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Requested database not found</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/receipts</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">258</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 01:38:57 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;committed_update_seq&quot;</span><span class="p">:</span> <span class="mi">292786</span><span class="p">,</span>
    <span class="nt">&quot;compact_running&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;data_size&quot;</span><span class="p">:</span> <span class="mi">65031503</span><span class="p">,</span>
    <span class="nt">&quot;db_name&quot;</span><span class="p">:</span> <span class="s2">&quot;receipts&quot;</span><span class="p">,</span>
    <span class="nt">&quot;disk_format_version&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="nt">&quot;disk_size&quot;</span><span class="p">:</span> <span class="mi">137433211</span><span class="p">,</span>
    <span class="nt">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">6146</span><span class="p">,</span>
    <span class="nt">&quot;doc_del_count&quot;</span><span class="p">:</span> <span class="mi">64637</span><span class="p">,</span>
    <span class="nt">&quot;instance_start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;1376269325408900&quot;</span><span class="p">,</span>
    <span class="nt">&quot;purge_seq&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;update_seq&quot;</span><span class="p">:</span> <span class="mi">292786</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="put">
<dt id="put--db">
<tt class="descname">PUT </tt><tt class="descname">/{db}</tt><a class="headerlink" href="#put--db" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates a new database. The database name <tt class="docutils literal"><span class="pre">{db}</span></tt> must be composed by
following next rules:</p>
<ul class="simple">
<li>Name must begin with a lowercase letter (<tt class="docutils literal"><span class="pre">a-z</span></tt>)</li>
<li>Lowercase characters (<tt class="docutils literal"><span class="pre">a-z</span></tt>)</li>
<li>Digits (<tt class="docutils literal"><span class="pre">0-9</span></tt>)</li>
<li>Any of the characters <tt class="docutils literal"><span class="pre">_</span></tt>, <tt class="docutils literal"><span class="pre">$</span></tt>, <tt class="docutils literal"><span class="pre">(</span></tt>, <tt class="docutils literal"><span class="pre">)</span></tt>, <tt class="docutils literal"><span class="pre">+</span></tt>, <tt class="docutils literal"><span class="pre">-</span></tt>, and
<tt class="docutils literal"><span class="pre">/</span></tt>.</li>
</ul>
<p>If you&#8217;re familiar with <a class="reference external" href="http://en.wikipedia.org/wiki/Regular_expression">Regular Expressions</a>, the rules above could be
written as <tt class="docutils literal"><span class="pre">^[a-z][a-z0-9_$()+/-]*$</span></tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.3">Location</a> &#8211; Database URI location</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status. Available in case of success</li>
<li><strong>error</strong> (<em>string</em>) &#8211; Error type. Available if response code is <tt class="docutils literal"><span class="pre">4xx</span></tt></li>
<li><strong>reason</strong> (<em>string</em>) &#8211; Error description. Available if response code is <tt class="docutils literal"><span class="pre">4xx</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> &#8211; Database created successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid database name</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.13">412 Precondition Failed</a> &#8211; Database already exists</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/db</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">12</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 08:01:45 GMT</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/db</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If we repeat the same request to CouchDB, it will response with <tt class="code docutils literal"><span class="pre">412</span></tt>
since the database already exists:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/db</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">412</span> <span class="ne">Precondition Failed</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">95</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 08:01:16 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;file_exists&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;The database could not be created, the file already exists.&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If an invalid database name is supplied, CouchDB returns response with <tt class="code docutils literal"><span class="pre">400</span></tt>:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/_db</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">400</span> <span class="ne">Bad Request</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">194</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 08:02:10 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;illegal_database_name&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;Name: &#39;_db&#39;. Only lowercase characters (a-z), digits (0-9), and any of the characters _, $, (, ), +, -, and / are allowed. Must begin with a letter.&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="delete">
<dt id="delete--db">
<tt class="descname">DELETE </tt><tt class="descname">/{db}</tt><a class="headerlink" href="#delete--db" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes the specified database, and all the documents and attachments
contained within it.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To avoid deleting a database, CouchDB will respond with the HTTP status code 400
when the request URL includes a ?rev= parameter. This suggests that one wants to delete
a document but forgot to add the document id to the URL.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Database removed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid database name or forgotten document id by accident</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Database doesn&#8217;t exist</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">DELETE</span> <span class="nn">/db</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">12</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 08:54:00 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="post">
<dt id="post--db">
<tt class="descname">POST </tt><tt class="descname">/{db}</tt><a class="headerlink" href="#post--db" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates a new document in the specified database, using the supplied JSON
document structure.</p>
<p>If the JSON structure includes the <tt class="docutils literal"><span class="pre">_id</span></tt> field, then the document will be
created with the specified document ID.</p>
<p>If the <tt class="docutils literal"><span class="pre">_id</span></tt> field is not specified, a new unique ID will be generated,
following whatever UUID algorithm is configured for that server.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
<li><strong>X-Couch-Full-Commit</strong> &#8211; Overrides server&#8217;s
<a class="reference internal" href="contents.html#couchdb/delayed_commits" title="delayed_commits"><tt class="xref config config-option docutils literal"><span class="pre">commit</span> <span class="pre">policy</span></tt></a>. Possible values
are: <tt class="docutils literal"><span class="pre">false</span></tt> and <tt class="docutils literal"><span class="pre">true</span></tt>. <em>Optional</em>.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>batch</strong> (<em>string</em>) &#8211; Stores document in <a class="reference internal" href="contents.html#api-doc-batch-writes"><em>batch mode</em></a> Possible values: <tt class="docutils literal"><span class="pre">ok</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Quoted new document&#8217;s revision</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.3">Location</a> &#8211; Document&#8217;s URI</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>id</strong> (<em>string</em>) &#8211; Document ID</li>
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
<li><strong>rev</strong> (<em>string</em>) &#8211; Revision info</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> &#8211; Document created and stored on disk</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Document data accepted, but not yet stored on disk</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid database name</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Write privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Database doesn&#8217;t exist</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.10">409 Conflict</a> &#8211; A Conflicting Document with same ID already exists</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">81</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
    <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Delicious with fresh bread&quot;</span><span class="p">,</span>
    <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Fish Stew&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">95</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 13 Aug 2013 15:19:25 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;1-9c65296036141e575d32ba9c034dd3ee&quot;</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/db/ab39fe0993049b84cfa81acd6ebad09d</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;ab39fe0993049b84cfa81acd6ebad09d&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-9c65296036141e575d32ba9c034dd3ee&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="specifying-the-document-id">
<h5>Specifying the Document ID<a class="headerlink" href="#specifying-the-document-id" title="Permalink to this headline">¶</a></h5>
<p>The document ID can be specified by including the <tt class="docutils literal"><span class="pre">_id</span></tt> field in the
JSON of the submitted record. The following request will create the same
document with the ID <tt class="docutils literal"><span class="pre">FishStew</span></tt>.</p>
<blockquote>
<div><p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">98</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
    <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Delicious with fresh bread&quot;</span><span class="p">,</span>
    <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Fish Stew&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">71</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 13 Aug 2013 15:19:25 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;1-9c65296036141e575d32ba9c034dd3ee&quot;</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/db/FishStew</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-9c65296036141e575d32ba9c034dd3ee&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="batch-mode-writes">
<span id="api-doc-batch-writes"></span><h5>Batch Mode Writes<a class="headerlink" href="#batch-mode-writes" title="Permalink to this headline">¶</a></h5>
<p>You can write documents to the database at a higher rate by using the
batch option. This collects document writes together in memory (on a
user-by-user basis) before they are committed to disk. This increases
the risk of the documents not being stored in the event of a failure,
since the documents are not written to disk immediately.</p>
<p>To use the batched mode, append the <tt class="docutils literal"><span class="pre">batch=ok</span></tt> query argument to the
URL of the <tt class="docutils literal"><span class="pre">PUT</span></tt> or <a class="reference internal" href="contents.html#post--db" title="POST /{db}"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}</span></tt></a> request. The CouchDB server will
respond with a HTTP <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> response code immediately.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Creating or updating documents with batch mode doesn&#8217;t guarantee that all
documents will be successfully stored on disk. For example, individual
documents may not be saved due to conflicts, rejection by
<a class="reference internal" href="contents.html#vdufun"><em>validation function</em></a> or by other reasons, even if overall
the batch was sucessfully submitted.</p>
</div>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db?batch=ok</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">98</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>

<span class="p">{</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
    <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Delicious with fresh bread&quot;</span><span class="p">,</span>
    <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Fish Stew&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">202</span> <span class="ne">Accepted</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">28</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 13 Aug 2013 15:19:25 GMT</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/db/FishStew</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<span id="document-api/database/bulk-api"></span><div class="section" id="db-all-docs">
<span id="api-db-all-docs"></span><h4><tt class="docutils literal"><span class="pre">/db/_all_docs</span></tt><a class="headerlink" href="#db-all-docs" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_all_docs">
<tt class="descname">GET </tt><tt class="descname">/{db}/_all_docs</tt><a class="headerlink" href="#get--db-_all_docs" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a JSON structure of all of the documents in a given database.
The information is returned as a JSON structure containing meta
information about the return structure, including a list of all documents
and basic contents, consisting the ID, revision and key. The key is the
from the document&#8217;s <tt class="docutils literal"><span class="pre">_id</span></tt>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>conflicts</strong> (<em>boolean</em>) &#8211; Includes <cite>conflicts</cite> information in response.
Ignored if <cite>include_docs</cite> isn&#8217;t <tt class="docutils literal"><span class="pre">true</span></tt>. Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>descending</strong> (<em>boolean</em>) &#8211; Return the documents in descending by key order.
Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>endkey</strong> (<em>string</em>) &#8211; Stop returning records when the specified key is
reached. <em>Optional</em>.</li>
<li><strong>end_key</strong> (<em>string</em>) &#8211; Alias for <cite>endkey</cite> param.</li>
<li><strong>endkey_docid</strong> (<em>string</em>) &#8211; Stop returning records when the specified
document ID is reached. <em>Optional</em>.</li>
<li><strong>end_key_doc_id</strong> (<em>string</em>) &#8211; Alias for <cite>endkey_docid</cite> param.</li>
<li><strong>include_docs</strong> (<em>boolean</em>) &#8211; Include the full content of the documents in
the return. Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>inclusive_end</strong> (<em>boolean</em>) &#8211; Specifies whether the specified end key should
be included in the result. Default is <tt class="docutils literal"><span class="pre">true</span></tt>.</li>
<li><strong>key</strong> (<em>string</em>) &#8211; Return only documents that match the specified key.
<em>Optional</em>.</li>
<li><strong>limit</strong> (<em>number</em>) &#8211; Limit the number of the returned documents to the
specified number. <em>Optional</em>.</li>
<li><strong>skip</strong> (<em>number</em>) &#8211; Skip this number of records before starting to return
the results. Default is <tt class="docutils literal"><span class="pre">0</span></tt>.</li>
<li><strong>stale</strong> (<em>string</em>) &#8211; Allow the results from a stale view to be used, without
triggering a rebuild of all views within the encompassing design doc.
Supported values: <tt class="docutils literal"><span class="pre">ok</span></tt> and <tt class="docutils literal"><span class="pre">update_after</span></tt>. <em>Optional</em>.</li>
<li><strong>startkey</strong> (<em>string</em>) &#8211; Return records starting with the specified key.
<em>Optional</em>.</li>
<li><strong>start_key</strong> (<em>string</em>) &#8211; Alias for <cite>startkey</cite> param.</li>
<li><strong>startkey_docid</strong> (<em>string</em>) &#8211; Return records starting with the specified
document ID. <em>Optional</em>.</li>
<li><strong>start_key_doc_id</strong> (<em>string</em>) &#8211; Alias for <cite>startkey_docid</cite> param.</li>
<li><strong>update_seq</strong> (<em>boolean</em>) &#8211; Response includes an <tt class="docutils literal"><span class="pre">update_seq</span></tt> value
indicating which sequence id of the underlying database the view reflects.
Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Response signature</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>offset</strong> (<em>number</em>) &#8211; Offset where the document list started</li>
<li><strong>rows</strong> (<em>array</em>) &#8211; Array of view row objects. By default the information
returned contains only the document ID and revision.</li>
<li><strong>total_rows</strong> (<em>number</em>) &#8211; Number of documents in the database/view. Note that
this is not the number of rows returned in the actual query.</li>
<li><strong>update_seq</strong> (<em>number</em>) &#8211; Current update sequence for the database</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/db/_all_docs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 10 Aug 2013 16:22:56 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;1W2DJUZFZSZD9K78UFA3GZWB4&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;16e458537602f5ef2a710089dffd9453&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;16e458537602f5ef2a710089dffd9453&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-967a00dff5e02add41819138abb3284d&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;a4c51cdfa2069f3e905c431114001aff&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;a4c51cdfa2069f3e905c431114001aff&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-967a00dff5e02add41819138abb3284d&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;a4c51cdfa2069f3e905c4311140034aa&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;a4c51cdfa2069f3e905c4311140034aa&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;5-6182c9c954200ab5e3c6bd5e76a1549f&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;a4c51cdfa2069f3e905c431114003597&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;a4c51cdfa2069f3e905c431114003597&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-7051cbe5c8faecd085a3fa619e6e6337&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;f4ca7773ddea715afebc4b4b15d4f0b3&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;f4ca7773ddea715afebc4b4b15d4f0b3&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-7051cbe5c8faecd085a3fa619e6e6337&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;total_rows&quot;</span><span class="p">:</span> <span class="mi">5</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="post">
<dt id="post--db-_all_docs">
<tt class="descname">POST </tt><tt class="descname">/{db}/_all_docs</tt><a class="headerlink" href="#post--db-_all_docs" title="Permalink to this definition">¶</a></dt>
<dd><p>The <tt class="docutils literal"><span class="pre">POST</span></tt> to <tt class="docutils literal"><span class="pre">_all_docs</span></tt> allows to specify multiple keys to be
selected from the database. This enables you to request multiple
documents in a single request, in place of multiple <a class="reference internal" href="contents.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}</span></tt></a>
requests.</p>
<p>The request body should contain a list of the keys to be returned as an
array to a <tt class="docutils literal"><span class="pre">keys</span></tt> object. For example:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db/_all_docs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">70</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
   <span class="nt">&quot;keys&quot;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;Zingylemontart&quot;</span><span class="p">,</span>
      <span class="s2">&quot;Yogurtraita&quot;</span>
   <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The returned JSON is the all documents structure, but with only the
selected keys in the output:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
   <span class="s2">&quot;total_rows&quot;</span> <span class="o">:</span> <span class="mi">2666</span><span class="p">,</span>
   <span class="s2">&quot;rows&quot;</span> <span class="o">:</span> <span class="p">[</span>
      <span class="p">{</span>
         <span class="s2">&quot;value&quot;</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;rev&quot;</span> <span class="o">:</span> <span class="s2">&quot;1-a3544d296de19e6f5b932ea77d886942&quot;</span>
         <span class="p">},</span>
         <span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="s2">&quot;Zingylemontart&quot;</span><span class="p">,</span>
         <span class="s2">&quot;key&quot;</span> <span class="o">:</span> <span class="s2">&quot;Zingylemontart&quot;</span>
      <span class="p">},</span>
      <span class="p">{</span>
         <span class="s2">&quot;value&quot;</span> <span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;rev&quot;</span> <span class="o">:</span> <span class="s2">&quot;1-91635098bfe7d40197a1b98d7ee085fc&quot;</span>
         <span class="p">},</span>
         <span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="s2">&quot;Yogurtraita&quot;</span><span class="p">,</span>
         <span class="s2">&quot;key&quot;</span> <span class="o">:</span> <span class="s2">&quot;Yogurtraita&quot;</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="s2">&quot;offset&quot;</span> <span class="o">:</span> <span class="mi">0</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-bulk-docs">
<span id="api-db-bulk-docs"></span><h4><tt class="docutils literal"><span class="pre">/db/_bulk_docs</span></tt><a class="headerlink" href="#db-bulk-docs" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--db-_bulk_docs">
<tt class="descname">POST </tt><tt class="descname">/{db}/_bulk_docs</tt><a class="headerlink" href="#post--db-_bulk_docs" title="Permalink to this definition">¶</a></dt>
<dd><p>The bulk document API allows you to create and update multiple documents
at the same time within a single request. The basic operation is similar
to creating or updating a single document, except that you batch the
document structure and information.</p>
<p>When creating new documents the document ID (<tt class="docutils literal"><span class="pre">_id</span></tt>) is optional.</p>
<p>For updating existing documents, you must provide the document ID, revision
information (<tt class="docutils literal"><span class="pre">_rev</span></tt>), and new document values.</p>
<p>In case of batch deleting documents all fields as document ID, revision
information and deletion status (<tt class="docutils literal"><span class="pre">_deleted</span></tt>) are required.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
<li><strong>X-Couch-Full-Commit</strong> &#8211; Overrides server&#8217;s
<a class="reference internal" href="contents.html#couchdb/delayed_commits" title="delayed_commits"><tt class="xref config config-option docutils literal"><span class="pre">commit</span> <span class="pre">policy</span></tt></a>. Possible values
are: <tt class="docutils literal"><span class="pre">false</span></tt> and <tt class="docutils literal"><span class="pre">true</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Request JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>all_or_nothing</strong> (<em>boolean</em>) &#8211; Sets the database commit mode to use
<a class="reference internal" href="contents.html#api-db-bulk-docs-semantics"><em>all-or-nothing</em></a> semantics.
Default is <tt class="docutils literal"><span class="pre">false</span></tt>. <em>Optional</em></li>
<li><strong>docs</strong> (<em>array</em>) &#8211; List of documents objects</li>
<li><strong>new_edits</strong> (<em>boolean</em>) &#8211; If <tt class="docutils literal"><span class="pre">false</span></tt>, prevents the database from assigning
them new revision IDs. Default is <tt class="docutils literal"><span class="pre">true</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Array of Objects:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>id</strong> (<em>string</em>) &#8211; Document ID</li>
<li><strong>rev</strong> (<em>string</em>) &#8211; New document revision token. Available
if document have saved without errors. <em>Optional</em></li>
<li><strong>error</strong> (<em>string</em>) &#8211; Error type. <em>Optional</em></li>
<li><strong>reason</strong> (<em>string</em>) &#8211; Error reason. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> &#8211; Document(s) have been created or updated</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; The request provided invalid JSON data</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.18">417 Expectation Failed</a> &#8211; Occurs when <tt class="docutils literal"><span class="pre">all_or_nothing</span></tt> option set as <tt class="docutils literal"><span class="pre">true</span></tt> and
at least one document was rejected by <a class="reference internal" href="contents.html#vdufun"><em>validation function</em></a></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> &#8211; Malformed data provided, while it&#8217;s still valid JSON</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db/_bulk_docs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">109</span>
<span class="na">Content-Type</span><span class="o">:</span><span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
  <span class="nt">&quot;docs&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-0786321986194c92dd3b57dfbfc741ce&quot;</span><span class="p">,</span>
      <span class="nt">&quot;_deleted&quot;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">144</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 00:15:05 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span><span class="s2">&quot; 1-967a00dff5e02add41819138abb3284d&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;3-f9c62b2169d0999103e9f41949090807&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="inserting-documents-in-bulk">
<h5>Inserting Documents in Bulk<a class="headerlink" href="#inserting-documents-in-bulk" title="Permalink to this headline">¶</a></h5>
<p>Each time a document is stored or updated in CouchDB, the internal B-tree
is updated. Bulk insertion provides efficiency gains in both storage space,
and time, by consolidating many of the updates to intermediate B-tree nodes.</p>
<p>It is not intended as a way to perform <tt class="docutils literal"><span class="pre">ACID</span></tt>-like transactions in CouchDB,
the only transaction boundary within CouchDB is a single update to a single
database. The constraints are detailed in <a class="reference internal" href="contents.html#api-db-bulk-docs-semantics"><em>Bulk Documents Transaction Semantics</em></a>.</p>
<p>To insert documents in bulk into a database you need to supply a JSON
structure with the array of documents that you want to add to the database.
You can either include a document ID, or allow the document ID to be
automatically generated.</p>
<p>For example, the following update inserts three new documents, two with the
supplied document IDs, and one which will have a document ID generated:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/source/_bulk_docs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">323</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;docs&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
            <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Delicious with freshly baked bread&quot;</span><span class="p">,</span>
            <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
            <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Serve with a whole meal scone topping&quot;</span><span class="p">,</span>
            <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;BeefStew&quot;</span><span class="p">,</span>
            <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Hand-made dumplings make a great accompaniment&quot;</span><span class="p">,</span>
            <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;BeefStew&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The return type from a bulk insertion will be <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a>,
with the content of the returned structure indicating specific success
or otherwise messages on a per-document basis.</p>
<p>The return structure from the example above contains a list of the
documents created, here with the combination and their revision IDs:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">215</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 26 Oct 2013 00:10:39 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-6a466d5dfda05e613ba97bd737829d67&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-648f1b989d52b8e43f05aa877092cc7c&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;BeefStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-e4602845fc4c99674f50b1d5a804fdfa&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The content and structure of the returned JSON will depend on the transaction
semantics being used for the bulk update; see <a class="reference internal" href="contents.html#api-db-bulk-docs-semantics"><em>Bulk Documents Transaction Semantics</em></a>
for more information. Conflicts and validation errors when updating documents in
bulk must be handled separately; see <a class="reference internal" href="contents.html#api-db-bulk-docs-validation"><em>Bulk Document Validation and Conflict Errors</em></a>.</p>
</div>
<div class="section" id="updating-documents-in-bulk">
<h5>Updating Documents in Bulk<a class="headerlink" href="#updating-documents-in-bulk" title="Permalink to this headline">¶</a></h5>
<p>The bulk document update procedure is similar to the insertion
procedure, except that you must specify the document ID and current
revision for every document in the bulk update JSON string.</p>
<p>For example, you could send the following request:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/recipes/_bulk_docs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">464</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;docs&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
            <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-6a466d5dfda05e613ba97bd737829d67&quot;</span><span class="p">,</span>
            <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Delicious with freshly baked bread&quot;</span><span class="p">,</span>
            <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
            <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-648f1b989d52b8e43f05aa877092cc7c&quot;</span><span class="p">,</span>
            <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
            <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Serve with a whole meal scone topping&quot;</span><span class="p">,</span>
            <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;BeefStew&quot;</span><span class="p">,</span>
            <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-e4602845fc4c99674f50b1d5a804fdfa&quot;</span><span class="p">,</span>
            <span class="nt">&quot;servings&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="nt">&quot;subtitle&quot;</span><span class="p">:</span> <span class="s2">&quot;Hand-made dumplings make a great accompaniment&quot;</span><span class="p">,</span>
            <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;BeefStew&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The return structure is the JSON of the updated documents, with the new
revision and ID information:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">215</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 26 Oct 2013 00:10:39 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-2bff94179917f1dec7cd7f0209066fb8&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-6a7aae7ac481aa98a2042718d09843c4&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;BeefStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-9801936a42f06a16f16c30027980d96f&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>You can optionally delete documents during a bulk update by adding the
<tt class="docutils literal"><span class="pre">_deleted</span></tt> field with a value of <tt class="docutils literal"><span class="pre">true</span></tt> to each document ID/revision
combination within the submitted JSON structure.</p>
<p>The return type from a bulk insertion will be <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a>, with the
content of the returned structure indicating specific success or otherwise
messages on a per-document basis.</p>
<p>The content and structure of the returned JSON will depend on the transaction
semantics being used for the bulk update; see <a class="reference internal" href="contents.html#api-db-bulk-docs-semantics"><em>Bulk Documents Transaction Semantics</em></a>
for more information. Conflicts and validation errors when updating documents in
bulk must be handled separately; see <a class="reference internal" href="contents.html#api-db-bulk-docs-validation"><em>Bulk Document Validation and Conflict Errors</em></a>.</p>
</div>
<div class="section" id="bulk-documents-transaction-semantics">
<span id="api-db-bulk-docs-semantics"></span><h5>Bulk Documents Transaction Semantics<a class="headerlink" href="#bulk-documents-transaction-semantics" title="Permalink to this headline">¶</a></h5>
<p>CouchDB supports two different modes for updating (or inserting)
documents using the bulk documentation system. Each mode affects both
the state of the documents in the event of system failure, and the level
of conflict checking performed on each document. The two modes are:</p>
<ul>
<li><p class="first"><strong>non-atomic</strong></p>
<p>The default mode is <cite>non-atomic</cite>, that is, CouchDB will only guarantee
that some of the documents will be saved when you send the request.
The response will contain the list of documents successfully inserted
or updated during the process. In the event of a crash, some of the
documents may have been successfully saved, and some will have been
lost.</p>
<p>In this mode, the response structure will indicate whether the
document was updated by supplying the new <tt class="docutils literal"><span class="pre">_rev</span></tt> parameter
indicating a new document revision was created. If the update failed,
then you will get an <tt class="docutils literal"><span class="pre">error</span></tt> of type <tt class="docutils literal"><span class="pre">conflict</span></tt>. For example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span>
   <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
      <span class="s2">&quot;error&quot;</span> <span class="o">:</span> <span class="s2">&quot;conflict&quot;</span><span class="p">,</span>
      <span class="s2">&quot;reason&quot;</span> <span class="o">:</span> <span class="s2">&quot;Document update conflict.&quot;</span>
   <span class="p">},</span>
   <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
      <span class="s2">&quot;error&quot;</span> <span class="o">:</span> <span class="s2">&quot;conflict&quot;</span><span class="p">,</span>
      <span class="s2">&quot;reason&quot;</span> <span class="o">:</span> <span class="s2">&quot;Document update conflict.&quot;</span>
   <span class="p">},</span>
   <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="s2">&quot;BeefStew&quot;</span><span class="p">,</span>
      <span class="s2">&quot;error&quot;</span> <span class="o">:</span> <span class="s2">&quot;conflict&quot;</span><span class="p">,</span>
      <span class="s2">&quot;reason&quot;</span> <span class="o">:</span> <span class="s2">&quot;Document update conflict.&quot;</span>
   <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>In this case no new revision has been created and you will need to
submit the document update, with the correct revision tag, to update
the document.</p>
</li>
<li><p class="first"><strong>all-or-nothing</strong></p>
<p>In <cite>all-or-nothing</cite> mode, either all documents are written to the
database, or no documents are written to the database, in the event
of a system failure during commit.</p>
<p>In addition, the per-document conflict checking is not performed.
Instead a new revision of the document is created, even if the new
revision is in conflict with the current revision in the database.
The returned structure contains the list of documents with new
revisions:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">215</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 26 Oct 2013 00:13:33 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-6a466d5dfda05e613ba97bd737829d67&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-648f1b989d52b8e43f05aa877092cc7c&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;BeefStew&quot;</span><span class="p">,</span>
        <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-e4602845fc4c99674f50b1d5a804fdfa&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>When updating documents using this mode the revision of a document
included in views will be arbitrary. You can check the conflict
status for a document by using the <tt class="docutils literal"><span class="pre">conflicts=true</span></tt> query argument
when accessing the view. Conflicts should be handled individually to
ensure the consistency of your database.</p>
<p>To use this mode, you must include the <tt class="docutils literal"><span class="pre">all_or_nothing</span></tt> field (set
to true) within the main body of the JSON of the request.</p>
</li>
</ul>
<p>The effects of different database operations on the different modes are
summarized below:</p>
<ul class="simple">
<li><strong>Transaction Mode</strong>: <tt class="docutils literal"><span class="pre">Non-atomic</span></tt><ul>
<li><strong>Transaction</strong>: <tt class="docutils literal"><span class="pre">Insert</span></tt><ul>
<li><strong>Cause</strong>: Requested document ID already exists</li>
<li><strong>Resolution</strong>: Resubmit with different document ID, or update the
existing document</li>
</ul>
</li>
<li><strong>Transaction</strong>: <tt class="docutils literal"><span class="pre">Update</span></tt><ul>
<li><strong>Cause</strong>: Revision missing or incorrect</li>
<li><strong>Resolution</strong>: Resubmit with correct revision</li>
</ul>
</li>
</ul>
</li>
<li><strong>Transaction Mode</strong>: <tt class="docutils literal"><span class="pre">All-or-nothing</span></tt><ul>
<li><strong>Transaction</strong>: <tt class="docutils literal"><span class="pre">Insert</span></tt> / <tt class="docutils literal"><span class="pre">Update</span></tt><ul>
<li><strong>Cause</strong>: Additional revision inserted</li>
<li><strong>Resolution</strong>: Resolve conflicted revisions</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Replication of documents is independent of the type of insert or update.
The documents and revisions created during a bulk insert or update are
replicated in the same way as any other document. This can mean that if
you make use of the <cite>all-or-nothing</cite> mode the exact list of documents,
revisions (and their conflict state) may or may not be replicated to
other databases correctly.</p>
</div>
<div class="section" id="bulk-document-validation-and-conflict-errors">
<span id="api-db-bulk-docs-validation"></span><h5>Bulk Document Validation and Conflict Errors<a class="headerlink" href="#bulk-document-validation-and-conflict-errors" title="Permalink to this headline">¶</a></h5>
<p>The JSON returned by the <tt class="docutils literal"><span class="pre">_bulk_docs</span></tt> operation consists of an array
of JSON structures, one for each document in the original submission.
The returned JSON structure should be examined to ensure that all of the
documents submitted in the original request were successfully added to
the database.</p>
<p>When a document (or document revision) is not correctly committed to the
database because of an error, you should check the <tt class="docutils literal"><span class="pre">error</span></tt> field to
determine error type and course of action. Errors will be one of the
following type:</p>
<ul>
<li><p class="first"><strong>conflict</strong></p>
<p>The document as submitted is in conflict. If you used the default
bulk transaction mode then the new revision will not have been
created and you will need to re-submit the document to the database.
If you used <tt class="docutils literal"><span class="pre">all-or-nothing</span></tt> mode then you will need to manually
resolve the conflicted revisions of the document.</p>
<p>Conflict resolution of documents added using the bulk docs interface
is identical to the resolution procedures used when resolving
conflict errors during replication.</p>
</li>
<li><p class="first"><strong>forbidden</strong></p>
<p>Entries with this error type indicate that the validation routine
applied to the document during submission has returned an error.</p>
<p>For example, if your <a class="reference internal" href="contents.html#vdufun"><em>validation routine</em></a> includes
the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;invalid recipe ingredient&#39;</span><span class="p">});</span>
</pre></div>
</div>
<p>The error response returned will be:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">417</span> <span class="ne">Expectation Failed</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">120</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 26 Oct 2013 00:05:17 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;forbidden&quot;</span><span class="p">,</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;LambStew&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;invalid recipe ingredient&quot;</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-34c318924a8f327223eed702ddfdc66d&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<span id="document-api/database/changes"></span><div class="section" id="db-changes">
<span id="api-db-changes"></span><h4><tt class="docutils literal"><span class="pre">/db/_changes</span></tt><a class="headerlink" href="#db-changes" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_changes">
<tt class="descname">GET </tt><tt class="descname">/{db}/_changes</tt><a class="headerlink" href="#get--db-_changes" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a sorted list of changes made to documents in the database, in time
order of application, can be obtained from the database&#8217;s <tt class="docutils literal"><span class="pre">_changes</span></tt>
resource. Only the most recent change for a given document is guaranteed to
be provided, for example if a document has had fields added, and then deleted,
an API client checking for changes will not necessarily receive the
intermediate state of added documents.</p>
<p>This can be used to listen for update and modifications to the database for
post processing or synchronization, and for practical purposes, a continuously
connected <tt class="docutils literal"><span class="pre">_changes</span></tt> feed is a reasonable approach for generating a
real-time log for most applications.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/event-stream</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/TR/eventsource/#last-event-id">Last-Event-ID</a> &#8211; ID of the last events received by the server on a
previous connection. Overrides <cite>since</cite> query parameter.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>doc_ids</strong> (<em>array</em>) &#8211; List of document IDs to filter the changes feed as
valid JSON array. Used with <a class="reference internal" href="contents.html#changes-filter-doc-ids"><em>_doc_ids</em></a> filter.
Since <a class="reference external" href="http://stackoverflow.com/a/417184/965635">length of URL is limited</a>, it is better to use
<a class="reference internal" href="contents.html#post--db-_changes" title="POST /{db}/_changes"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_changes</span></tt></a> instead.</li>
<li><strong>conflicts</strong> (<em>boolean</em>) &#8211; Includes <cite>conflicts</cite> information in response.
Ignored if <cite>include_docs</cite> isn&#8217;t <tt class="docutils literal"><span class="pre">true</span></tt>. Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>descending</strong> (<em>boolean</em>) &#8211; Return the change results in descending sequence
order (most recent change first). Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>feed</strong> (<em>string</em>) &#8211; see <a class="reference internal" href="contents.html#changes"><em>Changes Feeds</em></a>. Default is <tt class="docutils literal"><span class="pre">normal</span></tt>.</li>
<li><strong>filter</strong> (<em>string</em>) &#8211; Reference to a <a class="reference internal" href="contents.html#filterfun"><em>filter function</em></a>
from a design document that will filter whole stream emitting only filtered
events. See the section <a class="reference external" href="http://guide.couchdb.org/draft/notifications.html">Change Notifications in the book
CouchDB The Definitive Guide</a> for more information.</li>
<li><strong>heartbeat</strong> (<em>number</em>) &#8211; Period in <em>milliseconds</em> after which an empty line is
sent in the results. Only applicable for <a class="reference internal" href="contents.html#changes-longpoll"><em>longpoll</em></a>
or <a class="reference internal" href="contents.html#changes-continuous"><em>continuous</em></a> feeds. Overrides any timeout to
keep the feed alive indefinitely. Default is <tt class="docutils literal"><span class="pre">60000</span></tt>. May be <tt class="docutils literal"><span class="pre">true</span></tt> to
use default value.</li>
<li><strong>include_docs</strong> (<em>boolean</em>) &#8211; Include the associated document with each result.
If there are conflicts, only the winning revision is returned.
Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>attachments</strong> (<em>boolean</em>) &#8211; Include the Base64-encoded content of
<a class="reference internal" href="contents.html#api-doc-attachments"><em>attachments</em></a> in the documents that are included
if <cite>include_docs</cite> is <tt class="docutils literal"><span class="pre">true</span></tt>. Ignored if <cite>include_docs</cite> isn&#8217;t <tt class="docutils literal"><span class="pre">true</span></tt>.
Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>att_encoding_info</strong> (<em>boolean</em>) &#8211; Include encoding information in attachment
stubs if <cite>include_docs</cite> is <tt class="docutils literal"><span class="pre">true</span></tt> and the particular attachment is
compressed. Ignored if <cite>include_docs</cite> isn&#8217;t <tt class="docutils literal"><span class="pre">true</span></tt>. Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>last-event-id</strong> (<em>number</em>) &#8211; Alias of <cite>Last-Event-ID</cite> header.</li>
<li><strong>limit</strong> (<em>number</em>) &#8211; Limit number of result rows to the specified value
(note that using <tt class="docutils literal"><span class="pre">0</span></tt> here has the same effect as <tt class="docutils literal"><span class="pre">1</span></tt>).</li>
<li><strong>since</strong> &#8211; Start the results from the change immediately after the given
sequence number. Can be integer number or <tt class="docutils literal"><span class="pre">now</span></tt> value. Default is <tt class="docutils literal"><span class="pre">0</span></tt>.</li>
<li><strong>style</strong> (<em>string</em>) &#8211; Specifies how many revisions are returned in the changes
array. The default, <tt class="docutils literal"><span class="pre">main_only</span></tt>, will only return the current &#8220;winning&#8221;
revision; <tt class="docutils literal"><span class="pre">all_docs</span></tt> will return all leaf revisions (including conflicts
and deleted former conflicts).</li>
<li><strong>timeout</strong> (<em>number</em>) &#8211; Maximum period in <em>milliseconds</em> to wait for a change
before the response is sent, even if there are no results. Only applicable
for <a class="reference internal" href="contents.html#changes-longpoll"><em>longpoll</em></a> or <a class="reference internal" href="contents.html#changes-continuous"><em>continuous</em></a> feeds. Default value is specified by
<a class="reference internal" href="contents.html#httpd/changes_timeout" title="changes_timeout"><tt class="xref config config-option docutils literal"><span class="pre">httpd/changes_timeout</span></tt></a> configuration option.
Note that <tt class="docutils literal"><span class="pre">60000</span></tt> value is also the default maximum timeout to prevent
undetected dead connections.</li>
<li><strong>view</strong> (<em>string</em>) &#8211; Allows to use view functions as filters. Documents
counted as &#8220;passed&#8221; for view filter in case if map function emits at least
one record for them. See <a class="reference internal" href="contents.html#changes-filter-view"><em>_view</em></a> for more info.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9">Cache-Control</a> &#8211; <tt class="docutils literal"><span class="pre">no-cache</span></tt> if changes feed is
<a class="reference internal" href="contents.html#changes-eventsource"><em>eventsource</em></a></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/event-stream</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Response hash is changes feed is <cite>normal</cite></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.41">Transfer-Encoding</a> &#8211; <tt class="docutils literal"><span class="pre">chunked</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>last_seq</strong> (<em>number</em>) &#8211; Last change sequence number</li>
<li><strong>results</strong> (<em>array</em>) &#8211; Changes made to a database</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Bad request</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal"><span class="pre">result</span></tt> field of database changes</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">JSON Object:</th><td class="field-body"><ul class="first last simple">
<li><strong>changes</strong> (<em>array</em>) &#8211; List of document`s leafs with single field <tt class="docutils literal"><span class="pre">rev</span></tt></li>
<li><strong>id</strong> (<em>string</em>) &#8211; Document ID</li>
<li><strong>seq</strong> (<em>number</em>) &#8211; Update sequence number</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/db/_changes?style=all_docs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 00:54:58 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;6ASLEKEMSRABT0O5XY9UPO9Z&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;last_seq&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
    <span class="nt">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-7051cbe5c8faecd085a3fa619e6e6337&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;6478c2ae800dfc387396d14e1fc39626&quot;</span><span class="p">,</span>
            <span class="nt">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">6</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;3-7379b9e515b161226c6559d90c4dc49f&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;deleted&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;5bbc9ca465f1b0fcd62362168a7c8831&quot;</span><span class="p">,</span>
            <span class="nt">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">9</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;6-460637e73a6288cb24d532bf91f32969&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;5-eeaa298781f60b7bcae0c91bdedd1b87&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;729eb57437745e506b333068fff665ae&quot;</span><span class="p">,</span>
            <span class="nt">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">11</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<div class="versionchanged">
<p><span class="versionmodified">Changed in version 0.11.0: </span>added <tt class="docutils literal"><span class="pre">include_docs</span></tt> parameter</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.2.0: </span>added <tt class="docutils literal"><span class="pre">view</span></tt> parameter and special value <cite>_view</cite>
for <tt class="docutils literal"><span class="pre">filter</span></tt> one</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.3.0: </span><tt class="docutils literal"><span class="pre">since</span></tt> parameter could take <cite>now</cite> value to start
listen changes since current seq number.</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.3.0: </span><tt class="docutils literal"><span class="pre">eventsource</span></tt> feed type added.</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.4.0: </span>Support <tt class="docutils literal"><span class="pre">Last-Event-ID</span></tt> header.</p>
</div>
<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.6.0: </span>added <tt class="docutils literal"><span class="pre">attachments</span></tt> and <tt class="docutils literal"><span class="pre">att_encoding_info</span></tt>
parameters</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Using the <tt class="docutils literal"><span class="pre">attachments</span></tt> parameter to include attachments in the changes
feed is not recommended for large attachment sizes. Also note that the
Base64-encoding that is used leads to a 33% overhead (i.e. one third) in
transfer size for attachments.</p>
</div>
<dl class="post">
<dt id="post--db-_changes">
<tt class="descname">POST </tt><tt class="descname">/{db}/_changes</tt><a class="headerlink" href="#post--db-_changes" title="Permalink to this definition">¶</a></dt>
<dd><p>Requests the database changes feed in the same way as
<a class="reference internal" href="contents.html#get--db-_changes" title="GET /{db}/_changes"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/_changes</span></tt></a> does, but is widely used with
<tt class="docutils literal"><span class="pre">?filter=_doc_ids</span></tt> query parameter and allows one to pass a larger list of
document IDs to filter.</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/recipes/_changes?filter=_doc_ids</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">40</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;doc_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 28 Sep 2013 07:23:09 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;ARIHFWL3I7PIS0SPVTFU6TLR2&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;last_seq&quot;</span><span class="p">:</span> <span class="mi">38</span><span class="p">,</span>
    <span class="nt">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;13-bcb9d6388b60fd1e960d9ec4e8e3f29e&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">38</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="changes-feeds">
<span id="changes"></span><h5>Changes Feeds<a class="headerlink" href="#changes-feeds" title="Permalink to this headline">¶</a></h5>
<div class="section" id="polling">
<span id="changes-normal"></span><h6>Polling<a class="headerlink" href="#polling" title="Permalink to this headline">¶</a></h6>
<p>By default all changes are immediately returned within the JSON body:</p>
<div class="highlight-ini"><div class="highlight"><pre>GET /somedatabase/_changes HTTP/1.1
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;fresh&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-967a00dff5e02add41819138abb3284d&quot;</span><span class="p">}]},</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-7051cbe5c8faecd085a3fa619e6e6337&quot;</span><span class="p">}]},</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;deleted&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-eec205a9d413992850a6e32678485900&quot;</span><span class="p">}],</span><span class="s2">&quot;deleted&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">],</span>
<span class="s2">&quot;last_seq&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">}</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">results</span></tt> is the list of changes in sequential order. New and changed
documents only differ in the value of the rev; deleted documents include the
<tt class="docutils literal"><span class="pre">&quot;deleted&quot;:</span> <span class="pre">true</span></tt> attribute. (In the <tt class="docutils literal"><span class="pre">style=all_docs</span> <span class="pre">mode</span></tt>, deleted applies
only to the current/winning revision. The other revisions listed might be
deleted even if there is no deleted property; you have to <tt class="docutils literal"><span class="pre">GET</span></tt> them
individually to make sure.)</p>
<p><tt class="docutils literal"><span class="pre">last_seq</span></tt> is the sequence number of the last update returned. (Currently it
will always be the same as the seq of the last item in results.)</p>
<p>Sending a <tt class="docutils literal"><span class="pre">since</span></tt> param in the query string skips all changes up to and
including the given sequence number:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="na">GET /somedatabase/_changes?since</span><span class="o">=</span><span class="s">3 HTTP/1.1</span>
</pre></div>
</div>
<p>The return structure for <tt class="docutils literal"><span class="pre">normal</span></tt> and <tt class="docutils literal"><span class="pre">longpoll</span></tt> modes is a JSON
array of changes objects, and the last update sequence number.</p>
<p>In the return format for <tt class="docutils literal"><span class="pre">continuous</span></tt> mode, the server sends a <tt class="docutils literal"><span class="pre">CRLF</span></tt>
(carriage-return, linefeed) delimited line for each change. Each line
contains the <cite>JSON object</cite> described above.</p>
<p>You can also request the full contents of each document change (instead
of just the change notification) by using the <tt class="docutils literal"><span class="pre">include_docs</span></tt> parameter.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;last_seq&quot;</span><span class="o">:</span> <span class="mi">5</span>
    <span class="s2">&quot;results&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;changes&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;rev&quot;</span><span class="o">:</span> <span class="s2">&quot;2-eec205a9d413992850a6e32678485900&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;deleted&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;deleted&quot;</span><span class="p">,</span>
            <span class="s2">&quot;seq&quot;</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="long-polling">
<span id="changes-longpoll"></span><h6>Long Polling<a class="headerlink" href="#long-polling" title="Permalink to this headline">¶</a></h6>
<p>The <cite>longpoll</cite> feed, probably most applicable for a browser, is a more
efficient form of polling that waits for a change to occur before the response
is sent. <cite>longpoll</cite> avoids the need to frequently poll CouchDB to discover
nothing has changed!</p>
<p>The request to the server will remain open until a change is made on the
database and is subsequently transferred, and then the connection will close.
This is low load for both server and client.</p>
<p>The response is basically the same JSON as is sent for the <cite>normal</cite> feed.</p>
<p>Because the wait for a change can be significant you can set a
timeout before the connection is automatically closed (the
<tt class="docutils literal"><span class="pre">timeout</span></tt> argument). You can also set a heartbeat interval (using
the <tt class="docutils literal"><span class="pre">heartbeat</span></tt> query argument), which sends a newline to keep the
connection active.</p>
</div>
<div class="section" id="continuous">
<span id="changes-continuous"></span><h6>Continuous<a class="headerlink" href="#continuous" title="Permalink to this headline">¶</a></h6>
<p>Continually polling the CouchDB server is not ideal - setting up new HTTP
connections just to tell the client that nothing happened puts unnecessary
strain on CouchDB.</p>
<p>A continuous feed stays open and connected to the database until explicitly
closed and changes are sent to the client as they happen, i.e. in near
real-time.</p>
<p>As with the <cite>longpoll</cite> feed type you can set both the timeout and heartbeat
intervals to ensure that the connection is kept open for new changes
and updates.</p>
<p>The continuous feed&#8217;s response is a little different than the other feed types
to simplify the job of the client - each line of the response is either empty
or a JSON object representing a single change, as found in the normal feed&#8217;s
results.</p>
<div class="highlight-text"><div class="highlight"><pre>GET /somedatabase/_changes?feed=continuous HTTP/1.1
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;fresh&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-967a00dff5e02add41819138abb3284d&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-7051cbe5c8faecd085a3fa619e6e6337&quot;</span><span class="p">}]}</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;deleted&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;2-eec205a9d413992850a6e32678485900&quot;</span><span class="p">}],</span><span class="s2">&quot;deleted&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
<span class="p">...</span> <span class="nx">tum</span> <span class="nx">tee</span> <span class="nx">tum</span> <span class="p">...</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;updated&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;3-825cb35de44c433bfb2df415563a19de&quot;</span><span class="p">}]}</span>
</pre></div>
</div>
<p>Obviously, <cite>... tum tee tum ...</cite> does not appear in the actual response, but
represents a long pause before the change with seq 6 occurred.</p>
</div>
<div class="section" id="event-source">
<span id="changes-eventsource"></span><h6>Event Source<a class="headerlink" href="#event-source" title="Permalink to this headline">¶</a></h6>
<p>The <cite>eventsource</cite> feed provides push notifications that can be consumed in
the form of DOM events in the browser. Refer to the <a class="reference external" href="http://www.w3.org/TR/eventsource/">W3C eventsource
specification</a> for further details. CouchDB also honours the <tt class="docutils literal"><span class="pre">Last-Event-ID</span></tt>
parameter.</p>
<div class="highlight-text"><div class="highlight"><pre>GET /somedatabase/_changes?feed=eventsource HTTP/1.1
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// define the event handling function</span>
<span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">EventSource</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventSource</span><span class="p">(</span><span class="s2">&quot;/somedatabase/_changes?feed=eventsource&quot;</span><span class="p">);</span>
  <span class="nx">source</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;EventSource failed.&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="kd">var</span> <span class="nx">sourceListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c1">// start listening for events</span>
  <span class="nx">source</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">sourceListener</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

  <span class="c1">// stop listening for events</span>
  <span class="nx">source</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nx">sourceListener</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">EventSource connections are subject to cross-origin resource sharing
restrictions. You might need to configure <a class="reference internal" href="contents.html#cors"><em>CORS support</em></a> to get the EventSource to work in your application.</p>
</div>
</div>
</div>
<div class="section" id="filtering">
<span id="changes-filter"></span><h5>Filtering<a class="headerlink" href="#filtering" title="Permalink to this headline">¶</a></h5>
<p>You can filter the contents of the changes feed in a number of ways. The
most basic way is to specify one or more document IDs to the query. This
causes the returned structure value to only contain changes for the
specified IDs. Note that the value of this query argument should be a
JSON formatted array.</p>
<p>You can also filter the <tt class="docutils literal"><span class="pre">_changes</span></tt> feed by defining a filter function
within a design document. The specification for the filter is the same
as for replication filters. You specify the name of the filter function
to the <tt class="docutils literal"><span class="pre">filter</span></tt> parameter, specifying the design document name and
<a class="reference internal" href="contents.html#filterfun"><em>filter name</em></a>. For example:</p>
<div class="highlight-http"><div class="highlight"><pre>GET /db/_changes?filter=design_doc/filtername
</pre></div>
</div>
<p>Additionally, there are couple of builtin filters are available and described
below.</p>
<div class="section" id="doc-ids">
<span id="changes-filter-doc-ids"></span><h6>_doc_ids<a class="headerlink" href="#doc-ids" title="Permalink to this headline">¶</a></h6>
<p>This filter accepts only changes for documents which ID in specified in
<tt class="docutils literal"><span class="pre">doc_ids</span></tt> query parameter or payload&#8217;s object array. See
<a class="reference internal" href="contents.html#post--db-_changes" title="POST /{db}/_changes"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}/_changes</span></tt></a> for an example.</p>
</div>
<div class="section" id="design">
<span id="changes-filter-design"></span><h6>_design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h6>
<p>The <tt class="docutils literal"><span class="pre">_design</span></tt> filter accepts only changes for any design document within the
requested database.</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_changes?filter=_design</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 28 Sep 2013 07:28:28 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;ARIHFWL3I7PIS0SPVTFU6TLR2&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;last_seq&quot;</span><span class="p">:</span> <span class="mi">38</span><span class="p">,</span>
    <span class="nt">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;10-304cae84fd862832ea9814f02920d4b2&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;_design/ingredients&quot;</span><span class="p">,</span>
            <span class="nt">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">29</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;123-6f7c1b7c97a9e4f0d22bdf130e8fd817&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;deleted&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;_design/cookbook&quot;</span><span class="p">,</span>
            <span class="nt">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">35</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;6-5b8a52c22580e922e792047cff3618f3&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;deleted&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;_design/meta&quot;</span><span class="p">,</span>
            <span class="nt">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">36</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="view">
<span id="changes-filter-view"></span><h6>_view<a class="headerlink" href="#view" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.2.</span></p>
</div>
<p>The special filter <tt class="docutils literal"><span class="pre">_view</span></tt> allows to use existing <a class="reference internal" href="contents.html#mapfun"><em>map function</em></a>
as the <a class="reference internal" href="contents.html#filterfun"><em>filter</em></a>. If the map function emits anything for the
processed document it counts as accepted and the changes event emits to the
feed. For most use-practice cases <cite>filter</cite> functions are very similar to <cite>map</cite>
ones, so this feature helps to reduce amount of duplicated code.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">While <a class="reference internal" href="contents.html#mapfun"><em>map functions</em></a> doesn&#8217;t process the design documents,
using <tt class="docutils literal"><span class="pre">_view</span></tt> filter forces them to do this. You need to be sure, that
they are ready to handle documents with <em>alien</em> structure without panic
crush.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Using <tt class="docutils literal"><span class="pre">_view</span></tt> filter doesn&#8217;t queries the view index files, so you cannot
use common <a class="reference internal" href="contents.html#api-ddoc-view"><em>view query parameters</em></a> to additionally
filter the changes feed by index key. Also, CouchDB doesn&#8217;t returns
the result instantly as it does for views - it really uses the specified
map function as filter.</p>
<p class="last">Moreover, you cannot make such filters dynamic e.g. process the request
query parameters or handle the <a class="reference internal" href="contents.html#userctx-object"><em>User Context Object</em></a> - the map function is
only operates with the document.</p>
</div>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_changes?filter=_view&amp;view=ingredients/by_recipe</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 28 Sep 2013 07:36:40 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;ARIHFWL3I7PIS0SPVTFU6TLR2&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;last_seq&quot;</span><span class="p">:</span> <span class="mi">38</span><span class="p">,</span>
    <span class="nt">&quot;results&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;changes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;13-bcb9d6388b60fd1e960d9ec4e8e3f29e&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;seq&quot;</span><span class="p">:</span> <span class="mi">38</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-api/database/compact"></span><div class="section" id="db-compact">
<span id="api-db-compact"></span><h4><tt class="docutils literal"><span class="pre">/db/_compact</span></tt><a class="headerlink" href="#db-compact" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--db-_compact">
<tt class="descname">POST </tt><tt class="descname">/{db}/_compact</tt><a class="headerlink" href="#post--db-_compact" title="Permalink to this definition">¶</a></dt>
<dd><p>Request compaction of the specified database. Compaction compresses the
disk database file by performing the following operations:</p>
<ul class="simple">
<li>Writes a new, optimised, version of the database file, removing any unused
sections from the new version during write. Because a new file is
temporarily created for this purpose, you may require up to twice the current
storage space of the specified database in order for the compaction
routine to complete.</li>
<li>Removes old revisions of documents from the database, up to the
per-database limit specified by the <tt class="docutils literal"><span class="pre">_revs_limit</span></tt> database
parameter.</li>
</ul>
<p>Compaction can only be requested on an individual database; you cannot
compact all the databases for a CouchDB instance. The compaction process
runs as a background process.</p>
<p>You can determine if the compaction process is operating on a database
by obtaining the database meta information, the <tt class="docutils literal"><span class="pre">compact_running</span></tt>
value of the returned database structure will be set to true. See
<a class="reference internal" href="contents.html#get--db" title="GET /{db}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}</span></tt></a>.</p>
<p>You can also obtain a list of running processes to determine whether
compaction is currently running. See <a class="reference internal" href="contents.html#api-server-active-tasks"><em>/_active_tasks</em></a>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Compaction request has been accepted</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid database name</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.16">415 Unsupported Media Type</a> &#8211; Bad <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> value</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db/_compact</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">202</span> <span class="ne">Accepted</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">12</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 09:27:43 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-compact-design-doc">
<span id="api-db-compact-ddoc"></span><h4><tt class="docutils literal"><span class="pre">/db/_compact/design-doc</span></tt><a class="headerlink" href="#db-compact-design-doc" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--db-_compact-ddoc">
<tt class="descname">POST </tt><tt class="descname">/{db}/_compact/{ddoc}</tt><a class="headerlink" href="#post--db-_compact-ddoc" title="Permalink to this definition">¶</a></dt>
<dd><p>Compacts the view indexes associated with the specified design document.
If may be that compacting a large view can return more storage than
compacting the actual db. Thus, you can use this in place of the full
database compaction if you know a specific set of view indexes have been
affected by a recent database change.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>ddoc</strong> &#8211; Design document name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Compaction request has been accepted</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid database name</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Design document not found</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.16">415 Unsupported Media Type</a> &#8211; Bad <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> value</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db/_compact/posts</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre>HTTP/1.1 202 Accepted
Cache-Control: must-revalidate
Content-Length: 12
Content-Type: application/json
Date: Mon, 12 Aug 2013 09:36:44 GMT
Server: CouchDB (Erlang/OTP)

{
    &quot;ok&quot;: true
}

.. note::

  View indexes are stored in a separate ``.couch`` file based on
  a hash of the design document&#39;s relevant functions, in a sub directory
  of where the main ``.couch`` database files are located.
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-ensure-full-commit">
<span id="api-db-ensure-full-commit"></span><h4><tt class="docutils literal"><span class="pre">/db/_ensure_full_commit</span></tt><a class="headerlink" href="#db-ensure-full-commit" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--db-_ensure_full_commit">
<tt class="descname">POST </tt><tt class="descname">/{db}/_ensure_full_commit</tt><a class="headerlink" href="#post--db-_ensure_full_commit" title="Permalink to this definition">¶</a></dt>
<dd><p>Commits any recent changes to the specified database to disk. You should
call this if you want to ensure that recent changes have been flushed.
This function is likely not required, assuming you have the recommended
configuration setting of <tt class="docutils literal"><span class="pre">delayed_commits=false</span></tt>, which requires CouchDB
to ensure changes are written to disk before a 200 or similar result is
returned.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>instance_start_time</strong> (<em>string</em>) &#8211; Timestamp of when the database was opened,
expressed in microseconds since the epoch.</li>
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> &#8211; Commit completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid database name</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.16">415 Unsupported Media Type</a> &#8211; Bad <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> value</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db/_ensure_full_commit</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">53</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 10:22:19 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;instance_start_time&quot;</span><span class="p">:</span> <span class="s2">&quot;1376269047459338&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-view-cleanup">
<span id="api-db-view-cleanup"></span><h4><tt class="docutils literal"><span class="pre">/db/_view_cleanup</span></tt><a class="headerlink" href="#db-view-cleanup" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--db-_view_cleanup">
<tt class="descname">POST </tt><tt class="descname">/{db}/_view_cleanup</tt><a class="headerlink" href="#post--db-_view_cleanup" title="Permalink to this definition">¶</a></dt>
<dd><p>Removes view index files that are no longer required by CouchDB as a result
of changed views within design documents. As the view filename is based on
a hash of the view functions, over time old views will remain, consuming
storage. This call cleans up the cached view output on disk for a given view.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Compaction request has been accepted</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid database name</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.16">415 Unsupported Media Type</a> &#8211; Bad <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> value</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db/_view_cleanup</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">202</span> <span class="ne">Accepted</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">12</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 09:27:43 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<span id="document-api/database/security"></span><div class="section" id="db-security">
<span id="api-db-security"></span><h4><tt class="docutils literal"><span class="pre">/db/_security</span></tt><a class="headerlink" href="#db-security" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_security">
<tt class="descname">GET </tt><tt class="descname">/{db}/_security</tt><a class="headerlink" href="#get--db-_security" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the current security object from the specified database.</p>
<p>The security object consists of two compulsory elements, <tt class="docutils literal"><span class="pre">admins</span></tt>
and <tt class="docutils literal"><span class="pre">members</span></tt>, which are used to specify the list of users and/or roles
that have admin and members rights to the database respectively:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">members</span></tt>: they can read all types of documents from the DB, and they can
write (and edit) documents to the DB except for design documents.</li>
<li><tt class="docutils literal"><span class="pre">admins</span></tt>: they have all the privileges of <tt class="docutils literal"><span class="pre">members</span></tt> plus the privileges:
write (and edit) design documents, add/remove database admins and members,
set the <a class="reference internal" href="contents.html#api-db-revs-limit"><em>database revisions limit</em></a> and execute
<a class="reference internal" href="contents.html#api-db-temp-view"><em>temporary views</em></a> against the database.
They can not create a database nor delete a database.</li>
</ul>
<p>Both <tt class="docutils literal"><span class="pre">members</span></tt> and <tt class="docutils literal"><span class="pre">admins</span></tt> objects are contains two array-typed fields:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">users</span></tt>: List of CouchDB user names</li>
<li><tt class="docutils literal"><span class="pre">roles</span></tt>: List of users roles</li>
</ul>
<p>Any other additional fields in the security object are optional.
The entire security object is made available to validation and other
internal functions so that the database can control and limit functionality.</p>
<p>If both the names and roles fields of either the admins or members properties
are empty arrays, it means the database has no admins or members.</p>
<p>Having no admins, only server admins (with the reserved <tt class="docutils literal"><span class="pre">_admin</span></tt> role)
are able to update design document and make other admin level changes.</p>
<p>Having no members, any user can write regular documents (any non-design
document) and read documents from the database.</p>
<p>If there are any member names or roles defined for a database, then only
authenticated users having a matching name or role are allowed to
read documents from the database (or do a <a class="reference internal" href="contents.html#get--db" title="GET /{db}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}</span></tt></a> call).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If the security object for a database has never been set, then the
value returned will be empty.</p>
<p class="last">Also note, that security objects are not regular versioned documents
(that is, they are not under MVCC rules). This is a design choice to
speedup authorization checks (avoids traversing a database`s documents
B-Tree).</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>admins</strong> (<em>object</em>) &#8211; Object with two fields as <tt class="docutils literal"><span class="pre">names</span></tt> and <tt class="docutils literal"><span class="pre">roles</span></tt>.
See description above for more info.</li>
<li><strong>members</strong> (<em>object</em>) &#8211; Object with two fields as <tt class="docutils literal"><span class="pre">names</span></tt> and <tt class="docutils literal"><span class="pre">roles</span></tt>.
See description above for more info.</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/db/_security</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">109</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 19:05:29 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;admins&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;superuser&quot;</span>
        <span class="p">],</span>
        <span class="nt">&quot;roles&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;admins&quot;</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;members&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;user1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;user2&quot;</span>
        <span class="p">],</span>
        <span class="nt">&quot;roles&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;developers&quot;</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="put">
<dt id="put--db-_security">
<tt class="descname">PUT </tt><tt class="descname">/{db}/_security</tt><a class="headerlink" href="#put--db-_security" title="Permalink to this definition">¶</a></dt>
<dd><p>Sets the security object for the given database.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Request JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>admins</strong> (<em>object</em>) &#8211; Object with two fields as <tt class="docutils literal"><span class="pre">names</span></tt> and <tt class="docutils literal"><span class="pre">roles</span></tt>.
<a class="reference internal" href="contents.html#api-db-security"><em>See description above for more info</em></a>.</li>
<li><strong>members</strong> (<em>object</em>) &#8211; Object with two fields as <tt class="docutils literal"><span class="pre">names</span></tt> and <tt class="docutils literal"><span class="pre">roles</span></tt>.
<a class="reference internal" href="contents.html#api-db-security"><em>See description above for more info</em></a>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; CouchDB Server Administrator privileges required</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/db/_security</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">121</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;admins&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;superuser&quot;</span>
        <span class="p">],</span>
        <span class="nt">&quot;roles&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;admins&quot;</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;members&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;names&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;user1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;user2&quot;</span>
        <span class="p">],</span>
        <span class="nt">&quot;roles&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;developers&quot;</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">12</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 13 Aug 2013 11:26:28 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<span id="document-api/database/temp-views"></span><div class="section" id="db-temp-view">
<span id="api-db-temp-view"></span><h4><tt class="docutils literal"><span class="pre">/db/_temp_view</span></tt><a class="headerlink" href="#db-temp-view" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--db-_temp_view">
<tt class="descname">POST </tt><tt class="descname">/{db}/_temp_view</tt><a class="headerlink" href="#post--db-_temp_view" title="Permalink to this definition">¶</a></dt>
<dd><p>Creates (and executes) a temporary view based on the view function
supplied in the JSON request.</p>
<p>The arguments also available to standard view requests also apply to
temporary views, but the execution of the view may take some time as it
relies on being executed at the time of the request. This means that for
every temporary view you create, the entire database will be read
one doc at a time and passed through the view function.</p>
<p>This should not be used on production CouchDB instances, and is purely a
convenience function for quick development testing. You should use a
defined view if you want to achieve the best performance.</p>
<p>See <a class="reference internal" href="contents.html#api-ddoc-view"><em>/db/_design/design-doc/_view/view-name</em></a> for more info.</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db/_temp_view?group=true</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">92</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;map&quot;</span><span class="p">:</span> <span class="s2">&quot;function(doc) { if (doc.value) { emit(doc.value, null); } }&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reduce&quot;</span><span class="p">:</span> <span class="s2">&quot;_count&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 13 Aug 2013 12:28:12 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;AU33B3N7S9K4SAZSFA048HVB4&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">-10</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<span id="document-api/database/misc"></span><div class="section" id="db-purge">
<span id="api-db-purge"></span><h4><tt class="docutils literal"><span class="pre">/db/_purge</span></tt><a class="headerlink" href="#db-purge" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--db-_purge">
<tt class="descname">POST </tt><tt class="descname">/{db}/_purge</tt><a class="headerlink" href="#post--db-_purge" title="Permalink to this definition">¶</a></dt>
<dd><p>A database purge permanently removes the references to deleted documents
from the database. Normal deletion of a document within CouchDB does not
remove the document from the database, instead, the document is marked as
<tt class="docutils literal"><span class="pre">_deleted=true</span></tt> (and a new revision is created). This is to ensure that
deleted documents can be replicated to other databases as having been
deleted. This also means that you can check the status of a document and
identify that the document has been deleted by its absence.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Purging a document from a database should only be done as a last resort
when sensitive information has been introduced inadvertently into a
database. In clustered or replicated environments it is very difficult
to guarantee that a particular purged document has been removed from all
replicas. Do not rely on this API as a way of doing secure deletion.</p>
</div>
<p>The purge operation removes the references to the deleted documents from
the database. The purging of old documents is not replicated to other
databases. If you are replicating between databases and have deleted a
large number of documents you should run purge on each database.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Purging documents does not remove the space used by them on disk. To
reclaim disk space, you should run a database compact (see
<a class="reference internal" href="contents.html#api-db-compact"><em>/db/_compact</em></a>), and compact views (see <a class="reference internal" href="contents.html#api-db-compact-ddoc"><em>/db/_compact/design-doc</em></a>).</p>
</div>
<p>The format of the request must include the document ID and one or more
revisions that must be purged.</p>
<p>The response will contain the purge sequence number, and a list of the
document IDs and revisions successfully purged.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Request JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>object</strong> &#8211; Mapping of document ID to list of revisions to purge</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>purge_seq</strong> (<em>number</em>) &#8211; Purge sequence number</li>
<li><strong>purged</strong> (<em>object</em>) &#8211; Mapping of document ID to list of purged revisions</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid database name or JSON payload</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.16">415 Unsupported Media Type</a> &#8211; Bad <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> value</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db/_purge</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">76</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
  <span class="nt">&quot;c6114c65e295552ab1019e2b046b10e&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;3-b06fcd1c1c9e0ec7c480ee8aa467bf3b&quot;</span><span class="p">,</span>
    <span class="s2">&quot;3-0e871ef78849b0c206091f1a7af6ec41&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">103</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 10:53:24 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
  <span class="nt">&quot;purge_seq&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
  <span class="nt">&quot;purged&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;c6114c65e295552ab1019e2b046b10e&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;3-b06fcd1c1c9e0ec7c480ee8aa467bf3b&quot;</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="updating-indexes">
<h5>Updating Indexes<a class="headerlink" href="#updating-indexes" title="Permalink to this headline">¶</a></h5>
<p>The number of purges on a database is tracked using a purge sequence.
This is used by the view indexer to optimize the updating of views that
contain the purged documents.</p>
<p>When the indexer identifies that the purge sequence on a database has
changed, it compares the purge sequence of the database with that stored
in the view index. If the difference between the stored sequence and
database is sequence is only 1, then the indexer uses a cached list of
the most recently purged documents, and then removes these documents
from the index individually. This prevents completely rebuilding the
index from scratch.</p>
<p>If the difference between the stored sequence number and current
database sequence is greater than 1, then the view index is entirely
rebuilt. This is an expensive operation as every document in the
database must be examined.</p>
</div>
</div>
<div class="section" id="db-missing-revs">
<span id="api-db-missing-revs"></span><h4><tt class="docutils literal"><span class="pre">/db/_missing_revs</span></tt><a class="headerlink" href="#db-missing-revs" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--db-_missing_revs">
<tt class="descname">POST </tt><tt class="descname">/{db}/_missing_revs</tt><a class="headerlink" href="#post--db-_missing_revs" title="Permalink to this definition">¶</a></dt>
<dd><p>With given a list of document revisions, returns the document revisions that
do not exist in the database.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Request JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>object</strong> &#8211; Mapping of document ID to list of revisions to lookup</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>missing_revs</strong> (<em>object</em>) &#8211; Mapping of document ID to list of missed revisions</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid database name or JSON payload</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db/_missing_revs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">76</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
  <span class="nt">&quot;c6114c65e295552ab1019e2b046b10e&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;3-b06fcd1c1c9e0ec7c480ee8aa467bf3b&quot;</span><span class="p">,</span>
    <span class="s2">&quot;3-0e871ef78849b0c206091f1a7af6ec41&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">64</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 10:53:24 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
  <span class="nt">&quot;missed_revs&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;c6114c65e295552ab1019e2b046b10e&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;3-b06fcd1c1c9e0ec7c480ee8aa467bf3b&quot;</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-revs-diff">
<span id="api-db-revs-diff"></span><h4><tt class="docutils literal"><span class="pre">/db/_revs_diff</span></tt><a class="headerlink" href="#db-revs-diff" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--db-_revs_diff">
<tt class="descname">POST </tt><tt class="descname">/{db}/_revs_diff</tt><a class="headerlink" href="#post--db-_revs_diff" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a set of document/revision IDs, returns the subset of those that do
not correspond to revisions stored in the database.</p>
<p>Its primary use is by the replicator, as an important optimization: after
receiving a set of new revision IDs from the source database, the replicator
sends this set to the destination database&#8217;s <tt class="docutils literal"><span class="pre">_revs_diff</span></tt> to find out which
of them already exist there. It can then avoid fetching and sending
already-known document bodies.</p>
<p>Both the request and response bodies are JSON objects whose keys are document
IDs; but the values are structured differently:</p>
<ul class="simple">
<li>In the request, a value is an array of revision IDs for that document.</li>
<li>In the response, a value is an object with a <tt class="docutils literal"><span class="pre">missing</span></tt>: key, whose value
is a list of revision IDs for that document (the ones that are not stored
in the database) and optionally a <tt class="docutils literal"><span class="pre">possible_ancestors</span></tt> key, whose value is
an array of revision IDs that are known that might be ancestors of
the missing revisions.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Request JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>object</strong> &#8211; Mapping of document ID to list of revisions to lookup</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>missing</strong> (<em>array</em>) &#8211; List of missed revisions for specified document</li>
<li><strong>possible_ancestors</strong> (<em>array</em>) &#8211; List of revisions that <em>may be</em> ancestors
for specified document and its current revision in requested database</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid database name or JSON payload</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/db/_revs_diff</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">113</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
  <span class="nt">&quot;190f721ca3411be7aa9477db5f948bbb&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;3-bb72a7682290f94a985f7afac8b27137&quot;</span><span class="p">,</span>
    <span class="s2">&quot;4-10265e5a26d807a3cfa459cf1a82ef2e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;5-067a00dff5e02add41819138abb3284d&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">88</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 16:56:02 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
  <span class="nt">&quot;190f721ca3411be7aa9477db5f948bbb&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;missing&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;3-bb72a7682290f94a985f7afac8b27137&quot;</span><span class="p">,</span>
      <span class="s2">&quot;5-067a00dff5e02add41819138abb3284d&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;possible_ancestors&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;4-10265e5a26d807a3cfa459cf1a82ef2e&quot;</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-revs-limit">
<span id="api-db-revs-limit"></span><h4><tt class="docutils literal"><span class="pre">/db/_revs_limit</span></tt><a class="headerlink" href="#db-revs-limit" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_revs_limit">
<tt class="descname">GET </tt><tt class="descname">/{db}/_revs_limit</tt><a class="headerlink" href="#get--db-_revs_limit" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets the current <tt class="docutils literal"><span class="pre">revs_limit</span></tt> (revision limit) setting.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/db/_revs_limit</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">5</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 17:27:30 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="mi">1000</span>
</pre></div>
</div>
</dd></dl>

<dl class="put">
<dt id="put--db-_revs_limit">
<tt class="descname">PUT </tt><tt class="descname">/{db}/_revs_limit</tt><a class="headerlink" href="#put--db-_revs_limit" title="Permalink to this definition">¶</a></dt>
<dd><p>Sets the maximum number of document revisions that will be tracked by
CouchDB, even after compaction has occurred. You can set the revision
limit on a database with a scalar integer of the limit that you want
to set as the request body.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid JSON data</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/db/_revs_limit</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">5</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="mi">1000</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">12</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Mon, 12 Aug 2013 17:47:52 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
</div>
<span id="document-api/document/index"></span><div class="section" id="documents">
<span id="api-document"></span><h3>Documents<a class="headerlink" href="#documents" title="Permalink to this headline">¶</a></h3>
<p>Details on how to create, read, update and delete documents within a database.</p>
<div class="toctree-wrapper compound">
<span id="document-api/document/common"></span><div class="section" id="db-doc">
<span id="api-doc"></span><h4><tt class="docutils literal"><span class="pre">/db/doc</span></tt><a class="headerlink" href="#db-doc" title="Permalink to this headline">¶</a></h4>
<dl class="head">
<dt id="head--db-docid">
<tt class="descname">HEAD </tt><tt class="descname">/{db}/{docid}</tt><a class="headerlink" href="#head--db-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the HTTP Headers containing a minimal amount of information
about the specified document. The method supports the same query
arguments as the <a class="reference internal" href="contents.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}</span></tt></a> method, but only the header
information (including document size, and the revision as an ETag), is
returned.</p>
<p>The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> header shows the current revision for the requested
document, and the <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.13">Content-Length</a> specifies the length of the
data, if the document were requested in full.</p>
<p>Adding any of the query arguments (see <a class="reference internal" href="contents.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}</span></tt></a>), then the
resulting HTTP Headers will correspond to what would be returned.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.26">If-None-Match</a> &#8211; Double quoted document&#8217;s revision token</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.13">Content-Length</a> &#8211; Document size</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Double quoted document&#8217;s revision token</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Document exists</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.5">304 Not Modified</a> &#8211; Document wasn&#8217;t modified since specified revision</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Read privilege required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Document not found</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/db/SpaghettiWithMeatballs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">660</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 13 Aug 2013 21:35:37 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;12-151bb8678d45aaa949ec3698ef1c7e78&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
</pre></div>
</div>
</dd></dl>

<dl class="get">
<dt id="get--db-docid">
<tt class="descname">GET </tt><tt class="descname">/{db}/{docid}</tt><a class="headerlink" href="#get--db-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns document by the specified <tt class="docutils literal"><span class="pre">docid</span></tt> from the specified <tt class="docutils literal"><span class="pre">db</span></tt>.
Unless you request a specific revision, the latest revision of the
document will always be returned.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">multipart/mixed</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.26">If-None-Match</a> &#8211; Double quoted document&#8217;s revision token</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>attachments</strong> (<em>boolean</em>) &#8211; Includes attachments bodies in response.
Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><strong>att_encoding_info</strong> (<em>boolean</em>) &#8211; Includes encoding information in attachment
stubs if the particular attachment is compressed. Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>atts_since</strong> (<em>array</em>) &#8211; Includes attachments only since specified revisions.
Doesn&#8217;t includes attachments for specified revisions. <em>Optional</em></li>
<li><strong>conflicts</strong> (<em>boolean</em>) &#8211; Includes information about conflicts in document.
Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><strong>deleted_conflicts</strong> (<em>boolean</em>) &#8211; Includes information about deleted
conflicted revisions. Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><strong>latest</strong> (<em>boolean</em>) &#8211; Forces retrieving latest &#8220;leaf&#8221; revision, no matter
what <cite>rev</cite> was requested. Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><strong>local_seq</strong> (<em>boolean</em>) &#8211; Includes last update sequence number for the
document. Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><strong>meta</strong> (<em>boolean</em>) &#8211; Acts same as specifying all <cite>conflicts</cite>,
<cite>deleted_conflicts</cite> and <cite>open_revs</cite> query parameters. Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><strong>open_revs</strong> (<em>array</em>) &#8211; Retrieves documents of specified leaf revisions.
Additionally, it accepts value as <tt class="docutils literal"><span class="pre">all</span></tt> to return all leaf revisions.
<em>Optional</em></li>
<li><strong>rev</strong> (<em>string</em>) &#8211; Retrieves document of specified revision. <em>Optional</em></li>
<li><strong>revs</strong> (<em>boolean</em>) &#8211; Includes list of all known document revisions.
Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><strong>revs_info</strong> (<em>boolean</em>) &#8211; Includes detailed information for all known
document revisions. Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">multipart/mixed</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Double quoted document&#8217;s revision token. Not available when
retrieving conflicts-related information</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.41">Transfer-Encoding</a> &#8211; <tt class="docutils literal"><span class="pre">chunked</span></tt>. Available if requested with
query parameter <tt class="docutils literal"><span class="pre">open_revs</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>_id</strong> (<em>string</em>) &#8211; Document ID</li>
<li><strong>_rev</strong> (<em>string</em>) &#8211; Revision MVCC token</li>
<li><strong>_deleted</strong> (<em>boolean</em>) &#8211; Deletion flag. Available if document was removed</li>
<li><strong>_attachments</strong> (<em>object</em>) &#8211; Attachment&#8217;s stubs. Available if document has
any attachments</li>
<li><strong>_conflicts</strong> (<em>array</em>) &#8211; List of conflicted revisions. Available if requested
with <tt class="docutils literal"><span class="pre">conflicts=true</span></tt> query parameter</li>
<li><strong>_deleted_conflicts</strong> (<em>array</em>) &#8211; List of deleted conflicted revisions.
Available if requested with <tt class="docutils literal"><span class="pre">deleted_conflicts=true</span></tt> query parameter</li>
<li><strong>_local_seq</strong> (<em>number</em>) &#8211; Document&#8217;s sequence number in current database.
Available if requested with <tt class="docutils literal"><span class="pre">local_seq=true</span></tt> query parameter</li>
<li><strong>_revs_info</strong> (<em>array</em>) &#8211; List of objects with information about local
revisions and their status. Available if requested with <tt class="docutils literal"><span class="pre">open_revs</span></tt> query
parameter</li>
<li><strong>_revisions</strong> (<em>object</em>) &#8211; List of local revision tokens without.
Available if requested with <tt class="docutils literal"><span class="pre">revs=true</span></tt> query parameter</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.5">304 Not Modified</a> &#8211; Document wasn&#8217;t modified since specified revision</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; The format of the request or revision was invalid</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Read privilege required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Document not found</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/SpaghettiWithMeatballs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">660</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 13 Aug 2013 21:35:37 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;1-917fa2381192822767f010b95b45325b&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-917fa2381192822767f010b95b45325b&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
        <span class="s2">&quot;meatballs&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="put">
<dt id="put--db-docid">
<tt class="descname">PUT </tt><tt class="descname">/{db}/{docid}</tt><a class="headerlink" href="#put--db-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">PUT</a> method creates a new named document, or creates a new
revision of the existing document. Unlike the <a class="reference internal" href="contents.html#post--db" title="POST /{db}"><tt class="xref http http-post docutils literal"><span class="pre">POST</span> <span class="pre">/{db}</span></tt></a>, you
must specify the document ID in the request URL.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <em class="mimetype">application/json</em></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> &#8211; Document&#8217;s revision. Alternative to <cite>rev</cite> query parameter</li>
<li><strong>X-Couch-Full-Commit</strong> &#8211; Overrides server&#8217;s
<a class="reference internal" href="contents.html#couchdb/delayed_commits" title="delayed_commits"><tt class="xref config config-option docutils literal"><span class="pre">commit</span> <span class="pre">policy</span></tt></a>. Possible values
are: <tt class="docutils literal"><span class="pre">false</span></tt> and <tt class="docutils literal"><span class="pre">true</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>batch</strong> (<em>string</em>) &#8211; Stores document in <a class="reference internal" href="contents.html#api-doc-batch-writes"><em>batch mode</em></a> Possible values: <tt class="docutils literal"><span class="pre">ok</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Quoted document&#8217;s new revision</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.3">Location</a> &#8211; Document URI</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>id</strong> (<em>string</em>) &#8211; Document ID</li>
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
<li><strong>rev</strong> (<em>string</em>) &#8211; Revision MVCC token</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> &#8211; Document created and stored on disk</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Document data accepted, but not yet stored on disk</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid request body or parameters</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Write privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Specified database or document ID doesn&#8217;t exists</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.10">409 Conflict</a> &#8211; Document with the specified ID already exists or specified
revision is not latest for target document</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/recipes/SpaghettiWithMeatballs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">196</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
        <span class="s2">&quot;meatballs&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">85</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 20:31:39 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;1-917fa2381192822767f010b95b45325b&quot;</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/recipes/SpaghettiWithMeatballs</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-917fa2381192822767f010b95b45325b&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="delete">
<dt id="delete--db-docid">
<tt class="descname">DELETE </tt><tt class="descname">/{db}/{docid}</tt><a class="headerlink" href="#delete--db-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>Marks the specified document as deleted by adding a field <tt class="docutils literal"><span class="pre">_deleted</span></tt> with
the value <tt class="docutils literal"><span class="pre">true</span></tt>. Documents with this field will not be returned within
requests anymore, but stay in the database. You must supply the current
(latest) revision, either by using the <tt class="docutils literal"><span class="pre">rev</span></tt> parameter or by using the
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> header to specify the revision.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#api-doc-retrieving-deleted-documents"><em>Retrieving Deleted Documents</em></a></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CouchDB doesn&#8217;t actually delete documents. The reason is the need to track
them correctly during the replication process between databases to prevent
accidental document recovery for any previous state.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> &#8211; Document&#8217;s revision. Alternative to <cite>rev</cite> query parameter</li>
<li><strong>X-Couch-Full-Commit</strong> &#8211; Overrides server&#8217;s
<a class="reference internal" href="contents.html#couchdb/delayed_commits" title="delayed_commits"><tt class="xref config config-option docutils literal"><span class="pre">commit</span> <span class="pre">policy</span></tt></a>. Possible values
are: <tt class="docutils literal"><span class="pre">false</span></tt> and <tt class="docutils literal"><span class="pre">true</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>rev</strong> (<em>string</em>) &#8211; Actual document&#8217;s revision</li>
<li><strong>batch</strong> (<em>string</em>) &#8211; Stores document in <a class="reference internal" href="contents.html#api-doc-batch-writes"><em>batch mode</em></a> Possible values: <tt class="docutils literal"><span class="pre">ok</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Double quoted document&#8217;s new revision</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>id</strong> (<em>string</em>) &#8211; Document ID</li>
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
<li><strong>rev</strong> (<em>string</em>) &#8211; Revision MVCC token</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Document successfully removed</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Request was accepted, but changes are not yet stored on disk</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid request body or parameters</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Write privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Specified database or document ID doesn&#8217;t exists</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.10">409 Conflict</a> &#8211; Specified revision is not the latest for target document</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">DELETE</span> <span class="nn">/recipes/FishStew?rev=1-9c65296036141e575d32ba9c034dd3ee</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p>Alternatively, instead of <tt class="docutils literal"><span class="pre">rev</span></tt> query parameter you may use
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> header:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">DELETE</span> <span class="nn">/recipes/FishStew</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">If-Match</span><span class="o">:</span> <span class="l">1-9c65296036141e575d32ba9c034dd3ee</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">71</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 12:23:13 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;2-056f5f44046ecafc08a2bc2b9c229e20&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-056f5f44046ecafc08a2bc2b9c229e20&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="copy">
<dt id="copy--db-docid">
<tt class="descname">COPY </tt><tt class="descname">/{db}/{docid}</tt><a class="headerlink" href="#copy--db-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference external" href="http://tools.ietf.org/html/rfc2518#section-8.8">COPY</a> (which is non-standard HTTP) copies an existing
document to a new or existing document.</p>
<p>The source document is specified on the request line, with the
<a class="reference external" href="http://tools.ietf.org/html/rfc2518#section-9.3">Destination</a> header of the request specifying the target
document.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://tools.ietf.org/html/rfc2518#section-9.3">Destination</a> &#8211; Destination document</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> &#8211; Source document&#8217;s revision. Alternative to <cite>rev</cite> query
parameter</li>
<li><strong>X-Couch-Full-Commit</strong> &#8211; Overrides server&#8217;s
<a class="reference internal" href="contents.html#couchdb/delayed_commits" title="delayed_commits"><tt class="xref config config-option docutils literal"><span class="pre">commit</span> <span class="pre">policy</span></tt></a>. Possible values
are: <tt class="docutils literal"><span class="pre">false</span></tt> and <tt class="docutils literal"><span class="pre">true</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>rev</strong> (<em>string</em>) &#8211; Revision to copy from. <em>Optional</em></li>
<li><strong>batch</strong> (<em>string</em>) &#8211; Stores document in <a class="reference internal" href="contents.html#api-doc-batch-writes"><em>batch mode</em></a> Possible values: <tt class="docutils literal"><span class="pre">ok</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Double quoted document&#8217;s new revision</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.3">Location</a> &#8211; Document URI</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>id</strong> (<em>string</em>) &#8211; Document document ID</li>
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
<li><strong>rev</strong> (<em>string</em>) &#8211; Revision MVCC token</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> &#8211; Document successfully created</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Request was accepted, but changes are not yet stored on disk</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid request body or parameters</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Read or write privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Specified database, document ID  or revision doesn&#8217;t exists</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.10">409 Conflict</a> &#8211; Document with the specified ID already exists or specified
revision is not latest for target document</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre>COPY /recipes/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Destination: SpaghettiWithMeatballs_Italian
Host: localhost:5984
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">93</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 14:21:00 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;1-e86fdf912560c2321a5fcefc6264e6d9&quot;</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/recipes/SpaghettiWithMeatballs_Italian</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs_Italian&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-e86fdf912560c2321a5fcefc6264e6d9&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="attachments">
<span id="api-doc-attachments"></span><h5>Attachments<a class="headerlink" href="#attachments" title="Permalink to this headline">¶</a></h5>
<p>If the document includes attachments, then the returned structure will
contain a summary of the attachments associated with the document, but
not the attachment data itself.</p>
<p>The JSON for the returned document will include the <tt class="docutils literal"><span class="pre">_attachments</span></tt>
field, with one or more attachment definitions.</p>
<p>The <tt class="docutils literal"><span class="pre">_attachments</span></tt> object keys are attachments names while values are
information objects with next structure:</p>
<ul>
<li><p class="first"><strong>content_type</strong> (<em>string</em>): Attachment MIME type</p>
</li>
<li><p class="first"><strong>data</strong> (<em>string</em>): Base64-encoded content. Available if attachment content
is requested by using the following query parameters:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">attachments=true</span></tt> when querying a document</li>
<li><tt class="docutils literal"><span class="pre">attachments=true&amp;include_docs=true</span></tt> when querying a
<a class="reference internal" href="contents.html#api-db-changes"><em>changes feed</em></a> or a <a class="reference internal" href="contents.html#api-ddoc-view"><em>view</em></a></li>
<li><tt class="docutils literal"><span class="pre">atts_since</span></tt>.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><strong>digest</strong> (<em>string</em>): Content hash digest.
It starts with prefix which announce hash type (<tt class="docutils literal"><span class="pre">md5-</span></tt>) and continues with
Base64-encoded hash digest</p>
</li>
<li><p class="first"><strong>encoded_length</strong> (<em>number</em>): Compressed attachment size in bytes.
Available if <tt class="docutils literal"><span class="pre">content_type</span></tt> is in <a class="reference internal" href="contents.html#attachments/compressible_types" title="compressible_types"><tt class="xref config config-option docutils literal"><span class="pre">list</span> <span class="pre">of</span> <span class="pre">compressible</span> <span class="pre">types</span></tt></a> when the attachment was added and the
following query parameters are specified:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">att_encoding_info=true</span></tt> when querying a document</li>
<li><tt class="docutils literal"><span class="pre">att_encoding_info=true&amp;include_docs=true</span></tt> when querying a
<a class="reference internal" href="contents.html#api-db-changes"><em>changes feed</em></a> or a <a class="reference internal" href="contents.html#api-ddoc-view"><em>view</em></a></li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><strong>encoding</strong> (<em>string</em>): Compression codec. Available if <tt class="docutils literal"><span class="pre">content_type</span></tt> is
in <a class="reference internal" href="contents.html#attachments/compressible_types" title="compressible_types"><tt class="xref config config-option docutils literal"><span class="pre">list</span> <span class="pre">of</span> <span class="pre">compressible</span> <span class="pre">types</span></tt></a> when the attachment was added and the
following query parameters are specified:</p>
<blockquote>
<div><ul class="simple">
<li><tt class="docutils literal"><span class="pre">att_encoding_info=true</span></tt> when querying a document</li>
<li><tt class="docutils literal"><span class="pre">att_encoding_info=true&amp;include_docs=true</span></tt> when querying a
<a class="reference internal" href="contents.html#api-db-changes"><em>changes feed</em></a> or a <a class="reference internal" href="contents.html#api-ddoc-view"><em>view</em></a></li>
</ul>
</div></blockquote>
</li>
<li><p class="first"><strong>length</strong> (<em>number</em>): Real attachment size in bytes. Not available if attachment
content requested</p>
</li>
<li><p class="first"><strong>revpos</strong> (<em>number</em>): Revision <em>number</em> when attachment was added</p>
</li>
<li><p class="first"><strong>stub</strong> (<em>boolean</em>): Has <tt class="docutils literal"><span class="pre">true</span></tt> value if object contains stub info and no
content. Otherwise omitted in response</p>
</li>
</ul>
<div class="section" id="basic-attachments-info">
<h6>Basic Attachments Info<a class="headerlink" href="#basic-attachments-info" title="Permalink to this headline">¶</a></h6>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/SpaghettiWithMeatballs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">660</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 13 Aug 2013 21:35:37 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;5-fd96acb3256302bf0dd2f32713161f2a&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;_attachments&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;grandma_recipe.txt&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-Ids41vtv725jyrN7iUvMcQ==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;length&quot;</span><span class="p">:</span> <span class="mi">1872</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="nt">&quot;stub&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="nt">&quot;my_recipe.txt&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-198BPPNiT5fqlLxoYYbjBA==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;length&quot;</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="nt">&quot;stub&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="nt">&quot;photo.jpg&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-7Pv4HW2822WY1r/3WDbPug==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;length&quot;</span><span class="p">:</span> <span class="mi">165504</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;stub&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;5-fd96acb3256302bf0dd2f32713161f2a&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
        <span class="s2">&quot;meatballs&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="retrieving-attachments-content">
<span id="api-doc-retrieving-deleted-documents"></span><h6>Retrieving Attachments Content<a class="headerlink" href="#retrieving-attachments-content" title="Permalink to this headline">¶</a></h6>
<p>It&#8217;s possible to retrieve document with all attached files content by using
<tt class="docutils literal"><span class="pre">attachements=true</span></tt> query parameter:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/db/pixel?attachments=true</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">553</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 11:32:40 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;4-f1bcae4bf7bbb92310079e632abfe3f4&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;_attachments&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;pixel.gif&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;image/gif&quot;</span><span class="p">,</span>
            <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-2JdGiI2i2VELZKnwMers1Q==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">},</span>
        <span class="nt">&quot;pixel.png&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;image/png&quot;</span><span class="p">,</span>
            <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAAXNSR0IArs4c6QAAAANQTFRFAAAAp3o92gAAAAF0Uk5TAEDm2GYAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3QgOCx8VHgmcNwAAAApJREFUCNdjYAAAAAIAAeIhvDMAAAAASUVORK5CYII=&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-Dgf5zxgGuchWrve73evvGQ==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;pixel&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;4-f1bcae4bf7bbb92310079e632abfe3f4&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Or retrieve attached files content since specific revision using <tt class="docutils literal"><span class="pre">atts_since</span></tt>
query parameter:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/SpaghettiWithMeatballs?atts_since=[%224-874985bc28906155ba0e2e0538f67b05%22]</span>  <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">760</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 13 Aug 2013 21:35:37 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;5-fd96acb3256302bf0dd2f32713161f2a&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;_attachments&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;grandma_recipe.txt&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-Ids41vtv725jyrN7iUvMcQ==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;length&quot;</span><span class="p">:</span> <span class="mi">1872</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="nt">&quot;stub&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="nt">&quot;my_recipe.txt&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
            <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;MS4gQ29vayBzcGFnaGV0dGkKMi4gQ29vayBtZWV0YmFsbHMKMy4gTWl4IHRoZW0KNC4gQWRkIHRvbWF0byBzYXVjZQo1LiAuLi4KNi4gUFJPRklUIQ==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-198BPPNiT5fqlLxoYYbjBA==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">},</span>
        <span class="nt">&quot;photo.jpg&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-7Pv4HW2822WY1r/3WDbPug==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;length&quot;</span><span class="p">:</span> <span class="mi">165504</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;stub&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;5-fd96acb3256302bf0dd2f32713161f2a&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
        <span class="s2">&quot;meatballs&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="efficient-multiple-attachments-retrieving">
<h7>Efficient Multiple Attachments Retrieving<a class="headerlink" href="#efficient-multiple-attachments-retrieving" title="Permalink to this headline">¶</a></h7>
<p>As you had noted above, retrieving document with <tt class="docutils literal"><span class="pre">attachements=true</span></tt> returns
large JSON object where all attachments are included.  While you document and
files are smaller it&#8217;s ok, but if you have attached something bigger like media
files (audio/video), parsing such response might be very expensive.</p>
<p>To solve this problem, CouchDB allows to get documents in
<em class="mimetype">multipart/related</em> format:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/secret?attachments=true</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">multipart/related</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">538</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/related; boundary=&quot;e89b3e29388aef23453450d10e5aaed0&quot;</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 28 Sep 2013 08:08:22 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;2-c1c6c44c4bc3c9344b037c8690468605&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

--e89b3e29388aef23453450d10e5aaed0
Content-Type: application/json

{&quot;_id&quot;:&quot;secret&quot;,&quot;_rev&quot;:&quot;2-c1c6c44c4bc3c9344b037c8690468605&quot;,&quot;_attachments&quot;:{&quot;recipe.txt&quot;:{&quot;content_type&quot;:&quot;text/plain&quot;,&quot;revpos&quot;:2,&quot;digest&quot;:&quot;md5-HV9aXJdEnu0xnMQYTKgOFA==&quot;,&quot;length&quot;:86,&quot;follows&quot;:true}}}
--e89b3e29388aef23453450d10e5aaed0
Content-Disposition: attachment; filename=&quot;recipe.txt&quot;
Content-Type: text/plain
Content-Length: 86

1. Take R
2. Take E
3. Mix with L
4. Add some A
5. Serve with X

--e89b3e29388aef23453450d10e5aaed0--
</pre></div>
</div>
<p>In this response the document contains only attachments stub information and
quite short while all attachments goes as separate entities which reduces
memory footprint and processing overhead (you&#8217;d noticed, that attachment content
goes as raw data, not in base64 encoding, right?).</p>
</div>
</div>
<div class="section" id="retrieving-attachments-encoding-info">
<h6>Retrieving Attachments Encoding Info<a class="headerlink" href="#retrieving-attachments-encoding-info" title="Permalink to this headline">¶</a></h6>
<p>By using <tt class="docutils literal"><span class="pre">att_encoding_info=true</span></tt> query parameter you may retrieve information
about compressed attachments size and used codec.</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/SpaghettiWithMeatballs?att_encoding_info=true</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">736</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Tue, 13 Aug 2013 21:35:37 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;5-fd96acb3256302bf0dd2f32713161f2a&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;_attachments&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;grandma_recipe.txt&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-Ids41vtv725jyrN7iUvMcQ==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;encoded_length&quot;</span><span class="p">:</span> <span class="mi">693</span><span class="p">,</span>
            <span class="nt">&quot;encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="nt">&quot;length&quot;</span><span class="p">:</span> <span class="mi">1872</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="nt">&quot;stub&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="nt">&quot;my_recipe.txt&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-198BPPNiT5fqlLxoYYbjBA==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;encoded_length&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="nt">&quot;encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="nt">&quot;length&quot;</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="nt">&quot;stub&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">},</span>
        <span class="nt">&quot;photo.jpg&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;content_type&quot;</span><span class="p">:</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
            <span class="nt">&quot;digest&quot;</span><span class="p">:</span> <span class="s2">&quot;md5-7Pv4HW2822WY1r/3WDbPug==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;length&quot;</span><span class="p">:</span> <span class="mi">165504</span><span class="p">,</span>
            <span class="nt">&quot;revpos&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;stub&quot;</span><span class="p">:</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;5-fd96acb3256302bf0dd2f32713161f2a&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
        <span class="s2">&quot;meatballs&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-multiple-attachments">
<h6>Creating Multiple Attachments<a class="headerlink" href="#creating-multiple-attachments" title="Permalink to this headline">¶</a></h6>
<p>To create a document with multiple attachments with single request you need
just inline base64 encoded attachments data into the document body:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="s2">&quot;multiple_attachments&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_attachments&quot;</span><span class="o">:</span>
  <span class="p">{</span>
    <span class="s2">&quot;foo.txt&quot;</span><span class="o">:</span>
    <span class="p">{</span>
      <span class="s2">&quot;content_type&quot;</span><span class="o">:</span><span class="s2">&quot;text\/plain&quot;</span><span class="p">,</span>
      <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="s2">&quot;VGhpcyBpcyBhIGJhc2U2NCBlbmNvZGVkIHRleHQ=&quot;</span>
    <span class="p">},</span>

   <span class="s2">&quot;bar.txt&quot;</span><span class="o">:</span>
    <span class="p">{</span>
      <span class="s2">&quot;content_type&quot;</span><span class="o">:</span><span class="s2">&quot;text\/plain&quot;</span><span class="p">,</span>
      <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="s2">&quot;VGhpcyBpcyBhIGJhc2U2NCBlbmNvZGVkIHRleHQ=&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Alternatively, you can upload a document with attachments more efficiently in
<em class="mimetype">multipart/related</em> format. This avoids having to Base64-encode
the attachments, saving CPU and bandwidth. To do this, set the
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> header of the <a class="reference internal" href="contents.html#put--db-docid" title="PUT /{db}/{docid}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/{db}/{docid}</span></tt></a> request to
<em class="mimetype">multipart/related</em>.</p>
<p>The first MIME body is the document itself, which should have its own
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> of <em class="mimetype">application/json&quot;</em>. It also should
include  an <tt class="docutils literal"><span class="pre">_attachments</span></tt> metadata object in which each attachment object
has a key <tt class="docutils literal"><span class="pre">follows</span></tt> with value <tt class="docutils literal"><span class="pre">true</span></tt>.</p>
<p>The subsequent MIME bodies are the attachments.</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/temp/somedoc</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">372</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">multipart/related;boundary=&quot;abc123&quot;</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">HTTPie/0.6.0</span>

--abc123
Content-Type: application/json

{
    &quot;body&quot;: &quot;This is a body.&quot;,
    &quot;_attachments&quot;: {
        &quot;foo.txt&quot;: {
            &quot;follows&quot;: true,
            &quot;content_type&quot;: &quot;text/plain&quot;,
            &quot;length&quot;: 21
        },
        &quot;bar.txt&quot;: {
            &quot;follows&quot;: true,
            &quot;content_type&quot;: &quot;text/plain&quot;,
            &quot;length&quot;: 20
        }
    }
}

--abc123

this is 21 chars long
--abc123

this is 20 chars lon
--abc123--
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">72</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 28 Sep 2013 09:13:24 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;1-5575e26acdeb1df561bb5b70b26ba151&quot;</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/temp/somedoc</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;somedoc&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-5575e26acdeb1df561bb5b70b26ba151&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="getting-a-list-of-revisions">
<h5>Getting a List of Revisions<a class="headerlink" href="#getting-a-list-of-revisions" title="Permalink to this headline">¶</a></h5>
<p>You can obtain a list of the revisions for a given document by adding
the <tt class="docutils literal"><span class="pre">revs=true</span></tt> parameter to the request URL:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/SpaghettiWithMeatballs?revs=true</span>  <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">584</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 11:38:26 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;5-fd96acb3256302bf0dd2f32713161f2a&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;8-6f5ad8db0f34af24a6e0984cd1a6cfb9&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_revisions&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;ids&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;6f5ad8db0f34af24a6e0984cd1a6cfb9&quot;</span><span class="p">,</span>
            <span class="s2">&quot;77fba3a059497f51ec99b9b478b569d2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;136813b440a00a24834f5cb1ddf5b1f1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fd96acb3256302bf0dd2f32713161f2a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;874985bc28906155ba0e2e0538f67b05&quot;</span><span class="p">,</span>
            <span class="s2">&quot;0de77a37463bf391d14283e626831f2e&quot;</span><span class="p">,</span>
            <span class="s2">&quot;d795d1b924777732fdea76538c558b62&quot;</span><span class="p">,</span>
            <span class="s2">&quot;917fa2381192822767f010b95b45325b&quot;</span>
        <span class="p">],</span>
        <span class="nt">&quot;start&quot;</span><span class="p">:</span> <span class="mi">8</span>
    <span class="p">},</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
        <span class="s2">&quot;meatballs&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The returned JSON structure includes the original document, including a
<tt class="docutils literal"><span class="pre">_revisions</span></tt> structure that includes the revision information in next form:</p>
<ul class="simple">
<li><strong>ids</strong> (<em>array</em>): Array of valid revision IDs, in reverse order
(latest first)</li>
<li><strong>start</strong> (<em>number</em>): Prefix number for the latest revision</li>
</ul>
</div>
<div class="section" id="obtaining-an-extended-revision-history">
<h5>Obtaining an Extended Revision History<a class="headerlink" href="#obtaining-an-extended-revision-history" title="Permalink to this headline">¶</a></h5>
<p>You can get additional information about the revisions for a given
document by supplying the <tt class="docutils literal"><span class="pre">revs_info</span></tt> argument to the query:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/SpaghettiWithMeatballs?revs_info=true</span>  <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">802</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 11:40:55 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;8-6f5ad8db0f34af24a6e0984cd1a6cfb9&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_revs_info&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;8-6f5ad8db0f34af24a6e0984cd1a6cfb9&quot;</span><span class="p">,</span>
            <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;available&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;7-77fba3a059497f51ec99b9b478b569d2&quot;</span><span class="p">,</span>
            <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;deleted&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;6-136813b440a00a24834f5cb1ddf5b1f1&quot;</span><span class="p">,</span>
            <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;available&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;5-fd96acb3256302bf0dd2f32713161f2a&quot;</span><span class="p">,</span>
            <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;missing&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;4-874985bc28906155ba0e2e0538f67b05&quot;</span><span class="p">,</span>
            <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;missing&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;3-0de77a37463bf391d14283e626831f2e&quot;</span><span class="p">,</span>
            <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;missing&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-d795d1b924777732fdea76538c558b62&quot;</span><span class="p">,</span>
            <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;missing&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-917fa2381192822767f010b95b45325b&quot;</span><span class="p">,</span>
            <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;missing&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
        <span class="s2">&quot;meatballs&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The returned document contains <tt class="docutils literal"><span class="pre">_revs_info</span></tt> field with extended revision
information, including the availability and status of each revision. This array
field contains objects with following structure:</p>
<ul class="simple">
<li><strong>rev</strong> (<em>string</em>): Full revision string</li>
<li><strong>status</strong> (<em>string</em>): Status of the revision.
Maybe one of:<ul>
<li><tt class="docutils literal"><span class="pre">available</span></tt>: Revision is available for retrieving with <cite>rev</cite> query
parameter</li>
<li><tt class="docutils literal"><span class="pre">missing</span></tt>: Revision is not available</li>
<li><tt class="docutils literal"><span class="pre">deleted</span></tt>: Revision belongs to deleted document</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="obtaining-a-specific-revision">
<h5>Obtaining a Specific Revision<a class="headerlink" href="#obtaining-a-specific-revision" title="Permalink to this headline">¶</a></h5>
<p>To get a specific revision, use the <tt class="docutils literal"><span class="pre">rev</span></tt> argument to the request, and
specify the full revision number. The specified revision of the document will
be returned, including a <tt class="docutils literal"><span class="pre">_rev</span></tt> field specifying the revision that was
requested.</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/SpaghettiWithMeatballs?rev=6-136813b440a00a24834f5cb1ddf5b1f1</span>  <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">271</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 11:40:55 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;6-136813b440a00a24834f5cb1ddf5b1f1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
        <span class="s2">&quot;meatballs&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="retrieving-deleted-documents">
<h6>Retrieving Deleted Documents<a class="headerlink" href="#retrieving-deleted-documents" title="Permalink to this headline">¶</a></h6>
<p>CouchDB doesn&#8217;t actually deletes documents via <a class="reference internal" href="contents.html#delete--db-docid" title="DELETE /{db}/{docid}"><tt class="xref http http-delete docutils literal"><span class="pre">DELETE</span> <span class="pre">/{db}/{docid}</span></tt></a>.
Instead of this, it leaves tombstone with very basic information about document.
If you just <a class="reference internal" href="contents.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}</span></tt></a> CouchDB returns <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a>
response:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/FishStew</span>  <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">404</span> <span class="ne">Object Not Found</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">41</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 12:23:27 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;not_found&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;deleted&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>However, you may retrieve document&#8217;s tombstone by using <tt class="docutils literal"><span class="pre">rev</span></tt> query parameter
with <a class="reference internal" href="contents.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}</span></tt></a> request:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/FishStew?rev=2-056f5f44046ecafc08a2bc2b9c229e20</span>  <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">79</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 12:30:22 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;2-056f5f44046ecafc08a2bc2b9c229e20&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;_deleted&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;_id&quot;</span><span class="p">:</span> <span class="s2">&quot;FishStew&quot;</span><span class="p">,</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-056f5f44046ecafc08a2bc2b9c229e20&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="updating-an-existing-document">
<h5>Updating an Existing Document<a class="headerlink" href="#updating-an-existing-document" title="Permalink to this headline">¶</a></h5>
<p>To update an existing document you must specify the current revision
number within the <tt class="docutils literal"><span class="pre">_rev</span></tt> parameter.</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/recipes/SpaghettiWithMeatballs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">258</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;_rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-917fa2381192822767f010b95b45325b&quot;</span><span class="p">,</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
        <span class="s2">&quot;meatballs&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;serving&quot;</span><span class="p">:</span> <span class="s2">&quot;hot&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Alternatively, you can supply the current revision number in the
<tt class="docutils literal"><span class="pre">If-Match</span></tt> HTTP header of the request:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/recipes/SpaghettiWithMeatballs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">258</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">If-Match</span><span class="o">:</span> <span class="l">1-917fa2381192822767f010b95b45325b</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ingredients&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
        <span class="s2">&quot;meatballs&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Spaghetti with meatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;serving&quot;</span><span class="p">:</span> <span class="s2">&quot;hot&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">85</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 20:33:56 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;2-790895a73b63fb91dd863388398483dd&quot;</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/recipes/SpaghettiWithMeatballs</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-790895a73b63fb91dd863388398483dd&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="copying-from-a-specific-revision">
<h5>Copying from a Specific Revision<a class="headerlink" href="#copying-from-a-specific-revision" title="Permalink to this headline">¶</a></h5>
<p>To copy <em>from</em> a specific version, use the <tt class="docutils literal"><span class="pre">rev</span></tt> argument to the query
string or <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a>:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre>COPY /recipes/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Destination: http://localhost:5984/recipes_old/SpaghettiWithMeatballs_Original
If-Match: 1-917fa2381192822767f010b95b45325b
Host: localhost:5984
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">93</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 14:21:00 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;1-917fa2381192822767f010b95b45325b&quot;</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/recipes_old/SpaghettiWithMeatballs_Original</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs_Original&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;1-917fa2381192822767f010b95b45325b&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="copying-to-an-existing-document">
<h5>Copying to an Existing Document<a class="headerlink" href="#copying-to-an-existing-document" title="Permalink to this headline">¶</a></h5>
<p>To copy to an existing document, you must specify the current revision
string for the target document by appending the <tt class="docutils literal"><span class="pre">rev</span></tt> parameter to the
<a class="reference external" href="http://tools.ietf.org/html/rfc2518#section-9.3">Destination</a> header string.</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre>COPY /recipes/SpaghettiWithMeatballs?rev=8-6f5ad8db0f34af24a6e0984cd1a6cfb9 HTTP/1.1
Accept: application/json
Destination: http://localhost:5984/recipes_old/SpaghettiWithMeatballs_Original?rev=1-917fa2381192822767f010b95b45325b
Host: localhost:5984
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">93</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 14:21:00 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;2-62e778c9ec09214dd685a981dcc24074&quot;&quot;</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/recipes_old/SpaghettiWithMeatballs_Original</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs_Original&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-62e778c9ec09214dd685a981dcc24074&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<span id="document-api/document/attachments"></span><div class="section" id="db-doc-attachment">
<span id="api-doc-attachment"></span><h4><tt class="docutils literal"><span class="pre">/db/doc/attachment</span></tt><a class="headerlink" href="#db-doc-attachment" title="Permalink to this headline">¶</a></h4>
<dl class="head">
<dt id="head--db-docid-attname">
<tt class="descname">HEAD </tt><tt class="descname">/{db}/{docid}/{attname}</tt><a class="headerlink" href="#head--db-docid-attname" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the HTTP headers containing a minimal amount of information
about the specified attachment. The method supports the same query
arguments as the <a class="reference internal" href="contents.html#get--db-docid-attname" title="GET /{db}/{docid}/{attname}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}/{attname}</span></tt></a> method, but only
the header information (including attachment size, encoding and the MD5 hash
as an <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a>), is returned.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
<li><strong>attname</strong> &#8211; Attachment name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> &#8211; Document&#8217;s revision. Alternative to <cite>rev</cite> query parameter</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.26">If-None-Match</a> &#8211; Attachment&#8217;s base64 encoded MD5 binary digest.
<em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>rev</strong> (<em>string</em>) &#8211; Document&#8217;s revision. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.5">Accept-Ranges</a> &#8211; <a class="reference internal" href="contents.html#api-doc-attachment-range"><em>Range request aware</em></a>.
Used for attachments with <em class="mimetype">application/octet-stream</em> content type</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.11">Content-Encoding</a> &#8211; Used compression codec. Available if attachment&#8217;s
<tt class="docutils literal"><span class="pre">content_type</span></tt> is in <a class="reference internal" href="contents.html#attachments/compressible_types" title="compressible_types"><tt class="xref config config-option docutils literal"><span class="pre">list</span> <span class="pre">of</span> <span class="pre">compressiable</span> <span class="pre">types</span></tt></a></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.13">Content-Length</a> &#8211; Attachment size. If compression codec was used,
this value is about compressed size, not actual</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.15">Content-MD5</a> &#8211; Base64 encoded MD5 binary digest</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Double quoted base64 encoded MD5 binary digest</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Attachment exists</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.5">304 Not Modified</a> &#8211; Attachment wasn&#8217;t modified if <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> equals specified
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.26">If-None-Match</a> header</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Read privilege required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Specified database, document or attachment was not found</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">HEAD</span> <span class="nn">/recipes/SpaghettiWithMeatballs/recipe.txt</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Accept-Ranges</span><span class="o">:</span> <span class="l">none</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Encoding</span><span class="o">:</span> <span class="l">gzip</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">100</span>
<span class="na">Content-MD5</span><span class="o">:</span> <span class="l">vVa/YgiE1+Gh0WfoFJAcSg==</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/plain</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 15 Aug 2013 12:42:42 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;vVa/YgiE1+Gh0WfoFJAcSg==&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
</pre></div>
</div>
</dd></dl>

<dl class="get">
<dt id="get--db-docid-attname">
<tt class="descname">GET </tt><tt class="descname">/{db}/{docid}/{attname}</tt><a class="headerlink" href="#get--db-docid-attname" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the file attachment associated with the document.
The raw data of the associated attachment is returned (just as if you were
accessing a static file. The returned <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a>
will be the same as the content type set when the document attachment
was submitted into the database.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
<li><strong>attname</strong> &#8211; Attachment name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> &#8211; Document&#8217;s revision. Alternative to <cite>rev</cite> query parameter</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.26">If-None-Match</a> &#8211; Attachment&#8217;s base64 encoded MD5 binary digest.
<em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>rev</strong> (<em>string</em>) &#8211; Document&#8217;s revision. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.5">Accept-Ranges</a> &#8211; <a class="reference internal" href="contents.html#api-doc-attachment-range"><em>Range request aware</em></a>.
Used for attachments with <em class="mimetype">application/octet-stream</em></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.11">Content-Encoding</a> &#8211; Used compression codec. Available if attachment&#8217;s
<tt class="docutils literal"><span class="pre">content_type</span></tt> is in <a class="reference internal" href="contents.html#attachments/compressible_types" title="compressible_types"><tt class="xref config config-option docutils literal"><span class="pre">list</span> <span class="pre">of</span> <span class="pre">compressiable</span> <span class="pre">types</span></tt></a></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.13">Content-Length</a> &#8211; Attachment size. If compression codec is used,
this value is about compressed size, not actual</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.15">Content-MD5</a> &#8211; Base64 encoded MD5 binary digest</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Double quoted base64 encoded MD5 binary digest</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Response:</th><td class="field-body"><p class="first">Stored content</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Attachment exists</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.3.5">304 Not Modified</a> &#8211; Attachment wasn&#8217;t modified if <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> equals specified
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.26">If-None-Match</a> header</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Read privilege required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Specified database, document or attachment was not found</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="put">
<dt id="put--db-docid-attname">
<tt class="descname">PUT </tt><tt class="descname">/{db}/{docid}/{attname}</tt><a class="headerlink" href="#put--db-docid-attname" title="Permalink to this definition">¶</a></dt>
<dd><p>Uploads the supplied content as an attachment to the specified document.
The attachment name provided must be a URL encoded string. You must also
supply either the <tt class="docutils literal"><span class="pre">rev</span></tt> query argument or the <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a>
HTTP header for validation, and the HTTP headers (to set the attachment
content type).</p>
<p>If case when uploading an attachment using an existing attachment name,
CouchDB will update the corresponding stored content of the database.
Since you must supply the revision information to add an attachment to
the document, this serves as validation to update the existing attachment.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Uploading an attachment updates the corresponding document revision.
Revisions are tracked for the parent document, not individual attachments.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
<li><strong>attname</strong> &#8211; Attachment name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; Attachment MIME type. <em>Required</em></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> &#8211; Document revision. Alternative to <cite>rev</cite> query parameter</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>rev</strong> (<em>string</em>) &#8211; Document revision. <em>Required</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.5">Accept-Ranges</a> &#8211; <a class="reference internal" href="contents.html#api-doc-attachment-range"><em>Range request aware</em></a>.
Used for attachments with <em class="mimetype">application/octet-stream</em></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.11">Content-Encoding</a> &#8211; Used compression codec. Available if attachment&#8217;s
<tt class="docutils literal"><span class="pre">content_type</span></tt> is in <a class="reference internal" href="contents.html#attachments/compressible_types" title="compressible_types"><tt class="xref config config-option docutils literal"><span class="pre">list</span> <span class="pre">of</span> <span class="pre">compressiable</span> <span class="pre">types</span></tt></a></li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.13">Content-Length</a> &#8211; Attachment size. If compression codec is used,
this value is about compressed size, not actual</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.15">Content-MD5</a> &#8211; Base64 encoded MD5 binary digest</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Double quoted base64 encoded MD5 binary digest</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>id</strong> (<em>string</em>) &#8211; Document ID</li>
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
<li><strong>rev</strong> (<em>string</em>) &#8211; Revision MVCC token</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Attachment successfully removed</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Request was accepted, but changes are not yet stored on disk</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid request body or parameters</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Write privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Specified database, document or attachment was not found</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.10">409 Conflict</a> &#8211; Document&#8217;s revision wasn&#8217;t specified or it&#8217;s not the latest</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">PUT</span> <span class="nn">/recipes/SpaghettiWithMeatballs/recipe.txt</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">86</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/plain</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
<span class="na">If-Match</span><span class="o">:</span> <span class="l">1-917fa2381192822767f010b95b45325b</span>

1. Cook spaghetti
2. Cook meatballs
3. Mix them
4. Add tomato sauce
5. ...
6. PROFIT!
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">85</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Thu, 15 Aug 2013 12:38:04 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;2-ce91aed0129be8f9b0f650a2edcfd0a4&quot;</span>
<span class="na">Location</span><span class="o">:</span> <span class="l">http://localhost:5984/recipes/SpaghettiWithMeatballs/recipe.txt</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;2-ce91aed0129be8f9b0f650a2edcfd0a4&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="delete">
<dt id="delete--db-docid-attname">
<tt class="descname">DELETE </tt><tt class="descname">/{db}/{docid}/{attname}</tt><a class="headerlink" href="#delete--db-docid-attname" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes the attachment <tt class="docutils literal"><span class="pre">attachment</span></tt> of the specified <tt class="docutils literal"><span class="pre">doc</span></tt>. You must
supply the <tt class="docutils literal"><span class="pre">rev</span></tt> query parameter or <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> with the current
revision to delete the attachment.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Deleting an attachment updates the corresponding document revision.
Revisions are tracked for the parent document, not individual attachments.</p>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> &#8211; Document revision. Alternative to <cite>rev</cite> query parameter</li>
<li><strong>X-Couch-Full-Commit</strong> &#8211; Overrides server&#8217;s
<a class="reference internal" href="contents.html#couchdb/delayed_commits" title="delayed_commits"><tt class="xref config config-option docutils literal"><span class="pre">commit</span> <span class="pre">policy</span></tt></a>. Possible values
are: <tt class="docutils literal"><span class="pre">false</span></tt> and <tt class="docutils literal"><span class="pre">true</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>rev</strong> (<em>string</em>) &#8211; Document revision. <em>Required</em></li>
<li><strong>batch</strong> (<em>string</em>) &#8211; Store changes in <a class="reference internal" href="contents.html#api-doc-batch-writes"><em>batch mode</em></a> Possible values: <tt class="docutils literal"><span class="pre">ok</span></tt>. <em>Optional</em></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Double quoted document&#8217;s new revision</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>id</strong> (<em>string</em>) &#8211; Document ID</li>
<li><strong>ok</strong> (<em>boolean</em>) &#8211; Operation status</li>
<li><strong>rev</strong> (<em>string</em>) &#8211; Revision MVCC token</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Attachment successfully removed</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.3">202 Accepted</a> &#8211; Request was accepted, but changes are not yet stored on disk</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid request body or parameters</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Write privileges required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Specified database, document or attachment was not found</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.10">409 Conflict</a> &#8211; Document&#8217;s revision wasn&#8217;t specified or it&#8217;s not the latest</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">DELETE</span> <span class="nn">/recipes/SpaghettiWithMeatballs?rev=6-440b2dd39c20413045748b42c6aba6e2</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p>Alternatively, instead of <tt class="docutils literal"><span class="pre">rev</span></tt> query parameter you may use
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.24">If-Match</a> header:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">DELETE</span> <span class="nn">/recipes/SpaghettiWithMeatballs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">If-Match</span><span class="o">:</span> <span class="l">6-440b2dd39c20413045748b42c6aba6e2</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">85</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 14 Aug 2013 12:23:13 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;7-05185cf5fcdf4b6da360af939431d466&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
    <span class="nt">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;rev&quot;</span><span class="p">:</span> <span class="s2">&quot;7-05185cf5fcdf4b6da360af939431d466&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="http-range-requests">
<span id="api-doc-attachment-range"></span><h5>HTTP Range Requests<a class="headerlink" href="#http-range-requests" title="Permalink to this headline">¶</a></h5>
<p>HTTP allows you to specify byte ranges for requests. This allows the
implementation of resumable downloads and skippable audio and video
streams alike. This is available for all attachments inside CouchDB.</p>
<p>This is just a real quick run through how this looks under the hood.
Usually, you will have larger binary files to serve from CouchDB, like
MP3s and videos, but to make things a little more obvious, I use a text
file here (Note that I use the <em class="mimetype">application/octet-stream</em>
:header`Content-Type` instead of <em class="mimetype">text/plain</em>).</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; cat file.txt
My hovercraft is full of eels!
</pre></div>
</div>
<p>Now let&#8217;s store this text file as an attachment in CouchDB. First, we
create a database:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl -X PUT http://127.0.0.1:5984/test
<span class="o">{</span><span class="s2">&quot;ok&quot;</span>:true<span class="o">}</span>
</pre></div>
</div>
<p>Then we create a new document and the file attachment in one go:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl -X PUT http://127.0.0.1:5984/test/doc/file.txt <span class="se">\</span>
            -H <span class="s2">&quot;Content-Type: application/octet-stream&quot;</span> -d@file.txt
<span class="o">{</span><span class="s2">&quot;ok&quot;</span>:true,<span class="s2">&quot;id&quot;</span>:<span class="s2">&quot;doc&quot;</span>,<span class="s2">&quot;rev&quot;</span>:<span class="s2">&quot;1-287a28fa680ae0c7fb4729bf0c6e0cf2&quot;</span><span class="o">}</span>
</pre></div>
</div>
<p>Now we can request the whole file easily:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl -X GET http://127.0.0.1:5984/test/doc/file.txt
My hovercraft is full of eels!
</pre></div>
</div>
<p>But say we only want the first 13 bytes:</p>
<div class="highlight-bash"><div class="highlight"><pre>shell&gt; curl -X GET http://127.0.0.1:5984/test/doc/file.txt <span class="se">\</span>
            -H <span class="s2">&quot;Range: bytes=0-12&quot;</span>
My hovercraft
</pre></div>
</div>
<p>HTTP supports many ways to specify single and even multiple byte
ranges. Read all about it in <span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2616.html#section-14.27"><strong>RFC 2616</strong></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Databases that have been created with CouchDB 1.0.2 or earlier will
support range requests in 1.6, but they are using a less-optimal
algorithm. If you plan to make heavy use of this feature, make sure
to compact your database with CouchDB 1.6 to take advantage of a
better algorithm to find byte ranges.</p>
</div>
</div>
</div>
</div>
</div>
<span id="document-api/ddoc/index"></span><div class="section" id="design-documents">
<span id="api-design-docs"></span><h3>Design Documents<a class="headerlink" href="#design-documents" title="Permalink to this headline">¶</a></h3>
<p>In CouchDB, design documents provide the main interface for building a
CouchDB application. The design document defines the views used to
extract information from CouchDB through one or more views. Design
documents are created within your CouchDB instance in the same way as
you create database documents, but the content and definition of the
documents is different. Design Documents are named using an ID defined
with the design document URL path, and this URL can then be used to
access the database contents.</p>
<p>Views and lists operate together to provide automated (and formatted)
output from your database.</p>
<div class="toctree-wrapper compound">
<span id="document-api/ddoc/common"></span><div class="section" id="db-design-design-doc">
<span id="api-ddoc"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc</span></tt><a class="headerlink" href="#db-design-design-doc" title="Permalink to this headline">¶</a></h4>
<dl class="head">
<dt id="head--db-_design-ddoc">
<tt class="descname">HEAD </tt><tt class="descname">/{db}/_design/{ddoc}</tt><a class="headerlink" href="#head--db-_design-ddoc" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the HTTP Headers containing a minimal amount of information
about the specified design document.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#head--db-docid" title="HEAD /{db}/{docid}"><tt class="xref http http-head docutils literal"><span class="pre">HEAD</span> <span class="pre">/{db}/{docid}</span></tt></a></p>
</div>
</dd></dl>

<dl class="get">
<dt id="get--db-_design-ddoc">
<tt class="descname">GET </tt><tt class="descname">/{db}/_design/{ddoc}</tt><a class="headerlink" href="#get--db-_design-ddoc" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the contents of the design document specified with the name of the design
document and from the specified database from the URL. Unless you request a specific
revision, the latest revision of the document will always be returned.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}</span></tt></a></p>
</div>
</dd></dl>

<dl class="put">
<dt id="put--db-_design-ddoc">
<tt class="descname">PUT </tt><tt class="descname">/{db}/_design/{ddoc}</tt><a class="headerlink" href="#put--db-_design-ddoc" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.6">PUT</a> method creates a new named design document, or creates
a new revision of the existing design document.</p>
<p>The design documents have some agreement upon their fields and structure.
Currently it is the following:</p>
<ul class="simple">
<li><strong>language</strong> (<em>string</em>): Defines <a class="reference internal" href="contents.html#query-server"><em>Query Server</em></a>
<a class="reference internal" href="contents.html#query_servers" title="[query_servers]"><tt class="xref config config-section docutils literal"><span class="pre">key</span></tt></a> to process design document functions</li>
<li><strong>options</strong> (<em>object</em>): View&#8217;s default options</li>
<li><strong>filters</strong> (<em>object</em>): <a class="reference internal" href="contents.html#filterfun"><em>Filter functions</em></a> definition</li>
<li><strong>lists</strong> (<em>object</em>): <a class="reference internal" href="contents.html#listfun"><em>List functions</em></a> definition</li>
<li><strong>rewrites</strong> (<em>array</em>): Rewrite rules definition</li>
<li><strong>shows</strong> (<em>object</em>): <a class="reference internal" href="contents.html#showfun"><em>Show functions</em></a> definition</li>
<li><strong>updates</strong> (<em>object</em>): <a class="reference internal" href="contents.html#updatefun"><em>Update functions</em></a> definition</li>
<li><strong>validate_doc_update</strong> (<em>string</em>): <a class="reference internal" href="contents.html#vdufun"><em>Validate document update</em></a>
function source</li>
<li><strong>views</strong> (<em>object</em>): <a class="reference internal" href="contents.html#viewfun"><em>View functions</em></a> definition.</li>
</ul>
<p>Note, that for <tt class="docutils literal"><span class="pre">filters</span></tt>, <tt class="docutils literal"><span class="pre">lists</span></tt>, <tt class="docutils literal"><span class="pre">shows</span></tt> and <tt class="docutils literal"><span class="pre">updates</span></tt> fields
objects are mapping of function name to string function source code.
For <tt class="docutils literal"><span class="pre">views</span></tt> mapping is the same except that values are objects with <tt class="docutils literal"><span class="pre">map</span></tt>
and <tt class="docutils literal"><span class="pre">reduce</span></tt> (optional) keys which also contains functions source code.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#put--db-docid" title="PUT /{db}/{docid}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/{db}/{docid}</span></tt></a></p>
</div>
</dd></dl>

<dl class="delete">
<dt id="delete--db-_design-ddoc">
<tt class="descname">DELETE </tt><tt class="descname">/{db}/_design/{ddoc}</tt><a class="headerlink" href="#delete--db-_design-ddoc" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes the specified document from the database. You must supply the
current (latest) revision, either by using the <tt class="docutils literal"><span class="pre">rev</span></tt> parameter to
specify the revision.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#delete--db-docid" title="DELETE /{db}/{docid}"><tt class="xref http http-delete docutils literal"><span class="pre">DELETE</span> <span class="pre">/{db}/{docid}</span></tt></a></p>
</div>
</dd></dl>

<dl class="copy">
<dt id="copy--db-_design-ddoc">
<tt class="descname">COPY </tt><tt class="descname">/{db}/_design/{ddoc}</tt><a class="headerlink" href="#copy--db-_design-ddoc" title="Permalink to this definition">¶</a></dt>
<dd><p>The <a class="reference external" href="http://tools.ietf.org/html/rfc2518#section-8.8">COPY</a> (which is non-standard HTTP) copies an existing
design document to a new or existing one.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Copying a design document does automatically reconstruct the view
indexes. These will be recreated, as with other views, the first
time the new view is accessed.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#copy--db-docid" title="COPY /{db}/{docid}"><tt class="xref http http-copy docutils literal"><span class="pre">COPY</span> <span class="pre">/{db}/{docid}</span></tt></a></p>
</div>
</dd></dl>

</div>
<div class="section" id="db-design-design-doc-attachment">
<span id="api-ddoc-attachment"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc/attachment</span></tt><a class="headerlink" href="#db-design-design-doc-attachment" title="Permalink to this headline">¶</a></h4>
<dl class="head">
<dt id="head--db-_design-ddoc-attname">
<tt class="descname">HEAD </tt><tt class="descname">/{db}/_design/{ddoc}/{attname}</tt><a class="headerlink" href="#head--db-_design-ddoc-attname" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the HTTP headers containing a minimal amount of information
about the specified attachment.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#head--db-docid-attname" title="HEAD /{db}/{docid}/{attname}"><tt class="xref http http-head docutils literal"><span class="pre">HEAD</span> <span class="pre">/{db}/{docid}/{attname}</span></tt></a></p>
</div>
</dd></dl>

<dl class="get">
<dt id="get--db-_design-ddoc-attname">
<tt class="descname">GET </tt><tt class="descname">/{db}/_design/{ddoc}/{attname}</tt><a class="headerlink" href="#get--db-_design-ddoc-attname" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the file attachment associated with the design document.
The raw data of the associated attachment is returned (just as if you were
accessing a static file.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#get--db-docid-attname" title="GET /{db}/{docid}/{attname}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}/{attname}</span></tt></a></p>
</div>
</dd></dl>

<dl class="put">
<dt id="put--db-_design-ddoc-attname">
<tt class="descname">PUT </tt><tt class="descname">/{db}/_design/{ddoc}/{attname}</tt><a class="headerlink" href="#put--db-_design-ddoc-attname" title="Permalink to this definition">¶</a></dt>
<dd><p>Uploads the supplied content as an attachment to the specified design
document. The attachment name provided must be a URL encoded string.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#put--db-docid-attname" title="PUT /{db}/{docid}/{attname}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/{db}/{docid}/{attname}</span></tt></a></p>
</div>
</dd></dl>

<dl class="delete">
<dt id="delete--db-_design-ddoc-attname">
<tt class="descname">DELETE </tt><tt class="descname">/{db}/_design/{ddoc}/{attname}</tt><a class="headerlink" href="#delete--db-_design-ddoc-attname" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes the attachment of the specified design document.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#delete--db-docid-attname" title="DELETE /{db}/{docid}/{attname}"><tt class="xref http http-delete docutils literal"><span class="pre">DELETE</span> <span class="pre">/{db}/{docid}/{attname}</span></tt></a></p>
</div>
</dd></dl>

</div>
<div class="section" id="db-design-design-doc-info">
<span id="api-ddoc-info"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc/_info</span></tt><a class="headerlink" href="#db-design-design-doc-info" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_design-ddoc-_info">
<tt class="descname">GET </tt><tt class="descname">/{db}/_design/{ddoc}/_info</tt><a class="headerlink" href="#get--db-_design-ddoc-_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Obtains information about the specified design document, including the index,
index size and current status of the design document and associated
index information.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>ddoc</strong> &#8211; Design document name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>name</strong> (<em>string</em>) &#8211; Design document name</li>
<li><strong>view_index</strong> (<em>object</em>) &#8211; <a class="reference internal" href="contents.html#api-ddoc-view-index-info"><em>View Index Information</em></a></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_design/recipe/_info</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">263</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Sat, 17 Aug 2013 12:54:17 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;recipe&quot;</span><span class="p">,</span>
    <span class="nt">&quot;view_index&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;compact_running&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;data_size&quot;</span><span class="p">:</span> <span class="mi">926691</span><span class="p">,</span>
        <span class="nt">&quot;disk_size&quot;</span><span class="p">:</span> <span class="mi">1982704</span><span class="p">,</span>
        <span class="nt">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
        <span class="nt">&quot;purge_seq&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nt">&quot;signature&quot;</span><span class="p">:</span> <span class="s2">&quot;a59a1bb13fdf8a8a584bc477919c97ac&quot;</span><span class="p">,</span>
        <span class="nt">&quot;update_seq&quot;</span><span class="p">:</span> <span class="mi">12397</span><span class="p">,</span>
        <span class="nt">&quot;updater_running&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;waiting_clients&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nt">&quot;waiting_commit&quot;</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="view-index-information">
<span id="api-ddoc-view-index-info"></span><h5>View Index Information<a class="headerlink" href="#view-index-information" title="Permalink to this headline">¶</a></h5>
<p>The response from <a class="reference internal" href="contents.html#get--db-_design-ddoc-_info" title="GET /{db}/_design/{ddoc}/_info"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/_design/{ddoc}/_info</span></tt></a> contains
<tt class="docutils literal"><span class="pre">view_index</span></tt> (<em>object</em>) field with the next structure:</p>
<ul class="simple">
<li><strong>compact_running</strong> (<em>boolean</em>):  Indicates whether a compaction routine
is currently running on the view</li>
<li><strong>data_size</strong> (<em>number</em>): Actual size in bytes of the view</li>
<li><strong>disk_size</strong> (<em>number</em>): Size in bytes of the view as stored on disk</li>
<li><strong>language</strong> (<em>string</em>): Language for the defined views</li>
<li><strong>purge_seq</strong> (<em>number</em>): The purge sequence that has been processed</li>
<li><strong>signature</strong> (<em>string</em>): MD5 signature of the views for the design document</li>
<li><strong>update_seq</strong> (<em>number</em>): The update sequence of the corresponding database
that has been indexed</li>
<li><strong>updater_running</strong> (<em>boolean</em>): Indicates if the view is currently
being updated</li>
<li><strong>waiting_clients</strong> (<em>number</em>): Number of clients waiting on views from
this design document</li>
<li><strong>waiting_commit</strong> (<em>boolean</em>): Indicates if there are outstanding commits
to the underlying database that need to processed</li>
</ul>
</div>
</div>
<span id="document-api/ddoc/views"></span><div class="section" id="db-design-design-doc-view-view-name">
<span id="api-ddoc-view"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc/_view/view-name</span></tt><a class="headerlink" href="#db-design-design-doc-view-view-name" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_design-ddoc-_view-view">
<tt class="descname">GET </tt><tt class="descname">/{db}/_design/{ddoc}/_view/{view}</tt><a class="headerlink" href="#get--db-_design-ddoc-_view-view" title="Permalink to this definition">¶</a></dt>
<dd><p>Executes the specified view function from the specified design document.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>ddoc</strong> &#8211; Design document name</li>
<li><strong>view</strong> &#8211; View function name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Request Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.1">Accept</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain</em></li>
</ul>
</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>conflicts</strong> (<em>boolean</em>) &#8211; Includes <cite>conflicts</cite> information in response.
Ignored if <cite>include_docs</cite> isn&#8217;t <tt class="docutils literal"><span class="pre">true</span></tt>. Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><strong>descending</strong> (<em>boolean</em>) &#8211; Return the documents in descending by key order.
Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><strong>endkey</strong> (<em>string</em>) &#8211; Stop returning records when the specified key is
reached. <em>Optional</em></li>
<li><strong>end_key</strong> (<em>string</em>) &#8211; Alias for <cite>endkey</cite> param</li>
<li><strong>endkey_docid</strong> (<em>string</em>) &#8211; Stop returning records when the specified
document ID is reached. <em>Optional</em></li>
<li><strong>end_key_doc_id</strong> (<em>string</em>) &#8211; Alias for <cite>endkey_docid</cite> param</li>
<li><strong>group</strong> (<em>boolean</em>) &#8211; Group the results using the reduce function to a group
or single row. Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><strong>group_level</strong> (<em>number</em>) &#8211; Specify the group level to be used. <em>Optional</em></li>
<li><strong>include_docs</strong> (<em>boolean</em>) &#8211; Include the associated document with each row.
Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>attachments</strong> (<em>boolean</em>) &#8211; Include the Base64-encoded content of
<a class="reference internal" href="contents.html#api-doc-attachments"><em>attachments</em></a> in the documents that are included
if <cite>include_docs</cite> is <tt class="docutils literal"><span class="pre">true</span></tt>. Ignored if <cite>include_docs</cite> isn&#8217;t <tt class="docutils literal"><span class="pre">true</span></tt>.
Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>att_encoding_info</strong> (<em>boolean</em>) &#8211; Include encoding information in attachment
stubs if <cite>include_docs</cite> is <tt class="docutils literal"><span class="pre">true</span></tt> and the particular attachment is
compressed. Ignored if <cite>include_docs</cite> isn&#8217;t <tt class="docutils literal"><span class="pre">true</span></tt>. Default is <tt class="docutils literal"><span class="pre">false</span></tt>.</li>
<li><strong>inclusive_end</strong> (<em>boolean</em>) &#8211; Specifies whether the specified end key should
be included in the result. Default is <tt class="docutils literal"><span class="pre">true</span></tt></li>
<li><strong>key</strong> (<em>string</em>) &#8211; Return only documents that match the specified key.
<em>Optional</em></li>
<li><strong>limit</strong> (<em>number</em>) &#8211; Limit the number of the returned documents to the
specified number. <em>Optional</em></li>
<li><strong>reduce</strong> (<em>boolean</em>) &#8211; Use the reduction function. Default is <tt class="docutils literal"><span class="pre">true</span></tt></li>
<li><strong>skip</strong> (<em>number</em>) &#8211; Skip this number of records before starting to return
the results. Default is <tt class="docutils literal"><span class="pre">0</span></tt></li>
<li><strong>stale</strong> (<em>string</em>) &#8211; Allow the results from a stale view to be used.
Supported values: <tt class="docutils literal"><span class="pre">ok</span></tt> and <tt class="docutils literal"><span class="pre">update_after</span></tt>. <em>Optional</em></li>
<li><strong>startkey</strong> (<em>string</em>) &#8211; Return records starting with the specified key.
<em>Optional</em></li>
<li><strong>start_key</strong> (<em>string</em>) &#8211; Alias for <cite>startkey</cite> param</li>
<li><strong>startkey_docid</strong> (<em>string</em>) &#8211; Return records starting with the specified
document ID. <em>Optional</em></li>
<li><strong>start_key_doc_id</strong> (<em>string</em>) &#8211; Alias for <cite>startkey_docid</cite> param</li>
<li><strong>update_seq</strong> (<em>boolean</em>) &#8211; Response includes an <tt class="docutils literal"><span class="pre">update_seq</span></tt> value
indicating which sequence id of the database the view reflects.
Default is <tt class="docutils literal"><span class="pre">false</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.17">Content-Type</a> &#8211; <ul>
<li><em class="mimetype">application/json</em></li>
<li><em class="mimetype">text/plain; charset=utf-8</em></li>
</ul>
</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Response signature</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.41">Transfer-Encoding</a> &#8211; <tt class="docutils literal"><span class="pre">chunked</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Response JSON Object:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>offset</strong> (<em>number</em>) &#8211; Offset where the document list started</li>
<li><strong>rows</strong> (<em>array</em>) &#8211; Array of view row objects. By default the information
returned contains only the document ID and revision</li>
<li><strong>total_rows</strong> (<em>number</em>) &#8211; Number of documents in the database/view</li>
<li><strong>update_seq</strong> (<em>number</em>) &#8211; Current update sequence for the database</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a> &#8211; Invalid request</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a> &#8211; Read permission required</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> &#8211; Specified database, design document or view is missed</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> &#8211; View function execution error</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_design/ingredients/_view/by_name</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 09:12:06 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;2FOLSBSW4O6WB798XU4AQYA9B&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;meatballs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;tomato sauce&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;total_rows&quot;</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<div class="versionchanged">
<p><span class="versionmodified">Changed in version 1.6.0: </span>added <tt class="docutils literal"><span class="pre">attachments</span></tt> and <tt class="docutils literal"><span class="pre">att_encoding_info</span></tt>
parameters</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Using the <tt class="docutils literal"><span class="pre">attachments</span></tt> parameter to include attachments in view results
is not recommended for large attachment sizes. Also note that the
Base64-encoding that is used leads to a 33% overhead (i.e. one third) in
transfer size for attachments.</p>
</div>
<dl class="post">
<dt id="post--db-_design-ddoc-_view-view">
<tt class="descname">POST </tt><tt class="descname">/{db}/_design/{ddoc}/_view/{view}</tt><a class="headerlink" href="#post--db-_design-ddoc-_view-view" title="Permalink to this definition">¶</a></dt>
<dd><p>Executes the specified view function from the specified design document.
Unlike <a class="reference internal" href="contents.html#get--db-_design-ddoc-_view-view" title="GET /{db}/_design/{ddoc}/_view/{view}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/_design/{ddoc}/_view/{view}</span></tt></a> for accessing views, the
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.5">POST</a> method supports the specification
of explicit keys to be retrieved from the view results. The remainder of the
<a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html#sec9.5">POST</a> view functionality is identical to the
<a class="reference internal" href="contents.html#get--db-_design-ddoc-_view-view" title="GET /{db}/_design/{ddoc}/_view/{view}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/_design/{ddoc}/_view/{view}</span></tt></a> API.</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">POST</span> <span class="nn">/recipes/_design/ingredients/_view/by_name</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">37</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
    <span class="nt">&quot;keys&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;meatballs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;spaghetti&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 09:14:13 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;6R5NM8E872JIJF796VF7WI3FZ&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;meatballs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;SpaghettiWithMeatballs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;spaghetti&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;total_rows&quot;</span><span class="p">:</span> <span class="mi">3</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<div class="section" id="view-options">
<span id="api-ddoc-view-options"></span><h5>View Options<a class="headerlink" href="#view-options" title="Permalink to this headline">¶</a></h5>
<p>There are two view indexing options that can be defined in a design document
as boolean properties of an <tt class="docutils literal"><span class="pre">options</span></tt> object. Unlike the others querying
options, these aren&#8217;t URL parameters because they take effect when the view
index is generated, not when it&#8217;s accessed:</p>
<ul class="simple">
<li><strong>local_seq</strong> (<em>boolean</em>): Makes documents&#8217; local sequence numbers available
to map functions (as a <tt class="docutils literal"><span class="pre">_local_seq</span></tt> document property)</li>
<li><strong>include_design</strong> (<em>boolean</em>): Allows map functions to be called on design
documents as well as regular documents</li>
</ul>
<p>In additional to these options, you may specify <a class="reference internal" href="contents.html#api-ddoc-view"><em>any other</em></a>
with their default value. E.g. having option <tt class="docutils literal"><span class="pre">&quot;include_docs&quot;:</span> <span class="pre">true</span></tt> will
automatically includes document body for view results response. You still may
override such by explicitly defining same query parameter name with other value.</p>
</div>
<div class="section" id="querying-views-and-indexes">
<span id="api-ddoc-view-indexing"></span><h5>Querying Views and Indexes<a class="headerlink" href="#querying-views-and-indexes" title="Permalink to this headline">¶</a></h5>
<p>The definition of a view within a design document also creates an index
based on the key information defined within each view. The production
and use of the index significantly increases the speed of access and
searching or selecting documents from the view.</p>
<p>However, the index is not updated when new documents are added or
modified in the database. Instead, the index is generated or updated,
either when the view is first accessed, or when the view is accessed
after a document has been updated. In each case, the index is updated
before the view query is executed against the database.</p>
<p>View indexes are updated incrementally in the following situations:</p>
<ul class="simple">
<li>A new document has been added to the database.</li>
<li>A document has been deleted from the database.</li>
<li>A document in the database has been updated.</li>
</ul>
<p>View indexes are rebuilt entirely when the view definition changes. To
achieve this, a &#8216;fingerprint&#8217; of the view definition is created when the
design document is updated. If the fingerprint changes, then the view
indexes are entirely rebuilt. This ensures that changes to the view
definitions are reflected in the view indexes.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">View index rebuilds occur when one view from the same the view group
(i.e. all the views defined within a single a design document) has
been determined as needing a rebuild. For example, if if you have a
design document with different views, and you update the database,
all three view indexes within the design document will be updated.</p>
</div>
<p>Because the view is updated when it has been queried, it can result in a
delay in returned information when the view is accessed, especially if
there are a large number of documents in the database and the view index
does not exist. There are a number of ways to mitigate, but not
completely eliminate, these issues. These include:</p>
<ul class="simple">
<li>Create the view definition (and associated design documents) on your
database before allowing insertion or updates to the documents. If
this is allowed while the view is being accessed, the index can be
updated incrementally.</li>
<li>Manually force a view request from the database. You can do this
either before users are allowed to use the view, or you can access
the view manually after documents are added or updated.</li>
<li>Use the <a class="reference internal" href="contents.html#api-db-changes"><em>changes feed</em></a> to monitor for changes to the
database and then access the view to force the corresponding view
index to be updated.</li>
<li>Use a monitor with the <a class="reference internal" href="contents.html#update-notifications"><em>update notification</em></a>
section of the CouchDB configuration file to monitor for changes to your
database, and trigger a view query to force the view to be updated.</li>
</ul>
<p>None of these can completely eliminate the need for the indexes to be
rebuilt or updated when the view is accessed, but they may lessen the
effects on end-users of the index update affecting the user experience.</p>
<p>Another alternative is to allow users to access a &#8216;stale&#8217; version of the
view index, rather than forcing the index to be updated and displaying
the updated results. Using a stale view may not return the latest
information, but will return the results of the view query using an
existing version of the index.</p>
<p>For example, to access the existing stale view <tt class="docutils literal"><span class="pre">by_recipe</span></tt> in the
<tt class="docutils literal"><span class="pre">recipes</span></tt> design document:</p>
<div class="highlight-text"><div class="highlight"><pre>http://localhost:5984/recipes/_design/recipes/_view/by_recipe?stale=ok
</pre></div>
</div>
<p>Accessing a stale view:</p>
<ul class="simple">
<li>Does not trigger a rebuild of the view indexes, even if there have
been changes since the last access.</li>
<li>Returns the current version of the view index, if a current version
exists.</li>
<li>Returns an empty result set if the given view index does exist.</li>
</ul>
<p>As an alternative, you use the <tt class="docutils literal"><span class="pre">update_after</span></tt> value to the <tt class="docutils literal"><span class="pre">stale</span></tt>
parameter. This causes the view to be returned as a stale view, but for
the update process to be triggered after the view information has been
returned to the client.</p>
<p>In addition to using stale views, you can also make use of the
<tt class="docutils literal"><span class="pre">update_seq</span></tt> query argument. Using this query argument generates the
view information including the update sequence of the database from
which the view was generated. The returned value can be compared this to
the current update sequence exposed in the database information
(returned by <a class="reference internal" href="contents.html#get--db" title="GET /{db}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}</span></tt></a>).</p>
</div>
<div class="section" id="sorting-returned-rows">
<span id="api-ddoc-view-sorting"></span><h5>Sorting Returned Rows<a class="headerlink" href="#sorting-returned-rows" title="Permalink to this headline">¶</a></h5>
<p>Each element within the returned array is sorted using native UTF-8
sorting according to the contents of the key portion of the emitted
content. The basic order of output is as follows:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">null</span></tt></li>
<li><tt class="docutils literal"><span class="pre">false</span></tt></li>
<li><tt class="docutils literal"><span class="pre">true</span></tt></li>
<li>Numbers</li>
<li>Text (case sensitive, lowercase first)</li>
<li>Arrays (according to the values of each element, in order)</li>
<li>Objects (according to the values of keys, in key order)</li>
</ul>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/db/_design/test/_view/sorting</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 10:09:25 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;8LA1LZPQ37B6R9U8BK9BGQH27&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;\u043f\u0440\u0438\u0432\u0435\u0442&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="mi">3</span>
            <span class="p">],</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="mi">3</span>
            <span class="p">],</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="mi">3</span>
            <span class="p">],</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;total_rows&quot;</span><span class="p">:</span> <span class="mi">17</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can reverse the order of the returned view information by using the
<tt class="docutils literal"><span class="pre">descending</span></tt> query value set to true:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/db/_design/test/_view/sorting?descending=true</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 10:09:25 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;Z4N468R15JBT98OM0AMNSR8U&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
    <span class="nt">&quot;offset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="mi">3</span>
            <span class="p">],</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="mi">3</span>
            <span class="p">],</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="mi">3</span>
            <span class="p">],</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;\u043f\u0440\u0438\u0432\u0435\u0442&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;dummy-doc&quot;</span><span class="p">,</span>
            <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&quot;total_rows&quot;</span><span class="p">:</span> <span class="mi">17</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="sorting-order-and-startkey-endkey">
<h6>Sorting order and startkey/endkey<a class="headerlink" href="#sorting-order-and-startkey-endkey" title="Permalink to this headline">¶</a></h6>
<p>The sorting direction is applied before the filtering applied using the
<tt class="docutils literal"><span class="pre">startkey</span></tt> and <tt class="docutils literal"><span class="pre">endkey</span></tt> query arguments. For example the following
query:</p>
<div class="highlight-http"><div class="highlight"><pre>GET http://couchdb:5984/recipes/_design/recipes/_view/by_ingredient?startkey=%22carrots%22&amp;endkey=%22egg%22
Accept: application/json
</pre></div>
</div>
<p>will operate correctly when listing all the matching entries between
<tt class="docutils literal"><span class="pre">carrots</span></tt> and <tt class="docutils literal"><span class="pre">egg</span></tt>. If the order of output is reversed with the
<tt class="docutils literal"><span class="pre">descending</span></tt> query argument, the view request will return no entries:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_design/recipes/_view/by_ingredient?descending=true&amp;startkey=%22carrots%22&amp;endkey=%22egg%22</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>

<span class="p">{</span>
   <span class="nt">&quot;total_rows&quot;</span> <span class="p">:</span> <span class="mi">26453</span><span class="p">,</span>
   <span class="nt">&quot;rows&quot;</span> <span class="p">:</span> <span class="p">[],</span>
   <span class="nt">&quot;offset&quot;</span> <span class="p">:</span> <span class="mi">21882</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The results will be empty because the entries in the view are reversed
before the key filter is applied, and therefore the <tt class="docutils literal"><span class="pre">endkey</span></tt> of “egg”
will be seen before the <tt class="docutils literal"><span class="pre">startkey</span></tt> of “carrots”, resulting in an empty
list.</p>
<p>Instead, you should reverse the values supplied to the <tt class="docutils literal"><span class="pre">startkey</span></tt> and
<tt class="docutils literal"><span class="pre">endkey</span></tt> parameters to match the descending sorting applied to the
keys. Changing the previous example to:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_design/recipes/_view/by_ingredient?descending=true&amp;startkey=%22egg%22&amp;endkey=%22carrots%22</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
</div>
<div class="section" id="raw-collation">
<span id="api-ddoc-view-sorting-raw"></span><h6>Raw collation<a class="headerlink" href="#raw-collation" title="Permalink to this headline">¶</a></h6>
<p>By default CouchDB using <a class="reference external" href="http://site.icu-project.org/">ICU</a> driver for sorting view results. It&#8217;s possible
use binary collation instead for faster view builds where Unicode collation is
not important.</p>
<p>To use raw collation add <tt class="docutils literal"><span class="pre">&quot;collation&quot;:</span> <span class="pre">&quot;raw&quot;</span></tt> key-value pair to the design
documents <tt class="docutils literal"><span class="pre">options</span></tt> object at the root level. After that, views will be
regenerated and new order applied.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference internal" href="contents.html#views-collation"><em>Views Collation</em></a></p>
</div>
</div>
</div>
<div class="section" id="using-limits-and-skipping-rows">
<span id="api-ddoc-view-limiting"></span><h5>Using Limits and Skipping Rows<a class="headerlink" href="#using-limits-and-skipping-rows" title="Permalink to this headline">¶</a></h5>
<p>By default requestion views result returns all records for it. That&#8217;s ok when
they are small, but this may lead to problems when there are billions of them
since the clients might have to read them all and consume all available memory.</p>
<p>But it&#8217;s possible to reduce output result rows by specifying <tt class="docutils literal"><span class="pre">limit</span></tt> query
parameter. For example, retrieving the list of recipes using the <tt class="docutils literal"><span class="pre">by_title</span></tt>
view and limited to 5 returns only 5 records, while there are total 2667 records
in view:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_design/recipes/_view/by_title?limit=5</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 09:14:13 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;9Q6Q2GZKPH8D5F8L7PB6DBSS9&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
   <span class="nt">&quot;offset&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="nt">&quot;rows&quot;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;3-tiersalmonspinachandavocadoterrine&quot;</span><span class="p">,</span>
         <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="s2">&quot;3-tier salmon, spinach and avocado terrine&quot;</span><span class="p">,</span>
         <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="kc">null</span><span class="p">,</span>
            <span class="s2">&quot;3-tier salmon, spinach and avocado terrine&quot;</span>
         <span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;Aberffrawcake&quot;</span><span class="p">,</span>
         <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="s2">&quot;Aberffraw cake&quot;</span><span class="p">,</span>
         <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="kc">null</span><span class="p">,</span>
            <span class="s2">&quot;Aberffraw cake&quot;</span>
         <span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;Adukiandorangecasserole-microwave&quot;</span><span class="p">,</span>
         <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="s2">&quot;Aduki and orange casserole - microwave&quot;</span><span class="p">,</span>
         <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="kc">null</span><span class="p">,</span>
            <span class="s2">&quot;Aduki and orange casserole - microwave&quot;</span>
         <span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;Aioli-garlicmayonnaise&quot;</span><span class="p">,</span>
         <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="s2">&quot;Aioli - garlic mayonnaise&quot;</span><span class="p">,</span>
         <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="kc">null</span><span class="p">,</span>
            <span class="s2">&quot;Aioli - garlic mayonnaise&quot;</span>
         <span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;Alabamapeanutchicken&quot;</span><span class="p">,</span>
         <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="s2">&quot;Alabama peanut chicken&quot;</span><span class="p">,</span>
         <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="kc">null</span><span class="p">,</span>
            <span class="s2">&quot;Alabama peanut chicken&quot;</span>
         <span class="p">]</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="nt">&quot;total_rows&quot;</span> <span class="p">:</span> <span class="mi">2667</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To omit some records you may use <tt class="docutils literal"><span class="pre">skip</span></tt> query parameter:</p>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_design/recipes/_view/by_title?limit=3&amp;skip=2</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 09:14:13 GMT</span>
<span class="na">ETag</span><span class="o">:</span> <span class="l">&quot;H3G7YZSNIVRRHO5FXPE16NJHN&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="p">{</span>
   <span class="nt">&quot;offset&quot;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&quot;rows&quot;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;Adukiandorangecasserole-microwave&quot;</span><span class="p">,</span>
         <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="s2">&quot;Aduki and orange casserole - microwave&quot;</span><span class="p">,</span>
         <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="kc">null</span><span class="p">,</span>
            <span class="s2">&quot;Aduki and orange casserole - microwave&quot;</span>
         <span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;Aioli-garlicmayonnaise&quot;</span><span class="p">,</span>
         <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="s2">&quot;Aioli - garlic mayonnaise&quot;</span><span class="p">,</span>
         <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="kc">null</span><span class="p">,</span>
            <span class="s2">&quot;Aioli - garlic mayonnaise&quot;</span>
         <span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span> <span class="p">:</span> <span class="s2">&quot;Alabamapeanutchicken&quot;</span><span class="p">,</span>
         <span class="nt">&quot;key&quot;</span> <span class="p">:</span> <span class="s2">&quot;Alabama peanut chicken&quot;</span><span class="p">,</span>
         <span class="nt">&quot;value&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="kc">null</span><span class="p">,</span>
            <span class="s2">&quot;Alabama peanut chicken&quot;</span>
         <span class="p">]</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="nt">&quot;total_rows&quot;</span> <span class="p">:</span> <span class="mi">2667</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Using <tt class="docutils literal"><span class="pre">limit</span></tt> and <tt class="docutils literal"><span class="pre">skip</span></tt> parameters is not recommended for results
pagination. Read <a class="reference internal" href="contents.html#views-pagination"><em>pagination recipe</em></a> why it&#8217;s so
and how to make it better.</p>
</div>
</div>
</div>
<span id="document-api/ddoc/render"></span><div class="section" id="db-design-design-doc-show-show-name">
<span id="api-ddoc-show"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc/_show/show-name</span></tt><a class="headerlink" href="#db-design-design-doc-show-show-name" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_design-ddoc-_show-func">
<tt class="descname">GET </tt><tt class="descname">/{db}/_design/{ddoc}/_show/{func}</tt><a class="headerlink" href="#get--db-_design-ddoc-_show-func" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="post">
<dt id="post--db-_design-ddoc-_show-func">
<tt class="descname">POST </tt><tt class="descname">/{db}/_design/{ddoc}/_show/{func}</tt><a class="headerlink" href="#post--db-_design-ddoc-_show-func" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies <a class="reference internal" href="contents.html#showfun"><em>show function</em></a> for <cite>null</cite> document.</p>
<p>The request and response parameters are depended upon function implementation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>ddoc</strong> &#8211; Design document name</li>
<li><strong>func</strong> &#8211; Show function name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Response signature</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>details</strong> (<em>boolean</em>) &#8211; Indicates whether details should be included</li>
<li><strong>format</strong> (<em>string</em>) &#8211; Format of the returned response.
Used by <a class="reference internal" href="contents.html#provides" title="provides"><tt class="xref js js-func docutils literal"><span class="pre">provides()</span></tt></a> function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> &#8211; Query server error</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Function</strong>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">body</span><span class="o">:</span> <span class="s2">&quot;no doc&quot;</span><span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">body</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">description</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_design/recipe/_show/description</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">6</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html; charset=utf-8</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 12:34:07 GMT</span>
<span class="na">Etag</span><span class="o">:</span> <span class="l">&quot;7Z2TO7FPEMZ0F4GH0RJCRIOAU&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Vary</span><span class="o">:</span> <span class="l">Accept</span>

no doc
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-design-design-doc-show-show-name-doc-id">
<span id="api-ddoc-show-id"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc/_show/show-name/doc-id</span></tt><a class="headerlink" href="#db-design-design-doc-show-show-name-doc-id" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_design-ddoc-_show-func-docid">
<tt class="descname">GET </tt><tt class="descname">/{db}/_design/{ddoc}/_show/{func}/{docid}</tt><a class="headerlink" href="#get--db-_design-ddoc-_show-func-docid" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="post">
<dt id="post--db-_design-ddoc-_show-func-docid">
<tt class="descname">POST </tt><tt class="descname">/{db}/_design/{ddoc}/_show/{func}/{docid}</tt><a class="headerlink" href="#post--db-_design-ddoc-_show-func-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies <a class="reference internal" href="contents.html#showfun"><em>show function</em></a> for the specified document.</p>
<p>The request and response parameters are depended upon function implementation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>ddoc</strong> &#8211; Design document name</li>
<li><strong>func</strong> &#8211; Show function name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Response signature</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>details</strong> (<em>boolean</em>) &#8211; Indicates whether details should be included</li>
<li><strong>format</strong> (<em>string</em>) &#8211; Format of the returned response.
Used by <a class="reference internal" href="contents.html#provides" title="provides"><tt class="xref js js-func docutils literal"><span class="pre">provides()</span></tt></a> function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> &#8211; Query server error</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Function</strong>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">body</span><span class="o">:</span> <span class="s2">&quot;no doc&quot;</span><span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">body</span><span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">description</span><span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_design/recipe/_show/description/SpaghettiWithMeatballs</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">88</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/html; charset=utf-8</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 12:38:08 GMT</span>
<span class="na">Etag</span><span class="o">:</span> <span class="l">&quot;8IEBO8103EI98HDZL5Z4I1T0C&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Vary</span><span class="o">:</span> <span class="l">Accept</span>

An Italian-American dish that usually consists of spaghetti, tomato sauce and meatballs.
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-design-design-doc-list-list-name-view-name">
<span id="api-ddoc-list"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc/_list/list-name/view-name</span></tt><a class="headerlink" href="#db-design-design-doc-list-list-name-view-name" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_design-ddoc-_list-func-view">
<tt class="descname">GET </tt><tt class="descname">/{db}/_design/{ddoc}/_list/{func}/{view}</tt><a class="headerlink" href="#get--db-_design-ddoc-_list-func-view" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="post">
<dt id="post--db-_design-ddoc-_list-func-view">
<tt class="descname">POST </tt><tt class="descname">/{db}/_design/{ddoc}/_list/{func}/{view}</tt><a class="headerlink" href="#post--db-_design-ddoc-_list-func-view" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies <a class="reference internal" href="contents.html#listfun"><em>list function</em></a> for the <a class="reference internal" href="contents.html#viewfun"><em>view function</em></a>
from the same design document.</p>
<p>The request and response parameters are depended upon function implementation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>ddoc</strong> &#8211; Design document name</li>
<li><strong>func</strong> &#8211; List function name</li>
<li><strong>view</strong> &#8211; View function name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Response signature</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.41">Transfer-Encoding</a> &#8211; <tt class="docutils literal"><span class="pre">chunked</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>format</strong> (<em>string</em>) &#8211; Format of the returned response.
Used by <a class="reference internal" href="contents.html#provides" title="provides"><tt class="xref js js-func docutils literal"><span class="pre">provides()</span></tt></a> function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> &#8211; Query server error</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Function</strong>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">getRow</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">row</span><span class="p">){</span>
    <span class="k">return</span> <span class="s1">&#39;no ingredients&#39;</span>
  <span class="p">}</span>
  <span class="nx">send</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">row</span><span class="o">=</span><span class="nx">getRow</span><span class="p">()){</span>
    <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nx">row</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_design/recipe/_list/ingredients/by_name</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/plain</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/plain; charset=utf-8</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 12:49:15 GMT</span>
<span class="na">Etag</span><span class="o">:</span> <span class="l">&quot;D52L2M1TKQYDD1Y8MEYJR8C84&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>
<span class="na">Vary</span><span class="o">:</span> <span class="l">Accept</span>

meatballs, spaghetti, tomato sauce
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-design-design-doc-list-list-name-other-ddoc-view-name">
<span id="api-ddoc-list-ddoc"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc/_list/list-name/other-ddoc/view-name</span></tt><a class="headerlink" href="#db-design-design-doc-list-list-name-other-ddoc-view-name" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_design-ddoc-_list-func-other-ddoc-view">
<tt class="descname">GET </tt><tt class="descname">/{db}/_design/{ddoc}/_list/{func}/{other-ddoc}/{view}</tt><a class="headerlink" href="#get--db-_design-ddoc-_list-func-other-ddoc-view" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="post">
<dt id="post--db-_design-ddoc-_list-func-other-ddoc-view">
<tt class="descname">POST </tt><tt class="descname">/{db}/_design/{ddoc}/_list/{func}/{other-ddoc}/{view}</tt><a class="headerlink" href="#post--db-_design-ddoc-_list-func-other-ddoc-view" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies <a class="reference internal" href="contents.html#listfun"><em>list function</em></a> for the <a class="reference internal" href="contents.html#viewfun"><em>view function</em></a>
from the other design document.</p>
<p>The request and response parameters are depended upon function implementation.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>ddoc</strong> &#8211; Design document name</li>
<li><strong>func</strong> &#8211; List function name</li>
<li><strong>other-ddoc</strong> &#8211; Other design document name that holds view function</li>
<li><strong>view</strong> &#8211; View function name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">ETag</a> &#8211; Response signature</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.41">Transfer-Encoding</a> &#8211; <tt class="docutils literal"><span class="pre">chunked</span></tt></li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name" colspan="2">Query Parameters:</th></tr>
<tr class="field-odd field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>format</strong> (<em>string</em>) &#8211; Format of the returned response.
Used by <a class="reference internal" href="contents.html#provides" title="provides"><tt class="xref js js-func docutils literal"><span class="pre">provides()</span></tt></a> function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; Request completed successfully</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> &#8211; Query server error</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Function</strong>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">getRow</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">row</span><span class="p">){</span>
    <span class="k">return</span> <span class="s1">&#39;no ingredients&#39;</span>
  <span class="p">}</span>
  <span class="nx">send</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
  <span class="k">while</span><span class="p">(</span><span class="nx">row</span><span class="o">=</span><span class="nx">getRow</span><span class="p">()){</span>
    <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nx">row</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="nf">GET</span> <span class="nn">/recipes/_design/ingredient/_list/ingredients/recipe/by_ingredient?key=&quot;spaghetti&quot;</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/plain</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">localhost:5984</span>
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">text/plain; charset=utf-8</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 12:49:15 GMT</span>
<span class="na">Etag</span><span class="o">:</span> <span class="l">&quot;5L0975X493R0FB5Z3043POZHD&quot;</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>
<span class="na">Vary</span><span class="o">:</span> <span class="l">Accept</span>

spaghetti
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-design-design-doc-update-update-name">
<span id="api-ddoc-update"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc/_update/update-name</span></tt><a class="headerlink" href="#db-design-design-doc-update-update-name" title="Permalink to this headline">¶</a></h4>
<dl class="post">
<dt id="post--db-_design-ddoc-_update-func">
<tt class="descname">POST </tt><tt class="descname">/{db}/_design/{ddoc}/_update/{func}</tt><a class="headerlink" href="#post--db-_design-ddoc-_update-func" title="Permalink to this definition">¶</a></dt>
<dd><p>Executes <a class="reference internal" href="contents.html#updatefun"><em>update function</em></a> on server side for <tt class="docutils literal"><span class="pre">null</span></tt>
document.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>ddoc</strong> &#8211; Design document name</li>
<li><strong>func</strong> &#8211; Update function name</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>X-Couch-Id</strong> &#8211; Created/updated document&#8217;s ID</li>
<li><strong>X-Couch-Update-Newrev</strong> &#8211; Created/updated document&#8217;s revision</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; No document was created or updated</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> &#8211; Document was created or updated</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> &#8211; Query server error</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Function</strong>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
                   <span class="s1">&#39;json&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="o">:</span> <span class="s1">&#39;missed&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;reason&#39;</span><span class="o">:</span> <span class="s1">&#39;no document to update&#39;</span><span class="p">}}]</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">ingredients</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">doc</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;json&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="o">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">}}];</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre>POST /recipes/_design/recipe/_update/ingredients HTTP/1.1
Accept: application/json
Content-Length: 10
Content-Type: application/json
Host: localhost:5984

something
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">404</span> <span class="ne">Object Not Found</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">52</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 14:00:58 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>

<span class="p">{</span>
    <span class="nt">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;missed&quot;</span><span class="p">,</span>
    <span class="nt">&quot;reason&quot;</span><span class="p">:</span> <span class="s2">&quot;no document to update&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<div class="section" id="db-design-design-doc-update-update-name-doc-id">
<span id="api-ddoc-update-id"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc/_update/update-name/doc-id</span></tt><a class="headerlink" href="#db-design-design-doc-update-update-name-doc-id" title="Permalink to this headline">¶</a></h4>
<dl class="put">
<dt id="put--db-_design-ddoc-_update-func-docid">
<tt class="descname">PUT </tt><tt class="descname">/{db}/_design/{ddoc}/_update/{func}/{docid}</tt><a class="headerlink" href="#put--db-_design-ddoc-_update-func-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>Executes <a class="reference internal" href="contents.html#updatefun"><em>update function</em></a> on server side for the specified
document.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>ddoc</strong> &#8211; Design document name</li>
<li><strong>func</strong> &#8211; Update function name</li>
<li><strong>docid</strong> &#8211; Document ID</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name" colspan="2">Response Headers:</th></tr>
<tr class="field-even field"><td>&nbsp;</td><td class="field-body"><ul class="first simple">
<li><strong>X-Couch-Id</strong> &#8211; Created/updated document&#8217;s ID</li>
<li><strong>X-Couch-Update-Newrev</strong> &#8211; Created/updated document&#8217;s revision</li>
</ul>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status Codes:</th><td class="field-body"><ul class="first last simple">
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a> &#8211; No document was created or updated</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a> &#8211; Document was created or updated</li>
<li><a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a> &#8211; Query server error</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Function</strong>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;code&#39;</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
                   <span class="s1">&#39;json&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="o">:</span> <span class="s1">&#39;missed&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;reason&#39;</span><span class="o">:</span> <span class="s1">&#39;no document to update&#39;</span><span class="p">}}]</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">ingredients</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">doc</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;json&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="o">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">}}];</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Request</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre>POST /recipes/_design/recipe/_update/ingredients/SpaghettiWithMeatballs HTTP/1.1
Accept: application/json
Content-Length: 5
Content-Type: application/json
Host: localhost:5984

love
</pre></div>
</div>
<p><strong>Response</strong>:</p>
<div class="highlight-http"><div class="highlight"><pre><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">201</span> <span class="ne">Created</span>
<span class="na">Cache-Control</span><span class="o">:</span> <span class="l">must-revalidate</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">16</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Date</span><span class="o">:</span> <span class="l">Wed, 21 Aug 2013 14:11:34 GMT</span>
<span class="na">Server</span><span class="o">:</span> <span class="l">CouchDB (Erlang/OTP)</span>
<span class="na">X-Couch-Id</span><span class="o">:</span> <span class="l">SpaghettiWithMeatballs</span>
<span class="na">X-Couch-Update-NewRev</span><span class="o">:</span> <span class="l">12-a5e099df5720988dae90c8b664496baf</span>

<span class="p">{</span>
    <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</div>
<span id="document-api/ddoc/rewrites"></span><div class="section" id="db-design-design-doc-rewrite-path">
<span id="api-ddoc-rewrite"></span><h4><tt class="docutils literal"><span class="pre">/db/_design/design-doc/_rewrite/path</span></tt><a class="headerlink" href="#db-design-design-doc-rewrite-path" title="Permalink to this headline">¶</a></h4>
<dl class="any">
<dt id="any--db-_design-ddoc-_rewrite-path">
<tt class="descname">ANY </tt><tt class="descname">/{db}/_design/{ddoc}/_rewrite/{path}</tt><a class="headerlink" href="#any--db-_design-ddoc-_rewrite-path" title="Permalink to this definition">¶</a></dt>
<dd><p>Rewrites the specified path by rules defined in the specified design document.</p>
<p>The rewrite rules are defined in <em>array</em> field of the design document called
<tt class="docutils literal"><span class="pre">rewrites</span></tt>. Each rule is an <em>object</em> with next structure:</p>
<ul class="simple">
<li><strong>from</strong> (<em>string</em>): The path rule used to bind current uri to the rule.
It use pattern matching for that</li>
<li><strong>to</strong> (<em>string</em>): Rule to rewrite an url. It can contain variables
depending on  binding variables discovered during pattern matching and
query args (url args and from the query member)</li>
<li><strong>method</strong> (<em>string</em>): HTTP request method to bind the request method to
the rule. Default is <tt class="docutils literal"><span class="pre">&quot;*&quot;</span></tt></li>
<li><strong>query</strong> (<em>object</em>): Query args you want to define they can contain
dynamic variable by binding the key</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">to``and</span> <span class="pre">``from</span></tt> paths may contains string patterns with leading <tt class="docutils literal"><span class="pre">:</span></tt>
or <tt class="docutils literal"><span class="pre">*</span></tt> characters.</p>
<p>For example: <tt class="docutils literal"><span class="pre">/somepath/:var/*</span></tt></p>
<ul class="simple">
<li>This path is converted in Erlang list by splitting <tt class="docutils literal"><span class="pre">/</span></tt></li>
<li>Each <tt class="docutils literal"><span class="pre">var</span></tt> are converted in atom</li>
<li><tt class="docutils literal"><span class="pre">&quot;&quot;</span></tt> are converted to <tt class="docutils literal"><span class="pre">''</span></tt> atom</li>
<li>The pattern matching is done by splitting <tt class="docutils literal"><span class="pre">/</span></tt> in request url in a list of
token</li>
<li>A string pattern will match equal token</li>
<li>The star atom (<tt class="docutils literal"><span class="pre">'*'</span></tt> in single quotes) will match any number of tokens,
but may only be present as the last <cite>pathterm</cite> in a <cite>pathspec</cite></li>
<li>If all tokens are matched and all <cite>pathterms</cite> are used, then the <cite>pathspec</cite>
matches</li>
</ul>
<p>The pattern matching is done by first matching the HTTP request method to a
rule. <tt class="docutils literal"><span class="pre">method</span></tt> is equal to <tt class="docutils literal"><span class="pre">&quot;*&quot;</span></tt> by default, and will match any HTTP
method. It will then try to match the path to one rule. If no rule matches,
then a <a class="reference external" href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.5">404 Not Found</a> response returned.</p>
<p>Once a rule is found we rewrite the request url using the <tt class="docutils literal"><span class="pre">to</span></tt> and <tt class="docutils literal"><span class="pre">query</span></tt>
fields. The identified token are matched to the rule and will replace var.
If <tt class="docutils literal"><span class="pre">'*'</span></tt> is found in the rule it will contain the remaining part if it
exists.</p>
<p>Examples:</p>
<table border="1" class="docutils">
<colgroup>
<col width="52%" />
<col width="14%" />
<col width="25%" />
<col width="10%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Rule</th>
<th class="head">Url</th>
<th class="head">Rewrite to</th>
<th class="head">Tokens</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>{&#8220;from&#8221;: &#8220;/a&#8221;, &#8220;to&#8221;: &#8220;/some&#8221;}</td>
<td>/a</td>
<td>/some</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>{&#8220;from&#8221;: &#8220;/a/*&#8221;, &#8220;to&#8221;: &#8220;/some/*}</td>
<td>/a/b/c</td>
<td>/some/b/c</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>{&#8220;from&#8221;: &#8220;/a/b&#8221;, &#8220;to&#8221;: &#8220;/some&#8221;}</td>
<td>/a/b?k=v</td>
<td>/some?k=v</td>
<td>k=v</td>
</tr>
<tr class="row-odd"><td>{&#8220;from&#8221;: &#8220;/a/b&#8221;, &#8220;to&#8221;: &#8220;/some/:var&#8221;}</td>
<td>/a/b</td>
<td>/some/b?var=b</td>
<td>var=b</td>
</tr>
<tr class="row-even"><td>{&#8220;from&#8221;: &#8220;/a/:foo/&#8221;,
&#8220;to&#8221;: &#8220;/some/:foo/&#8221;}</td>
<td>/a/b/c</td>
<td>/some/b/c?foo=b</td>
<td>foo=b</td>
</tr>
<tr class="row-odd"><td>{&#8220;from&#8221;: &#8220;/a/:foo&#8221;, &#8220;to&#8221;: &#8220;/some&#8221;,
&#8220;query&#8221;: { &#8220;k&#8221;: &#8221;:foo&#8221; }}</td>
<td>/a/b</td>
<td>/some/?k=b&amp;foo=b</td>
<td>foo=b</td>
</tr>
<tr class="row-even"><td>{&#8220;from&#8221;: &#8220;/a&#8221;, &#8220;to&#8221;: &#8220;/some/:foo&#8221;}</td>
<td>/a?foo=b</td>
<td>/some/?b&amp;foo=b</td>
<td>foo=b</td>
</tr>
</tbody>
</table>
<p>Request method, header, query parameters, request payload and response body
are depended on endpoint to which url will be rewritten.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>db</strong> &#8211; Database name</li>
<li><strong>ddoc</strong> &#8211; Design document name</li>
<li><strong>path</strong> &#8211; URL path to rewrite</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
</div>
<span id="document-api/local"></span><div class="section" id="local-non-replicating-documents">
<span id="api-local"></span><h3>Local (non-replicating) Documents<a class="headerlink" href="#local-non-replicating-documents" title="Permalink to this headline">¶</a></h3>
<p>The Local (non-replicating) document interface allows you to create
local documents that are not replicated to other databases. These
documents can be used to hold configuration or other information that is
required specifically on the local CouchDB instance.</p>
<p>Local documents have the following limitations:</p>
<ul class="simple">
<li>Local documents are not replicated to other databases.</li>
<li>The ID of the local document must be known for the document to
accessed. You cannot obtain a list of local documents from the
database.</li>
<li>Local documents are not output by views, or the <a class="reference internal" href="contents.html#api-db-all-docs"><em>/db/_all_docs</em></a> view.</li>
</ul>
<p>Local documents can be used when you want to store configuration or
other information for the current (local) instance of a given database.</p>
<p>A list of the available methods and URL paths are provided below:</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="33%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Method</th>
<th class="head">Path</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>GET</td>
<td>/db/_local/id</td>
<td>Returns the latest revision of the
non-replicated document</td>
</tr>
<tr class="row-odd"><td>PUT</td>
<td>/db/_local/id</td>
<td>Inserts a new version of the
non-replicated document</td>
</tr>
<tr class="row-even"><td>DELETE</td>
<td>/db/_local/id</td>
<td>Deletes the non-replicated document</td>
</tr>
<tr class="row-odd"><td>COPY</td>
<td>/db/_local/id</td>
<td>Copies the non-replicated document</td>
</tr>
</tbody>
</table>
<div class="section" id="db-local-id">
<span id="api-local-doc"></span><h4><tt class="docutils literal"><span class="pre">/db/_local/id</span></tt><a class="headerlink" href="#db-local-id" title="Permalink to this headline">¶</a></h4>
<dl class="get">
<dt id="get--db-_local-docid">
<tt class="descname">GET </tt><tt class="descname">/{db}/_local/{docid}</tt><a class="headerlink" href="#get--db-_local-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets the specified local document. The semantics are identical to
accessing a standard document in the specified database, except that the
document is not replicated. See <a class="reference internal" href="contents.html#get--db-docid" title="GET /{db}/{docid}"><tt class="xref http http-get docutils literal"><span class="pre">GET</span> <span class="pre">/{db}/{docid}</span></tt></a>.</p>
</dd></dl>

<dl class="put">
<dt id="put--db-_local-docid">
<tt class="descname">PUT </tt><tt class="descname">/{db}/_local/{docid}</tt><a class="headerlink" href="#put--db-_local-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>Stores the specified local document. The semantics are identical to
storing a standard document in the specified database, except that the
document is not replicated. See <a class="reference internal" href="contents.html#put--db-docid" title="PUT /{db}/{docid}"><tt class="xref http http-put docutils literal"><span class="pre">PUT</span> <span class="pre">/{db}/{docid}</span></tt></a>.</p>
</dd></dl>

<dl class="delete">
<dt id="delete--db-_local-docid">
<tt class="descname">DELETE </tt><tt class="descname">/{db}/_local/{docid}</tt><a class="headerlink" href="#delete--db-_local-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>Deletes the specified local document. The semantics are identical to
deleting a standard document in the specified database, except that the
document is not replicated. See <a class="reference internal" href="contents.html#delete--db-docid" title="DELETE /{db}/{docid}"><tt class="xref http http-delete docutils literal"><span class="pre">DELETE</span> <span class="pre">/{db}/{docid}</span></tt></a>.</p>
</dd></dl>

<dl class="copy">
<dt id="copy--db-_local-docid">
<tt class="descname">COPY </tt><tt class="descname">/{db}/_local/{docid}</tt><a class="headerlink" href="#copy--db-_local-docid" title="Permalink to this definition">¶</a></dt>
<dd><p>Copies the specified local document. The semantics are identical to
copying a standard document in the specified database, except that the
document is not replicated. See <a class="reference internal" href="contents.html#copy--db-docid" title="COPY /{db}/{docid}"><tt class="xref http http-copy docutils literal"><span class="pre">COPY</span> <span class="pre">/{db}/{docid}</span></tt></a>.</p>
</dd></dl>

</div>
</div>
</div>
</div>
<span id="document-json-structure"></span><div class="section" id="json-structure-reference">
<h2>JSON Structure Reference<a class="headerlink" href="#json-structure-reference" title="Permalink to this headline">¶</a></h2>
<p>The following appendix provides a quick reference to all the JSON structures
that you can supply to CouchDB, or get in return to requests.</p>
<div class="section" id="all-database-documents">
<h3>All Database Documents<a class="headerlink" href="#all-database-documents" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>total_rows</td>
<td>Number of documents in the database/view</td>
</tr>
<tr class="row-odd"><td>offset</td>
<td>Offset where the document list started</td>
</tr>
<tr class="row-even"><td>update_seq (optional)</td>
<td>Current update sequence for the database</td>
</tr>
<tr class="row-odd"><td>rows [array]</td>
<td>Array of document object</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="bulk-document-response">
<h3>Bulk Document Response<a class="headerlink" href="#bulk-document-response" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>docs [array]</td>
<td>Bulk Docs Returned Documents</td>
</tr>
<tr class="row-odd"><td>id</td>
<td>Document ID</td>
</tr>
<tr class="row-even"><td>error</td>
<td>Error type</td>
</tr>
<tr class="row-odd"><td>reason</td>
<td>Error string with extended reason</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="bulk-documents">
<h3>Bulk Documents<a class="headerlink" href="#bulk-documents" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>all_or_nothing (optional)</td>
<td>Sets the database commit mode to use
all-or-nothing semantics</td>
</tr>
<tr class="row-odd"><td>docs [array]</td>
<td>Bulk Documents Document</td>
</tr>
<tr class="row-even"><td>_id (optional)</td>
<td>Document ID</td>
</tr>
<tr class="row-odd"><td>_rev (optional)</td>
<td>Revision ID (when updating an existing
document)</td>
</tr>
<tr class="row-even"><td>_deleted (optional)</td>
<td>Whether the document should be deleted</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="changes-information-for-a-database">
<h3>Changes information for a database<a class="headerlink" href="#changes-information-for-a-database" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>last_seq</td>
<td>Last change sequence number</td>
</tr>
<tr class="row-odd"><td>results [array]</td>
<td>Changes made to a database</td>
</tr>
<tr class="row-even"><td>seq</td>
<td>Update sequence number</td>
</tr>
<tr class="row-odd"><td>id</td>
<td>Document ID</td>
</tr>
<tr class="row-even"><td>changes [array]</td>
<td>List of changes, field-by-field, for this
document</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="couchdb-document">
<h3>CouchDB Document<a class="headerlink" href="#couchdb-document" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>_id (optional)</td>
<td>Document ID</td>
</tr>
<tr class="row-odd"><td>_rev (optional)</td>
<td>Revision ID (when updating an existing
document)</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="couchdb-error-status">
<h3>CouchDB Error Status<a class="headerlink" href="#couchdb-error-status" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>id</td>
<td>Document ID</td>
</tr>
<tr class="row-odd"><td>error</td>
<td>Error type</td>
</tr>
<tr class="row-even"><td>reason</td>
<td>Error string with extended reason</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="couchdb-database-information-object">
<span id="dbinfo-object"></span><h3>CouchDB database information object<a class="headerlink" href="#couchdb-database-information-object" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>db_name</td>
<td>The name of the database.</td>
</tr>
<tr class="row-odd"><td>committed_update_seq</td>
<td>The number of committed updates.</td>
</tr>
<tr class="row-even"><td>doc_count</td>
<td>The number of documents in the database.</td>
</tr>
<tr class="row-odd"><td>doc_del_count</td>
<td>The number of deleted documents.</td>
</tr>
<tr class="row-even"><td>compact_running</td>
<td>Set to true if the database compaction
routine is operating on this database.</td>
</tr>
<tr class="row-odd"><td>disk_format_version</td>
<td>The version of the physical format used for
the data when it is stored on hard disk.</td>
</tr>
<tr class="row-even"><td>disk_size</td>
<td>Size in bytes of the data as stored on disk.
View indexes are not included in the
calculation.</td>
</tr>
<tr class="row-odd"><td>instance_start_time</td>
<td>Timestamp indicating when the database was
opened, expressed in microseconds since the
epoch.</td>
</tr>
<tr class="row-even"><td>purge_seq</td>
<td>The number of purge operations on the
database.</td>
</tr>
<tr class="row-odd"><td>update_seq</td>
<td>The current number of updates made in the
database.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="design-document">
<h3>Design Document<a class="headerlink" href="#design-document" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>_id</td>
<td>Design Document ID</td>
</tr>
<tr class="row-odd"><td>_rev</td>
<td>Design Document Revision</td>
</tr>
<tr class="row-even"><td>views</td>
<td>View</td>
</tr>
<tr class="row-odd"><td>viewname</td>
<td>View Definition</td>
</tr>
<tr class="row-even"><td>map</td>
<td>Map Function for View</td>
</tr>
<tr class="row-odd"><td>reduce (optional)</td>
<td>Reduce Function for View</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="design-document-information">
<h3>Design Document Information<a class="headerlink" href="#design-document-information" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>name</td>
<td>Name/ID of Design Document</td>
</tr>
<tr class="row-odd"><td>view_index</td>
<td>View Index</td>
</tr>
<tr class="row-even"><td>compact_running</td>
<td>Indicates whether a compaction routine is
currently running on the view</td>
</tr>
<tr class="row-odd"><td>disk_size</td>
<td>Size in bytes of the view as stored on disk</td>
</tr>
<tr class="row-even"><td>language</td>
<td>Language for the defined views</td>
</tr>
<tr class="row-odd"><td>purge_seq</td>
<td>The purge sequence that has been processed</td>
</tr>
<tr class="row-even"><td>signature</td>
<td>MD5 signature of the views for the design
document</td>
</tr>
<tr class="row-odd"><td>update_seq</td>
<td>The update sequence of the corresponding
database that has been indexed</td>
</tr>
<tr class="row-even"><td>updater_running</td>
<td>Indicates if the view is currently being
updated</td>
</tr>
<tr class="row-odd"><td>waiting_clients</td>
<td>Number of clients waiting on views from this
design document</td>
</tr>
<tr class="row-even"><td>waiting_commit</td>
<td>Indicates if there are outstanding commits
to the underlying database that need to
processed</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="document-with-attachments">
<h3>Document with Attachments<a class="headerlink" href="#document-with-attachments" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>_id (optional)</td>
<td>Document ID</td>
</tr>
<tr class="row-odd"><td>_rev (optional)</td>
<td>Revision ID (when updating an existing
document)</td>
</tr>
<tr class="row-even"><td>_attachments (optional)</td>
<td>Document Attachment</td>
</tr>
<tr class="row-odd"><td>filename</td>
<td>Attachment information</td>
</tr>
<tr class="row-even"><td>content_type</td>
<td>MIME Content type string</td>
</tr>
<tr class="row-odd"><td>data</td>
<td>File attachment content, Base64 encoded</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="list-of-active-tasks">
<h3>List of Active Tasks<a class="headerlink" href="#list-of-active-tasks" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>tasks [array]</td>
<td>Active Tasks</td>
</tr>
<tr class="row-odd"><td>pid</td>
<td>Process ID</td>
</tr>
<tr class="row-even"><td>status</td>
<td>Task status message</td>
</tr>
<tr class="row-odd"><td>task</td>
<td>Task name</td>
</tr>
<tr class="row-even"><td>type</td>
<td>Operation Type</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="replication-settings">
<span id="id1"></span><h3>Replication Settings<a class="headerlink" href="#replication-settings" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>source</td>
<td>Source database name or URL</td>
</tr>
<tr class="row-odd"><td>target</td>
<td>Target database name or URL</td>
</tr>
<tr class="row-even"><td>create_target (optional)</td>
<td>Creates the target database</td>
</tr>
<tr class="row-odd"><td>continuous (optional)</td>
<td>Configure the replication to be continuous</td>
</tr>
<tr class="row-even"><td>cancel (optional)</td>
<td>Cancels the replication</td>
</tr>
<tr class="row-odd"><td>doc_ids (optional)</td>
<td>Array of document IDs to be synchronized</td>
</tr>
<tr class="row-even"><td>proxy (optional)</td>
<td>Address of a proxy server through which
replication should occur</td>
</tr>
<tr class="row-odd"><td>since_seq (optional)</td>
<td>Sequence from which the replication should
start</td>
</tr>
<tr class="row-even"><td>filter (optional)</td>
<td>name of the filter function in the form of
<tt class="docutils literal"><span class="pre">ddoc/myfilter</span></tt></td>
</tr>
<tr class="row-odd"><td>query_params (optional)</td>
<td>Query parameter that are passed to the
filter function; the value should be a
document containing parameters as members</td>
</tr>
<tr class="row-even"><td>use_checkpoints (optional)</td>
<td>Whether to use replication checkpoints
or not</td>
</tr>
<tr class="row-odd"><td>checkpoint_interval (optional)</td>
<td>Specifies the checkpoint interval in ms.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="replication-status">
<span id="id2"></span><h3>Replication Status<a class="headerlink" href="#replication-status" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ok</td>
<td>Replication status</td>
</tr>
<tr class="row-odd"><td>session_id</td>
<td>Unique session ID</td>
</tr>
<tr class="row-even"><td>source_last_seq</td>
<td>Last sequence number read from the source
database</td>
</tr>
<tr class="row-odd"><td>history [array]</td>
<td>Replication History</td>
</tr>
<tr class="row-even"><td>session_id</td>
<td>Session ID for this replication operation</td>
</tr>
<tr class="row-odd"><td>recorded_seq</td>
<td>Last recorded sequence number</td>
</tr>
<tr class="row-even"><td>docs_read</td>
<td>Number of documents read</td>
</tr>
<tr class="row-odd"><td>docs_written</td>
<td>Number of documents written to target</td>
</tr>
<tr class="row-even"><td>doc_write_failures</td>
<td>Number of document write failures</td>
</tr>
<tr class="row-odd"><td>start_time</td>
<td>Date/Time replication operation started</td>
</tr>
<tr class="row-even"><td>start_last_seq</td>
<td>First sequence number in changes stream</td>
</tr>
<tr class="row-odd"><td>end_time</td>
<td>Date/Time replication operation completed</td>
</tr>
<tr class="row-even"><td>end_last_seq</td>
<td>Last sequence number in changes stream</td>
</tr>
<tr class="row-odd"><td>missing_checked</td>
<td>Number of missing documents checked</td>
</tr>
<tr class="row-even"><td>missing_found</td>
<td>Number of missing documents found</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="request-object">
<span id="id3"></span><h3>Request object<a class="headerlink" href="#request-object" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>body</td>
<td>Request body data as <cite>string</cite>.
If the request method is <cite>GET</cite> this field
contains the value <tt class="docutils literal"><span class="pre">&quot;undefined&quot;</span></tt>. If the
method is <cite>DELETE</cite> or <cite>HEAD</cite> the value is
<tt class="docutils literal"><span class="pre">&quot;&quot;</span></tt> (empty string).</td>
</tr>
<tr class="row-odd"><td>cookie</td>
<td>Cookies <cite>object</cite>.</td>
</tr>
<tr class="row-even"><td>form</td>
<td>Form data <cite>object</cite>.
Contains the decoded body as key-value
pairs if the <cite>Content-Type</cite> header was
<tt class="docutils literal"><span class="pre">application/x-www-form-urlencoded</span></tt>.</td>
</tr>
<tr class="row-odd"><td>headers</td>
<td>Request headers <cite>object</cite>.</td>
</tr>
<tr class="row-even"><td>id</td>
<td>Requested document id <cite>string</cite> if it was
specified or <tt class="docutils literal"><span class="pre">null</span></tt> otherwise.</td>
</tr>
<tr class="row-odd"><td>info</td>
<td><a class="reference internal" href="contents.html#dbinfo-object"><em>Database information</em></a></td>
</tr>
<tr class="row-even"><td>method</td>
<td>Request method as <cite>string</cite> or <cite>array</cite>.
String value is a method as one of: <cite>HEAD</cite>,
<cite>GET</cite>, <cite>POST</cite>, <cite>PUT</cite>, <cite>DELETE</cite>, <cite>OPTIONS</cite>,
and <cite>TRACE</cite>. Otherwise it will be
represented as an array of char codes.</td>
</tr>
<tr class="row-odd"><td>path</td>
<td>List of requested path sections.</td>
</tr>
<tr class="row-even"><td>peer</td>
<td>Request source IP address.</td>
</tr>
<tr class="row-odd"><td>query</td>
<td>URL query parameters <cite>object</cite>.
Note that multiple keys are not supported
and the last key value suppresses others.</td>
</tr>
<tr class="row-even"><td>requested_path</td>
<td>List of actual requested path section.</td>
</tr>
<tr class="row-odd"><td>raw_path</td>
<td>Raw requested path <cite>string</cite>.</td>
</tr>
<tr class="row-even"><td>secObj</td>
<td><a class="reference internal" href="contents.html#security-object"><em>Security Object</em></a>.</td>
</tr>
<tr class="row-odd"><td>userCtx</td>
<td><a class="reference internal" href="contents.html#userctx-object"><em>User Context Object</em></a>.</td>
</tr>
<tr class="row-even"><td>uuid</td>
<td>Generated UUID by a specified algorithm in
the config file.</td>
</tr>
</tbody>
</table>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;body&quot;</span><span class="o">:</span> <span class="s2">&quot;undefined&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cookie&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;AuthSession&quot;</span><span class="o">:</span> <span class="s2">&quot;cm9vdDo1MDZBRjQzRjrfcuikzPRfAn-EA37FmjyfM8G8Lw&quot;</span><span class="p">,</span>
        <span class="s2">&quot;m&quot;</span><span class="o">:</span> <span class="s2">&quot;3234&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;form&quot;</span><span class="o">:</span> <span class="p">{},</span>
    <span class="s2">&quot;headers&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;Accept&quot;</span><span class="o">:</span> <span class="s2">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept-Charset&quot;</span><span class="o">:</span> <span class="s2">&quot;ISO-8859-1,utf-8;q=0.7,*;q=0.3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept-Encoding&quot;</span><span class="o">:</span> <span class="s2">&quot;gzip,deflate,sdch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept-Language&quot;</span><span class="o">:</span> <span class="s2">&quot;en-US,en;q=0.8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Connection&quot;</span><span class="o">:</span> <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cookie&quot;</span><span class="o">:</span> <span class="s2">&quot;m=3234:t|3247:t|6493:t|6967:t|34e2:|18c3:t|2c69:t|5acb:t|ca3:t|c01:t|5e55:t|77cb:t|2a03:t|1d98:t|47ba:t|64b8:t|4a01:t; AuthSession=cm9vdDo1MDZBRjQzRjrfcuikzPRfAn-EA37FmjyfM8G8Lw&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Host&quot;</span><span class="o">:</span> <span class="s2">&quot;127.0.0.1:5984&quot;</span><span class="p">,</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="o">:</span> <span class="s2">&quot;Mozilla/5.0 (Windows NT 5.2) AppleWebKit/535.7 (KHTML, like Gecko) Chrome/16.0.912.75 Safari/535.7&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;info&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;committed_update_seq&quot;</span><span class="o">:</span> <span class="mi">2701412</span><span class="p">,</span>
        <span class="s2">&quot;compact_running&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="s2">&quot;data_size&quot;</span><span class="o">:</span> <span class="mi">7580843252</span><span class="p">,</span>
        <span class="s2">&quot;db_name&quot;</span><span class="o">:</span> <span class="s2">&quot;mailbox&quot;</span><span class="p">,</span>
        <span class="s2">&quot;disk_format_version&quot;</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
        <span class="s2">&quot;disk_size&quot;</span><span class="o">:</span> <span class="mi">14325313673</span><span class="p">,</span>
        <span class="s2">&quot;doc_count&quot;</span><span class="o">:</span> <span class="mi">2262757</span><span class="p">,</span>
        <span class="s2">&quot;doc_del_count&quot;</span><span class="o">:</span> <span class="mi">560</span><span class="p">,</span>
        <span class="s2">&quot;instance_start_time&quot;</span><span class="o">:</span> <span class="s2">&quot;1347601025628957&quot;</span><span class="p">,</span>
        <span class="s2">&quot;purge_seq&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;update_seq&quot;</span><span class="o">:</span> <span class="mi">2701412</span>
    <span class="p">},</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
    <span class="s2">&quot;path&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">&quot;mailbox&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_design&quot;</span><span class="p">,</span>
        <span class="s2">&quot;request&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_show&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dump&quot;</span><span class="p">,</span>
        <span class="s2">&quot;foo&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;peer&quot;</span><span class="o">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;query&quot;</span><span class="o">:</span> <span class="p">{},</span>
    <span class="s2">&quot;raw_path&quot;</span><span class="o">:</span> <span class="s2">&quot;/mailbox/_design/request/_show/dump/foo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;requested_path&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">&quot;mailbox&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_design&quot;</span><span class="p">,</span>
        <span class="s2">&quot;request&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_show&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dump&quot;</span><span class="p">,</span>
        <span class="s2">&quot;foo&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;secObj&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;admins&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;names&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;Bob&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[]</span>
        <span class="p">},</span>
        <span class="s2">&quot;members&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;names&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;Mike&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Alice&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[]</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">&quot;userCtx&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;db&quot;</span><span class="o">:</span> <span class="s2">&quot;mailbox&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Mike&quot;</span><span class="p">,</span>
        <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[</span>
            <span class="s2">&quot;user&quot;</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;uuid&quot;</span><span class="o">:</span> <span class="s2">&quot;3184f9d1ea934e1f81a24c71bde5c168&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="response-object">
<span id="id4"></span><h3>Response object<a class="headerlink" href="#response-object" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>code</td>
<td>HTTP status code <cite>number</cite>.</td>
</tr>
<tr class="row-odd"><td>json</td>
<td>JSON encodable <cite>object</cite>.
Implicitly sets <cite>Content-Type</cite> header as
<tt class="docutils literal"><span class="pre">application/json</span></tt>.</td>
</tr>
<tr class="row-even"><td>body</td>
<td>Raw response text <cite>string</cite>.
Implicitly sets <cite>Content-Type</cite> header as
<tt class="docutils literal"><span class="pre">text/html;</span> <span class="pre">charset=utf-8</span></tt>.</td>
</tr>
<tr class="row-odd"><td>base64</td>
<td>Base64 encoded <cite>string</cite>.
Implicitly sets <cite>Content-Type</cite> header as
<tt class="docutils literal"><span class="pre">application/binary</span></tt>.</td>
</tr>
<tr class="row-even"><td>headers</td>
<td>Response headers <cite>object</cite>.
<cite>Content-Type</cite> header from this object
overrides any implicitly assigned one.</td>
</tr>
<tr class="row-odd"><td>stop</td>
<td><cite>boolean</cite> signal to stop iteration over
view result rows (for list functions only)</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The <tt class="docutils literal"><span class="pre">body</span></tt>, <tt class="docutils literal"><span class="pre">base64</span></tt> and <tt class="docutils literal"><span class="pre">json</span></tt> object keys are overlapping each other
where the last one wins. Since most realizations of key-value objects do
not preserve the key order or if they are mixed, confusing situations can
occure. Try to use only one of them.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Any custom property makes CouchDB raise an internal exception.
Furthermore, the <cite>Response object</cite> could be a simple string value which would
be implicitly wrapped into a <tt class="docutils literal"><span class="pre">{&quot;body&quot;:</span> <span class="pre">...}</span></tt> object.</p>
</div>
</div>
<div class="section" id="returned-couchdb-document-with-detailed-revision-info">
<h3>Returned CouchDB Document with Detailed Revision Info<a class="headerlink" href="#returned-couchdb-document-with-detailed-revision-info" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>_id (optional)</td>
<td>Document ID</td>
</tr>
<tr class="row-odd"><td>_rev (optional)</td>
<td>Revision ID (when updating an existing
document)</td>
</tr>
<tr class="row-even"><td>_revs_info [array]</td>
<td>CouchDB document extended revision info</td>
</tr>
<tr class="row-odd"><td>rev</td>
<td>Full revision string</td>
</tr>
<tr class="row-even"><td>status</td>
<td>Status of the revision</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="returned-couchdb-document-with-revision-info">
<h3>Returned CouchDB Document with Revision Info<a class="headerlink" href="#returned-couchdb-document-with-revision-info" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>_id (optional)</td>
<td>Document ID</td>
</tr>
<tr class="row-odd"><td>_rev (optional)</td>
<td>Revision ID (when updating an existing
document)</td>
</tr>
<tr class="row-even"><td>_revisions</td>
<td>CouchDB document revisions</td>
</tr>
<tr class="row-odd"><td>ids [array]</td>
<td>Array of valid revision IDs, in reverse
order (latest first)</td>
</tr>
<tr class="row-even"><td>start</td>
<td>Prefix number for the latest revision</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="returned-document-with-attachments">
<h3>Returned Document with Attachments<a class="headerlink" href="#returned-document-with-attachments" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>_id (optional)</td>
<td>Document ID</td>
</tr>
<tr class="row-odd"><td>_rev (optional)</td>
<td>Revision ID (when updating an existing
document)</td>
</tr>
<tr class="row-even"><td>_attachments (optional)</td>
<td>Document attachment</td>
</tr>
<tr class="row-odd"><td>filename</td>
<td>Attachment</td>
</tr>
<tr class="row-even"><td>stub</td>
<td>Indicates whether the attachment is a stub</td>
</tr>
<tr class="row-odd"><td>content_type</td>
<td>MIME Content type string</td>
</tr>
<tr class="row-even"><td>length</td>
<td>Length (bytes) of the attachment data</td>
</tr>
<tr class="row-odd"><td>revpos</td>
<td>Revision where this attachment exists</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="security-object">
<span id="id5"></span><h3>Security Object<a class="headerlink" href="#security-object" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>admins</td>
<td>Roles/Users with admin privileges</td>
</tr>
<tr class="row-odd"><td>roles [array]</td>
<td>List of roles with parent privilege</td>
</tr>
<tr class="row-even"><td>users [array]</td>
<td>List of users with parent privilege</td>
</tr>
<tr class="row-odd"><td>readers</td>
<td>Roles/Users with reader privileges</td>
</tr>
<tr class="row-even"><td>roles [array]</td>
<td>List of roles with parent privilege</td>
</tr>
<tr class="row-odd"><td>users [array]</td>
<td>List of users with parent privilege</td>
</tr>
</tbody>
</table>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;admins&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;names&quot;</span><span class="o">:</span> <span class="p">[</span>
            <span class="s2">&quot;Bob&quot;</span>
        <span class="p">],</span>
        <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[]</span>
    <span class="p">},</span>
    <span class="s2">&quot;members&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;names&quot;</span><span class="o">:</span> <span class="p">[</span>
            <span class="s2">&quot;Mike&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Alice&quot;</span>
        <span class="p">],</span>
        <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[]</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="user-context-object">
<span id="userctx-object"></span><h3>User Context Object<a class="headerlink" href="#user-context-object" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>db</td>
<td>Database name in the context of the
provided operation.</td>
</tr>
<tr class="row-odd"><td>name</td>
<td>User name.</td>
</tr>
<tr class="row-even"><td>roles</td>
<td>List of user roles.</td>
</tr>
</tbody>
</table>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;db&quot;</span><span class="o">:</span> <span class="s2">&quot;mailbox&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="s2">&quot;roles&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">&quot;_admin&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="view-head-information">
<span id="view-head-info-object"></span><h3>View Head Information<a class="headerlink" href="#view-head-information" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Field</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>total_rows</td>
<td>Number of documents in the view</td>
</tr>
<tr class="row-odd"><td>offset</td>
<td>Offset where the document list started</td>
</tr>
</tbody>
</table>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;total_rows&quot;</span><span class="o">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s2">&quot;offset&quot;</span><span class="o">:</span> <span class="mi">3</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<span id="document-experimental"></span><div class="section" id="experimental-features">
<span id="experimental"></span><h2>Experimental Features<a class="headerlink" href="#experimental-features" title="Permalink to this headline">¶</a></h2>
<p>This is a list of experimental features in CouchDB. They are included in
a release because the development team is requesting feedback from the
larger developer community. As such, please play around with these features
and send us feedback, thanks!</p>
<p>Use at your own risk! Do not rely on these features for critical
applications.</p>
<div class="section" id="nodejs-query-server">
<h3>NodeJS Query Server<a class="headerlink" href="#nodejs-query-server" title="Permalink to this headline">¶</a></h3>
<p>The NodeJS Query Server is an alternative runtime environment for
the default JavaScript Query Server that runs on top of Node.JS and
not SpiderMonkey like the default Query Server.</p>
<div class="section" id="setup">
<h4>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h4>
<p>You will need to install Node.JS version 0.10.0 or later. See <a class="reference external" href="http://nodejs.org/download/">Node.JS
Downloads</a> for options.</p>
<ol class="arabic">
<li><p class="first">Install the <cite>couchjs-node</cite> binary. Either from the CouchDB sources:</p>
<div class="highlight-ini"><div class="highlight"><pre>cd src/couchjs-node
npm link
</pre></div>
</div>
</li>
</ol>
<p>Or via NPM:</p>
<div class="highlight-ini"><div class="highlight"><pre>npm install -g couchjs
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>NPM in non-standard locations</strong></p>
<p>If your Node.JS installation doesn’t store binaries in <cite>/usr/local/bin</cite>
you will need to adjust CouchDB’s configuration. Add this to your <cite>local.ini</cite>
file:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[query_servers]</span>
<span class="na">nodejs</span> <span class="o">=</span> <span class="s">/path/to/couchjs-node /path/to/couchdb/share/server/main.js</span>
</pre></div>
</div>
<p class="last">And then restart your CouchDB instance.</p>
</div>
<p>2. Done. Now you can create design documents with the <cite>language</cite> parameter
set to <cite>nodejs</cite> and all JavaScript functions in this design document will
be processed by the Node.JS query server.</p>
<p>Enjoy!</p>
</div>
<div class="section" id="differences-from-the-spidermonkey-query-server">
<h4>Differences from the SpiderMonkey Query Server<a class="headerlink" href="#differences-from-the-spidermonkey-query-server" title="Permalink to this headline">¶</a></h4>
<p>V8 and SpiderMonkey roughly behave similar, but there might be engine-
specific differences that make or break a JavaScript function in one or
the other server.</p>
</div>
</div>
<div class="section" id="plugins">
<h3>Plugins<a class="headerlink" href="#plugins" title="Permalink to this headline">¶</a></h3>
<p>See <cite>src/couch_plugins/README.md</cite>.</p>
</div>
</div>
<span id="document-contributing"></span><div class="section" id="contributing-to-this-documentation">
<span id="contributing"></span><h2>Contributing to this Documentation<a class="headerlink" href="#contributing-to-this-documentation" title="Permalink to this headline">¶</a></h2>
<p>The documentation lives in the CouchDB source tree. We&#8217;ll start by forking and
closing the CouchDB GitHub mirror. That will allow us to send the contribution
to CouchDB with a pull request.</p>
<p>If you don&#8217;t have a GitHub account yet, it is a good time to get one, they are
free. If you don&#8217;t want to use GitHub, there are alternate ways to
contributing back, that we&#8217;ll cover next time.</p>
<p>Go to <a class="reference external" href="https://github.com/apache/couchdb">https://github.com/apache/couchdb</a> and click the &#8220;fork&#8221; button in the top
right. This will create a fork of CouchDB in your GitHub account. Mine is
<cite>janl</cite>, so my fork lives at <a class="reference external" href="https://github.com/janl/couchdb">https://github.com/janl/couchdb</a>. In the header, it
tells me me my &#8220;GitHub Clone URL&#8221;. We need to copy that and start a terminal:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>git clone https://github.com/janl/couchdb.git
<span class="nv">$ </span><span class="nb">cd </span>couchdb
<span class="nv">$ </span>subl .
</pre></div>
</div>
<p>I&#8217;m opening the whole CouchDB source tree in my favourite editor. It gives
me the usual directory listing:</p>
<div class="highlight-bash"><div class="highlight"><pre>.git/
.gitignore
.mailmap
.travis.yml
AUTHORS
BUGS
CHANGES
DEVELOPERS
INSTALL
INSTALL.Unix
INSTALL.Windows
LICENSE
Makefile.am
NEWS
NOTICE
README
THANKS.in
acinclude.m4.in
bin/
bootstrap
build-aux/
configure.ac
etc/
license.skip
share/
src/
<span class="nb">test</span>/
utils/
var/
</pre></div>
</div>
<p>The documentation sources live in <cite>share/doc/src</cite>, you can safely ignore all
the other files and directories.</p>
<p>First we should determine where we want to document this inside the
documentation. We can look through <a class="reference external" href="http://docs.couchdb.org/en/latest/">http://docs.couchdb.org/en/latest/</a>
for inspiration. The <a class="reference external" href="http://docs.couchdb.org/en/latest/json-structure.html">JSON Structure Reference</a> looks like a fine place to write this up.</p>
<p>The current state includes mostly tables describing the JSON structure (after
all, that&#8217;s the title of this chapter), but some prose about the number
representation can&#8217;t hurt. For future reference, since the topic in the thread
includes views and different encoding in views (as opposed to the storage
engine), we should remember to make a note in the views documentation as well,
but we&#8217;ll leave this for later.</p>
<p>Let&#8217;s try and find the source file that builds the file
<a class="reference external" href="http://docs.couchdb.org/en/latest/json-structure.html">http://docs.couchdb.org/en/latest/json-structure.html</a> &#8211; we are in luck, under
<cite>share/doc/src</cite> we find the file <cite>json-structure.rst</cite>. That looks promising.
<cite>.rst</cite> stands for ReStructured Text (see
<a class="reference external" href="http://thomas-cokelaer.info/tutorials/sphinx/rest_syntax.html">http://thomas-cokelaer.info/tutorials/sphinx/rest_syntax.html</a>
for a markup reference), which is an ascii format for writing
documents, documentation in this case. Let&#8217;s have a look and open it.</p>
<p>We see ascii tables with some additional formatting, all looking like the
final HTML. So far so easy. For now, let&#8217;s just add to the bottom of this. We
can worry about organising this better later.</p>
<p>We start by adding a new headline:</p>
<div class="highlight-ini"><div class="highlight"><pre>Number Handling
===============
</pre></div>
</div>
<p>Now we paste in the rest of the main email of the thread. It is mostly text,
but it includes some code listings. Let&#8217;s mark them up. We&#8217;ll turn:</p>
<div class="highlight-ini"><div class="highlight"><pre>ejson:encode(ejson:decode(&lt;&lt;&quot;1.1&quot;&gt;&gt;)).
&lt;&lt;&quot;1.1000000000000000888&quot;&gt;&gt;
</pre></div>
</div>
<p>Into:</p>
<div class="highlight-ini"><div class="highlight"><pre>.. code-block:: erlang

  ejson:encode(ejson:decode(&lt;&lt;&quot;1.1&quot;&gt;&gt;)).
  &lt;&lt;&quot;1.1000000000000000888&quot;&gt;&gt;
</pre></div>
</div>
<p>And we follow along with the other code samples. We turn:</p>
<div class="highlight-ini"><div class="highlight"><pre>Spidermonkey

$ js -h 2&gt;&amp;1 | head -n 1
JavaScript-C 1.8.5 2011-03-31
$ js
js&gt; JSON.stringify(JSON.parse(&quot;1.01234567890123456789012345678901234567890&quot;))
&quot;1.0123456789012346&quot;
js&gt; var f = JSON.stringify(JSON.parse(&quot;1.01234567890123456789012345678901234567890&quot;))
js&gt; JSON.stringify(JSON.parse(f))
&quot;1.0123456789012346&quot;
</pre></div>
</div>
<p>into:</p>
<div class="highlight-ini"><div class="highlight"><pre>Spidermonkey::

    $ js -h 2&gt;&amp;1 | head -n 1
    JavaScript-C 1.8.5 2011-03-31
    $ js
    js&gt; JSON.stringify(JSON.parse(&quot;1.01234567890123456789012345678901234567890&quot;))
    &quot;1.0123456789012346&quot;
    js&gt; var f = JSON.stringify(JSON.parse(&quot;1.01234567890123456789012345678901234567890&quot;))
    js&gt; JSON.stringify(JSON.parse(f))
    &quot;1.0123456789012346&quot;
</pre></div>
</div>
<p>And then follow all the other ones.</p>
<p>I cleaned up the text a little but to make it sound more like a documentation
entry as opposed to a post on a mailing list.</p>
<p>The next step would be to validate that we got all the markup right. I&#8217;ll
leave this for later. For now we&#8217;ll contribute our change back to CouchDB.</p>
<p>First, we commit our changes:</p>
<div class="highlight-ini"><div class="highlight"><pre>$ &gt; git commit -am &#39;document number encoding&#39;
[master a84b2cf] document number encoding
1 file changed, 199 insertions(+)
</pre></div>
</div>
<p>Then we push the commit to our CouchDB fork:</p>
<div class="highlight-ini"><div class="highlight"><pre>$ git push origin master
</pre></div>
</div>
<p>Next, we go back to our GitHub page <a class="reference external" href="https://github.com/janl/couchdb">https://github.com/janl/couchdb</a> and click
the &#8220;Pull Request&#8221; button. Fill in the description with something useful and
hit the &#8220;Send Pull Request&#8221; button.</p>
<p>And we&#8217;re done!</p>
</div>
<span id="document-whatsnew/index"></span><div class="section" id="release-history">
<span id="releases"></span><h2>Release History<a class="headerlink" href="#release-history" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-whatsnew/1.6"></span><div class="section" id="x-branch">
<span id="release-1-6-x"></span><h3>1.6.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#deprecations" id="id1">Deprecations</a></li>
<li><a class="reference internal" href="#version-1-6-1" id="id2">Version 1.6.1</a></li>
<li><a class="reference internal" href="#version-1-6-0" id="id3">Version 1.6.0</a></li>
</ul>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference internal" href="contents.html#release-1-6-1"><em>Version 1.6.1</em></a> contains important patches to hash of passwords on
restart. The previous <a class="reference internal" href="contents.html#release-1-6-0"><em>Version 1.6.0</em></a> release is not recommended for
usage as certain edge cases with admin passwords may prevent CouchDB from
starting.</p>
</div>
<div class="section" id="deprecations">
<span id="release-1-6-x-upgrade"></span><h4><a class="toc-backref" href="#id1">Deprecations</a><a class="headerlink" href="#deprecations" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference internal" href="contents.html#api-auth-proxy"><em>Proxy Authentication</em></a> handler was renamed to
<tt class="docutils literal"><span class="pre">proxy_authentication_handler</span></tt> to follow the <tt class="docutils literal"><span class="pre">*_authentication_handler</span></tt> from
of all other handlers. The old <tt class="docutils literal"><span class="pre">proxy_authentification_handler</span></tt> name is marked
as deprecated and will be removed in future releases. It&#8217;s highly recommended
to update <a class="reference internal" href="contents.html#httpd/authentication_handlers" title="authentication_handlers"><tt class="xref config config-option docutils literal"><span class="pre">httpd/authentication_handlers</span></tt></a> option with the new
value if you have used such a handler.</p>
</div>
<div class="section" id="version-1-6-1">
<span id="release-1-6-1"></span><h4><a class="toc-backref" href="#id2">Version 1.6.1</a><a class="headerlink" href="#version-1-6-1" title="Permalink to this headline">¶</a></h4>
<p>A bugfix release to handle various edge cases related to admin password hashing.</p>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2298">COUCHDB-2298</a>: Hash plaintext admin passwords stored in <tt class="docutils literal"><span class="pre">local.ini</span></tt> on startup
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=ed825d3">#ed825d3</a>.</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2299">COUCHDB-2299</a>: Filter out local admin users before updating password hash in
<tt class="docutils literal"><span class="pre">_users</span></tt> db <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=5e46f3b">#5e46f3b</a>.</li>
</ul>
</div>
<div class="section" id="version-1-6-0">
<span id="release-1-6-0"></span><h4><a class="toc-backref" href="#id3">Version 1.6.0</a><a class="headerlink" href="#version-1-6-0" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2200">COUCHDB-2200</a>: support Erlang/OTP 17.0 <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=35e16032">#35e16032</a></li>
<li>Fauxton: many improvements in our experimental new user interface, including
switching the code editor from CodeMirror to Ace as well as better support
for various browsers.</li>
<li>Add the <tt class="docutils literal"><span class="pre">max_count</span></tt> option (<a class="reference internal" href="contents.html#config-uuids"><em>UUIDs Configuration</em></a>) to allow rate-limiting
the amount of UUIDs that can be requested from the <a class="reference internal" href="contents.html#api-server-uuids"><em>/_uuids</em></a>
handler in a single request (<a class="reference internal" href="contents.html#cve-2014-2668"><em>CVE 2014-2668</em></a>).</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1986">COUCHDB-1986</a>: increase socket buffer size to improve replication speed
for large documents and attachments, and fix tests on BSD-like systems.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=9a0e561b">#9a0e561b</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1953">COUCHDB-1953</a>: improve performance of multipart/related requests.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=ce3e89dc">#ce3e89dc</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2221">COUCHDB-2221</a>: verify that authentication-related configuration settings
are well-formed. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=dbe769c6">#dbe769c6</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1922">COUCHDB-1922</a>: fix CORS exposed headers. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=4f619833">#4f619833</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1795">COUCHDB-1795</a>: ensure the startup script clears the pid file on termination.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=818ef4f9">#818ef4f9</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1962">COUCHDB-1962</a>: replication can now be performed without having write access
to the source database (<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=1d5fe2aa">#1d5fe2aa</a>), the replication checkpoint
interval is now configurable (<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=0693f98e">#0693f98e</a>).</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2025">COUCHDB-2025</a>: add support for SOCKS5 proxies for replication.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=fcd76c9">#fcd76c9</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1930">COUCHDB-1930</a>: redirect to the correct page after submitting a new document
with a different ID than the one suggested by Futon. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=4906b591">#4906b591</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1923">COUCHDB-1923</a>: add support for <cite>attachments</cite> and <cite>att_encoding_info</cite> options
(formerly only available on the documents API) to the view API.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=ca41964b">#ca41964b</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1780">COUCHDB-1780</a>: upgrade password hashes from SHA-1 to PBKDF2 scheme on
successful authentication. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=34888938">#34888938</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2059">COUCHDB-2059</a>: allow run-time configuration of maximum URL length.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=f7ca266b">#f7ca266b</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2054">COUCHDB-2054</a>: accept gzipped JSON request bodies. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=4d893387">#4d893387</a></li>
<li>Rename <tt class="docutils literal"><span class="pre">proxy_authentification_handler</span></tt> to <tt class="docutils literal"><span class="pre">proxy_authentication_handler</span></tt>.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=c66ac4a8">#c66ac4a8</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1647">COUCHDB-1647</a>: for failed replications originating from a document in the
<cite>_replicator</cite> database, store the failure reason in the document.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=08cac68b">#08cac68b</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2053">COUCHDB-2053</a>: send better error messages when both <cite>key</cite> and <cite>keys</cite>
parameters are specified in view requests. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=2bc07840">#2bc07840</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2040">COUCHDB-2040</a>: send better error messages when incorrect checksums
are encountered during compaction. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=e7fdc16a">#e7fdc16a</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2028">COUCHDB-2028</a>: allow intermedia certificates when using SSL/TLS.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=2d080449">#2d080449</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-2031">COUCHDB-2031</a>: fix rewriting of paths with query string parameters.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=37c84596">#37c84596</a></li>
<li>Numerous improvements to the documentation.</li>
</ul>
</div>
</div>
<span id="document-whatsnew/1.5"></span><div class="section" id="x-branch">
<span id="release-1-5-x"></span><h3>1.5.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#version-1-5-1" id="id1">Version 1.5.1</a></li>
<li><a class="reference internal" href="#version-1-5-0" id="id2">Version 1.5.0</a></li>
</ul>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference internal" href="contents.html#release-1-5-1"><em>Version 1.5.1</em></a> contains important security fixes. Previous <cite>1.5.x</cite>
releases are not recommended for regular usage.</p>
</div>
<div class="section" id="version-1-5-1">
<span id="release-1-5-1"></span><h4><a class="toc-backref" href="#id1">Version 1.5.1</a><a class="headerlink" href="#version-1-5-1" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Add the <tt class="docutils literal"><span class="pre">max_count</span></tt> option (<a class="reference internal" href="contents.html#config-uuids"><em>UUIDs Configuration</em></a>) to allow rate-limiting
the amount of UUIDs that can be requested from the <a class="reference internal" href="contents.html#api-server-uuids"><em>/_uuids</em></a>
handler in a single request (<a class="reference internal" href="contents.html#cve-2014-2668"><em>CVE 2014-2668</em></a>).</li>
</ul>
</div>
<div class="section" id="version-1-5-0">
<span id="release-1-5-0"></span><h4><a class="toc-backref" href="#id2">Version 1.5.0</a><a class="headerlink" href="#version-1-5-0" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1781">COUCHDB-1781</a>: The official documentation has been overhauled. A lot of
content from other sources have been merged, and the index page
has been rebuilt to make the docs much more accessible.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=54813a7">#54813a7</a></li>
<li>A new administration UI, codenamed Fauxton, has been included as an
experimental preview. It can be accessed at <tt class="docutils literal"><span class="pre">/_utils/fauxton/</span></tt>. There
are too many improvements here to list them all. We are looking for
feedback from the community on this preview release.</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1888">COUCHDB-1888</a>: Fixed an issue where admin users would be restricted by
the <tt class="docutils literal"><span class="pre">public_fields</span></tt> feature.</li>
<li>Fixed an issue with the JavaScript CLI test runner. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=be76882">#be76882</a>,
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=54813a7">#54813a7</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1867">COUCHDB-1867</a>: An experimental plugin feature has been added. See
<tt class="docutils literal"><span class="pre">src/couch_plugin/README.md</span></tt> for details. We invite the community to
test and report any findings.</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1894">COUCHDB-1894</a>: An experimental Node.js-based query server runtime
has been added. See <a class="reference internal" href="contents.html#experimental"><em>Experimental Features</em></a> for details. We invite the
community to test and report any findings.</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1901">COUCHDB-1901</a>: Better retry mechanism for transferring attachments
during replication. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=4ca2cec">#4ca2cec</a></li>
</ul>
</div>
</div>
<span id="document-whatsnew/1.4"></span><div class="section" id="x-branch">
<span id="release-1-4-x"></span><h3>1.4.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#upgrade-notes" id="id1">Upgrade Notes</a></li>
<li><a class="reference internal" href="#version-1-4-0" id="id2">Version 1.4.0</a></li>
</ul>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference internal" href="contents.html#release-1-4-x"><em>1.4.x Branch</em></a> is affected by the issue described in <a class="reference internal" href="contents.html#cve-2014-2668"><em>CVE-2014-2668: DoS (CPU and memory consumption) via the count parameter to /_uuids</em></a>.
Upgrading to a more recent release is strongly recommended.</p>
</div>
<div class="section" id="upgrade-notes">
<span id="release-1-4-x-upgrade"></span><h4><a class="toc-backref" href="#id1">Upgrade Notes</a><a class="headerlink" href="#upgrade-notes" title="Permalink to this headline">¶</a></h4>
<p>We now support Erlang/OTP R16B and R16B01; the minimum required version is R14B.</p>
<p>User document role values must now be strings. Other types of values will be
refused when saving the user document.</p>
</div>
<div class="section" id="version-1-4-0">
<span id="release-1-4-0"></span><h4><a class="toc-backref" href="#id2">Version 1.4.0</a><a class="headerlink" href="#version-1-4-0" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1139">COUCHDB-1139</a>: it&#8217;s possible to apply <a class="reference internal" href="contents.html#listfun"><em>list</em></a>
functions to <tt class="docutils literal"><span class="pre">_all_docs</span></tt> view. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=54fd258e">#54fd258e</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1632">COUCHDB-1632</a>: Ignore epilogues in <tt class="docutils literal"><span class="pre">multipart/related</span></tt> MIME attachments.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=2b4ab67a">#2b4ab67a</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1634">COUCHDB-1634</a>: Reduce PBKDF2 work factor. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=f726bc4d">#f726bc4d</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1684">COUCHDB-1684</a>: Support for server-wide changes feed reporting on creation,
updates and deletion of databases. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=917d8988">#917d8988</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1772">COUCHDB-1772</a>: Prevent invalid JSON output when using <cite>all_or_nothing</cite>
<a class="reference internal" href="contents.html#api-db-bulk-docs"><em>of bulk API</em></a>. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=dfd39d57">#dfd39d57</a></li>
<li>Add a <a class="reference internal" href="contents.html#couch_httpd_auth/public_fields" title="public_fields"><tt class="xref config config-option docutils literal"><span class="pre">configurable</span> <span class="pre">whitelist</span></tt></a>
of user document properties. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=8d7ab8b1">#8d7ab8b1</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1852">COUCHDB-1852</a>: Support Last-Event-ID header in EventSource changes feeds.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=dfd2199a">#dfd2199a</a></li>
<li>Allow storing pre-hashed admin passwords via <a class="reference internal" href="contents.html#api-config"><em>config API</em></a>.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=c98ba561">#c98ba561</a></li>
<li>Automatic loading of CouchDB plugins. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=3fab6bb5">#3fab6bb5</a></li>
<li>Much improved documentation, including an <a class="reference internal" href="contents.html#vdufun"><em>expanded description</em></a> of <cite>validate_doc_update</cite> functions (commit:<cite>ef9ac469</cite>) and
a description of how  CouchDB handles JSON <a class="reference internal" href="contents.html#json-numbers"><em>number values</em></a> (<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=bbd93f77">#bbd93f77</a>).</li>
<li>Split up <cite>replicator_db</cite> tests into multiple independent tests.</li>
</ul>
</div>
</div>
<span id="document-whatsnew/1.3"></span><div class="section" id="x-branch">
<span id="release-1-3-x"></span><h3>1.3.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#upgrade-notes" id="id3">Upgrade Notes</a></li>
<li><a class="reference internal" href="#version-1-3-1" id="id4">Version 1.3.1</a></li>
<li><a class="reference internal" href="#version-1-3-0" id="id5">Version 1.3.0</a></li>
</ul>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference internal" href="contents.html#release-1-3-x"><em>1.3.x Branch</em></a> is affected by the issue described in <a class="reference internal" href="contents.html#cve-2014-2668"><em>CVE-2014-2668: DoS (CPU and memory consumption) via the count parameter to /_uuids</em></a>.
Upgrading to a more recent release is strongly recommended.</p>
</div>
<div class="section" id="upgrade-notes">
<span id="release-1-3-x-upgrade"></span><h4><a class="toc-backref" href="#id3">Upgrade Notes</a><a class="headerlink" href="#upgrade-notes" title="Permalink to this headline">¶</a></h4>
<p>You can upgrade your existing CouchDB 1.0.x installation to 1.3.0
without any specific steps or migration. When you run CouchDB, the
existing data and index files will be opened and used as normal.</p>
<p>The first time you run a compaction routine on your database within 1.3.0,
the data structure and indexes will be updated to the new version of the
CouchDB database format that can only be read by CouchDB 1.3.0 and later.
This step is not reversible. Once the data files have been updated and
migrated to the new version the data files will no longer work with a
CouchDB 1.0.x release.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you want to retain support for opening the data files in
CouchDB 1.0.x you must back up your data files before performing the
upgrade and compaction process.</p>
</div>
</div>
<div class="section" id="version-1-3-1">
<span id="release-1-3-1"></span><h4><a class="toc-backref" href="#id4">Version 1.3.1</a><a class="headerlink" href="#version-1-3-1" title="Permalink to this headline">¶</a></h4>
<div class="section" id="replicator">
<h5>Replicator<a class="headerlink" href="#replicator" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1788">COUCHDB-1788</a>: Tolerate missing source and target fields in _replicator docs.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=869f42e2">#869f42e2</a></li>
</ul>
</div>
<div class="section" id="log-system">
<h5>Log System<a class="headerlink" href="#log-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1794">COUCHDB-1794</a>: Fix bug in WARN level logging from 1.3.0.</li>
<li>Don&#8217;t log about missing .compact files. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=06f1a8dc">#06f1a8dc</a></li>
</ul>
</div>
<div class="section" id="view-server">
<h5>View Server<a class="headerlink" href="#view-server" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1792">COUCHDB-1792</a>: Fix the -S option to couchjs to increase memory limits.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=cfaa66cd">#cfaa66cd</a></li>
</ul>
</div>
<div class="section" id="miscellaneous">
<h5>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1784">COUCHDB-1784</a>: Improvements to test suite and VPATH build system.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=01afaa4f">#01afaa4f</a></li>
<li>Improve documentation: better structure, improve language, less duplication.</li>
</ul>
</div>
</div>
<div class="section" id="version-1-3-0">
<span id="release-1-3-0"></span><h4><a class="toc-backref" href="#id5">Version 1.3.0</a><a class="headerlink" href="#version-1-3-0" title="Permalink to this headline">¶</a></h4>
<div class="section" id="database-core">
<h5>Database core<a class="headerlink" href="#database-core" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1512">COUCHDB-1512</a>: Validate bind address before assignment. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=09ead8a0">#09ead8a0</a></li>
<li>Restore <tt class="docutils literal"><span class="pre">max_document_size</span></tt> protection. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=bf1eb135">#bf1eb135</a></li>
</ul>
</div>
<div class="section" id="documentation">
<h5>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1523">COUCHDB-1523</a>: Import CouchBase documentation and convert them into
<a class="reference external" href="http://sphinx.pocoo.org/">Sphinx docs</a></li>
</ul>
</div>
<div class="section" id="futon">
<h5>Futon<a class="headerlink" href="#futon" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-509">COUCHDB-509</a>: Added view request duration to Futon. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=2d2c7d1e">#2d2c7d1e</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-627">COUCHDB-627</a>: Support all timezones. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=b1a049bb">#b1a049bb</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1383">COUCHDB-1383</a>: Futon view editor won&#8217;t allow you to save original view after
saving a revision. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=ce48342">#ce48342</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1470">COUCHDB-1470</a>: Futon raises popup on attempt to navigate to missed/deleted
document. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=5da40eef">#5da40eef</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1473">COUCHDB-1473</a>, <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1472">COUCHDB-1472</a>: Disable buttons for actions that the user
doesn&#8217;t have permissions to. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=7156254d">#7156254d</a></li>
</ul>
</div>
<div class="section" id="http-interface">
<h5>HTTP Interface<a class="headerlink" href="#http-interface" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-431">COUCHDB-431</a>: Introduce experimental <a class="reference internal" href="contents.html#cors"><em>CORS support</em></a>.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=b90e4021">#b90e4021</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-764">COUCHDB-764</a>, <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-514">COUCHDB-514</a>, <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-430">COUCHDB-430</a>: Fix sending HTTP headers from
<tt class="docutils literal"><span class="pre">_list</span></tt> function, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=2a74f88375">#2a74f88375</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-887">COUCHDB-887</a>: Fix <tt class="docutils literal"><span class="pre">bytes</span></tt> and <tt class="docutils literal"><span class="pre">offset</span></tt> parameters semantic for <cite>_log</cite>
resource (<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=blobdiff;f=src/couchdb/couch_log.erl;h=1b05f4db2;hp=0befe7aab;hb=ad700014;hpb=7809f3ca">explanation</a>)
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=ad700014">#ad700014</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-986">COUCHDB-986</a>: Added Server-Sent Events protocol to db changes API.
See <a class="reference external" href="http://www.w3.org/TR/eventsource/">http://www.w3.org/TR/eventsource/</a> for details. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=093d2aa6">#093d2aa6</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1026">COUCHDB-1026</a>: Database names are encoded with respect of special characters
in the rewriter now. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=272d6415">#272d6415</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1097">COUCHDB-1097</a>: Allow <cite>OPTIONS</cite> request to shows and lists functions.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=9f53704a">#9f53704a</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1210">COUCHDB-1210</a>: Files starting with underscore can be attached and updated now.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=05858792">#05858792</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1277">COUCHDB-1277</a>: Better query parameter support and code clarity:
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=7e3c69ba">#7e3c69ba</a><ul>
<li>Responses to documents created/modified via form data <cite>POST</cite> to /db/doc or
copied with <cite>COPY</cite> should now include <cite>Location</cite> header.</li>
<li>Form data POST to /db/doc now includes an <cite>ETag</cite> response header.</li>
<li><tt class="docutils literal"><span class="pre">?batch=ok</span></tt> is now supported for <cite>COPY</cite> and <cite>POST</cite> /db/doc updates.</li>
<li><tt class="docutils literal"><span class="pre">?new_edits=false</span></tt> is now supported for more operations.</li>
</ul>
</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1285">COUCHDB-1285</a>: Allow configuration of vendor and modules version in CouchDB
welcome message. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=3c24a94d">#3c24a94d</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1321">COUCHDB-1321</a>: Variables in rewrite rules breaks OAuth authentication.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=c307ba95">#c307ba95</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1337">COUCHDB-1337</a>: Use MD5 for attachment ETag header value. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=6d912c9f">#6d912c9f</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1381">COUCHDB-1381</a>: Add jquery.couch support for Windows 8 Metro apps.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=dfc5d37c">#dfc5d37c</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1441">COUCHDB-1441</a>: Limit recursion depth in the URL rewriter.
Defaults to a maximum of 100 invocations but is configurable.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=d076976c">#d076976c</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1442">COUCHDB-1442</a>: No longer rewrites the <cite>X-CouchDB-Requested-Path</cite> during
recursive calls to the rewriter. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=56744f2f">#56744f2f</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1501">COUCHDB-1501</a>: <a class="reference internal" href="contents.html#changes"><em>Changes feed</em></a> now can take special parameter
<tt class="docutils literal"><span class="pre">since=now</span></tt> to emit changes since current point of time. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=3bbb2612">#3bbb2612</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1502">COUCHDB-1502</a>: Allow users to delete own _users doc. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=f0d6f19bc8">#f0d6f19bc8</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1511">COUCHDB-1511</a>: CouchDB checks <cite>roles</cite> field for <cite>_users</cite> database documents
with more care. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=41205000">#41205000</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1537">COUCHDB-1537</a>: Include user name in show/list <cite>ETags</cite>. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=ac320479">#ac320479</a></li>
<li>Send a 202 response for <cite>_restart</cite>. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=b213e16f">#b213e16f</a></li>
<li>Make password hashing synchronous when using the /_config/admins API.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=08071a80">#08071a80</a></li>
<li>Add support to serve single file with CouchDB, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=2774531ff2">#2774531ff2</a></li>
<li>Allow any 2xx code to indicate success, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=0d50103cfd">#0d50103cfd</a></li>
<li>Fix <cite>_session</cite> for IE7.</li>
<li>Restore 400 error for empty PUT, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=2057b895">#2057b895</a></li>
<li>Return <tt class="docutils literal"><span class="pre">X-Couch-Id</span></tt> header if doc is created, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=98515bf0b9">#98515bf0b9</a></li>
<li>Support auth cookies with <tt class="docutils literal"><span class="pre">:</span></tt> characters, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=d9566c831d">#d9566c831d</a></li>
</ul>
</div>
<div class="section" id="id1">
<h5>Log System<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1380">COUCHDB-1380</a>: Minor fixes for logrotate support.</li>
<li>Improve file I/O error logging and handling, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=4b6475da">#4b6475da</a></li>
<li>Module Level Logging, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=b58f069167">#b58f069167</a></li>
<li>Log 5xx responses at error level, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=e896b0b7">#e896b0b7</a></li>
<li>Log problems opening database at ERROR level except for auto-created
system dbs, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=41667642f7">#41667642f7</a></li>
</ul>
</div>
<div class="section" id="id2">
<h5>Replicator<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1248">COUCHDB-1248</a>: <cite>HTTP 500</cite> error now doesn&#8217;t occurs when replicating with
<tt class="docutils literal"><span class="pre">?doc_ids=null</span></tt>. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=bea76dbf">#bea76dbf</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1259">COUCHDB-1259</a>: Stabilize replication id, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=c6252d6d7f">#c6252d6d7f</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1323">COUCHDB-1323</a>: Replicator now acts as standalone application.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=f913ca6e">#f913ca6e</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1363">COUCHDB-1363</a>: Fix rarely occurred, but still race condition in changes feed
if a quick burst of changes happens while replication is starting the
replication can go stale. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=573a7bb9">#573a7bb9</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1557">COUCHDB-1557</a>: Upgrade some code to use BIFs bring good improvements for
replication.</li>
</ul>
</div>
<div class="section" id="security">
<h5>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1060">COUCHDB-1060</a>: Passwords are now hashed using the PBKDF2 algorithm with a
configurable work factor. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=7d418134">#7d418134</a></li>
</ul>
</div>
<div class="section" id="source-repository">
<h5>Source Repository<a class="headerlink" href="#source-repository" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>The source repository was migrated from <a class="reference external" href="https://svn.apache.org/repos/asf/couchdb">SVN</a> to <a class="reference external" href="https://git-wip-us.apache.org/repos/asf/couchdb.git">Git</a>.</li>
</ul>
</div>
<div class="section" id="storage-system">
<h5>Storage System<a class="headerlink" href="#storage-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed unnecessary conflict when deleting and creating a
document in the same batch.</li>
</ul>
</div>
<div class="section" id="test-suite">
<h5>Test Suite<a class="headerlink" href="#test-suite" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1321">COUCHDB-1321</a>: Moved the JS test suite to the CLI.</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1338">COUCHDB-1338</a>: Start CouchDB with <tt class="docutils literal"><span class="pre">port=0</span></tt>. While CouchDB might be already
running on the default port 5984, port number 0 let the TCP stack figure out a
free port to run. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=127cbe3">#127cbe3</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1339">COUCHDB-1339</a>: Use shell trap to catch dying beam processes during test runs.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=2921c78">#2921c78</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1389">COUCHDB-1389</a>: Improved tracebacks printed by the JS CLI tests.</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1563">COUCHDB-1563</a>: Ensures urlPrefix is set in all ajax requests.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=07a6af222">#07a6af222</a></li>
<li>Fix race condition for test running on faster hardware.</li>
<li>Improved the reliability of a number of tests.</li>
</ul>
</div>
<div class="section" id="url-rewriter-vhosts">
<h5>URL Rewriter &amp; Vhosts<a class="headerlink" href="#url-rewriter-vhosts" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1026">COUCHDB-1026</a>: Database name is encoded during rewriting
(allowing embedded /&#8217;s, etc). <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=272d6415">#272d6415</a></li>
</ul>
</div>
<div class="section" id="uuid-algorithms">
<h5>UUID Algorithms<a class="headerlink" href="#uuid-algorithms" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1373">COUCHDB-1373</a>: Added the utc_id algorithm <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=5ab712a2">#5ab712a2</a></li>
</ul>
</div>
<div class="section" id="query-and-view-server">
<h5>Query and View Server<a class="headerlink" href="#query-and-view-server" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-111">COUCHDB-111</a>: Improve the errors reported by the javascript view server
to provide a more friendly error report when something goes wrong.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=0c619ed">#0c619ed</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-410">COUCHDB-410</a>: More graceful error handling for JavaScript validate_doc_update
functions.</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1372">COUCHDB-1372</a>: <cite>_stats</cite> builtin reduce function no longer produces error for
empty view result.</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1444">COUCHDB-1444</a>: Fix missed_named_view error that occurs on existed design
documents and views. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=b59ac98b">#b59ac98b</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1445">COUCHDB-1445</a>: CouchDB tries no more to delete view file if it couldn&#8217;t open
it, even if the error is <cite>emfile</cite>.</li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1483">COUCHDB-1483</a>: Update handlers requires valid doc ids. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=72ea7e38">#72ea7e38</a></li>
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1491">COUCHDB-1491</a>: Clenaup view tables. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=c37204b7">#c37204b7</a></li>
<li>Deprecate E4X support, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=cdfdda2314">#cdfdda2314</a></li>
</ul>
</div>
<div class="section" id="windows">
<h5>Windows<a class="headerlink" href="#windows" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1482">COUCHDB-1482</a>: Use correct linker flag to build <cite>snappy_nif.dll</cite> on Windows.
<a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=a6eaf9f1">#a6eaf9f1</a></li>
<li>Allows building cleanly on Windows without cURL, <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=fb670f5712">#fb670f5712</a></li>
</ul>
</div>
</div>
</div>
<span id="document-whatsnew/1.2"></span><div class="section" id="x-branch">
<span id="release-1-2-x"></span><h3>1.2.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#upgrade-notes" id="id7">Upgrade Notes</a></li>
<li><a class="reference internal" href="#version-1-2-2" id="id8">Version 1.2.2</a></li>
<li><a class="reference internal" href="#version-1-2-1" id="id9">Version 1.2.1</a></li>
<li><a class="reference internal" href="#version-1-2-0" id="id10">Version 1.2.0</a></li>
</ul>
</div>
<div class="section" id="upgrade-notes">
<span id="release-1-2-x-upgrade"></span><h4><a class="toc-backref" href="#id7">Upgrade Notes</a><a class="headerlink" href="#upgrade-notes" title="Permalink to this headline">¶</a></h4>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This version drops support for the database format that was introduced in
version 0.9.0. Compact your older databases (that have not been compacted
for a long time) before upgrading, or they will become inaccessible.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference internal" href="contents.html#release-1-2-1"><em>Version 1.2.1</em></a> contains important security fixes. Previous <cite>1.2.x</cite>
releases are not recommended for regular usage.</p>
</div>
<div class="section" id="security-changes">
<h5>Security changes<a class="headerlink" href="#security-changes" title="Permalink to this headline">¶</a></h5>
<p>The interface to the <tt class="docutils literal"><span class="pre">_users</span></tt> and <tt class="docutils literal"><span class="pre">_replicator</span></tt> databases have been
changed so that non-administrator users can see less information:</p>
<ul class="simple">
<li>In the <tt class="docutils literal"><span class="pre">_users</span></tt> database:<ul>
<li>User documents can now only be read by the respective users, as well as
administrators. Other users cannot read these documents.</li>
<li>Views can only be defined and queried by administrator users.</li>
<li>The <tt class="docutils literal"><span class="pre">_changes</span></tt> feed can only be queried by administrator users.</li>
</ul>
</li>
<li>In the <tt class="docutils literal"><span class="pre">_replicator</span></tt> database:<ul>
<li>Documents now have a forced <tt class="docutils literal"><span class="pre">owner</span></tt> field that corresponds to the
authenticated user that created them.</li>
<li>Non-owner users will not see confidential information like passwords or
OAuth tokens in replication documents; they can still see the other
contents of those documents. Administrators can see everything.</li>
<li>Views can only be defined and queried by administrators.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="database-compression">
<h5>Database Compression<a class="headerlink" href="#database-compression" title="Permalink to this headline">¶</a></h5>
<p>The new optional (but enabled by default) compression of disk files requires
an upgrade of the on-disk format (5 -&gt; 6) which occurs on creation for new
databases and views, and on compaction for existing files. This format is not
supported in previous releases, so rollback would require replication to the
previous CouchDB release or restoring from backup.</p>
<p>Compression can be disabled by setting <tt class="docutils literal"><span class="pre">compression</span> <span class="pre">=</span> <span class="pre">none</span></tt> in your
<tt class="docutils literal"><span class="pre">local.ini</span></tt> <tt class="docutils literal"><span class="pre">[couchdb]</span></tt> section, but the on-disk format will still be
upgraded.</p>
</div>
</div>
<div class="section" id="version-1-2-2">
<span id="release-1-2-2"></span><h4><a class="toc-backref" href="#id8">Version 1.2.2</a><a class="headerlink" href="#version-1-2-2" title="Permalink to this headline">¶</a></h4>
<div class="section" id="build-system">
<h5>Build System<a class="headerlink" href="#build-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed issue in <cite>couchdb</cite> script where stopped status returns before process
exits.</li>
</ul>
</div>
<div class="section" id="http-interface">
<h5>HTTP Interface<a class="headerlink" href="#http-interface" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Reset rewrite counter on new request, avoiding unnecessary request failures
due to bogus rewrite limit reports.</li>
</ul>
</div>
</div>
<div class="section" id="version-1-2-1">
<span id="release-1-2-1"></span><h4><a class="toc-backref" href="#id9">Version 1.2.1</a><a class="headerlink" href="#version-1-2-1" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id1">
<h5>Build System<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix couchdb start script.</li>
<li>Win: fix linker invocations.</li>
</ul>
</div>
<div class="section" id="futon">
<h5>Futon<a class="headerlink" href="#futon" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Disable buttons that aren&#8217;t available for the logged-in user.</li>
</ul>
</div>
<div class="section" id="id2">
<h5>HTTP Interface<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>No longer rewrites the <tt class="docutils literal"><span class="pre">X-CouchDB-Requested-Path</span></tt> during recursive
calls to the rewriter.</li>
<li>Limit recursion depth in the URL rewriter. Defaults to a maximum
of 100 invocations but is configurable.</li>
</ul>
</div>
<div class="section" id="security">
<h5>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed <a class="reference internal" href="contents.html#cve-2012-5641"><em>CVE-2012-5641: Information disclosure via unescaped backslashes in URLs on Windows</em></a></li>
<li>Fixed <a class="reference internal" href="contents.html#cve-2012-5649"><em>CVE-2012-5649: JSONP arbitrary code execution with Adobe Flash</em></a></li>
<li>Fixed <a class="reference internal" href="contents.html#cve-2012-5650"><em>CVE-2012-5650: DOM based Cross-Site Scripting via Futon UI</em></a></li>
</ul>
</div>
<div class="section" id="replication">
<h5>Replication<a class="headerlink" href="#replication" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix potential timeouts.</li>
</ul>
</div>
<div class="section" id="view-server">
<h5>View Server<a class="headerlink" href="#view-server" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Change use of signals to avoid broken view groups.</li>
</ul>
</div>
</div>
<div class="section" id="version-1-2-0">
<span id="release-1-2-0"></span><h4><a class="toc-backref" href="#id10">Version 1.2.0</a><a class="headerlink" href="#version-1-2-0" title="Permalink to this headline">¶</a></h4>
<div class="section" id="authentication">
<h5>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix use of OAuth with VHosts and URL rewriting.</li>
<li>OAuth secrets can now be stored in the users system database
as an alternative to key value pairs in the .ini configuration.
By default this is disabled (secrets are stored in the .ini)
but can be enabled via the .ini configuration key <cite>use_users_db</cite>
in the <cite>couch_httpd_oauth</cite> section.</li>
<li>Documents in the _users database are no longer publicly
readable.</li>
<li>Confidential information in the _replication database is no
longer publicly readable.</li>
<li>Password hashes are now calculated by CouchDB. Clients are no
longer required to do this manually.</li>
<li>Cookies used for authentication can be made persistent by enabling
the .ini configuration key <cite>allow_persistent_cookies</cite> in the
<cite>couch_httpd_auth</cite> section.</li>
</ul>
</div>
<div class="section" id="id3">
<h5>Build System<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>cURL is no longer required to build CouchDB as it is only
used by the command line JS test runner. If cURL is available
when building CouchJS you can enable the HTTP bindings by
passing -H on the command line.</li>
<li>Temporarily made <cite>make check</cite> pass with R15B. A more thorough
fix is in the works (<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1424">COUCHDB-1424</a>).</li>
<li>Fixed &#8211;with-js-include and &#8211;with-js-lib options.</li>
<li>Added &#8211;with-js-lib-name option.</li>
</ul>
</div>
<div class="section" id="id4">
<h5>Futon<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>The <cite>Status</cite> screen (active tasks) now displays two new task status
fields: <cite>Started on</cite> and <cite>Updated on</cite>.</li>
<li>Futon remembers view code every time it is saved, allowing to save an
edit that amounts to a revert.</li>
</ul>
</div>
<div class="section" id="id5">
<h5>HTTP Interface<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added a native JSON parser.</li>
<li>The _active_tasks API now offers more granular fields. Each
task type is now able to expose different properties.</li>
<li>Added built-in changes feed filter <cite>_view</cite>.</li>
<li>Fixes to the <cite>_changes</cite> feed heartbeat option which caused
heartbeats to be missed when used with a filter. This caused
timeouts of continuous pull replications with a filter.</li>
<li>Properly restart the SSL socket on configuration changes.</li>
</ul>
</div>
<div class="section" id="oauth">
<h5>OAuth<a class="headerlink" href="#oauth" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Updated bundled <cite>erlang_oauth</cite> library to the latest version.</li>
</ul>
</div>
<div class="section" id="replicator">
<h5>Replicator<a class="headerlink" href="#replicator" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>A new replicator implementation. It offers more performance and
configuration options.</li>
<li>Passing non-string values to query_params is now a 400 bad
request. This is to reduce the surprise that all parameters
are converted to strings internally.</li>
<li>Added optional field <cite>since_seq</cite> to replication objects/documents.
It allows to bootstrap a replication from a specific source sequence
number.</li>
<li>Simpler replication cancellation. In addition to the current method,
replications can now be canceled by specifying the replication ID
instead of the original replication object/document.</li>
</ul>
</div>
<div class="section" id="storage-system">
<h5>Storage System<a class="headerlink" href="#storage-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added optional database and view index file compression (using Google&#8217;s
snappy or zlib&#8217;s deflate). This feature is enabled by default, but it
can be disabled by adapting local.ini accordingly. The on-disk format
is upgraded on compaction and new DB/view creation to support this.</li>
<li>Several performance improvements, most notably regarding database writes
and view indexing.</li>
<li>Computation of the size of the latest MVCC snapshot data and all its
supporting metadata, both for database and view index files. This
information is exposed as the <cite>data_size</cite> attribute in the database and
view group information URIs.</li>
<li>The size of the buffers used for database and view compaction is now
configurable.</li>
<li>Added support for automatic database and view compaction. This feature
is disabled by default, but it can be enabled via the .ini configuration.</li>
<li>Performance improvements for the built-in changes feed filters <cite>_doc_ids</cite>
and <cite>_design</cite>.</li>
</ul>
</div>
<div class="section" id="id6">
<h5>View Server<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Add CoffeeScript (<a class="reference external" href="http://coffeescript.org/">http://coffeescript.org/</a>) as a first class view server
language.</li>
<li>Fixed old index file descriptor leaks after a view cleanup.</li>
<li>The requested_path property keeps the pre-rewrite path even when no VHost
configuration is matched.</li>
<li>Fixed incorrect reduce query results when using pagination parameters.</li>
<li>Made icu_driver work with Erlang R15B and later.</li>
</ul>
</div>
</div>
</div>
<span id="document-whatsnew/1.1"></span><div class="section" id="x-branch">
<span id="release-1-1-x"></span><h3>1.1.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#upgrade-notes" id="id4">Upgrade Notes</a></li>
<li><a class="reference internal" href="#version-1-1-2" id="id5">Version 1.1.2</a></li>
<li><a class="reference internal" href="#version-1-1-1" id="id6">Version 1.1.1</a></li>
<li><a class="reference internal" href="#version-1-1-0" id="id7">Version 1.1.0</a></li>
</ul>
</div>
<div class="section" id="upgrade-notes">
<span id="release-1-1-x-upgrade"></span><h4><a class="toc-backref" href="#id4">Upgrade Notes</a><a class="headerlink" href="#upgrade-notes" title="Permalink to this headline">¶</a></h4>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference internal" href="contents.html#release-1-1-2"><em>Version 1.1.2</em></a> contains important security fixes. Previous <cite>1.1.x</cite>
releases are not recommended for regular usage.</p>
</div>
</div>
<div class="section" id="version-1-1-2">
<span id="release-1-1-2"></span><h4><a class="toc-backref" href="#id5">Version 1.1.2</a><a class="headerlink" href="#version-1-1-2" title="Permalink to this headline">¶</a></h4>
<div class="section" id="build-system">
<h5>Build System<a class="headerlink" href="#build-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Don&#8217;t <cite>ln</cite> the <cite>couchjs</cite> install target on Windows</li>
<li>Remove ICU version dependency on Windows.</li>
<li>Improve SpiderMonkey version detection.</li>
</ul>
</div>
<div class="section" id="http-interface">
<h5>HTTP Interface<a class="headerlink" href="#http-interface" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>ETag of attachment changes only when the attachment changes, not
the document.</li>
<li>Fix retrieval of headers larger than 4k.</li>
<li>Allow OPTIONS HTTP method for list requests.</li>
<li>Don&#8217;t attempt to encode invalid json.</li>
</ul>
</div>
<div class="section" id="log-system">
<h5>Log System<a class="headerlink" href="#log-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Improvements to log messages for file-related errors.</li>
</ul>
</div>
<div class="section" id="replicator">
<h5>Replicator<a class="headerlink" href="#replicator" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ul class="simple">
<li>Fix pull replication of documents with many revisions.</li>
<li>Fix replication from an HTTP source to an HTTP target.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="security">
<h5>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed <a class="reference internal" href="contents.html#cve-2012-5641"><em>CVE-2012-5641: Information disclosure via unescaped backslashes in URLs on Windows</em></a></li>
<li>Fixed <a class="reference internal" href="contents.html#cve-2012-5649"><em>CVE-2012-5649: JSONP arbitrary code execution with Adobe Flash</em></a></li>
<li>Fixed <a class="reference internal" href="contents.html#cve-2012-5650"><em>CVE-2012-5650: DOM based Cross-Site Scripting via Futon UI</em></a></li>
</ul>
</div>
<div class="section" id="view-server">
<h5>View Server<a class="headerlink" href="#view-server" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Avoid invalidating view indexes when running out of file descriptors.</li>
</ul>
</div>
</div>
<div class="section" id="version-1-1-1">
<span id="release-1-1-1"></span><h4><a class="toc-backref" href="#id6">Version 1.1.1</a><a class="headerlink" href="#version-1-1-1" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Support SpiderMonkey 1.8.5</li>
<li>Add configurable maximum to the number of bytes returned by _log.</li>
<li>Allow CommonJS modules to be an empty string.</li>
<li>Bump minimum Erlang version to R13B02.</li>
<li>Do not run deleted validate_doc_update functions.</li>
<li>ETags for views include current sequence if include_docs=true.</li>
<li>Fix bug where duplicates can appear in _changes feed.</li>
<li>Fix bug where update handlers break after conflict resolution.</li>
<li>Fix bug with _replicator where include &#8220;filter&#8221; could crash couch.</li>
<li>Fix crashes when compacting large views.</li>
<li>Fix file descriptor leak in _log</li>
<li>Fix missing revisions in _changes?style=all_docs.</li>
<li>Improve handling of compaction at max_dbs_open limit.</li>
<li>JSONP responses now send &#8220;text/javascript&#8221; for Content-Type.</li>
<li>Link to ICU 4.2 on Windows.</li>
<li>Permit forward slashes in path to update functions.</li>
<li>Reap couchjs processes that hit reduce_overflow error.</li>
<li>Status code can be specified in update handlers.</li>
<li>Support provides() in show functions.</li>
<li>_view_cleanup when ddoc has no views now removes all index files.</li>
<li>max_replication_retry_count now supports &#8220;infinity&#8221;.</li>
<li>Fix replication crash when source database has a document with empty ID.</li>
<li>Fix deadlock when assigning couchjs processes to serve requests.</li>
<li>Fixes to the document multipart PUT API.</li>
<li>Fixes regarding file descriptor leaks for databases with views.</li>
</ul>
</div>
<div class="section" id="version-1-1-0">
<span id="release-1-1-0"></span><h4><a class="toc-backref" href="#id7">Version 1.1.0</a><a class="headerlink" href="#version-1-1-0" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All CHANGES for 1.0.2 and 1.0.3 also apply to 1.1.0.</p>
</div>
<div class="section" id="externals">
<h5>Externals<a class="headerlink" href="#externals" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added OS Process module to manage daemons outside of CouchDB.</li>
<li>Added HTTP Proxy handler for more scalable externals.</li>
</ul>
</div>
<div class="section" id="futon">
<h5>Futon<a class="headerlink" href="#futon" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added a &#8220;change password&#8221;-feature to Futon.</li>
</ul>
</div>
<div class="section" id="id1">
<h5>HTTP Interface<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Native SSL support.</li>
<li>Added support for HTTP range requests for attachments.</li>
<li>Added built-in filters for <cite>_changes</cite>: <cite>_doc_ids</cite> and <cite>_design</cite>.</li>
<li>Added configuration option for TCP_NODELAY aka &#8220;Nagle&#8221;.</li>
<li>Allow POSTing arguments to <cite>_changes</cite>.</li>
<li>Allow <cite>keys</cite> parameter for GET requests to views.</li>
<li>Allow wildcards in vhosts definitions.</li>
<li>More granular ETag support for views.</li>
<li>More flexible URL rewriter.</li>
<li>Added support for recognizing &#8220;Q values&#8221; and media parameters in
HTTP Accept headers.</li>
<li>Validate doc ids that come from a PUT to a URL.</li>
</ul>
</div>
<div class="section" id="id2">
<h5>Replicator<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added <cite>_replicator</cite> database to manage replications.</li>
<li>Fixed issues when an endpoint is a remote database accessible via SSL.</li>
<li>Added support for continuous by-doc-IDs replication.</li>
<li>Fix issue where revision info was omitted when replicating attachments.</li>
<li>Integrity of attachment replication is now verified by MD5.</li>
</ul>
</div>
<div class="section" id="storage-system">
<h5>Storage System<a class="headerlink" href="#storage-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Multiple micro-optimizations when reading data.</li>
</ul>
</div>
<div class="section" id="url-rewriter-vhosts">
<h5>URL Rewriter &amp; Vhosts<a class="headerlink" href="#url-rewriter-vhosts" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix for variable substituion</li>
</ul>
</div>
<div class="section" id="id3">
<h5>View Server<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added CommonJS support to map functions.</li>
<li>Added <cite>stale=update_after</cite> query option that triggers a view update after
returning a <cite>stale=ok</cite> response.</li>
<li>Warn about empty result caused by <cite>startkey</cite> and <cite>endkey</cite> limiting.</li>
<li>Built-in reduce function <cite>_sum</cite> now accepts lists of integers as input.</li>
<li>Added view query aliases start_key, end_key, start_key_doc_id and
end_key_doc_id.</li>
</ul>
</div>
</div>
</div>
<span id="document-whatsnew/1.0"></span><div class="section" id="x-branch">
<span id="release-1-0-x"></span><h3>1.0.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#upgrade-notes" id="id16">Upgrade Notes</a></li>
<li><a class="reference internal" href="#version-1-0-4" id="id17">Version 1.0.4</a></li>
<li><a class="reference internal" href="#version-1-0-3" id="id18">Version 1.0.3</a></li>
<li><a class="reference internal" href="#version-1-0-2" id="id19">Version 1.0.2</a></li>
<li><a class="reference internal" href="#version-1-0-1" id="id20">Version 1.0.1</a></li>
<li><a class="reference internal" href="#version-1-0-0" id="id21">Version 1.0.0</a></li>
</ul>
</div>
<div class="section" id="upgrade-notes">
<span id="release-1-0-x-upgrade"></span><h4><a class="toc-backref" href="#id16">Upgrade Notes</a><a class="headerlink" href="#upgrade-notes" title="Permalink to this headline">¶</a></h4>
<p>Note, to replicate with a 1.0 CouchDB instance you must first upgrade in-place
your current CouchDB to 1.0 or 0.11.1 &#8211; backporting so that 0.10.x can
replicate to 1.0 wouldn&#8217;t be that hard. All that is required is patching the
replicator to use the <tt class="docutils literal"><span class="pre">application/json</span></tt> content type.</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">_log</span></tt> and <tt class="docutils literal"><span class="pre">_temp_views</span></tt> are now admin-only resources.</li>
<li><tt class="docutils literal"><span class="pre">_bulk_docs</span></tt> now requires a valid <cite>Content-Type</cite> header of
<tt class="docutils literal"><span class="pre">application/json</span></tt>.</li>
<li><cite>JSONP</cite> is disabled by default. An .ini option was added to selectively
enable it.</li>
<li>The <tt class="docutils literal"><span class="pre">key</span></tt>, <tt class="docutils literal"><span class="pre">startkey</span></tt> and <tt class="docutils literal"><span class="pre">endkey</span></tt> properties of the request object
passed to <a class="reference internal" href="contents.html#listfun"><em>list</em></a> and <a class="reference internal" href="contents.html#showfun"><em>show</em></a> functions now
contain JSON objects representing the URL encoded string values in the query
string. Previously, these properties contained strings which needed to be
converted to JSON before using.</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference internal" href="contents.html#release-1-0-4"><em>Version 1.0.4</em></a> contains important security fixes. Previous <cite>1.0.x</cite>
releases are not recommended for regular usage.</p>
</div>
</div>
<div class="section" id="version-1-0-4">
<span id="release-1-0-4"></span><h4><a class="toc-backref" href="#id17">Version 1.0.4</a><a class="headerlink" href="#version-1-0-4" title="Permalink to this headline">¶</a></h4>
<div class="section" id="http-interface">
<h5>HTTP Interface<a class="headerlink" href="#http-interface" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix missing revisions in <tt class="docutils literal"><span class="pre">_changes?style=all_docs</span></tt>.</li>
<li>Fix validation of attachment names.</li>
</ul>
</div>
<div class="section" id="log-system">
<h5>Log System<a class="headerlink" href="#log-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix file descriptor leak in <tt class="docutils literal"><span class="pre">_log</span></tt>.</li>
</ul>
</div>
<div class="section" id="replicator">
<h5>Replicator<a class="headerlink" href="#replicator" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix a race condition where replications can go stale</li>
</ul>
</div>
<div class="section" id="security">
<h5>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed <a class="reference internal" href="contents.html#cve-2012-5641"><em>CVE-2012-5641: Information disclosure via unescaped backslashes in URLs on Windows</em></a></li>
<li>Fixed <a class="reference internal" href="contents.html#cve-2012-5649"><em>CVE-2012-5649: JSONP arbitrary code execution with Adobe Flash</em></a></li>
<li>Fixed <a class="reference internal" href="contents.html#cve-2012-5650"><em>CVE-2012-5650: DOM based Cross-Site Scripting via Futon UI</em></a></li>
</ul>
</div>
<div class="section" id="view-system">
<h5>View System<a class="headerlink" href="#view-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Avoid invalidating view indexes when running out of file descriptors.</li>
</ul>
</div>
</div>
<div class="section" id="version-1-0-3">
<span id="release-1-0-3"></span><h4><a class="toc-backref" href="#id18">Version 1.0.3</a><a class="headerlink" href="#version-1-0-3" title="Permalink to this headline">¶</a></h4>
<div class="section" id="general">
<h5>General<a class="headerlink" href="#general" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed compatibility issues with Erlang R14B02.</li>
</ul>
</div>
<div class="section" id="etap-test-suite">
<h5>Etap Test Suite<a class="headerlink" href="#etap-test-suite" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Etap tests no longer require use of port 5984. They now use a randomly
selected port so they won&#8217;t clash with a running CouchDB.</li>
</ul>
</div>
<div class="section" id="futon">
<h5>Futon<a class="headerlink" href="#futon" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Made compatible with jQuery 1.5.x.</li>
</ul>
</div>
<div class="section" id="id1">
<h5>HTTP Interface<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix bug that allows invalid UTF-8 after valid escapes.</li>
<li>The query parameter <cite>include_docs</cite> now honors the parameter <cite>conflicts</cite>.
This applies to queries against map views, _all_docs and _changes.</li>
<li>Added support for inclusive_end with reduce views.</li>
</ul>
</div>
<div class="section" id="id2">
<h5>Replicator<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Enabled replication over IPv6.</li>
<li>Fixed for crashes in continuous and filtered changes feeds.</li>
<li>Fixed error when restarting replications in OTP R14B02.</li>
<li>Upgrade ibrowse to version 2.2.0.</li>
<li>Fixed bug when using a filter and a limit of 1.</li>
</ul>
</div>
<div class="section" id="id3">
<h5>Security<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed OAuth signature computation in OTP R14B02.</li>
<li>Handle passwords with : in them.</li>
</ul>
</div>
<div class="section" id="storage-system">
<h5>Storage System<a class="headerlink" href="#storage-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>More performant queries against _changes and _all_docs when using the
<cite>include_docs</cite> parameter.</li>
</ul>
</div>
<div class="section" id="windows">
<h5>Windows<a class="headerlink" href="#windows" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Windows builds now require ICU &gt;= 4.4.0 and Erlang &gt;= R14B03. See
<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1152">COUCHDB-1152</a>, and <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-963">COUCHDB-963</a> + OTP-9139 for more information.</li>
</ul>
</div>
</div>
<div class="section" id="version-1-0-2">
<span id="release-1-0-2"></span><h4><a class="toc-backref" href="#id19">Version 1.0.2</a><a class="headerlink" href="#version-1-0-2" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id4">
<h5>Futon<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Make test suite work with Safari and Chrome.</li>
<li>Fixed animated progress spinner.</li>
<li>Fix raw view document link due to overzealous URI encoding.</li>
<li>Spell javascript correctly in loadScript(uri).</li>
</ul>
</div>
<div class="section" id="id5">
<h5>HTTP Interface<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Allow reduce=false parameter in map-only views.</li>
<li>Fix parsing of Accept headers.</li>
<li>Fix for multipart GET APIs when an attachment was created during a
local-local replication. See <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-1022">COUCHDB-1022</a> for details.</li>
</ul>
</div>
<div class="section" id="id6">
<h5>Log System<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Reduce lengthy stack traces.</li>
<li>Allow logging of native &lt;xml&gt; types.</li>
</ul>
</div>
<div class="section" id="id7">
<h5>Replicator<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Updated ibrowse library to 2.1.2 fixing numerous replication issues.</li>
<li>Make sure that the replicator respects HTTP settings defined in the config.</li>
<li>Fix error when the ibrowse connection closes unexpectedly.</li>
<li>Fix authenticated replication (with HTTP basic auth) of design documents
with attachments.</li>
<li>Various fixes to make replication more resilient for edge-cases.</li>
</ul>
</div>
<div class="section" id="id8">
<h5>Storage System<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix leaking file handles after compacting databases and views.</li>
<li>Fix databases forgetting their validation function after compaction.</li>
<li>Fix occasional timeout errors after successfully compacting large databases.</li>
<li>Fix ocassional error when writing to a database that has just been compacted.</li>
<li>Fix occasional timeout errors on systems with slow or heavily loaded IO.</li>
<li>Fix for OOME when compactions include documents with many conflicts.</li>
<li>Fix for missing attachment compression when MIME types included parameters.</li>
<li>Preserve purge metadata during compaction to avoid spurious view rebuilds.</li>
<li>Fix spurious conflicts introduced when uploading an attachment after
a doc has been in a conflict. See <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-902">COUCHDB-902</a> for details.</li>
<li>Fix for frequently edited documents in multi-master deployments being
duplicated in _changes and _all_docs.  See <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-968">COUCHDB-968</a> for details on how
to repair.</li>
<li>Significantly higher read and write throughput against database and
view index files.</li>
</ul>
</div>
<div class="section" id="view-server">
<h5>View Server<a class="headerlink" href="#view-server" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Don&#8217;t trigger view updates when requesting <cite>_design/doc/_info</cite>.</li>
<li>Fix for circular references in CommonJS requires.</li>
<li>Made isArray() function available to functions executed in the query server.</li>
<li>Documents are now sealed before being passed to map functions.</li>
<li>Force view compaction failure when duplicated document data exists. When
this error is seen in the logs users should rebuild their views from
scratch to fix the issue. See <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-999">COUCHDB-999</a> for details.</li>
</ul>
</div>
</div>
<div class="section" id="version-1-0-1">
<span id="release-1-0-1"></span><h4><a class="toc-backref" href="#id20">Version 1.0.1</a><a class="headerlink" href="#version-1-0-1" title="Permalink to this headline">¶</a></h4>
<div class="section" id="authentication">
<h5>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h5>
<ul>
<li><dl class="first docutils">
<dt>Enable basic-auth popup when required to access the server, to prevent</dt>
<dd><p class="first last">people from getting locked out.</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="build-and-system-integration">
<h5>Build and System Integration<a class="headerlink" href="#build-and-system-integration" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Included additional source files for distribution.</li>
</ul>
</div>
<div class="section" id="id9">
<h5>Futon<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>User interface element for querying stale (cached) views.</li>
</ul>
</div>
<div class="section" id="id10">
<h5>HTTP Interface<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Expose <cite>committed_update_seq</cite> for monitoring purposes.</li>
<li>Show fields saved along with _deleted=true. Allows for auditing of deletes.</li>
<li>More robust Accept-header detection.</li>
</ul>
</div>
<div class="section" id="id11">
<h5>Replicator<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added support for replication via an HTTP/HTTPS proxy.</li>
<li>Fix pull replication of attachments from 0.11 to 1.0.x.</li>
<li>Make the _changes feed work with non-integer seqnums.</li>
</ul>
</div>
<div class="section" id="id12">
<h5>Storage System<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix data corruption bug <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-844">COUCHDB-844</a>. Please see
<a class="reference external" href="http://couchdb.apache.org/notice/1.0.1.html">http://couchdb.apache.org/notice/1.0.1.html</a> for details.</li>
</ul>
</div>
</div>
<div class="section" id="version-1-0-0">
<span id="release-1-0-0"></span><h4><a class="toc-backref" href="#id21">Version 1.0.0</a><a class="headerlink" href="#version-1-0-0" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id13">
<h5>Security<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added authentication caching, to avoid repeated opening and closing of the
users database for each request requiring authentication.</li>
</ul>
</div>
<div class="section" id="id14">
<h5>Storage System<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Small optimization for reordering result lists.</li>
<li>More efficient header commits.</li>
<li>Use O_APPEND to save lseeks.</li>
<li>Faster implementation of pread_iolist(). Further improves performance on
concurrent reads.</li>
</ul>
</div>
<div class="section" id="id15">
<h5>View Server<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Faster default view collation.</li>
<li>Added option to include update_seq in view responses.</li>
</ul>
</div>
</div>
</div>
<span id="document-whatsnew/0.11"></span><div class="section" id="x-branch">
<span id="release-0-11-x"></span><h3>0.11.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#upgrade-notes" id="id11">Upgrade Notes</a></li>
<li><a class="reference internal" href="#version-0-11-2" id="id12">Version 0.11.2</a></li>
<li><a class="reference internal" href="#version-0-11-1" id="id13">Version 0.11.1</a></li>
<li><a class="reference internal" href="#version-0-11-0" id="id14">Version 0.11.0</a></li>
</ul>
</div>
<div class="section" id="upgrade-notes">
<span id="release-0-11-x-upgrade"></span><h4><a class="toc-backref" href="#id11">Upgrade Notes</a><a class="headerlink" href="#upgrade-notes" title="Permalink to this headline">¶</a></h4>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference internal" href="contents.html#release-0-11-2"><em>Version 0.11.2</em></a> contains important security fixes. Previous <cite>0.11.x</cite>
releases are not recommended for regular usage.</p>
</div>
<div class="section" id="changes-between-0-11-0-and-0-11-1">
<h5>Changes Between 0.11.0 and 0.11.1<a class="headerlink" href="#changes-between-0-11-0-and-0-11-1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">_log</span></tt> and <tt class="docutils literal"><span class="pre">_temp_views</span></tt> are now admin-only resources.</li>
<li><tt class="docutils literal"><span class="pre">_bulk_docs</span></tt> now requires a valid <cite>Content-Type</cite> header of
<tt class="docutils literal"><span class="pre">application/json</span></tt>.</li>
<li><cite>JSONP</cite> is disabled by default. An .ini option was added to selectively
enable it.</li>
<li>The <tt class="docutils literal"><span class="pre">key</span></tt>, <tt class="docutils literal"><span class="pre">startkey</span></tt> and <tt class="docutils literal"><span class="pre">endkey</span></tt> properties of the request object
passed to <a class="reference internal" href="contents.html#listfun"><em>list</em></a> and <a class="reference internal" href="contents.html#showfun"><em>show</em></a> functions now
contain JSON objects representing the URL encoded string values in the query
string. Previously, these properties contained strings which needed to be
converted to JSON before using.</li>
</ul>
</div>
<div class="section" id="changes-between-0-10-x-and-0-11-0">
<h5>Changes Between 0.10.x and 0.11.0<a class="headerlink" href="#changes-between-0-10-x-and-0-11-0" title="Permalink to this headline">¶</a></h5>
<div class="section" id="show-list-update-and-validation-functions">
<h6>show, list, update and validation functions<a class="headerlink" href="#show-list-update-and-validation-functions" title="Permalink to this headline">¶</a></h6>
<p>The <tt class="docutils literal"><span class="pre">req</span></tt> argument to show, list, update and validation functions now contains
the member method with the specified HTTP method of the current request.
Previously, this member was called <tt class="docutils literal"><span class="pre">verb</span></tt>. <tt class="docutils literal"><span class="pre">method</span></tt> is following <span class="target" id="index-0"></span><a class="rfc reference external" href="http://tools.ietf.org/html/rfc2616.html"><strong>RFC 2616</strong></a>
(HTTP 1.1) closer.</p>
</div>
<div class="section" id="admins-security">
<h6>_admins -&gt; _security<a class="headerlink" href="#admins-security" title="Permalink to this headline">¶</a></h6>
<p>The <cite>/db/_admins</cite> handler has been removed and replaced with a
<a class="reference internal" href="contents.html#api-db-security"><em>/db/_security</em></a> object. Any existing <cite>_admins</cite> will be
dropped and need to be added to the security object again. The reason for this
is that the old system made no distinction between names and roles, while the
new one does, so there is no way to automatically upgrade the old admins list.</p>
<p>The security object has 2 special fields, <tt class="docutils literal"><span class="pre">admins</span></tt> and <tt class="docutils literal"><span class="pre">readers</span></tt>, which
contain lists of names and roles which are admins or readers on that database.
Anything else may be stored in other fields on the security object. The entire
object is made available to validation functions.</p>
</div>
<div class="section" id="json2-js">
<h6>json2.js<a class="headerlink" href="#json2-js" title="Permalink to this headline">¶</a></h6>
<p>JSON handling in the query server has been upgraded to use <a class="reference external" href="https://github.com/douglascrockford/JSON-js/blob/master/json2.js">json2.js</a>.
This allows us to use faster native JSON serialization when it is available.</p>
<p>In previous versions, attempts to serialize undefined would throw an exception,
causing the doc that emitted undefined to be dropped from the view index.
The new behavior is to serialize undefined as null. Applications depending on
the old behavior will need to explicitly check for undefined.</p>
<p>Another change is that E4X&#8217;s XML objects will not automatically be
stringified. XML users will need to call <tt class="docutils literal"><span class="pre">my_xml_object.toXMLString()</span></tt>
to return a string value. <a class="reference external" href="https://git-wip-us.apache.org/repos/asf?p=couchdb.git;a=commit;h=8d3b7ab3">#8d3b7ab3</a></p>
</div>
<div class="section" id="www-authenticate">
<h6>WWW-Authenticate<a class="headerlink" href="#www-authenticate" title="Permalink to this headline">¶</a></h6>
<p>The default configuration has been changed to avoid causing basic-auth popups
which result from sending the WWW-Authenticate header. To enable basic-auth
popups, uncomment the <a class="reference internal" href="contents.html#httpd/WWW-Authenticate" title="WWW-Authenticate"><tt class="xref config config-option docutils literal"><span class="pre">httpd/WWW-Authenticate</span></tt></a> line in
<cite>local.ini</cite>.</p>
</div>
<div class="section" id="query-server-line-protocol">
<h6>Query server line protocol<a class="headerlink" href="#query-server-line-protocol" title="Permalink to this headline">¶</a></h6>
<p>The query server line protocol has changed for all functions except
<a class="reference internal" href="contents.html#qs-map-doc"><em>map</em></a>, <a class="reference internal" href="contents.html#qs-reduce"><em>reduce</em></a>, and
<a class="reference internal" href="contents.html#qs-rereduce"><em>rereduce</em></a>. This allows us to cache the entire design
document in the query server process, which results in faster performance for
common operations. It also gives more flexibility to query server
implementators and shouldn&#8217;t require major changes in the future when adding
new query server features.</p>
</div>
<div class="section" id="utf8-json">
<h6>UTF8 JSON<a class="headerlink" href="#utf8-json" title="Permalink to this headline">¶</a></h6>
<p>JSON request bodies are validated for proper UTF-8 before saving, instead of
waiting to fail on subsequent read requests.</p>
</div>
<div class="section" id="changes-line-format">
<h6>_changes line format<a class="headerlink" href="#changes-line-format" title="Permalink to this headline">¶</a></h6>
<p>Continuous changes are now newline delimited, instead of having each line
followed by a comma.</p>
</div>
</div>
</div>
<div class="section" id="version-0-11-2">
<span id="release-0-11-2"></span><h4><a class="toc-backref" href="#id12">Version 0.11.2</a><a class="headerlink" href="#version-0-11-2" title="Permalink to this headline">¶</a></h4>
<div class="section" id="authentication">
<h5>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>User documents can now be deleted by admins or the user.</li>
</ul>
</div>
<div class="section" id="futon">
<h5>Futon<a class="headerlink" href="#futon" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Add some Futon files that were missing from the Makefile.</li>
</ul>
</div>
<div class="section" id="http-interface">
<h5>HTTP Interface<a class="headerlink" href="#http-interface" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Better error messages on invalid URL requests.</li>
</ul>
</div>
<div class="section" id="replicator">
<h5>Replicator<a class="headerlink" href="#replicator" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix bug when pushing design docs by non-admins, which was hanging the
replicator for no good reason.</li>
<li>Fix bug when pulling design documents from a source that requires
basic-auth.</li>
</ul>
</div>
<div class="section" id="security">
<h5>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Avoid potential DOS attack by guarding all creation of atoms.</li>
<li>Fixed <a class="reference internal" href="contents.html#cve-2010-2234"><em>CVE-2010-2234: Apache CouchDB Cross Site Request Forgery Attack</em></a></li>
</ul>
</div>
</div>
<div class="section" id="version-0-11-1">
<span id="release-0-11-1"></span><h4><a class="toc-backref" href="#id13">Version 0.11.1</a><a class="headerlink" href="#version-0-11-1" title="Permalink to this headline">¶</a></h4>
<div class="section" id="build-and-system-integration">
<h5>Build and System Integration<a class="headerlink" href="#build-and-system-integration" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Output of <cite>couchdb &#8211;help</cite> has been improved.</li>
<li>Fixed compatibility with the Erlang R14 series.</li>
<li>Fixed warnings on Linux builds.</li>
<li>Fixed build error when aclocal needs to be called during the build.</li>
<li>Require ICU 4.3.1.</li>
<li>Fixed compatibility with Solaris.</li>
</ul>
</div>
<div class="section" id="configuration-system">
<h5>Configuration System<a class="headerlink" href="#configuration-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed timeout with large .ini files.</li>
</ul>
</div>
<div class="section" id="id2">
<h5>Futon<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Use &#8220;expando links&#8221; for over-long document values in Futon.</li>
<li>Added continuous replication option.</li>
<li>Added option to replicating test results anonymously to a community
CouchDB instance.</li>
<li>Allow creation and deletion of config entries.</li>
<li>Fixed display issues with doc ids that have escaped characters.</li>
<li>Fixed various UI issues.</li>
</ul>
</div>
<div class="section" id="id3">
<h5>HTTP Interface<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Mask passwords in active tasks and logging.</li>
<li>Update mochijson2 to allow output of BigNums not in float form.</li>
<li>Added support for X-HTTP-METHOD-OVERRIDE.</li>
<li>Better error message for database names.</li>
<li>Disable jsonp by default.</li>
<li>Accept gzip encoded standalone attachments.</li>
<li>Made max_concurrent_connections configurable.</li>
<li>Made changes API more robust.</li>
<li>Send newly generated document rev to callers of an update function.</li>
</ul>
</div>
<div class="section" id="javascript-clients">
<h5>JavaScript Clients<a class="headerlink" href="#javascript-clients" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added tests for couch.js and jquery.couch.js</li>
<li>Added changes handler to jquery.couch.js.</li>
<li>Added cache busting to jquery.couch.js if the user agent is msie.</li>
<li>Added support for multi-document-fetch (via _all_docs) to jquery.couch.js.</li>
<li>Added attachment versioning to jquery.couch.js.</li>
<li>Added option to control ensure_full_commit to jquery.couch.js.</li>
<li>Added list functionality to jquery.couch.js.</li>
<li>Fixed issues where bulkSave() wasn&#8217;t sending a POST body.</li>
</ul>
</div>
<div class="section" id="log-system">
<h5>Log System<a class="headerlink" href="#log-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Log HEAD requests as HEAD, not GET.</li>
<li>Keep massive JSON blobs out of the error log.</li>
<li>Fixed a timeout issue.</li>
</ul>
</div>
<div class="section" id="replication-system">
<h5>Replication System<a class="headerlink" href="#replication-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Refactored various internal APIs related to attachment streaming.</li>
<li>Fixed hanging replication.</li>
<li>Fixed keepalive issue.</li>
</ul>
</div>
<div class="section" id="id4">
<h5>Security<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added authentication redirect URL to log in clients.</li>
<li>Fixed query parameter encoding issue in oauth.js.</li>
<li>Made authentication timeout configurable.</li>
<li>Temporary views are now admin-only resources.</li>
</ul>
</div>
<div class="section" id="storage-system">
<h5>Storage System<a class="headerlink" href="#storage-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Don&#8217;t require a revpos for attachment stubs.</li>
<li>Added checking to ensure when a revpos is sent with an attachment stub,
it&#8217;s correct.</li>
<li>Make file deletions async to avoid pauses during compaction and db
deletion.</li>
<li>Fixed for wrong offset when writing headers and converting them to blocks,
only triggered when header is larger than 4k.</li>
<li>Preserve _revs_limit and instance_start_time after compaction.</li>
</ul>
</div>
<div class="section" id="test-suite">
<h5>Test Suite<a class="headerlink" href="#test-suite" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Made the test suite overall more reliable.</li>
</ul>
</div>
<div class="section" id="view-server">
<h5>View Server<a class="headerlink" href="#view-server" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Provide a UUID to update functions (and all other functions) that they can
use to create new docs.</li>
<li>Upgrade CommonJS modules support to 1.1.1.</li>
<li>Fixed erlang filter funs and normalize filter fun API.</li>
<li>Fixed hang in view shutdown.</li>
</ul>
</div>
<div class="section" id="url-rewriter-vhosts">
<h5>URL Rewriter &amp; Vhosts<a class="headerlink" href="#url-rewriter-vhosts" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Allow more complex keys in rewriter.</li>
<li>Allow global rewrites so system defaults are available in vhosts.</li>
<li>Allow isolation of databases with vhosts.</li>
<li>Fix issue with passing variables to query parameters.</li>
</ul>
</div>
</div>
<div class="section" id="version-0-11-0">
<span id="release-0-11-0"></span><h4><a class="toc-backref" href="#id14">Version 0.11.0</a><a class="headerlink" href="#version-0-11-0" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id5">
<h5>Build and System Integration<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Updated and improved source documentation.</li>
<li>Fixed distribution preparation for building on Mac OS X.</li>
<li>Added support for building a Windows installer as part of &#8216;make dist&#8217;.</li>
<li>Bug fix for building couch.app&#8217;s module list.</li>
<li>ETap tests are now run during make distcheck. This included a number of
updates to the build system to properly support VPATH builds.</li>
<li>Gavin McDonald setup a build-bot instance. More info can be found at
<a class="reference external" href="http://ci.apache.org/buildbot.html">http://ci.apache.org/buildbot.html</a></li>
</ul>
</div>
<div class="section" id="id6">
<h5>Futon<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added a button for view compaction.</li>
<li>JSON strings are now displayed as-is in the document view, without the
escaping of new-lines and quotes. That dramatically improves readability of
multi-line strings.</li>
<li>Same goes for editing of JSON string values. When a change to a field value is
submitted, and the value is not valid JSON it is assumed to be a string. This
improves editing of multi-line strings a lot.</li>
<li>Hitting tab in textareas no longer moves focus to the next form field, but
simply inserts a tab character at the current caret position.</li>
<li>Fixed some font declarations.</li>
</ul>
</div>
<div class="section" id="id7">
<h5>HTTP Interface<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Provide Content-MD5 header support for attachments.</li>
<li>Added URL Rewriter handler.</li>
<li>Added virtual host handling.</li>
</ul>
</div>
<div class="section" id="replication">
<h5>Replication<a class="headerlink" href="#replication" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added option to implicitly create replication target databases.</li>
<li>Avoid leaking file descriptors on automatic replication restarts.</li>
<li>Added option to replicate a list of documents by id.</li>
<li>Allow continuous replication to be cancelled.</li>
</ul>
</div>
<div class="section" id="runtime-statistics">
<h5>Runtime Statistics<a class="headerlink" href="#runtime-statistics" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Statistics are now calculated for a moving window instead of non-overlapping
timeframes.</li>
<li>Fixed a problem with statistics timers and system sleep.</li>
<li>Moved statistic names to a term file in the priv directory.</li>
</ul>
</div>
<div class="section" id="id8">
<h5>Security<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed CVE-2010-0009: Apache CouchDB Timing Attack Vulnerability.</li>
<li>Added default cookie-authentication and users database.</li>
<li>Added Futon user interface for user signup and login.</li>
<li>Added per-database reader access control lists.</li>
<li>Added per-database security object for configuration data in validation
functions.</li>
<li>Added proxy authentication handler</li>
</ul>
</div>
<div class="section" id="id9">
<h5>Storage System<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Adds batching of multiple updating requests, to improve throughput with many
writers. Removed the now redundant couch_batch_save module.</li>
<li>Adds configurable compression of attachments.</li>
</ul>
</div>
<div class="section" id="id10">
<h5>View Server<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added optional &#8216;raw&#8217; binary collation for faster view builds where Unicode
collation is not important.</li>
<li>Improved view index build time by reducing ICU collation callouts.</li>
<li>Improved view information objects.</li>
<li>Bug fix for partial updates during view builds.</li>
<li>Move query server to a design-doc based protocol.</li>
<li>Use json2.js for JSON serialization for compatiblity with native JSON.</li>
<li>Major refactoring of couchjs to lay the groundwork for disabling cURL
support. The new HTTP interaction acts like a synchronous XHR. Example usage
of the new system is in the JavaScript CLI test runner.</li>
</ul>
</div>
</div>
</div>
<span id="document-whatsnew/0.10"></span><div class="section" id="x-branch">
<span id="release-0-10-x"></span><h3>0.10.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#upgrade-notes" id="id4">Upgrade Notes</a></li>
<li><a class="reference internal" href="#version-0-10-2" id="id5">Version 0.10.2</a></li>
<li><a class="reference internal" href="#version-0-10-1" id="id6">Version 0.10.1</a></li>
<li><a class="reference internal" href="#version-0-10-0" id="id7">Version 0.10.0</a></li>
</ul>
</div>
<div class="section" id="upgrade-notes">
<span id="release-0-10-x-upgrade"></span><h4><a class="toc-backref" href="#id4">Upgrade Notes</a><a class="headerlink" href="#upgrade-notes" title="Permalink to this headline">¶</a></h4>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><a class="reference internal" href="contents.html#release-0-10-2"><em>Version 0.10.2</em></a> contains important security fixes. Previous <cite>0.10.x</cite>
releases are not recommended for regular usage.</p>
</div>
<div class="section" id="modular-configuration-directories">
<h5>Modular Configuration Directories<a class="headerlink" href="#modular-configuration-directories" title="Permalink to this headline">¶</a></h5>
<p>CouchDB now loads configuration from the following places (<a class="reference external" href="http://linux.die.net/man/7/glob">glob(7)</a> syntax)
in order:</p>
<ul class="simple">
<li>PREFIX/default.ini</li>
<li>PREFIX/default.d/*</li>
<li>PREFIX/local.ini</li>
<li>PREFIX/local.d/*</li>
</ul>
<p>The configuration options for <cite>couchdb</cite> script have changed to:</p>
<div class="highlight-ini"><div class="highlight"><pre>-a FILE     add configuration FILE to chain
-A DIR      add configuration DIR to chain
-n          reset configuration file chain (including system default)
-c          print configuration file chain and exit
</pre></div>
</div>
</div>
<div class="section" id="show-and-list-api-change">
<h5>Show and List API change<a class="headerlink" href="#show-and-list-api-change" title="Permalink to this headline">¶</a></h5>
<p>Show and List functions must have a new structure in 0.10.
See <a class="reference external" href="http://wiki.apache.org/couchdb/Formatting_with_Show_and_List">Formatting_with_Show_and_List</a> for details.</p>
</div>
<div class="section" id="stricter-enforcing-of-reduciness-in-reduce-functions">
<h5>Stricter enforcing of reduciness in reduce-functions<a class="headerlink" href="#stricter-enforcing-of-reduciness-in-reduce-functions" title="Permalink to this headline">¶</a></h5>
<p>Reduce functions are now required to reduce the number of values for a key.</p>
</div>
<div class="section" id="view-query-reduce-parameter-strictness">
<h5>View query reduce parameter strictness<a class="headerlink" href="#view-query-reduce-parameter-strictness" title="Permalink to this headline">¶</a></h5>
<p>CouchDB now considers the parameter <tt class="docutils literal"><span class="pre">reduce=false</span></tt> to be an error for queries
of map-only views, and responds with status code 400.</p>
</div>
</div>
<div class="section" id="version-0-10-2">
<span id="release-0-10-2"></span><h4><a class="toc-backref" href="#id5">Version 0.10.2</a><a class="headerlink" href="#version-0-10-2" title="Permalink to this headline">¶</a></h4>
<div class="section" id="build-and-system-integration">
<h5>Build and System Integration<a class="headerlink" href="#build-and-system-integration" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed distribution preparation for building on Mac OS X.</li>
</ul>
</div>
<div class="section" id="security">
<h5>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fixed <a class="reference internal" href="contents.html#cve-2010-0009"><em>CVE-2010-0009: Apache CouchDB Timing Attack Vulnerability</em></a></li>
</ul>
</div>
<div class="section" id="replicator">
<h5>Replicator<a class="headerlink" href="#replicator" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Avoid leaking file descriptors on automatic replication restarts.</li>
</ul>
</div>
</div>
<div class="section" id="version-0-10-1">
<span id="release-0-10-1"></span><h4><a class="toc-backref" href="#id6">Version 0.10.1</a><a class="headerlink" href="#version-0-10-1" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id1">
<h5>Build and System Integration<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Test suite now works with the distcheck target.</li>
</ul>
</div>
<div class="section" id="id2">
<h5>Replicator<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Stability enhancements regarding redirects, timeouts, OAuth.</li>
</ul>
</div>
<div class="section" id="query-server">
<h5>Query Server<a class="headerlink" href="#query-server" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Avoid process leaks</li>
<li>Allow list and view to span languages</li>
</ul>
</div>
<div class="section" id="stats">
<h5>Stats<a class="headerlink" href="#stats" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Eliminate new process flood on system wake</li>
</ul>
</div>
</div>
<div class="section" id="version-0-10-0">
<span id="release-0-10-0"></span><h4><a class="toc-backref" href="#id7">Version 0.10.0</a><a class="headerlink" href="#version-0-10-0" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id3">
<h5>Build and System Integration<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Changed <cite>couchdb</cite> script configuration options.</li>
<li>Added default.d and local.d configuration directories to load sequence.</li>
</ul>
</div>
<div class="section" id="http-interface">
<h5>HTTP Interface<a class="headerlink" href="#http-interface" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added optional cookie-based authentication handler.</li>
<li>Added optional two-legged OAuth authentication handler.</li>
</ul>
</div>
<div class="section" id="storage-format">
<h5>Storage Format<a class="headerlink" href="#storage-format" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Add move headers with checksums to the end of database files for extra robust
storage and faster storage.</li>
</ul>
</div>
<div class="section" id="view-server">
<h5>View Server<a class="headerlink" href="#view-server" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added native Erlang views for high-performance applications.</li>
</ul>
</div>
</div>
</div>
<span id="document-whatsnew/0.9"></span><div class="section" id="x-branch">
<span id="release-0-9-x"></span><h3>0.9.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#upgrade-notes" id="id8">Upgrade Notes</a></li>
<li><a class="reference internal" href="#version-0-9-2" id="id9">Version 0.9.2</a></li>
<li><a class="reference internal" href="#version-0-9-1" id="id10">Version 0.9.1</a></li>
<li><a class="reference internal" href="#version-0-9-0" id="id11">Version 0.9.0</a></li>
</ul>
</div>
<div class="section" id="upgrade-notes">
<span id="release-0-9-x-upgrade"></span><h4><a class="toc-backref" href="#id8">Upgrade Notes</a><a class="headerlink" href="#upgrade-notes" title="Permalink to this headline">¶</a></h4>
<div class="section" id="response-to-bulk-creation-updates">
<h5>Response to Bulk Creation/Updates<a class="headerlink" href="#response-to-bulk-creation-updates" title="Permalink to this headline">¶</a></h5>
<p>The response to a bulk creation / update now looks like this</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;rev&quot;</span><span class="o">:</span> <span class="s2">&quot;3682408536&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;rev&quot;</span><span class="o">:</span> <span class="s2">&quot;3206753266&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="s2">&quot;conflict&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;Document update conflict.&quot;</span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="database-file-format">
<h5>Database File Format<a class="headerlink" href="#database-file-format" title="Permalink to this headline">¶</a></h5>
<p>The database file format has changed. CouchDB itself does yet not provide any
tools for migrating your data. In the meantime, you can use third-party scripts
to deal with the migration, such as the dump/load tools that come with the
development version (trunk) of <a class="reference external" href="http://code.google.com/p/couchdb-python/">couchdb-python</a>.</p>
</div>
<div class="section" id="renamed-count-to-limit">
<h5>Renamed &#8220;count&#8221; to &#8220;limit&#8221;<a class="headerlink" href="#renamed-count-to-limit" title="Permalink to this headline">¶</a></h5>
<p>The view query API has been changed: <tt class="docutils literal"><span class="pre">count</span></tt> has become <tt class="docutils literal"><span class="pre">limit</span></tt>.
This is a better description of what the parameter does, and should be a simple
update in any client code.</p>
</div>
<div class="section" id="moved-view-urls">
<h5>Moved View URLs<a class="headerlink" href="#moved-view-urls" title="Permalink to this headline">¶</a></h5>
<p>The view URLs have been moved to design document resources. This means that
paths that used to be like <a class="reference external" href="http://hostname:5984/mydb/_view/designname/viewname?limit=10">http://hostname:5984/mydb/_view/designname/viewname?limit=10</a>
will now look like <a class="reference external" href="http://hostname:5984/mydb/_design/designname/_view/viewname?limit=10">http://hostname:5984/mydb/_design/designname/_view/viewname?limit=10</a>.
See the <a class="reference external" href="http://mail-archives.apache.org/mod_mbox/couchdb-dev/200902.mbox/%3Ce282921e0902242116n2cd207c4x7a9d0feced3f10d9&#64;mail.gmail.com%3E">REST, Hypermedia, and CouchApps</a>  thread on dev for details.</p>
</div>
<div class="section" id="attachments">
<h5>Attachments<a class="headerlink" href="#attachments" title="Permalink to this headline">¶</a></h5>
<p>Names of attachments are no longer allowed to start with an underscore.</p>
</div>
<div class="section" id="error-codes">
<h5>Error Codes<a class="headerlink" href="#error-codes" title="Permalink to this headline">¶</a></h5>
<p>Some refinements have been made to error handling. CouchDB will send 400 instead
of 500 on invalid query parameters. Most notably, document update conflicts now
respond with <cite>409 Conflict</cite> instead of <cite>412 Precondition Failed</cite>. The error code
for when attempting to create a database that already exists is now 412
instead of 409.</p>
</div>
<div class="section" id="ini-file-format">
<h5>ini file format<a class="headerlink" href="#ini-file-format" title="Permalink to this headline">¶</a></h5>
<p>CouchDB 0.9 changes sections and configuration variable names in configuration
files. Old .ini files won&#8217;t work. Also note that CouchDB now ships with two .ini
files where 0.8 used couch.ini there are now <cite>default.ini</cite> and <cite>local.ini</cite>.
<cite>default.ini</cite> contains CouchDB&#8217;s standard configuration values. local.ini is
meant for local changes. <cite>local.ini</cite> is not overwritten on CouchDB updates, so
your edits are safe. In addition, the new runtime configuration system persists
changes to the configuration in <cite>local.ini</cite>.</p>
</div>
</div>
<div class="section" id="version-0-9-2">
<span id="release-0-9-2"></span><h4><a class="toc-backref" href="#id9">Version 0.9.2</a><a class="headerlink" href="#version-0-9-2" title="Permalink to this headline">¶</a></h4>
<div class="section" id="build-and-system-integration">
<h5>Build and System Integration<a class="headerlink" href="#build-and-system-integration" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Remove branch callbacks to allow building couchjs against newer versions of
Spidermonkey.</li>
</ul>
</div>
<div class="section" id="replication">
<h5>Replication<a class="headerlink" href="#replication" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix replication with 0.10 servers initiated by an 0.9 server (<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-559">COUCHDB-559</a>).</li>
</ul>
</div>
</div>
<div class="section" id="version-0-9-1">
<span id="release-0-9-1"></span><h4><a class="toc-backref" href="#id10">Version 0.9.1</a><a class="headerlink" href="#version-0-9-1" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id1">
<h5>Build and System Integration<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>PID file directory is now created by the SysV/BSD daemon scripts.</li>
<li>Fixed the environment variables shown by the configure script.</li>
<li>Fixed the build instructions shown by the configure script.</li>
<li>Updated ownership and permission advice in <cite>README</cite> for better security.</li>
</ul>
</div>
<div class="section" id="configuration-and-stats-system">
<h5>Configuration and stats system<a class="headerlink" href="#configuration-and-stats-system" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Corrected missing configuration file error message.</li>
<li>Fixed incorrect recording of request time.</li>
</ul>
</div>
<div class="section" id="database-core">
<h5>Database Core<a class="headerlink" href="#database-core" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Document validation for underscore prefixed variables.</li>
<li>Made attachment storage less sparse.</li>
<li>Fixed problems when a database with delayed commits pending is considered
idle, and subject to losing changes when shutdown. (<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-334">COUCHDB-334</a>)</li>
</ul>
</div>
<div class="section" id="external-handlers">
<h5>External Handlers<a class="headerlink" href="#external-handlers" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix POST requests.</li>
</ul>
</div>
<div class="section" id="futon">
<h5>Futon<a class="headerlink" href="#futon" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Redirect when loading a deleted view URI from the cookie.</li>
</ul>
</div>
<div class="section" id="http-interface">
<h5>HTTP Interface<a class="headerlink" href="#http-interface" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Attachment requests respect the &#8220;rev&#8221; query-string parameter.</li>
</ul>
</div>
<div class="section" id="javascript-view-server">
<h5>JavaScript View Server<a class="headerlink" href="#javascript-view-server" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Useful JavaScript Error messages.</li>
</ul>
</div>
<div class="section" id="id2">
<h5>Replication<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added support for Unicode characters transmitted as UTF-16 surrogate pairs.</li>
<li>URL-encode attachment names when necessary.</li>
<li>Pull specific revisions of an attachment, instead of just the latest one.</li>
<li>Work around a rare chunk-merging problem in ibrowse.</li>
<li>Work with documents containing Unicode characters outside the Basic
Multilingual Plane.</li>
</ul>
</div>
</div>
<div class="section" id="version-0-9-0">
<span id="release-0-9-0"></span><h4><a class="toc-backref" href="#id11">Version 0.9.0</a><a class="headerlink" href="#version-0-9-0" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id3">
<h5>Build and System Integration<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>The <cite>couchdb</cite> script now supports system chainable configuration files.</li>
<li>The Mac OS X daemon script now redirects STDOUT and STDERR like SysV/BSD.</li>
<li>The build and system integration have been improved for portability.</li>
<li>Added COUCHDB_OPTIONS to etc/default/couchdb file.</li>
<li>Remove COUCHDB_INI_FILE and COUCHDB_PID_FILE from etc/default/couchdb file.</li>
<li>Updated <cite>configure.ac</cite> to manually link <cite>libm</cite> for portability.</li>
<li>Updated <cite>configure.ac</cite> to extended default library paths.</li>
<li>Removed inets configuration files.</li>
<li>Added command line test runner.</li>
<li>Created dev target for make.</li>
</ul>
</div>
<div class="section" id="id4">
<h5>Configuration and stats system<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Separate default and local configuration files.</li>
<li>HTTP interface for configuration changes.</li>
<li>Statistics framework with HTTP query API.</li>
</ul>
</div>
<div class="section" id="id5">
<h5>Database Core<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Faster B-tree implementation.</li>
<li>Changed internal JSON term format.</li>
<li>Improvements to Erlang VM interactions under heavy load.</li>
<li>User context and administrator role.</li>
<li>Update validations with design document validation functions.</li>
<li>Document purge functionality.</li>
<li>Ref-counting for database file handles.</li>
</ul>
</div>
<div class="section" id="design-document-resource-paths">
<h5>Design Document Resource Paths<a class="headerlink" href="#design-document-resource-paths" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added httpd_design_handlers config section.</li>
<li>Moved _view to httpd_design_handlers.</li>
<li>Added ability to render documents as non-JSON content-types with _show and
_list functions, which are also httpd_design_handlers.</li>
</ul>
</div>
<div class="section" id="futon-utility-client">
<h5>Futon Utility Client<a class="headerlink" href="#futon-utility-client" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added pagination to the database listing page.</li>
<li>Implemented attachment uploading from the document page.</li>
<li>Added page that shows the current configuration, and allows modification of
option values.</li>
<li>Added a JSON &#8220;source view&#8221; for document display.</li>
<li>JSON data in view rows is now syntax highlighted.</li>
<li>Removed the use of an iframe for better integration with browser history and
bookmarking.</li>
<li>Full database listing in the sidebar has been replaced by a short list of
recent databases.</li>
<li>The view editor now allows selection of the view language if there is more
than one configured.</li>
<li>Added links to go to the raw view or document URI.</li>
<li>Added status page to display currently running tasks in CouchDB.</li>
<li>JavaScript test suite split into multiple files.</li>
<li>Pagination for reduce views.</li>
</ul>
</div>
<div class="section" id="id6">
<h5>HTTP Interface<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Added client side UUIDs for idempotent document creation</li>
<li>HTTP COPY for documents</li>
<li>Streaming of chunked attachment PUTs to disk</li>
<li>Remove negative count feature</li>
<li>Add include_docs option for view queries</li>
<li>Add multi-key view post for views</li>
<li>Query parameter validation</li>
<li>Use stale=ok to request potentially cached view index</li>
<li>External query handler module for full-text or other indexers.</li>
<li>Etags for attachments, views, shows and lists</li>
<li>Show and list functions for rendering documents and views as developer
controlled content-types.</li>
<li>Attachment names may use slashes to allow uploading of nested directories
(useful for static web hosting).</li>
<li>Option for a view to run over design documents.</li>
<li>Added newline to JSON responses. Closes bike-shed.</li>
</ul>
</div>
<div class="section" id="id7">
<h5>Replication<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Using ibrowse.</li>
<li>Checkpoint replications so failures are less expensive.</li>
<li>Automatically retry of failed replications.</li>
<li>Stream attachments in pull-replication.</li>
</ul>
</div>
</div>
</div>
<span id="document-whatsnew/0.8"></span><div class="section" id="x-branch">
<span id="release-0-8-x"></span><h3>0.8.x Branch<a class="headerlink" href="#x-branch" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#version-0-8-1-incubating" id="id6">Version 0.8.1-incubating</a></li>
<li><a class="reference internal" href="#version-0-8-0-incubating" id="id7">Version 0.8.0-incubating</a></li>
</ul>
</div>
<div class="section" id="version-0-8-1-incubating">
<span id="release-0-8-1"></span><h4><a class="toc-backref" href="#id6">Version 0.8.1-incubating</a><a class="headerlink" href="#version-0-8-1-incubating" title="Permalink to this headline">¶</a></h4>
<div class="section" id="build-and-system-integration">
<h5>Build and System Integration<a class="headerlink" href="#build-and-system-integration" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>The <cite>couchdb</cite> script no longer uses <cite>awk</cite> for configuration checks as this
was causing portability problems.</li>
<li>Updated <cite>sudo</cite> example in <cite>README</cite> to use the <cite>-i</cite> option, this fixes
problems when invoking from a directory the <cite>couchdb</cite> user cannot access.</li>
</ul>
</div>
<div class="section" id="database-core">
<h5>Database Core<a class="headerlink" href="#database-core" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix for replication problems where the write queues can get backed up if the
writes aren&#8217;t happening fast enough to keep up with the reads. For a large
replication, this can exhaust memory and crash, or slow down the machine
dramatically. The fix keeps only one document in the write queue at a time.</li>
<li>Fix for databases sometimes incorrectly reporting that they contain 0
documents after compaction.</li>
<li>CouchDB now uses ibrowse instead of inets for its internal HTTP client
implementation. This means better replication stability.</li>
</ul>
</div>
<div class="section" id="futon">
<h5>Futon<a class="headerlink" href="#futon" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>The view selector dropdown should now work in Opera and Internet Explorer
even when it includes optgroups for design documents. (<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-81">COUCHDB-81</a>)</li>
</ul>
</div>
<div class="section" id="javascript-view-server">
<h5>JavaScript View Server<a class="headerlink" href="#javascript-view-server" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Sealing of documents has been disabled due to an incompatibility with
SpiderMonkey 1.9.</li>
<li>Improve error handling for undefined values emitted by map functions.
(<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-83">COUCHDB-83</a>)</li>
</ul>
</div>
<div class="section" id="http-interface">
<h5>HTTP Interface<a class="headerlink" href="#http-interface" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Fix for chunked responses where chunks were always being split into multiple
TCP packets, which caused problems with the test suite under Safari, and in
some other cases.</li>
<li>Fix for an invalid JSON response body being returned for some kinds of
views. (<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-84">COUCHDB-84</a>)</li>
<li>Fix for connections not getting closed after rejecting a chunked request.
(<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-55">COUCHDB-55</a>)</li>
<li>CouchDB can now be bound to IPv6 addresses.</li>
<li>The HTTP <cite>Server</cite> header now contains the versions of CouchDB and Erlang.</li>
</ul>
</div>
</div>
<div class="section" id="version-0-8-0-incubating">
<span id="release-0-8-0"></span><h4><a class="toc-backref" href="#id7">Version 0.8.0-incubating</a><a class="headerlink" href="#version-0-8-0-incubating" title="Permalink to this headline">¶</a></h4>
<div class="section" id="id1">
<h5>Build and System Integration<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>CouchDB can automatically respawn following a server crash.</li>
<li>Database server no longer refuses to start with a stale PID file.</li>
<li>System logrotate configuration provided.</li>
<li>Improved handling of ICU shared libraries.</li>
<li>The <cite>couchdb</cite> script now automatically enables SMP support in Erlang.</li>
<li>The <cite>couchdb</cite> and <cite>couchjs</cite> scripts have been improved for portability.</li>
<li>The build and system integration have been improved for portability.</li>
</ul>
</div>
<div class="section" id="id2">
<h5>Database Core<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>The view engine has been completely decoupled from the storage engine. Index
data is now stored in separate files, and the format of the main database
file has changed.</li>
<li>Databases can now be compacted to reclaim space used for deleted documents
and old document revisions.</li>
<li>Support for incremental map/reduce views has been added.</li>
<li>To support map/reduce, the structure of design documents has changed. View
values are now JSON objects containing at least a <cite>map</cite> member, and
optionally a <cite>reduce</cite> member.</li>
<li>View servers are now identified by name (for example <cite>javascript</cite>) instead of
by media type.</li>
<li>Automatically generated document IDs are now based on proper UUID generation
using the crypto module.</li>
<li>The field <cite>content-type</cite> in the JSON representation of attachments has been
renamed to <cite>content_type</cite> (underscore).</li>
</ul>
</div>
<div class="section" id="id3">
<h5>Futon<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>When adding a field to a document, Futon now just adds a field with an
autogenerated name instead of prompting for the name with a dialog. The name
is automatically put into edit mode so that it can be changed immediately.</li>
<li>Fields are now sorted alphabetically by name when a document is displayed.</li>
<li>Futon can be used to create and update permanent views.</li>
<li>The maximum number of rows to display per page on the database page can now
be adjusted.</li>
<li>Futon now uses the XMLHTTPRequest API asynchronously to communicate with the
CouchDB HTTP server, so that most operations no longer block the browser.</li>
<li>View results sorting can now be switched between ascending and descending by
clicking on the <cite>Key</cite> column header.</li>
<li>Fixed a bug where documents that contained a <cite>&#64;</cite> character could not be
viewed. (<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-12">COUCHDB-12</a>)</li>
<li>The database page now provides a <cite>Compact</cite> button to trigger database
compaction. (<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-38">COUCHDB-38</a>)</li>
<li>Fixed portential double encoding of document IDs and other URI segments in
many instances. (<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-39">COUCHDB-39</a>)</li>
<li>Improved display of attachments.</li>
<li>The JavaScript Shell has been removed due to unresolved licensing issues.</li>
</ul>
</div>
<div class="section" id="id4">
<h5>JavaScript View Server<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>SpiderMonkey is no longer included with CouchDB, but rather treated as a
normal external dependency. A simple C program (<cite>_couchjs</cite>) is provided that
links against an existing SpiderMonkey installation and uses the interpreter
embedding API.</li>
<li>View functions using the default JavaScript view server can now do logging
using the global <cite>log(message)</cite> function. Log messages are directed into the
CouchDB log at <cite>INFO</cite> level. (<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-59">COUCHDB-59</a>)</li>
<li>The global <cite>map(key, value)</cite> function made available to view code has been
renamed to <cite>emit(key, value)</cite>.</li>
<li>Fixed handling of exceptions raised by view functions.</li>
</ul>
</div>
<div class="section" id="id5">
<h5>HTTP Interface<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>CouchDB now uses MochiWeb instead of inets for the HTTP server
implementation. Among other things, this means that the extra configuration
files needed for inets (such as <cite>couch_httpd.conf</cite>) are no longer used.</li>
<li>The HTTP interface now completely supports the <cite>HEAD</cite> method. (<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-3">COUCHDB-3</a>)</li>
<li>Improved compliance of <cite>Etag</cite> handling with the HTTP specification.
(<a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB-13">COUCHDB-13</a>)</li>
<li>Etags are no longer included in responses to document <cite>GET</cite> requests that
include query string parameters causing the JSON response to change without
the revision or the URI having changed.</li>
<li>The bulk document update API has changed slightly on both the request and the
response side. In addition, bulk updates are now atomic.</li>
<li>CouchDB now uses <cite>TCP_NODELAY</cite> to fix performance problems with persistent
connections on some platforms due to nagling.</li>
<li>Including a <cite>?descending=false</cite> query string parameter in requests to views
no longer raises an error.</li>
<li>Requests to unknown top-level reserved URLs (anything with a leading
underscore) now return a <cite>unknown_private_path</cite> error instead of the
confusing <cite>illegal_database_name</cite>.</li>
<li>The Temporary view handling now expects a JSON request body, where the JSON
is an object with at least a <cite>map</cite> member, and optional <cite>reduce</cite> and
<cite>language</cite> members.</li>
<li>Temporary views no longer determine the view server based on the Content-Type
header of the <cite>POST</cite> request, but rather by looking for a <cite>language</cite> member
in the JSON body of the request.</li>
<li>The status code of responses to <cite>DELETE</cite> requests is now 200 to reflect that
that the deletion is performed synchronously.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<span id="document-cve/index"></span><div class="section" id="security-issues-information">
<span id="cve"></span><h2>Security Issues Information<a class="headerlink" href="#security-issues-information" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-cve/2010-0009"></span><div class="section" id="cve-2010-0009-apache-couchdb-timing-attack-vulnerability">
<span id="cve-2010-0009"></span><h3>CVE-2010-0009: Apache CouchDB Timing Attack Vulnerability<a class="headerlink" href="#cve-2010-0009-apache-couchdb-timing-attack-vulnerability" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">31.03.2010</td>
</tr>
<tr class="field-even field"><th class="field-name">Affected:</th><td class="field-body">Apache CouchDB 0.8.0 to 0.10.1</td>
</tr>
<tr class="field-odd field"><th class="field-name">Severity:</th><td class="field-body">Important</td>
</tr>
<tr class="field-even field"><th class="field-name">Vendor:</th><td class="field-body">The Apache Software Foundation</td>
</tr>
</tbody>
</table>
<div class="section" id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>Apache CouchDB versions prior to version <a class="reference internal" href="contents.html#release-0-11-0"><em>0.11.0</em></a> are
vulnerable to timing attacks, also known as side-channel information leakage,
due to using simple break-on-inequality string comparisons when verifying hashes
and passwords.</p>
</div>
<div class="section" id="mitigation">
<h4>Mitigation<a class="headerlink" href="#mitigation" title="Permalink to this headline">¶</a></h4>
<p>All users should upgrade to CouchDB <a class="reference internal" href="contents.html#release-0-11-0"><em>0.11.0</em></a>.
Upgrades from the <a class="reference internal" href="contents.html#release-0-10-x"><em>0.10.x</em></a> series should be seamless.
Users on earlier versions should consult with
<a class="reference internal" href="contents.html#release-0-10-x-upgrade"><em>upgrade notes</em></a>.</p>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>A canonical description of the attack can be found in
<a class="reference external" href="http://codahale.com/a-lesson-in-timing-attacks/">http://codahale.com/a-lesson-in-timing-attacks/</a></p>
</div>
<div class="section" id="credit">
<h4>Credit<a class="headerlink" href="#credit" title="Permalink to this headline">¶</a></h4>
<p>This issue was discovered by <em>Jason Davies</em> of the Apache CouchDB development
team.</p>
</div>
</div>
<span id="document-cve/2010-2234"></span><div class="section" id="cve-2010-2234-apache-couchdb-cross-site-request-forgery-attack">
<span id="cve-2010-2234"></span><h3>CVE-2010-2234: Apache CouchDB Cross Site Request Forgery Attack<a class="headerlink" href="#cve-2010-2234-apache-couchdb-cross-site-request-forgery-attack" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">21.02.2010</td>
</tr>
<tr class="field-even field"><th class="field-name">Affected:</th><td class="field-body">Apache CouchDB 0.8.0 to 0.11.1</td>
</tr>
<tr class="field-odd field"><th class="field-name">Severity:</th><td class="field-body">Important</td>
</tr>
<tr class="field-even field"><th class="field-name">Vendor:</th><td class="field-body">The Apache Software Foundation</td>
</tr>
</tbody>
</table>
<div class="section" id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>Apache CouchDB versions prior to version <a class="reference internal" href="contents.html#release-0-11-1"><em>0.11.1</em></a> are
vulnerable to <a class="reference external" href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">Cross Site Request Forgery</a> (CSRF) attacks.</p>
</div>
<div class="section" id="mitigation">
<h4>Mitigation<a class="headerlink" href="#mitigation" title="Permalink to this headline">¶</a></h4>
<p>All users should upgrade to CouchDB <a class="reference internal" href="contents.html#release-0-11-2"><em>0.11.2</em></a>
or <a class="reference internal" href="contents.html#release-1-0-1"><em>1.0.1</em></a>.</p>
<p>Upgrades from the <a class="reference internal" href="contents.html#release-0-11-x"><em>0.11.x</em></a> and
<a class="reference internal" href="contents.html#release-0-10-x"><em>0.10.x</em></a> series should be seamless.</p>
<p>Users on earlier versions should consult with upgrade notes.</p>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>A malicious website can <cite>POST</cite> arbitrary JavaScript code to well
known CouchDB installation URLs (like <a class="reference external" href="http://localhost:5984/">http://localhost:5984/</a>)
and make the browser execute the injected JavaScript in the
security context of CouchDB&#8217;s admin interface Futon.</p>
<p>Unrelated, but in addition the JSONP API has been turned off
by default to avoid potential information leakage.</p>
</div>
<div class="section" id="credit">
<h4>Credit<a class="headerlink" href="#credit" title="Permalink to this headline">¶</a></h4>
<p>This CSRF issue was discovered by a source that wishes to stay
anonymous.</p>
</div>
</div>
<span id="document-cve/2010-3854"></span><div class="section" id="cve-2010-3854-apache-couchdb-cross-site-scripting-issue">
<span id="cve-2010-3854"></span><h3>CVE-2010-3854: Apache CouchDB Cross Site Scripting Issue<a class="headerlink" href="#cve-2010-3854-apache-couchdb-cross-site-scripting-issue" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">28.01.2011</td>
</tr>
<tr class="field-even field"><th class="field-name">Affected:</th><td class="field-body">Apache CouchDB 0.8.0 to 1.0.1</td>
</tr>
<tr class="field-odd field"><th class="field-name">Severity:</th><td class="field-body">Important</td>
</tr>
<tr class="field-even field"><th class="field-name">Vendor:</th><td class="field-body">The Apache Software Foundation</td>
</tr>
</tbody>
</table>
<div class="section" id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>Apache CouchDB versions prior to version <a class="reference internal" href="contents.html#release-1-0-2"><em>1.0.2</em></a> are
vulnerable to <a class="reference external" href="http://en.wikipedia.org/wiki/Cross-site_scripting">Cross Site Scripting</a> (XSS) attacks.</p>
</div>
<div class="section" id="mitigation">
<h4>Mitigation<a class="headerlink" href="#mitigation" title="Permalink to this headline">¶</a></h4>
<p>All users should upgrade to CouchDB <a class="reference internal" href="contents.html#release-1-0-2"><em>1.0.2</em></a>.</p>
<p>Upgrades from the <a class="reference internal" href="contents.html#release-0-11-x"><em>0.11.x</em></a> and
<a class="reference internal" href="contents.html#release-0-10-x"><em>0.10.x</em></a> series should be seamless.</p>
<p>Users on earlier versions should consult with upgrade notes.</p>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>Due to inadequate validation of request parameters and cookie data in Futon,
CouchDB&#8217;s web-based administration UI, a malicious site can execute arbitrary
code in the context of a user&#8217;s browsing session.</p>
</div>
<div class="section" id="credit">
<h4>Credit<a class="headerlink" href="#credit" title="Permalink to this headline">¶</a></h4>
<p>This XSS issue was discovered by a source that wishes to stay anonymous.</p>
</div>
</div>
<span id="document-cve/2012-5641"></span><div class="section" id="cve-2012-5641-information-disclosure-via-unescaped-backslashes-in-urls-on-windows">
<span id="cve-2012-5641"></span><h3>CVE-2012-5641: Information disclosure via unescaped backslashes in URLs on Windows<a class="headerlink" href="#cve-2012-5641-information-disclosure-via-unescaped-backslashes-in-urls-on-windows" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">14.01.2013</td>
</tr>
<tr class="field-even field"><th class="field-name">Affected:</th><td class="field-body">All Windows-based releases of Apache CouchDB, up to and including
1.0.3, 1.1.1, and 1.2.0 are vulnerable.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Severity:</th><td class="field-body">Moderate</td>
</tr>
<tr class="field-even field"><th class="field-name">Vendor:</th><td class="field-body">The Apache Software Foundation</td>
</tr>
</tbody>
</table>
<div class="section" id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>A specially crafted request could be used to access content directly that
would otherwise be protected by inbuilt CouchDB security mechanisms. This
request could retrieve in binary form any CouchDB database, including the
<cite>_users</cite> or <cite>_replication</cite> databases, or any other file that the user account
used to run CouchDB might have read access to on the local filesystem. This
exploit is due to a vulnerability in the included MochiWeb HTTP library.</p>
</div>
<div class="section" id="mitigation">
<h4>Mitigation<a class="headerlink" href="#mitigation" title="Permalink to this headline">¶</a></h4>
<p>Upgrade to a supported CouchDB release that includes this fix, such as:</p>
<ul class="simple">
<li><a class="reference internal" href="contents.html#release-1-0-4"><em>1.0.4</em></a></li>
<li><a class="reference internal" href="contents.html#release-1-1-2"><em>1.1.2</em></a></li>
<li><a class="reference internal" href="contents.html#release-1-2-1"><em>1.2.1</em></a></li>
<li><a class="reference internal" href="contents.html#release-1-3-x"><em>1.3.x</em></a></li>
</ul>
<p>All listed releases have included a specific fix for the MochiWeb component.</p>
</div>
<div class="section" id="work-around">
<h4>Work-Around<a class="headerlink" href="#work-around" title="Permalink to this headline">¶</a></h4>
<p>Users may simply exclude any file-based web serving components directly
within their configuration file, typically in <cite>local.ini</cite>. On a default
CouchDB installation, this requires amending the
<a class="reference internal" href="contents.html#httpd_global_handlers/favicon.ico" title="favicon.ico"><tt class="xref config config-option docutils literal"><span class="pre">httpd_global_handlers/favicon.ico</span></tt></a> and
<a class="reference internal" href="contents.html#httpd_global_handlers/_utils" title="_utils"><tt class="xref config config-option docutils literal"><span class="pre">httpd_global_handlers/_utils</span></tt></a> lines within
<a class="reference internal" href="contents.html#httpd_global_handlers" title="[httpd_global_handlers]"><tt class="xref config config-section docutils literal"><span class="pre">httpd_global_handlers</span></tt></a>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">favicon.ico</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_welcome_req, &lt;&lt;&quot;Forbidden&quot;&gt;&gt;}</span>
<span class="na">_utils</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_welcome_req, &lt;&lt;&quot;Forbidden&quot;&gt;&gt;}</span>
</pre></div>
</div>
<p>If additional handlers have been added, such as to support Adobe&#8217;s Flash
<cite>crossdomain.xml</cite> files, these would also need to be excluded.</p>
</div>
<div class="section" id="acknowledgement">
<h4>Acknowledgement<a class="headerlink" href="#acknowledgement" title="Permalink to this headline">¶</a></h4>
<p>The issue was found and reported by Sriram Melkote to the upstream MochiWeb
project.</p>
</div>
<div class="section" id="references">
<h4>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://github.com/melkote/mochiweb/commit/ac2bf">https://github.com/melkote/mochiweb/commit/ac2bf</a></li>
</ul>
</div>
</div>
<span id="document-cve/2012-5649"></span><div class="section" id="cve-2012-5649-jsonp-arbitrary-code-execution-with-adobe-flash">
<span id="cve-2012-5649"></span><h3>CVE-2012-5649: JSONP arbitrary code execution with Adobe Flash<a class="headerlink" href="#cve-2012-5649-jsonp-arbitrary-code-execution-with-adobe-flash" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">14.01.2013</td>
</tr>
<tr class="field-even field"><th class="field-name">Affected:</th><td class="field-body">Releases up to and including 1.0.3, 1.1.1, and 1.2.0 are vulnerable,
if administrators have enabled JSONP.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Severity:</th><td class="field-body">Moderate</td>
</tr>
<tr class="field-even field"><th class="field-name">Vendor:</th><td class="field-body">The Apache Software Foundation</td>
</tr>
</tbody>
</table>
<div class="section" id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>A hand-crafted JSONP callback and response can be used to run arbitrary code
inside client-side browsers via Adobe Flash.</p>
</div>
<div class="section" id="mitigation">
<h4>Mitigation<a class="headerlink" href="#mitigation" title="Permalink to this headline">¶</a></h4>
<p>Upgrade to a supported CouchDB release that includes this fix, such as:</p>
<ul class="simple">
<li><a class="reference internal" href="contents.html#release-1-0-4"><em>1.0.4</em></a></li>
<li><a class="reference internal" href="contents.html#release-1-1-2"><em>1.1.2</em></a></li>
<li><a class="reference internal" href="contents.html#release-1-2-1"><em>1.2.1</em></a></li>
<li><a class="reference internal" href="contents.html#release-1-3-x"><em>1.3.x</em></a></li>
</ul>
<p>All listed releases have included a specific fix.</p>
</div>
<div class="section" id="work-around">
<h4>Work-Around<a class="headerlink" href="#work-around" title="Permalink to this headline">¶</a></h4>
<p>Disable JSONP or don&#8217;t enable it since it&#8217;s disabled by default.</p>
</div>
</div>
<span id="document-cve/2012-5650"></span><div class="section" id="cve-2012-5650-dom-based-cross-site-scripting-via-futon-ui">
<span id="cve-2012-5650"></span><h3>CVE-2012-5650: DOM based Cross-Site Scripting via Futon UI<a class="headerlink" href="#cve-2012-5650-dom-based-cross-site-scripting-via-futon-ui" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">14.01.2013</td>
</tr>
<tr class="field-even field"><th class="field-name">Affected:</th><td class="field-body">Apache CouchDB releases up to and including 1.0.3, 1.1.1,
and 1.2.0 are vulnerable.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Severity:</th><td class="field-body">Moderate</td>
</tr>
<tr class="field-even field"><th class="field-name">Vendor:</th><td class="field-body">The Apache Software Foundation</td>
</tr>
</tbody>
</table>
<div class="section" id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>Query parameters passed into the browser-based test suite are not sanitised,
and can be used to load external resources. An attacker may execute JavaScript
code in the browser, using the context of the remote user.</p>
</div>
<div class="section" id="mitigation">
<h4>Mitigation<a class="headerlink" href="#mitigation" title="Permalink to this headline">¶</a></h4>
<p>Upgrade to a supported CouchDB release that includes this fix, such as:</p>
<ul class="simple">
<li><a class="reference internal" href="contents.html#release-1-0-4"><em>1.0.4</em></a></li>
<li><a class="reference internal" href="contents.html#release-1-1-2"><em>1.1.2</em></a></li>
<li><a class="reference internal" href="contents.html#release-1-2-1"><em>1.2.1</em></a></li>
<li><a class="reference internal" href="contents.html#release-1-3-x"><em>1.3.x</em></a></li>
</ul>
<p>All listed releases have included a specific fix.</p>
</div>
<div class="section" id="work-around">
<h4>Work-Around<a class="headerlink" href="#work-around" title="Permalink to this headline">¶</a></h4>
<p>Disable the Futon user interface completely, by adapting <cite>local.ini</cite> and
restarting CouchDB:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_utils</span> <span class="o">=</span> <span class="s">{couch_httpd_misc_handlers, handle_welcome_req, &lt;&lt;&quot;Forbidden&quot;&gt;&gt;}</span>
</pre></div>
</div>
<p>Or by removing the UI test suite components:</p>
<ul class="simple">
<li>share/www/verify_install.html</li>
<li>share/www/couch_tests.html</li>
<li>share/www/custom_test.html</li>
</ul>
</div>
<div class="section" id="acknowledgement">
<h4>Acknowledgement<a class="headerlink" href="#acknowledgement" title="Permalink to this headline">¶</a></h4>
<p>This vulnerability was discovered &amp; reported to the Apache Software Foundation
by <a class="reference external" href="https://frederik-braun.com/">Frederik Braun</a>.</p>
</div>
</div>
<span id="document-cve/2014-2668"></span><div class="section" id="cve-2014-2668-dos-cpu-and-memory-consumption-via-the-count-parameter-to-uuids">
<span id="cve-2014-2668"></span><h3>CVE-2014-2668: DoS (CPU and memory consumption) via the count parameter to /_uuids<a class="headerlink" href="#cve-2014-2668-dos-cpu-and-memory-consumption-via-the-count-parameter-to-uuids" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">26.03.2014</td>
</tr>
<tr class="field-even field"><th class="field-name">Affected:</th><td class="field-body">Apache CouchDB releases up to and including 1.3.1, 1.4.0,
and 1.5.0 are vulnerable.</td>
</tr>
<tr class="field-odd field"><th class="field-name">Severity:</th><td class="field-body">Moderate</td>
</tr>
<tr class="field-even field"><th class="field-name">Vendor:</th><td class="field-body">The Apache Software Foundation</td>
</tr>
</tbody>
</table>
<div class="section" id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>The <a class="reference internal" href="contents.html#api-server-uuids"><em>/_uuids</em></a> resource&#8217;s <cite>count</cite> query parameter is able to take
unreasonable huge numeric value which leads to exhaustion of server resources
(CPU and memory) and to DoS as the result.</p>
</div>
<div class="section" id="mitigation">
<h4>Mitigation<a class="headerlink" href="#mitigation" title="Permalink to this headline">¶</a></h4>
<p>Upgrade to a supported CouchDB release that includes this fix, such as:</p>
<ul class="simple">
<li><a class="reference internal" href="contents.html#release-1-5-1"><em>1.5.1</em></a></li>
<li><a class="reference internal" href="contents.html#release-1-6-0"><em>1.6.0</em></a></li>
</ul>
<p>All listed releases have included a specific fix to</p>
</div>
<div class="section" id="work-around">
<h4>Work-Around<a class="headerlink" href="#work-around" title="Permalink to this headline">¶</a></h4>
<p>Disable the <a class="reference internal" href="contents.html#api-server-uuids"><em>/_uuids</em></a> handler completely, by adapting
<cite>local.ini</cite> and restarting CouchDB:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[httpd_global_handlers]</span>
<span class="na">_uuids</span> <span class="o">=</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="reporting-new-security-problems-with-apache-couchdb">
<span id="cve-report"></span><h2>Reporting New Security Problems with Apache CouchDB<a class="headerlink" href="#reporting-new-security-problems-with-apache-couchdb" title="Permalink to this headline">¶</a></h2>
<p>The Apache Software Foundation takes a very active stance in eliminating
security problems and denial of service attacks against Apache CouchDB.</p>
<p>We strongly encourage folks to report such problems to our private security
mailing list first, before disclosing them in a public forum.</p>
<p>Please note that the security mailing list should only be used for reporting
undisclosed security vulnerabilities in Apache CouchDB and managing the
process of fixing such vulnerabilities. We cannot accept regular bug reports
or other queries at this address. All mail sent to this address that does not
relate to an undisclosed security problem in the Apache CouchDB source code
will be ignored.</p>
<p>If you need to report a bug that isn&#8217;t an undisclosed security vulnerability,
please use the <a class="reference external" href="https://issues.apache.org/jira/browse/COUCHDB">bug reporting page</a>.</p>
<p>Questions about:</p>
<ul class="simple">
<li>How to configure CouchDB securely</li>
<li>If a vulnerability applies to your particular application</li>
<li>Obtaining further information on a published vulnerability</li>
<li>Availability of patches and/or new releases</li>
</ul>
<p>should be address to the <a class="reference external" href="mailto:user&#37;&#52;&#48;couchdb&#46;apache&#46;org">users mailing list</a>. Please see the <a class="reference external" href="http://couchdb.apache.org/#mailing-list">mailing
lists page</a> for details of how to subscribe.</p>
<p>The private security mailing address is: <a class="reference external" href="mailto:security&#37;&#52;&#48;couchdb&#46;apache&#46;org">security<span>&#64;</span>couchdb<span>&#46;</span>apache<span>&#46;</span>org</a></p>
<p>Please read <a class="reference external" href="http://apache.org/security/committers.html">how the Apache Software Foundation handles security</a> reports to
know what to expect.</p>
<p>Note that all networked servers are subject to denial of service attacks,
and we cannot promise magic workarounds to generic problems (such as a client
streaming lots of data to your server, or re-requesting the same URL
repeatedly). In general our philosophy is to avoid any attacks which can
cause the server to consume resources in a non-linear relationship to the
size of inputs.</p>
</div>
<span id="document-about"></span><div class="section" id="about-couchdb-documentation">
<span id="about"></span><h2>About CouchDB Documentation<a class="headerlink" href="#about-couchdb-documentation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="license">
<h3>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ini"><div class="highlight"><pre>                                Apache License
                          Version 2.0, January 2004
                       http://www.apache.org/licenses/

  TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

  1. Definitions.

     &quot;License&quot; shall mean the terms and conditions for use, reproduction,
     and distribution as defined by Sections 1 through 9 of this document.

     &quot;Licensor&quot; shall mean the copyright owner or entity authorized by
     the copyright owner that is granting the License.

     &quot;Legal Entity&quot; shall mean the union of the acting entity and all
     other entities that control, are controlled by, or are under common
     control with that entity. For the purposes of this definition,
     &quot;control&quot; means (i) the power, direct or indirect, to cause the
     direction or management of such entity, whether by contract or
     otherwise, or (ii) ownership of fifty percent (50%) or more of the
     outstanding shares, or (iii) beneficial ownership of such entity.

     &quot;You&quot; (or &quot;Your&quot;) shall mean an individual or Legal Entity
     exercising permissions granted by this License.

     &quot;Source&quot; form shall mean the preferred form for making modifications,
     including but not limited to software source code, documentation
     source, and configuration files.

     &quot;Object&quot; form shall mean any form resulting from mechanical
     transformation or translation of a Source form, including but
     not limited to compiled object code, generated documentation,
     and conversions to other media types.

     &quot;Work&quot; shall mean the work of authorship, whether in Source or
     Object form, made available under the License, as indicated by a
     copyright notice that is included in or attached to the work
     (an example is provided in the Appendix below).

     &quot;Derivative Works&quot; shall mean any work, whether in Source or Object
     form, that is based on (or derived from) the Work and for which the
     editorial revisions, annotations, elaborations, or other modifications
     represent, as a whole, an original work of authorship. For the purposes
     of this License, Derivative Works shall not include works that remain
     separable from, or merely link (or bind by name) to the interfaces of,
     the Work and Derivative Works thereof.

     &quot;Contribution&quot; shall mean any work of authorship, including
     the original version of the Work and any modifications or additions
     to that Work or Derivative Works thereof, that is intentionally
     submitted to Licensor for inclusion in the Work by the copyright owner
     or by an individual or Legal Entity authorized to submit on behalf of
     the copyright owner. For the purposes of this definition, &quot;submitted&quot;
     means any form of electronic, verbal, or written communication sent
     to the Licensor or its representatives, including but not limited to
     communication on electronic mailing lists, source code control systems,
     and issue tracking systems that are managed by, or on behalf of, the
     Licensor for the purpose of discussing and improving the Work, but
     excluding communication that is conspicuously marked or otherwise
     designated in writing by the copyright owner as &quot;Not a Contribution.&quot;

     &quot;Contributor&quot; shall mean Licensor and any individual or Legal Entity
     on behalf of whom a Contribution has been received by Licensor and
     subsequently incorporated within the Work.

  2. Grant of Copyright License. Subject to the terms and conditions of
     this License, each Contributor hereby grants to You a perpetual,
     worldwide, non-exclusive, no-charge, royalty-free, irrevocable
     copyright license to reproduce, prepare Derivative Works of,
     publicly display, publicly perform, sublicense, and distribute the
     Work and such Derivative Works in Source or Object form.

  3. Grant of Patent License. Subject to the terms and conditions of
     this License, each Contributor hereby grants to You a perpetual,
     worldwide, non-exclusive, no-charge, royalty-free, irrevocable
     (except as stated in this section) patent license to make, have made,
     use, offer to sell, sell, import, and otherwise transfer the Work,
     where such license applies only to those patent claims licensable
     by such Contributor that are necessarily infringed by their
     Contribution(s) alone or by combination of their Contribution(s)
     with the Work to which such Contribution(s) was submitted. If You
     institute patent litigation against any entity (including a
     cross-claim or counterclaim in a lawsuit) alleging that the Work
     or a Contribution incorporated within the Work constitutes direct
     or contributory patent infringement, then any patent licenses
     granted to You under this License for that Work shall terminate
     as of the date such litigation is filed.

  4. Redistribution. You may reproduce and distribute copies of the
     Work or Derivative Works thereof in any medium, with or without
     modifications, and in Source or Object form, provided that You
     meet the following conditions:

     (a) You must give any other recipients of the Work or
         Derivative Works a copy of this License; and

     (b) You must cause any modified files to carry prominent notices
         stating that You changed the files; and

     (c) You must retain, in the Source form of any Derivative Works
         that You distribute, all copyright, patent, trademark, and
         attribution notices from the Source form of the Work,
         excluding those notices that do not pertain to any part of
         the Derivative Works; and

     (d) If the Work includes a &quot;NOTICE&quot; text file as part of its
         distribution, then any Derivative Works that You distribute must
         include a readable copy of the attribution notices contained
         within such NOTICE file, excluding those notices that do not
         pertain to any part of the Derivative Works, in at least one
         of the following places: within a NOTICE text file distributed
         as part of the Derivative Works; within the Source form or
         documentation, if provided along with the Derivative Works; or,
         within a display generated by the Derivative Works, if and
         wherever such third-party notices normally appear. The contents
         of the NOTICE file are for informational purposes only and
         do not modify the License. You may add Your own attribution
         notices within Derivative Works that You distribute, alongside
         or as an addendum to the NOTICE text from the Work, provided
         that such additional attribution notices cannot be construed
         as modifying the License.

     You may add Your own copyright statement to Your modifications and
     may provide additional or different license terms and conditions
     for use, reproduction, or distribution of Your modifications, or
     for any such Derivative Works as a whole, provided Your use,
     reproduction, and distribution of the Work otherwise complies with
     the conditions stated in this License.

  5. Submission of Contributions. Unless You explicitly state otherwise,
     any Contribution intentionally submitted for inclusion in the Work
     by You to the Licensor shall be under the terms and conditions of
     this License, without any additional terms or conditions.
     Notwithstanding the above, nothing herein shall supersede or modify
     the terms of any separate license agreement you may have executed
     with Licensor regarding such Contributions.

  6. Trademarks. This License does not grant permission to use the trade
     names, trademarks, service marks, or product names of the Licensor,
     except as required for reasonable and customary use in describing the
     origin of the Work and reproducing the content of the NOTICE file.

  7. Disclaimer of Warranty. Unless required by applicable law or
     agreed to in writing, Licensor provides the Work (and each
     Contributor provides its Contributions) on an &quot;AS IS&quot; BASIS,
     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
     implied, including, without limitation, any warranties or conditions
     of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
     PARTICULAR PURPOSE. You are solely responsible for determining the
     appropriateness of using or redistributing the Work and assume any
     risks associated with Your exercise of permissions under this License.

  8. Limitation of Liability. In no event and under no legal theory,
     whether in tort (including negligence), contract, or otherwise,
     unless required by applicable law (such as deliberate and grossly
     negligent acts) or agreed to in writing, shall any Contributor be
     liable to You for damages, including any direct, indirect, special,
     incidental, or consequential damages of any character arising as a
     result of this License or out of the use or inability to use the
     Work (including but not limited to damages for loss of goodwill,
     work stoppage, computer failure or malfunction, or any and all
     other commercial damages or losses), even if such Contributor
     has been advised of the possibility of such damages.

  9. Accepting Warranty or Additional Liability. While redistributing
     the Work or Derivative Works thereof, You may choose to offer,
     and charge a fee for, acceptance of support, warranty, indemnity,
     or other liability obligations and/or rights consistent with this
     License. However, in accepting such obligations, You may act only
     on Your own behalf and on Your sole responsibility, not on behalf
     of any other Contributor, and only if You agree to indemnify,
     defend, and hold each Contributor harmless for any liability
     incurred by, or claims asserted against, such Contributor by reason
     of your accepting any such warranty or additional liability.

  END OF TERMS AND CONDITIONS

  APPENDIX: How to apply the Apache License to your work.

     To apply the Apache License to your work, attach the following
     boilerplate notice, with the fields enclosed by brackets &quot;[]&quot;
     replaced with your own identifying information. (Don&#39;t include
     the brackets!)  The text should be enclosed in the appropriate
     comment syntax for the file format. We also recommend that a
     file or class name and description of purpose be included on the
     same &quot;printed page&quot; as the copyright notice for easier
     identification within third-party archives.

  Copyright [yyyy] [name of copyright owner]

  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
</pre></div>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="contents.html#document-contents">
              <img class="logo" src="_static/logo.png" alt="Logo"/>
            </a></p><!--

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

-->

<div id="searchbox" style="display: none">

<h3>Quick Search</h3>

<form class="search" action="search.html" method="get">
<input type="text" name="q" style="width:115px">
<input type="submit" value="Go">
<input type="hidden" name="check_keywords" value="yes">
<input type="hidden" name="area" value="default">
</form>

<br>

</div>

<script type="text/javascript">$('#searchbox').show(0);</script>
  <h3><a href="contents.html#document-contents">Table Of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-intro/index">1. Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-intro/overview">1.1. Technical Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-storage">1.1.1. Document Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#acid-properties">1.1.2. ACID Properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#compaction">1.1.3. Compaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#views">1.1.4. Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#security-and-validation">1.1.5. Security and Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#distributed-updates-and-replication">1.1.6. Distributed Updates and Replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#implementation">1.1.7. Implementation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-intro/why">1.2. Why CouchDB?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#relax">1.2.1. Relax</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#a-different-way-to-model-your-data">1.2.2. A Different Way to Model Your Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#a-better-fit-for-common-applications">1.2.3. A Better Fit for Common Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#building-blocks-for-larger-systems">1.2.4. Building Blocks for Larger Systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#couchdb-replication">1.2.5. CouchDB Replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#local-data-is-king">1.2.6. Local Data Is King</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#wrapping-up">1.2.7. Wrapping Up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-intro/consistency">1.3. Eventual Consistency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#working-with-the-grain">1.3.1. Working with the Grain</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#the-cap-theorem">1.3.2. The CAP Theorem</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#local-consistency">1.3.3. Local Consistency</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#validation">1.3.4. Validation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#distributed-consistency">1.3.5. Distributed Consistency</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#incremental-replication">1.3.6. Incremental Replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#case-study">1.3.7. Case Study</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#wrapping-up">1.3.8. Wrapping Up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-intro/tour">1.4. Getting Started</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#all-systems-are-go">1.4.1. All Systems Are Go!</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#welcome-to-futon">1.4.2. Welcome to Futon</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#your-first-database-and-document">1.4.3. Your First Database and Document</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#running-a-query-using-mapreduce">1.4.4. Running a Query Using MapReduce</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#triggering-replication">1.4.5. Triggering Replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#wrapping-up">1.4.6. Wrapping Up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-intro/api">1.5. The Core API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#server">1.5.1. Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#databases">1.5.2. Databases</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#documents">1.5.3. Documents</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#replication">1.5.4. Replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#wrapping-up">1.5.5. Wrapping Up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-intro/security">1.6. Security</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#authentication">1.6.1. Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#authentication-database">1.6.2. Authentication Database</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-intro/futon">1.7. Futon: Web GUI Administration Panel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#managing-databases-and-documents">1.7.1. Managing Databases and Documents</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#configuring-replication">1.7.2. Configuring Replication</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-intro/curl">1.8. cURL: Your Command Line Friend</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-install/index">2. Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-install/unix">2.1. Installation on Unix-like systems</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#troubleshooting">2.1.1. Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#dependencies">2.1.2. Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#installing">2.1.3. Installing</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#first-run">2.1.4. First Run</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#security-considerations">2.1.5. Security Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#running-as-a-daemon">2.1.6. Running as a Daemon</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-install/windows">2.2. Installation on Windows</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#installation-from-binaries">2.2.1. Installation from binaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#installation-from-sources">2.2.2. Installation from sources</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-install/mac">2.3. Installation on Mac OS X</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#installation-using-the-apache-couchdb-native-application">2.3.1. Installation using the Apache CouchDB native application</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#installation-with-homebrew">2.3.2. Installation with HomeBrew</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#installation-from-macports">2.3.3. Installation from MacPorts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-install/freebsd">2.4. Installation on FreeBSD</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#installation-from-ports">2.4.1. Installation from ports</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-config/index">3. Configuring CouchDB</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/intro">3.1. Introduction Into Configuring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#configuration-files">3.1.1. Configuration files</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#parameter-names-and-values">3.1.2. Parameter names and values</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#setting-parameters-via-the-configuration-file">3.1.3. Setting parameters via the configuration file</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#setting-parameters-via-the-http-api">3.1.4. Setting parameters via the HTTP API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/couchdb">3.2. Base Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#base-couchdb-options">3.2.1. Base CouchDB Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/http">3.3. CouchDB HTTP Server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#http-server-options">3.3.1. HTTP Server Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#secure-socket-level-options">3.3.2. Secure Socket Level Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#cross-origin-resource-sharing">3.3.3. Cross-Origin Resource Sharing</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#virtual-hosts">3.3.4. Virtual Hosts</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/auth">3.4. Authentication and Authorization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#server-administrators">3.4.1. Server Administrators</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#authentication-configuration">3.4.2. Authentication Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#http-oauth-configuration">3.4.3. HTTP OAuth Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#oauth-configuration">3.4.4. OAuth Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/compaction">3.5. Compaction Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#database-compaction-options">3.5.1. Database Compaction Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#compaction-daemon-rules">3.5.2. Compaction Daemon Rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#configuration-of-compaction-daemon">3.5.3. Configuration of Compaction Daemon</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#views-compaction-options">3.5.4. Views Compaction Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/logging">3.6. Logging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#logging-options">3.6.1. Logging options</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#per-module-logging">3.6.2. Per module logging</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/replicator">3.7. Replicator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#replicator-database-configuration">3.7.1. Replicator Database Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/query-servers">3.8. Query Servers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#query-servers-definition">3.8.1. Query Servers Definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#query-servers-configuration">3.8.2. Query Servers Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#native-erlang-query-server">3.8.3. Native Erlang Query Server</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/externals">3.9. External Processes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#os-daemons">3.9.1. OS Daemons</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#os-daemons-settings">3.9.2. OS Daemons settings</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#config-update-notification">3.9.3. Update notifications</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/http-handlers">3.10. HTTP Resource Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#global-http-handlers">3.10.1. Global HTTP Handlers</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#database-http-handlers">3.10.2. Database HTTP Handlers</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#design-documents-http-handlers">3.10.3. Design Documents HTTP Handlers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/services">3.11. CouchDB Internal Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#couchdb-daemonized-mini-apps">3.11.1. CouchDB Daemonized Mini Apps</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/misc">3.12. Miscellaneous Parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#configuration-of-attachment-storage">3.12.1. Configuration of Attachment Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#statistic-calculation">3.12.2. Statistic Calculation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#uuids-configuration">3.12.3. UUIDs Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#vendor-information">3.12.4. Vendor information</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-config/proxying">3.13. Proxying Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#couchdb-as-proxy">3.13.1. CouchDB As Proxy</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-replication/index">4. Replication</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-replication/intro">4.1. Introduction Into Replications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#triggering-replication">4.1.1. Triggering Replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#replication-procedure">4.1.2. Replication Procedure</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#master-master-replication">4.1.3. Master - Master replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#controlling-which-documents-to-replicate">4.1.4. Controlling which Documents to Replicate</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#migrating-data-to-clients">4.1.5. Migrating Data to Clients</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-replication/protocol">4.2. CouchDB Replication Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#language">4.2.1. Language</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#goals">4.2.2. Goals</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#definitions">4.2.3. Definitions</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#algorithm">4.2.4. Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#filter-replication">4.2.5. Filter replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#optimisations">4.2.6. Optimisations</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#api-reference">4.2.7. API Reference</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#reference">4.2.8. Reference</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-replication/replicator">4.3. Replicator Database</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#basics">4.3.1. Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#documents-describing-the-same-replication">4.3.2. Documents describing the same replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#canceling-replications">4.3.3. Canceling replications</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#server-restart">4.3.4. Server restart</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#changing-the-replicator-database">4.3.5. Changing the Replicator Database</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#replicating-the-replicator-database">4.3.6. Replicating the replicator database</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#delegations">4.3.7. Delegations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-replication/conflicts">4.4. Replication and conflict model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#couchdb-replication">4.4.1. CouchDB replication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#conflict-avoidance">4.4.2. Conflict avoidance</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#conflicts-in-batches">4.4.3. Conflicts in batches</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#revision-tree">4.4.4. Revision tree</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#working-with-conflicting-documents">4.4.5. Working with conflicting documents</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#multiple-document-api">4.4.6. Multiple document API</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#view-map-functions">4.4.7. View map functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#merging-and-revision-history">4.4.8. Merging and revision history</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#comparison-with-other-replicating-data-stores">4.4.9. Comparison with other replicating data stores</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-maintenance/index">5. CouchDB Maintenance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-maintenance/compaction">5.1. Compaction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#database-compaction">5.1.1. Database Compaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#views-compaction">5.1.2. Views Compaction</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#automatic-compaction">5.1.3. Automatic Compaction</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-maintenance/performance">5.2. Performance</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#disk-i-o">5.2.1. Disk I/O</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#system-resource-limits">5.2.2. System Resource Limits</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#network">5.2.3. Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#couchdb">5.2.4. CouchDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#views">5.2.5. Views</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-couchapp/index">6. CouchApp</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-couchapp/ddocs">6.1. Design Functions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#view-functions">6.1.1. View functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#show-functions">6.1.2. Show functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#list-functions">6.1.3. List functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#update-functions">6.1.4. Update functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#filter-functions">6.1.5. Filter functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#validate-document-update-functions">6.1.6. Validate document update functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-couchapp/views/index">6.2. Guide to Views</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-couchapp/views/intro">6.2.1. Introduction Into The Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-couchapp/views/collation">6.2.2. Views Collation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-couchapp/views/joins">6.2.3. Joins With Views</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-couchapp/views/nosql">6.2.4. View Cookbook for SQL Jockeys</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-couchapp/views/pagination">6.2.5. Pagination Recipe</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-externals">7. CouchDB Externals API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#the-new-hotness">7.1. The New Hotness</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#how-does-it-work-http-proxying">7.2. How does it work? - HTTP Proxying</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#how-does-it-work-os-daemons">7.3. How does it work? - OS Daemons</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#configuration-api">7.3.1. Configuration API</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#logging-api">7.3.2. Logging API</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#dynamic-daemons">7.3.3. Dynamic Daemons</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#neat-but-so-what">7.4. Neat. But So What?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-query-server/index">8. Query Server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-query-server/protocol">8.1. Query Server Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#reset">8.1.1. <tt class="docutils literal"><span class="pre">reset</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#add-lib">8.1.2. <tt class="docutils literal"><span class="pre">add_lib</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#map-doc">8.1.3. <tt class="docutils literal"><span class="pre">map_doc</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#reduce">8.1.4. <tt class="docutils literal"><span class="pre">reduce</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#rereduce">8.1.5. <tt class="docutils literal"><span class="pre">rereduce</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#ddoc">8.1.6. <tt class="docutils literal"><span class="pre">ddoc</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#raising-errors">8.1.7. Raising errors</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#logging">8.1.8. Logging</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-query-server/javascript">8.2. JavaScript</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#design-functions-context">8.2.1. Design functions context</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#commonjs-modules">8.2.2. CommonJS Modules</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-query-server/erlang">8.3. Erlang</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-fauxton/index">9. Fauxton</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-fauxton/install">9.1. Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#get-the-source">9.1.1. Get the source</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#fauxton-setup">9.1.2. Fauxton Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#dev-server">9.1.3. Dev Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#deploy-fauxton">9.1.4. Deploy Fauxton</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-fauxton/addons">9.2. Writting Addons</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#generating-an-addon">9.2.1. Generating an Addon</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#routes-and-hooks">9.2.2. Routes and hooks</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#hello-world-addon">9.2.3. Hello world Addon</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-api/index">10. API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-api/basics">10.1. API Basics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#request-format-and-responses">10.1.1. Request Format and Responses</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#http-headers">10.1.2. HTTP Headers</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#json-basics">10.1.3. JSON Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#http-status-codes">10.1.4. HTTP Status Codes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-api/server/index">10.2. Server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/server/common">10.2.1. <tt class="docutils literal"><span class="pre">/</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#active-tasks">10.2.2. <tt class="docutils literal"><span class="pre">/_active_tasks</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#all-dbs">10.2.3. <tt class="docutils literal"><span class="pre">/_all_dbs</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-updates">10.2.4. <tt class="docutils literal"><span class="pre">/_db_updates</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#log">10.2.5. <tt class="docutils literal"><span class="pre">/_log</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#replicate">10.2.6. <tt class="docutils literal"><span class="pre">/_replicate</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#restart">10.2.7. <tt class="docutils literal"><span class="pre">/_restart</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#stats">10.2.8. <tt class="docutils literal"><span class="pre">/_stats</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#utils">10.2.9. <tt class="docutils literal"><span class="pre">/_utils</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#uuids">10.2.10. <tt class="docutils literal"><span class="pre">/_uuids</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#favicon-ico">10.2.11. <tt class="docutils literal"><span class="pre">/favicon.ico</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/server/authn">10.2.12. Authentication</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/server/configuration">10.2.13. Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-api/database/index">10.3. Databases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/database/common">10.3.1. <tt class="docutils literal"><span class="pre">/db</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/database/bulk-api">10.3.2. <tt class="docutils literal"><span class="pre">/db/_all_docs</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-bulk-docs">10.3.3. <tt class="docutils literal"><span class="pre">/db/_bulk_docs</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/database/changes">10.3.4. <tt class="docutils literal"><span class="pre">/db/_changes</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/database/compact">10.3.5. <tt class="docutils literal"><span class="pre">/db/_compact</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-compact-design-doc">10.3.6. <tt class="docutils literal"><span class="pre">/db/_compact/design-doc</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-ensure-full-commit">10.3.7. <tt class="docutils literal"><span class="pre">/db/_ensure_full_commit</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-view-cleanup">10.3.8. <tt class="docutils literal"><span class="pre">/db/_view_cleanup</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/database/security">10.3.9. <tt class="docutils literal"><span class="pre">/db/_security</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/database/temp-views">10.3.10. <tt class="docutils literal"><span class="pre">/db/_temp_view</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/database/misc">10.3.11. <tt class="docutils literal"><span class="pre">/db/_purge</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-missing-revs">10.3.12. <tt class="docutils literal"><span class="pre">/db/_missing_revs</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-revs-diff">10.3.13. <tt class="docutils literal"><span class="pre">/db/_revs_diff</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-revs-limit">10.3.14. <tt class="docutils literal"><span class="pre">/db/_revs_limit</span></tt></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-api/document/index">10.4. Documents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/document/common">10.4.1. <tt class="docutils literal"><span class="pre">/db/doc</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/document/attachments">10.4.2. <tt class="docutils literal"><span class="pre">/db/doc/attachment</span></tt></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-api/ddoc/index">10.5. Design Documents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/ddoc/common">10.5.1. <tt class="docutils literal"><span class="pre">/db/_design/design-doc</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-design-design-doc-attachment">10.5.2. <tt class="docutils literal"><span class="pre">/db/_design/design-doc/attachment</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-design-design-doc-info">10.5.3. <tt class="docutils literal"><span class="pre">/db/_design/design-doc/_info</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/ddoc/views">10.5.4. <tt class="docutils literal"><span class="pre">/db/_design/design-doc/_view/view-name</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/ddoc/render">10.5.5. <tt class="docutils literal"><span class="pre">/db/_design/design-doc/_show/show-name</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-design-design-doc-show-show-name-doc-id">10.5.6. <tt class="docutils literal"><span class="pre">/db/_design/design-doc/_show/show-name/doc-id</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-design-design-doc-list-list-name-view-name">10.5.7. <tt class="docutils literal"><span class="pre">/db/_design/design-doc/_list/list-name/view-name</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-design-design-doc-list-list-name-other-ddoc-view-name">10.5.8. <tt class="docutils literal"><span class="pre">/db/_design/design-doc/_list/list-name/other-ddoc/view-name</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-design-design-doc-update-update-name">10.5.9. <tt class="docutils literal"><span class="pre">/db/_design/design-doc/_update/update-name</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-design-design-doc-update-update-name-doc-id">10.5.10. <tt class="docutils literal"><span class="pre">/db/_design/design-doc/_update/update-name/doc-id</span></tt></a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#document-api/ddoc/rewrites">10.5.11. <tt class="docutils literal"><span class="pre">/db/_design/design-doc/_rewrite/path</span></tt></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-api/local">10.6. Local (non-replicating) Documents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#db-local-id">10.6.1. <tt class="docutils literal"><span class="pre">/db/_local/id</span></tt></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-json-structure">11. JSON Structure Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#all-database-documents">11.1. All Database Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#bulk-document-response">11.2. Bulk Document Response</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#bulk-documents">11.3. Bulk Documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#changes-information-for-a-database">11.4. Changes information for a database</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#couchdb-document">11.5. CouchDB Document</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#couchdb-error-status">11.6. CouchDB Error Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#couchdb-database-information-object">11.7. CouchDB database information object</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#design-document">11.8. Design Document</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#design-document-information">11.9. Design Document Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-with-attachments">11.10. Document with Attachments</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#list-of-active-tasks">11.11. List of Active Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#replication-settings">11.12. Replication Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#replication-status">11.13. Replication Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#request-object">11.14. Request object</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#response-object">11.15. Response object</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#returned-couchdb-document-with-detailed-revision-info">11.16. Returned CouchDB Document with Detailed Revision Info</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#returned-couchdb-document-with-revision-info">11.17. Returned CouchDB Document with Revision Info</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#returned-document-with-attachments">11.18. Returned Document with Attachments</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#security-object">11.19. Security Object</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#user-context-object">11.20. User Context Object</a></li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#view-head-information">11.21. View Head Information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-experimental">12. Experimental Features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#nodejs-query-server">12.1. NodeJS Query Server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#setup">12.1.1. Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#differences-from-the-spidermonkey-query-server">12.1.2. Differences from the SpiderMonkey Query Server</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#plugins">12.2. Plugins</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-contributing">13. Contributing to this Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-whatsnew/index">14. Release History</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/1.6">14.1. 1.6.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#deprecations">14.1.1. Deprecations</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-6-1">14.1.2. Version 1.6.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-6-0">14.1.3. Version 1.6.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/1.5">14.2. 1.5.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-5-1">14.2.1. Version 1.5.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-5-0">14.2.2. Version 1.5.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/1.4">14.3. 1.4.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#upgrade-notes">14.3.1. Upgrade Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-4-0">14.3.2. Version 1.4.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/1.3">14.4. 1.3.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#upgrade-notes">14.4.1. Upgrade Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-3-1">14.4.2. Version 1.3.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-3-0">14.4.3. Version 1.3.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/1.2">14.5. 1.2.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#upgrade-notes">14.5.1. Upgrade Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-2-2">14.5.2. Version 1.2.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-2-1">14.5.3. Version 1.2.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-2-0">14.5.4. Version 1.2.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/1.1">14.6. 1.1.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#upgrade-notes">14.6.1. Upgrade Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-1-2">14.6.2. Version 1.1.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-1-1">14.6.3. Version 1.1.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-1-0">14.6.4. Version 1.1.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/1.0">14.7. 1.0.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#upgrade-notes">14.7.1. Upgrade Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-0-4">14.7.2. Version 1.0.4</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-0-3">14.7.3. Version 1.0.3</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-0-2">14.7.4. Version 1.0.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-0-1">14.7.5. Version 1.0.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-1-0-0">14.7.6. Version 1.0.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/0.11">14.8. 0.11.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#upgrade-notes">14.8.1. Upgrade Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-11-2">14.8.2. Version 0.11.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-11-1">14.8.3. Version 0.11.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-11-0">14.8.4. Version 0.11.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/0.10">14.9. 0.10.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#upgrade-notes">14.9.1. Upgrade Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-10-2">14.9.2. Version 0.10.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-10-1">14.9.3. Version 0.10.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-10-0">14.9.4. Version 0.10.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/0.9">14.10. 0.9.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#upgrade-notes">14.10.1. Upgrade Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-9-2">14.10.2. Version 0.9.2</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-9-1">14.10.3. Version 0.9.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-9-0">14.10.4. Version 0.9.0</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-whatsnew/0.8">14.11. 0.8.x Branch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-8-1-incubating">14.11.1. Version 0.8.1-incubating</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#version-0-8-0-incubating">14.11.2. Version 0.8.0-incubating</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-cve/index">15. Security Issues Information</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-cve/2010-0009">15.1. CVE-2010-0009: Apache CouchDB Timing Attack Vulnerability</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#description">15.1.1. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#mitigation">15.1.2. Mitigation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#example">15.1.3. Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#credit">15.1.4. Credit</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-cve/2010-2234">15.2. CVE-2010-2234: Apache CouchDB Cross Site Request Forgery Attack</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#description">15.2.1. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#mitigation">15.2.2. Mitigation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#example">15.2.3. Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#credit">15.2.4. Credit</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-cve/2010-3854">15.3. CVE-2010-3854: Apache CouchDB Cross Site Scripting Issue</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#description">15.3.1. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#mitigation">15.3.2. Mitigation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#example">15.3.3. Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#credit">15.3.4. Credit</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-cve/2012-5641">15.4. CVE-2012-5641: Information disclosure via unescaped backslashes in URLs on Windows</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#description">15.4.1. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#mitigation">15.4.2. Mitigation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#work-around">15.4.3. Work-Around</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#acknowledgement">15.4.4. Acknowledgement</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#references">15.4.5. References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-cve/2012-5649">15.5. CVE-2012-5649: JSONP arbitrary code execution with Adobe Flash</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#description">15.5.1. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#mitigation">15.5.2. Mitigation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#work-around">15.5.3. Work-Around</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-cve/2012-5650">15.6. CVE-2012-5650: DOM based Cross-Site Scripting via Futon UI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#description">15.6.1. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#mitigation">15.6.2. Mitigation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#work-around">15.6.3. Work-Around</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#acknowledgement">15.6.4. Acknowledgement</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contents.html#document-cve/2014-2668">15.7. CVE-2014-2668: DoS (CPU and memory consumption) via the count parameter to /_uuids</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contents.html#description">15.7.1. Description</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#mitigation">15.7.2. Mitigation</a></li>
<li class="toctree-l3"><a class="reference internal" href="contents.html#work-around">15.7.3. Work-Around</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#reporting-new-security-problems-with-apache-couchdb">16. Reporting New Security Problems with Apache CouchDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="contents.html#document-about">17. About CouchDB Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="contents.html#license">17.1. License</a></li>
</ul>
</li>
</ul>
<!--

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

-->

<!--

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

-->

<h3>More Help</h3>

<ul>
<li><a href="https://couchdb.apache.org/" onclick="_gaq.push(['_link', 'https://couchdb.apache.org/']); return false;">Homepage</a></li>
<li><a href="http://wiki.apache.org/couchdb/">Wiki</a></li>
<li><a href="https://couchdb.apache.org/#mailing-list" onclick="_gaq.push(['_link', 'https://couchdb.apache.org/#mailing-list']); return false;">Mailing Lists</a></li>
<li><a href="http://webchat.freenode.net/?channels=couchdb">IRC</a></li>
<li><a href="https://issues.apache.org/jira/browse/CouchDB">Issues</a></li>
<li><a href="download.html">Download</a></li>
<li><a href="https://github.com/apache/couchdb/blob/master/share/doc/src/contents.rst"
       rel="nofollow">Show on GitHub</a></li>
<li><a href="https://github.com/apache/couchdb/edit/master/share/doc/src/contents.rst"
       rel="nofollow">Edit on GitHub</a></li>
</ul><!--

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.

-->


<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-658988-6']);
  _gaq.push(['_setDomainName', 'couchdb.org']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="contents.html#document-contents">Apache CouchDB 1.6 Documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, The Apache Software Foundation.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>